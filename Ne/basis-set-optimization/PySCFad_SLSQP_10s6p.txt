#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45446999]
bas 2, expnt(s) = [833.2710571]
bas 3, expnt(s) = [235.73473657]
bas 4, expnt(s) = [76.43305808]
bas 5, expnt(s) = [10.03688528]
bas 6, expnt(s) = [27.05056174]
bas 7, expnt(s) = [0.38143141]
bas 8, expnt(s) = [1.11706584]
bas 9, expnt(s) = [2.88245389]
bas 10, expnt(s) = [3.68488423]
bas 11, expnt(s) = [12.45003874]
bas 12, expnt(s) = [54.78531231]
bas 13, expnt(s) = [0.330264]
bas 14, expnt(s) = [1.14415964]
bas 15, expnt(s) = [0.5]
CPU time:         1.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996193e+02
 7.64330581e+01 6.53094387e+01 1.00368853e+01 1.42466989e+01
 2.70505617e+01 2.99672741e+01 3.81431405e-01 1.22624531e+00
 1.11706584e+00 2.74520070e+00 2.88245389e+00 5.58903464e+00
 3.68488423e+00 1.48940978e+01 1.24500387e+01 6.82256640e+01
 5.47853123e+01 4.34825064e+02 3.30264004e-01 7.30400304e-01
 1.14415964e+00 3.45217398e+00 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843332466941
cond(S) = 344.7877995796555
E1 = -183.5773317403851  E_coul = 55.07849064531135
init E= -128.498841095074
    CPU time for initialize scf      0.14 sec, wall time      0.14 sec
  HOMO = -0.773948239703608  LUMO = 0.770660609355614
  mo_energy =
[-3.25553007e+01 -1.85276376e+00 -7.73948240e-01 -7.73948240e-01
 -7.73948240e-01  7.70660609e-01  7.70660609e-01  7.70660609e-01
  1.21894513e+00  2.63761981e+00  2.63761981e+00  2.63761981e+00
  7.37911315e+00  7.45711243e+00  7.45711243e+00  7.45711243e+00
  2.55750896e+01  2.55750896e+01  2.55750896e+01  3.47841389e+01
  1.20019445e+02  1.20019445e+02  1.20019445e+02  1.38929702e+02
  5.03036549e+02  1.87067979e+03  8.00035222e+03  4.77680082e+04]
E1 = -182.11904535891085  E_coul = 53.59046400268312
cycle= 1 E= -128.528581356228  delta_E= -0.0297  |g|=  0.2  |ddm|= 0.165
    CPU time for cycle= 1      0.26 sec, wall time      0.26 sec
diis-norm(errvec)=0.549674
diis-c [-0.30214098  1.        ]
  HOMO = -0.878914436182661  LUMO = 0.752075917329258
  mo_energy =
[-3.28724900e+01 -1.96233770e+00 -8.78914436e-01 -8.78914436e-01
 -8.78914436e-01  7.52075917e-01  7.52075917e-01  7.52075917e-01
  1.17632499e+00  2.58597857e+00  2.58597857e+00  2.58597857e+00
  7.25171127e+00  7.33592393e+00  7.33592393e+00  7.33592393e+00
  2.53452860e+01  2.53452860e+01  2.53452860e+01  3.45430024e+01
  1.19700566e+02  1.19700566e+02  1.19700566e+02  1.38617676e+02
  5.02680693e+02  1.87028798e+03  7.99993142e+03  4.77675685e+04]
E1 = -182.85363016368453  E_coul = 54.32255661959099
cycle= 2 E= -128.531073544094  delta_E= -0.00249  |g|=  0.1  |ddm|= 0.0907
    CPU time for cycle= 2      0.08 sec, wall time      0.08 sec
diis-norm(errvec)=0.274961
diis-c [-6.04566474e-04  3.32764661e-01  6.67235339e-01]
  HOMO = -0.844419780123288  LUMO = 0.758486646781581
  mo_energy =
[-3.27674710e+01 -1.92603924e+00 -8.44419780e-01 -8.44419780e-01
 -8.44419780e-01  7.58486647e-01  7.58486647e-01  7.58486647e-01
  1.19045179e+00  2.60297590e+00  2.60297590e+00  2.60297590e+00
  7.29362250e+00  7.37574935e+00  7.37574935e+00  7.37574935e+00
  2.54215746e+01  2.54215746e+01  2.54215746e+01  3.46233164e+01
  1.19805422e+02  1.19805422e+02  1.19805422e+02  1.38720767e+02
  5.02794319e+02  1.87040675e+03  8.00005260e+03  4.77676906e+04]
E1 = -182.60808593145117  E_coul = 54.07616695900218
cycle= 3 E= -128.531918972449  delta_E= -0.000845  |g|= 0.00042  |ddm|= 0.0283
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000898366
diis-c [-1.41226801e-07 -1.97219177e-03 -9.77881389e-04  1.00295007e+00]
  HOMO = -0.844559702850299  LUMO = 0.758502695097593
  mo_energy =
[-3.27677402e+01 -1.92609701e+00 -8.44559703e-01 -8.44559703e-01
 -8.44559703e-01  7.58502695e-01  7.58502695e-01  7.58502695e-01
  1.19047318e+00  2.60295662e+00  2.60295662e+00  2.60295662e+00
  7.29354346e+00  7.37566436e+00  7.37566436e+00  7.37566436e+00
  2.54213899e+01  2.54213899e+01  2.54213899e+01  3.46231314e+01
  1.19805141e+02  1.19805141e+02  1.19805141e+02  1.38720497e+02
  5.02793946e+02  1.87040627e+03  8.00005202e+03  4.77676900e+04]
E1 = -182.60849943998056  E_coul = 54.07658044525244
cycle= 4 E= -128.531918994728  delta_E= -2.23e-08  |g|= 6.93e-05  |ddm|= 0.000584
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000169661
diis-c [-1.57100752e-09  3.38428415e-04  6.55278832e-04 -2.33831861e-01
  1.23283815e+00]
  HOMO = -0.844580312091562  LUMO = 0.758500821378375
  mo_energy =
[-3.27677816e+01 -1.92610034e+00 -8.44580312e-01 -8.44580312e-01
 -8.44580312e-01  7.58500821e-01  7.58500821e-01  7.58500821e-01
  1.19047530e+00  2.60294846e+00  2.60294846e+00  2.60294846e+00
  7.29352755e+00  7.37564502e+00  7.37564502e+00  7.37564502e+00
  2.54213568e+01  2.54213568e+01  2.54213568e+01  3.46230988e+01
  1.19805099e+02  1.19805099e+02  1.19805099e+02  1.38720456e+02
  5.02793895e+02  1.87040620e+03  8.00005196e+03  4.77676899e+04]
E1 = -182.60862745065765  E_coul = 54.076708455079256
cycle= 5 E= -128.531918995578  delta_E= -8.5e-10  |g|= 5.72e-06  |ddm|= 0.000113
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60862745065765  E_coul = 54.076708455079256
  HOMO = -0.84457746555396  LUMO = 0.758501363241288
  mo_energy =
[-3.27677761e+01 -1.92609678e+00 -8.44577466e-01 -8.44577466e-01
 -8.44577466e-01  7.58501363e-01  7.58501363e-01  7.58501363e-01
  1.19047703e+00  2.60295006e+00  2.60295006e+00  2.60295006e+00
  7.29353143e+00  7.37564828e+00  7.37564828e+00  7.37564828e+00
  2.54213618e+01  2.54213618e+01  2.54213618e+01  3.46231040e+01
  1.19805105e+02  1.19805105e+02  1.19805105e+02  1.38720461e+02
  5.02793900e+02  1.87040621e+03  8.00005196e+03  4.77676899e+04]
E1 = -182.60861455021399  E_coul = 54.076695554633645
Extra cycle  E= -128.53191899558  delta_E= -1.93e-12  |g|= 1.81e-06  |ddm|= 2.91e-06
    CPU time for scf_cycle      0.52 sec, wall time      0.53 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330581e+01 1.00368853e+01 2.70505617e+01 3.81431405e-01
 1.11706584e+00 2.88245389e+00 3.68488423e+00 1.24500387e+01
 5.47853123e+01 3.30264004e-01 1.14415964e+00 5.00000000e-01]
E = -128.53191899558033
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45446999]
bas 2, expnt(s) = [833.2710571]
bas 3, expnt(s) = [235.73473657]
bas 4, expnt(s) = [76.43305808]
bas 5, expnt(s) = [10.03688528]
bas 6, expnt(s) = [27.05056174]
bas 7, expnt(s) = [0.38143141]
bas 8, expnt(s) = [1.11706584]
bas 9, expnt(s) = [2.88245389]
bas 10, expnt(s) = [3.68488423]
bas 11, expnt(s) = [12.45003874]
bas 12, expnt(s) = [54.78531231]
bas 13, expnt(s) = [0.330264]
bas 14, expnt(s) = [1.14415964]
bas 15, expnt(s) = [0.5]
CPU time:         2.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996193e+02
 7.64330581e+01 6.53094387e+01 1.00368853e+01 1.42466989e+01
 2.70505617e+01 2.99672741e+01 3.81431405e-01 1.22624531e+00
 1.11706584e+00 2.74520070e+00 2.88245389e+00 5.58903464e+00
 3.68488423e+00 1.48940978e+01 1.24500387e+01 6.82256640e+01
 5.47853123e+01 4.34825064e+02 3.30264004e-01 7.30400304e-01
 1.14415964e+00 3.45217398e+00 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843332466941
cond(S) = 344.7877995796555
E1 = -183.5773317403851  E_coul = 55.07849064531135
init E= -128.498841095074
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773948239703608  LUMO = 0.770660609355614
  mo_energy =
[-3.25553007e+01 -1.85276376e+00 -7.73948240e-01 -7.73948240e-01
 -7.73948240e-01  7.70660609e-01  7.70660609e-01  7.70660609e-01
  1.21894513e+00  2.63761981e+00  2.63761981e+00  2.63761981e+00
  7.37911315e+00  7.45711243e+00  7.45711243e+00  7.45711243e+00
  2.55750896e+01  2.55750896e+01  2.55750896e+01  3.47841389e+01
  1.20019445e+02  1.20019445e+02  1.20019445e+02  1.38929702e+02
  5.03036549e+02  1.87067979e+03  8.00035222e+03  4.77680082e+04]
E1 = -182.11904535891085  E_coul = 53.59046400268312
cycle= 1 E= -128.528581356228  delta_E= -0.0297  |g|=  0.2  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.549674
diis-c [-0.30214098  1.        ]
  HOMO = -0.878914436182661  LUMO = 0.752075917329258
  mo_energy =
[-3.28724900e+01 -1.96233770e+00 -8.78914436e-01 -8.78914436e-01
 -8.78914436e-01  7.52075917e-01  7.52075917e-01  7.52075917e-01
  1.17632499e+00  2.58597857e+00  2.58597857e+00  2.58597857e+00
  7.25171127e+00  7.33592393e+00  7.33592393e+00  7.33592393e+00
  2.53452860e+01  2.53452860e+01  2.53452860e+01  3.45430024e+01
  1.19700566e+02  1.19700566e+02  1.19700566e+02  1.38617676e+02
  5.02680693e+02  1.87028798e+03  7.99993142e+03  4.77675685e+04]
E1 = -182.85363016368453  E_coul = 54.32255661959099
cycle= 2 E= -128.531073544094  delta_E= -0.00249  |g|=  0.1  |ddm|= 0.0907
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274961
diis-c [-6.04566474e-04  3.32764661e-01  6.67235339e-01]
  HOMO = -0.844419780123288  LUMO = 0.758486646781581
  mo_energy =
[-3.27674710e+01 -1.92603924e+00 -8.44419780e-01 -8.44419780e-01
 -8.44419780e-01  7.58486647e-01  7.58486647e-01  7.58486647e-01
  1.19045179e+00  2.60297590e+00  2.60297590e+00  2.60297590e+00
  7.29362250e+00  7.37574935e+00  7.37574935e+00  7.37574935e+00
  2.54215746e+01  2.54215746e+01  2.54215746e+01  3.46233164e+01
  1.19805422e+02  1.19805422e+02  1.19805422e+02  1.38720767e+02
  5.02794319e+02  1.87040675e+03  8.00005260e+03  4.77676906e+04]
E1 = -182.60808593145117  E_coul = 54.07616695900218
cycle= 3 E= -128.531918972449  delta_E= -0.000845  |g|= 0.00042  |ddm|= 0.0283
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000898366
diis-c [-1.41226801e-07 -1.97219177e-03 -9.77881389e-04  1.00295007e+00]
  HOMO = -0.844559702850299  LUMO = 0.758502695097593
  mo_energy =
[-3.27677402e+01 -1.92609701e+00 -8.44559703e-01 -8.44559703e-01
 -8.44559703e-01  7.58502695e-01  7.58502695e-01  7.58502695e-01
  1.19047318e+00  2.60295662e+00  2.60295662e+00  2.60295662e+00
  7.29354346e+00  7.37566436e+00  7.37566436e+00  7.37566436e+00
  2.54213899e+01  2.54213899e+01  2.54213899e+01  3.46231314e+01
  1.19805141e+02  1.19805141e+02  1.19805141e+02  1.38720497e+02
  5.02793946e+02  1.87040627e+03  8.00005202e+03  4.77676900e+04]
E1 = -182.60849943998056  E_coul = 54.07658044525244
cycle= 4 E= -128.531918994728  delta_E= -2.23e-08  |g|= 6.93e-05  |ddm|= 0.000584
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000169661
diis-c [-1.57100752e-09  3.38428415e-04  6.55278832e-04 -2.33831861e-01
  1.23283815e+00]
  HOMO = -0.844580312091562  LUMO = 0.758500821378375
  mo_energy =
[-3.27677816e+01 -1.92610034e+00 -8.44580312e-01 -8.44580312e-01
 -8.44580312e-01  7.58500821e-01  7.58500821e-01  7.58500821e-01
  1.19047530e+00  2.60294846e+00  2.60294846e+00  2.60294846e+00
  7.29352755e+00  7.37564502e+00  7.37564502e+00  7.37564502e+00
  2.54213568e+01  2.54213568e+01  2.54213568e+01  3.46230988e+01
  1.19805099e+02  1.19805099e+02  1.19805099e+02  1.38720456e+02
  5.02793895e+02  1.87040620e+03  8.00005196e+03  4.77676899e+04]
E1 = -182.60862745065765  E_coul = 54.076708455079256
cycle= 5 E= -128.531918995578  delta_E= -8.5e-10  |g|= 5.72e-06  |ddm|= 0.000113
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60862745065765  E_coul = 54.076708455079256
  HOMO = -0.84457746555396  LUMO = 0.758501363241288
  mo_energy =
[-3.27677761e+01 -1.92609678e+00 -8.44577466e-01 -8.44577466e-01
 -8.44577466e-01  7.58501363e-01  7.58501363e-01  7.58501363e-01
  1.19047703e+00  2.60295006e+00  2.60295006e+00  2.60295006e+00
  7.29353143e+00  7.37564828e+00  7.37564828e+00  7.37564828e+00
  2.54213618e+01  2.54213618e+01  2.54213618e+01  3.46231040e+01
  1.19805105e+02  1.19805105e+02  1.19805105e+02  1.38720461e+02
  5.02793900e+02  1.87040621e+03  8.00005196e+03  4.77676899e+04]
E1 = -182.60861455021399  E_coul = 54.076695554633645
Extra cycle  E= -128.53191899558  delta_E= -1.93e-12  |g|= 1.81e-06  |ddm|= 2.91e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.7877995796555
E1 = -182.60861455021399  E_coul = 54.076695554633645
init E= -128.53191899558
    CPU time for initialize scf      0.49 sec, wall time      0.48 sec
  HOMO = -0.844578374124865  LUMO = 0.758501196764702
  mo_energy =
[-3.27677790e+01 -1.92609762e+00 -8.44578374e-01 -8.44578374e-01
 -8.44578374e-01  7.58501197e-01  7.58501197e-01  7.58501197e-01
  1.19047674e+00  2.60294963e+00  2.60294963e+00  2.60294963e+00
  7.29353041e+00  7.37564723e+00  7.37564723e+00  7.37564723e+00
  2.54213598e+01  2.54213598e+01  2.54213598e+01  3.46231019e+01
  1.19805102e+02  1.19805102e+02  1.19805102e+02  1.38720458e+02
  5.02793896e+02  1.87040621e+03  8.00005196e+03  4.77676899e+04]
E1 = -182.60862151433562  E_coul = 54.076702518755084
cycle= 1 E= -128.531918995581  delta_E= -2.27e-13  |g|= 9.58e-07  |ddm|= 8.11e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60862151433562  E_coul = 54.076702518755084
  HOMO = -0.844577885551354  LUMO = 0.758501287706015
  mo_energy =
[-3.27677775e+01 -1.92609708e+00 -8.44577886e-01 -8.44577886e-01
 -8.44577886e-01  7.58501288e-01  7.58501288e-01  7.58501288e-01
  1.19047695e+00  2.60294987e+00  2.60294987e+00  2.60294987e+00
  7.29353101e+00  7.37564780e+00  7.37564780e+00  7.37564780e+00
  2.54213609e+01  2.54213609e+01  2.54213609e+01  3.46231030e+01
  1.19805103e+02  1.19805103e+02  1.19805103e+02  1.38720459e+02
  5.02793898e+02  1.87040621e+03  8.00005196e+03  4.77676899e+04]
E1 = -182.60861805733353  E_coul = 54.07669906175296
Extra cycle  E= -128.531918995581  delta_E=    0  |g|= 4.69e-07  |ddm|= 4.06e-07
    CPU time for scf_cycle      1.20 sec, wall time      1.20 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330581e+01 1.00368853e+01 2.70505617e+01 3.81431405e-01
 1.11706584e+00 2.88245389e+00 3.68488423e+00 1.24500387e+01
 5.47853123e+01 3.30264004e-01 1.14415964e+00 5.00000000e-01]
grad_E = [ 3.77865139e-11 -1.99645822e-09  4.76571400e-08 -7.05759748e-07
  4.49490777e-06  1.27510308e-06  3.67545675e-06 -2.16151938e-04
  6.16102477e-05 -5.15380692e-06  2.21868180e-03 -2.02983563e-04
  6.74508889e-06  2.68021898e-02 -1.16849987e-02 -2.43186660e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447           1
[INPUT] 0    0    [1    /1   ]  833.271057055        1
[INPUT] 0    0    [1    /1   ]  235.73473728         1
[INPUT] 0    0    [1    /1   ]  76.4330535859        1
[INPUT] 0    0    [1    /1   ]  10.0368840016        1
[INPUT] 0    0    [1    /1   ]  27.0505580648        1
[INPUT] 0    0    [1    /1   ]  0.38164755737        1
[INPUT] 0    0    [1    /1   ]  1.11700422482        1
[INPUT] 0    0    [1    /1   ]  2.8824590459         1
[INPUT] 1    0    [1    /1   ]  3.68266554738        1
[INPUT] 1    0    [1    /1   ]  12.4502417213        1
[INPUT] 1    0    [1    /1   ]  54.7853055617        1
[INPUT] 1    0    [1    /1   ]  0.303461814531       1
[INPUT] 1    0    [1    /1   ]  1.15584464214        1
[INPUT] 1    0    [1    /1   ]  0.50024318666        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412999053, 1.0]], [0, [3661.4544699950616, 1.0]], [0, [833.2710570546224, 1.0]], [0, [235.73473728046267, 1.0]], [0, [76.43305358588985, 1.0]], [0, [10.036884001646678, 1.0]], [0, [27.05055806476719, 1.0]], [0, [0.3816475573697442, 1.0]], [0, [1.1170042248200038, 1.0]], [0, [2.882459045899506, 1.0]], [1, [3.6826655473781633, 1.0]], [1, [12.450241721296358, 1.0]], [1, [54.78530556165188, 1.0]], [1, [0.3034618145305618, 1.0]], [1, [1.1558446421444428, 1.0]], [1, [0.5002431866596835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447]
bas 2, expnt(s) = [833.27105705]
bas 3, expnt(s) = [235.73473728]
bas 4, expnt(s) = [76.43305359]
bas 5, expnt(s) = [10.036884]
bas 6, expnt(s) = [27.05055806]
bas 7, expnt(s) = [0.38164756]
bas 8, expnt(s) = [1.11700422]
bas 9, expnt(s) = [2.88245905]
bas 10, expnt(s) = [3.68266555]
bas 11, expnt(s) = [12.45024172]
bas 12, expnt(s) = [54.78530556]
bas 13, expnt(s) = [0.30346181]
bas 14, expnt(s) = [1.15584464]
bas 15, expnt(s) = [0.50024319]
CPU time:         7.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996194e+02
 7.64330536e+01 6.53094358e+01 1.00368840e+01 1.42466975e+01
 2.70505581e+01 2.99672711e+01 3.81647557e-01 1.22676645e+00
 1.11700422e+00 2.74508715e+00 2.88245905e+00 5.58904213e+00
 3.68266555e+00 1.48828889e+01 1.24502417e+01 6.82270544e+01
 5.47853056e+01 4.34824997e+02 3.03461815e-01 6.57074261e-01
 1.15584464e+00 3.49630026e+00 5.00243187e-01 1.22732864e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998802624928928
cond(S) = 343.9851642036978
E1 = -183.5782993958482  E_coul = 55.07839894285672
init E= -128.499900452991
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774125403216124  LUMO = 0.729824552649208
  mo_energy =
[-3.25553098e+01 -1.85277050e+00 -7.74125403e-01 -7.74125403e-01
 -7.74125403e-01  7.29824553e-01  7.29824553e-01  7.29824553e-01
  1.21952255e+00  2.56051231e+00  2.56051231e+00  2.56051231e+00
  7.37987896e+00  7.38528178e+00  7.38528178e+00  7.38528178e+00
  2.55242275e+01  2.55242275e+01  2.55242275e+01  3.47848556e+01
  1.19986162e+02  1.19986162e+02  1.19986162e+02  1.38930281e+02
  5.03037044e+02  1.87068024e+03  8.00035262e+03  4.77680085e+04]
E1 = -182.0978299039112  E_coul = 53.5685001792653
cycle= 1 E= -128.529329724646  delta_E= -0.0294  |g|= 0.203  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.552882
diis-c [-0.30567895  1.        ]
  HOMO = -0.880798347454983  LUMO = 0.711794974618095
  mo_energy =
[-3.28762924e+01 -1.96431594e+00 -8.80798347e-01 -8.80798347e-01
 -8.80798347e-01  7.11794975e-01  7.11794975e-01  7.11794975e-01
  1.17579103e+00  2.50804586e+00  2.50804586e+00  2.50804586e+00
  7.25032324e+00  7.26154801e+00  7.26154801e+00  7.26154801e+00
  2.52911204e+01  2.52911204e+01  2.52911204e+01  3.45404409e+01
  1.19663503e+02  1.19663503e+02  1.19663503e+02  1.38614519e+02
  5.02677294e+02  1.87028448e+03  7.99992785e+03  4.77675649e+04]
E1 = -182.84574483806875  E_coul = 54.31386142220609
cycle= 2 E= -128.531883415863  delta_E= -0.00255  |g|= 0.102  |ddm|= 0.0741
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.277994
diis-c [-6.10756378e-04  3.33918973e-01  6.66081027e-01]
  HOMO = -0.845717565908891  LUMO = 0.717955558499585
  mo_energy =
[-3.27696472e+01 -1.92738723e+00 -8.45717566e-01 -8.45717566e-01
 -8.45717566e-01  7.17955558e-01  7.17955558e-01  7.17955558e-01
  1.19018766e+00  2.52525741e+00  2.52525741e+00  2.52525741e+00
  7.29295427e+00  7.30222543e+00  7.30222543e+00  7.30222543e+00
  2.53686922e+01  2.53686922e+01  2.53686922e+01  3.46220397e+01
  1.19769987e+02  1.19769987e+02  1.19769987e+02  1.38719206e+02
  5.02792651e+02  1.87040504e+03  8.00005085e+03  4.77676888e+04]
E1 = -182.59481395642175  E_coul = 54.062051983960096
cycle= 3 E= -128.532761972462  delta_E= -0.000879  |g|= 0.000378  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000867903
diis-c [-1.08350122e-07 -1.91518760e-03 -9.22866053e-04  1.00283805e+00]
  HOMO = -0.845867145696653  LUMO = 0.717966131401893
  mo_energy =
[-3.27699309e+01 -1.92746497e+00 -8.45867146e-01 -8.45867146e-01
 -8.45867146e-01  7.17966131e-01  7.17966131e-01  7.17966131e-01
  1.19019384e+00  2.52522977e+00  2.52522977e+00  2.52522977e+00
  7.29286120e+00  7.30212790e+00  7.30212790e+00  7.30212790e+00
  2.53684942e+01  2.53684942e+01  2.53684942e+01  3.46218407e+01
  1.19769691e+02  1.19769691e+02  1.19769691e+02  1.38718922e+02
  5.02792264e+02  1.87040454e+03  8.00005027e+03  4.77676882e+04]
E1 = -182.5951854026629  E_coul = 54.062423414747194
cycle= 4 E= -128.532761987916  delta_E= -1.55e-08  |g|= 6.28e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000164796
diis-c [-1.38644861e-09  2.80104744e-04  6.09809907e-04 -2.09152620e-01
  1.20826271e+00]
  HOMO = -0.845890660630078  LUMO = 0.717963039562312
  mo_energy =
[-3.27699765e+01 -1.92747476e+00 -8.45890661e-01 -8.45890661e-01
 -8.45890661e-01  7.17963040e-01  7.17963040e-01  7.17963040e-01
  1.19019139e+00  2.52521889e+00  2.52521889e+00  2.52521889e+00
  7.29284021e+00  7.30210440e+00  7.30210440e+00  7.30210440e+00
  2.53684566e+01  2.53684566e+01  2.53684566e+01  3.46218032e+01
  1.19769645e+02  1.19769645e+02  1.19769645e+02  1.38718876e+02
  5.02792210e+02  1.87040448e+03  8.00005020e+03  4.77676881e+04]
E1 = -182.59531045772982  E_coul = 54.062548469209084
cycle= 5 E= -128.532761988521  delta_E= -6.05e-10  |g|= 5.36e-06  |ddm|= 6.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59531045772982  E_coul = 54.062548469209084
  HOMO = -0.845888029776566  LUMO = 0.717963558760524
  mo_energy =
[-3.27699713e+01 -1.92747133e+00 -8.45888030e-01 -8.45888030e-01
 -8.45888030e-01  7.17963559e-01  7.17963559e-01  7.17963559e-01
  1.19019312e+00  2.52522041e+00  2.52522041e+00  2.52522041e+00
  7.29284386e+00  7.30210747e+00  7.30210747e+00  7.30210747e+00
  2.53684613e+01  2.53684613e+01  2.53684613e+01  3.46218081e+01
  1.19769650e+02  1.19769650e+02  1.19769650e+02  1.38718881e+02
  5.02792214e+02  1.87040449e+03  8.00005020e+03  4.77676881e+04]
E1 = -182.59529895505054  E_coul = 54.062536966527915
Extra cycle  E= -128.532761988523  delta_E= -1.88e-12  |g|= 1.66e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330536e+01 1.00368840e+01 2.70505581e+01 3.81647557e-01
 1.11700422e+00 2.88245905e+00 3.68266555e+00 1.24502417e+01
 5.47853056e+01 3.03461815e-01 1.15584464e+00 5.00243187e-01]
E = -128.53276198852262
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447           1
[INPUT] 0    0    [1    /1   ]  833.271057055        1
[INPUT] 0    0    [1    /1   ]  235.73473728         1
[INPUT] 0    0    [1    /1   ]  76.4330535859        1
[INPUT] 0    0    [1    /1   ]  10.0368840016        1
[INPUT] 0    0    [1    /1   ]  27.0505580648        1
[INPUT] 0    0    [1    /1   ]  0.38164755737        1
[INPUT] 0    0    [1    /1   ]  1.11700422482        1
[INPUT] 0    0    [1    /1   ]  2.8824590459         1
[INPUT] 1    0    [1    /1   ]  3.68266554738        1
[INPUT] 1    0    [1    /1   ]  12.4502417213        1
[INPUT] 1    0    [1    /1   ]  54.7853055617        1
[INPUT] 1    0    [1    /1   ]  0.303461814531       1
[INPUT] 1    0    [1    /1   ]  1.15584464214        1
[INPUT] 1    0    [1    /1   ]  0.50024318666        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412999053, 1.0]], [0, [3661.4544699950616, 1.0]], [0, [833.2710570546224, 1.0]], [0, [235.73473728046267, 1.0]], [0, [76.43305358588985, 1.0]], [0, [10.036884001646678, 1.0]], [0, [27.05055806476719, 1.0]], [0, [0.3816475573697442, 1.0]], [0, [1.1170042248200038, 1.0]], [0, [2.882459045899506, 1.0]], [1, [3.6826655473781633, 1.0]], [1, [12.450241721296358, 1.0]], [1, [54.78530556165188, 1.0]], [1, [0.3034618145305618, 1.0]], [1, [1.1558446421444428, 1.0]], [1, [0.5002431866596835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447]
bas 2, expnt(s) = [833.27105705]
bas 3, expnt(s) = [235.73473728]
bas 4, expnt(s) = [76.43305359]
bas 5, expnt(s) = [10.036884]
bas 6, expnt(s) = [27.05055806]
bas 7, expnt(s) = [0.38164756]
bas 8, expnt(s) = [1.11700422]
bas 9, expnt(s) = [2.88245905]
bas 10, expnt(s) = [3.68266555]
bas 11, expnt(s) = [12.45024172]
bas 12, expnt(s) = [54.78530556]
bas 13, expnt(s) = [0.30346181]
bas 14, expnt(s) = [1.15584464]
bas 15, expnt(s) = [0.50024319]
CPU time:         7.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996194e+02
 7.64330536e+01 6.53094358e+01 1.00368840e+01 1.42466975e+01
 2.70505581e+01 2.99672711e+01 3.81647557e-01 1.22676645e+00
 1.11700422e+00 2.74508715e+00 2.88245905e+00 5.58904213e+00
 3.68266555e+00 1.48828889e+01 1.24502417e+01 6.82270544e+01
 5.47853056e+01 4.34824997e+02 3.03461815e-01 6.57074261e-01
 1.15584464e+00 3.49630026e+00 5.00243187e-01 1.22732864e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998802624928928
cond(S) = 343.9851642036978
E1 = -183.5782993958482  E_coul = 55.07839894285672
init E= -128.499900452991
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.774125403216124  LUMO = 0.729824552649208
  mo_energy =
[-3.25553098e+01 -1.85277050e+00 -7.74125403e-01 -7.74125403e-01
 -7.74125403e-01  7.29824553e-01  7.29824553e-01  7.29824553e-01
  1.21952255e+00  2.56051231e+00  2.56051231e+00  2.56051231e+00
  7.37987896e+00  7.38528178e+00  7.38528178e+00  7.38528178e+00
  2.55242275e+01  2.55242275e+01  2.55242275e+01  3.47848556e+01
  1.19986162e+02  1.19986162e+02  1.19986162e+02  1.38930281e+02
  5.03037044e+02  1.87068024e+03  8.00035262e+03  4.77680085e+04]
E1 = -182.0978299039112  E_coul = 53.5685001792653
cycle= 1 E= -128.529329724646  delta_E= -0.0294  |g|= 0.203  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.552882
diis-c [-0.30567895  1.        ]
  HOMO = -0.880798347454983  LUMO = 0.711794974618095
  mo_energy =
[-3.28762924e+01 -1.96431594e+00 -8.80798347e-01 -8.80798347e-01
 -8.80798347e-01  7.11794975e-01  7.11794975e-01  7.11794975e-01
  1.17579103e+00  2.50804586e+00  2.50804586e+00  2.50804586e+00
  7.25032324e+00  7.26154801e+00  7.26154801e+00  7.26154801e+00
  2.52911204e+01  2.52911204e+01  2.52911204e+01  3.45404409e+01
  1.19663503e+02  1.19663503e+02  1.19663503e+02  1.38614519e+02
  5.02677294e+02  1.87028448e+03  7.99992785e+03  4.77675649e+04]
E1 = -182.84574483806875  E_coul = 54.31386142220609
cycle= 2 E= -128.531883415863  delta_E= -0.00255  |g|= 0.102  |ddm|= 0.0741
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.277994
diis-c [-6.10756378e-04  3.33918973e-01  6.66081027e-01]
  HOMO = -0.845717565908891  LUMO = 0.717955558499585
  mo_energy =
[-3.27696472e+01 -1.92738723e+00 -8.45717566e-01 -8.45717566e-01
 -8.45717566e-01  7.17955558e-01  7.17955558e-01  7.17955558e-01
  1.19018766e+00  2.52525741e+00  2.52525741e+00  2.52525741e+00
  7.29295427e+00  7.30222543e+00  7.30222543e+00  7.30222543e+00
  2.53686922e+01  2.53686922e+01  2.53686922e+01  3.46220397e+01
  1.19769987e+02  1.19769987e+02  1.19769987e+02  1.38719206e+02
  5.02792651e+02  1.87040504e+03  8.00005085e+03  4.77676888e+04]
E1 = -182.59481395642175  E_coul = 54.062051983960096
cycle= 3 E= -128.532761972462  delta_E= -0.000879  |g|= 0.000378  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000867903
diis-c [-1.08350122e-07 -1.91518760e-03 -9.22866053e-04  1.00283805e+00]
  HOMO = -0.845867145696653  LUMO = 0.717966131401893
  mo_energy =
[-3.27699309e+01 -1.92746497e+00 -8.45867146e-01 -8.45867146e-01
 -8.45867146e-01  7.17966131e-01  7.17966131e-01  7.17966131e-01
  1.19019384e+00  2.52522977e+00  2.52522977e+00  2.52522977e+00
  7.29286120e+00  7.30212790e+00  7.30212790e+00  7.30212790e+00
  2.53684942e+01  2.53684942e+01  2.53684942e+01  3.46218407e+01
  1.19769691e+02  1.19769691e+02  1.19769691e+02  1.38718922e+02
  5.02792264e+02  1.87040454e+03  8.00005027e+03  4.77676882e+04]
E1 = -182.5951854026629  E_coul = 54.062423414747194
cycle= 4 E= -128.532761987916  delta_E= -1.55e-08  |g|= 6.28e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000164796
diis-c [-1.38644861e-09  2.80104744e-04  6.09809907e-04 -2.09152620e-01
  1.20826271e+00]
  HOMO = -0.845890660630078  LUMO = 0.717963039562312
  mo_energy =
[-3.27699765e+01 -1.92747476e+00 -8.45890661e-01 -8.45890661e-01
 -8.45890661e-01  7.17963040e-01  7.17963040e-01  7.17963040e-01
  1.19019139e+00  2.52521889e+00  2.52521889e+00  2.52521889e+00
  7.29284021e+00  7.30210440e+00  7.30210440e+00  7.30210440e+00
  2.53684566e+01  2.53684566e+01  2.53684566e+01  3.46218032e+01
  1.19769645e+02  1.19769645e+02  1.19769645e+02  1.38718876e+02
  5.02792210e+02  1.87040448e+03  8.00005020e+03  4.77676881e+04]
E1 = -182.59531045772982  E_coul = 54.062548469209084
cycle= 5 E= -128.532761988521  delta_E= -6.05e-10  |g|= 5.36e-06  |ddm|= 6.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59531045772982  E_coul = 54.062548469209084
  HOMO = -0.845888029776566  LUMO = 0.717963558760524
  mo_energy =
[-3.27699713e+01 -1.92747133e+00 -8.45888030e-01 -8.45888030e-01
 -8.45888030e-01  7.17963559e-01  7.17963559e-01  7.17963559e-01
  1.19019312e+00  2.52522041e+00  2.52522041e+00  2.52522041e+00
  7.29284386e+00  7.30210747e+00  7.30210747e+00  7.30210747e+00
  2.53684613e+01  2.53684613e+01  2.53684613e+01  3.46218081e+01
  1.19769650e+02  1.19769650e+02  1.19769650e+02  1.38718881e+02
  5.02792214e+02  1.87040449e+03  8.00005020e+03  4.77676881e+04]
E1 = -182.59529895505054  E_coul = 54.062536966527915
Extra cycle  E= -128.532761988523  delta_E= -1.88e-12  |g|= 1.66e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9851642036978
E1 = -182.59529895505054  E_coul = 54.062536966527915
init E= -128.532761988523
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.845888842332385  LUMO = 0.717963425456318
  mo_energy =
[-3.27699739e+01 -1.92747204e+00 -8.45888842e-01 -8.45888842e-01
 -8.45888842e-01  7.17963425e-01  7.17963425e-01  7.17963425e-01
  1.19019289e+00  2.52522004e+00  2.52522004e+00  2.52522004e+00
  7.29284296e+00  7.30210654e+00  7.30210654e+00  7.30210654e+00
  2.53684594e+01  2.53684594e+01  2.53684594e+01  3.46218062e+01
  1.19769647e+02  1.19769647e+02  1.19769647e+02  1.38718878e+02
  5.02792212e+02  1.87040448e+03  8.00005020e+03  4.77676881e+04]
E1 = -182.5953053931059  E_coul = 54.06254340458284
cycle= 1 E= -128.532761988523  delta_E= -4.26e-13  |g|= 8.88e-07  |ddm|= 7.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5953053931059  E_coul = 54.06254340458284
  HOMO = -0.845888390794751  LUMO = 0.717963506298021
  mo_energy =
[-3.27699726e+01 -1.92747154e+00 -8.45888391e-01 -8.45888391e-01
 -8.45888391e-01  7.17963506e-01  7.17963506e-01  7.17963506e-01
  1.19019309e+00  2.52522027e+00  2.52522027e+00  2.52522027e+00
  7.29284352e+00  7.30210707e+00  7.30210707e+00  7.30210707e+00
  2.53684604e+01  2.53684604e+01  2.53684604e+01  3.46218072e+01
  1.19769649e+02  1.19769649e+02  1.19769649e+02  1.38718880e+02
  5.02792213e+02  1.87040448e+03  8.00005020e+03  4.77676881e+04]
E1 = -182.59530221855283  E_coul = 54.062540230029775
Extra cycle  E= -128.532761988523  delta_E=    0  |g|= 4.31e-07  |ddm|= 3.16e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330536e+01 1.00368840e+01 2.70505581e+01 3.81647557e-01
 1.11700422e+00 2.88245905e+00 3.68266555e+00 1.24502417e+01
 5.47853056e+01 3.03461815e-01 1.15584464e+00 5.00243187e-01]
grad_E = [ 3.82212229e-11 -2.01953222e-09  4.81233815e-08 -7.11748095e-07
  4.54932587e-06  3.19389821e-06  3.26941274e-06  4.98420337e-05
 -7.22482632e-06  2.64243501e-06  2.34749641e-03 -1.61894537e-04
  4.57316848e-06  2.40116347e-02 -1.44562464e-02 -1.05587559e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447001        1
[INPUT] 0    0    [1    /1   ]  833.271056797        1
[INPUT] 0    0    [1    /1   ]  235.734741084        1
[INPUT] 0    0    [1    /1   ]  76.4330292819        1
[INPUT] 0    0    [1    /1   ]  10.0368675904        1
[INPUT] 0    0    [1    /1   ]  27.0505404443        1
[INPUT] 0    0    [1    /1   ]  0.381473238238       1
[INPUT] 0    0    [1    /1   ]  1.1170190026         1
[INPUT] 0    0    [1    /1   ]  2.88244761938        1
[INPUT] 1    0    [1    /1   ]  3.67015934969        1
[INPUT] 1    0    [1    /1   ]  12.4511215225        1
[INPUT] 1    0    [1    /1   ]  54.7852803588        1
[INPUT] 1    0    [1    /1   ]  0.174117377888       1
[INPUT] 1    0    [1    /1   ]  1.23217442282        1
[INPUT] 1    0    [1    /1   ]  0.505606822491       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990325, 1.0]], [0, [3661.454470005851, 1.0]], [0, [833.2710567974935, 1.0]], [0, [235.73474108373057, 1.0]], [0, [76.43302928189163, 1.0]], [0, [10.03686759036549, 1.0]], [0, [27.050540444253123, 1.0]], [0, [0.38147323823767576, 1.0]], [0, [1.1170190025997646, 1.0]], [0, [2.882447619384803, 1.0]], [1, [3.670159349685246, 1.0]], [1, [12.451121522516909, 1.0]], [1, [54.78528035881125, 1.0]], [1, [0.17411737788822054, 1.0]], [1, [1.2321744228177538, 1.0]], [1, [0.5056068224906257, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447001]
bas 2, expnt(s) = [833.2710568]
bas 3, expnt(s) = [235.73474108]
bas 4, expnt(s) = [76.43302928]
bas 5, expnt(s) = [10.03686759]
bas 6, expnt(s) = [27.05054044]
bas 7, expnt(s) = [0.38147324]
bas 8, expnt(s) = [1.117019]
bas 9, expnt(s) = [2.88244762]
bas 10, expnt(s) = [3.67015935]
bas 11, expnt(s) = [12.45112152]
bas 12, expnt(s) = [54.78528036]
bas 13, expnt(s) = [0.17411738]
bas 14, expnt(s) = [1.23217442]
bas 15, expnt(s) = [0.50560682]
CPU time:        10.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734741e+02 1.51996195e+02
 7.64330293e+01 6.53094202e+01 1.00368676e+01 1.42466800e+01
 2.70505404e+01 2.99672564e+01 3.81473238e-01 1.22634618e+00
 1.11701900e+00 2.74511438e+00 2.88244762e+00 5.58902551e+00
 3.67015935e+00 1.48197386e+01 1.24511215e+01 6.82330811e+01
 5.47852804e+01 4.34824747e+02 1.74117378e-01 3.28123277e-01
 1.23217442e+00 3.78725571e+00 5.05606822e-01 1.24379999e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999568348156407
cond(S) = 343.93623948341985
E1 = -183.57785353534612  E_coul = 55.076950928046465
init E= -128.5009026073
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774586069093169  LUMO = 0.479221335496378
  mo_energy =
[-3.25554355e+01 -1.85292831e+00 -7.74586069e-01 -7.74586069e-01
 -7.74586069e-01  4.79221335e-01  4.79221335e-01  4.79221335e-01
  1.21916649e+00  2.16014084e+00  2.16014084e+00  2.16014084e+00
  7.10731743e+00  7.10731743e+00  7.10731743e+00  7.37898583e+00
  2.53765042e+01  2.53765042e+01  2.53765042e+01  3.47841329e+01
  1.19897320e+02  1.19897320e+02  1.19897320e+02  1.38929425e+02
  5.03036192e+02  1.87067952e+03  8.00035201e+03  4.77680080e+04]
E1 = -182.0294210673638  E_coul = 53.49886862994192
cycle= 1 E= -128.530552437422  delta_E= -0.0296  |g|= 0.21  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.541423
diis-c [-0.29313882  1.        ]
  HOMO = -0.886673966966221  LUMO = 0.466329678574641
  mo_energy =
[-3.28879766e+01 -1.97068481e+00 -8.86673967e-01 -8.86673967e-01
 -8.86673967e-01  4.66329679e-01  4.66329679e-01  4.66329679e-01
  1.17175897e+00  2.10390570e+00  2.10390570e+00  2.10390570e+00
  6.97352759e+00  6.97352759e+00  6.97352759e+00  7.24258250e+00
  2.51329975e+01  2.51329975e+01  2.51329975e+01  3.45295515e+01
  1.19563179e+02  1.19563179e+02  1.19563179e+02  1.38602253e+02
  5.02664590e+02  1.87027170e+03  7.99991512e+03  4.77675523e+04]
E1 = -182.82229185605806  E_coul = 54.2889949012196
cycle= 2 E= -128.533296954838  delta_E= -0.00274  |g|= 0.108  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278135
diis-c [-6.36040744e-04  3.38690188e-01  6.61309812e-01]
  HOMO = -0.849648815397079  LUMO = 0.470552381154805
  mo_energy =
[-3.27761779e+01 -1.93165869e+00 -8.49648815e-01 -8.49648815e-01
 -8.49648815e-01  4.70552381e-01  4.70552381e-01  4.70552381e-01
  1.18705809e+00  2.12213453e+00  2.12213453e+00  2.12213453e+00
  7.01768451e+00  7.01768451e+00  7.01768451e+00  7.28760773e+00
  2.52147570e+01  2.52147570e+01  2.52147570e+01  3.46152766e+01
  1.19674816e+02  1.19674816e+02  1.19674816e+02  1.38711997e+02
  5.02785400e+02  1.87039790e+03  8.00004384e+03  4.77676819e+04]
E1 = -182.55126775511107  E_coul = 54.01697264987358
cycle= 3 E= -128.534295105238  delta_E= -0.000998  |g|= 0.000557  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000989158
diis-c [-2.82149437e-07 -2.30581791e-03 -1.49813218e-03  1.00380395e+00]
  HOMO = -0.849914513731388  LUMO = 0.470517174779697
  mo_energy =
[-3.27766228e+01 -1.93189957e+00 -8.49914514e-01 -8.49914514e-01
 -8.49914514e-01  4.70517175e-01  4.70517175e-01  4.70517175e-01
  1.18693510e+00  2.12200276e+00  2.12200276e+00  2.12200276e+00
  7.01744172e+00  7.01744172e+00  7.01744172e+00  7.28736740e+00
  2.52144032e+01  2.52144032e+01  2.52144032e+01  3.46149192e+01
  1.19674359e+02  1.19674359e+02  1.19674359e+02  1.38711552e+02
  5.02784855e+02  1.87039724e+03  8.00004310e+03  4.77676812e+04]
E1 = -182.5513522520222  E_coul = 54.01705708468666
cycle= 4 E= -128.534295167336  delta_E= -6.21e-08  |g|= 0.000104  |ddm|= 0.000509
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000191604
diis-c [-1.34226543e-09  1.78237203e-04  5.18818591e-04 -1.84442231e-01
  1.18374517e+00]
  HOMO = -0.849971442329993  LUMO = 0.470504639993965
  mo_energy =
[-3.27767130e+01 -1.93195981e+00 -8.49971442e-01 -8.49971442e-01
 -8.49971442e-01  4.70504640e-01  4.70504640e-01  4.70504640e-01
  1.18689527e+00  2.12196177e+00  2.12196177e+00  2.12196177e+00
  7.01737487e+00  7.01737487e+00  7.01737487e+00  7.28730006e+00
  2.52143191e+01  2.52143191e+01  2.52143191e+01  3.46148341e+01
  1.19674269e+02  1.19674269e+02  1.19674269e+02  1.38711462e+02
  5.02784763e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55144458723353  E_coul = 54.01714941795295
cycle= 5 E= -128.534295169281  delta_E= -1.95e-09  |g|= 4.88e-06  |ddm|= 9.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.30811e-05
diis-c [-1.48724681e-11  6.58702792e-06 -4.78347916e-05  5.88381088e-03
 -5.19392107e-02  1.04609665e+00]
  HOMO = -0.849970146740472  LUMO = 0.470504688839695
  mo_energy =
[-3.27767096e+01 -1.93195920e+00 -8.49970147e-01 -8.49970147e-01
 -8.49970147e-01  4.70504689e-01  4.70504689e-01  4.70504689e-01
  1.18689521e+00  2.12196220e+00  2.12196220e+00  2.12196220e+00
  7.01737623e+00  7.01737623e+00  7.01737623e+00  7.28730134e+00
  2.52143217e+01  2.52143217e+01  2.52143217e+01  3.46148369e+01
  1.19674272e+02  1.19674272e+02  1.19674272e+02  1.38711465e+02
  5.02784767e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55143218624266  E_coul = 54.017137016958024
cycle= 6 E= -128.534295169285  delta_E= -4.04e-12  |g|= 5.23e-07  |ddm|= 2.94e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.55143218624266  E_coul = 54.017137016958024
  HOMO = -0.849970108712314  LUMO = 0.470504686048128
  mo_energy =
[-3.27767095e+01 -1.93195930e+00 -8.49970109e-01 -8.49970109e-01
 -8.49970109e-01  4.70504686e-01  4.70504686e-01  4.70504686e-01
  1.18689514e+00  2.12196220e+00  2.12196220e+00  2.12196220e+00
  7.01737625e+00  7.01737625e+00  7.01737625e+00  7.28730131e+00
  2.52143218e+01  2.52143218e+01  2.52143218e+01  3.46148369e+01
  1.19674272e+02  1.19674272e+02  1.19674272e+02  1.38711466e+02
  5.02784767e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55143176833764  E_coul = 54.01713659905286
Extra cycle  E= -128.534295169285  delta_E= -1.42e-13  |g|= 1.31e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734741e+02
 7.64330293e+01 1.00368676e+01 2.70505404e+01 3.81473238e-01
 1.11701900e+00 2.88244762e+00 3.67015935e+00 1.24511215e+01
 5.47852804e+01 1.74117378e-01 1.23217442e+00 5.05606822e-01]
E = -128.53429516928477
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447001        1
[INPUT] 0    0    [1    /1   ]  833.271056797        1
[INPUT] 0    0    [1    /1   ]  235.734741084        1
[INPUT] 0    0    [1    /1   ]  76.4330292819        1
[INPUT] 0    0    [1    /1   ]  10.0368675904        1
[INPUT] 0    0    [1    /1   ]  27.0505404443        1
[INPUT] 0    0    [1    /1   ]  0.381473238238       1
[INPUT] 0    0    [1    /1   ]  1.1170190026         1
[INPUT] 0    0    [1    /1   ]  2.88244761938        1
[INPUT] 1    0    [1    /1   ]  3.67015934969        1
[INPUT] 1    0    [1    /1   ]  12.4511215225        1
[INPUT] 1    0    [1    /1   ]  54.7852803588        1
[INPUT] 1    0    [1    /1   ]  0.174117377888       1
[INPUT] 1    0    [1    /1   ]  1.23217442282        1
[INPUT] 1    0    [1    /1   ]  0.505606822491       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990325, 1.0]], [0, [3661.454470005851, 1.0]], [0, [833.2710567974935, 1.0]], [0, [235.73474108373057, 1.0]], [0, [76.43302928189163, 1.0]], [0, [10.03686759036549, 1.0]], [0, [27.050540444253123, 1.0]], [0, [0.38147323823767576, 1.0]], [0, [1.1170190025997646, 1.0]], [0, [2.882447619384803, 1.0]], [1, [3.670159349685246, 1.0]], [1, [12.451121522516909, 1.0]], [1, [54.78528035881125, 1.0]], [1, [0.17411737788822054, 1.0]], [1, [1.2321744228177538, 1.0]], [1, [0.5056068224906257, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447001]
bas 2, expnt(s) = [833.2710568]
bas 3, expnt(s) = [235.73474108]
bas 4, expnt(s) = [76.43302928]
bas 5, expnt(s) = [10.03686759]
bas 6, expnt(s) = [27.05054044]
bas 7, expnt(s) = [0.38147324]
bas 8, expnt(s) = [1.117019]
bas 9, expnt(s) = [2.88244762]
bas 10, expnt(s) = [3.67015935]
bas 11, expnt(s) = [12.45112152]
bas 12, expnt(s) = [54.78528036]
bas 13, expnt(s) = [0.17411738]
bas 14, expnt(s) = [1.23217442]
bas 15, expnt(s) = [0.50560682]
CPU time:        10.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734741e+02 1.51996195e+02
 7.64330293e+01 6.53094202e+01 1.00368676e+01 1.42466800e+01
 2.70505404e+01 2.99672564e+01 3.81473238e-01 1.22634618e+00
 1.11701900e+00 2.74511438e+00 2.88244762e+00 5.58902551e+00
 3.67015935e+00 1.48197386e+01 1.24511215e+01 6.82330811e+01
 5.47852804e+01 4.34824747e+02 1.74117378e-01 3.28123277e-01
 1.23217442e+00 3.78725571e+00 5.05606822e-01 1.24379999e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999568348156407
cond(S) = 343.93623948341985
E1 = -183.57785353534612  E_coul = 55.076950928046465
init E= -128.5009026073
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774586069093169  LUMO = 0.479221335496378
  mo_energy =
[-3.25554355e+01 -1.85292831e+00 -7.74586069e-01 -7.74586069e-01
 -7.74586069e-01  4.79221335e-01  4.79221335e-01  4.79221335e-01
  1.21916649e+00  2.16014084e+00  2.16014084e+00  2.16014084e+00
  7.10731743e+00  7.10731743e+00  7.10731743e+00  7.37898583e+00
  2.53765042e+01  2.53765042e+01  2.53765042e+01  3.47841329e+01
  1.19897320e+02  1.19897320e+02  1.19897320e+02  1.38929425e+02
  5.03036192e+02  1.87067952e+03  8.00035201e+03  4.77680080e+04]
E1 = -182.0294210673638  E_coul = 53.49886862994192
cycle= 1 E= -128.530552437422  delta_E= -0.0296  |g|= 0.21  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.541423
diis-c [-0.29313882  1.        ]
  HOMO = -0.886673966966221  LUMO = 0.466329678574641
  mo_energy =
[-3.28879766e+01 -1.97068481e+00 -8.86673967e-01 -8.86673967e-01
 -8.86673967e-01  4.66329679e-01  4.66329679e-01  4.66329679e-01
  1.17175897e+00  2.10390570e+00  2.10390570e+00  2.10390570e+00
  6.97352759e+00  6.97352759e+00  6.97352759e+00  7.24258250e+00
  2.51329975e+01  2.51329975e+01  2.51329975e+01  3.45295515e+01
  1.19563179e+02  1.19563179e+02  1.19563179e+02  1.38602253e+02
  5.02664590e+02  1.87027170e+03  7.99991512e+03  4.77675523e+04]
E1 = -182.82229185605806  E_coul = 54.2889949012196
cycle= 2 E= -128.533296954838  delta_E= -0.00274  |g|= 0.108  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278135
diis-c [-6.36040744e-04  3.38690188e-01  6.61309812e-01]
  HOMO = -0.849648815397079  LUMO = 0.470552381154805
  mo_energy =
[-3.27761779e+01 -1.93165869e+00 -8.49648815e-01 -8.49648815e-01
 -8.49648815e-01  4.70552381e-01  4.70552381e-01  4.70552381e-01
  1.18705809e+00  2.12213453e+00  2.12213453e+00  2.12213453e+00
  7.01768451e+00  7.01768451e+00  7.01768451e+00  7.28760773e+00
  2.52147570e+01  2.52147570e+01  2.52147570e+01  3.46152766e+01
  1.19674816e+02  1.19674816e+02  1.19674816e+02  1.38711997e+02
  5.02785400e+02  1.87039790e+03  8.00004384e+03  4.77676819e+04]
E1 = -182.55126775511107  E_coul = 54.01697264987358
cycle= 3 E= -128.534295105238  delta_E= -0.000998  |g|= 0.000557  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000989158
diis-c [-2.82149437e-07 -2.30581791e-03 -1.49813218e-03  1.00380395e+00]
  HOMO = -0.849914513731388  LUMO = 0.470517174779697
  mo_energy =
[-3.27766228e+01 -1.93189957e+00 -8.49914514e-01 -8.49914514e-01
 -8.49914514e-01  4.70517175e-01  4.70517175e-01  4.70517175e-01
  1.18693510e+00  2.12200276e+00  2.12200276e+00  2.12200276e+00
  7.01744172e+00  7.01744172e+00  7.01744172e+00  7.28736740e+00
  2.52144032e+01  2.52144032e+01  2.52144032e+01  3.46149192e+01
  1.19674359e+02  1.19674359e+02  1.19674359e+02  1.38711552e+02
  5.02784855e+02  1.87039724e+03  8.00004310e+03  4.77676812e+04]
E1 = -182.5513522520222  E_coul = 54.01705708468666
cycle= 4 E= -128.534295167336  delta_E= -6.21e-08  |g|= 0.000104  |ddm|= 0.000509
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000191604
diis-c [-1.34226543e-09  1.78237203e-04  5.18818591e-04 -1.84442231e-01
  1.18374517e+00]
  HOMO = -0.849971442329993  LUMO = 0.470504639993965
  mo_energy =
[-3.27767130e+01 -1.93195981e+00 -8.49971442e-01 -8.49971442e-01
 -8.49971442e-01  4.70504640e-01  4.70504640e-01  4.70504640e-01
  1.18689527e+00  2.12196177e+00  2.12196177e+00  2.12196177e+00
  7.01737487e+00  7.01737487e+00  7.01737487e+00  7.28730006e+00
  2.52143191e+01  2.52143191e+01  2.52143191e+01  3.46148341e+01
  1.19674269e+02  1.19674269e+02  1.19674269e+02  1.38711462e+02
  5.02784763e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55144458723353  E_coul = 54.01714941795295
cycle= 5 E= -128.534295169281  delta_E= -1.95e-09  |g|= 4.88e-06  |ddm|= 9.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.30811e-05
diis-c [-1.48724681e-11  6.58702792e-06 -4.78347916e-05  5.88381088e-03
 -5.19392107e-02  1.04609665e+00]
  HOMO = -0.849970146740472  LUMO = 0.470504688839695
  mo_energy =
[-3.27767096e+01 -1.93195920e+00 -8.49970147e-01 -8.49970147e-01
 -8.49970147e-01  4.70504689e-01  4.70504689e-01  4.70504689e-01
  1.18689521e+00  2.12196220e+00  2.12196220e+00  2.12196220e+00
  7.01737623e+00  7.01737623e+00  7.01737623e+00  7.28730134e+00
  2.52143217e+01  2.52143217e+01  2.52143217e+01  3.46148369e+01
  1.19674272e+02  1.19674272e+02  1.19674272e+02  1.38711465e+02
  5.02784767e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55143218624266  E_coul = 54.017137016958024
cycle= 6 E= -128.534295169285  delta_E= -4.04e-12  |g|= 5.23e-07  |ddm|= 2.94e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.55143218624266  E_coul = 54.017137016958024
  HOMO = -0.849970108712314  LUMO = 0.470504686048128
  mo_energy =
[-3.27767095e+01 -1.93195930e+00 -8.49970109e-01 -8.49970109e-01
 -8.49970109e-01  4.70504686e-01  4.70504686e-01  4.70504686e-01
  1.18689514e+00  2.12196220e+00  2.12196220e+00  2.12196220e+00
  7.01737625e+00  7.01737625e+00  7.01737625e+00  7.28730131e+00
  2.52143218e+01  2.52143218e+01  2.52143218e+01  3.46148369e+01
  1.19674272e+02  1.19674272e+02  1.19674272e+02  1.38711466e+02
  5.02784767e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55143176833764  E_coul = 54.01713659905286
Extra cycle  E= -128.534295169285  delta_E= -1.42e-13  |g|= 1.31e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.93623948341985
E1 = -182.55143176833764  E_coul = 54.01713659905286
init E= -128.534295169285
    CPU time for initialize scf      0.30 sec, wall time      0.36 sec
  HOMO = -0.849970133413354  LUMO = 0.470504681451603
  mo_energy =
[-3.27767095e+01 -1.93195936e+00 -8.49970133e-01 -8.49970133e-01
 -8.49970133e-01  4.70504681e-01  4.70504681e-01  4.70504681e-01
  1.18689511e+00  2.12196218e+00  2.12196218e+00  2.12196218e+00
  7.01737622e+00  7.01737622e+00  7.01737622e+00  7.28730126e+00
  2.52143217e+01  2.52143217e+01  2.52143217e+01  3.46148368e+01
  1.19674272e+02  1.19674272e+02  1.19674272e+02  1.38711465e+02
  5.02784767e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.55143190998078  E_coul = 54.0171367406959
cycle= 1 E= -128.534295169285  delta_E= -8.53e-14  |g|= 3.08e-08  |ddm|= 8.58e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55143190998078  E_coul = 54.0171367406959
  HOMO = -0.84997012243214  LUMO = 0.470504682288329
  mo_energy =
[-3.27767095e+01 -1.93195935e+00 -8.49970122e-01 -8.49970122e-01
 -8.49970122e-01  4.70504682e-01  4.70504682e-01  4.70504682e-01
  1.18689511e+00  2.12196219e+00  2.12196219e+00  2.12196219e+00
  7.01737623e+00  7.01737623e+00  7.01737623e+00  7.28730127e+00
  2.52143217e+01  2.52143217e+01  2.52143217e+01  3.46148369e+01
  1.19674272e+02  1.19674272e+02  1.19674272e+02  1.38711466e+02
  5.02784767e+02  1.87039715e+03  8.00004301e+03  4.77676811e+04]
E1 = -182.5514318178496  E_coul = 54.017136648564794
Extra cycle  E= -128.534295169285  delta_E= 5.68e-14  |g|= 1.39e-08  |ddm|= 1.66e-08
    CPU time for scf_cycle      0.37 sec, wall time      0.42 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734741e+02
 7.64330293e+01 1.00368676e+01 2.70505404e+01 3.81473238e-01
 1.11701900e+00 2.88244762e+00 3.67015935e+00 1.24511215e+01
 5.47852804e+01 1.74117378e-01 1.23217442e+00 5.05606822e-01]
grad_E = [ 3.64543343e-11 -1.92652829e-09  4.62555261e-08 -6.89091051e-07
  4.36389572e-06 -5.95622663e-07  4.33312348e-06 -3.83533399e-04
  2.31780100e-04 -1.55318449e-05  1.53736994e-03  3.05344885e-04
 -1.61709421e-05 -5.36233359e-02 -2.97588684e-02  4.52695590e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447           1
[INPUT] 0    0    [1    /1   ]  833.271056828        1
[INPUT] 0    0    [1    /1   ]  235.734740638        1
[INPUT] 0    0    [1    /1   ]  76.4330321518        1
[INPUT] 0    0    [1    /1   ]  10.0368717419        1
[INPUT] 0    0    [1    /1   ]  27.0505418473        1
[INPUT] 0    0    [1    /1   ]  0.381766682199       1
[INPUT] 0    0    [1    /1   ]  1.11688756485        1
[INPUT] 0    0    [1    /1   ]  2.88245948306        1
[INPUT] 1    0    [1    /1   ]  3.67199565406        1
[INPUT] 1    0    [1    /1   ]  12.4508152868        1
[INPUT] 1    0    [1    /1   ]  54.7852922816        1
[INPUT] 1    0    [1    /1   ]  0.224177140395       1
[INPUT] 1    0    [1    /1   ]  1.22983795179        1
[INPUT] 1    0    [1    /1   ]  0.483245660739       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412999035, 1.0]], [0, [3661.454470004572, 1.0]], [0, [833.2710568277832, 1.0]], [0, [235.73474063826413, 1.0]], [0, [76.43303215182476, 1.0]], [0, [10.036871741931414, 1.0]], [0, [27.05054184725356, 1.0]], [0, [0.3817666821987978, 1.0]], [0, [1.1168875648477772, 1.0]], [0, [2.882459483057872, 1.0]], [1, [3.671995654057776, 1.0]], [1, [12.450815286797749, 1.0]], [1, [54.78529228162809, 1.0]], [1, [0.22417714039450393, 1.0]], [1, [1.2298379517941875, 1.0]], [1, [0.4832456607388694, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447]
bas 2, expnt(s) = [833.27105683]
bas 3, expnt(s) = [235.73474064]
bas 4, expnt(s) = [76.43303215]
bas 5, expnt(s) = [10.03687174]
bas 6, expnt(s) = [27.05054185]
bas 7, expnt(s) = [0.38176668]
bas 8, expnt(s) = [1.11688756]
bas 9, expnt(s) = [2.88245948]
bas 10, expnt(s) = [3.67199565]
bas 11, expnt(s) = [12.45081529]
bas 12, expnt(s) = [54.78529228]
bas 13, expnt(s) = [0.22417714]
bas 14, expnt(s) = [1.22983795]
bas 15, expnt(s) = [0.48324566]
CPU time:        13.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734741e+02 1.51996195e+02
 7.64330322e+01 6.53094221e+01 1.00368717e+01 1.42466844e+01
 2.70505418e+01 2.99672576e+01 3.81766682e-01 1.22705362e+00
 1.11688756e+00 2.74487212e+00 2.88245948e+00 5.58904277e+00
 3.67199565e+00 1.48290077e+01 1.24508153e+01 6.82309833e+01
 5.47852923e+01 4.34824865e+02 2.24177140e-01 4.50011434e-01
 1.22983795e+00 3.77828102e+00 4.83245661e-01 1.17542344e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964589102651
cond(S) = 343.9991850304899
E1 = -183.58164741794351  E_coul = 55.0788799287351
init E= -128.502767489208
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774533514793851  LUMO = 0.580914968002032
  mo_energy =
[-3.25552556e+01 -1.85269790e+00 -7.74533515e-01 -7.74533515e-01
 -7.74533515e-01  5.80914968e-01  5.80914968e-01  5.80914968e-01
  1.21984774e+00  2.29311422e+00  2.29311422e+00  2.29311422e+00
  7.20784126e+00  7.20784126e+00  7.20784126e+00  7.38020024e+00
  2.54475764e+01  2.54475764e+01  2.54475764e+01  3.47847095e+01
  1.19943780e+02  1.19943780e+02  1.19943780e+02  1.38930201e+02
  5.03036894e+02  1.87068000e+03  8.00035236e+03  4.77680083e+04]
E1 = -182.05425521151562  E_coul = 53.522719709793755
cycle= 1 E= -128.531535501722  delta_E= -0.0288  |g|= 0.208  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548444
diis-c [-0.30079053  1.        ]
  HOMO = -0.88480461464147  LUMO = 0.56606233941716
  mo_energy =
[-3.28843295e+01 -1.96841575e+00 -8.84804615e-01 -8.84804615e-01
 -8.84804615e-01  5.66062339e-01  5.66062339e-01  5.66062339e-01
  1.17364341e+00  2.23862455e+00  2.23862455e+00  2.23862455e+00
  7.07708999e+00  7.07708999e+00  7.07708999e+00  7.24611989e+00
  2.52074832e+01  2.52074832e+01  2.52074832e+01  3.45335999e+01
  1.19613021e+02  1.19613021e+02  1.19613021e+02  1.38606518e+02
  5.02668895e+02  1.87027596e+03  7.99991933e+03  4.77675564e+04]
E1 = -182.8315437390887  E_coul = 54.29733193961589
cycle= 2 E= -128.534211799473  delta_E= -0.00268  |g|= 0.106  |ddm|= 0.0621
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279638
diis-c [-6.28683907e-04  3.37025012e-01  6.62974988e-01]
  HOMO = -0.848451637524336  LUMO = 0.571050083787529
  mo_energy =
[-3.27742985e+01 -1.93011120e+00 -8.48451638e-01 -8.48451638e-01
 -8.48451638e-01  5.71050084e-01  5.71050084e-01  5.71050084e-01
  1.18864216e+00  2.25637552e+00  2.25637552e+00  2.25637552e+00
  7.12016421e+00  7.12016421e+00  7.12016421e+00  7.29031549e+00
  2.52878021e+01  2.52878021e+01  2.52878021e+01  3.46179079e+01
  1.19722890e+02  1.19722890e+02  1.19722890e+02  1.38714530e+02
  5.02787847e+02  1.87040025e+03  8.00004611e+03  4.77676841e+04]
E1 = -182.56822260264968  E_coul = 54.03305653658231
cycle= 3 E= -128.535166066067  delta_E= -0.000954  |g|= 0.000349  |ddm|= 0.0216
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000752172
diis-c [-7.03220949e-08 -1.83107474e-03 -1.08093291e-03  1.00291201e+00]
  HOMO = -0.848628280055871  LUMO = 0.571051755391908
  mo_energy =
[-3.27746075e+01 -1.93023672e+00 -8.48628280e-01 -8.48628280e-01
 -8.48628280e-01  5.71051755e-01  5.71051755e-01  5.71051755e-01
  1.18861217e+00  2.25632690e+00  2.25632690e+00  2.25632690e+00
  7.12003340e+00  7.12003340e+00  7.12003340e+00  7.29018518e+00
  2.52875752e+01  2.52875752e+01  2.52875752e+01  3.46176796e+01
  1.19722569e+02  1.19722569e+02  1.19722569e+02  1.38714222e+02
  5.02787443e+02  1.87039974e+03  8.00004552e+03  4.77676835e+04]
E1 = -182.5684566239578  E_coul = 54.033290548293444
cycle= 4 E= -128.535166075664  delta_E= -9.6e-09  |g|= 5.73e-05  |ddm|= 0.000187
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148111
diis-c [-8.92500941e-10  1.16122867e-04  4.74430234e-04 -1.31050709e-01
  1.13046016e+00]
  HOMO = -0.848657478303695  LUMO = 0.571047193783858
  mo_energy =
[-3.27746579e+01 -1.93025924e+00 -8.48657478e-01 -8.48657478e-01
 -8.48657478e-01  5.71047194e-01  5.71047194e-01  5.71047194e-01
  1.18860039e+00  2.25631039e+00  2.25631039e+00  2.25631039e+00
  7.12000151e+00  7.12000151e+00  7.12000151e+00  7.29015408e+00
  2.52875304e+01  2.52875304e+01  2.52875304e+01  3.46176344e+01
  1.19722519e+02  1.19722519e+02  1.19722519e+02  1.38714172e+02
  5.02787389e+02  1.87039969e+03  8.00004546e+03  4.77676834e+04]
E1 = -182.5685654181072  E_coul = 54.03339934211319
cycle= 5 E= -128.535166075994  delta_E= -3.3e-10  |g|= 3.36e-06  |ddm|= 2.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5685654181072  E_coul = 54.03339934211319
  HOMO = -0.848656561280409  LUMO = 0.571047337287974
  mo_energy =
[-3.27746561e+01 -1.93025755e+00 -8.48656561e-01 -8.48656561e-01
 -8.48656561e-01  5.71047337e-01  5.71047337e-01  5.71047337e-01
  1.18860124e+00  2.25631094e+00  2.25631094e+00  2.25631094e+00
  7.12000268e+00  7.12000268e+00  7.12000268e+00  7.29015565e+00
  2.52875321e+01  2.52875321e+01  2.52875321e+01  3.46176363e+01
  1.19722521e+02  1.19722521e+02  1.19722521e+02  1.38714173e+02
  5.02787390e+02  1.87039969e+03  8.00004546e+03  4.77676834e+04]
E1 = -182.56856097209078  E_coul = 54.033394896095395
Extra cycle  E= -128.535166075995  delta_E= -1.39e-12  |g|= 7.97e-07  |ddm|= 1.68e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734741e+02
 7.64330322e+01 1.00368717e+01 2.70505418e+01 3.81766682e-01
 1.11688756e+00 2.88245948e+00 3.67199565e+00 1.24508153e+01
 5.47852923e+01 2.24177140e-01 1.22983795e+00 4.83245661e-01]
E = -128.5351660759954
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447           1
[INPUT] 0    0    [1    /1   ]  833.271056828        1
[INPUT] 0    0    [1    /1   ]  235.734740638        1
[INPUT] 0    0    [1    /1   ]  76.4330321518        1
[INPUT] 0    0    [1    /1   ]  10.0368717419        1
[INPUT] 0    0    [1    /1   ]  27.0505418473        1
[INPUT] 0    0    [1    /1   ]  0.381766682199       1
[INPUT] 0    0    [1    /1   ]  1.11688756485        1
[INPUT] 0    0    [1    /1   ]  2.88245948306        1
[INPUT] 1    0    [1    /1   ]  3.67199565406        1
[INPUT] 1    0    [1    /1   ]  12.4508152868        1
[INPUT] 1    0    [1    /1   ]  54.7852922816        1
[INPUT] 1    0    [1    /1   ]  0.224177140395       1
[INPUT] 1    0    [1    /1   ]  1.22983795179        1
[INPUT] 1    0    [1    /1   ]  0.483245660739       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412999035, 1.0]], [0, [3661.454470004572, 1.0]], [0, [833.2710568277832, 1.0]], [0, [235.73474063826413, 1.0]], [0, [76.43303215182476, 1.0]], [0, [10.036871741931414, 1.0]], [0, [27.05054184725356, 1.0]], [0, [0.3817666821987978, 1.0]], [0, [1.1168875648477772, 1.0]], [0, [2.882459483057872, 1.0]], [1, [3.671995654057776, 1.0]], [1, [12.450815286797749, 1.0]], [1, [54.78529228162809, 1.0]], [1, [0.22417714039450393, 1.0]], [1, [1.2298379517941875, 1.0]], [1, [0.4832456607388694, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447]
bas 2, expnt(s) = [833.27105683]
bas 3, expnt(s) = [235.73474064]
bas 4, expnt(s) = [76.43303215]
bas 5, expnt(s) = [10.03687174]
bas 6, expnt(s) = [27.05054185]
bas 7, expnt(s) = [0.38176668]
bas 8, expnt(s) = [1.11688756]
bas 9, expnt(s) = [2.88245948]
bas 10, expnt(s) = [3.67199565]
bas 11, expnt(s) = [12.45081529]
bas 12, expnt(s) = [54.78529228]
bas 13, expnt(s) = [0.22417714]
bas 14, expnt(s) = [1.22983795]
bas 15, expnt(s) = [0.48324566]
CPU time:        13.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734741e+02 1.51996195e+02
 7.64330322e+01 6.53094221e+01 1.00368717e+01 1.42466844e+01
 2.70505418e+01 2.99672576e+01 3.81766682e-01 1.22705362e+00
 1.11688756e+00 2.74487212e+00 2.88245948e+00 5.58904277e+00
 3.67199565e+00 1.48290077e+01 1.24508153e+01 6.82309833e+01
 5.47852923e+01 4.34824865e+02 2.24177140e-01 4.50011434e-01
 1.22983795e+00 3.77828102e+00 4.83245661e-01 1.17542344e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964589102651
cond(S) = 343.9991850304899
E1 = -183.58164741794351  E_coul = 55.0788799287351
init E= -128.502767489208
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.774533514793851  LUMO = 0.580914968002032
  mo_energy =
[-3.25552556e+01 -1.85269790e+00 -7.74533515e-01 -7.74533515e-01
 -7.74533515e-01  5.80914968e-01  5.80914968e-01  5.80914968e-01
  1.21984774e+00  2.29311422e+00  2.29311422e+00  2.29311422e+00
  7.20784126e+00  7.20784126e+00  7.20784126e+00  7.38020024e+00
  2.54475764e+01  2.54475764e+01  2.54475764e+01  3.47847095e+01
  1.19943780e+02  1.19943780e+02  1.19943780e+02  1.38930201e+02
  5.03036894e+02  1.87068000e+03  8.00035236e+03  4.77680083e+04]
E1 = -182.05425521151562  E_coul = 53.522719709793755
cycle= 1 E= -128.531535501722  delta_E= -0.0288  |g|= 0.208  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548444
diis-c [-0.30079053  1.        ]
  HOMO = -0.88480461464147  LUMO = 0.56606233941716
  mo_energy =
[-3.28843295e+01 -1.96841575e+00 -8.84804615e-01 -8.84804615e-01
 -8.84804615e-01  5.66062339e-01  5.66062339e-01  5.66062339e-01
  1.17364341e+00  2.23862455e+00  2.23862455e+00  2.23862455e+00
  7.07708999e+00  7.07708999e+00  7.07708999e+00  7.24611989e+00
  2.52074832e+01  2.52074832e+01  2.52074832e+01  3.45335999e+01
  1.19613021e+02  1.19613021e+02  1.19613021e+02  1.38606518e+02
  5.02668895e+02  1.87027596e+03  7.99991933e+03  4.77675564e+04]
E1 = -182.8315437390887  E_coul = 54.29733193961589
cycle= 2 E= -128.534211799473  delta_E= -0.00268  |g|= 0.106  |ddm|= 0.0621
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279638
diis-c [-6.28683907e-04  3.37025012e-01  6.62974988e-01]
  HOMO = -0.848451637524336  LUMO = 0.571050083787529
  mo_energy =
[-3.27742985e+01 -1.93011120e+00 -8.48451638e-01 -8.48451638e-01
 -8.48451638e-01  5.71050084e-01  5.71050084e-01  5.71050084e-01
  1.18864216e+00  2.25637552e+00  2.25637552e+00  2.25637552e+00
  7.12016421e+00  7.12016421e+00  7.12016421e+00  7.29031549e+00
  2.52878021e+01  2.52878021e+01  2.52878021e+01  3.46179079e+01
  1.19722890e+02  1.19722890e+02  1.19722890e+02  1.38714530e+02
  5.02787847e+02  1.87040025e+03  8.00004611e+03  4.77676841e+04]
E1 = -182.56822260264968  E_coul = 54.03305653658231
cycle= 3 E= -128.535166066067  delta_E= -0.000954  |g|= 0.000349  |ddm|= 0.0216
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000752172
diis-c [-7.03220949e-08 -1.83107474e-03 -1.08093291e-03  1.00291201e+00]
  HOMO = -0.848628280055871  LUMO = 0.571051755391908
  mo_energy =
[-3.27746075e+01 -1.93023672e+00 -8.48628280e-01 -8.48628280e-01
 -8.48628280e-01  5.71051755e-01  5.71051755e-01  5.71051755e-01
  1.18861217e+00  2.25632690e+00  2.25632690e+00  2.25632690e+00
  7.12003340e+00  7.12003340e+00  7.12003340e+00  7.29018518e+00
  2.52875752e+01  2.52875752e+01  2.52875752e+01  3.46176796e+01
  1.19722569e+02  1.19722569e+02  1.19722569e+02  1.38714222e+02
  5.02787443e+02  1.87039974e+03  8.00004552e+03  4.77676835e+04]
E1 = -182.5684566239578  E_coul = 54.033290548293444
cycle= 4 E= -128.535166075664  delta_E= -9.6e-09  |g|= 5.73e-05  |ddm|= 0.000187
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148111
diis-c [-8.92500941e-10  1.16122867e-04  4.74430234e-04 -1.31050709e-01
  1.13046016e+00]
  HOMO = -0.848657478303695  LUMO = 0.571047193783858
  mo_energy =
[-3.27746579e+01 -1.93025924e+00 -8.48657478e-01 -8.48657478e-01
 -8.48657478e-01  5.71047194e-01  5.71047194e-01  5.71047194e-01
  1.18860039e+00  2.25631039e+00  2.25631039e+00  2.25631039e+00
  7.12000151e+00  7.12000151e+00  7.12000151e+00  7.29015408e+00
  2.52875304e+01  2.52875304e+01  2.52875304e+01  3.46176344e+01
  1.19722519e+02  1.19722519e+02  1.19722519e+02  1.38714172e+02
  5.02787389e+02  1.87039969e+03  8.00004546e+03  4.77676834e+04]
E1 = -182.5685654181072  E_coul = 54.03339934211319
cycle= 5 E= -128.535166075994  delta_E= -3.3e-10  |g|= 3.36e-06  |ddm|= 2.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5685654181072  E_coul = 54.03339934211319
  HOMO = -0.848656561280409  LUMO = 0.571047337287974
  mo_energy =
[-3.27746561e+01 -1.93025755e+00 -8.48656561e-01 -8.48656561e-01
 -8.48656561e-01  5.71047337e-01  5.71047337e-01  5.71047337e-01
  1.18860124e+00  2.25631094e+00  2.25631094e+00  2.25631094e+00
  7.12000268e+00  7.12000268e+00  7.12000268e+00  7.29015565e+00
  2.52875321e+01  2.52875321e+01  2.52875321e+01  3.46176363e+01
  1.19722521e+02  1.19722521e+02  1.19722521e+02  1.38714173e+02
  5.02787390e+02  1.87039969e+03  8.00004546e+03  4.77676834e+04]
E1 = -182.56856097209078  E_coul = 54.033394896095395
Extra cycle  E= -128.535166075995  delta_E= -1.39e-12  |g|= 7.97e-07  |ddm|= 1.68e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9991850304899
E1 = -182.56856097209078  E_coul = 54.033394896095395
init E= -128.535166075995
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848656899134442  LUMO = 0.571047294977402
  mo_energy =
[-3.27746571e+01 -1.93025775e+00 -8.48656899e-01 -8.48656899e-01
 -8.48656899e-01  5.71047295e-01  5.71047295e-01  5.71047295e-01
  1.18860119e+00  2.25631079e+00  2.25631079e+00  2.25631079e+00
  7.12000231e+00  7.12000231e+00  7.12000231e+00  7.29015533e+00
  2.52875314e+01  2.52875314e+01  2.52875314e+01  3.46176356e+01
  1.19722520e+02  1.19722520e+02  1.19722520e+02  1.38714172e+02
  5.02787389e+02  1.87039968e+03  8.00004546e+03  4.77676834e+04]
E1 = -182.56856355192218  E_coul = 54.03339747592658
cycle= 1 E= -128.535166075996  delta_E= -2.27e-13  |g|= 3.79e-07  |ddm|= 3.33e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56856355192218  E_coul = 54.03339747592658
  HOMO = -0.848656721992937  LUMO = 0.571047320480401
  mo_energy =
[-3.27746566e+01 -1.93025753e+00 -8.48656722e-01 -8.48656722e-01
 -8.48656722e-01  5.71047320e-01  5.71047320e-01  5.71047320e-01
  1.18860128e+00  2.25631088e+00  2.25631088e+00  2.25631088e+00
  7.12000252e+00  7.12000252e+00  7.12000252e+00  7.29015556e+00
  2.52875318e+01  2.52875318e+01  2.52875318e+01  3.46176360e+01
  1.19722520e+02  1.19722520e+02  1.19722520e+02  1.38714173e+02
  5.02787389e+02  1.87039968e+03  8.00004546e+03  4.77676834e+04]
E1 = -182.5685622877577  E_coul = 54.0333962117623
Extra cycle  E= -128.535166075995  delta_E= 2.27e-13  |g|= 1.72e-07  |ddm|= 1.47e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734741e+02
 7.64330322e+01 1.00368717e+01 2.70505418e+01 3.81766682e-01
 1.11688756e+00 2.88245948e+00 3.67199565e+00 1.24508153e+01
 5.47852923e+01 2.24177140e-01 1.22983795e+00 4.83245661e-01]
grad_E = [ 3.76061293e-11 -1.98788855e-09  4.74923040e-08 -7.05280826e-07
  4.51677814e-06  6.64791142e-06  3.04600146e-06  3.54080868e-04
 -1.36456202e-04  2.45211198e-05 -6.57120523e-03  1.12321196e-03
 -4.27252358e-05  1.89394121e-02 -2.48262514e-03 -5.05388922e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447001        1
[INPUT] 0    0    [1    /1   ]  833.271056723        1
[INPUT] 0    0    [1    /1   ]  235.734742194        1
[INPUT] 0    0    [1    /1   ]  76.4330222134        1
[INPUT] 0    0    [1    /1   ]  10.0368633904        1
[INPUT] 0    0    [1    /1   ]  27.0505344602        1
[INPUT] 0    0    [1    /1   ]  0.381585502807       1
[INPUT] 0    0    [1    /1   ]  1.11692751448        1
[INPUT] 0    0    [1    /1   ]  2.88244297686        1
[INPUT] 1    0    [1    /1   ]  3.67397066327        1
[INPUT] 1    0    [1    /1   ]  12.4500605852        1
[INPUT] 1    0    [1    /1   ]  54.7853239258        1
[INPUT] 1    0    [1    /1   ]  0.19521948963        1
[INPUT] 1    0    [1    /1   ]  1.25594249971        1
[INPUT] 1    0    [1    /1   ]  0.476263438014       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990267, 1.0]], [0, [3661.454470008968, 1.0]], [0, [833.2710567228306, 1.0]], [0, [235.73474219422496, 1.0]], [0, [76.43302221343797, 1.0]], [0, [10.036863390433767, 1.0]], [0, [27.050534460155653, 1.0]], [0, [0.3815855028070479, 1.0]], [0, [1.1169275144760964, 1.0]], [0, [2.8824429768553843, 1.0]], [1, [3.6739706632690283, 1.0]], [1, [12.450060585249375, 1.0]], [1, [54.78532392576808, 1.0]], [1, [0.19521948962950247, 1.0]], [1, [1.255942499714989, 1.0]], [1, [0.4762634380135822, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447001]
bas 2, expnt(s) = [833.27105672]
bas 3, expnt(s) = [235.73474219]
bas 4, expnt(s) = [76.43302221]
bas 5, expnt(s) = [10.03686339]
bas 6, expnt(s) = [27.05053446]
bas 7, expnt(s) = [0.3815855]
bas 8, expnt(s) = [1.11692751]
bas 9, expnt(s) = [2.88244298]
bas 10, expnt(s) = [3.67397066]
bas 11, expnt(s) = [12.45006059]
bas 12, expnt(s) = [54.78532393]
bas 13, expnt(s) = [0.19521949]
bas 14, expnt(s) = [1.2559425]
bas 15, expnt(s) = [0.47626344]
CPU time:        16.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734742e+02 1.51996196e+02
 7.64330222e+01 6.53094157e+01 1.00368634e+01 1.42466756e+01
 2.70505345e+01 2.99672514e+01 3.81585503e-01 1.22661684e+00
 1.11692751e+00 2.74494575e+00 2.88244298e+00 5.58901876e+00
 3.67397066e+00 1.48389782e+01 1.24500606e+01 6.82258136e+01
 5.47853239e+01 4.34825179e+02 1.95219490e-01 3.78563169e-01
 1.25594250e+00 3.87879287e+00 4.76263438e-01 1.15423289e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999820842342395
cond(S) = 343.9526177045232
E1 = -183.58218432983261  E_coul = 55.07894874452372
init E= -128.503235585309
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774610104485702  LUMO = 0.518487394255948
  mo_energy =
[-3.25552496e+01 -1.85268421e+00 -7.74610104e-01 -7.74610104e-01
 -7.74610104e-01  5.18487394e-01  5.18487394e-01  5.18487394e-01
  1.21940296e+00  2.18431961e+00  2.18431961e+00  2.18431961e+00
  7.14274351e+00  7.14274351e+00  7.14274351e+00  7.37953900e+00
  2.54337886e+01  2.54337886e+01  2.54337886e+01  3.47839590e+01
  1.19942634e+02  1.19942634e+02  1.19942634e+02  1.38929547e+02
  5.03036279e+02  1.87067942e+03  8.00035183e+03  4.77680078e+04]
E1 = -182.04152581085998  E_coul = 53.50961954002896
cycle= 1 E= -128.531906270831  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.543153
diis-c [-0.29501508  1.        ]
  HOMO = -0.885920435269352  LUMO = 0.505175825419371
  mo_energy =
[-3.28865773e+01 -1.96960085e+00 -8.85920435e-01 -8.85920435e-01
 -8.85920435e-01  5.05175825e-01  5.05175825e-01  5.05175825e-01
  1.17247246e+00  2.12923540e+00  2.12923540e+00  2.12923540e+00
  7.00954039e+00  7.00954039e+00  7.00954039e+00  7.24415223e+00
  2.51916519e+01  2.51916519e+01  2.51916519e+01  3.45309768e+01
  1.19609617e+02  1.19609617e+02  1.19609617e+02  1.38603656e+02
  5.02665984e+02  1.87027308e+03  7.99991650e+03  4.77675537e+04]
E1 = -182.8268805675269  E_coul = 54.29226556171335
cycle= 2 E= -128.534615005814  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278078
diis-c [-6.34146414e-04  3.37930829e-01  6.62069171e-01]
  HOMO = -0.849222364367351  LUMO = 0.509617629389798
  mo_energy =
[-3.27756356e+01 -1.93092276e+00 -8.49222364e-01 -8.49222364e-01
 -8.49222364e-01  5.09617629e-01  5.09617629e-01  5.09617629e-01
  1.18763039e+00  2.14712741e+00  2.14712741e+00  2.14712741e+00
  7.05342737e+00  7.05342737e+00  7.05342737e+00  7.28877386e+00
  2.52727419e+01  2.52727419e+01  2.52727419e+01  3.46160156e+01
  1.19720397e+02  1.19720397e+02  1.19720397e+02  1.38712564e+02
  5.02785903e+02  1.87039837e+03  8.00004430e+03  4.77676824e+04]
E1 = -182.55993976706122  E_coul = 54.024348591325904
cycle= 3 E= -128.535591175735  delta_E= -0.000976  |g|= 0.000363  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000742053
diis-c [-7.89150082e-08 -1.86294830e-03 -1.17764624e-03  1.00304059e+00]
  HOMO = -0.849418537580048  LUMO = 0.509614056812252
  mo_energy =
[-3.27759668e+01 -1.93107582e+00 -8.49418538e-01 -8.49418538e-01
 -8.49418538e-01  5.09614057e-01  5.09614057e-01  5.09614057e-01
  1.18757984e+00  2.14706373e+00  2.14706373e+00  2.14706373e+00
  7.05327255e+00  7.05327255e+00  7.05327255e+00  7.28861833e+00
  2.52724913e+01  2.52724913e+01  2.52724913e+01  3.46157633e+01
  1.19720054e+02  1.19720054e+02  1.19720054e+02  1.38712234e+02
  5.02785480e+02  1.87039784e+03  8.00004369e+03  4.77676818e+04]
E1 = -182.56012449493926  E_coul = 54.02453330798186
cycle= 4 E= -128.535591186957  delta_E= -1.12e-08  |g|= 6.03e-05  |ddm|= 0.000196
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000144594
diis-c [-6.84754038e-10  8.91761816e-05  4.39428644e-04 -1.20631816e-01
  1.12010321e+00]
  HOMO = -0.849451825902643  LUMO = 0.509608705049672
  mo_energy =
[-3.27760216e+01 -1.93110499e+00 -8.49451826e-01 -8.49451826e-01
 -8.49451826e-01  5.09608705e-01  5.09608705e-01  5.09608705e-01
  1.18756316e+00  2.14704357e+00  2.14704357e+00  2.14704357e+00
  7.05323518e+00  7.05323518e+00  7.05323518e+00  7.28858125e+00
  2.52724411e+01  2.52724411e+01  2.52724411e+01  3.46157127e+01
  1.19720000e+02  1.19720000e+02  1.19720000e+02  1.38712179e+02
  5.02785423e+02  1.87039778e+03  8.00004363e+03  4.77676817e+04]
E1 = -182.56022595588178  E_coul = 54.02463476857607
cycle= 5 E= -128.535591187306  delta_E= -3.48e-10  |g|= 2.52e-06  |ddm|= 2.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56022595588178  E_coul = 54.02463476857607
  HOMO = -0.849451318926014  LUMO = 0.509608714744911
  mo_energy =
[-3.27760203e+01 -1.93110399e+00 -8.49451319e-01 -8.49451319e-01
 -8.49451319e-01  5.09608715e-01  5.09608715e-01  5.09608715e-01
  1.18756352e+00  2.14704376e+00  2.14704376e+00  2.14704376e+00
  7.05323584e+00  7.05323584e+00  7.05323584e+00  7.28858218e+00
  2.52724423e+01  2.52724423e+01  2.52724423e+01  3.46157141e+01
  1.19720001e+02  1.19720001e+02  1.19720001e+02  1.38712180e+02
  5.02785424e+02  1.87039778e+03  8.00004363e+03  4.77676817e+04]
E1 = -182.5602209250929  E_coul = 54.024629737786746
Extra cycle  E= -128.535591187306  delta_E= -4.55e-13  |g|= 7.13e-07  |ddm|= 1.69e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734742e+02
 7.64330222e+01 1.00368634e+01 2.70505345e+01 3.81585503e-01
 1.11692751e+00 2.88244298e+00 3.67397066e+00 1.24500606e+01
 5.47853239e+01 1.95219490e-01 1.25594250e+00 4.76263438e-01]
E = -128.53559118730615
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447001        1
[INPUT] 0    0    [1    /1   ]  833.271056723        1
[INPUT] 0    0    [1    /1   ]  235.734742194        1
[INPUT] 0    0    [1    /1   ]  76.4330222134        1
[INPUT] 0    0    [1    /1   ]  10.0368633904        1
[INPUT] 0    0    [1    /1   ]  27.0505344602        1
[INPUT] 0    0    [1    /1   ]  0.381585502807       1
[INPUT] 0    0    [1    /1   ]  1.11692751448        1
[INPUT] 0    0    [1    /1   ]  2.88244297686        1
[INPUT] 1    0    [1    /1   ]  3.67397066327        1
[INPUT] 1    0    [1    /1   ]  12.4500605852        1
[INPUT] 1    0    [1    /1   ]  54.7853239258        1
[INPUT] 1    0    [1    /1   ]  0.19521948963        1
[INPUT] 1    0    [1    /1   ]  1.25594249971        1
[INPUT] 1    0    [1    /1   ]  0.476263438014       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990267, 1.0]], [0, [3661.454470008968, 1.0]], [0, [833.2710567228306, 1.0]], [0, [235.73474219422496, 1.0]], [0, [76.43302221343797, 1.0]], [0, [10.036863390433767, 1.0]], [0, [27.050534460155653, 1.0]], [0, [0.3815855028070479, 1.0]], [0, [1.1169275144760964, 1.0]], [0, [2.8824429768553843, 1.0]], [1, [3.6739706632690283, 1.0]], [1, [12.450060585249375, 1.0]], [1, [54.78532392576808, 1.0]], [1, [0.19521948962950247, 1.0]], [1, [1.255942499714989, 1.0]], [1, [0.4762634380135822, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447001]
bas 2, expnt(s) = [833.27105672]
bas 3, expnt(s) = [235.73474219]
bas 4, expnt(s) = [76.43302221]
bas 5, expnt(s) = [10.03686339]
bas 6, expnt(s) = [27.05053446]
bas 7, expnt(s) = [0.3815855]
bas 8, expnt(s) = [1.11692751]
bas 9, expnt(s) = [2.88244298]
bas 10, expnt(s) = [3.67397066]
bas 11, expnt(s) = [12.45006059]
bas 12, expnt(s) = [54.78532393]
bas 13, expnt(s) = [0.19521949]
bas 14, expnt(s) = [1.2559425]
bas 15, expnt(s) = [0.47626344]
CPU time:        16.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734742e+02 1.51996196e+02
 7.64330222e+01 6.53094157e+01 1.00368634e+01 1.42466756e+01
 2.70505345e+01 2.99672514e+01 3.81585503e-01 1.22661684e+00
 1.11692751e+00 2.74494575e+00 2.88244298e+00 5.58901876e+00
 3.67397066e+00 1.48389782e+01 1.24500606e+01 6.82258136e+01
 5.47853239e+01 4.34825179e+02 1.95219490e-01 3.78563169e-01
 1.25594250e+00 3.87879287e+00 4.76263438e-01 1.15423289e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999820842342395
cond(S) = 343.9526177045232
E1 = -183.58218432983261  E_coul = 55.07894874452372
init E= -128.503235585309
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774610104485702  LUMO = 0.518487394255948
  mo_energy =
[-3.25552496e+01 -1.85268421e+00 -7.74610104e-01 -7.74610104e-01
 -7.74610104e-01  5.18487394e-01  5.18487394e-01  5.18487394e-01
  1.21940296e+00  2.18431961e+00  2.18431961e+00  2.18431961e+00
  7.14274351e+00  7.14274351e+00  7.14274351e+00  7.37953900e+00
  2.54337886e+01  2.54337886e+01  2.54337886e+01  3.47839590e+01
  1.19942634e+02  1.19942634e+02  1.19942634e+02  1.38929547e+02
  5.03036279e+02  1.87067942e+03  8.00035183e+03  4.77680078e+04]
E1 = -182.04152581085998  E_coul = 53.50961954002896
cycle= 1 E= -128.531906270831  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.543153
diis-c [-0.29501508  1.        ]
  HOMO = -0.885920435269352  LUMO = 0.505175825419371
  mo_energy =
[-3.28865773e+01 -1.96960085e+00 -8.85920435e-01 -8.85920435e-01
 -8.85920435e-01  5.05175825e-01  5.05175825e-01  5.05175825e-01
  1.17247246e+00  2.12923540e+00  2.12923540e+00  2.12923540e+00
  7.00954039e+00  7.00954039e+00  7.00954039e+00  7.24415223e+00
  2.51916519e+01  2.51916519e+01  2.51916519e+01  3.45309768e+01
  1.19609617e+02  1.19609617e+02  1.19609617e+02  1.38603656e+02
  5.02665984e+02  1.87027308e+03  7.99991650e+03  4.77675537e+04]
E1 = -182.8268805675269  E_coul = 54.29226556171335
cycle= 2 E= -128.534615005814  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278078
diis-c [-6.34146414e-04  3.37930829e-01  6.62069171e-01]
  HOMO = -0.849222364367351  LUMO = 0.509617629389798
  mo_energy =
[-3.27756356e+01 -1.93092276e+00 -8.49222364e-01 -8.49222364e-01
 -8.49222364e-01  5.09617629e-01  5.09617629e-01  5.09617629e-01
  1.18763039e+00  2.14712741e+00  2.14712741e+00  2.14712741e+00
  7.05342737e+00  7.05342737e+00  7.05342737e+00  7.28877386e+00
  2.52727419e+01  2.52727419e+01  2.52727419e+01  3.46160156e+01
  1.19720397e+02  1.19720397e+02  1.19720397e+02  1.38712564e+02
  5.02785903e+02  1.87039837e+03  8.00004430e+03  4.77676824e+04]
E1 = -182.55993976706122  E_coul = 54.024348591325904
cycle= 3 E= -128.535591175735  delta_E= -0.000976  |g|= 0.000363  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000742053
diis-c [-7.89150082e-08 -1.86294830e-03 -1.17764624e-03  1.00304059e+00]
  HOMO = -0.849418537580048  LUMO = 0.509614056812252
  mo_energy =
[-3.27759668e+01 -1.93107582e+00 -8.49418538e-01 -8.49418538e-01
 -8.49418538e-01  5.09614057e-01  5.09614057e-01  5.09614057e-01
  1.18757984e+00  2.14706373e+00  2.14706373e+00  2.14706373e+00
  7.05327255e+00  7.05327255e+00  7.05327255e+00  7.28861833e+00
  2.52724913e+01  2.52724913e+01  2.52724913e+01  3.46157633e+01
  1.19720054e+02  1.19720054e+02  1.19720054e+02  1.38712234e+02
  5.02785480e+02  1.87039784e+03  8.00004369e+03  4.77676818e+04]
E1 = -182.56012449493926  E_coul = 54.02453330798186
cycle= 4 E= -128.535591186957  delta_E= -1.12e-08  |g|= 6.03e-05  |ddm|= 0.000196
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000144594
diis-c [-6.84754038e-10  8.91761816e-05  4.39428644e-04 -1.20631816e-01
  1.12010321e+00]
  HOMO = -0.849451825902643  LUMO = 0.509608705049672
  mo_energy =
[-3.27760216e+01 -1.93110499e+00 -8.49451826e-01 -8.49451826e-01
 -8.49451826e-01  5.09608705e-01  5.09608705e-01  5.09608705e-01
  1.18756316e+00  2.14704357e+00  2.14704357e+00  2.14704357e+00
  7.05323518e+00  7.05323518e+00  7.05323518e+00  7.28858125e+00
  2.52724411e+01  2.52724411e+01  2.52724411e+01  3.46157127e+01
  1.19720000e+02  1.19720000e+02  1.19720000e+02  1.38712179e+02
  5.02785423e+02  1.87039778e+03  8.00004363e+03  4.77676817e+04]
E1 = -182.56022595588178  E_coul = 54.02463476857607
cycle= 5 E= -128.535591187306  delta_E= -3.48e-10  |g|= 2.52e-06  |ddm|= 2.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56022595588178  E_coul = 54.02463476857607
  HOMO = -0.849451318926014  LUMO = 0.509608714744911
  mo_energy =
[-3.27760203e+01 -1.93110399e+00 -8.49451319e-01 -8.49451319e-01
 -8.49451319e-01  5.09608715e-01  5.09608715e-01  5.09608715e-01
  1.18756352e+00  2.14704376e+00  2.14704376e+00  2.14704376e+00
  7.05323584e+00  7.05323584e+00  7.05323584e+00  7.28858218e+00
  2.52724423e+01  2.52724423e+01  2.52724423e+01  3.46157141e+01
  1.19720001e+02  1.19720001e+02  1.19720001e+02  1.38712180e+02
  5.02785424e+02  1.87039778e+03  8.00004363e+03  4.77676817e+04]
E1 = -182.5602209250929  E_coul = 54.024629737786746
Extra cycle  E= -128.535591187306  delta_E= -4.55e-13  |g|= 7.13e-07  |ddm|= 1.69e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9526177045232
E1 = -182.5602209250929  E_coul = 54.024629737786746
init E= -128.535591187306
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.849451705734788  LUMO = 0.509608659019457
  mo_energy =
[-3.27760213e+01 -1.93110431e+00 -8.49451706e-01 -8.49451706e-01
 -8.49451706e-01  5.09608659e-01  5.09608659e-01  5.09608659e-01
  1.18756338e+00  2.14704356e+00  2.14704356e+00  2.14704356e+00
  7.05323539e+00  7.05323539e+00  7.05323539e+00  7.28858177e+00
  2.52724416e+01  2.52724416e+01  2.52724416e+01  3.46157133e+01
  1.19720000e+02  1.19720000e+02  1.19720000e+02  1.38712179e+02
  5.02785423e+02  1.87039778e+03  8.00004363e+03  4.77676817e+04]
E1 = -182.5602232796415  E_coul = 54.02463209233509
cycle= 1 E= -128.535591187306  delta_E= -2.56e-13  |g|= 3.39e-07  |ddm|= 2.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5602232796415  E_coul = 54.02463209233509
  HOMO = -0.849451544967451  LUMO = 0.509608677227685
  mo_energy =
[-3.27760208e+01 -1.93110413e+00 -8.49451545e-01 -8.49451545e-01
 -8.49451545e-01  5.09608677e-01  5.09608677e-01  5.09608677e-01
  1.18756346e+00  2.14704363e+00  2.14704363e+00  2.14704363e+00
  7.05323558e+00  7.05323558e+00  7.05323558e+00  7.28858197e+00
  2.52724419e+01  2.52724419e+01  2.52724419e+01  3.46157137e+01
  1.19720000e+02  1.19720000e+02  1.19720000e+02  1.38712180e+02
  5.02785423e+02  1.87039778e+03  8.00004363e+03  4.77676817e+04]
E1 = -182.5602220257589  E_coul = 54.02463083845253
Extra cycle  E= -128.535591187306  delta_E= 5.68e-14  |g|= 1.68e-07  |ddm|= 1.24e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734742e+02
 7.64330222e+01 1.00368634e+01 2.70505345e+01 3.81585503e-01
 1.11692751e+00 2.88244298e+00 3.67397066e+00 1.24500606e+01
 5.47853239e+01 1.95219490e-01 1.25594250e+00 4.76263438e-01]
grad_E = [ 3.67789829e-11 -1.94442221e-09  4.66186313e-08 -6.94778262e-07
  4.43249174e-06  5.56615632e-06  3.48162365e-06  1.95809021e-04
 -9.40919328e-05  2.28649901e-05 -9.44702563e-03  1.51888559e-03
 -5.61566583e-05  1.06042603e-02  2.24532706e-03 -5.07227640e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447001        1
[INPUT] 0    0    [1    /1   ]  833.271056595        1
[INPUT] 0    0    [1    /1   ]  235.734744099        1
[INPUT] 0    0    [1    /1   ]  76.4330100639        1
[INPUT] 0    0    [1    /1   ]  10.0368516731        1
[INPUT] 0    0    [1    /1   ]  27.0505249332        1
[INPUT] 0    0    [1    /1   ]  0.381316822428       1
[INPUT] 0    0    [1    /1   ]  1.11703330614        1
[INPUT] 0    0    [1    /1   ]  2.88240645938        1
[INPUT] 1    0    [1    /1   ]  3.68755569087        1
[INPUT] 1    0    [1    /1   ]  12.4475705459        1
[INPUT] 1    0    [1    /1   ]  54.7854183175        1
[INPUT] 1    0    [1    /1   ]  0.170999913053       1
[INPUT] 1    0    [1    /1   ]  1.27095805274        1
[INPUT] 1    0    [1    /1   ]  0.474517718281       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990165, 1.0]], [0, [3661.45447001432, 1.0]], [0, [833.2710565947372, 1.0]], [0, [235.73474409881723, 1.0]], [0, [76.43301006393024, 1.0]], [0, [10.036851673103357, 1.0]], [0, [27.050524933208926, 1.0]], [0, [0.3813168224279535, 1.0]], [0, [1.1170333061375417, 1.0]], [0, [2.882406459380901, 1.0]], [1, [3.6875556908672613, 1.0]], [1, [12.44757054592388, 1.0]], [1, [54.78541831754465, 1.0]], [1, [0.1709999130532493, 1.0]], [1, [1.2709580527389748, 1.0]], [1, [0.47451771828145733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447001]
bas 2, expnt(s) = [833.27105659]
bas 3, expnt(s) = [235.7347441]
bas 4, expnt(s) = [76.43301006]
bas 5, expnt(s) = [10.03685167]
bas 6, expnt(s) = [27.05052493]
bas 7, expnt(s) = [0.38131682]
bas 8, expnt(s) = [1.11703331]
bas 9, expnt(s) = [2.88240646]
bas 10, expnt(s) = [3.68755569]
bas 11, expnt(s) = [12.44757055]
bas 12, expnt(s) = [54.78541832]
bas 13, expnt(s) = [0.17099991]
bas 14, expnt(s) = [1.27095805]
bas 15, expnt(s) = [0.47451772]
CPU time:        19.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734744e+02 1.51996197e+02
 7.64330101e+01 6.53094079e+01 1.00368517e+01 1.42466631e+01
 2.70505249e+01 2.99672435e+01 3.81316822e-01 1.22596903e+00
 1.11703331e+00 2.74514075e+00 2.88240646e+00 5.58896566e+00
 3.68755569e+00 1.49075964e+01 1.24475705e+01 6.82087574e+01
 5.47854183e+01 4.34826116e+02 1.70999913e-01 3.20796229e-01
 1.27095805e+00 3.93684589e+00 4.74517718e-01 1.14894684e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999859378795438
cond(S) = 343.8915326745549
E1 = -183.58240372970084  E_coul = 55.07894239317804
init E= -128.503461336523
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774640283351397  LUMO = 0.464004498226897
  mo_energy =
[-3.25552523e+01 -1.85268782e+00 -7.74640283e-01 -7.74640283e-01
 -7.74640283e-01  4.64004498e-01  4.64004498e-01  4.64004498e-01
  1.21878679e+00  2.09637081e+00  2.09637081e+00  2.09637081e+00
  7.09550472e+00  7.09550472e+00  7.09550472e+00  7.37861681e+00
  2.54466154e+01  2.54466154e+01  2.54466154e+01  3.47831501e+01
  1.19965393e+02  1.19965393e+02  1.19965393e+02  1.38928738e+02
  5.03035520e+02  1.87067875e+03  8.00035126e+03  4.77680074e+04]
E1 = -182.0350625927263  E_coul = 53.50302515359828
cycle= 1 E= -128.532037439128  delta_E= -0.0286  |g|= 0.21  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53695
diis-c [-0.2883156  1.       ]
  HOMO = -0.88650255768756  LUMO = 0.452058041519152
  mo_energy =
[-3.28875920e+01 -1.97022603e+00 -8.86502558e-01 -8.86502558e-01
 -8.86502558e-01  4.52058042e-01  4.52058042e-01  4.52058042e-01
  1.17146468e+00  2.04087894e+00  2.04087894e+00  2.04087894e+00
  6.96057524e+00  6.96057524e+00  6.96057524e+00  7.24252743e+00
  2.52033506e+01  2.52033506e+01  2.52033506e+01  3.45291997e+01
  1.19631385e+02  1.19631385e+02  1.19631385e+02  1.38601835e+02
  5.02664174e+02  1.87027132e+03  7.99991482e+03  4.77675521e+04]
E1 = -182.82472195549866  E_coul = 54.2899600300823
cycle= 2 E= -128.534761925416  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0635
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27559
diis-c [-6.35582608e-04  3.38476872e-01  6.61523128e-01]
  HOMO = -0.849622031169444  LUMO = 0.456013997460279
  mo_energy =
[-3.27761836e+01 -1.93135141e+00 -8.49622031e-01 -8.49622031e-01
 -8.49622031e-01  4.56013997e-01  4.56013997e-01  4.56013997e-01
  1.18670319e+00  2.05886159e+00  2.05886159e+00  2.05886159e+00
  7.00503688e+00  7.00503688e+00  7.00503688e+00  7.28737501e+00
  2.52848779e+01  2.52848779e+01  2.52848779e+01  3.46146161e+01
  1.19742629e+02  1.19742629e+02  1.19742629e+02  1.38711200e+02
  5.02784583e+02  1.87039712e+03  8.00004313e+03  4.77676813e+04]
E1 = -182.5555813060039  E_coul = 54.01983090104874
cycle= 3 E= -128.535750404955  delta_E= -0.000988  |g|= 0.0004  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000788036
diis-c [-1.25181179e-07 -1.96397742e-03 -1.28161395e-03  1.00324559e+00]
  HOMO = -0.849844762290645  LUMO = 0.456001653289819
  mo_energy =
[-3.27765515e+01 -1.93153816e+00 -8.49844762e-01 -8.49844762e-01
 -8.49844762e-01  4.56001653e-01  4.56001653e-01  4.56001653e-01
  1.18662592e+00  2.05877483e+00  2.05877483e+00  2.05877483e+00
  7.00484848e+00  7.00484848e+00  7.00484848e+00  7.28718665e+00
  2.52845913e+01  2.52845913e+01  2.52845913e+01  3.46143275e+01
  1.19742250e+02  1.19742250e+02  1.19742250e+02  1.38710833e+02
  5.02784124e+02  1.87039656e+03  8.00004249e+03  4.77676807e+04]
E1 = -182.55571452947663  E_coul = 54.01996410419507
cycle= 4 E= -128.535750425282  delta_E= -2.03e-08  |g|= 7.12e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000151836
diis-c [-7.42416145e-10  1.24053064e-04  4.60773697e-04 -1.47789504e-01
  1.14720468e+00]
  HOMO = -0.849886094144263  LUMO = 0.455994544547748
  mo_energy =
[-3.27766171e+01 -1.93157800e+00 -8.49886094e-01 -8.49886094e-01
 -8.49886094e-01  4.55994545e-01  4.55994545e-01  4.55994545e-01
  1.18660133e+00  2.05874776e+00  2.05874776e+00  2.05874776e+00
  7.00480088e+00  7.00480088e+00  7.00480088e+00  7.28713913e+00
  2.52845300e+01  2.52845300e+01  2.52845300e+01  3.46142657e+01
  1.19742185e+02  1.19742185e+02  1.19742185e+02  1.38710768e+02
  5.02784056e+02  1.87039649e+03  8.00004242e+03  4.77676806e+04]
E1 = -182.555809662143  E_coul = 54.02005923621738
cycle= 5 E= -128.535750425926  delta_E= -6.44e-10  |g|= 3.15e-06  |ddm|= 4.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.555809662143  E_coul = 54.02005923621738
  HOMO = -0.849884953182654  LUMO = 0.455994562269075
  mo_energy =
[-3.27766139e+01 -1.93157682e+00 -8.49884953e-01 -8.49884953e-01
 -8.49884953e-01  4.55994562e-01  4.55994562e-01  4.55994562e-01
  1.18660161e+00  2.05874815e+00  2.05874815e+00  2.05874815e+00
  7.00480220e+00  7.00480220e+00  7.00480220e+00  7.28714059e+00
  2.52845326e+01  2.52845326e+01  2.52845326e+01  3.46142684e+01
  1.19742188e+02  1.19742188e+02  1.19742188e+02  1.38710771e+02
  5.02784059e+02  1.87039649e+03  8.00004242e+03  4.77676806e+04]
E1 = -182.55579866526276  E_coul = 54.020048239335495
Extra cycle  E= -128.535750425927  delta_E= -1.65e-12  |g|= 1.46e-06  |ddm|= 2.43e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734744e+02
 7.64330101e+01 1.00368517e+01 2.70505249e+01 3.81316822e-01
 1.11703331e+00 2.88240646e+00 3.68755569e+00 1.24475705e+01
 5.47854183e+01 1.70999913e-01 1.27095805e+00 4.74517718e-01]
E = -128.53575042592726
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447001        1
[INPUT] 0    0    [1    /1   ]  833.271056595        1
[INPUT] 0    0    [1    /1   ]  235.734744099        1
[INPUT] 0    0    [1    /1   ]  76.4330100639        1
[INPUT] 0    0    [1    /1   ]  10.0368516731        1
[INPUT] 0    0    [1    /1   ]  27.0505249332        1
[INPUT] 0    0    [1    /1   ]  0.381316822428       1
[INPUT] 0    0    [1    /1   ]  1.11703330614        1
[INPUT] 0    0    [1    /1   ]  2.88240645938        1
[INPUT] 1    0    [1    /1   ]  3.68755569087        1
[INPUT] 1    0    [1    /1   ]  12.4475705459        1
[INPUT] 1    0    [1    /1   ]  54.7854183175        1
[INPUT] 1    0    [1    /1   ]  0.170999913053       1
[INPUT] 1    0    [1    /1   ]  1.27095805274        1
[INPUT] 1    0    [1    /1   ]  0.474517718281       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129990165, 1.0]], [0, [3661.45447001432, 1.0]], [0, [833.2710565947372, 1.0]], [0, [235.73474409881723, 1.0]], [0, [76.43301006393024, 1.0]], [0, [10.036851673103357, 1.0]], [0, [27.050524933208926, 1.0]], [0, [0.3813168224279535, 1.0]], [0, [1.1170333061375417, 1.0]], [0, [2.882406459380901, 1.0]], [1, [3.6875556908672613, 1.0]], [1, [12.44757054592388, 1.0]], [1, [54.78541831754465, 1.0]], [1, [0.1709999130532493, 1.0]], [1, [1.2709580527389748, 1.0]], [1, [0.47451771828145733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447001]
bas 2, expnt(s) = [833.27105659]
bas 3, expnt(s) = [235.7347441]
bas 4, expnt(s) = [76.43301006]
bas 5, expnt(s) = [10.03685167]
bas 6, expnt(s) = [27.05052493]
bas 7, expnt(s) = [0.38131682]
bas 8, expnt(s) = [1.11703331]
bas 9, expnt(s) = [2.88240646]
bas 10, expnt(s) = [3.68755569]
bas 11, expnt(s) = [12.44757055]
bas 12, expnt(s) = [54.78541832]
bas 13, expnt(s) = [0.17099991]
bas 14, expnt(s) = [1.27095805]
bas 15, expnt(s) = [0.47451772]
CPU time:        19.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734744e+02 1.51996197e+02
 7.64330101e+01 6.53094079e+01 1.00368517e+01 1.42466631e+01
 2.70505249e+01 2.99672435e+01 3.81316822e-01 1.22596903e+00
 1.11703331e+00 2.74514075e+00 2.88240646e+00 5.58896566e+00
 3.68755569e+00 1.49075964e+01 1.24475705e+01 6.82087574e+01
 5.47854183e+01 4.34826116e+02 1.70999913e-01 3.20796229e-01
 1.27095805e+00 3.93684589e+00 4.74517718e-01 1.14894684e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999859378795438
cond(S) = 343.8915326745549
E1 = -183.58240372970084  E_coul = 55.07894239317804
init E= -128.503461336523
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774640283351397  LUMO = 0.464004498226897
  mo_energy =
[-3.25552523e+01 -1.85268782e+00 -7.74640283e-01 -7.74640283e-01
 -7.74640283e-01  4.64004498e-01  4.64004498e-01  4.64004498e-01
  1.21878679e+00  2.09637081e+00  2.09637081e+00  2.09637081e+00
  7.09550472e+00  7.09550472e+00  7.09550472e+00  7.37861681e+00
  2.54466154e+01  2.54466154e+01  2.54466154e+01  3.47831501e+01
  1.19965393e+02  1.19965393e+02  1.19965393e+02  1.38928738e+02
  5.03035520e+02  1.87067875e+03  8.00035126e+03  4.77680074e+04]
E1 = -182.0350625927263  E_coul = 53.50302515359828
cycle= 1 E= -128.532037439128  delta_E= -0.0286  |g|= 0.21  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53695
diis-c [-0.2883156  1.       ]
  HOMO = -0.88650255768756  LUMO = 0.452058041519152
  mo_energy =
[-3.28875920e+01 -1.97022603e+00 -8.86502558e-01 -8.86502558e-01
 -8.86502558e-01  4.52058042e-01  4.52058042e-01  4.52058042e-01
  1.17146468e+00  2.04087894e+00  2.04087894e+00  2.04087894e+00
  6.96057524e+00  6.96057524e+00  6.96057524e+00  7.24252743e+00
  2.52033506e+01  2.52033506e+01  2.52033506e+01  3.45291997e+01
  1.19631385e+02  1.19631385e+02  1.19631385e+02  1.38601835e+02
  5.02664174e+02  1.87027132e+03  7.99991482e+03  4.77675521e+04]
E1 = -182.82472195549866  E_coul = 54.2899600300823
cycle= 2 E= -128.534761925416  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0635
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27559
diis-c [-6.35582608e-04  3.38476872e-01  6.61523128e-01]
  HOMO = -0.849622031169444  LUMO = 0.456013997460279
  mo_energy =
[-3.27761836e+01 -1.93135141e+00 -8.49622031e-01 -8.49622031e-01
 -8.49622031e-01  4.56013997e-01  4.56013997e-01  4.56013997e-01
  1.18670319e+00  2.05886159e+00  2.05886159e+00  2.05886159e+00
  7.00503688e+00  7.00503688e+00  7.00503688e+00  7.28737501e+00
  2.52848779e+01  2.52848779e+01  2.52848779e+01  3.46146161e+01
  1.19742629e+02  1.19742629e+02  1.19742629e+02  1.38711200e+02
  5.02784583e+02  1.87039712e+03  8.00004313e+03  4.77676813e+04]
E1 = -182.5555813060039  E_coul = 54.01983090104874
cycle= 3 E= -128.535750404955  delta_E= -0.000988  |g|= 0.0004  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000788036
diis-c [-1.25181179e-07 -1.96397742e-03 -1.28161395e-03  1.00324559e+00]
  HOMO = -0.849844762290645  LUMO = 0.456001653289819
  mo_energy =
[-3.27765515e+01 -1.93153816e+00 -8.49844762e-01 -8.49844762e-01
 -8.49844762e-01  4.56001653e-01  4.56001653e-01  4.56001653e-01
  1.18662592e+00  2.05877483e+00  2.05877483e+00  2.05877483e+00
  7.00484848e+00  7.00484848e+00  7.00484848e+00  7.28718665e+00
  2.52845913e+01  2.52845913e+01  2.52845913e+01  3.46143275e+01
  1.19742250e+02  1.19742250e+02  1.19742250e+02  1.38710833e+02
  5.02784124e+02  1.87039656e+03  8.00004249e+03  4.77676807e+04]
E1 = -182.55571452947663  E_coul = 54.01996410419507
cycle= 4 E= -128.535750425282  delta_E= -2.03e-08  |g|= 7.12e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000151836
diis-c [-7.42416145e-10  1.24053064e-04  4.60773697e-04 -1.47789504e-01
  1.14720468e+00]
  HOMO = -0.849886094144263  LUMO = 0.455994544547748
  mo_energy =
[-3.27766171e+01 -1.93157800e+00 -8.49886094e-01 -8.49886094e-01
 -8.49886094e-01  4.55994545e-01  4.55994545e-01  4.55994545e-01
  1.18660133e+00  2.05874776e+00  2.05874776e+00  2.05874776e+00
  7.00480088e+00  7.00480088e+00  7.00480088e+00  7.28713913e+00
  2.52845300e+01  2.52845300e+01  2.52845300e+01  3.46142657e+01
  1.19742185e+02  1.19742185e+02  1.19742185e+02  1.38710768e+02
  5.02784056e+02  1.87039649e+03  8.00004242e+03  4.77676806e+04]
E1 = -182.555809662143  E_coul = 54.02005923621738
cycle= 5 E= -128.535750425926  delta_E= -6.44e-10  |g|= 3.15e-06  |ddm|= 4.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.555809662143  E_coul = 54.02005923621738
  HOMO = -0.849884953182654  LUMO = 0.455994562269075
  mo_energy =
[-3.27766139e+01 -1.93157682e+00 -8.49884953e-01 -8.49884953e-01
 -8.49884953e-01  4.55994562e-01  4.55994562e-01  4.55994562e-01
  1.18660161e+00  2.05874815e+00  2.05874815e+00  2.05874815e+00
  7.00480220e+00  7.00480220e+00  7.00480220e+00  7.28714059e+00
  2.52845326e+01  2.52845326e+01  2.52845326e+01  3.46142684e+01
  1.19742188e+02  1.19742188e+02  1.19742188e+02  1.38710771e+02
  5.02784059e+02  1.87039649e+03  8.00004242e+03  4.77676806e+04]
E1 = -182.55579866526276  E_coul = 54.020048239335495
Extra cycle  E= -128.535750425927  delta_E= -1.65e-12  |g|= 1.46e-06  |ddm|= 2.43e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.8915326745549
E1 = -182.55579866526276  E_coul = 54.020048239335495
init E= -128.535750425927
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849885753577908  LUMO = 0.45599445534831
  mo_energy =
[-3.27766161e+01 -1.93157769e+00 -8.49885754e-01 -8.49885754e-01
 -8.49885754e-01  4.55994455e-01  4.55994455e-01  4.55994455e-01
  1.18660122e+00  2.05874772e+00  2.05874772e+00  2.05874772e+00
  7.00480123e+00  7.00480123e+00  7.00480123e+00  7.28713962e+00
  2.52845309e+01  2.52845309e+01  2.52845309e+01  3.46142667e+01
  1.19742186e+02  1.19742186e+02  1.19742186e+02  1.38710769e+02
  5.02784057e+02  1.87039649e+03  8.00004242e+03  4.77676806e+04]
E1 = -182.55580361895846  E_coul = 54.02005319303087
cycle= 1 E= -128.535750425928  delta_E= -3.41e-13  |g|= 6.87e-07  |ddm|= 6.1e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55580361895846  E_coul = 54.02005319303087
  HOMO = -0.849885406991505  LUMO = 0.455994488790286
  mo_energy =
[-3.27766151e+01 -1.93157733e+00 -8.49885407e-01 -8.49885407e-01
 -8.49885407e-01  4.55994489e-01  4.55994489e-01  4.55994489e-01
  1.18660135e+00  2.05874788e+00  2.05874788e+00  2.05874788e+00
  7.00480164e+00  7.00480164e+00  7.00480164e+00  7.28714004e+00
  2.52845317e+01  2.52845317e+01  2.52845317e+01  3.46142675e+01
  1.19742187e+02  1.19742187e+02  1.19742187e+02  1.38710770e+02
  5.02784058e+02  1.87039649e+03  8.00004242e+03  4.77676806e+04]
E1 = -182.5558009014689  E_coul = 54.02005047554159
Extra cycle  E= -128.535750425927  delta_E= 2.84e-13  |g|= 3.66e-07  |ddm|= 2.24e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734744e+02
 7.64330101e+01 1.00368517e+01 2.70505249e+01 3.81316822e-01
 1.11703331e+00 2.88240646e+00 3.68755569e+00 1.24475705e+01
 5.47854183e+01 1.70999913e-01 1.27095805e+00 4.74517718e-01]
grad_E = [ 3.59027260e-11 -1.89802311e-09  4.56851817e-08 -6.82998205e-07
  4.32783778e-06  2.09275208e-06  4.23696508e-06 -1.80795580e-04
  5.09831132e-05  7.80367632e-06 -8.52030325e-03  1.33825340e-03
 -4.81768585e-05 -8.59224509e-03 -1.22248203e-03  6.92452680e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447002        1
[INPUT] 0    0    [1    /1   ]  833.271056538        1
[INPUT] 0    0    [1    /1   ]  235.734744945        1
[INPUT] 0    0    [1    /1   ]  76.4330046858        1
[INPUT] 0    0    [1    /1   ]  10.036847331         1
[INPUT] 0    0    [1    /1   ]  27.0505201002        1
[INPUT] 0    0    [1    /1   ]  0.381345332871       1
[INPUT] 0    0    [1    /1   ]  1.11704372689        1
[INPUT] 0    0    [1    /1   ]  2.8823891641         1
[INPUT] 1    0    [1    /1   ]  3.6985537953         1
[INPUT] 1    0    [1    /1   ]  12.4458326124        1
[INPUT] 1    0    [1    /1   ]  54.7854815898        1
[INPUT] 1    0    [1    /1   ]  0.172612108685       1
[INPUT] 1    0    [1    /1   ]  1.27091079217        1
[INPUT] 1    0    [1    /1   ]  0.471322099634       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412999012, 1.0]], [0, [3661.454470016679, 1.0]], [0, [833.2710565380532, 1.0]], [0, [235.7347449451788, 1.0]], [0, [76.43300468577112, 1.0]], [0, [10.036847330983607, 1.0]], [0, [27.05052010016739, 1.0]], [0, [0.3813453328714774, 1.0]], [0, [1.1170437268878828, 1.0]], [0, [2.882389164097406, 1.0]], [1, [3.698553795296932, 1.0]], [1, [12.445832612421789, 1.0]], [1, [54.78548158982875, 1.0]], [1, [0.17261210868450522, 1.0]], [1, [1.2709107921692815, 1.0]], [1, [0.47132209963386335, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447002]
bas 2, expnt(s) = [833.27105654]
bas 3, expnt(s) = [235.73474495]
bas 4, expnt(s) = [76.43300469]
bas 5, expnt(s) = [10.03684733]
bas 6, expnt(s) = [27.0505201]
bas 7, expnt(s) = [0.38134533]
bas 8, expnt(s) = [1.11704373]
bas 9, expnt(s) = [2.88238916]
bas 10, expnt(s) = [3.6985538]
bas 11, expnt(s) = [12.44583261]
bas 12, expnt(s) = [54.78548159]
bas 13, expnt(s) = [0.17261211]
bas 14, expnt(s) = [1.27091079]
bas 15, expnt(s) = [0.4713221]
CPU time:        22.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734745e+02 1.51996197e+02
 7.64330047e+01 6.53094045e+01 1.00368473e+01 1.42466585e+01
 2.70505201e+01 2.99672395e+01 3.81345333e-01 1.22603777e+00
 1.11704373e+00 2.74515995e+00 2.88238916e+00 5.58894051e+00
 3.69855380e+00 1.49631944e+01 1.24458326e+01 6.81968535e+01
 5.47854816e+01 4.34826744e+02 1.72612109e-01 3.24581277e-01
 1.27091079e+00 3.93666290e+00 4.71322100e-01 1.13928308e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999867823422441
cond(S) = 343.9011162629542
E1 = -183.58259084813582  E_coul = 55.07900561003696
init E= -128.503585238099
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774651972858749  LUMO = 0.466896920154619
  mo_energy =
[-3.25552524e+01 -1.85268025e+00 -7.74651973e-01 -7.74651973e-01
 -7.74651973e-01  4.66896920e-01  4.66896920e-01  4.66896920e-01
  1.21886460e+00  2.09468996e+00  2.09468996e+00  2.09468996e+00
  7.09732880e+00  7.09732880e+00  7.09732880e+00  7.37875190e+00
  2.54703646e+01  2.54703646e+01  2.54703646e+01  3.47832607e+01
  1.19989381e+02  1.19989381e+02  1.19989381e+02  1.38928792e+02
  5.03035546e+02  1.87067877e+03  8.00035128e+03  4.77680074e+04]
E1 = -182.03587156269253  E_coul = 53.50371075623588
cycle= 1 E= -128.532160806457  delta_E= -0.0286  |g|= 0.21  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53739
diis-c [-0.28878816  1.        ]
  HOMO = -0.886473608531769  LUMO = 0.454925216823504
  mo_energy =
[-3.28874510e+01 -1.97017051e+00 -8.86473609e-01 -8.86473609e-01
 -8.86473609e-01  4.54925217e-01  4.54925217e-01  4.54925217e-01
  1.17157628e+00  2.03937297e+00  2.03937297e+00  2.03937297e+00
  6.96228061e+00  6.96228061e+00  6.96228061e+00  7.24271733e+00
  2.52271408e+01  2.52271408e+01  2.52271408e+01  3.45294139e+01
  1.19655519e+02  1.19655519e+02  1.19655519e+02  1.38602024e+02
  5.02664336e+02  1.87027147e+03  7.99991497e+03  4.77675522e+04]
E1 = -182.8251774468033  E_coul = 54.29029395875115
cycle= 2 E= -128.534883488052  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0633
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275767
diis-c [-6.34673424e-04  3.38438646e-01  6.61561354e-01]
  HOMO = -0.849608532227827  LUMO = 0.458894493949564
  mo_energy =
[-3.27760817e+01 -1.93131219e+00 -8.49608532e-01 -8.49608532e-01
 -8.49608532e-01  4.58894494e-01  4.58894494e-01  4.58894494e-01
  1.18680988e+00  2.05730590e+00  2.05730590e+00  2.05730590e+00
  7.00678161e+00  7.00678161e+00  7.00678161e+00  7.28754527e+00
  2.53086586e+01  2.53086586e+01  2.53086586e+01  3.46147986e+01
  1.19766721e+02  1.19766721e+02  1.19766721e+02  1.38711351e+02
  5.02784703e+02  1.87039722e+03  8.00004324e+03  4.77676814e+04]
E1 = -182.55625151444184  E_coul = 54.02038063076213
cycle= 3 E= -128.53587088368  delta_E= -0.000987  |g|= 0.00039  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000776171
diis-c [-1.13970701e-07 -1.93494414e-03 -1.24589890e-03  1.00318084e+00]
  HOMO = -0.849825924247191  LUMO = 0.458884071224473
  mo_energy =
[-3.27764421e+01 -1.93149213e+00 -8.49825924e-01 -8.49825924e-01
 -8.49825924e-01  4.58884071e-01  4.58884071e-01  4.58884071e-01
  1.18673810e+00  2.05722428e+00  2.05722428e+00  2.05722428e+00
  7.00659964e+00  7.00659964e+00  7.00659964e+00  7.28736359e+00
  2.53083791e+01  2.53083791e+01  2.53083791e+01  3.46145174e+01
  1.19766349e+02  1.19766349e+02  1.19766349e+02  1.38710991e+02
  5.02784251e+02  1.87039667e+03  8.00004260e+03  4.77676808e+04]
E1 = -182.55639479031868  E_coul = 54.020523888672884
cycle= 4 E= -128.535870901646  delta_E= -1.8e-08  |g|= 6.87e-05  |ddm|= 0.000246
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000149652
diis-c [-7.10903873e-10  1.16254048e-04  4.54278776e-04 -1.42368340e-01
  1.14179781e+00]
  HOMO = -0.849865638909896  LUMO = 0.45887740091769
  mo_energy =
[-3.27765055e+01 -1.93152982e+00 -8.49865639e-01 -8.49865639e-01
 -8.49865639e-01  4.58877401e-01  4.58877401e-01  4.58877401e-01
  1.18671509e+00  2.05719866e+00  2.05719866e+00  2.05719866e+00
  7.00655401e+00  7.00655401e+00  7.00655401e+00  7.28731818e+00
  2.53083201e+01  2.53083201e+01  2.53083201e+01  3.46144578e+01
  1.19766286e+02  1.19766286e+02  1.19766286e+02  1.38710928e+02
  5.02784185e+02  1.87039660e+03  8.00004254e+03  4.77676807e+04]
E1 = -182.5564910802237  E_coul = 54.020620178010695
cycle= 5 E= -128.535870902213  delta_E= -5.67e-10  |g|= 2.95e-06  |ddm|= 4.39e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5564910802237  E_coul = 54.020620178010695
  HOMO = -0.84986464461627  LUMO = 0.458877408367819
  mo_energy =
[-3.27765027e+01 -1.93152872e+00 -8.49864645e-01 -8.49864645e-01
 -8.49864645e-01  4.58877408e-01  4.58877408e-01  4.58877408e-01
  1.18671536e+00  2.05719898e+00  2.05719898e+00  2.05719898e+00
  7.00655517e+00  7.00655517e+00  7.00655517e+00  7.28731951e+00
  2.53083224e+01  2.53083224e+01  2.53083224e+01  3.46144602e+01
  1.19766289e+02  1.19766289e+02  1.19766289e+02  1.38710931e+02
  5.02784188e+02  1.87039661e+03  8.00004254e+03  4.77676807e+04]
E1 = -182.5564811608973  E_coul = 54.020610258683014
Extra cycle  E= -128.535870902214  delta_E= -1.28e-12  |g|= 1.31e-06  |ddm|= 2.32e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734745e+02
 7.64330047e+01 1.00368473e+01 2.70505201e+01 3.81345333e-01
 1.11704373e+00 2.88238916e+00 3.69855380e+00 1.24458326e+01
 5.47854816e+01 1.72612109e-01 1.27091079e+00 4.71322100e-01]
E = -128.5358709022143
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447002        1
[INPUT] 0    0    [1    /1   ]  833.271056538        1
[INPUT] 0    0    [1    /1   ]  235.734744945        1
[INPUT] 0    0    [1    /1   ]  76.4330046858        1
[INPUT] 0    0    [1    /1   ]  10.036847331         1
[INPUT] 0    0    [1    /1   ]  27.0505201002        1
[INPUT] 0    0    [1    /1   ]  0.381345332871       1
[INPUT] 0    0    [1    /1   ]  1.11704372689        1
[INPUT] 0    0    [1    /1   ]  2.8823891641         1
[INPUT] 1    0    [1    /1   ]  3.6985537953         1
[INPUT] 1    0    [1    /1   ]  12.4458326124        1
[INPUT] 1    0    [1    /1   ]  54.7854815898        1
[INPUT] 1    0    [1    /1   ]  0.172612108685       1
[INPUT] 1    0    [1    /1   ]  1.27091079217        1
[INPUT] 1    0    [1    /1   ]  0.471322099634       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412999012, 1.0]], [0, [3661.454470016679, 1.0]], [0, [833.2710565380532, 1.0]], [0, [235.7347449451788, 1.0]], [0, [76.43300468577112, 1.0]], [0, [10.036847330983607, 1.0]], [0, [27.05052010016739, 1.0]], [0, [0.3813453328714774, 1.0]], [0, [1.1170437268878828, 1.0]], [0, [2.882389164097406, 1.0]], [1, [3.698553795296932, 1.0]], [1, [12.445832612421789, 1.0]], [1, [54.78548158982875, 1.0]], [1, [0.17261210868450522, 1.0]], [1, [1.2709107921692815, 1.0]], [1, [0.47132209963386335, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447002]
bas 2, expnt(s) = [833.27105654]
bas 3, expnt(s) = [235.73474495]
bas 4, expnt(s) = [76.43300469]
bas 5, expnt(s) = [10.03684733]
bas 6, expnt(s) = [27.0505201]
bas 7, expnt(s) = [0.38134533]
bas 8, expnt(s) = [1.11704373]
bas 9, expnt(s) = [2.88238916]
bas 10, expnt(s) = [3.6985538]
bas 11, expnt(s) = [12.44583261]
bas 12, expnt(s) = [54.78548159]
bas 13, expnt(s) = [0.17261211]
bas 14, expnt(s) = [1.27091079]
bas 15, expnt(s) = [0.4713221]
CPU time:        22.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734745e+02 1.51996197e+02
 7.64330047e+01 6.53094045e+01 1.00368473e+01 1.42466585e+01
 2.70505201e+01 2.99672395e+01 3.81345333e-01 1.22603777e+00
 1.11704373e+00 2.74515995e+00 2.88238916e+00 5.58894051e+00
 3.69855380e+00 1.49631944e+01 1.24458326e+01 6.81968535e+01
 5.47854816e+01 4.34826744e+02 1.72612109e-01 3.24581277e-01
 1.27091079e+00 3.93666290e+00 4.71322100e-01 1.13928308e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999867823422441
cond(S) = 343.9011162629542
E1 = -183.58259084813582  E_coul = 55.07900561003696
init E= -128.503585238099
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774651972858749  LUMO = 0.466896920154619
  mo_energy =
[-3.25552524e+01 -1.85268025e+00 -7.74651973e-01 -7.74651973e-01
 -7.74651973e-01  4.66896920e-01  4.66896920e-01  4.66896920e-01
  1.21886460e+00  2.09468996e+00  2.09468996e+00  2.09468996e+00
  7.09732880e+00  7.09732880e+00  7.09732880e+00  7.37875190e+00
  2.54703646e+01  2.54703646e+01  2.54703646e+01  3.47832607e+01
  1.19989381e+02  1.19989381e+02  1.19989381e+02  1.38928792e+02
  5.03035546e+02  1.87067877e+03  8.00035128e+03  4.77680074e+04]
E1 = -182.03587156269253  E_coul = 53.50371075623588
cycle= 1 E= -128.532160806457  delta_E= -0.0286  |g|= 0.21  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53739
diis-c [-0.28878816  1.        ]
  HOMO = -0.886473608531769  LUMO = 0.454925216823504
  mo_energy =
[-3.28874510e+01 -1.97017051e+00 -8.86473609e-01 -8.86473609e-01
 -8.86473609e-01  4.54925217e-01  4.54925217e-01  4.54925217e-01
  1.17157628e+00  2.03937297e+00  2.03937297e+00  2.03937297e+00
  6.96228061e+00  6.96228061e+00  6.96228061e+00  7.24271733e+00
  2.52271408e+01  2.52271408e+01  2.52271408e+01  3.45294139e+01
  1.19655519e+02  1.19655519e+02  1.19655519e+02  1.38602024e+02
  5.02664336e+02  1.87027147e+03  7.99991497e+03  4.77675522e+04]
E1 = -182.8251774468033  E_coul = 54.29029395875115
cycle= 2 E= -128.534883488052  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0633
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275767
diis-c [-6.34673424e-04  3.38438646e-01  6.61561354e-01]
  HOMO = -0.849608532227827  LUMO = 0.458894493949564
  mo_energy =
[-3.27760817e+01 -1.93131219e+00 -8.49608532e-01 -8.49608532e-01
 -8.49608532e-01  4.58894494e-01  4.58894494e-01  4.58894494e-01
  1.18680988e+00  2.05730590e+00  2.05730590e+00  2.05730590e+00
  7.00678161e+00  7.00678161e+00  7.00678161e+00  7.28754527e+00
  2.53086586e+01  2.53086586e+01  2.53086586e+01  3.46147986e+01
  1.19766721e+02  1.19766721e+02  1.19766721e+02  1.38711351e+02
  5.02784703e+02  1.87039722e+03  8.00004324e+03  4.77676814e+04]
E1 = -182.55625151444184  E_coul = 54.02038063076213
cycle= 3 E= -128.53587088368  delta_E= -0.000987  |g|= 0.00039  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000776171
diis-c [-1.13970701e-07 -1.93494414e-03 -1.24589890e-03  1.00318084e+00]
  HOMO = -0.849825924247191  LUMO = 0.458884071224473
  mo_energy =
[-3.27764421e+01 -1.93149213e+00 -8.49825924e-01 -8.49825924e-01
 -8.49825924e-01  4.58884071e-01  4.58884071e-01  4.58884071e-01
  1.18673810e+00  2.05722428e+00  2.05722428e+00  2.05722428e+00
  7.00659964e+00  7.00659964e+00  7.00659964e+00  7.28736359e+00
  2.53083791e+01  2.53083791e+01  2.53083791e+01  3.46145174e+01
  1.19766349e+02  1.19766349e+02  1.19766349e+02  1.38710991e+02
  5.02784251e+02  1.87039667e+03  8.00004260e+03  4.77676808e+04]
E1 = -182.55639479031868  E_coul = 54.020523888672884
cycle= 4 E= -128.535870901646  delta_E= -1.8e-08  |g|= 6.87e-05  |ddm|= 0.000246
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000149652
diis-c [-7.10903873e-10  1.16254048e-04  4.54278776e-04 -1.42368340e-01
  1.14179781e+00]
  HOMO = -0.849865638909896  LUMO = 0.45887740091769
  mo_energy =
[-3.27765055e+01 -1.93152982e+00 -8.49865639e-01 -8.49865639e-01
 -8.49865639e-01  4.58877401e-01  4.58877401e-01  4.58877401e-01
  1.18671509e+00  2.05719866e+00  2.05719866e+00  2.05719866e+00
  7.00655401e+00  7.00655401e+00  7.00655401e+00  7.28731818e+00
  2.53083201e+01  2.53083201e+01  2.53083201e+01  3.46144578e+01
  1.19766286e+02  1.19766286e+02  1.19766286e+02  1.38710928e+02
  5.02784185e+02  1.87039660e+03  8.00004254e+03  4.77676807e+04]
E1 = -182.5564910802237  E_coul = 54.020620178010695
cycle= 5 E= -128.535870902213  delta_E= -5.67e-10  |g|= 2.95e-06  |ddm|= 4.39e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5564910802237  E_coul = 54.020620178010695
  HOMO = -0.84986464461627  LUMO = 0.458877408367819
  mo_energy =
[-3.27765027e+01 -1.93152872e+00 -8.49864645e-01 -8.49864645e-01
 -8.49864645e-01  4.58877408e-01  4.58877408e-01  4.58877408e-01
  1.18671536e+00  2.05719898e+00  2.05719898e+00  2.05719898e+00
  7.00655517e+00  7.00655517e+00  7.00655517e+00  7.28731951e+00
  2.53083224e+01  2.53083224e+01  2.53083224e+01  3.46144602e+01
  1.19766289e+02  1.19766289e+02  1.19766289e+02  1.38710931e+02
  5.02784188e+02  1.87039661e+03  8.00004254e+03  4.77676807e+04]
E1 = -182.5564811608973  E_coul = 54.020610258683014
Extra cycle  E= -128.535870902214  delta_E= -1.28e-12  |g|= 1.31e-06  |ddm|= 2.32e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9011162629542
E1 = -182.5564811608973  E_coul = 54.020610258683014
init E= -128.535870902214
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849865371640737  LUMO = 0.458877310412522
  mo_energy =
[-3.27765047e+01 -1.93152949e+00 -8.49865372e-01 -8.49865372e-01
 -8.49865372e-01  4.58877310e-01  4.58877310e-01  4.58877310e-01
  1.18671501e+00  2.05719859e+00  2.05719859e+00  2.05719859e+00
  7.00655429e+00  7.00655429e+00  7.00655429e+00  7.28731863e+00
  2.53083209e+01  2.53083209e+01  2.53083209e+01  3.46144587e+01
  1.19766287e+02  1.19766287e+02  1.19766287e+02  1.38710929e+02
  5.02784185e+02  1.87039660e+03  8.00004253e+03  4.77676807e+04]
E1 = -182.5564856092604  E_coul = 54.02061470704601
cycle= 1 E= -128.535870902214  delta_E= -8.53e-14  |g|= 6.19e-07  |ddm|= 5.45e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5564856092604  E_coul = 54.02061470704601
  HOMO = -0.849865061395091  LUMO = 0.458877340359187
  mo_energy =
[-3.27765037e+01 -1.93152917e+00 -8.49865061e-01 -8.49865061e-01
 -8.49865061e-01  4.58877340e-01  4.58877340e-01  4.58877340e-01
  1.18671513e+00  2.05719874e+00  2.05719874e+00  2.05719874e+00
  7.00655467e+00  7.00655467e+00  7.00655467e+00  7.28731901e+00
  2.53083216e+01  2.53083216e+01  2.53083216e+01  3.46144594e+01
  1.19766288e+02  1.19766288e+02  1.19766288e+02  1.38710930e+02
  5.02784187e+02  1.87039660e+03  8.00004254e+03  4.77676807e+04]
E1 = -182.55648316771124  E_coul = 54.020612265497014
Extra cycle  E= -128.535870902214  delta_E= 1.71e-13  |g|= 3.29e-07  |ddm|= 2.04e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.38 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734745e+02
 7.64330047e+01 1.00368473e+01 2.70505201e+01 3.81345333e-01
 1.11704373e+00 2.88238916e+00 3.69855380e+00 1.24458326e+01
 5.47854816e+01 1.72612109e-01 1.27091079e+00 4.71322100e-01]
grad_E = [ 3.60997386e-11 -1.90834938e-09  4.58938213e-08 -6.85472875e-07
  4.34667373e-06  2.19375793e-06  4.16249573e-06 -1.33904551e-04
  3.59364447e-05  8.31317225e-06 -7.86061662e-03  1.15004420e-03
 -3.98491080e-05 -4.75613737e-03 -9.18714201e-04  4.06831272e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447004        1
[INPUT] 0    0    [1    /1   ]  833.271056034        1
[INPUT] 0    0    [1    /1   ]  235.734752458        1
[INPUT] 0    0    [1    /1   ]  76.4329569189        1
[INPUT] 0    0    [1    /1   ]  10.0368103518        1
[INPUT] 0    0    [1    /1   ]  27.0504779423        1
[INPUT] 0    0    [1    /1   ]  0.381483738884       1
[INPUT] 0    0    [1    /1   ]  1.11712713833        1
[INPUT] 0    0    [1    /1   ]  2.88225167527        1
[INPUT] 1    0    [1    /1   ]  3.78195592521        1
[INPUT] 1    0    [1    /1   ]  12.4328071811        1
[INPUT] 1    0    [1    /1   ]  54.7859501906        1
[INPUT] 1    0    [1    /1   ]  0.162724312425       1
[INPUT] 1    0    [1    /1   ]  1.28583707647        1
[INPUT] 1    0    [1    /1   ]  0.449734429084       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129989725, 1.0]], [0, [3661.454470037659, 1.0]], [0, [833.2710560343315, 1.0]], [0, [235.73475245837614, 1.0]], [0, [76.43295691887234, 1.0]], [0, [10.036810351824728, 1.0]], [0, [27.050477942292808, 1.0]], [0, [0.3814837388841975, 1.0]], [0, [1.1171271383317378, 1.0]], [0, [2.8822516752744383, 1.0]], [1, [3.7819559252075856, 1.0]], [1, [12.432807181104504, 1.0]], [1, [54.785950190564655, 1.0]], [1, [0.1627243124246413, 1.0]], [1, [1.2858370764738138, 1.0]], [1, [0.44973442908435146, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447004]
bas 2, expnt(s) = [833.27105603]
bas 3, expnt(s) = [235.73475246]
bas 4, expnt(s) = [76.43295692]
bas 5, expnt(s) = [10.03681035]
bas 6, expnt(s) = [27.05047794]
bas 7, expnt(s) = [0.38148374]
bas 8, expnt(s) = [1.11712714]
bas 9, expnt(s) = [2.88225168]
bas 10, expnt(s) = [3.78195593]
bas 11, expnt(s) = [12.43280718]
bas 12, expnt(s) = [54.78595019]
bas 13, expnt(s) = [0.16272431]
bas 14, expnt(s) = [1.28583708]
bas 15, expnt(s) = [0.44973443]
CPU time:        24.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271056e+02 3.91836372e+02 2.35734752e+02 1.51996201e+02
 7.64329569e+01 6.53093739e+01 1.00368104e+01 1.42466191e+01
 2.70504779e+01 2.99672045e+01 3.81483739e-01 1.22637149e+00
 1.11712714e+00 2.74531369e+00 2.88225168e+00 5.58874056e+00
 3.78195593e+00 1.53861503e+01 1.24328072e+01 6.81076492e+01
 5.47859502e+01 4.34831393e+02 1.62724312e-01 3.01508770e-01
 1.28583708e+00 3.99454045e+00 4.49734429e-01 1.07443355e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999863875059829
cond(S) = 343.951616407225
E1 = -183.58320933256707  E_coul = 55.079229158799876
init E= -128.503980173767
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774691616791226  LUMO = 0.438587187524531
  mo_energy =
[-3.25552717e+01 -1.85265347e+00 -7.74691617e-01 -7.74691617e-01
 -7.74691617e-01  4.38587188e-01  4.38587188e-01  4.38587188e-01
  1.21924457e+00  2.01065499e+00  2.01065499e+00  2.01065499e+00
  7.07964924e+00  7.07964924e+00  7.07964924e+00  7.37942078e+00
  2.56493245e+01  2.56493245e+01  2.56493245e+01  3.47837366e+01
  1.20177186e+02  1.20177186e+02  1.20177186e+02  1.38928847e+02
  5.03035406e+02  1.87067862e+03  8.00035116e+03  4.77680073e+04]
E1 = -182.03747895259266  E_coul = 53.50484975298834
cycle= 1 E= -128.532629199604  delta_E= -0.0286  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.533508
diis-c [-0.28463116  1.        ]
  HOMO = -0.886514900954845  LUMO = 0.42770014123234
  mo_energy =
[-3.28870258e+01 -1.97013171e+00 -8.86514901e-01 -8.86514901e-01
 -8.86514901e-01  4.27700141e-01  4.27700141e-01  4.27700141e-01
  1.17196328e+00  1.95619165e+00  1.95619165e+00  1.95619165e+00
  6.94252685e+00  6.94252685e+00  6.94252685e+00  7.24340496e+00
  2.54057792e+01  2.54057792e+01  2.54057792e+01  3.45301193e+01
  1.19843807e+02  1.19843807e+02  1.19843807e+02  1.38602487e+02
  5.02664588e+02  1.87027167e+03  7.99991518e+03  4.77675525e+04]
E1 = -182.8263830871943  E_coul = 54.291037060717095
cycle= 2 E= -128.535346026477  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273838
diis-c [-6.30145787e-04  3.38485866e-01  6.61514134e-01]
  HOMO = -0.849671038590539  LUMO = 0.431327087091154
  mo_energy =
[-3.27757224e+01 -1.93129428e+00 -8.49671039e-01 -8.49671039e-01
 -8.49671039e-01  4.31327087e-01  4.31327087e-01  4.31327087e-01
  1.18720086e+00  1.97386467e+00  1.97386467e+00  1.97386467e+00
  6.98770863e+00  6.98770863e+00  6.98770863e+00  7.28820361e+00
  2.54874426e+01  2.54874426e+01  2.54874426e+01  3.46154539e+01
  1.19954926e+02  1.19954926e+02  1.19954926e+02  1.38711748e+02
  5.02784879e+02  1.87039734e+03  8.00004337e+03  4.77676816e+04]
E1 = -182.55769006659133  E_coul = 54.02135785666434
cycle= 3 E= -128.536332209927  delta_E= -0.000986  |g|= 0.000371  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000752462
diis-c [-9.35533219e-08 -1.87179553e-03 -1.14460294e-03  1.00301640e+00]
  HOMO = -0.849877064832642  LUMO = 0.431322534446929
  mo_energy =
[-3.27760665e+01 -1.93145904e+00 -8.49877065e-01 -8.49877065e-01
 -8.49877065e-01  4.31322534e-01  4.31322534e-01  4.31322534e-01
  1.18714249e+00  1.97379684e+00  1.97379684e+00  1.97379684e+00
  6.98753894e+00  6.98753894e+00  6.98753894e+00  7.28803638e+00
  2.54871777e+01  2.54871777e+01  2.54871777e+01  3.46151878e+01
  1.19954570e+02  1.19954570e+02  1.19954570e+02  1.38711404e+02
  5.02784442e+02  1.87039680e+03  8.00004275e+03  4.77676809e+04]
E1 = -182.55787028018696  E_coul = 54.0215380570748
cycle= 4 E= -128.536332223112  delta_E= -1.32e-08  |g|= 6.24e-05  |ddm|= 0.000205
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000142204
diis-c [-6.60107628e-10  1.00777106e-04  4.30072712e-04 -1.30846896e-01
  1.13031605e+00]
  HOMO = -0.849912686183479  LUMO = 0.431317448719656
  mo_energy =
[-3.27761242e+01 -1.93149129e+00 -8.49912686e-01 -8.49912686e-01
 -8.49912686e-01  4.31317449e-01  4.31317449e-01  4.31317449e-01
  1.18712350e+00  1.97377497e+00  1.97377497e+00  1.97377497e+00
  6.98749794e+00  6.98749794e+00  6.98749794e+00  7.28799628e+00
  2.54871243e+01  2.54871243e+01  2.54871243e+01  3.46151341e+01
  1.19954513e+02  1.19954513e+02  1.19954513e+02  1.38711347e+02
  5.02784382e+02  1.87039674e+03  8.00004268e+03  4.77676809e+04]
E1 = -182.55796886428888  E_coul = 54.02163664076206
cycle= 5 E= -128.536332223527  delta_E= -4.15e-10  |g|= 2.77e-06  |ddm|= 3.38e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55796886428888  E_coul = 54.02163664076206
  HOMO = -0.84991188893415  LUMO = 0.431317450646008
  mo_energy =
[-3.27761220e+01 -1.93149016e+00 -8.49911889e-01 -8.49911889e-01
 -8.49911889e-01  4.31317451e-01  4.31317451e-01  4.31317451e-01
  1.18712385e+00  1.97377524e+00  1.97377524e+00  1.97377524e+00
  6.98749894e+00  6.98749894e+00  6.98749894e+00  7.28799749e+00
  2.54871262e+01  2.54871262e+01  2.54871262e+01  3.46151361e+01
  1.19954515e+02  1.19954515e+02  1.19954515e+02  1.38711349e+02
  5.02784383e+02  1.87039674e+03  8.00004268e+03  4.77676809e+04]
E1 = -182.5579609209299  E_coul = 54.021628697402114
Extra cycle  E= -128.536332223528  delta_E= -9.66e-13  |g|= 1.05e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271056e+02 2.35734752e+02
 7.64329569e+01 1.00368104e+01 2.70504779e+01 3.81483739e-01
 1.11712714e+00 2.88225168e+00 3.78195593e+00 1.24328072e+01
 5.47859502e+01 1.62724312e-01 1.28583708e+00 4.49734429e-01]
E = -128.53633222352778
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447004        1
[INPUT] 0    0    [1    /1   ]  833.271056034        1
[INPUT] 0    0    [1    /1   ]  235.734752458        1
[INPUT] 0    0    [1    /1   ]  76.4329569189        1
[INPUT] 0    0    [1    /1   ]  10.0368103518        1
[INPUT] 0    0    [1    /1   ]  27.0504779423        1
[INPUT] 0    0    [1    /1   ]  0.381483738884       1
[INPUT] 0    0    [1    /1   ]  1.11712713833        1
[INPUT] 0    0    [1    /1   ]  2.88225167527        1
[INPUT] 1    0    [1    /1   ]  3.78195592521        1
[INPUT] 1    0    [1    /1   ]  12.4328071811        1
[INPUT] 1    0    [1    /1   ]  54.7859501906        1
[INPUT] 1    0    [1    /1   ]  0.162724312425       1
[INPUT] 1    0    [1    /1   ]  1.28583707647        1
[INPUT] 1    0    [1    /1   ]  0.449734429084       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129989725, 1.0]], [0, [3661.454470037659, 1.0]], [0, [833.2710560343315, 1.0]], [0, [235.73475245837614, 1.0]], [0, [76.43295691887234, 1.0]], [0, [10.036810351824728, 1.0]], [0, [27.050477942292808, 1.0]], [0, [0.3814837388841975, 1.0]], [0, [1.1171271383317378, 1.0]], [0, [2.8822516752744383, 1.0]], [1, [3.7819559252075856, 1.0]], [1, [12.432807181104504, 1.0]], [1, [54.785950190564655, 1.0]], [1, [0.1627243124246413, 1.0]], [1, [1.2858370764738138, 1.0]], [1, [0.44973442908435146, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447004]
bas 2, expnt(s) = [833.27105603]
bas 3, expnt(s) = [235.73475246]
bas 4, expnt(s) = [76.43295692]
bas 5, expnt(s) = [10.03681035]
bas 6, expnt(s) = [27.05047794]
bas 7, expnt(s) = [0.38148374]
bas 8, expnt(s) = [1.11712714]
bas 9, expnt(s) = [2.88225168]
bas 10, expnt(s) = [3.78195593]
bas 11, expnt(s) = [12.43280718]
bas 12, expnt(s) = [54.78595019]
bas 13, expnt(s) = [0.16272431]
bas 14, expnt(s) = [1.28583708]
bas 15, expnt(s) = [0.44973443]
CPU time:        24.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271056e+02 3.91836372e+02 2.35734752e+02 1.51996201e+02
 7.64329569e+01 6.53093739e+01 1.00368104e+01 1.42466191e+01
 2.70504779e+01 2.99672045e+01 3.81483739e-01 1.22637149e+00
 1.11712714e+00 2.74531369e+00 2.88225168e+00 5.58874056e+00
 3.78195593e+00 1.53861503e+01 1.24328072e+01 6.81076492e+01
 5.47859502e+01 4.34831393e+02 1.62724312e-01 3.01508770e-01
 1.28583708e+00 3.99454045e+00 4.49734429e-01 1.07443355e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999863875059829
cond(S) = 343.951616407225
E1 = -183.58320933256707  E_coul = 55.079229158799876
init E= -128.503980173767
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774691616791226  LUMO = 0.438587187524531
  mo_energy =
[-3.25552717e+01 -1.85265347e+00 -7.74691617e-01 -7.74691617e-01
 -7.74691617e-01  4.38587188e-01  4.38587188e-01  4.38587188e-01
  1.21924457e+00  2.01065499e+00  2.01065499e+00  2.01065499e+00
  7.07964924e+00  7.07964924e+00  7.07964924e+00  7.37942078e+00
  2.56493245e+01  2.56493245e+01  2.56493245e+01  3.47837366e+01
  1.20177186e+02  1.20177186e+02  1.20177186e+02  1.38928847e+02
  5.03035406e+02  1.87067862e+03  8.00035116e+03  4.77680073e+04]
E1 = -182.03747895259266  E_coul = 53.50484975298834
cycle= 1 E= -128.532629199604  delta_E= -0.0286  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.533508
diis-c [-0.28463116  1.        ]
  HOMO = -0.886514900954845  LUMO = 0.42770014123234
  mo_energy =
[-3.28870258e+01 -1.97013171e+00 -8.86514901e-01 -8.86514901e-01
 -8.86514901e-01  4.27700141e-01  4.27700141e-01  4.27700141e-01
  1.17196328e+00  1.95619165e+00  1.95619165e+00  1.95619165e+00
  6.94252685e+00  6.94252685e+00  6.94252685e+00  7.24340496e+00
  2.54057792e+01  2.54057792e+01  2.54057792e+01  3.45301193e+01
  1.19843807e+02  1.19843807e+02  1.19843807e+02  1.38602487e+02
  5.02664588e+02  1.87027167e+03  7.99991518e+03  4.77675525e+04]
E1 = -182.8263830871943  E_coul = 54.291037060717095
cycle= 2 E= -128.535346026477  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273838
diis-c [-6.30145787e-04  3.38485866e-01  6.61514134e-01]
  HOMO = -0.849671038590539  LUMO = 0.431327087091154
  mo_energy =
[-3.27757224e+01 -1.93129428e+00 -8.49671039e-01 -8.49671039e-01
 -8.49671039e-01  4.31327087e-01  4.31327087e-01  4.31327087e-01
  1.18720086e+00  1.97386467e+00  1.97386467e+00  1.97386467e+00
  6.98770863e+00  6.98770863e+00  6.98770863e+00  7.28820361e+00
  2.54874426e+01  2.54874426e+01  2.54874426e+01  3.46154539e+01
  1.19954926e+02  1.19954926e+02  1.19954926e+02  1.38711748e+02
  5.02784879e+02  1.87039734e+03  8.00004337e+03  4.77676816e+04]
E1 = -182.55769006659133  E_coul = 54.02135785666434
cycle= 3 E= -128.536332209927  delta_E= -0.000986  |g|= 0.000371  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000752462
diis-c [-9.35533219e-08 -1.87179553e-03 -1.14460294e-03  1.00301640e+00]
  HOMO = -0.849877064832642  LUMO = 0.431322534446929
  mo_energy =
[-3.27760665e+01 -1.93145904e+00 -8.49877065e-01 -8.49877065e-01
 -8.49877065e-01  4.31322534e-01  4.31322534e-01  4.31322534e-01
  1.18714249e+00  1.97379684e+00  1.97379684e+00  1.97379684e+00
  6.98753894e+00  6.98753894e+00  6.98753894e+00  7.28803638e+00
  2.54871777e+01  2.54871777e+01  2.54871777e+01  3.46151878e+01
  1.19954570e+02  1.19954570e+02  1.19954570e+02  1.38711404e+02
  5.02784442e+02  1.87039680e+03  8.00004275e+03  4.77676809e+04]
E1 = -182.55787028018696  E_coul = 54.0215380570748
cycle= 4 E= -128.536332223112  delta_E= -1.32e-08  |g|= 6.24e-05  |ddm|= 0.000205
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000142204
diis-c [-6.60107628e-10  1.00777106e-04  4.30072712e-04 -1.30846896e-01
  1.13031605e+00]
  HOMO = -0.849912686183479  LUMO = 0.431317448719656
  mo_energy =
[-3.27761242e+01 -1.93149129e+00 -8.49912686e-01 -8.49912686e-01
 -8.49912686e-01  4.31317449e-01  4.31317449e-01  4.31317449e-01
  1.18712350e+00  1.97377497e+00  1.97377497e+00  1.97377497e+00
  6.98749794e+00  6.98749794e+00  6.98749794e+00  7.28799628e+00
  2.54871243e+01  2.54871243e+01  2.54871243e+01  3.46151341e+01
  1.19954513e+02  1.19954513e+02  1.19954513e+02  1.38711347e+02
  5.02784382e+02  1.87039674e+03  8.00004268e+03  4.77676809e+04]
E1 = -182.55796886428888  E_coul = 54.02163664076206
cycle= 5 E= -128.536332223527  delta_E= -4.15e-10  |g|= 2.77e-06  |ddm|= 3.38e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55796886428888  E_coul = 54.02163664076206
  HOMO = -0.84991188893415  LUMO = 0.431317450646008
  mo_energy =
[-3.27761220e+01 -1.93149016e+00 -8.49911889e-01 -8.49911889e-01
 -8.49911889e-01  4.31317451e-01  4.31317451e-01  4.31317451e-01
  1.18712385e+00  1.97377524e+00  1.97377524e+00  1.97377524e+00
  6.98749894e+00  6.98749894e+00  6.98749894e+00  7.28799749e+00
  2.54871262e+01  2.54871262e+01  2.54871262e+01  3.46151361e+01
  1.19954515e+02  1.19954515e+02  1.19954515e+02  1.38711349e+02
  5.02784383e+02  1.87039674e+03  8.00004268e+03  4.77676809e+04]
E1 = -182.5579609209299  E_coul = 54.021628697402114
Extra cycle  E= -128.536332223528  delta_E= -9.66e-13  |g|= 1.05e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.951616407225
E1 = -182.5579609209299  E_coul = 54.021628697402114
init E= -128.536332223528
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.84991248178426  LUMO = 0.431317377581738
  mo_energy =
[-3.27761236e+01 -1.93149074e+00 -8.49912482e-01 -8.49912482e-01
 -8.49912482e-01  4.31317378e-01  4.31317378e-01  4.31317378e-01
  1.18712359e+00  1.97377492e+00  1.97377492e+00  1.97377492e+00
  6.98749822e+00  6.98749822e+00  6.98749822e+00  7.28799680e+00
  2.54871250e+01  2.54871250e+01  2.54871250e+01  3.46151348e+01
  1.19954513e+02  1.19954513e+02  1.19954513e+02  1.38711347e+02
  5.02784382e+02  1.87039674e+03  8.00004268e+03  4.77676809e+04]
E1 = -182.55796452403496  E_coul = 54.02163230050721
cycle= 1 E= -128.536332223528  delta_E= 2.84e-14  |g|= 5.07e-07  |ddm|= 4.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55796452403496  E_coul = 54.02163230050721
  HOMO = -0.849912232667003  LUMO = 0.431317399567024
  mo_energy =
[-3.27761228e+01 -1.93149047e+00 -8.49912233e-01 -8.49912233e-01
 -8.49912233e-01  4.31317400e-01  4.31317400e-01  4.31317400e-01
  1.18712369e+00  1.97377504e+00  1.97377504e+00  1.97377504e+00
  6.98749853e+00  6.98749853e+00  6.98749853e+00  7.28799711e+00
  2.54871255e+01  2.54871255e+01  2.54871255e+01  3.46151354e+01
  1.19954514e+02  1.19954514e+02  1.19954514e+02  1.38711348e+02
  5.02784382e+02  1.87039674e+03  8.00004268e+03  4.77676809e+04]
E1 = -182.5579625581418  E_coul = 54.02163033461443
Extra cycle  E= -128.536332223527  delta_E= 3.69e-13  |g|= 2.64e-07  |ddm|= 1.72e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271056e+02 2.35734752e+02
 7.64329569e+01 1.00368104e+01 2.70504779e+01 3.81483739e-01
 1.11712714e+00 2.88225168e+00 3.78195593e+00 1.24328072e+01
 5.47859502e+01 1.62724312e-01 1.28583708e+00 4.49734429e-01]
grad_E = [ 3.71327764e-11 -1.96239680e-09  4.69888271e-08 -6.98336855e-07
  4.44125642e-06  2.05306312e-06  3.87165730e-06  5.25224470e-05
 -2.33285613e-05  8.54103679e-06 -3.81098968e-03 -6.49934745e-05
  1.72133163e-05  2.51950880e-03  6.39793007e-04 -7.10590253e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447005        1
[INPUT] 0    0    [1    /1   ]  833.271055763        1
[INPUT] 0    0    [1    /1   ]  235.734756505        1
[INPUT] 0    0    [1    /1   ]  76.432931189         1
[INPUT] 0    0    [1    /1   ]  10.0367921282        1
[INPUT] 0    0    [1    /1   ]  27.0504552539        1
[INPUT] 0    0    [1    /1   ]  0.3814869648         1
[INPUT] 0    0    [1    /1   ]  1.11718750943        1
[INPUT] 0    0    [1    /1   ]  2.88218254038        1
[INPUT] 1    0    [1    /1   ]  3.82250241503        1
[INPUT] 1    0    [1    /1   ]  12.4272807709        1
[INPUT] 1    0    [1    /1   ]  54.7861306591        1
[INPUT] 1    0    [1    /1   ]  0.159216290351       1
[INPUT] 1    0    [1    /1   ]  1.29129830082        1
[INPUT] 1    0    [1    /1   ]  0.447493501469       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998951, 1.0]], [0, [3661.4544700489737, 1.0]], [0, [833.2710557628184, 1.0]], [0, [235.7347565053209, 1.0]], [0, [76.43293118896133, 1.0]], [0, [10.036792128159039, 1.0]], [0, [27.050455253868876, 1.0]], [0, [0.3814869647996081, 1.0]], [0, [1.1171875094288066, 1.0]], [0, [2.8821825403784653, 1.0]], [1, [3.8225024150335147, 1.0]], [1, [12.427280770899985, 1.0]], [1, [54.786130659079575, 1.0]], [1, [0.1592162903508173, 1.0]], [1, [1.2912983008192345, 1.0]], [1, [0.44749350146876427, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447005]
bas 2, expnt(s) = [833.27105576]
bas 3, expnt(s) = [235.73475651]
bas 4, expnt(s) = [76.43293119]
bas 5, expnt(s) = [10.03679213]
bas 6, expnt(s) = [27.05045525]
bas 7, expnt(s) = [0.38148696]
bas 8, expnt(s) = [1.11718751]
bas 9, expnt(s) = [2.88218254]
bas 10, expnt(s) = [3.82250242]
bas 11, expnt(s) = [12.42728077]
bas 12, expnt(s) = [54.78613066]
bas 13, expnt(s) = [0.15921629]
bas 14, expnt(s) = [1.2912983]
bas 15, expnt(s) = [0.4474935]
CPU time:        27.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271056e+02 3.91836372e+02 2.35734757e+02 1.51996203e+02
 7.64329312e+01 6.53093574e+01 1.00367921e+01 1.42465997e+01
 2.70504553e+01 2.99671856e+01 3.81486965e-01 1.22637927e+00
 1.11718751e+00 2.74542496e+00 2.88218254e+00 5.58864002e+00
 3.82250242e+00 1.55926203e+01 1.24272808e+01 6.80698088e+01
 5.47861307e+01 4.34833183e+02 1.59216290e-01 2.93405850e-01
 1.29129830e+00 4.01575877e+00 4.47493501e-01 1.06774564e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999861617039958
cond(S) = 343.96089987429514
E1 = -183.58323005190607  E_coul = 55.079199546771875
init E= -128.504030505134
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774700955934904  LUMO = 0.430054272005808
  mo_energy =
[-3.25553022e+01 -1.85265630e+00 -7.74700956e-01 -7.74700956e-01
 -7.74700956e-01  4.30054272e-01  4.30054272e-01  4.30054272e-01
  1.21929931e+00  1.99351590e+00  1.99351590e+00  1.99351590e+00
  7.10111789e+00  7.10111789e+00  7.10111789e+00  7.37948977e+00
  2.57609698e+01  2.57609698e+01  2.57609698e+01  3.47838073e+01
  1.20287357e+02  1.20287357e+02  1.20287357e+02  1.38928683e+02
  5.03035160e+02  1.87067840e+03  8.00035099e+03  4.77680072e+04]
E1 = -182.03740693759613  E_coul = 53.50469457136432
cycle= 1 E= -128.532712366232  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.532763
diis-c [-0.2838362  1.       ]
  HOMO = -0.886561696615044  LUMO = 0.419412499208861
  mo_energy =
[-3.28869698e+01 -1.97016863e+00 -8.86561697e-01 -8.86561697e-01
 -8.86561697e-01  4.19412499e-01  4.19412499e-01  4.19412499e-01
  1.17201572e+00  1.93905027e+00  1.93905027e+00  1.93905027e+00
  6.96306886e+00  6.96306886e+00  6.96306886e+00  7.24342158e+00
  2.55172168e+01  2.55172168e+01  2.55172168e+01  3.45301398e+01
  1.19954109e+02  1.19954109e+02  1.19954109e+02  1.38602383e+02
  5.02664384e+02  1.87027145e+03  7.99991499e+03  4.77675523e+04]
E1 = -182.8267647612675  E_coul = 54.29133406257059
cycle= 2 E= -128.535430698697  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.064
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273509
diis-c [-6.27331402e-04  3.38531282e-01  6.61468718e-01]
  HOMO = -0.849698017934805  LUMO = 0.422954597859381
  mo_energy =
[-3.27756149e+01 -1.93130987e+00 -8.49698018e-01 -8.49698018e-01
 -8.49698018e-01  4.22954598e-01  4.22954598e-01  4.22954598e-01
  1.18726582e+00  1.95673324e+00  1.95673324e+00  1.95673324e+00
  7.00857429e+00  7.00857429e+00  7.00857429e+00  7.28824338e+00
  2.55989901e+01  2.55989901e+01  2.55989901e+01  3.46155156e+01
  1.20065267e+02  1.20065267e+02  1.20065267e+02  1.38711694e+02
  5.02784726e+02  1.87039717e+03  8.00004322e+03  4.77676815e+04]
E1 = -182.55789778961775  E_coul = 54.021479830187516
cycle= 3 E= -128.53641795943  delta_E= -0.000987  |g|= 0.000366  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000753087
diis-c [-9.82828018e-08 -1.85941202e-03 -1.12658899e-03  1.00298600e+00]
  HOMO = -0.849902716206852  LUMO = 0.422949430775651
  mo_energy =
[-3.27759581e+01 -1.93147302e+00 -8.49902716e-01 -8.49902716e-01
 -8.49902716e-01  4.22949431e-01  4.22949431e-01  4.22949431e-01
  1.18720791e+00  1.95666572e+00  1.95666572e+00  1.95666572e+00
  7.00840496e+00  7.00840496e+00  7.00840496e+00  7.28807811e+00
  2.55987263e+01  2.55987263e+01  2.55987263e+01  3.46152507e+01
  1.20064912e+02  1.20064912e+02  1.20064912e+02  1.38711350e+02
  5.02784289e+02  1.87039663e+03  8.00004260e+03  4.77676808e+04]
E1 = -182.55806946951174  E_coul = 54.02165149608763
cycle= 4 E= -128.536417973424  delta_E= -1.4e-08  |g|= 6.35e-05  |ddm|= 0.000212
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143643
diis-c [-6.72763362e-10  1.07675437e-04  4.37634863e-04 -1.36380230e-01
  1.13583492e+00]
  HOMO = -0.849939089238543  LUMO = 0.422944191379915
  mo_energy =
[-3.27760171e+01 -1.93150610e+00 -8.49939089e-01 -8.49939089e-01
 -8.49939089e-01  4.22944191e-01  4.22944191e-01  4.22944191e-01
  1.18718826e+00  1.95664319e+00  1.95664319e+00  1.95664319e+00
  7.00836282e+00  7.00836282e+00  7.00836282e+00  7.28803716e+00
  2.55986717e+01  2.55986717e+01  2.55986717e+01  3.46151958e+01
  1.20064853e+02  1.20064853e+02  1.20064853e+02  1.38711291e+02
  5.02784227e+02  1.87039657e+03  8.00004254e+03  4.77676808e+04]
E1 = -182.558167783828  E_coul = 54.02174980994948
cycle= 5 E= -128.536417973879  delta_E= -4.54e-10  |g|= 2.9e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.558167783828  E_coul = 54.02174980994948
  HOMO = -0.849938183445401  LUMO = 0.422944196940126
  mo_energy =
[-3.27760146e+01 -1.93150491e+00 -8.49938183e-01 -8.49938183e-01
 -8.49938183e-01  4.22944197e-01  4.22944197e-01  4.22944197e-01
  1.18718862e+00  1.95664350e+00  1.95664350e+00  1.95664350e+00
  7.00836395e+00  7.00836395e+00  7.00836395e+00  7.28803848e+00
  2.55986738e+01  2.55986738e+01  2.55986738e+01  3.46151980e+01
  1.20064856e+02  1.20064856e+02  1.20064856e+02  1.38711294e+02
  5.02784229e+02  1.87039657e+03  8.00004254e+03  4.77676808e+04]
E1 = -182.558158899836  E_coul = 54.021740925956266
Extra cycle  E= -128.53641797388  delta_E= -1.22e-12  |g|= 1.17e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271056e+02 2.35734757e+02
 7.64329312e+01 1.00367921e+01 2.70504553e+01 3.81486965e-01
 1.11718751e+00 2.88218254e+00 3.82250242e+00 1.24272808e+01
 5.47861307e+01 1.59216290e-01 1.29129830e+00 4.47493501e-01]
E = -128.53641797387974
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:14:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447005        1
[INPUT] 0    0    [1    /1   ]  833.271055763        1
[INPUT] 0    0    [1    /1   ]  235.734756505        1
[INPUT] 0    0    [1    /1   ]  76.432931189         1
[INPUT] 0    0    [1    /1   ]  10.0367921282        1
[INPUT] 0    0    [1    /1   ]  27.0504552539        1
[INPUT] 0    0    [1    /1   ]  0.3814869648         1
[INPUT] 0    0    [1    /1   ]  1.11718750943        1
[INPUT] 0    0    [1    /1   ]  2.88218254038        1
[INPUT] 1    0    [1    /1   ]  3.82250241503        1
[INPUT] 1    0    [1    /1   ]  12.4272807709        1
[INPUT] 1    0    [1    /1   ]  54.7861306591        1
[INPUT] 1    0    [1    /1   ]  0.159216290351       1
[INPUT] 1    0    [1    /1   ]  1.29129830082        1
[INPUT] 1    0    [1    /1   ]  0.447493501469       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998951, 1.0]], [0, [3661.4544700489737, 1.0]], [0, [833.2710557628184, 1.0]], [0, [235.7347565053209, 1.0]], [0, [76.43293118896133, 1.0]], [0, [10.036792128159039, 1.0]], [0, [27.050455253868876, 1.0]], [0, [0.3814869647996081, 1.0]], [0, [1.1171875094288066, 1.0]], [0, [2.8821825403784653, 1.0]], [1, [3.8225024150335147, 1.0]], [1, [12.427280770899985, 1.0]], [1, [54.786130659079575, 1.0]], [1, [0.1592162903508173, 1.0]], [1, [1.2912983008192345, 1.0]], [1, [0.44749350146876427, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447005]
bas 2, expnt(s) = [833.27105576]
bas 3, expnt(s) = [235.73475651]
bas 4, expnt(s) = [76.43293119]
bas 5, expnt(s) = [10.03679213]
bas 6, expnt(s) = [27.05045525]
bas 7, expnt(s) = [0.38148696]
bas 8, expnt(s) = [1.11718751]
bas 9, expnt(s) = [2.88218254]
bas 10, expnt(s) = [3.82250242]
bas 11, expnt(s) = [12.42728077]
bas 12, expnt(s) = [54.78613066]
bas 13, expnt(s) = [0.15921629]
bas 14, expnt(s) = [1.2912983]
bas 15, expnt(s) = [0.4474935]
CPU time:        27.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271056e+02 3.91836372e+02 2.35734757e+02 1.51996203e+02
 7.64329312e+01 6.53093574e+01 1.00367921e+01 1.42465997e+01
 2.70504553e+01 2.99671856e+01 3.81486965e-01 1.22637927e+00
 1.11718751e+00 2.74542496e+00 2.88218254e+00 5.58864002e+00
 3.82250242e+00 1.55926203e+01 1.24272808e+01 6.80698088e+01
 5.47861307e+01 4.34833183e+02 1.59216290e-01 2.93405850e-01
 1.29129830e+00 4.01575877e+00 4.47493501e-01 1.06774564e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999861617039958
cond(S) = 343.96089987429514
E1 = -183.58323005190607  E_coul = 55.079199546771875
init E= -128.504030505134
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774700955934904  LUMO = 0.430054272005808
  mo_energy =
[-3.25553022e+01 -1.85265630e+00 -7.74700956e-01 -7.74700956e-01
 -7.74700956e-01  4.30054272e-01  4.30054272e-01  4.30054272e-01
  1.21929931e+00  1.99351590e+00  1.99351590e+00  1.99351590e+00
  7.10111789e+00  7.10111789e+00  7.10111789e+00  7.37948977e+00
  2.57609698e+01  2.57609698e+01  2.57609698e+01  3.47838073e+01
  1.20287357e+02  1.20287357e+02  1.20287357e+02  1.38928683e+02
  5.03035160e+02  1.87067840e+03  8.00035099e+03  4.77680072e+04]
E1 = -182.03740693759613  E_coul = 53.50469457136432
cycle= 1 E= -128.532712366232  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.532763
diis-c [-0.2838362  1.       ]
  HOMO = -0.886561696615044  LUMO = 0.419412499208861
  mo_energy =
[-3.28869698e+01 -1.97016863e+00 -8.86561697e-01 -8.86561697e-01
 -8.86561697e-01  4.19412499e-01  4.19412499e-01  4.19412499e-01
  1.17201572e+00  1.93905027e+00  1.93905027e+00  1.93905027e+00
  6.96306886e+00  6.96306886e+00  6.96306886e+00  7.24342158e+00
  2.55172168e+01  2.55172168e+01  2.55172168e+01  3.45301398e+01
  1.19954109e+02  1.19954109e+02  1.19954109e+02  1.38602383e+02
  5.02664384e+02  1.87027145e+03  7.99991499e+03  4.77675523e+04]
E1 = -182.8267647612675  E_coul = 54.29133406257059
cycle= 2 E= -128.535430698697  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.064
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273509
diis-c [-6.27331402e-04  3.38531282e-01  6.61468718e-01]
  HOMO = -0.849698017934805  LUMO = 0.422954597859381
  mo_energy =
[-3.27756149e+01 -1.93130987e+00 -8.49698018e-01 -8.49698018e-01
 -8.49698018e-01  4.22954598e-01  4.22954598e-01  4.22954598e-01
  1.18726582e+00  1.95673324e+00  1.95673324e+00  1.95673324e+00
  7.00857429e+00  7.00857429e+00  7.00857429e+00  7.28824338e+00
  2.55989901e+01  2.55989901e+01  2.55989901e+01  3.46155156e+01
  1.20065267e+02  1.20065267e+02  1.20065267e+02  1.38711694e+02
  5.02784726e+02  1.87039717e+03  8.00004322e+03  4.77676815e+04]
E1 = -182.55789778961775  E_coul = 54.021479830187516
cycle= 3 E= -128.53641795943  delta_E= -0.000987  |g|= 0.000366  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000753087
diis-c [-9.82828018e-08 -1.85941202e-03 -1.12658899e-03  1.00298600e+00]
  HOMO = -0.849902716206852  LUMO = 0.422949430775651
  mo_energy =
[-3.27759581e+01 -1.93147302e+00 -8.49902716e-01 -8.49902716e-01
 -8.49902716e-01  4.22949431e-01  4.22949431e-01  4.22949431e-01
  1.18720791e+00  1.95666572e+00  1.95666572e+00  1.95666572e+00
  7.00840496e+00  7.00840496e+00  7.00840496e+00  7.28807811e+00
  2.55987263e+01  2.55987263e+01  2.55987263e+01  3.46152507e+01
  1.20064912e+02  1.20064912e+02  1.20064912e+02  1.38711350e+02
  5.02784289e+02  1.87039663e+03  8.00004260e+03  4.77676808e+04]
E1 = -182.55806946951174  E_coul = 54.02165149608763
cycle= 4 E= -128.536417973424  delta_E= -1.4e-08  |g|= 6.35e-05  |ddm|= 0.000212
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143643
diis-c [-6.72763362e-10  1.07675437e-04  4.37634863e-04 -1.36380230e-01
  1.13583492e+00]
  HOMO = -0.849939089238543  LUMO = 0.422944191379915
  mo_energy =
[-3.27760171e+01 -1.93150610e+00 -8.49939089e-01 -8.49939089e-01
 -8.49939089e-01  4.22944191e-01  4.22944191e-01  4.22944191e-01
  1.18718826e+00  1.95664319e+00  1.95664319e+00  1.95664319e+00
  7.00836282e+00  7.00836282e+00  7.00836282e+00  7.28803716e+00
  2.55986717e+01  2.55986717e+01  2.55986717e+01  3.46151958e+01
  1.20064853e+02  1.20064853e+02  1.20064853e+02  1.38711291e+02
  5.02784227e+02  1.87039657e+03  8.00004254e+03  4.77676808e+04]
E1 = -182.558167783828  E_coul = 54.02174980994948
cycle= 5 E= -128.536417973879  delta_E= -4.54e-10  |g|= 2.9e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.558167783828  E_coul = 54.02174980994948
  HOMO = -0.849938183445401  LUMO = 0.422944196940126
  mo_energy =
[-3.27760146e+01 -1.93150491e+00 -8.49938183e-01 -8.49938183e-01
 -8.49938183e-01  4.22944197e-01  4.22944197e-01  4.22944197e-01
  1.18718862e+00  1.95664350e+00  1.95664350e+00  1.95664350e+00
  7.00836395e+00  7.00836395e+00  7.00836395e+00  7.28803848e+00
  2.55986738e+01  2.55986738e+01  2.55986738e+01  3.46151980e+01
  1.20064856e+02  1.20064856e+02  1.20064856e+02  1.38711294e+02
  5.02784229e+02  1.87039657e+03  8.00004254e+03  4.77676808e+04]
E1 = -182.558158899836  E_coul = 54.021740925956266
Extra cycle  E= -128.53641797388  delta_E= -1.22e-12  |g|= 1.17e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.96089987429514
E1 = -182.558158899836  E_coul = 54.021740925956266
init E= -128.53641797388
    CPU time for initialize scf      0.27 sec, wall time      0.26 sec
  HOMO = -0.84993884219342  LUMO = 0.422944117675503
  mo_energy =
[-3.27760164e+01 -1.93150556e+00 -8.49938842e-01 -8.49938842e-01
 -8.49938842e-01  4.22944118e-01  4.22944118e-01  4.22944118e-01
  1.18718833e+00  1.95664315e+00  1.95664315e+00  1.95664315e+00
  7.00836314e+00  7.00836314e+00  7.00836314e+00  7.28803771e+00
  2.55986725e+01  2.55986725e+01  2.55986725e+01  3.46151966e+01
  1.20064854e+02  1.20064854e+02  1.20064854e+02  1.38711292e+02
  5.02784227e+02  1.87039657e+03  8.00004254e+03  4.77676808e+04]
E1 = -182.5581629311022  E_coul = 54.02174495722258
cycle= 1 E= -128.53641797388  delta_E= 1.14e-13  |g|= 5.65e-07  |ddm|= 4.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5581629311022  E_coul = 54.02174495722258
  HOMO = -0.849938562648307  LUMO = 0.422944141729276
  mo_energy =
[-3.27760156e+01 -1.93150526e+00 -8.49938563e-01 -8.49938563e-01
 -8.49938563e-01  4.22944142e-01  4.22944142e-01  4.22944142e-01
  1.18718844e+00  1.95664328e+00  1.95664328e+00  1.95664328e+00
  7.00836349e+00  7.00836349e+00  7.00836349e+00  7.28803805e+00
  2.55986731e+01  2.55986731e+01  2.55986731e+01  3.46151973e+01
  1.20064855e+02  1.20064855e+02  1.20064855e+02  1.38711293e+02
  5.02784228e+02  1.87039657e+03  8.00004254e+03  4.77676808e+04]
E1 = -182.5581607290561  E_coul = 54.021742755176454
Extra cycle  E= -128.53641797388  delta_E= -2.84e-14  |g|= 2.96e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271056e+02 2.35734757e+02
 7.64329312e+01 1.00367921e+01 2.70504553e+01 3.81486965e-01
 1.11718751e+00 2.88218254e+00 3.82250242e+00 1.24272808e+01
 5.47861307e+01 1.59216290e-01 1.29129830e+00 4.47493501e-01]
grad_E = [ 3.74320154e-11 -1.97784402e-09  4.73034587e-08 -7.01728202e-07
  4.45995218e-06  6.29302242e-07  3.96762703e-06  4.07161583e-06
  1.33242394e-05  1.29252175e-06 -4.56233166e-04 -7.91873307e-04
  5.07770881e-05 -1.70789954e-04 -4.29795877e-03 -3.45562718e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447006        1
[INPUT] 0    0    [1    /1   ]  833.271055546        1
[INPUT] 0    0    [1    /1   ]  235.73475973         1
[INPUT] 0    0    [1    /1   ]  76.4329106881        1
[INPUT] 0    0    [1    /1   ]  10.0367807425        1
[INPUT] 0    0    [1    /1   ]  27.0504372123        1
[INPUT] 0    0    [1    /1   ]  0.381534086155       1
[INPUT] 0    0    [1    /1   ]  1.11718653836        1
[INPUT] 0    0    [1    /1   ]  2.88214339096        1
[INPUT] 1    0    [1    /1   ]  3.84539034074        1
[INPUT] 1    0    [1    /1   ]  12.4249993389        1
[INPUT] 1    0    [1    /1   ]  54.7861789262        1
[INPUT] 1    0    [1    /1   ]  0.154498962585       1
[INPUT] 1    0    [1    /1   ]  1.30357166288        1
[INPUT] 1    0    [1    /1   ]  0.447140757112       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998934, 1.0]], [0, [3661.454470058011, 1.0]], [0, [833.27105554618, 1.0]], [0, [235.73475972974023, 1.0]], [0, [76.43291068807189, 1.0]], [0, [10.036780742533855, 1.0]], [0, [27.050437212316222, 1.0]], [0, [0.38153408615504947, 1.0]], [0, [1.117186538362329, 1.0]], [0, [2.8821433909615313, 1.0]], [1, [3.8453903407410164, 1.0]], [1, [12.42499933894882, 1.0]], [1, [54.7861789261836, 1.0]], [1, [0.15449896258481288, 1.0]], [1, [1.3035716628784466, 1.0]], [1, [0.44714075711229034, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447006]
bas 2, expnt(s) = [833.27105555]
bas 3, expnt(s) = [235.73475973]
bas 4, expnt(s) = [76.43291069]
bas 5, expnt(s) = [10.03678074]
bas 6, expnt(s) = [27.05043721]
bas 7, expnt(s) = [0.38153409]
bas 8, expnt(s) = [1.11718654]
bas 9, expnt(s) = [2.88214339]
bas 10, expnt(s) = [3.84539034]
bas 11, expnt(s) = [12.42499934]
bas 12, expnt(s) = [54.78617893]
bas 13, expnt(s) = [0.15449896]
bas 14, expnt(s) = [1.30357166]
bas 15, expnt(s) = [0.44714076]
CPU time:        30.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271056e+02 3.91836372e+02 2.35734760e+02 1.51996204e+02
 7.64329107e+01 6.53093442e+01 1.00367807e+01 1.42465876e+01
 2.70504372e+01 2.99671706e+01 3.81534086e-01 1.22649288e+00
 1.11718654e+00 2.74542317e+00 2.88214339e+00 5.58858309e+00
 3.84539034e+00 1.57094121e+01 1.24249993e+01 6.80541886e+01
 5.47861789e+01 4.34833662e+02 1.54498963e-01 2.82579955e-01
 1.30357166e+00 4.06352589e+00 4.47140757e-01 1.06669366e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99985475740628
cond(S) = 343.97316759901486
E1 = -183.58329676536033  E_coul = 55.079240897387656
init E= -128.504055867973
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.774700744064225  LUMO = 0.4189912395155
  mo_energy =
[-3.25553071e+01 -1.85265061e+00 -7.74700744e-01 -7.74700744e-01
 -7.74700744e-01  4.18991240e-01  4.18991240e-01  4.18991240e-01
  1.21941441e+00  1.97971051e+00  1.97971051e+00  1.97971051e+00
  7.13052634e+00  7.13052634e+00  7.13052634e+00  7.37964784e+00
  2.58520263e+01  2.58520263e+01  2.58520263e+01  3.47838490e+01
  1.20373449e+02  1.20373449e+02  1.20373449e+02  1.38928607e+02
  5.03035014e+02  1.87067825e+03  8.00035085e+03  4.77680070e+04]
E1 = -182.0373665246118  E_coul = 53.50460888154898
cycle= 1 E= -128.532757643063  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.530903
diis-c [-0.28185767  1.        ]
  HOMO = -0.886586031455354  LUMO = 0.40865817328467
  mo_energy =
[-3.28869407e+01 -1.97018963e+00 -8.86586031e-01 -8.86586031e-01
 -8.86586031e-01  4.08658173e-01  4.08658173e-01  4.08658173e-01
  1.17210089e+00  1.92499183e+00  1.92499183e+00  1.92499183e+00
  6.99169367e+00  6.99169367e+00  6.99169367e+00  7.24355227e+00
  2.56081891e+01  2.56081891e+01  2.56081891e+01  3.45301922e+01
  1.20040262e+02  1.20040262e+02  1.20040262e+02  1.38602336e+02
  5.02664261e+02  1.87027131e+03  7.99991487e+03  4.77675522e+04]
E1 = -182.82670524527543  E_coul = 54.2912305251328
cycle= 2 E= -128.535474720143  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.272615
diis-c [-6.26653231e-04  3.38577825e-01  6.61422175e-01]
  HOMO = -0.849725392703346  LUMO = 0.412097242591555
  mo_energy =
[-3.27755979e+01 -1.93133394e+00 -8.49725393e-01 -8.49725393e-01
 -8.49725393e-01  4.12097243e-01  4.12097243e-01  4.12097243e-01
  1.18735102e+00  1.94275046e+00  1.94275046e+00  1.94275046e+00
  7.03745148e+00  7.03745148e+00  7.03745148e+00  7.28836998e+00
  2.56899867e+01  2.56899867e+01  2.56899867e+01  3.46155594e+01
  1.20151398e+02  1.20151398e+02  1.20151398e+02  1.38711634e+02
  5.02784589e+02  1.87039702e+03  8.00004308e+03  4.77676814e+04]
E1 = -182.55777451477735  E_coul = 54.02131235049596
cycle= 3 E= -128.536462164281  delta_E= -0.000987  |g|= 0.00037  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757323
diis-c [-1.01804376e-07 -1.86962123e-03 -1.12979366e-03  1.00299941e+00]
  HOMO = -0.849932866260407  LUMO = 0.412091810956482
  mo_energy =
[-3.27759441e+01 -1.93150034e+00 -8.49932866e-01 -8.49932866e-01
 -8.49932866e-01  4.12091811e-01  4.12091811e-01  4.12091811e-01
  1.18729093e+00  1.94268091e+00  1.94268091e+00  1.94268091e+00
  7.03727807e+00  7.03727807e+00  7.03727807e+00  7.28820126e+00
  2.56897193e+01  2.56897193e+01  2.56897193e+01  3.46152910e+01
  1.20151040e+02  1.20151040e+02  1.20151040e+02  1.38711288e+02
  5.02784149e+02  1.87039648e+03  8.00004246e+03  4.77676807e+04]
E1 = -182.5579465313354  E_coul = 54.021484352560634
cycle= 4 E= -128.536462178775  delta_E= -1.45e-08  |g|= 6.41e-05  |ddm|= 0.000213
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143442
diis-c [-6.72312106e-10  1.11074264e-04  4.37296497e-04 -1.38546022e-01
  1.13799765e+00]
  HOMO = -0.849969721654922  LUMO = 0.412086592057246
  mo_energy =
[-3.27760037e+01 -1.93153405e+00 -8.49969722e-01 -8.49969722e-01
 -8.49969722e-01  4.12086592e-01  4.12086592e-01  4.12086592e-01
  1.18727083e+00  1.94265790e+00  1.94265790e+00  1.94265790e+00
  7.03723519e+00  7.03723519e+00  7.03723519e+00  7.28815969e+00
  2.56896641e+01  2.56896641e+01  2.56896641e+01  3.46152355e+01
  1.20150981e+02  1.20150981e+02  1.20150981e+02  1.38711229e+02
  5.02784087e+02  1.87039641e+03  8.00004239e+03  4.77676807e+04]
E1 = -182.55804437402304  E_coul = 54.021582194778006
cycle= 5 E= -128.536462179245  delta_E= -4.7e-10  |g|= 2.99e-06  |ddm|= 3.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55804437402304  E_coul = 54.021582194778006
  HOMO = -0.849968741120315  LUMO = 0.412086599747771
  mo_energy =
[-3.27760010e+01 -1.93153281e+00 -8.49968741e-01 -8.49968741e-01
 -8.49968741e-01  4.12086600e-01  4.12086600e-01  4.12086600e-01
  1.18727120e+00  1.94265824e+00  1.94265824e+00  1.94265824e+00
  7.03723641e+00  7.03723641e+00  7.03723641e+00  7.28816108e+00
  2.56896663e+01  2.56896663e+01  2.56896663e+01  3.46152379e+01
  1.20150983e+02  1.20150983e+02  1.20150983e+02  1.38711231e+02
  5.02784089e+02  1.87039641e+03  8.00004239e+03  4.77676807e+04]
E1 = -182.55803492665353  E_coul = 54.02157274740679
Extra cycle  E= -128.536462179247  delta_E= -1.71e-12  |g|= 1.24e-06  |ddm|= 2.1e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271056e+02 2.35734760e+02
 7.64329107e+01 1.00367807e+01 2.70504372e+01 3.81534086e-01
 1.11718654e+00 2.88214339e+00 3.84539034e+00 1.24249993e+01
 5.47861789e+01 1.54498963e-01 1.30357166e+00 4.47140757e-01]
E = -128.53646217924674
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447006        1
[INPUT] 0    0    [1    /1   ]  833.271055546        1
[INPUT] 0    0    [1    /1   ]  235.73475973         1
[INPUT] 0    0    [1    /1   ]  76.4329106881        1
[INPUT] 0    0    [1    /1   ]  10.0367807425        1
[INPUT] 0    0    [1    /1   ]  27.0504372123        1
[INPUT] 0    0    [1    /1   ]  0.381534086155       1
[INPUT] 0    0    [1    /1   ]  1.11718653836        1
[INPUT] 0    0    [1    /1   ]  2.88214339096        1
[INPUT] 1    0    [1    /1   ]  3.84539034074        1
[INPUT] 1    0    [1    /1   ]  12.4249993389        1
[INPUT] 1    0    [1    /1   ]  54.7861789262        1
[INPUT] 1    0    [1    /1   ]  0.154498962585       1
[INPUT] 1    0    [1    /1   ]  1.30357166288        1
[INPUT] 1    0    [1    /1   ]  0.447140757112       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998934, 1.0]], [0, [3661.454470058011, 1.0]], [0, [833.27105554618, 1.0]], [0, [235.73475972974023, 1.0]], [0, [76.43291068807189, 1.0]], [0, [10.036780742533855, 1.0]], [0, [27.050437212316222, 1.0]], [0, [0.38153408615504947, 1.0]], [0, [1.117186538362329, 1.0]], [0, [2.8821433909615313, 1.0]], [1, [3.8453903407410164, 1.0]], [1, [12.42499933894882, 1.0]], [1, [54.7861789261836, 1.0]], [1, [0.15449896258481288, 1.0]], [1, [1.3035716628784466, 1.0]], [1, [0.44714075711229034, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447006]
bas 2, expnt(s) = [833.27105555]
bas 3, expnt(s) = [235.73475973]
bas 4, expnt(s) = [76.43291069]
bas 5, expnt(s) = [10.03678074]
bas 6, expnt(s) = [27.05043721]
bas 7, expnt(s) = [0.38153409]
bas 8, expnt(s) = [1.11718654]
bas 9, expnt(s) = [2.88214339]
bas 10, expnt(s) = [3.84539034]
bas 11, expnt(s) = [12.42499934]
bas 12, expnt(s) = [54.78617893]
bas 13, expnt(s) = [0.15449896]
bas 14, expnt(s) = [1.30357166]
bas 15, expnt(s) = [0.44714076]
CPU time:        30.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271056e+02 3.91836372e+02 2.35734760e+02 1.51996204e+02
 7.64329107e+01 6.53093442e+01 1.00367807e+01 1.42465876e+01
 2.70504372e+01 2.99671706e+01 3.81534086e-01 1.22649288e+00
 1.11718654e+00 2.74542317e+00 2.88214339e+00 5.58858309e+00
 3.84539034e+00 1.57094121e+01 1.24249993e+01 6.80541886e+01
 5.47861789e+01 4.34833662e+02 1.54498963e-01 2.82579955e-01
 1.30357166e+00 4.06352589e+00 4.47140757e-01 1.06669366e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99985475740628
cond(S) = 343.97316759901486
E1 = -183.58329676536033  E_coul = 55.079240897387656
init E= -128.504055867973
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774700744064225  LUMO = 0.4189912395155
  mo_energy =
[-3.25553071e+01 -1.85265061e+00 -7.74700744e-01 -7.74700744e-01
 -7.74700744e-01  4.18991240e-01  4.18991240e-01  4.18991240e-01
  1.21941441e+00  1.97971051e+00  1.97971051e+00  1.97971051e+00
  7.13052634e+00  7.13052634e+00  7.13052634e+00  7.37964784e+00
  2.58520263e+01  2.58520263e+01  2.58520263e+01  3.47838490e+01
  1.20373449e+02  1.20373449e+02  1.20373449e+02  1.38928607e+02
  5.03035014e+02  1.87067825e+03  8.00035085e+03  4.77680070e+04]
E1 = -182.0373665246118  E_coul = 53.50460888154898
cycle= 1 E= -128.532757643063  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.530903
diis-c [-0.28185767  1.        ]
  HOMO = -0.886586031455354  LUMO = 0.40865817328467
  mo_energy =
[-3.28869407e+01 -1.97018963e+00 -8.86586031e-01 -8.86586031e-01
 -8.86586031e-01  4.08658173e-01  4.08658173e-01  4.08658173e-01
  1.17210089e+00  1.92499183e+00  1.92499183e+00  1.92499183e+00
  6.99169367e+00  6.99169367e+00  6.99169367e+00  7.24355227e+00
  2.56081891e+01  2.56081891e+01  2.56081891e+01  3.45301922e+01
  1.20040262e+02  1.20040262e+02  1.20040262e+02  1.38602336e+02
  5.02664261e+02  1.87027131e+03  7.99991487e+03  4.77675522e+04]
E1 = -182.82670524527543  E_coul = 54.2912305251328
cycle= 2 E= -128.535474720143  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.272615
diis-c [-6.26653231e-04  3.38577825e-01  6.61422175e-01]
  HOMO = -0.849725392703346  LUMO = 0.412097242591555
  mo_energy =
[-3.27755979e+01 -1.93133394e+00 -8.49725393e-01 -8.49725393e-01
 -8.49725393e-01  4.12097243e-01  4.12097243e-01  4.12097243e-01
  1.18735102e+00  1.94275046e+00  1.94275046e+00  1.94275046e+00
  7.03745148e+00  7.03745148e+00  7.03745148e+00  7.28836998e+00
  2.56899867e+01  2.56899867e+01  2.56899867e+01  3.46155594e+01
  1.20151398e+02  1.20151398e+02  1.20151398e+02  1.38711634e+02
  5.02784589e+02  1.87039702e+03  8.00004308e+03  4.77676814e+04]
E1 = -182.55777451477735  E_coul = 54.02131235049596
cycle= 3 E= -128.536462164281  delta_E= -0.000987  |g|= 0.00037  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757323
diis-c [-1.01804376e-07 -1.86962123e-03 -1.12979366e-03  1.00299941e+00]
  HOMO = -0.849932866260407  LUMO = 0.412091810956482
  mo_energy =
[-3.27759441e+01 -1.93150034e+00 -8.49932866e-01 -8.49932866e-01
 -8.49932866e-01  4.12091811e-01  4.12091811e-01  4.12091811e-01
  1.18729093e+00  1.94268091e+00  1.94268091e+00  1.94268091e+00
  7.03727807e+00  7.03727807e+00  7.03727807e+00  7.28820126e+00
  2.56897193e+01  2.56897193e+01  2.56897193e+01  3.46152910e+01
  1.20151040e+02  1.20151040e+02  1.20151040e+02  1.38711288e+02
  5.02784149e+02  1.87039648e+03  8.00004246e+03  4.77676807e+04]
E1 = -182.5579465313354  E_coul = 54.021484352560634
cycle= 4 E= -128.536462178775  delta_E= -1.45e-08  |g|= 6.41e-05  |ddm|= 0.000213
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143442
diis-c [-6.72312106e-10  1.11074264e-04  4.37296497e-04 -1.38546022e-01
  1.13799765e+00]
  HOMO = -0.849969721654922  LUMO = 0.412086592057246
  mo_energy =
[-3.27760037e+01 -1.93153405e+00 -8.49969722e-01 -8.49969722e-01
 -8.49969722e-01  4.12086592e-01  4.12086592e-01  4.12086592e-01
  1.18727083e+00  1.94265790e+00  1.94265790e+00  1.94265790e+00
  7.03723519e+00  7.03723519e+00  7.03723519e+00  7.28815969e+00
  2.56896641e+01  2.56896641e+01  2.56896641e+01  3.46152355e+01
  1.20150981e+02  1.20150981e+02  1.20150981e+02  1.38711229e+02
  5.02784087e+02  1.87039641e+03  8.00004239e+03  4.77676807e+04]
E1 = -182.55804437402304  E_coul = 54.021582194778006
cycle= 5 E= -128.536462179245  delta_E= -4.7e-10  |g|= 2.99e-06  |ddm|= 3.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55804437402304  E_coul = 54.021582194778006
  HOMO = -0.849968741120315  LUMO = 0.412086599747771
  mo_energy =
[-3.27760010e+01 -1.93153281e+00 -8.49968741e-01 -8.49968741e-01
 -8.49968741e-01  4.12086600e-01  4.12086600e-01  4.12086600e-01
  1.18727120e+00  1.94265824e+00  1.94265824e+00  1.94265824e+00
  7.03723641e+00  7.03723641e+00  7.03723641e+00  7.28816108e+00
  2.56896663e+01  2.56896663e+01  2.56896663e+01  3.46152379e+01
  1.20150983e+02  1.20150983e+02  1.20150983e+02  1.38711231e+02
  5.02784089e+02  1.87039641e+03  8.00004239e+03  4.77676807e+04]
E1 = -182.55803492665353  E_coul = 54.02157274740679
Extra cycle  E= -128.536462179247  delta_E= -1.71e-12  |g|= 1.24e-06  |ddm|= 2.1e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.97316759901486
E1 = -182.55803492665353  E_coul = 54.02157274740679
init E= -128.536462179247
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.849969439183332  LUMO = 0.412086518009531
  mo_energy =
[-3.27760029e+01 -1.93153351e+00 -8.49969439e-01 -8.49969439e-01
 -8.49969439e-01  4.12086518e-01  4.12086518e-01  4.12086518e-01
  1.18727089e+00  1.94265787e+00  1.94265787e+00  1.94265787e+00
  7.03723555e+00  7.03723555e+00  7.03723555e+00  7.28816026e+00
  2.56896649e+01  2.56896649e+01  2.56896649e+01  3.46152364e+01
  1.20150981e+02  1.20150981e+02  1.20150981e+02  1.38711229e+02
  5.02784087e+02  1.87039641e+03  8.00004239e+03  4.77676807e+04]
E1 = -182.55803921629305  E_coul = 54.02157703704634
cycle= 1 E= -128.536462179247  delta_E= 2.84e-14  |g|= 6e-07  |ddm|= 5.05e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55803921629305  E_coul = 54.02157703704634
  HOMO = -0.849969141285672  LUMO = 0.412086542844859
  mo_energy =
[-3.27760020e+01 -1.93153319e+00 -8.49969141e-01 -8.49969141e-01
 -8.49969141e-01  4.12086543e-01  4.12086543e-01  4.12086543e-01
  1.18727101e+00  1.94265801e+00  1.94265801e+00  1.94265801e+00
  7.03723592e+00  7.03723592e+00  7.03723592e+00  7.28816062e+00
  2.56896655e+01  2.56896655e+01  2.56896655e+01  3.46152371e+01
  1.20150982e+02  1.20150982e+02  1.20150982e+02  1.38711230e+02
  5.02784088e+02  1.87039641e+03  8.00004239e+03  4.77676807e+04]
E1 = -182.55803687068783  E_coul = 54.02157469144073
Extra cycle  E= -128.536462179247  delta_E= -3.98e-13  |g|= 3.16e-07  |ddm|= 2e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271056e+02 2.35734760e+02
 7.64329107e+01 1.00367807e+01 2.70504372e+01 3.81534086e-01
 1.11718654e+00 2.88214339e+00 3.84539034e+00 1.24249993e+01
 5.47861789e+01 1.54498963e-01 1.30357166e+00 4.47140757e-01]
grad_E = [ 3.76813223e-11 -1.99096434e-09  4.75713247e-08 -7.05021899e-07
  4.48637172e-06  9.80395318e-07  3.84551781e-06  5.47869190e-05
 -1.01212471e-05  3.28462788e-06 -2.16278633e-04 -9.70665661e-04
  6.10840392e-05 -2.01495173e-03 -3.03342159e-03 -4.56767696e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447008        1
[INPUT] 0    0    [1    /1   ]  833.271055117        1
[INPUT] 0    0    [1    /1   ]  235.734766112        1
[INPUT] 0    0    [1    /1   ]  76.4328701086        1
[INPUT] 0    0    [1    /1   ]  10.0367619275        1
[INPUT] 0    0    [1    /1   ]  27.0504015156        1
[INPUT] 0    0    [1    /1   ]  0.381551912402       1
[INPUT] 0    0    [1    /1   ]  1.11719130913        1
[INPUT] 0    0    [1    /1   ]  2.8820779929         1
[INPUT] 1    0    [1    /1   ]  3.8815272262         1
[INPUT] 1    0    [1    /1   ]  12.4235248077        1
[INPUT] 1    0    [1    /1   ]  54.7861243976        1
[INPUT] 1    0    [1    /1   ]  0.153300410782       1
[INPUT] 1    0    [1    /1   ]  1.32620545716        1
[INPUT] 1    0    [1    /1   ]  0.456962477456       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129989, 1.0]], [0, [3661.4544700759257, 1.0]], [0, [833.271055117001, 1.0]], [0, [235.7347661119948, 1.0]], [0, [76.43287010858964, 1.0]], [0, [10.036761927548225, 1.0]], [0, [27.050401515594448, 1.0]], [0, [0.3815519124023105, 1.0]], [0, [1.1171913091275334, 1.0]], [0, [2.882077992898434, 1.0]], [1, [3.8815272262025196, 1.0]], [1, [12.423524807747478, 1.0]], [1, [54.78612439761198, 1.0]], [1, [0.15330041078236406, 1.0]], [1, [1.32620545715943, 1.0]], [1, [0.4569624774561255, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447008]
bas 2, expnt(s) = [833.27105512]
bas 3, expnt(s) = [235.73476611]
bas 4, expnt(s) = [76.43287011]
bas 5, expnt(s) = [10.03676193]
bas 6, expnt(s) = [27.05040152]
bas 7, expnt(s) = [0.38155191]
bas 8, expnt(s) = [1.11719131]
bas 9, expnt(s) = [2.88207799]
bas 10, expnt(s) = [3.88152723]
bas 11, expnt(s) = [12.42352481]
bas 12, expnt(s) = [54.7861244]
bas 13, expnt(s) = [0.15330041]
bas 14, expnt(s) = [1.32620546]
bas 15, expnt(s) = [0.45696248]
CPU time:        33.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271055e+02 3.91836372e+02 2.35734766e+02 1.51996208e+02
 7.64328701e+01 6.53093182e+01 1.00367619e+01 1.42465675e+01
 2.70504015e+01 2.99671410e+01 3.81551912e-01 1.22653586e+00
 1.11719131e+00 2.74543196e+00 2.88207799e+00 5.58848798e+00
 3.88152723e+00 1.58941640e+01 1.24235248e+01 6.80440934e+01
 5.47861244e+01 4.34833121e+02 1.53300411e-01 2.79842415e-01
 1.32620546e+00 4.15190976e+00 4.56962477e-01 1.09606187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999852563744245
cond(S) = 343.9770180184852
E1 = -183.58340759640348  E_coul = 55.07928423663297
init E= -128.504123359771
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774703661817344  LUMO = 0.418747538966065
  mo_energy =
[-3.25553231e+01 -1.85264377e+00 -7.74703662e-01 -7.74703662e-01
 -7.74703662e-01  4.18747539e-01  4.18747539e-01  4.18747539e-01
  1.21948376e+00  2.00883706e+00  2.00883706e+00  2.00883706e+00
  7.24502417e+00  7.24502417e+00  7.24502417e+00  7.37965149e+00
  2.60596386e+01  2.60596386e+01  2.60596386e+01  3.47837097e+01
  1.20559016e+02  1.20559016e+02  1.20559016e+02  1.38928256e+02
  5.03034553e+02  1.87067780e+03  8.00035045e+03  4.77680067e+04]
E1 = -182.0381863402667  E_coul = 53.505338937150164
cycle= 1 E= -128.532847403117  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.530536
diis-c [-0.28146835  1.        ]
  HOMO = -0.886551017837572  LUMO = 0.408284066561135
  mo_energy =
[-3.28867778e+01 -1.97013534e+00 -8.86551018e-01 -8.86551018e-01
 -8.86551018e-01  4.08284067e-01  4.08284067e-01  4.08284067e-01
  1.17217789e+00  1.95304213e+00  1.95304213e+00  1.95304213e+00
  7.10520940e+00  7.10520940e+00  7.10520940e+00  7.24359928e+00
  2.58159079e+01  2.58159079e+01  2.58159079e+01  3.45301478e+01
  1.20226083e+02  1.20226083e+02  1.20226083e+02  1.38602148e+02
  5.02663956e+02  1.87027100e+03  7.99991460e+03  4.77675520e+04]
E1 = -182.82725073596978  E_coul = 54.291688737526215
cycle= 2 E= -128.535561998444  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.272483
diis-c [-6.24912412e-04  3.38625346e-01  6.61374654e-01]
  HOMO = -0.849705069613701  LUMO = 0.411756352831874
  mo_energy =
[-3.27754838e+01 -1.93129587e+00 -8.49705070e-01 -8.49705070e-01
 -8.49705070e-01  4.11756353e-01  4.11756353e-01  4.11756353e-01
  1.18742081e+00  1.97114102e+00  1.97114102e+00  1.97114102e+00
  7.15129883e+00  7.15129883e+00  7.15129883e+00  7.28839861e+00
  2.58976732e+01  2.58976732e+01  2.58976732e+01  3.46154783e+01
  1.20337147e+02  1.20337147e+02  1.20337147e+02  1.38711399e+02
  5.02784229e+02  1.87039665e+03  8.00004275e+03  4.77676811e+04]
E1 = -182.55830242571284  E_coul = 54.02175340250542
cycle= 3 E= -128.536549023207  delta_E= -0.000987  |g|= 0.00038  |ddm|= 0.0224
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773735
diis-c [-1.17761706e-07 -1.89736227e-03 -1.15766460e-03  1.00305503e+00]
  HOMO = -0.84991864155008  LUMO = 0.411748133218267
  mo_energy =
[-3.27758374e+01 -1.93146943e+00 -8.49918642e-01 -8.49918642e-01
 -8.49918642e-01  4.11748133e-01  4.11748133e-01  4.11748133e-01
  1.18735419e+00  1.97106363e+00  1.97106363e+00  1.97106363e+00
  7.15111658e+00  7.15111658e+00  7.15111658e+00  7.28822268e+00
  2.58973979e+01  2.58973979e+01  2.58973979e+01  3.46152021e+01
  1.20336782e+02  1.20336782e+02  1.20336782e+02  1.38711044e+02
  5.02783782e+02  1.87039609e+03  8.00004212e+03  4.77676805e+04]
E1 = -182.55845556942265  E_coul = 54.021906528611396
cycle= 4 E= -128.536549040811  delta_E= -1.76e-08  |g|= 6.79e-05  |ddm|= 0.000235
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000148107
diis-c [-7.06708407e-10  1.24299693e-04  4.53121736e-04 -1.48422316e-01
  1.14784489e+00]
  HOMO = -0.849958035412747  LUMO = 0.411742198004702
  mo_energy =
[-3.27759007e+01 -1.93150622e+00 -8.49958035e-01 -8.49958035e-01
 -8.49958035e-01  4.11742198e-01  4.11742198e-01  4.11742198e-01
  1.18733180e+00  1.97103810e+00  1.97103810e+00  1.97103810e+00
  7.15107035e+00  7.15107035e+00  7.15107035e+00  7.28817799e+00
  2.58973391e+01  2.58973391e+01  2.58973391e+01  3.46151430e+01
  1.20336719e+02  1.20336719e+02  1.20336719e+02  1.38710981e+02
  5.02783716e+02  1.87039603e+03  8.00004205e+03  4.77676804e+04]
E1 = -182.55855232699102  E_coul = 54.02200328559818
cycle= 5 E= -128.536549041393  delta_E= -5.82e-10  |g|= 3.24e-06  |ddm|= 4.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55855232699102  E_coul = 54.02200328559818
  HOMO = -0.849956844612427  LUMO = 0.411742217064127
  mo_energy =
[-3.27758975e+01 -1.93150489e+00 -8.49956845e-01 -8.49956845e-01
 -8.49956845e-01  4.11742217e-01  4.11742217e-01  4.11742217e-01
  1.18733217e+00  1.97103854e+00  1.97103854e+00  1.97103854e+00
  7.15107181e+00  7.15107181e+00  7.15107181e+00  7.28817958e+00
  2.58973417e+01  2.58973417e+01  2.58973417e+01  3.46151458e+01
  1.20336722e+02  1.20336722e+02  1.20336722e+02  1.38710985e+02
  5.02783719e+02  1.87039603e+03  8.00004206e+03  4.77676804e+04]
E1 = -182.5585411942561  E_coul = 54.02199215286167
Extra cycle  E= -128.536549041394  delta_E= -1.59e-12  |g|= 1.47e-06  |ddm|= 2.23e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271055e+02 2.35734766e+02
 7.64328701e+01 1.00367619e+01 2.70504015e+01 3.81551912e-01
 1.11719131e+00 2.88207799e+00 3.88152723e+00 1.24235248e+01
 5.47861244e+01 1.53300411e-01 1.32620546e+00 4.56962477e-01]
E = -128.53654904139444
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447008        1
[INPUT] 0    0    [1    /1   ]  833.271055117        1
[INPUT] 0    0    [1    /1   ]  235.734766112        1
[INPUT] 0    0    [1    /1   ]  76.4328701086        1
[INPUT] 0    0    [1    /1   ]  10.0367619275        1
[INPUT] 0    0    [1    /1   ]  27.0504015156        1
[INPUT] 0    0    [1    /1   ]  0.381551912402       1
[INPUT] 0    0    [1    /1   ]  1.11719130913        1
[INPUT] 0    0    [1    /1   ]  2.8820779929         1
[INPUT] 1    0    [1    /1   ]  3.8815272262         1
[INPUT] 1    0    [1    /1   ]  12.4235248077        1
[INPUT] 1    0    [1    /1   ]  54.7861243976        1
[INPUT] 1    0    [1    /1   ]  0.153300410782       1
[INPUT] 1    0    [1    /1   ]  1.32620545716        1
[INPUT] 1    0    [1    /1   ]  0.456962477456       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129989, 1.0]], [0, [3661.4544700759257, 1.0]], [0, [833.271055117001, 1.0]], [0, [235.7347661119948, 1.0]], [0, [76.43287010858964, 1.0]], [0, [10.036761927548225, 1.0]], [0, [27.050401515594448, 1.0]], [0, [0.3815519124023105, 1.0]], [0, [1.1171913091275334, 1.0]], [0, [2.882077992898434, 1.0]], [1, [3.8815272262025196, 1.0]], [1, [12.423524807747478, 1.0]], [1, [54.78612439761198, 1.0]], [1, [0.15330041078236406, 1.0]], [1, [1.32620545715943, 1.0]], [1, [0.4569624774561255, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447008]
bas 2, expnt(s) = [833.27105512]
bas 3, expnt(s) = [235.73476611]
bas 4, expnt(s) = [76.43287011]
bas 5, expnt(s) = [10.03676193]
bas 6, expnt(s) = [27.05040152]
bas 7, expnt(s) = [0.38155191]
bas 8, expnt(s) = [1.11719131]
bas 9, expnt(s) = [2.88207799]
bas 10, expnt(s) = [3.88152723]
bas 11, expnt(s) = [12.42352481]
bas 12, expnt(s) = [54.7861244]
bas 13, expnt(s) = [0.15330041]
bas 14, expnt(s) = [1.32620546]
bas 15, expnt(s) = [0.45696248]
CPU time:        33.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271055e+02 3.91836372e+02 2.35734766e+02 1.51996208e+02
 7.64328701e+01 6.53093182e+01 1.00367619e+01 1.42465675e+01
 2.70504015e+01 2.99671410e+01 3.81551912e-01 1.22653586e+00
 1.11719131e+00 2.74543196e+00 2.88207799e+00 5.58848798e+00
 3.88152723e+00 1.58941640e+01 1.24235248e+01 6.80440934e+01
 5.47861244e+01 4.34833121e+02 1.53300411e-01 2.79842415e-01
 1.32620546e+00 4.15190976e+00 4.56962477e-01 1.09606187e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999852563744245
cond(S) = 343.9770180184852
E1 = -183.58340759640348  E_coul = 55.07928423663297
init E= -128.504123359771
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774703661817344  LUMO = 0.418747538966065
  mo_energy =
[-3.25553231e+01 -1.85264377e+00 -7.74703662e-01 -7.74703662e-01
 -7.74703662e-01  4.18747539e-01  4.18747539e-01  4.18747539e-01
  1.21948376e+00  2.00883706e+00  2.00883706e+00  2.00883706e+00
  7.24502417e+00  7.24502417e+00  7.24502417e+00  7.37965149e+00
  2.60596386e+01  2.60596386e+01  2.60596386e+01  3.47837097e+01
  1.20559016e+02  1.20559016e+02  1.20559016e+02  1.38928256e+02
  5.03034553e+02  1.87067780e+03  8.00035045e+03  4.77680067e+04]
E1 = -182.0381863402667  E_coul = 53.505338937150164
cycle= 1 E= -128.532847403117  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.530536
diis-c [-0.28146835  1.        ]
  HOMO = -0.886551017837572  LUMO = 0.408284066561135
  mo_energy =
[-3.28867778e+01 -1.97013534e+00 -8.86551018e-01 -8.86551018e-01
 -8.86551018e-01  4.08284067e-01  4.08284067e-01  4.08284067e-01
  1.17217789e+00  1.95304213e+00  1.95304213e+00  1.95304213e+00
  7.10520940e+00  7.10520940e+00  7.10520940e+00  7.24359928e+00
  2.58159079e+01  2.58159079e+01  2.58159079e+01  3.45301478e+01
  1.20226083e+02  1.20226083e+02  1.20226083e+02  1.38602148e+02
  5.02663956e+02  1.87027100e+03  7.99991460e+03  4.77675520e+04]
E1 = -182.82725073596978  E_coul = 54.291688737526215
cycle= 2 E= -128.535561998444  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.272483
diis-c [-6.24912412e-04  3.38625346e-01  6.61374654e-01]
  HOMO = -0.849705069613701  LUMO = 0.411756352831874
  mo_energy =
[-3.27754838e+01 -1.93129587e+00 -8.49705070e-01 -8.49705070e-01
 -8.49705070e-01  4.11756353e-01  4.11756353e-01  4.11756353e-01
  1.18742081e+00  1.97114102e+00  1.97114102e+00  1.97114102e+00
  7.15129883e+00  7.15129883e+00  7.15129883e+00  7.28839861e+00
  2.58976732e+01  2.58976732e+01  2.58976732e+01  3.46154783e+01
  1.20337147e+02  1.20337147e+02  1.20337147e+02  1.38711399e+02
  5.02784229e+02  1.87039665e+03  8.00004275e+03  4.77676811e+04]
E1 = -182.55830242571284  E_coul = 54.02175340250542
cycle= 3 E= -128.536549023207  delta_E= -0.000987  |g|= 0.00038  |ddm|= 0.0224
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773735
diis-c [-1.17761706e-07 -1.89736227e-03 -1.15766460e-03  1.00305503e+00]
  HOMO = -0.84991864155008  LUMO = 0.411748133218267
  mo_energy =
[-3.27758374e+01 -1.93146943e+00 -8.49918642e-01 -8.49918642e-01
 -8.49918642e-01  4.11748133e-01  4.11748133e-01  4.11748133e-01
  1.18735419e+00  1.97106363e+00  1.97106363e+00  1.97106363e+00
  7.15111658e+00  7.15111658e+00  7.15111658e+00  7.28822268e+00
  2.58973979e+01  2.58973979e+01  2.58973979e+01  3.46152021e+01
  1.20336782e+02  1.20336782e+02  1.20336782e+02  1.38711044e+02
  5.02783782e+02  1.87039609e+03  8.00004212e+03  4.77676805e+04]
E1 = -182.55845556942265  E_coul = 54.021906528611396
cycle= 4 E= -128.536549040811  delta_E= -1.76e-08  |g|= 6.79e-05  |ddm|= 0.000235
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000148107
diis-c [-7.06708407e-10  1.24299693e-04  4.53121736e-04 -1.48422316e-01
  1.14784489e+00]
  HOMO = -0.849958035412747  LUMO = 0.411742198004702
  mo_energy =
[-3.27759007e+01 -1.93150622e+00 -8.49958035e-01 -8.49958035e-01
 -8.49958035e-01  4.11742198e-01  4.11742198e-01  4.11742198e-01
  1.18733180e+00  1.97103810e+00  1.97103810e+00  1.97103810e+00
  7.15107035e+00  7.15107035e+00  7.15107035e+00  7.28817799e+00
  2.58973391e+01  2.58973391e+01  2.58973391e+01  3.46151430e+01
  1.20336719e+02  1.20336719e+02  1.20336719e+02  1.38710981e+02
  5.02783716e+02  1.87039603e+03  8.00004205e+03  4.77676804e+04]
E1 = -182.55855232699102  E_coul = 54.02200328559818
cycle= 5 E= -128.536549041393  delta_E= -5.82e-10  |g|= 3.24e-06  |ddm|= 4.31e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.55855232699102  E_coul = 54.02200328559818
  HOMO = -0.849956844612427  LUMO = 0.411742217064127
  mo_energy =
[-3.27758975e+01 -1.93150489e+00 -8.49956845e-01 -8.49956845e-01
 -8.49956845e-01  4.11742217e-01  4.11742217e-01  4.11742217e-01
  1.18733217e+00  1.97103854e+00  1.97103854e+00  1.97103854e+00
  7.15107181e+00  7.15107181e+00  7.15107181e+00  7.28817958e+00
  2.58973417e+01  2.58973417e+01  2.58973417e+01  3.46151458e+01
  1.20336722e+02  1.20336722e+02  1.20336722e+02  1.38710985e+02
  5.02783719e+02  1.87039603e+03  8.00004206e+03  4.77676804e+04]
E1 = -182.5585411942561  E_coul = 54.02199215286167
Extra cycle  E= -128.536549041394  delta_E= -1.59e-12  |g|= 1.47e-06  |ddm|= 2.23e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9770180184852
E1 = -182.5585411942561  E_coul = 54.02199215286167
init E= -128.536549041394
    CPU time for initialize scf      0.31 sec, wall time      0.31 sec
  HOMO = -0.849957658531108  LUMO = 0.411742121385091
  mo_energy =
[-3.27758997e+01 -1.93150574e+00 -8.49957659e-01 -8.49957659e-01
 -8.49957659e-01  4.11742121e-01  4.11742121e-01  4.11742121e-01
  1.18733179e+00  1.97103810e+00  1.97103810e+00  1.97103810e+00
  7.15107080e+00  7.15107080e+00  7.15107080e+00  7.28817860e+00
  2.58973400e+01  2.58973400e+01  2.58973400e+01  3.46151440e+01
  1.20336719e+02  1.20336719e+02  1.20336719e+02  1.38710982e+02
  5.02783716e+02  1.87039603e+03  8.00004205e+03  4.77676804e+04]
E1 = -182.55854625919358  E_coul = 54.02199721779869
cycle= 1 E= -128.536549041395  delta_E= -4.55e-13  |g|= 7.04e-07  |ddm|= 5.96e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55854625919358  E_coul = 54.02199721779869
  HOMO = -0.849957305050756  LUMO = 0.411742151278816
  mo_energy =
[-3.27758986e+01 -1.93150537e+00 -8.49957305e-01 -8.49957305e-01
 -8.49957305e-01  4.11742151e-01  4.11742151e-01  4.11742151e-01
  1.18733192e+00  1.97103826e+00  1.97103826e+00  1.97103826e+00
  7.15107124e+00  7.15107124e+00  7.15107124e+00  7.28817903e+00
  2.58973408e+01  2.58973408e+01  2.58973408e+01  3.46151448e+01
  1.20336721e+02  1.20336721e+02  1.20336721e+02  1.38710983e+02
  5.02783717e+02  1.87039603e+03  8.00004205e+03  4.77676804e+04]
E1 = -182.5585434876629  E_coul = 54.02199444626827
Extra cycle  E= -128.536549041395  delta_E= 2.84e-13  |g|= 3.74e-07  |ddm|= 2.3e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271055e+02 2.35734766e+02
 7.64328701e+01 1.00367619e+01 2.70504015e+01 3.81551912e-01
 1.11719131e+00 2.88207799e+00 3.88152723e+00 1.24235248e+01
 5.47861244e+01 1.53300411e-01 1.32620546e+00 4.56962477e-01]
grad_E = [ 3.79042836e-11 -2.00262799e-09  4.78137776e-08 -7.07949277e-07
  4.50766672e-06  6.20074960e-07  3.81830182e-06  2.28547324e-05
  2.80190179e-06  1.21983498e-06  8.79327949e-04 -1.30561349e-03
  7.87880960e-05 -8.20520390e-03 -4.91921312e-03  1.23879175e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447011        1
[INPUT] 0    0    [1    /1   ]  833.271054365        1
[INPUT] 0    0    [1    /1   ]  235.734777293        1
[INPUT] 0    0    [1    /1   ]  76.4327990133        1
[INPUT] 0    0    [1    /1   ]  10.0367325808        1
[INPUT] 0    0    [1    /1   ]  27.0503391228        1
[INPUT] 0    0    [1    /1   ]  0.381547269189       1
[INPUT] 0    0    [1    /1   ]  1.11719306297        1
[INPUT] 0    0    [1    /1   ]  2.88197686463        1
[INPUT] 1    0    [1    /1   ]  3.93493931662        1
[INPUT] 1    0    [1    /1   ]  12.4240839975        1
[INPUT] 1    0    [1    /1   ]  54.7858739369        1
[INPUT] 1    0    [1    /1   ]  0.159687129194       1
[INPUT] 1    0    [1    /1   ]  1.36748715568        1
[INPUT] 1    0    [1    /1   ]  0.476716094518       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129988408, 1.0]], [0, [3661.454470107339, 1.0]], [0, [833.2710543647421, 1.0]], [0, [235.73477729258383, 1.0]], [0, [76.43279901334469, 1.0]], [0, [10.036732580816317, 1.0]], [0, [27.050339122797013, 1.0]], [0, [0.38154726918913767, 1.0]], [0, [1.1171930629674405, 1.0]], [0, [2.881976864626681, 1.0]], [1, [3.9349393166201283, 1.0]], [1, [12.424083997456712, 1.0]], [1, [54.78587393691935, 1.0]], [1, [0.15968712919412195, 1.0]], [1, [1.3674871556814951, 1.0]], [1, [0.47671609451848757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447011]
bas 2, expnt(s) = [833.27105436]
bas 3, expnt(s) = [235.73477729]
bas 4, expnt(s) = [76.43279901]
bas 5, expnt(s) = [10.03673258]
bas 6, expnt(s) = [27.05033912]
bas 7, expnt(s) = [0.38154727]
bas 8, expnt(s) = [1.11719306]
bas 9, expnt(s) = [2.88197686]
bas 10, expnt(s) = [3.93493932]
bas 11, expnt(s) = [12.424084]
bas 12, expnt(s) = [54.78587394]
bas 13, expnt(s) = [0.15968713]
bas 14, expnt(s) = [1.36748716]
bas 15, expnt(s) = [0.47671609]
CPU time:        36.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271054e+02 3.91836371e+02 2.35734777e+02 1.51996213e+02
 7.64327990e+01 6.53092727e+01 1.00367326e+01 1.42465363e+01
 2.70503391e+01 2.99670891e+01 3.81547269e-01 1.22652467e+00
 1.11719306e+00 2.74543520e+00 2.88197686e+00 5.58834091e+00
 3.93493932e+00 1.61680239e+01 1.24240840e+01 6.80479218e+01
 5.47858739e+01 4.34830636e+02 1.59687129e-01 2.94490836e-01
 1.36748716e+00 4.31408266e+00 4.76716095e-01 1.15560433e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999857060570491
cond(S) = 343.9725834894838
E1 = -183.58362570457382  E_coul = 55.079370510604846
init E= -128.504255193969
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774712767589941  LUMO = 0.439218839256468
  mo_energy =
[-3.25553355e+01 -1.85263058e+00 -7.74712768e-01 -7.74712768e-01
 -7.74712768e-01  4.39218839e-01  4.39218839e-01  4.39218839e-01
  1.21948078e+00  2.09969723e+00  2.09969723e+00  2.09969723e+00
  7.37951053e+00  7.48158893e+00  7.48158893e+00  7.48158893e+00
  2.64357849e+01  2.64357849e+01  2.64357849e+01  3.47832814e+01
  1.20890508e+02  1.20890508e+02  1.20890508e+02  1.38927548e+02
  5.03033667e+02  1.87067692e+03  8.00034967e+03  4.77680061e+04]
E1 = -182.03899441361793  E_coul = 53.50599397246595
cycle= 1 E= -128.533000441152  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.532997
diis-c [-0.28408589  1.        ]
  HOMO = -0.886530502028621  LUMO = 0.427930131890684
  mo_energy =
[-3.28866355e+01 -1.97008536e+00 -8.86530502e-01 -8.86530502e-01
 -8.86530502e-01  4.27930132e-01  4.27930132e-01  4.27930132e-01
  1.17217435e+00  2.04179193e+00  2.04179193e+00  2.04179193e+00
  7.24349671e+00  7.34036486e+00  7.34036486e+00  7.34036486e+00
  2.61922673e+01  2.61922673e+01  2.61922673e+01  3.45298202e+01
  1.20557859e+02  1.20557859e+02  1.20557859e+02  1.38601583e+02
  5.02663201e+02  1.87027023e+03  7.99991392e+03  4.77675515e+04]
E1 = -182.82764591864057  E_coul = 54.29193391974641
cycle= 2 E= -128.535711998894  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273776
diis-c [-6.23214998e-04  3.38657256e-01  6.61342744e-01]
  HOMO = -0.849705842149443  LUMO = 0.431665957374566
  mo_energy =
[-3.27754030e+01 -1.93126932e+00 -8.49705842e-01 -8.49705842e-01
 -8.49705842e-01  4.31665957e-01  4.31665957e-01  4.31665957e-01
  1.18740515e+00  2.06056229e+00  2.06056229e+00  2.06056229e+00
  7.28826925e+00  7.38692094e+00  7.38692094e+00  7.38692094e+00
  2.62739498e+01  2.62739498e+01  2.62739498e+01  3.46151033e+01
  1.20668818e+02  1.20668818e+02  1.20668818e+02  1.38710774e+02
  5.02783407e+02  1.87039581e+03  8.00004201e+03  4.77676805e+04]
E1 = -182.55874668945992  E_coul = 54.02204835047481
cycle= 3 E= -128.536698338985  delta_E= -0.000986  |g|= 0.000389  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000792672
diis-c [-1.24832172e-07 -1.92232716e-03 -1.15860285e-03  1.00308093e+00]
  HOMO = -0.849924392103113  LUMO = 0.431655333730429
  mo_energy =
[-3.27757621e+01 -1.93144864e+00 -8.49924392e-01 -8.49924392e-01
 -8.49924392e-01  4.31655334e-01  4.31655334e-01  4.31655334e-01
  1.18733371e+00  2.06047690e+00  2.06047690e+00  2.06047690e+00
  7.28808742e+00  7.38673087e+00  7.38673087e+00  7.38673087e+00
  2.62736683e+01  2.62736683e+01  2.62736683e+01  3.46148208e+01
  1.20668448e+02  1.20668448e+02  1.20668448e+02  1.38710414e+02
  5.02782955e+02  1.87039525e+03  8.00004137e+03  4.77676798e+04]
E1 = -182.55889332678404  E_coul = 54.02219496846073
cycle= 4 E= -128.536698358323  delta_E= -1.93e-08  |g|= 7.06e-05  |ddm|= 0.000247
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000153343
diis-c [-7.14689039e-10  1.26462940e-04  4.63390520e-04 -1.50804262e-01
  1.15021441e+00]
  HOMO = -0.849965275599891  LUMO = 0.431648665338984
  mo_energy =
[-3.27758279e+01 -1.93148724e+00 -8.49965276e-01 -8.49965276e-01
 -8.49965276e-01  4.31648665e-01  4.31648665e-01  4.31648665e-01
  1.18731005e+00  2.06044945e+00  2.06044945e+00  2.06044945e+00
  7.28804089e+00  7.38668252e+00  7.38668252e+00  7.38668252e+00
  2.62736072e+01  2.62736072e+01  2.62736072e+01  3.46147594e+01
  1.20668382e+02  1.20668382e+02  1.20668382e+02  1.38710348e+02
  5.02782887e+02  1.87039518e+03  8.00004130e+03  4.77676798e+04]
E1 = -182.5589915567722  E_coul = 54.02229319781577
cycle= 5 E= -128.536698358956  delta_E= -6.33e-10  |g|= 3.23e-06  |ddm|= 4.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5589915567722  E_coul = 54.02229319781577
  HOMO = -0.849964044752319  LUMO = 0.431648695373294
  mo_energy =
[-3.27758245e+01 -1.93148592e+00 -8.49964045e-01 -8.49964045e-01
 -8.49964045e-01  4.31648695e-01  4.31648695e-01  4.31648695e-01
  1.18731041e+00  2.06044993e+00  2.06044993e+00  2.06044993e+00
  7.28804250e+00  7.38668404e+00  7.38668404e+00  7.38668404e+00
  2.62736100e+01  2.62736100e+01  2.62736100e+01  3.46147623e+01
  1.20668385e+02  1.20668385e+02  1.20668385e+02  1.38710352e+02
  5.02782890e+02  1.87039519e+03  8.00004130e+03  4.77676798e+04]
E1 = -182.55898014866742  E_coul = 54.02228178970927
Extra cycle  E= -128.536698358958  delta_E= -1.71e-12  |g|= 1.51e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271054e+02 2.35734777e+02
 7.64327990e+01 1.00367326e+01 2.70503391e+01 3.81547269e-01
 1.11719306e+00 2.88197686e+00 3.93493932e+00 1.24240840e+01
 5.47858739e+01 1.59687129e-01 1.36748716e+00 4.76716095e-01]
E = -128.53669835895815
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447011        1
[INPUT] 0    0    [1    /1   ]  833.271054365        1
[INPUT] 0    0    [1    /1   ]  235.734777293        1
[INPUT] 0    0    [1    /1   ]  76.4327990133        1
[INPUT] 0    0    [1    /1   ]  10.0367325808        1
[INPUT] 0    0    [1    /1   ]  27.0503391228        1
[INPUT] 0    0    [1    /1   ]  0.381547269189       1
[INPUT] 0    0    [1    /1   ]  1.11719306297        1
[INPUT] 0    0    [1    /1   ]  2.88197686463        1
[INPUT] 1    0    [1    /1   ]  3.93493931662        1
[INPUT] 1    0    [1    /1   ]  12.4240839975        1
[INPUT] 1    0    [1    /1   ]  54.7858739369        1
[INPUT] 1    0    [1    /1   ]  0.159687129194       1
[INPUT] 1    0    [1    /1   ]  1.36748715568        1
[INPUT] 1    0    [1    /1   ]  0.476716094518       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129988408, 1.0]], [0, [3661.454470107339, 1.0]], [0, [833.2710543647421, 1.0]], [0, [235.73477729258383, 1.0]], [0, [76.43279901334469, 1.0]], [0, [10.036732580816317, 1.0]], [0, [27.050339122797013, 1.0]], [0, [0.38154726918913767, 1.0]], [0, [1.1171930629674405, 1.0]], [0, [2.881976864626681, 1.0]], [1, [3.9349393166201283, 1.0]], [1, [12.424083997456712, 1.0]], [1, [54.78587393691935, 1.0]], [1, [0.15968712919412195, 1.0]], [1, [1.3674871556814951, 1.0]], [1, [0.47671609451848757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447011]
bas 2, expnt(s) = [833.27105436]
bas 3, expnt(s) = [235.73477729]
bas 4, expnt(s) = [76.43279901]
bas 5, expnt(s) = [10.03673258]
bas 6, expnt(s) = [27.05033912]
bas 7, expnt(s) = [0.38154727]
bas 8, expnt(s) = [1.11719306]
bas 9, expnt(s) = [2.88197686]
bas 10, expnt(s) = [3.93493932]
bas 11, expnt(s) = [12.424084]
bas 12, expnt(s) = [54.78587394]
bas 13, expnt(s) = [0.15968713]
bas 14, expnt(s) = [1.36748716]
bas 15, expnt(s) = [0.47671609]
CPU time:        37.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271054e+02 3.91836371e+02 2.35734777e+02 1.51996213e+02
 7.64327990e+01 6.53092727e+01 1.00367326e+01 1.42465363e+01
 2.70503391e+01 2.99670891e+01 3.81547269e-01 1.22652467e+00
 1.11719306e+00 2.74543520e+00 2.88197686e+00 5.58834091e+00
 3.93493932e+00 1.61680239e+01 1.24240840e+01 6.80479218e+01
 5.47858739e+01 4.34830636e+02 1.59687129e-01 2.94490836e-01
 1.36748716e+00 4.31408266e+00 4.76716095e-01 1.15560433e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999857060570491
cond(S) = 343.9725834894838
E1 = -183.58362570457382  E_coul = 55.079370510604846
init E= -128.504255193969
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774712767589941  LUMO = 0.439218839256468
  mo_energy =
[-3.25553355e+01 -1.85263058e+00 -7.74712768e-01 -7.74712768e-01
 -7.74712768e-01  4.39218839e-01  4.39218839e-01  4.39218839e-01
  1.21948078e+00  2.09969723e+00  2.09969723e+00  2.09969723e+00
  7.37951053e+00  7.48158893e+00  7.48158893e+00  7.48158893e+00
  2.64357849e+01  2.64357849e+01  2.64357849e+01  3.47832814e+01
  1.20890508e+02  1.20890508e+02  1.20890508e+02  1.38927548e+02
  5.03033667e+02  1.87067692e+03  8.00034967e+03  4.77680061e+04]
E1 = -182.03899441361793  E_coul = 53.50599397246595
cycle= 1 E= -128.533000441152  delta_E= -0.0287  |g|= 0.21  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.532997
diis-c [-0.28408589  1.        ]
  HOMO = -0.886530502028621  LUMO = 0.427930131890684
  mo_energy =
[-3.28866355e+01 -1.97008536e+00 -8.86530502e-01 -8.86530502e-01
 -8.86530502e-01  4.27930132e-01  4.27930132e-01  4.27930132e-01
  1.17217435e+00  2.04179193e+00  2.04179193e+00  2.04179193e+00
  7.24349671e+00  7.34036486e+00  7.34036486e+00  7.34036486e+00
  2.61922673e+01  2.61922673e+01  2.61922673e+01  3.45298202e+01
  1.20557859e+02  1.20557859e+02  1.20557859e+02  1.38601583e+02
  5.02663201e+02  1.87027023e+03  7.99991392e+03  4.77675515e+04]
E1 = -182.82764591864057  E_coul = 54.29193391974641
cycle= 2 E= -128.535711998894  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273776
diis-c [-6.23214998e-04  3.38657256e-01  6.61342744e-01]
  HOMO = -0.849705842149443  LUMO = 0.431665957374566
  mo_energy =
[-3.27754030e+01 -1.93126932e+00 -8.49705842e-01 -8.49705842e-01
 -8.49705842e-01  4.31665957e-01  4.31665957e-01  4.31665957e-01
  1.18740515e+00  2.06056229e+00  2.06056229e+00  2.06056229e+00
  7.28826925e+00  7.38692094e+00  7.38692094e+00  7.38692094e+00
  2.62739498e+01  2.62739498e+01  2.62739498e+01  3.46151033e+01
  1.20668818e+02  1.20668818e+02  1.20668818e+02  1.38710774e+02
  5.02783407e+02  1.87039581e+03  8.00004201e+03  4.77676805e+04]
E1 = -182.55874668945992  E_coul = 54.02204835047481
cycle= 3 E= -128.536698338985  delta_E= -0.000986  |g|= 0.000389  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000792672
diis-c [-1.24832172e-07 -1.92232716e-03 -1.15860285e-03  1.00308093e+00]
  HOMO = -0.849924392103113  LUMO = 0.431655333730429
  mo_energy =
[-3.27757621e+01 -1.93144864e+00 -8.49924392e-01 -8.49924392e-01
 -8.49924392e-01  4.31655334e-01  4.31655334e-01  4.31655334e-01
  1.18733371e+00  2.06047690e+00  2.06047690e+00  2.06047690e+00
  7.28808742e+00  7.38673087e+00  7.38673087e+00  7.38673087e+00
  2.62736683e+01  2.62736683e+01  2.62736683e+01  3.46148208e+01
  1.20668448e+02  1.20668448e+02  1.20668448e+02  1.38710414e+02
  5.02782955e+02  1.87039525e+03  8.00004137e+03  4.77676798e+04]
E1 = -182.55889332678404  E_coul = 54.02219496846073
cycle= 4 E= -128.536698358323  delta_E= -1.93e-08  |g|= 7.06e-05  |ddm|= 0.000247
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000153343
diis-c [-7.14689039e-10  1.26462940e-04  4.63390520e-04 -1.50804262e-01
  1.15021441e+00]
  HOMO = -0.849965275599891  LUMO = 0.431648665338984
  mo_energy =
[-3.27758279e+01 -1.93148724e+00 -8.49965276e-01 -8.49965276e-01
 -8.49965276e-01  4.31648665e-01  4.31648665e-01  4.31648665e-01
  1.18731005e+00  2.06044945e+00  2.06044945e+00  2.06044945e+00
  7.28804089e+00  7.38668252e+00  7.38668252e+00  7.38668252e+00
  2.62736072e+01  2.62736072e+01  2.62736072e+01  3.46147594e+01
  1.20668382e+02  1.20668382e+02  1.20668382e+02  1.38710348e+02
  5.02782887e+02  1.87039518e+03  8.00004130e+03  4.77676798e+04]
E1 = -182.5589915567722  E_coul = 54.02229319781577
cycle= 5 E= -128.536698358956  delta_E= -6.33e-10  |g|= 3.23e-06  |ddm|= 4.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5589915567722  E_coul = 54.02229319781577
  HOMO = -0.849964044752319  LUMO = 0.431648695373294
  mo_energy =
[-3.27758245e+01 -1.93148592e+00 -8.49964045e-01 -8.49964045e-01
 -8.49964045e-01  4.31648695e-01  4.31648695e-01  4.31648695e-01
  1.18731041e+00  2.06044993e+00  2.06044993e+00  2.06044993e+00
  7.28804250e+00  7.38668404e+00  7.38668404e+00  7.38668404e+00
  2.62736100e+01  2.62736100e+01  2.62736100e+01  3.46147623e+01
  1.20668385e+02  1.20668385e+02  1.20668385e+02  1.38710352e+02
  5.02782890e+02  1.87039519e+03  8.00004130e+03  4.77676798e+04]
E1 = -182.55898014866742  E_coul = 54.02228178970927
Extra cycle  E= -128.536698358958  delta_E= -1.71e-12  |g|= 1.51e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9725834894838
E1 = -182.55898014866742  E_coul = 54.02228178970927
init E= -128.536698358958
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.849964875755042  LUMO = 0.431648591709717
  mo_energy =
[-3.27758269e+01 -1.93148681e+00 -8.49964876e-01 -8.49964876e-01
 -8.49964876e-01  4.31648592e-01  4.31648592e-01  4.31648592e-01
  1.18731001e+00  2.06044947e+00  2.06044947e+00  2.06044947e+00
  7.28804149e+00  7.38668299e+00  7.38668299e+00  7.38668299e+00
  2.62736082e+01  2.62736082e+01  2.62736082e+01  3.46147604e+01
  1.20668383e+02  1.20668383e+02  1.20668383e+02  1.38710349e+02
  5.02782887e+02  1.87039518e+03  8.00004130e+03  4.77676798e+04]
E1 = -182.55898535751177  E_coul = 54.02228699855313
cycle= 1 E= -128.536698358959  delta_E= -4.83e-13  |g|= 7.22e-07  |ddm|= 5.97e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55898535751177  E_coul = 54.02228699855313
  HOMO = -0.849964511485121  LUMO = 0.431648625237429
  mo_energy =
[-3.27758257e+01 -1.93148643e+00 -8.49964511e-01 -8.49964511e-01
 -8.49964511e-01  4.31648625e-01  4.31648625e-01  4.31648625e-01
  1.18731015e+00  2.06044965e+00  2.06044965e+00  2.06044965e+00
  7.28804194e+00  7.38668345e+00  7.38668345e+00  7.38668345e+00
  2.62736090e+01  2.62736090e+01  2.62736090e+01  3.46147613e+01
  1.20668384e+02  1.20668384e+02  1.20668384e+02  1.38710350e+02
  5.02782888e+02  1.87039518e+03  8.00004130e+03  4.77676798e+04]
E1 = -182.55898251233262  E_coul = 54.022284153374294
Extra cycle  E= -128.536698358958  delta_E= 3.13e-13  |g|= 3.84e-07  |ddm|= 2.34e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271054e+02 2.35734777e+02
 7.64327990e+01 1.00367326e+01 2.70503391e+01 3.81547269e-01
 1.11719306e+00 2.88197686e+00 3.93493932e+00 1.24240840e+01
 5.47858739e+01 1.59687129e-01 1.36748716e+00 4.76716095e-01]
grad_E = [ 3.81214366e-11 -2.01407053e-09  4.80580631e-08 -7.11107634e-07
  4.53276474e-06  4.82623857e-07  3.76194255e-06  7.21274525e-06
  3.99229836e-06  8.74651075e-07  1.23335803e-03 -1.59696907e-03
  9.66042724e-05 -1.08242293e-02 -4.27374373e-03  3.24798876e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447017        1
[INPUT] 0    0    [1    /1   ]  833.271052798        1
[INPUT] 0    0    [1    /1   ]  235.734800571        1
[INPUT] 0    0    [1    /1   ]  76.4326509805        1
[INPUT] 0    0    [1    /1   ]  10.0366777563        1
[INPUT] 0    0    [1    /1   ]  27.0502093569        1
[INPUT] 0    0    [1    /1   ]  0.381513956554       1
[INPUT] 0    0    [1    /1   ]  1.11717924778        1
[INPUT] 0    0    [1    /1   ]  2.88178790646        1
[INPUT] 1    0    [1    /1   ]  4.03122853874        1
[INPUT] 1    0    [1    /1   ]  12.4304818174        1
[INPUT] 1    0    [1    /1   ]  54.7850874543        1
[INPUT] 1    0    [1    /1   ]  0.186089661974       1
[INPUT] 1    0    [1    /1   ]  1.45171409483        1
[INPUT] 1    0    [1    /1   ]  0.52599549784        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998717, 1.0]], [0, [3661.4544701727878, 1.0]], [0, [833.2710527979111, 1.0]], [0, [235.73480057064324, 1.0]], [0, [76.43265098053831, 1.0]], [0, [10.036677756330656, 1.0]], [0, [27.050209356893113, 1.0]], [0, [0.381513956554467, 1.0]], [0, [1.117179247783436, 1.0]], [0, [2.881787906463936, 1.0]], [1, [4.031228538736318, 1.0]], [1, [12.430481817432277, 1.0]], [1, [54.78508745433765, 1.0]], [1, [0.18608966197366805, 1.0]], [1, [1.451714094830148, 1.0]], [1, [0.5259954978400581, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447017]
bas 2, expnt(s) = [833.2710528]
bas 3, expnt(s) = [235.73480057]
bas 4, expnt(s) = [76.43265098]
bas 5, expnt(s) = [10.03667776]
bas 6, expnt(s) = [27.05020936]
bas 7, expnt(s) = [0.38151396]
bas 8, expnt(s) = [1.11717925]
bas 9, expnt(s) = [2.88178791]
bas 10, expnt(s) = [4.03122854]
bas 11, expnt(s) = [12.43048182]
bas 12, expnt(s) = [54.78508745]
bas 13, expnt(s) = [0.18608966]
bas 14, expnt(s) = [1.45171409]
bas 15, expnt(s) = [0.5259955]
CPU time:        39.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271053e+02 3.91836371e+02 2.35734801e+02 1.51996224e+02
 7.64326510e+01 6.53091778e+01 1.00366778e+01 1.42464779e+01
 2.70502094e+01 2.99669813e+01 3.81513957e-01 1.22644435e+00
 1.11717925e+00 2.74540973e+00 2.88178791e+00 5.58806611e+00
 4.03122854e+00 1.66640733e+01 1.24304818e+01 6.80917265e+01
 5.47850875e+01 4.34822833e+02 1.86089662e-01 3.56563760e-01
 1.45171409e+00 4.64874538e+00 5.25995498e-01 1.30680843e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999883917167285
cond(S) = 343.95412530901257
E1 = -183.5840019479404  E_coul = 55.0794793578785
init E= -128.504522590062
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774737397177528  LUMO = 0.51619009982287
  mo_energy =
[-3.25553498e+01 -1.85261208e+00 -7.74737397e-01 -7.74737397e-01
 -7.74737397e-01  5.16190100e-01  5.16190100e-01  5.16190100e-01
  1.21938177e+00  2.35784400e+00  2.35784400e+00  2.35784400e+00
  7.37908284e+00  8.03373806e+00  8.03373806e+00  8.03373806e+00
  2.72419452e+01  2.72419452e+01  2.72419452e+01  3.47822580e+01
  1.21597391e+02  1.21597391e+02  1.21597391e+02  1.38926026e+02
  5.03031785e+02  1.87067504e+03  8.00034798e+03  4.77680047e+04]
E1 = -182.04149955652287  E_coul = 53.50823264837314
cycle= 1 E= -128.53326690815  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.541915
diis-c [-0.29367136  1.        ]
  HOMO = -0.886386293596074  LUMO = 0.502139845338146
  mo_energy =
[-3.28862859e+01 -1.96987376e+00 -8.86386294e-01 -8.86386294e-01
 -8.86386294e-01  5.02139845e-01  5.02139845e-01  5.02139845e-01
  1.17219416e+00  2.29542220e+00  2.29542220e+00  2.29542220e+00
  7.24328392e+00  7.89039414e+00  7.89039414e+00  7.89039414e+00
  2.69991190e+01  2.69991190e+01  2.69991190e+01  3.45291106e+01
  1.21265379e+02  1.21265379e+02  1.21265379e+02  1.38600413e+02
  5.02661653e+02  1.87026866e+03  7.99991254e+03  4.77675504e+04]
E1 = -182.82859288801328  E_coul = 54.29261995650048
cycle= 2 E= -128.535972931513  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0629
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27813
diis-c [-6.20231299e-04  3.38500012e-01  6.61499988e-01]
  HOMO = -0.849631257492056  LUMO = 0.506779685338818
  mo_energy =
[-3.27752218e+01 -1.93113400e+00 -8.49631257e-01 -8.49631257e-01
 -8.49631257e-01  5.06779685e-01  5.06779685e-01  5.06779685e-01
  1.18738461e+00  2.31565690e+00  2.31565690e+00  2.31565690e+00
  7.28796889e+00  7.93765831e+00  7.93765831e+00  7.93765831e+00
  2.70805349e+01  2.70805349e+01  2.70805349e+01  3.46142566e+01
  1.21376078e+02  1.21376078e+02  1.21376078e+02  1.38709437e+02
  5.02781683e+02  1.87039406e+03  8.00004044e+03  4.77676792e+04]
E1 = -182.56040517567985  E_coul = 54.02344977110819
cycle= 3 E= -128.536955404572  delta_E= -0.000982  |g|= 0.00038  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000799538
diis-c [-1.05424721e-07 -1.89866789e-03 -1.07854760e-03  1.00297722e+00]
  HOMO = -0.849843705517747  LUMO = 0.506768348025701
  mo_energy =
[-3.27755709e+01 -1.93130548e+00 -8.49843706e-01 -8.49843706e-01
 -8.49843706e-01  5.06768348e-01  5.06768348e-01  5.06768348e-01
  1.18731878e+00  2.31556906e+00  2.31556906e+00  2.31556906e+00
  7.28779487e+00  7.93747304e+00  7.93747304e+00  7.93747304e+00
  2.70802624e+01  2.70802624e+01  2.70802624e+01  3.46139831e+01
  1.21375718e+02  1.21375718e+02  1.21375718e+02  1.38709088e+02
  5.02781241e+02  1.87039352e+03  8.00003982e+03  4.77676786e+04]
E1 = -182.56056541095512  E_coul = 54.02360999005823
cycle= 4 E= -128.536955420897  delta_E= -1.63e-08  |g|= 6.92e-05  |ddm|= 0.000232
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000159709
diis-c [-6.68409229e-10  1.09613743e-04  4.74772792e-04 -1.39718247e-01
  1.13913386e+00]
  HOMO = -0.849882903125615  LUMO = 0.506761002174434
  mo_energy =
[-3.27756356e+01 -1.93134175e+00 -8.49882903e-01 -8.49882903e-01
 -8.49882903e-01  5.06761002e-01  5.06761002e-01  5.06761002e-01
  1.18729706e+00  2.31554178e+00  2.31554178e+00  2.31554178e+00
  7.28775060e+00  7.93742639e+00  7.93742639e+00  7.93742639e+00
  2.70802031e+01  2.70802031e+01  2.70802031e+01  3.46139234e+01
  1.21375654e+02  1.21375654e+02  1.21375654e+02  1.38709023e+02
  5.02781173e+02  1.87039345e+03  8.00003975e+03  4.77676785e+04]
E1 = -182.5606715503279  E_coul = 54.02371612890908
cycle= 5 E= -128.536955421419  delta_E= -5.22e-10  |g|= 2.66e-06  |ddm|= 3.84e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5606715503279  E_coul = 54.02371612890908
  HOMO = -0.849881979809914  LUMO = 0.506761042570048
  mo_energy =
[-3.27756331e+01 -1.93134060e+00 -8.49881980e-01 -8.49881980e-01
 -8.49881980e-01  5.06761043e-01  5.06761043e-01  5.06761043e-01
  1.18729740e+00  2.31554218e+00  2.31554218e+00  2.31554218e+00
  7.28775190e+00  7.93742758e+00  7.93742758e+00  7.93742758e+00
  2.70802052e+01  2.70802052e+01  2.70802052e+01  3.46139256e+01
  1.21375656e+02  1.21375656e+02  1.21375656e+02  1.38709026e+02
  5.02781175e+02  1.87039345e+03  8.00003975e+03  4.77676785e+04]
E1 = -182.56066287472444  E_coul = 54.023707453304425
Extra cycle  E= -128.53695542142  delta_E= -1.22e-12  |g|= 1.14e-06  |ddm|= 1.7e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271053e+02 2.35734801e+02
 7.64326510e+01 1.00366778e+01 2.70502094e+01 3.81513957e-01
 1.11717925e+00 2.88178791e+00 4.03122854e+00 1.24304818e+01
 5.47850875e+01 1.86089662e-01 1.45171409e+00 5.25995498e-01]
E = -128.53695542142003
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447017        1
[INPUT] 0    0    [1    /1   ]  833.271052798        1
[INPUT] 0    0    [1    /1   ]  235.734800571        1
[INPUT] 0    0    [1    /1   ]  76.4326509805        1
[INPUT] 0    0    [1    /1   ]  10.0366777563        1
[INPUT] 0    0    [1    /1   ]  27.0502093569        1
[INPUT] 0    0    [1    /1   ]  0.381513956554       1
[INPUT] 0    0    [1    /1   ]  1.11717924778        1
[INPUT] 0    0    [1    /1   ]  2.88178790646        1
[INPUT] 1    0    [1    /1   ]  4.03122853874        1
[INPUT] 1    0    [1    /1   ]  12.4304818174        1
[INPUT] 1    0    [1    /1   ]  54.7850874543        1
[INPUT] 1    0    [1    /1   ]  0.186089661974       1
[INPUT] 1    0    [1    /1   ]  1.45171409483        1
[INPUT] 1    0    [1    /1   ]  0.52599549784        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998717, 1.0]], [0, [3661.4544701727878, 1.0]], [0, [833.2710527979111, 1.0]], [0, [235.73480057064324, 1.0]], [0, [76.43265098053831, 1.0]], [0, [10.036677756330656, 1.0]], [0, [27.050209356893113, 1.0]], [0, [0.381513956554467, 1.0]], [0, [1.117179247783436, 1.0]], [0, [2.881787906463936, 1.0]], [1, [4.031228538736318, 1.0]], [1, [12.430481817432277, 1.0]], [1, [54.78508745433765, 1.0]], [1, [0.18608966197366805, 1.0]], [1, [1.451714094830148, 1.0]], [1, [0.5259954978400581, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447017]
bas 2, expnt(s) = [833.2710528]
bas 3, expnt(s) = [235.73480057]
bas 4, expnt(s) = [76.43265098]
bas 5, expnt(s) = [10.03667776]
bas 6, expnt(s) = [27.05020936]
bas 7, expnt(s) = [0.38151396]
bas 8, expnt(s) = [1.11717925]
bas 9, expnt(s) = [2.88178791]
bas 10, expnt(s) = [4.03122854]
bas 11, expnt(s) = [12.43048182]
bas 12, expnt(s) = [54.78508745]
bas 13, expnt(s) = [0.18608966]
bas 14, expnt(s) = [1.45171409]
bas 15, expnt(s) = [0.5259955]
CPU time:        40.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271053e+02 3.91836371e+02 2.35734801e+02 1.51996224e+02
 7.64326510e+01 6.53091778e+01 1.00366778e+01 1.42464779e+01
 2.70502094e+01 2.99669813e+01 3.81513957e-01 1.22644435e+00
 1.11717925e+00 2.74540973e+00 2.88178791e+00 5.58806611e+00
 4.03122854e+00 1.66640733e+01 1.24304818e+01 6.80917265e+01
 5.47850875e+01 4.34822833e+02 1.86089662e-01 3.56563760e-01
 1.45171409e+00 4.64874538e+00 5.25995498e-01 1.30680843e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999883917167285
cond(S) = 343.95412530901257
E1 = -183.5840019479404  E_coul = 55.0794793578785
init E= -128.504522590062
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774737397177528  LUMO = 0.51619009982287
  mo_energy =
[-3.25553498e+01 -1.85261208e+00 -7.74737397e-01 -7.74737397e-01
 -7.74737397e-01  5.16190100e-01  5.16190100e-01  5.16190100e-01
  1.21938177e+00  2.35784400e+00  2.35784400e+00  2.35784400e+00
  7.37908284e+00  8.03373806e+00  8.03373806e+00  8.03373806e+00
  2.72419452e+01  2.72419452e+01  2.72419452e+01  3.47822580e+01
  1.21597391e+02  1.21597391e+02  1.21597391e+02  1.38926026e+02
  5.03031785e+02  1.87067504e+03  8.00034798e+03  4.77680047e+04]
E1 = -182.04149955652287  E_coul = 53.50823264837314
cycle= 1 E= -128.53326690815  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.541915
diis-c [-0.29367136  1.        ]
  HOMO = -0.886386293596074  LUMO = 0.502139845338146
  mo_energy =
[-3.28862859e+01 -1.96987376e+00 -8.86386294e-01 -8.86386294e-01
 -8.86386294e-01  5.02139845e-01  5.02139845e-01  5.02139845e-01
  1.17219416e+00  2.29542220e+00  2.29542220e+00  2.29542220e+00
  7.24328392e+00  7.89039414e+00  7.89039414e+00  7.89039414e+00
  2.69991190e+01  2.69991190e+01  2.69991190e+01  3.45291106e+01
  1.21265379e+02  1.21265379e+02  1.21265379e+02  1.38600413e+02
  5.02661653e+02  1.87026866e+03  7.99991254e+03  4.77675504e+04]
E1 = -182.82859288801328  E_coul = 54.29261995650048
cycle= 2 E= -128.535972931513  delta_E= -0.00271  |g|= 0.107  |ddm|= 0.0629
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27813
diis-c [-6.20231299e-04  3.38500012e-01  6.61499988e-01]
  HOMO = -0.849631257492056  LUMO = 0.506779685338818
  mo_energy =
[-3.27752218e+01 -1.93113400e+00 -8.49631257e-01 -8.49631257e-01
 -8.49631257e-01  5.06779685e-01  5.06779685e-01  5.06779685e-01
  1.18738461e+00  2.31565690e+00  2.31565690e+00  2.31565690e+00
  7.28796889e+00  7.93765831e+00  7.93765831e+00  7.93765831e+00
  2.70805349e+01  2.70805349e+01  2.70805349e+01  3.46142566e+01
  1.21376078e+02  1.21376078e+02  1.21376078e+02  1.38709437e+02
  5.02781683e+02  1.87039406e+03  8.00004044e+03  4.77676792e+04]
E1 = -182.56040517567985  E_coul = 54.02344977110819
cycle= 3 E= -128.536955404572  delta_E= -0.000982  |g|= 0.00038  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000799538
diis-c [-1.05424721e-07 -1.89866789e-03 -1.07854760e-03  1.00297722e+00]
  HOMO = -0.849843705517747  LUMO = 0.506768348025701
  mo_energy =
[-3.27755709e+01 -1.93130548e+00 -8.49843706e-01 -8.49843706e-01
 -8.49843706e-01  5.06768348e-01  5.06768348e-01  5.06768348e-01
  1.18731878e+00  2.31556906e+00  2.31556906e+00  2.31556906e+00
  7.28779487e+00  7.93747304e+00  7.93747304e+00  7.93747304e+00
  2.70802624e+01  2.70802624e+01  2.70802624e+01  3.46139831e+01
  1.21375718e+02  1.21375718e+02  1.21375718e+02  1.38709088e+02
  5.02781241e+02  1.87039352e+03  8.00003982e+03  4.77676786e+04]
E1 = -182.56056541095512  E_coul = 54.02360999005823
cycle= 4 E= -128.536955420897  delta_E= -1.63e-08  |g|= 6.92e-05  |ddm|= 0.000232
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000159709
diis-c [-6.68409229e-10  1.09613743e-04  4.74772792e-04 -1.39718247e-01
  1.13913386e+00]
  HOMO = -0.849882903125615  LUMO = 0.506761002174434
  mo_energy =
[-3.27756356e+01 -1.93134175e+00 -8.49882903e-01 -8.49882903e-01
 -8.49882903e-01  5.06761002e-01  5.06761002e-01  5.06761002e-01
  1.18729706e+00  2.31554178e+00  2.31554178e+00  2.31554178e+00
  7.28775060e+00  7.93742639e+00  7.93742639e+00  7.93742639e+00
  2.70802031e+01  2.70802031e+01  2.70802031e+01  3.46139234e+01
  1.21375654e+02  1.21375654e+02  1.21375654e+02  1.38709023e+02
  5.02781173e+02  1.87039345e+03  8.00003975e+03  4.77676785e+04]
E1 = -182.5606715503279  E_coul = 54.02371612890908
cycle= 5 E= -128.536955421419  delta_E= -5.22e-10  |g|= 2.66e-06  |ddm|= 3.84e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5606715503279  E_coul = 54.02371612890908
  HOMO = -0.849881979809914  LUMO = 0.506761042570048
  mo_energy =
[-3.27756331e+01 -1.93134060e+00 -8.49881980e-01 -8.49881980e-01
 -8.49881980e-01  5.06761043e-01  5.06761043e-01  5.06761043e-01
  1.18729740e+00  2.31554218e+00  2.31554218e+00  2.31554218e+00
  7.28775190e+00  7.93742758e+00  7.93742758e+00  7.93742758e+00
  2.70802052e+01  2.70802052e+01  2.70802052e+01  3.46139256e+01
  1.21375656e+02  1.21375656e+02  1.21375656e+02  1.38709026e+02
  5.02781175e+02  1.87039345e+03  8.00003975e+03  4.77676785e+04]
E1 = -182.56066287472444  E_coul = 54.023707453304425
Extra cycle  E= -128.53695542142  delta_E= -1.22e-12  |g|= 1.14e-06  |ddm|= 1.7e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.95412530901257
E1 = -182.56066287472444  E_coul = 54.023707453304425
init E= -128.53695542142
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.849882618165253  LUMO = 0.506760947395842
  mo_energy =
[-3.27756349e+01 -1.93134125e+00 -8.49882618e-01 -8.49882618e-01
 -8.49882618e-01  5.06760947e-01  5.06760947e-01  5.06760947e-01
  1.18729712e+00  2.31554181e+00  2.31554181e+00  2.31554181e+00
  7.28775115e+00  7.93742676e+00  7.93742676e+00  7.93742676e+00
  2.70802038e+01  2.70802038e+01  2.70802038e+01  3.46139242e+01
  1.21375654e+02  1.21375654e+02  1.21375654e+02  1.38709024e+02
  5.02781174e+02  1.87039345e+03  8.00003975e+03  4.77676785e+04]
E1 = -182.56066689286848  E_coul = 54.023711471448664
cycle= 1 E= -128.53695542142  delta_E= 2.27e-13  |g|= 5.58e-07  |ddm|= 3.93e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.56066689286848  E_coul = 54.023711471448664
  HOMO = -0.849882338145744  LUMO = 0.506760980423564
  mo_energy =
[-3.27756340e+01 -1.93134096e+00 -8.49882338e-01 -8.49882338e-01
 -8.49882338e-01  5.06760980e-01  5.06760980e-01  5.06760980e-01
  1.18729723e+00  2.31554196e+00  2.31554196e+00  2.31554196e+00
  7.28775149e+00  7.93742713e+00  7.93742713e+00  7.93742713e+00
  2.70802045e+01  2.70802045e+01  2.70802045e+01  3.46139249e+01
  1.21375655e+02  1.21375655e+02  1.21375655e+02  1.38709025e+02
  5.02781174e+02  1.87039345e+03  8.00003975e+03  4.77676785e+04]
E1 = -182.56066472372052  E_coul = 54.02370930230045
Extra cycle  E= -128.53695542142  delta_E= -2.56e-13  |g|= 2.93e-07  |ddm|= 1.83e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.43 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271053e+02 2.35734801e+02
 7.64326510e+01 1.00366778e+01 2.70502094e+01 3.81513957e-01
 1.11717925e+00 2.88178791e+00 4.03122854e+00 1.24304818e+01
 5.47850875e+01 1.86089662e-01 1.45171409e+00 5.25995498e-01]
grad_E = [ 3.84750332e-11 -2.03284254e-09  4.84659687e-08 -7.16687980e-07
  4.58085845e-06  6.78371813e-07  3.59806295e-06  1.70991882e-05
 -6.01868000e-06  1.96991456e-06  1.29040509e-03 -1.94247695e-03
  1.20194237e-04 -3.65356434e-03 -2.17144655e-03  6.00261687e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447021        1
[INPUT] 0    0    [1    /1   ]  833.271051923        1
[INPUT] 0    0    [1    /1   ]  235.734813554        1
[INPUT] 0    0    [1    /1   ]  76.4325683811        1
[INPUT] 0    0    [1    /1   ]  10.0366521521        1
[INPUT] 0    0    [1    /1   ]  27.050137508         1
[INPUT] 0    0    [1    /1   ]  0.381479008554       1
[INPUT] 0    0    [1    /1   ]  1.11715312881        1
[INPUT] 0    0    [1    /1   ]  2.88170251691        1
[INPUT] 1    0    [1    /1   ]  4.06988676882        1
[INPUT] 1    0    [1    /1   ]  12.4390152086        1
[INPUT] 1    0    [1    /1   ]  54.7843953609        1
[INPUT] 1    0    [1    /1   ]  0.203312240116       1
[INPUT] 1    0    [1    /1   ]  1.50045593235        1
[INPUT] 1    0    [1    /1   ]  0.558913706884       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998648, 1.0]], [0, [3661.454470209341, 1.0]], [0, [833.2710519233452, 1.0]], [0, [235.73481355437275, 1.0]], [0, [76.43256838111604, 1.0]], [0, [10.036652152084265, 1.0]], [0, [27.050137508006006, 1.0]], [0, [0.3814790085537844, 1.0]], [0, [1.1171531288094623, 1.0]], [0, [2.8817025169051385, 1.0]], [1, [4.069886768821324, 1.0]], [1, [12.439015208621086, 1.0]], [1, [54.784395360900156, 1.0]], [1, [0.20331224011629173, 1.0]], [1, [1.5004559323462374, 1.0]], [1, [0.5589137068835739, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447021]
bas 2, expnt(s) = [833.27105192]
bas 3, expnt(s) = [235.73481355]
bas 4, expnt(s) = [76.43256838]
bas 5, expnt(s) = [10.03665215]
bas 6, expnt(s) = [27.05013751]
bas 7, expnt(s) = [0.38147901]
bas 8, expnt(s) = [1.11715313]
bas 9, expnt(s) = [2.88170252]
bas 10, expnt(s) = [4.06988677]
bas 11, expnt(s) = [12.43901521]
bas 12, expnt(s) = [54.78439536]
bas 13, expnt(s) = [0.20331224]
bas 14, expnt(s) = [1.50045593]
bas 15, expnt(s) = [0.55891371]
CPU time:        43.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271052e+02 3.91836371e+02 2.35734814e+02 1.51996230e+02
 7.64325684e+01 6.53091249e+01 1.00366522e+01 1.42464507e+01
 2.70501375e+01 2.99669216e+01 3.81479009e-01 1.22636009e+00
 1.11715313e+00 2.74536159e+00 2.88170252e+00 5.58794192e+00
 4.06988677e+00 1.68640663e+01 1.24390152e+01 6.81501618e+01
 5.47843954e+01 4.34815967e+02 2.03312240e-01 3.98280276e-01
 1.50045593e+00 4.84466162e+00 5.58913707e-01 1.40982544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99987368291025
cond(S) = 343.93649052443175
E1 = -183.58418078823482  E_coul = 55.07954462848143
init E= -128.504636159753
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774740469028215  LUMO = 0.566990139865976
  mo_energy =
[-3.25553403e+01 -1.85260373e+00 -7.74740469e-01 -7.74740469e-01
 -7.74740469e-01  5.66990140e-01  5.66990140e-01  5.66990140e-01
  1.21926430e+00  2.52454176e+00  2.52454176e+00  2.52454176e+00
  7.37875241e+00  8.36308525e+00  8.36308525e+00  8.36308525e+00
  2.76884896e+01  2.76884896e+01  2.76884896e+01  3.47815919e+01
  1.21987847e+02  1.21987847e+02  1.21987847e+02  1.38925149e+02
  5.03030717e+02  1.87067395e+03  8.00034700e+03  4.77680039e+04]
E1 = -182.04576582342497  E_coul = 53.51241484896503
cycle= 1 E= -128.53335097446  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545849
diis-c [-0.29795137  1.        ]
  HOMO = -0.88605116247017  LUMO = 0.551169447778036
  mo_energy =
[-3.28856218e+01 -1.96947960e+00 -8.86051162e-01 -8.86051162e-01
 -8.86051162e-01  5.51169448e-01  5.51169448e-01  5.51169448e-01
  1.17231285e+00  2.45965211e+00  2.45965211e+00  2.45965211e+00
  7.24337929e+00  8.21916523e+00  8.21916523e+00  8.21916523e+00
  2.74465344e+01  2.74465344e+01  2.74465344e+01  3.45290469e+01
  1.21656635e+02  1.21656635e+02  1.21656635e+02  1.38600185e+02
  5.02661255e+02  1.87026827e+03  7.99991225e+03  4.77675503e+04]
E1 = -182.83011825809652  E_coul = 54.29407155929442
cycle= 2 E= -128.536046698802  delta_E= -0.0027  |g|= 0.107  |ddm|= 0.0624
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279774
diis-c [-6.18764556e-04  3.38208207e-01  6.61791793e-01]
  HOMO = -0.8494154162976  LUMO = 0.556397186877075
  mo_energy =
[-3.27748631e+01 -1.93086925e+00 -8.49415416e-01 -8.49415416e-01
 -8.49415416e-01  5.56397187e-01  5.56397187e-01  5.56397187e-01
  1.18744109e+00  2.48069852e+00  2.48069852e+00  2.48069852e+00
  7.28791661e+00  8.26662010e+00  8.26662010e+00  8.26662010e+00
  2.75276083e+01  2.75276083e+01  2.75276083e+01  3.46139469e+01
  1.21766980e+02  1.21766980e+02  1.21766980e+02  1.38708910e+02
  5.02780962e+02  1.87039333e+03  8.00003982e+03  4.77676788e+04]
E1 = -182.56317794784314  E_coul = 54.02615598786983
cycle= 3 E= -128.537021959973  delta_E= -0.000975  |g|= 0.000369  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000797021
diis-c [-9.20739548e-08 -1.87430275e-03 -1.02782034e-03  1.00290212e+00]
  HOMO = -0.84961946593275  LUMO = 0.556387218086192
  mo_energy =
[-3.27752001e+01 -1.93102934e+00 -8.49619466e-01 -8.49619466e-01
 -8.49619466e-01  5.56387218e-01  5.56387218e-01  5.56387218e-01
  1.18738366e+00  2.48061390e+00  2.48061390e+00  2.48061390e+00
  7.28775325e+00  8.26644408e+00  8.26644408e+00  8.26644408e+00
  2.75273476e+01  2.75273476e+01  2.75273476e+01  3.46136853e+01
  1.21766632e+02  1.21766632e+02  1.21766632e+02  1.38708573e+02
  5.02780533e+02  1.87039280e+03  8.00003921e+03  4.77676781e+04]
E1 = -182.56335495549635  E_coul = 54.02633298181938
cycle= 4 E= -128.537021973677  delta_E= -1.37e-08  |g|= 6.68e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000162112
diis-c [-6.74659077e-10  1.04996434e-04  4.86217771e-04 -1.34355106e-01
  1.13376389e+00]
  HOMO = -0.849656523342481  LUMO = 0.556379862321464
  mo_energy =
[-3.27752626e+01 -1.93106245e+00 -8.49656523e-01 -8.49656523e-01
 -8.49656523e-01  5.56379862e-01  5.56379862e-01  5.56379862e-01
  1.18736438e+00  2.48058785e+00  2.48058785e+00  2.48058785e+00
  7.28771191e+00  8.26640002e+00  8.26640002e+00  8.26640002e+00
  2.75272909e+01  2.75272909e+01  2.75272909e+01  3.46136283e+01
  1.21766570e+02  1.21766570e+02  1.21766570e+02  1.38708511e+02
  5.02780467e+02  1.87039273e+03  8.00003913e+03  4.77676781e+04]
E1 = -182.56346608925665  E_coul = 54.026444115132975
cycle= 5 E= -128.537021974124  delta_E= -4.47e-10  |g|= 2.53e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56346608925665  E_coul = 54.026444115132975
  HOMO = -0.849655707278799  LUMO = 0.556379929814526
  mo_energy =
[-3.27752606e+01 -1.93106126e+00 -8.49655707e-01 -8.49655707e-01
 -8.49655707e-01  5.56379930e-01  5.56379930e-01  5.56379930e-01
  1.18736481e+00  2.48058828e+00  2.48058828e+00  2.48058828e+00
  7.28771317e+00  8.26640111e+00  8.26640111e+00  8.26640111e+00
  2.75272927e+01  2.75272927e+01  2.75272927e+01  3.46136302e+01
  1.21766572e+02  1.21766572e+02  1.21766572e+02  1.38708513e+02
  5.02780468e+02  1.87039273e+03  8.00003913e+03  4.77676781e+04]
E1 = -182.56345917552287  E_coul = 54.02643720139856
Extra cycle  E= -128.537021974124  delta_E= -6.54e-13  |g|= 9.22e-07  |ddm|= 1.38e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271052e+02 2.35734814e+02
 7.64325684e+01 1.00366522e+01 2.70501375e+01 3.81479009e-01
 1.11715313e+00 2.88170252e+00 4.06988677e+00 1.24390152e+01
 5.47843954e+01 2.03312240e-01 1.50045593e+00 5.58913707e-01]
E = -128.53702197412431
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447021        1
[INPUT] 0    0    [1    /1   ]  833.271051923        1
[INPUT] 0    0    [1    /1   ]  235.734813554        1
[INPUT] 0    0    [1    /1   ]  76.4325683811        1
[INPUT] 0    0    [1    /1   ]  10.0366521521        1
[INPUT] 0    0    [1    /1   ]  27.050137508         1
[INPUT] 0    0    [1    /1   ]  0.381479008554       1
[INPUT] 0    0    [1    /1   ]  1.11715312881        1
[INPUT] 0    0    [1    /1   ]  2.88170251691        1
[INPUT] 1    0    [1    /1   ]  4.06988676882        1
[INPUT] 1    0    [1    /1   ]  12.4390152086        1
[INPUT] 1    0    [1    /1   ]  54.7843953609        1
[INPUT] 1    0    [1    /1   ]  0.203312240116       1
[INPUT] 1    0    [1    /1   ]  1.50045593235        1
[INPUT] 1    0    [1    /1   ]  0.558913706884       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412998648, 1.0]], [0, [3661.454470209341, 1.0]], [0, [833.2710519233452, 1.0]], [0, [235.73481355437275, 1.0]], [0, [76.43256838111604, 1.0]], [0, [10.036652152084265, 1.0]], [0, [27.050137508006006, 1.0]], [0, [0.3814790085537844, 1.0]], [0, [1.1171531288094623, 1.0]], [0, [2.8817025169051385, 1.0]], [1, [4.069886768821324, 1.0]], [1, [12.439015208621086, 1.0]], [1, [54.784395360900156, 1.0]], [1, [0.20331224011629173, 1.0]], [1, [1.5004559323462374, 1.0]], [1, [0.5589137068835739, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447021]
bas 2, expnt(s) = [833.27105192]
bas 3, expnt(s) = [235.73481355]
bas 4, expnt(s) = [76.43256838]
bas 5, expnt(s) = [10.03665215]
bas 6, expnt(s) = [27.05013751]
bas 7, expnt(s) = [0.38147901]
bas 8, expnt(s) = [1.11715313]
bas 9, expnt(s) = [2.88170252]
bas 10, expnt(s) = [4.06988677]
bas 11, expnt(s) = [12.43901521]
bas 12, expnt(s) = [54.78439536]
bas 13, expnt(s) = [0.20331224]
bas 14, expnt(s) = [1.50045593]
bas 15, expnt(s) = [0.55891371]
CPU time:        43.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271052e+02 3.91836371e+02 2.35734814e+02 1.51996230e+02
 7.64325684e+01 6.53091249e+01 1.00366522e+01 1.42464507e+01
 2.70501375e+01 2.99669216e+01 3.81479009e-01 1.22636009e+00
 1.11715313e+00 2.74536159e+00 2.88170252e+00 5.58794192e+00
 4.06988677e+00 1.68640663e+01 1.24390152e+01 6.81501618e+01
 5.47843954e+01 4.34815967e+02 2.03312240e-01 3.98280276e-01
 1.50045593e+00 4.84466162e+00 5.58913707e-01 1.40982544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99987368291025
cond(S) = 343.93649052443175
E1 = -183.58418078823482  E_coul = 55.07954462848143
init E= -128.504636159753
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774740469028215  LUMO = 0.566990139865976
  mo_energy =
[-3.25553403e+01 -1.85260373e+00 -7.74740469e-01 -7.74740469e-01
 -7.74740469e-01  5.66990140e-01  5.66990140e-01  5.66990140e-01
  1.21926430e+00  2.52454176e+00  2.52454176e+00  2.52454176e+00
  7.37875241e+00  8.36308525e+00  8.36308525e+00  8.36308525e+00
  2.76884896e+01  2.76884896e+01  2.76884896e+01  3.47815919e+01
  1.21987847e+02  1.21987847e+02  1.21987847e+02  1.38925149e+02
  5.03030717e+02  1.87067395e+03  8.00034700e+03  4.77680039e+04]
E1 = -182.04576582342497  E_coul = 53.51241484896503
cycle= 1 E= -128.53335097446  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545849
diis-c [-0.29795137  1.        ]
  HOMO = -0.88605116247017  LUMO = 0.551169447778036
  mo_energy =
[-3.28856218e+01 -1.96947960e+00 -8.86051162e-01 -8.86051162e-01
 -8.86051162e-01  5.51169448e-01  5.51169448e-01  5.51169448e-01
  1.17231285e+00  2.45965211e+00  2.45965211e+00  2.45965211e+00
  7.24337929e+00  8.21916523e+00  8.21916523e+00  8.21916523e+00
  2.74465344e+01  2.74465344e+01  2.74465344e+01  3.45290469e+01
  1.21656635e+02  1.21656635e+02  1.21656635e+02  1.38600185e+02
  5.02661255e+02  1.87026827e+03  7.99991225e+03  4.77675503e+04]
E1 = -182.83011825809652  E_coul = 54.29407155929442
cycle= 2 E= -128.536046698802  delta_E= -0.0027  |g|= 0.107  |ddm|= 0.0624
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279774
diis-c [-6.18764556e-04  3.38208207e-01  6.61791793e-01]
  HOMO = -0.8494154162976  LUMO = 0.556397186877075
  mo_energy =
[-3.27748631e+01 -1.93086925e+00 -8.49415416e-01 -8.49415416e-01
 -8.49415416e-01  5.56397187e-01  5.56397187e-01  5.56397187e-01
  1.18744109e+00  2.48069852e+00  2.48069852e+00  2.48069852e+00
  7.28791661e+00  8.26662010e+00  8.26662010e+00  8.26662010e+00
  2.75276083e+01  2.75276083e+01  2.75276083e+01  3.46139469e+01
  1.21766980e+02  1.21766980e+02  1.21766980e+02  1.38708910e+02
  5.02780962e+02  1.87039333e+03  8.00003982e+03  4.77676788e+04]
E1 = -182.56317794784314  E_coul = 54.02615598786983
cycle= 3 E= -128.537021959973  delta_E= -0.000975  |g|= 0.000369  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000797021
diis-c [-9.20739548e-08 -1.87430275e-03 -1.02782034e-03  1.00290212e+00]
  HOMO = -0.84961946593275  LUMO = 0.556387218086192
  mo_energy =
[-3.27752001e+01 -1.93102934e+00 -8.49619466e-01 -8.49619466e-01
 -8.49619466e-01  5.56387218e-01  5.56387218e-01  5.56387218e-01
  1.18738366e+00  2.48061390e+00  2.48061390e+00  2.48061390e+00
  7.28775325e+00  8.26644408e+00  8.26644408e+00  8.26644408e+00
  2.75273476e+01  2.75273476e+01  2.75273476e+01  3.46136853e+01
  1.21766632e+02  1.21766632e+02  1.21766632e+02  1.38708573e+02
  5.02780533e+02  1.87039280e+03  8.00003921e+03  4.77676781e+04]
E1 = -182.56335495549635  E_coul = 54.02633298181938
cycle= 4 E= -128.537021973677  delta_E= -1.37e-08  |g|= 6.68e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000162112
diis-c [-6.74659077e-10  1.04996434e-04  4.86217771e-04 -1.34355106e-01
  1.13376389e+00]
  HOMO = -0.849656523342481  LUMO = 0.556379862321464
  mo_energy =
[-3.27752626e+01 -1.93106245e+00 -8.49656523e-01 -8.49656523e-01
 -8.49656523e-01  5.56379862e-01  5.56379862e-01  5.56379862e-01
  1.18736438e+00  2.48058785e+00  2.48058785e+00  2.48058785e+00
  7.28771191e+00  8.26640002e+00  8.26640002e+00  8.26640002e+00
  2.75272909e+01  2.75272909e+01  2.75272909e+01  3.46136283e+01
  1.21766570e+02  1.21766570e+02  1.21766570e+02  1.38708511e+02
  5.02780467e+02  1.87039273e+03  8.00003913e+03  4.77676781e+04]
E1 = -182.56346608925665  E_coul = 54.026444115132975
cycle= 5 E= -128.537021974124  delta_E= -4.47e-10  |g|= 2.53e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56346608925665  E_coul = 54.026444115132975
  HOMO = -0.849655707278799  LUMO = 0.556379929814526
  mo_energy =
[-3.27752606e+01 -1.93106126e+00 -8.49655707e-01 -8.49655707e-01
 -8.49655707e-01  5.56379930e-01  5.56379930e-01  5.56379930e-01
  1.18736481e+00  2.48058828e+00  2.48058828e+00  2.48058828e+00
  7.28771317e+00  8.26640111e+00  8.26640111e+00  8.26640111e+00
  2.75272927e+01  2.75272927e+01  2.75272927e+01  3.46136302e+01
  1.21766572e+02  1.21766572e+02  1.21766572e+02  1.38708513e+02
  5.02780468e+02  1.87039273e+03  8.00003913e+03  4.77676781e+04]
E1 = -182.56345917552287  E_coul = 54.02643720139856
Extra cycle  E= -128.537021974124  delta_E= -6.54e-13  |g|= 9.22e-07  |ddm|= 1.38e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.93649052443175
E1 = -182.56345917552287  E_coul = 54.02643720139856
init E= -128.537021974124
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849656221135278  LUMO = 0.556379847664948
  mo_energy =
[-3.27752620e+01 -1.93106174e+00 -8.49656221e-01 -8.49656221e-01
 -8.49656221e-01  5.56379848e-01  5.56379848e-01  5.56379848e-01
  1.18736461e+00  2.48058797e+00  2.48058797e+00  2.48058797e+00
  7.28771259e+00  8.26640045e+00  8.26640045e+00  8.26640045e+00
  2.75272916e+01  2.75272916e+01  2.75272916e+01  3.46136291e+01
  1.21766570e+02  1.21766570e+02  1.21766570e+02  1.38708511e+02
  5.02780467e+02  1.87039273e+03  8.00003913e+03  4.77676781e+04]
E1 = -182.5634625095154  E_coul = 54.02644053539079
cycle= 1 E= -128.537021974125  delta_E= -3.13e-13  |g|= 4.65e-07  |ddm|= 2.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5634625095154  E_coul = 54.02644053539079
  HOMO = -0.84965598976921  LUMO = 0.556379879533876
  mo_energy =
[-3.27752613e+01 -1.93106148e+00 -8.49655990e-01 -8.49655990e-01
 -8.49655990e-01  5.56379880e-01  5.56379880e-01  5.56379880e-01
  1.18736471e+00  2.48058810e+00  2.48058810e+00  2.48058810e+00
  7.28771288e+00  8.26640076e+00  8.26640076e+00  8.26640076e+00
  2.75272922e+01  2.75272922e+01  2.75272922e+01  3.46136297e+01
  1.21766571e+02  1.21766571e+02  1.21766571e+02  1.38708512e+02
  5.02780468e+02  1.87039273e+03  8.00003913e+03  4.77676781e+04]
E1 = -182.56346074720227  E_coul = 54.02643877307768
Extra cycle  E= -128.537021974125  delta_E= 2.84e-14  |g|= 2.38e-07  |ddm|= 1.56e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271052e+02 2.35734814e+02
 7.64325684e+01 1.00366522e+01 2.70501375e+01 3.81479009e-01
 1.11715313e+00 2.88170252e+00 4.06988677e+00 1.24390152e+01
 5.47843954e+01 2.03312240e-01 1.50045593e+00 5.58913707e-01]
grad_E = [ 3.85677668e-11 -2.03793599e-09  4.85862596e-08 -7.18710114e-07
  4.60245431e-06  1.17573770e-06  3.47325529e-06  9.68291017e-06
 -1.33585563e-05  3.78105771e-06  5.80586122e-04 -1.90109365e-03
  1.20220084e-04  3.30897278e-03 -2.30671587e-04 -2.05121143e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447022        1
[INPUT] 0    0    [1    /1   ]  833.271051731        1
[INPUT] 0    0    [1    /1   ]  235.734816403        1
[INPUT] 0    0    [1    /1   ]  76.4325502236        1
[INPUT] 0    0    [1    /1   ]  10.0366492798        1
[INPUT] 0    0    [1    /1   ]  27.0501223913        1
[INPUT] 0    0    [1    /1   ]  0.381479148137       1
[INPUT] 0    0    [1    /1   ]  1.11713990258        1
[INPUT] 0    0    [1    /1   ]  2.88169592003        1
[INPUT] 1    0    [1    /1   ]  4.06813182945        1
[INPUT] 1    0    [1    /1   ]  12.4444234224        1
[INPUT] 1    0    [1    /1   ]  54.7840596898        1
[INPUT] 1    0    [1    /1   ]  0.205649534364       1
[INPUT] 1    0    [1    /1   ]  1.51176161913        1
[INPUT] 1    0    [1    /1   ]  0.567982558403       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129986327, 1.0]], [0, [3661.4544702173953, 1.0]], [0, [833.2710517310298, 1.0]], [0, [235.7348164026183, 1.0]], [0, [76.43255022359045, 1.0]], [0, [10.036649279768737, 1.0]], [0, [27.05012239125397, 1.0]], [0, [0.381479148137038, 1.0]], [0, [1.117139902579245, 1.0]], [0, [2.8816959200327226, 1.0]], [1, [4.068131829449089, 1.0]], [1, [12.444423422363995, 1.0]], [1, [54.78405968983283, 1.0]], [1, [0.2056495343635253, 1.0]], [1, [1.5117616191301524, 1.0]], [1, [0.5679825584031577, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447022]
bas 2, expnt(s) = [833.27105173]
bas 3, expnt(s) = [235.7348164]
bas 4, expnt(s) = [76.43255022]
bas 5, expnt(s) = [10.03664928]
bas 6, expnt(s) = [27.05012239]
bas 7, expnt(s) = [0.38147915]
bas 8, expnt(s) = [1.1171399]
bas 9, expnt(s) = [2.88169592]
bas 10, expnt(s) = [4.06813183]
bas 11, expnt(s) = [12.44442342]
bas 12, expnt(s) = [54.78405969]
bas 13, expnt(s) = [0.20564953]
bas 14, expnt(s) = [1.51176162]
bas 15, expnt(s) = [0.56798256]
CPU time:        46.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271052e+02 3.91836371e+02 2.35734816e+02 1.51996232e+02
 7.64325502e+01 6.53091132e+01 1.00366493e+01 1.42464476e+01
 2.70501224e+01 2.99669091e+01 3.81479148e-01 1.22636043e+00
 1.11713990e+00 2.74533722e+00 2.88169592e+00 5.58793233e+00
 4.06813183e+00 1.68549770e+01 1.24444234e+01 6.81872015e+01
 5.47840597e+01 4.34812637e+02 2.05649534e-01 4.04011805e-01
 1.51176162e+00 4.89033417e+00 5.67982558e-01 1.43847773e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999871098860392
cond(S) = 343.9340096212006
E1 = -183.5842365907206  E_coul = 55.07956534255506
init E= -128.504671248166
    CPU time for initialize scf      0.04 sec, wall time      0.05 sec
  HOMO = -0.774742685435512  LUMO = 0.575268789916845
  mo_energy =
[-3.25553320e+01 -1.85260228e+00 -7.74742685e-01 -7.74742685e-01
 -7.74742685e-01  5.75268790e-01  5.75268790e-01  5.75268790e-01
  1.21926289e+00  2.56034103e+00  2.56034103e+00  2.56034103e+00
  7.37871082e+00  8.43065535e+00  8.43065535e+00  8.43065535e+00
  2.77660080e+01  2.77660080e+01  2.77660080e+01  3.47814917e+01
  1.22056058e+02  1.22056058e+02  1.22056058e+02  1.38925020e+02
  5.03030543e+02  1.87067377e+03  8.00034683e+03  4.77680037e+04]
E1 = -182.04610008025062  E_coul = 53.51272851137903
cycle= 1 E= -128.533371568872  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546146
diis-c [-0.298276  1.      ]
  HOMO = -0.886029374399413  LUMO = 0.559096766014479
  mo_energy =
[-3.28855680e+01 -1.96945073e+00 -8.86029374e-01 -8.86029374e-01
 -8.86029374e-01  5.59096766e-01  5.59096766e-01  5.59096766e-01
  1.17231616e+00  2.49480215e+00  2.49480215e+00  2.49480215e+00
  7.24337030e+00  8.28666476e+00  8.28666476e+00  8.28666476e+00
  2.75241942e+01  2.75241942e+01  2.75241942e+01  3.45289957e+01
  1.21724918e+02  1.21724918e+02  1.21724918e+02  1.38600104e+02
  5.02661137e+02  1.87026814e+03  7.99991214e+03  4.77675502e+04]
E1 = -182.8301310396656  E_coul = 54.294065029603466
cycle= 2 E= -128.536066010062  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279896
diis-c [-6.19241985e-04  3.38184136e-01  6.61815864e-01]
  HOMO = -0.849408391441468  LUMO = 0.56443597519885
  mo_energy =
[-3.27748457e+01 -1.93085659e+00 -8.49408391e-01 -8.49408391e-01
 -8.49408391e-01  5.64435975e-01  5.64435975e-01  5.64435975e-01
  1.18743517e+00  2.51605168e+00  2.51605168e+00  2.51605168e+00
  7.28788983e+00  8.33413538e+00  8.33413538e+00  8.33413538e+00
  2.76052044e+01  2.76052044e+01  2.76052044e+01  3.46138661e+01
  1.21835218e+02  1.21835218e+02  1.21835218e+02  1.38708794e+02
  5.02780806e+02  1.87039317e+03  8.00003967e+03  4.77676787e+04]
E1 = -182.56327549287127  E_coul = 54.026234864091144
cycle= 3 E= -128.53704062878  delta_E= -0.000975  |g|= 0.000374  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000807366
diis-c [-9.42301063e-08 -1.89060343e-03 -1.02618555e-03  1.00291679e+00]
  HOMO = -0.849615433156492  LUMO = 0.564424701373288
  mo_energy =
[-3.27751870e+01 -1.93102020e+00 -8.49615433e-01 -8.49615433e-01
 -8.49615433e-01  5.64424701e-01  5.64424701e-01  5.64424701e-01
  1.18737509e+00  2.51596337e+00  2.51596337e+00  2.51596337e+00
  7.28772283e+00  8.33395544e+00  8.33395544e+00  8.33395544e+00
  2.76049395e+01  2.76049395e+01  2.76049395e+01  3.46136003e+01
  1.21834866e+02  1.21834866e+02  1.21834866e+02  1.38708452e+02
  5.02780373e+02  1.87039263e+03  8.00003906e+03  4.77676780e+04]
E1 = -182.56345386871135  E_coul = 54.026413225672435
cycle= 4 E= -128.537040643039  delta_E= -1.43e-08  |g|= 6.78e-05  |ddm|= 0.000218
    CPU time for cycle= 4      0.01 sec, wall time      0.03 sec
diis-norm(errvec)=0.000163779
diis-c [-6.68466812e-10  1.05854238e-04  4.88680450e-04 -1.34853687e-01
  1.13425915e+00]
  HOMO = -0.849653055738259  LUMO = 0.564417043457617
  mo_energy =
[-3.27752504e+01 -1.93105403e+00 -8.49653056e-01 -8.49653056e-01
 -8.49653056e-01  5.64417043e-01  5.64417043e-01  5.64417043e-01
  1.18735531e+00  2.51593664e+00  2.51593664e+00  2.51593664e+00
  7.28768078e+00  8.33391065e+00  8.33391065e+00  8.33391065e+00
  2.76048820e+01  2.76048820e+01  2.76048820e+01  3.46135423e+01
  1.21834803e+02  1.21834803e+02  1.21834803e+02  1.38708389e+02
  5.02780306e+02  1.87039256e+03  8.00003898e+03  4.77676779e+04]
E1 = -182.56356561953083  E_coul = 54.02652497603352
cycle= 5 E= -128.537040643497  delta_E= -4.58e-10  |g|= 2.5e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56356561953083  E_coul = 54.02652497603352
  HOMO = -0.849652226170591  LUMO = 0.564417114678723
  mo_energy =
[-3.27752483e+01 -1.93105284e+00 -8.49652226e-01 -8.49652226e-01
 -8.49652226e-01  5.64417115e-01  5.64417115e-01  5.64417115e-01
  1.18735574e+00  2.51593707e+00  2.51593707e+00  2.51593707e+00
  7.28768204e+00  8.33391176e+00  8.33391176e+00  8.33391176e+00
  2.76048838e+01  2.76048838e+01  2.76048838e+01  3.46135443e+01
  1.21834804e+02  1.21834804e+02  1.21834804e+02  1.38708391e+02
  5.02780308e+02  1.87039256e+03  8.00003898e+03  4.77676779e+04]
E1 = -182.5635585895921  E_coul = 54.026517946094216
Extra cycle  E= -128.537040643498  delta_E= -5.97e-13  |g|= 9.35e-07  |ddm|= 1.36e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271052e+02 2.35734816e+02
 7.64325502e+01 1.00366493e+01 2.70501224e+01 3.81479148e-01
 1.11713990e+00 2.88169592e+00 4.06813183e+00 1.24444234e+01
 5.47840597e+01 2.05649534e-01 1.51176162e+00 5.67982558e-01]
E = -128.5370406434979
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447022        1
[INPUT] 0    0    [1    /1   ]  833.271051731        1
[INPUT] 0    0    [1    /1   ]  235.734816403        1
[INPUT] 0    0    [1    /1   ]  76.4325502236        1
[INPUT] 0    0    [1    /1   ]  10.0366492798        1
[INPUT] 0    0    [1    /1   ]  27.0501223913        1
[INPUT] 0    0    [1    /1   ]  0.381479148137       1
[INPUT] 0    0    [1    /1   ]  1.11713990258        1
[INPUT] 0    0    [1    /1   ]  2.88169592003        1
[INPUT] 1    0    [1    /1   ]  4.06813182945        1
[INPUT] 1    0    [1    /1   ]  12.4444234224        1
[INPUT] 1    0    [1    /1   ]  54.7840596898        1
[INPUT] 1    0    [1    /1   ]  0.205649534364       1
[INPUT] 1    0    [1    /1   ]  1.51176161913        1
[INPUT] 1    0    [1    /1   ]  0.567982558403       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129986327, 1.0]], [0, [3661.4544702173953, 1.0]], [0, [833.2710517310298, 1.0]], [0, [235.7348164026183, 1.0]], [0, [76.43255022359045, 1.0]], [0, [10.036649279768737, 1.0]], [0, [27.05012239125397, 1.0]], [0, [0.381479148137038, 1.0]], [0, [1.117139902579245, 1.0]], [0, [2.8816959200327226, 1.0]], [1, [4.068131829449089, 1.0]], [1, [12.444423422363995, 1.0]], [1, [54.78405968983283, 1.0]], [1, [0.2056495343635253, 1.0]], [1, [1.5117616191301524, 1.0]], [1, [0.5679825584031577, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447022]
bas 2, expnt(s) = [833.27105173]
bas 3, expnt(s) = [235.7348164]
bas 4, expnt(s) = [76.43255022]
bas 5, expnt(s) = [10.03664928]
bas 6, expnt(s) = [27.05012239]
bas 7, expnt(s) = [0.38147915]
bas 8, expnt(s) = [1.1171399]
bas 9, expnt(s) = [2.88169592]
bas 10, expnt(s) = [4.06813183]
bas 11, expnt(s) = [12.44442342]
bas 12, expnt(s) = [54.78405969]
bas 13, expnt(s) = [0.20564953]
bas 14, expnt(s) = [1.51176162]
bas 15, expnt(s) = [0.56798256]
CPU time:        46.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271052e+02 3.91836371e+02 2.35734816e+02 1.51996232e+02
 7.64325502e+01 6.53091132e+01 1.00366493e+01 1.42464476e+01
 2.70501224e+01 2.99669091e+01 3.81479148e-01 1.22636043e+00
 1.11713990e+00 2.74533722e+00 2.88169592e+00 5.58793233e+00
 4.06813183e+00 1.68549770e+01 1.24444234e+01 6.81872015e+01
 5.47840597e+01 4.34812637e+02 2.05649534e-01 4.04011805e-01
 1.51176162e+00 4.89033417e+00 5.67982558e-01 1.43847773e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999871098860392
cond(S) = 343.9340096212006
E1 = -183.5842365907206  E_coul = 55.07956534255506
init E= -128.504671248166
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774742685435512  LUMO = 0.575268789916845
  mo_energy =
[-3.25553320e+01 -1.85260228e+00 -7.74742685e-01 -7.74742685e-01
 -7.74742685e-01  5.75268790e-01  5.75268790e-01  5.75268790e-01
  1.21926289e+00  2.56034103e+00  2.56034103e+00  2.56034103e+00
  7.37871082e+00  8.43065535e+00  8.43065535e+00  8.43065535e+00
  2.77660080e+01  2.77660080e+01  2.77660080e+01  3.47814917e+01
  1.22056058e+02  1.22056058e+02  1.22056058e+02  1.38925020e+02
  5.03030543e+02  1.87067377e+03  8.00034683e+03  4.77680037e+04]
E1 = -182.04610008025062  E_coul = 53.51272851137903
cycle= 1 E= -128.533371568872  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546146
diis-c [-0.298276  1.      ]
  HOMO = -0.886029374399413  LUMO = 0.559096766014479
  mo_energy =
[-3.28855680e+01 -1.96945073e+00 -8.86029374e-01 -8.86029374e-01
 -8.86029374e-01  5.59096766e-01  5.59096766e-01  5.59096766e-01
  1.17231616e+00  2.49480215e+00  2.49480215e+00  2.49480215e+00
  7.24337030e+00  8.28666476e+00  8.28666476e+00  8.28666476e+00
  2.75241942e+01  2.75241942e+01  2.75241942e+01  3.45289957e+01
  1.21724918e+02  1.21724918e+02  1.21724918e+02  1.38600104e+02
  5.02661137e+02  1.87026814e+03  7.99991214e+03  4.77675502e+04]
E1 = -182.8301310396656  E_coul = 54.294065029603466
cycle= 2 E= -128.536066010062  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279896
diis-c [-6.19241985e-04  3.38184136e-01  6.61815864e-01]
  HOMO = -0.849408391441468  LUMO = 0.56443597519885
  mo_energy =
[-3.27748457e+01 -1.93085659e+00 -8.49408391e-01 -8.49408391e-01
 -8.49408391e-01  5.64435975e-01  5.64435975e-01  5.64435975e-01
  1.18743517e+00  2.51605168e+00  2.51605168e+00  2.51605168e+00
  7.28788983e+00  8.33413538e+00  8.33413538e+00  8.33413538e+00
  2.76052044e+01  2.76052044e+01  2.76052044e+01  3.46138661e+01
  1.21835218e+02  1.21835218e+02  1.21835218e+02  1.38708794e+02
  5.02780806e+02  1.87039317e+03  8.00003967e+03  4.77676787e+04]
E1 = -182.56327549287127  E_coul = 54.026234864091144
cycle= 3 E= -128.53704062878  delta_E= -0.000975  |g|= 0.000374  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000807366
diis-c [-9.42301063e-08 -1.89060343e-03 -1.02618555e-03  1.00291679e+00]
  HOMO = -0.849615433156492  LUMO = 0.564424701373288
  mo_energy =
[-3.27751870e+01 -1.93102020e+00 -8.49615433e-01 -8.49615433e-01
 -8.49615433e-01  5.64424701e-01  5.64424701e-01  5.64424701e-01
  1.18737509e+00  2.51596337e+00  2.51596337e+00  2.51596337e+00
  7.28772283e+00  8.33395544e+00  8.33395544e+00  8.33395544e+00
  2.76049395e+01  2.76049395e+01  2.76049395e+01  3.46136003e+01
  1.21834866e+02  1.21834866e+02  1.21834866e+02  1.38708452e+02
  5.02780373e+02  1.87039263e+03  8.00003906e+03  4.77676780e+04]
E1 = -182.56345386871135  E_coul = 54.026413225672435
cycle= 4 E= -128.537040643039  delta_E= -1.43e-08  |g|= 6.78e-05  |ddm|= 0.000218
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000163779
diis-c [-6.68466812e-10  1.05854238e-04  4.88680450e-04 -1.34853687e-01
  1.13425915e+00]
  HOMO = -0.849653055738259  LUMO = 0.564417043457617
  mo_energy =
[-3.27752504e+01 -1.93105403e+00 -8.49653056e-01 -8.49653056e-01
 -8.49653056e-01  5.64417043e-01  5.64417043e-01  5.64417043e-01
  1.18735531e+00  2.51593664e+00  2.51593664e+00  2.51593664e+00
  7.28768078e+00  8.33391065e+00  8.33391065e+00  8.33391065e+00
  2.76048820e+01  2.76048820e+01  2.76048820e+01  3.46135423e+01
  1.21834803e+02  1.21834803e+02  1.21834803e+02  1.38708389e+02
  5.02780306e+02  1.87039256e+03  8.00003898e+03  4.77676779e+04]
E1 = -182.56356561953083  E_coul = 54.02652497603352
cycle= 5 E= -128.537040643497  delta_E= -4.58e-10  |g|= 2.5e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56356561953083  E_coul = 54.02652497603352
  HOMO = -0.849652226170591  LUMO = 0.564417114678723
  mo_energy =
[-3.27752483e+01 -1.93105284e+00 -8.49652226e-01 -8.49652226e-01
 -8.49652226e-01  5.64417115e-01  5.64417115e-01  5.64417115e-01
  1.18735574e+00  2.51593707e+00  2.51593707e+00  2.51593707e+00
  7.28768204e+00  8.33391176e+00  8.33391176e+00  8.33391176e+00
  2.76048838e+01  2.76048838e+01  2.76048838e+01  3.46135443e+01
  1.21834804e+02  1.21834804e+02  1.21834804e+02  1.38708391e+02
  5.02780308e+02  1.87039256e+03  8.00003898e+03  4.77676779e+04]
E1 = -182.5635585895921  E_coul = 54.026517946094216
Extra cycle  E= -128.537040643498  delta_E= -5.97e-13  |g|= 9.35e-07  |ddm|= 1.36e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9340096212006
E1 = -182.5635585895921  E_coul = 54.026517946094216
init E= -128.537040643498
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849652747408545  LUMO = 0.564417029669242
  mo_energy =
[-3.27752498e+01 -1.93105333e+00 -8.49652747e-01 -8.49652747e-01
 -8.49652747e-01  5.64417030e-01  5.64417030e-01  5.64417030e-01
  1.18735553e+00  2.51593676e+00  2.51593676e+00  2.51593676e+00
  7.28768145e+00  8.33391109e+00  8.33391109e+00  8.33391109e+00
  2.76048827e+01  2.76048827e+01  2.76048827e+01  3.46135432e+01
  1.21834803e+02  1.21834803e+02  1.21834803e+02  1.38708389e+02
  5.02780306e+02  1.87039256e+03  8.00003898e+03  4.77676779e+04]
E1 = -182.56356197729897  E_coul = 54.02652133380109
cycle= 1 E= -128.537040643498  delta_E= 2.84e-14  |g|= 4.72e-07  |ddm|= 2.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56356197729897  E_coul = 54.02652133380109
  HOMO = -0.849652512053674  LUMO = 0.564417062811551
  mo_energy =
[-3.27752490e+01 -1.93105308e+00 -8.49652512e-01 -8.49652512e-01
 -8.49652512e-01  5.64417063e-01  5.64417063e-01  5.64417063e-01
  1.18735563e+00  2.51593689e+00  2.51593689e+00  2.51593689e+00
  7.28768174e+00  8.33391140e+00  8.33391140e+00  8.33391140e+00
  2.76048832e+01  2.76048832e+01  2.76048832e+01  3.46135438e+01
  1.21834804e+02  1.21834804e+02  1.21834804e+02  1.38708390e+02
  5.02780307e+02  1.87039256e+03  8.00003898e+03  4.77676779e+04]
E1 = -182.5635601860261  E_coul = 54.026519542528064
Extra cycle  E= -128.537040643498  delta_E= -1.71e-13  |g|= 2.42e-07  |ddm|= 1.57e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271052e+02 2.35734816e+02
 7.64325502e+01 1.00366493e+01 2.70501224e+01 3.81479148e-01
 1.11713990e+00 2.88169592e+00 4.06813183e+00 1.24444234e+01
 5.47840597e+01 2.05649534e-01 1.51176162e+00 5.67982558e-01]
grad_E = [ 3.85041031e-11 -2.03469638e-09  4.85255806e-08 -7.18210395e-07
  4.60147881e-06  1.41813907e-06  3.44532614e-06  6.64533112e-06
 -1.25914492e-05  4.46825688e-06  5.72309502e-05 -1.77056228e-03
  1.12860496e-04  2.09577767e-03  2.31724812e-04 -1.16282684e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447023        1
[INPUT] 0    0    [1    /1   ]  833.2710515          1
[INPUT] 0    0    [1    /1   ]  235.734819825        1
[INPUT] 0    0    [1    /1   ]  76.4325283739        1
[INPUT] 0    0    [1    /1   ]  10.0366453105        1
[INPUT] 0    0    [1    /1   ]  27.0501047638        1
[INPUT] 0    0    [1    /1   ]  0.38147836952        1
[INPUT] 0    0    [1    /1   ]  1.11713817603        1
[INPUT] 0    0    [1    /1   ]  2.88168638164        1
[INPUT] 1    0    [1    /1   ]  4.06521132034        1
[INPUT] 1    0    [1    /1   ]  12.451847427         1
[INPUT] 1    0    [1    /1   ]  54.7836007613        1
[INPUT] 1    0    [1    /1   ]  0.207245810697       1
[INPUT] 1    0    [1    /1   ]  1.52181181909        1
[INPUT] 1    0    [1    /1   ]  0.57645824374        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129986145, 1.0]], [0, [3661.454470227081, 1.0]], [0, [833.2710514998796, 1.0]], [0, [235.73481982473427, 1.0]], [0, [76.4325283739494, 1.0]], [0, [10.03664531047473, 1.0]], [0, [27.050104763771365, 1.0]], [0, [0.38147836952030073, 1.0]], [0, [1.117138176029595, 1.0]], [0, [2.881686381643996, 1.0]], [1, [4.065211320335172, 1.0]], [1, [12.451847427030778, 1.0]], [1, [54.78360076125485, 1.0]], [1, [0.2072458106974491, 1.0]], [1, [1.5218118190867191, 1.0]], [1, [0.5764582437395277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447023]
bas 2, expnt(s) = [833.2710515]
bas 3, expnt(s) = [235.73481982]
bas 4, expnt(s) = [76.43252837]
bas 5, expnt(s) = [10.03664531]
bas 6, expnt(s) = [27.05010476]
bas 7, expnt(s) = [0.38147837]
bas 8, expnt(s) = [1.11713818]
bas 9, expnt(s) = [2.88168638]
bas 10, expnt(s) = [4.06521132]
bas 11, expnt(s) = [12.45184743]
bas 12, expnt(s) = [54.78360076]
bas 13, expnt(s) = [0.20724581]
bas 14, expnt(s) = [1.52181182]
bas 15, expnt(s) = [0.57645824]
CPU time:        49.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271051e+02 3.91836370e+02 2.35734820e+02 1.51996233e+02
 7.64325284e+01 6.53090992e+01 1.00366453e+01 1.42464434e+01
 2.70501048e+01 2.99668944e+01 3.81478370e-01 1.22635855e+00
 1.11713818e+00 2.74533403e+00 2.88168638e+00 5.58791846e+00
 4.06521132e+00 1.68398532e+01 1.24518474e+01 6.82380536e+01
 5.47836008e+01 4.34808084e+02 2.07245811e-01 4.07935587e-01
 1.52181182e+00 4.93100660e+00 5.76458244e-01 1.46535959e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99986795020412
cond(S) = 343.9332122987817
E1 = -183.58426759091495  E_coul = 55.0795763158423
init E= -128.504691275073
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774744587105327  LUMO = 0.581608024089962
  mo_energy =
[-3.25553253e+01 -1.85260202e+00 -7.74744587e-01 -7.74744587e-01
 -7.74744587e-01  5.81608024e-01  5.81608024e-01  5.81608024e-01
  1.21926754e+00  2.59129320e+00  2.59129320e+00  2.59129320e+00
  7.37869375e+00  8.48931340e+00  8.48931340e+00  8.48931340e+00
  2.78339250e+01  2.78339250e+01  2.78339250e+01  3.47814251e+01
  1.22120535e+02  1.22120535e+02  1.22120535e+02  1.38924909e+02
  5.03030372e+02  1.87067358e+03  8.00034665e+03  4.77680036e+04]
E1 = -182.04605401667234  E_coul = 53.51267094051186
cycle= 1 E= -128.53338307616  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546299
diis-c [-0.29844237  1.        ]
  HOMO = -0.886037532135003  LUMO = 0.565136891465372
  mo_energy =
[-3.28855712e+01 -1.96945720e+00 -8.86037532e-01 -8.86037532e-01
 -8.86037532e-01  5.65136891e-01  5.65136891e-01  5.65136891e-01
  1.17230307e+00  2.52514523e+00  2.52514523e+00  2.52514523e+00
  7.24334842e+00  8.34523561e+00  8.34523561e+00  8.34523561e+00
  2.75921821e+01  2.75921821e+01  2.75921821e+01  3.45289245e+01
  1.21789409e+02  1.21789409e+02  1.21789409e+02  1.38599985e+02
  5.02660967e+02  1.87026796e+03  7.99991198e+03  4.77675501e+04]
E1 = -182.82997170518317  E_coul = 54.293894606374344
cycle= 2 E= -128.536077098809  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27997
diis-c [-6.19879422e-04  3.38180179e-01  6.61819821e-01]
  HOMO = -0.849422290305549  LUMO = 0.5705686588879
  mo_energy =
[-3.27748610e+01 -1.93086958e+00 -8.49422290e-01 -8.49422290e-01
 -8.49422290e-01  5.70568659e-01  5.70568659e-01  5.70568659e-01
  1.18741706e+00  2.54658238e+00  2.54658238e+00  2.54658238e+00
  7.28786141e+00  8.39272603e+00  8.39272603e+00  8.39272603e+00
  2.76731540e+01  2.76731540e+01  2.76731540e+01  3.46137843e+01
  1.21899689e+02  1.21899689e+02  1.21899689e+02  1.38708662e+02
  5.02780624e+02  1.87039297e+03  8.00003949e+03  4.77676785e+04]
E1 = -182.56309620897187  E_coul = 54.02604454598064
cycle= 3 E= -128.537051662991  delta_E= -0.000975  |g|= 0.000382  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000820992
diis-c [-9.79629872e-08 -1.91302072e-03 -1.02667903e-03  1.00293970e+00]
  HOMO = -0.849633738514454  LUMO = 0.570555579762395
  mo_energy =
[-3.27752089e+01 -1.93103853e+00 -8.49633739e-01 -8.49633739e-01
 -8.49633739e-01  5.70555580e-01  5.70555580e-01  5.70555580e-01
  1.18735297e+00  2.54648916e+00  2.54648916e+00  2.54648916e+00
  7.28768902e+00  8.39254040e+00  8.39254040e+00  8.39254040e+00
  2.76728829e+01  2.76728829e+01  2.76728829e+01  3.46135123e+01
  1.21899330e+02  1.21899330e+02  1.21899330e+02  1.38708314e+02
  5.02780184e+02  1.87039243e+03  8.00003887e+03  4.77676778e+04]
E1 = -182.56327535123492  E_coul = 54.026223673062326
cycle= 4 E= -128.537051678173  delta_E= -1.52e-08  |g|= 6.91e-05  |ddm|= 0.000224
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000165737
diis-c [-6.59390885e-10  1.06965141e-04  4.90510358e-04 -1.35730238e-01
  1.13513276e+00]
  HOMO = -0.849672231089112  LUMO = 0.570547535539269
  mo_energy =
[-3.27752736e+01 -1.93107353e+00 -8.49672231e-01 -8.49672231e-01
 -8.49672231e-01  5.70547536e-01  5.70547536e-01  5.70547536e-01
  1.18733237e+00  2.54646147e+00  2.54646147e+00  2.54646147e+00
  7.28764584e+00  8.39249448e+00  8.39249448e+00  8.39249448e+00
  2.76728241e+01  2.76728241e+01  2.76728241e+01  3.46134531e+01
  1.21899266e+02  1.21899266e+02  1.21899266e+02  1.38708250e+02
  5.02780116e+02  1.87039236e+03  8.00003880e+03  4.77676778e+04]
E1 = -182.56338756265504  E_coul = 54.02633588400296
cycle= 5 E= -128.537051678652  delta_E= -4.79e-10  |g|= 2.47e-06  |ddm|= 3.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56338756265504  E_coul = 54.02633588400296
  HOMO = -0.849671378781723  LUMO = 0.570547609212337
  mo_energy =
[-3.27752714e+01 -1.93107235e+00 -8.49671379e-01 -8.49671379e-01
 -8.49671379e-01  5.70547609e-01  5.70547609e-01  5.70547609e-01
  1.18733278e+00  2.54646192e+00  2.54646192e+00  2.54646192e+00
  7.28764711e+00  8.39249561e+00  8.39249561e+00  8.39249561e+00
  2.76728260e+01  2.76728260e+01  2.76728260e+01  3.46134551e+01
  1.21899268e+02  1.21899268e+02  1.21899268e+02  1.38708252e+02
  5.02780117e+02  1.87039236e+03  8.00003880e+03  4.77676778e+04]
E1 = -182.56338026692615  E_coul = 54.026328588273564
Extra cycle  E= -128.537051678653  delta_E= -5.12e-13  |g|= 9.65e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271051e+02 2.35734820e+02
 7.64325284e+01 1.00366453e+01 2.70501048e+01 3.81478370e-01
 1.11713818e+00 2.88168638e+00 4.06521132e+00 1.24518474e+01
 5.47836008e+01 2.07245811e-01 1.52181182e+00 5.76458244e-01]
E = -128.53705167865257
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447023        1
[INPUT] 0    0    [1    /1   ]  833.2710515          1
[INPUT] 0    0    [1    /1   ]  235.734819825        1
[INPUT] 0    0    [1    /1   ]  76.4325283739        1
[INPUT] 0    0    [1    /1   ]  10.0366453105        1
[INPUT] 0    0    [1    /1   ]  27.0501047638        1
[INPUT] 0    0    [1    /1   ]  0.38147836952        1
[INPUT] 0    0    [1    /1   ]  1.11713817603        1
[INPUT] 0    0    [1    /1   ]  2.88168638164        1
[INPUT] 1    0    [1    /1   ]  4.06521132034        1
[INPUT] 1    0    [1    /1   ]  12.451847427         1
[INPUT] 1    0    [1    /1   ]  54.7836007613        1
[INPUT] 1    0    [1    /1   ]  0.207245810697       1
[INPUT] 1    0    [1    /1   ]  1.52181181909        1
[INPUT] 1    0    [1    /1   ]  0.57645824374        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129986145, 1.0]], [0, [3661.454470227081, 1.0]], [0, [833.2710514998796, 1.0]], [0, [235.73481982473427, 1.0]], [0, [76.4325283739494, 1.0]], [0, [10.03664531047473, 1.0]], [0, [27.050104763771365, 1.0]], [0, [0.38147836952030073, 1.0]], [0, [1.117138176029595, 1.0]], [0, [2.881686381643996, 1.0]], [1, [4.065211320335172, 1.0]], [1, [12.451847427030778, 1.0]], [1, [54.78360076125485, 1.0]], [1, [0.2072458106974491, 1.0]], [1, [1.5218118190867191, 1.0]], [1, [0.5764582437395277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447023]
bas 2, expnt(s) = [833.2710515]
bas 3, expnt(s) = [235.73481982]
bas 4, expnt(s) = [76.43252837]
bas 5, expnt(s) = [10.03664531]
bas 6, expnt(s) = [27.05010476]
bas 7, expnt(s) = [0.38147837]
bas 8, expnt(s) = [1.11713818]
bas 9, expnt(s) = [2.88168638]
bas 10, expnt(s) = [4.06521132]
bas 11, expnt(s) = [12.45184743]
bas 12, expnt(s) = [54.78360076]
bas 13, expnt(s) = [0.20724581]
bas 14, expnt(s) = [1.52181182]
bas 15, expnt(s) = [0.57645824]
CPU time:        49.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271051e+02 3.91836370e+02 2.35734820e+02 1.51996233e+02
 7.64325284e+01 6.53090992e+01 1.00366453e+01 1.42464434e+01
 2.70501048e+01 2.99668944e+01 3.81478370e-01 1.22635855e+00
 1.11713818e+00 2.74533403e+00 2.88168638e+00 5.58791846e+00
 4.06521132e+00 1.68398532e+01 1.24518474e+01 6.82380536e+01
 5.47836008e+01 4.34808084e+02 2.07245811e-01 4.07935587e-01
 1.52181182e+00 4.93100660e+00 5.76458244e-01 1.46535959e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99986795020412
cond(S) = 343.9332122987817
E1 = -183.58426759091495  E_coul = 55.0795763158423
init E= -128.504691275073
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774744587105327  LUMO = 0.581608024089962
  mo_energy =
[-3.25553253e+01 -1.85260202e+00 -7.74744587e-01 -7.74744587e-01
 -7.74744587e-01  5.81608024e-01  5.81608024e-01  5.81608024e-01
  1.21926754e+00  2.59129320e+00  2.59129320e+00  2.59129320e+00
  7.37869375e+00  8.48931340e+00  8.48931340e+00  8.48931340e+00
  2.78339250e+01  2.78339250e+01  2.78339250e+01  3.47814251e+01
  1.22120535e+02  1.22120535e+02  1.22120535e+02  1.38924909e+02
  5.03030372e+02  1.87067358e+03  8.00034665e+03  4.77680036e+04]
E1 = -182.04605401667234  E_coul = 53.51267094051186
cycle= 1 E= -128.53338307616  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546299
diis-c [-0.29844237  1.        ]
  HOMO = -0.886037532135003  LUMO = 0.565136891465372
  mo_energy =
[-3.28855712e+01 -1.96945720e+00 -8.86037532e-01 -8.86037532e-01
 -8.86037532e-01  5.65136891e-01  5.65136891e-01  5.65136891e-01
  1.17230307e+00  2.52514523e+00  2.52514523e+00  2.52514523e+00
  7.24334842e+00  8.34523561e+00  8.34523561e+00  8.34523561e+00
  2.75921821e+01  2.75921821e+01  2.75921821e+01  3.45289245e+01
  1.21789409e+02  1.21789409e+02  1.21789409e+02  1.38599985e+02
  5.02660967e+02  1.87026796e+03  7.99991198e+03  4.77675501e+04]
E1 = -182.82997170518317  E_coul = 54.293894606374344
cycle= 2 E= -128.536077098809  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27997
diis-c [-6.19879422e-04  3.38180179e-01  6.61819821e-01]
  HOMO = -0.849422290305549  LUMO = 0.5705686588879
  mo_energy =
[-3.27748610e+01 -1.93086958e+00 -8.49422290e-01 -8.49422290e-01
 -8.49422290e-01  5.70568659e-01  5.70568659e-01  5.70568659e-01
  1.18741706e+00  2.54658238e+00  2.54658238e+00  2.54658238e+00
  7.28786141e+00  8.39272603e+00  8.39272603e+00  8.39272603e+00
  2.76731540e+01  2.76731540e+01  2.76731540e+01  3.46137843e+01
  1.21899689e+02  1.21899689e+02  1.21899689e+02  1.38708662e+02
  5.02780624e+02  1.87039297e+03  8.00003949e+03  4.77676785e+04]
E1 = -182.56309620897187  E_coul = 54.02604454598064
cycle= 3 E= -128.537051662991  delta_E= -0.000975  |g|= 0.000382  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000820992
diis-c [-9.79629872e-08 -1.91302072e-03 -1.02667903e-03  1.00293970e+00]
  HOMO = -0.849633738514454  LUMO = 0.570555579762395
  mo_energy =
[-3.27752089e+01 -1.93103853e+00 -8.49633739e-01 -8.49633739e-01
 -8.49633739e-01  5.70555580e-01  5.70555580e-01  5.70555580e-01
  1.18735297e+00  2.54648916e+00  2.54648916e+00  2.54648916e+00
  7.28768902e+00  8.39254040e+00  8.39254040e+00  8.39254040e+00
  2.76728829e+01  2.76728829e+01  2.76728829e+01  3.46135123e+01
  1.21899330e+02  1.21899330e+02  1.21899330e+02  1.38708314e+02
  5.02780184e+02  1.87039243e+03  8.00003887e+03  4.77676778e+04]
E1 = -182.56327535123492  E_coul = 54.026223673062326
cycle= 4 E= -128.537051678173  delta_E= -1.52e-08  |g|= 6.91e-05  |ddm|= 0.000224
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000165737
diis-c [-6.59390885e-10  1.06965141e-04  4.90510358e-04 -1.35730238e-01
  1.13513276e+00]
  HOMO = -0.849672231089112  LUMO = 0.570547535539269
  mo_energy =
[-3.27752736e+01 -1.93107353e+00 -8.49672231e-01 -8.49672231e-01
 -8.49672231e-01  5.70547536e-01  5.70547536e-01  5.70547536e-01
  1.18733237e+00  2.54646147e+00  2.54646147e+00  2.54646147e+00
  7.28764584e+00  8.39249448e+00  8.39249448e+00  8.39249448e+00
  2.76728241e+01  2.76728241e+01  2.76728241e+01  3.46134531e+01
  1.21899266e+02  1.21899266e+02  1.21899266e+02  1.38708250e+02
  5.02780116e+02  1.87039236e+03  8.00003880e+03  4.77676778e+04]
E1 = -182.56338756265504  E_coul = 54.02633588400296
cycle= 5 E= -128.537051678652  delta_E= -4.79e-10  |g|= 2.47e-06  |ddm|= 3.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56338756265504  E_coul = 54.02633588400296
  HOMO = -0.849671378781723  LUMO = 0.570547609212337
  mo_energy =
[-3.27752714e+01 -1.93107235e+00 -8.49671379e-01 -8.49671379e-01
 -8.49671379e-01  5.70547609e-01  5.70547609e-01  5.70547609e-01
  1.18733278e+00  2.54646192e+00  2.54646192e+00  2.54646192e+00
  7.28764711e+00  8.39249561e+00  8.39249561e+00  8.39249561e+00
  2.76728260e+01  2.76728260e+01  2.76728260e+01  3.46134551e+01
  1.21899268e+02  1.21899268e+02  1.21899268e+02  1.38708252e+02
  5.02780117e+02  1.87039236e+03  8.00003880e+03  4.77676778e+04]
E1 = -182.56338026692615  E_coul = 54.026328588273564
Extra cycle  E= -128.537051678653  delta_E= -5.12e-13  |g|= 9.65e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9332122987817
E1 = -182.56338026692615  E_coul = 54.026328588273564
init E= -128.537051678653
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849671917716783  LUMO = 0.570547519578244
  mo_energy =
[-3.27752729e+01 -1.93107287e+00 -8.49671918e-01 -8.49671918e-01
 -8.49671918e-01  5.70547520e-01  5.70547520e-01  5.70547520e-01
  1.18733256e+00  2.54646159e+00  2.54646159e+00  2.54646159e+00
  7.28764649e+00  8.39249492e+00  8.39249492e+00  8.39249492e+00
  2.76728249e+01  2.76728249e+01  2.76728249e+01  3.46134539e+01
  1.21899266e+02  1.21899266e+02  1.21899266e+02  1.38708251e+02
  5.02780116e+02  1.87039236e+03  8.00003880e+03  4.77676778e+04]
E1 = -182.56338376805357  E_coul = 54.02633208940075
cycle= 1 E= -128.537051678653  delta_E= -2.27e-13  |g|= 4.86e-07  |ddm|= 2.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56338376805357  E_coul = 54.02633208940075
  HOMO = -0.84967167406698  LUMO = 0.570547554433648
  mo_energy =
[-3.27752722e+01 -1.93107261e+00 -8.49671674e-01 -8.49671674e-01
 -8.49671674e-01  5.70547554e-01  5.70547554e-01  5.70547554e-01
  1.18733266e+00  2.54646173e+00  2.54646173e+00  2.54646173e+00
  7.28764679e+00  8.39249524e+00  8.39249524e+00  8.39249524e+00
  2.76728254e+01  2.76728254e+01  2.76728254e+01  3.46134545e+01
  1.21899267e+02  1.21899267e+02  1.21899267e+02  1.38708251e+02
  5.02780116e+02  1.87039236e+03  8.00003880e+03  4.77676778e+04]
E1 = -182.5633819130043  E_coul = 54.02633023435195
Extra cycle  E= -128.537051678652  delta_E= 4.55e-13  |g|= 2.5e-07  |ddm|= 1.61e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271051e+02 2.35734820e+02
 7.64325284e+01 1.00366453e+01 2.70501048e+01 3.81478370e-01
 1.11713818e+00 2.88168638e+00 4.06521132e+00 1.24518474e+01
 5.47836008e+01 2.07245811e-01 1.52181182e+00 5.76458244e-01]
grad_E = [ 3.83853954e-11 -2.02856157e-09  4.84075638e-08 -7.17032175e-07
  4.59508124e-06  1.50572490e-06  3.45222943e-06 -2.24227896e-06
 -7.24757077e-06  4.51764598e-06 -4.02428233e-04 -1.63939404e-03
  1.04931476e-04 -7.50645958e-05  4.49122085e-04  2.29570941e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447024        1
[INPUT] 0    0    [1    /1   ]  833.271051282        1
[INPUT] 0    0    [1    /1   ]  235.734823053        1
[INPUT] 0    0    [1    /1   ]  76.4325077564        1
[INPUT] 0    0    [1    /1   ]  10.036639745         1
[INPUT] 0    0    [1    /1   ]  27.0500881313        1
[INPUT] 0    0    [1    /1   ]  0.381478976954       1
[INPUT] 0    0    [1    /1   ]  1.11714729544        1
[INPUT] 0    0    [1    /1   ]  2.88166976568        1
[INPUT] 1    0    [1    /1   ]  4.06772232598        1
[INPUT] 1    0    [1    /1   ]  12.4575196442        1
[INPUT] 1    0    [1    /1   ]  54.7832317466        1
[INPUT] 1    0    [1    /1   ]  0.208770619128       1
[INPUT] 1    0    [1    /1   ]  1.52828956473        1
[INPUT] 1    0    [1    /1   ]  0.5814951038         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129985974, 1.0]], [0, [3661.454470236203, 1.0]], [0, [833.2710512820145, 1.0]], [0, [235.73482305336552, 1.0]], [0, [76.43250775635475, 1.0]], [0, [10.036639744980327, 1.0]], [0, [27.050088131265923, 1.0]], [0, [0.38147897695443417, 1.0]], [0, [1.1171472954376906, 1.0]], [0, [2.881669765682589, 1.0]], [1, [4.06772232597632, 1.0]], [1, [12.457519644216369, 1.0]], [1, [54.78323174656726, 1.0]], [1, [0.20877061912799627, 1.0]], [1, [1.528289564733067, 1.0]], [1, [0.5814951037996603, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447024]
bas 2, expnt(s) = [833.27105128]
bas 3, expnt(s) = [235.73482305]
bas 4, expnt(s) = [76.43250776]
bas 5, expnt(s) = [10.03663974]
bas 6, expnt(s) = [27.05008813]
bas 7, expnt(s) = [0.38147898]
bas 8, expnt(s) = [1.1171473]
bas 9, expnt(s) = [2.88166977]
bas 10, expnt(s) = [4.06772233]
bas 11, expnt(s) = [12.45751964]
bas 12, expnt(s) = [54.78323175]
bas 13, expnt(s) = [0.20877062]
bas 14, expnt(s) = [1.52828956]
bas 15, expnt(s) = [0.5814951]
CPU time:        52.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271051e+02 3.91836370e+02 2.35734823e+02 1.51996235e+02
 7.64325078e+01 6.53090860e+01 1.00366397e+01 1.42464375e+01
 2.70500881e+01 2.99668806e+01 3.81478977e-01 1.22636001e+00
 1.11714730e+00 2.74535084e+00 2.88166977e+00 5.58789429e+00
 4.06772233e+00 1.68528563e+01 1.24575196e+01 6.82769116e+01
 5.47832317e+01 4.34804423e+02 2.08770619e-01 4.11690757e-01
 1.52828956e+00 4.95725720e+00 5.81495104e-01 1.48138168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999864946780223
cond(S) = 343.93448988359677
E1 = -183.58428045939988  E_coul = 55.079580787392956
init E= -128.504699672007
    CPU time for initialize scf      0.04 sec, wall time      0.10 sec
  HOMO = -0.774745173373174  LUMO = 0.586780404698842
  mo_energy =
[-3.25553230e+01 -1.85260185e+00 -7.74745173e-01 -7.74745173e-01
 -7.74745173e-01  5.86780405e-01  5.86780405e-01  5.86780405e-01
  1.21927665e+00  2.61205163e+00  2.61205163e+00  2.61205163e+00
  7.37870371e+00  8.53053832e+00  8.53053832e+00  8.53053832e+00
  2.78909569e+01  2.78909569e+01  2.78909569e+01  3.47813878e+01
  1.22178518e+02  1.22178518e+02  1.22178518e+02  1.38924812e+02
  5.03030216e+02  1.87067341e+03  8.00034649e+03  4.77680034e+04]
E1 = -182.04633906902154  E_coul = 53.51294911968527
cycle= 1 E= -128.533389949336  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546519
diis-c [-0.29868301  1.        ]
  HOMO = -0.886016664670465  LUMO = 0.570100340039314
  mo_energy =
[-3.28855221e+01 -1.96943210e+00 -8.86016665e-01 -8.86016665e-01
 -8.86016665e-01  5.70100340e-01  5.70100340e-01  5.70100340e-01
  1.17232223e+00  2.54554907e+00  2.54554907e+00  2.54554907e+00
  7.24338658e+00  8.38637922e+00  8.38637922e+00  8.38637922e+00
  2.76492763e+01  2.76492763e+01  2.76492763e+01  3.45289279e+01
  1.21847455e+02  1.21847455e+02  1.21847455e+02  1.38599935e+02
  5.02660863e+02  1.87026785e+03  7.99991187e+03  4.77675500e+04]
E1 = -182.83002317783303  E_coul = 54.29394006671988
cycle= 2 E= -128.536083111113  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.280053
diis-c [-6.20001304e-04  3.38156731e-01  6.61843269e-01]
  HOMO = -0.849411816071913  LUMO = 0.575598927491464
  mo_energy =
[-3.27748375e+01 -1.93085587e+00 -8.49411816e-01 -8.49411816e-01
 -8.49411816e-01  5.75598927e-01  5.75598927e-01  5.75598927e-01
  1.18743023e+00  2.56709859e+00  2.56709859e+00  2.56709859e+00
  7.28788693e+00  8.43389331e+00  8.43389331e+00  8.43389331e+00
  2.77302193e+01  2.77302193e+01  2.77302193e+01  3.46137669e+01
  1.21957704e+02  1.21957704e+02  1.21957704e+02  1.38708587e+02
  5.02780493e+02  1.87039283e+03  8.00003936e+03  4.77676784e+04]
E1 = -182.56322731090964  E_coul = 54.02617016378858
cycle= 3 E= -128.537057147121  delta_E= -0.000974  |g|= 0.000385  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.04 sec
diis-norm(errvec)=0.00082625
diis-c [-9.87418519e-08 -1.91998871e-03 -1.02285032e-03  1.00294284e+00]
  HOMO = -0.849624383407047  LUMO = 0.575585237665623
  mo_energy =
[-3.27751871e+01 -1.93102609e+00 -8.49624383e-01 -8.49624383e-01
 -8.49624383e-01  5.75585238e-01  5.75585238e-01  5.75585238e-01
  1.18736518e+00  2.56700378e+00  2.56700378e+00  2.56700378e+00
  7.28771321e+00  8.43370610e+00  8.43370610e+00  8.43370610e+00
  2.77299465e+01  2.77299465e+01  2.77299465e+01  3.46134932e+01
  1.21957344e+02  1.21957344e+02  1.21957344e+02  1.38708237e+02
  5.02780051e+02  1.87039229e+03  8.00003874e+03  4.77676777e+04]
E1 = -182.56340798771143  E_coul = 54.02635082518842
cycle= 4 E= -128.537057162523  delta_E= -1.54e-08  |g|= 6.95e-05  |ddm|= 0.000226
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000166619
diis-c [-6.57244848e-10  1.07409829e-04  4.91992156e-04 -1.35905068e-01
  1.13530567e+00]
  HOMO = -0.849663080989245  LUMO = 0.575577048866826
  mo_energy =
[-3.27752522e+01 -1.93106133e+00 -8.49663081e-01 -8.49663081e-01
 -8.49663081e-01  5.75577049e-01  5.75577049e-01  5.75577049e-01
  1.18734442e+00  2.56697580e+00  2.56697580e+00  2.56697580e+00
  7.28766978e+00  8.43365990e+00  8.43365990e+00  8.43365990e+00
  2.77298874e+01  2.77298874e+01  2.77298874e+01  3.46134336e+01
  1.21957279e+02  1.21957279e+02  1.21957279e+02  1.38708173e+02
  5.02779983e+02  1.87039221e+03  8.00003866e+03  4.77676777e+04]
E1 = -182.56352066309492  E_coul = 54.02646350008844
cycle= 5 E= -128.537057163006  delta_E= -4.83e-10  |g|= 2.46e-06  |ddm|= 3.44e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56352066309492  E_coul = 54.02646350008844
  HOMO = -0.849662221288041  LUMO = 0.575577125956689
  mo_energy =
[-3.27752500e+01 -1.93106016e+00 -8.49662221e-01 -8.49662221e-01
 -8.49662221e-01  5.75577126e-01  5.75577126e-01  5.75577126e-01
  1.18734483e+00  2.56697626e+00  2.56697626e+00  2.56697626e+00
  7.28767105e+00  8.43366104e+00  8.43366104e+00  8.43366104e+00
  2.77298893e+01  2.77298893e+01  2.77298893e+01  3.46134357e+01
  1.21957281e+02  1.21957281e+02  1.21957281e+02  1.38708175e+02
  5.02779984e+02  1.87039221e+03  8.00003867e+03  4.77676777e+04]
E1 = -182.56351334275774  E_coul = 54.02645617975075
Extra cycle  E= -128.537057163007  delta_E= -5.12e-13  |g|= 9.68e-07  |ddm|= 1.34e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.23 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271051e+02 2.35734823e+02
 7.64325078e+01 1.00366397e+01 2.70500881e+01 3.81478977e-01
 1.11714730e+00 2.88166977e+00 4.06772233e+00 1.24575196e+01
 5.47832317e+01 2.08770619e-01 1.52828956e+00 5.81495104e-01]
E = -128.53705716300698
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447024        1
[INPUT] 0    0    [1    /1   ]  833.271051282        1
[INPUT] 0    0    [1    /1   ]  235.734823053        1
[INPUT] 0    0    [1    /1   ]  76.4325077564        1
[INPUT] 0    0    [1    /1   ]  10.036639745         1
[INPUT] 0    0    [1    /1   ]  27.0500881313        1
[INPUT] 0    0    [1    /1   ]  0.381478976954       1
[INPUT] 0    0    [1    /1   ]  1.11714729544        1
[INPUT] 0    0    [1    /1   ]  2.88166976568        1
[INPUT] 1    0    [1    /1   ]  4.06772232598        1
[INPUT] 1    0    [1    /1   ]  12.4575196442        1
[INPUT] 1    0    [1    /1   ]  54.7832317466        1
[INPUT] 1    0    [1    /1   ]  0.208770619128       1
[INPUT] 1    0    [1    /1   ]  1.52828956473        1
[INPUT] 1    0    [1    /1   ]  0.5814951038         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129985974, 1.0]], [0, [3661.454470236203, 1.0]], [0, [833.2710512820145, 1.0]], [0, [235.73482305336552, 1.0]], [0, [76.43250775635475, 1.0]], [0, [10.036639744980327, 1.0]], [0, [27.050088131265923, 1.0]], [0, [0.38147897695443417, 1.0]], [0, [1.1171472954376906, 1.0]], [0, [2.881669765682589, 1.0]], [1, [4.06772232597632, 1.0]], [1, [12.457519644216369, 1.0]], [1, [54.78323174656726, 1.0]], [1, [0.20877061912799627, 1.0]], [1, [1.528289564733067, 1.0]], [1, [0.5814951037996603, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447024]
bas 2, expnt(s) = [833.27105128]
bas 3, expnt(s) = [235.73482305]
bas 4, expnt(s) = [76.43250776]
bas 5, expnt(s) = [10.03663974]
bas 6, expnt(s) = [27.05008813]
bas 7, expnt(s) = [0.38147898]
bas 8, expnt(s) = [1.1171473]
bas 9, expnt(s) = [2.88166977]
bas 10, expnt(s) = [4.06772233]
bas 11, expnt(s) = [12.45751964]
bas 12, expnt(s) = [54.78323175]
bas 13, expnt(s) = [0.20877062]
bas 14, expnt(s) = [1.52828956]
bas 15, expnt(s) = [0.5814951]
CPU time:        53.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271051e+02 3.91836370e+02 2.35734823e+02 1.51996235e+02
 7.64325078e+01 6.53090860e+01 1.00366397e+01 1.42464375e+01
 2.70500881e+01 2.99668806e+01 3.81478977e-01 1.22636001e+00
 1.11714730e+00 2.74535084e+00 2.88166977e+00 5.58789429e+00
 4.06772233e+00 1.68528563e+01 1.24575196e+01 6.82769116e+01
 5.47832317e+01 4.34804423e+02 2.08770619e-01 4.11690757e-01
 1.52828956e+00 4.95725720e+00 5.81495104e-01 1.48138168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999864946780223
cond(S) = 343.93448988359677
E1 = -183.58428045939988  E_coul = 55.079580787392956
init E= -128.504699672007
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774745173373174  LUMO = 0.586780404698842
  mo_energy =
[-3.25553230e+01 -1.85260185e+00 -7.74745173e-01 -7.74745173e-01
 -7.74745173e-01  5.86780405e-01  5.86780405e-01  5.86780405e-01
  1.21927665e+00  2.61205163e+00  2.61205163e+00  2.61205163e+00
  7.37870371e+00  8.53053832e+00  8.53053832e+00  8.53053832e+00
  2.78909569e+01  2.78909569e+01  2.78909569e+01  3.47813878e+01
  1.22178518e+02  1.22178518e+02  1.22178518e+02  1.38924812e+02
  5.03030216e+02  1.87067341e+03  8.00034649e+03  4.77680034e+04]
E1 = -182.04633906902154  E_coul = 53.51294911968527
cycle= 1 E= -128.533389949336  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546519
diis-c [-0.29868301  1.        ]
  HOMO = -0.886016664670465  LUMO = 0.570100340039314
  mo_energy =
[-3.28855221e+01 -1.96943210e+00 -8.86016665e-01 -8.86016665e-01
 -8.86016665e-01  5.70100340e-01  5.70100340e-01  5.70100340e-01
  1.17232223e+00  2.54554907e+00  2.54554907e+00  2.54554907e+00
  7.24338658e+00  8.38637922e+00  8.38637922e+00  8.38637922e+00
  2.76492763e+01  2.76492763e+01  2.76492763e+01  3.45289279e+01
  1.21847455e+02  1.21847455e+02  1.21847455e+02  1.38599935e+02
  5.02660863e+02  1.87026785e+03  7.99991187e+03  4.77675500e+04]
E1 = -182.83002317783303  E_coul = 54.29394006671988
cycle= 2 E= -128.536083111113  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280053
diis-c [-6.20001304e-04  3.38156731e-01  6.61843269e-01]
  HOMO = -0.849411816071913  LUMO = 0.575598927491464
  mo_energy =
[-3.27748375e+01 -1.93085587e+00 -8.49411816e-01 -8.49411816e-01
 -8.49411816e-01  5.75598927e-01  5.75598927e-01  5.75598927e-01
  1.18743023e+00  2.56709859e+00  2.56709859e+00  2.56709859e+00
  7.28788693e+00  8.43389331e+00  8.43389331e+00  8.43389331e+00
  2.77302193e+01  2.77302193e+01  2.77302193e+01  3.46137669e+01
  1.21957704e+02  1.21957704e+02  1.21957704e+02  1.38708587e+02
  5.02780493e+02  1.87039283e+03  8.00003936e+03  4.77676784e+04]
E1 = -182.56322731090964  E_coul = 54.02617016378858
cycle= 3 E= -128.537057147121  delta_E= -0.000974  |g|= 0.000385  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00082625
diis-c [-9.87418519e-08 -1.91998871e-03 -1.02285032e-03  1.00294284e+00]
  HOMO = -0.849624383407047  LUMO = 0.575585237665623
  mo_energy =
[-3.27751871e+01 -1.93102609e+00 -8.49624383e-01 -8.49624383e-01
 -8.49624383e-01  5.75585238e-01  5.75585238e-01  5.75585238e-01
  1.18736518e+00  2.56700378e+00  2.56700378e+00  2.56700378e+00
  7.28771321e+00  8.43370610e+00  8.43370610e+00  8.43370610e+00
  2.77299465e+01  2.77299465e+01  2.77299465e+01  3.46134932e+01
  1.21957344e+02  1.21957344e+02  1.21957344e+02  1.38708237e+02
  5.02780051e+02  1.87039229e+03  8.00003874e+03  4.77676777e+04]
E1 = -182.56340798771143  E_coul = 54.02635082518842
cycle= 4 E= -128.537057162523  delta_E= -1.54e-08  |g|= 6.95e-05  |ddm|= 0.000226
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000166619
diis-c [-6.57244848e-10  1.07409829e-04  4.91992156e-04 -1.35905068e-01
  1.13530567e+00]
  HOMO = -0.849663080989245  LUMO = 0.575577048866826
  mo_energy =
[-3.27752522e+01 -1.93106133e+00 -8.49663081e-01 -8.49663081e-01
 -8.49663081e-01  5.75577049e-01  5.75577049e-01  5.75577049e-01
  1.18734442e+00  2.56697580e+00  2.56697580e+00  2.56697580e+00
  7.28766978e+00  8.43365990e+00  8.43365990e+00  8.43365990e+00
  2.77298874e+01  2.77298874e+01  2.77298874e+01  3.46134336e+01
  1.21957279e+02  1.21957279e+02  1.21957279e+02  1.38708173e+02
  5.02779983e+02  1.87039221e+03  8.00003866e+03  4.77676777e+04]
E1 = -182.56352066309492  E_coul = 54.02646350008844
cycle= 5 E= -128.537057163006  delta_E= -4.83e-10  |g|= 2.46e-06  |ddm|= 3.44e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56352066309492  E_coul = 54.02646350008844
  HOMO = -0.849662221288041  LUMO = 0.575577125956689
  mo_energy =
[-3.27752500e+01 -1.93106016e+00 -8.49662221e-01 -8.49662221e-01
 -8.49662221e-01  5.75577126e-01  5.75577126e-01  5.75577126e-01
  1.18734483e+00  2.56697626e+00  2.56697626e+00  2.56697626e+00
  7.28767105e+00  8.43366104e+00  8.43366104e+00  8.43366104e+00
  2.77298893e+01  2.77298893e+01  2.77298893e+01  3.46134357e+01
  1.21957281e+02  1.21957281e+02  1.21957281e+02  1.38708175e+02
  5.02779984e+02  1.87039221e+03  8.00003867e+03  4.77676777e+04]
E1 = -182.56351334275774  E_coul = 54.02645617975075
Extra cycle  E= -128.537057163007  delta_E= -5.12e-13  |g|= 9.68e-07  |ddm|= 1.34e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.93448988359677
E1 = -182.56351334275774  E_coul = 54.02645617975075
init E= -128.537057163007
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.849662761518205  LUMO = 0.575577035232098
  mo_energy =
[-3.27752515e+01 -1.93106068e+00 -8.49662762e-01 -8.49662762e-01
 -8.49662762e-01  5.75577035e-01  5.75577035e-01  5.75577035e-01
  1.18734461e+00  2.56697592e+00  2.56697592e+00  2.56697592e+00
  7.28767043e+00  8.43366035e+00  8.43366035e+00  8.43366035e+00
  2.77298882e+01  2.77298882e+01  2.77298882e+01  3.46134345e+01
  1.21957280e+02  1.21957280e+02  1.21957280e+02  1.38708173e+02
  5.02779983e+02  1.87039221e+03  8.00003866e+03  4.77676777e+04]
E1 = -182.5635168609971  E_coul = 54.026459697990056
cycle= 1 E= -128.537057163007  delta_E= -8.53e-14  |g|= 4.88e-07  |ddm|= 2.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5635168609971  E_coul = 54.026459697990056
  HOMO = -0.84966251656971  LUMO = 0.575577070763928
  mo_energy =
[-3.27752508e+01 -1.93106042e+00 -8.49662517e-01 -8.49662517e-01
 -8.49662517e-01  5.75577071e-01  5.75577071e-01  5.75577071e-01
  1.18734471e+00  2.56697606e+00  2.56697606e+00  2.56697606e+00
  7.28767074e+00  8.43366067e+00  8.43366067e+00  8.43366067e+00
  2.77298888e+01  2.77298888e+01  2.77298888e+01  3.46134351e+01
  1.21957280e+02  1.21957280e+02  1.21957280e+02  1.38708174e+02
  5.02779984e+02  1.87039221e+03  8.00003866e+03  4.77676777e+04]
E1 = -182.56351499816148  E_coul = 54.02645783515406
Extra cycle  E= -128.537057163007  delta_E= -3.69e-13  |g|= 2.51e-07  |ddm|= 1.61e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271051e+02 2.35734823e+02
 7.64325078e+01 1.00366397e+01 2.70500881e+01 3.81478977e-01
 1.11714730e+00 2.88166977e+00 4.06772233e+00 1.24575196e+01
 5.47832317e+01 2.08770619e-01 1.52828956e+00 5.81495104e-01]
grad_E = [ 3.83193915e-11 -2.02515279e-09  4.83438094e-08 -7.16428096e-07
  4.59196421e-06  1.47589241e-06  3.46382816e-06 -7.06025932e-06
 -4.04699980e-06  4.28525622e-06 -5.32612535e-04 -1.59909958e-03
  1.02070213e-04 -5.37555098e-04  4.87095623e-04  6.98855687e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447027        1
[INPUT] 0    0    [1    /1   ]  833.271050449        1
[INPUT] 0    0    [1    /1   ]  235.734835404        1
[INPUT] 0    0    [1    /1   ]  76.4324288375        1
[INPUT] 0    0    [1    /1   ]  10.0366169988        1
[INPUT] 0    0    [1    /1   ]  27.0500251732        1
[INPUT] 0    0    [1    /1   ]  0.381490269756       1
[INPUT] 0    0    [1    /1   ]  1.11719908795        1
[INPUT] 0    0    [1    /1   ]  2.88160088934        1
[INPUT] 1    0    [1    /1   ]  4.07926479302        1
[INPUT] 1    0    [1    /1   ]  12.4797063043        1
[INPUT] 1    0    [1    /1   ]  54.7817833651        1
[INPUT] 1    0    [1    /1   ]  0.212932024914       1
[INPUT] 1    0    [1    /1   ]  1.54660181923        1
[INPUT] 1    0    [1    /1   ]  0.595183443096       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129985312, 1.0]], [0, [3661.4544702710978, 1.0]], [0, [833.2710504486707, 1.0]], [0, [235.73483540397598, 1.0]], [0, [76.43242883751907, 1.0]], [0, [10.036616998794148, 1.0]], [0, [27.050025173246425, 1.0]], [0, [0.3814902697558587, 1.0]], [0, [1.1171990879517766, 1.0]], [0, [2.881600889338571, 1.0]], [1, [4.079264793021646, 1.0]], [1, [12.479706304329959, 1.0]], [1, [54.78178336514024, 1.0]], [1, [0.21293202491446608, 1.0]], [1, [1.5466018192265105, 1.0]], [1, [0.5951834430955427, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447027]
bas 2, expnt(s) = [833.27105045]
bas 3, expnt(s) = [235.7348354]
bas 4, expnt(s) = [76.43242884]
bas 5, expnt(s) = [10.036617]
bas 6, expnt(s) = [27.05002517]
bas 7, expnt(s) = [0.38149027]
bas 8, expnt(s) = [1.11719909]
bas 9, expnt(s) = [2.88160089]
bas 10, expnt(s) = [4.07926479]
bas 11, expnt(s) = [12.4797063]
bas 12, expnt(s) = [54.78178337]
bas 13, expnt(s) = [0.21293202]
bas 14, expnt(s) = [1.54660182]
bas 15, expnt(s) = [0.59518344]
CPU time:        55.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271050e+02 3.91836370e+02 2.35734835e+02 1.51996241e+02
 7.64324288e+01 6.53090355e+01 1.00366170e+01 1.42464133e+01
 2.70500252e+01 2.99668283e+01 3.81490270e-01 1.22638724e+00
 1.11719909e+00 2.74544630e+00 2.88160089e+00 5.58779412e+00
 4.07926479e+00 1.69126540e+01 1.24797063e+01 6.84289457e+01
 5.47817834e+01 4.34790053e+02 2.12932025e-01 4.21973932e-01
 1.54660182e+00 5.03161657e+00 5.95183443e-01 1.52509868e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999855460288845
cond(S) = 343.9448173661845
E1 = -183.58431416680122  E_coul = 55.079590771893876
init E= -128.504723394907
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774747505812984  LUMO = 0.600945767723082
  mo_energy =
[-3.25553179e+01 -1.85260173e+00 -7.74747506e-01 -7.74747506e-01
 -7.74747506e-01  6.00945768e-01  6.00945768e-01  6.00945768e-01
  1.21934120e+00  2.66881388e+00  2.66881388e+00  2.66881388e+00
  7.37882344e+00  8.64759491e+00  8.64759491e+00  8.64759491e+00
  2.80688745e+01  2.80688745e+01  2.80688745e+01  3.47813397e+01
  1.22373599e+02  1.22373599e+02  1.22373599e+02  1.38924516e+02
  5.03029686e+02  1.87067282e+03  8.00034595e+03  4.77680030e+04]
E1 = -182.04721128219484  E_coul = 53.51379717989811
cycle= 1 E= -128.533414102297  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547084
diis-c [-0.29930049  1.        ]
  HOMO = -0.885954797202909  LUMO = 0.583696041347184
  mo_energy =
[-3.28853675e+01 -1.96935693e+00 -8.85954797e-01 -8.85954797e-01
 -8.85954797e-01  5.83696041e-01  5.83696041e-01  5.83696041e-01
  1.17241796e+00  2.60134299e+00  2.60134299e+00  2.60134299e+00
  7.24359087e+00  8.50313854e+00  8.50313854e+00  8.50313854e+00
  2.78273158e+01  2.78273158e+01  2.78273158e+01  3.45290037e+01
  1.22042736e+02  1.22042736e+02  1.22042736e+02  1.38599787e+02
  5.02660497e+02  1.87026743e+03  7.99991150e+03  4.77675497e+04]
E1 = -182.83021131923735  E_coul = 54.29410659012053
cycle= 2 E= -128.536104729117  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0622
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280252
diis-c [-6.20304003e-04  3.38085327e-01  6.61914673e-01]
  HOMO = -0.849380224352566  LUMO = 0.589376857139638
  mo_energy =
[-3.27747575e+01 -1.93081381e+00 -8.49380224e-01 -8.49380224e-01
 -8.49380224e-01  5.89376857e-01  5.89376857e-01  5.89376857e-01
  1.18750918e+00  2.62320019e+00  2.62320019e+00  2.62320019e+00
  7.28805437e+00  8.55074276e+00  8.55074276e+00  8.55074276e+00
  2.79081975e+01  2.79081975e+01  2.79081975e+01  3.46137817e+01
  1.22152894e+02  1.22152894e+02  1.22152894e+02  1.38708366e+02
  5.02780048e+02  1.87039233e+03  8.00003891e+03  4.77676780e+04]
E1 = -182.56365557895808  E_coul = 54.02657838736494
cycle= 3 E= -128.537077191593  delta_E= -0.000972  |g|= 0.000391  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841044
diis-c [-1.00672727e-07 -1.93824130e-03 -1.00859400e-03  1.00294684e+00]
  HOMO = -0.84959563446212  LUMO = 0.589361535484725
  mo_energy =
[-3.27751119e+01 -1.93098719e+00 -8.49595634e-01 -8.49595634e-01
 -8.49595634e-01  5.89361535e-01  5.89361535e-01  5.89361535e-01
  1.18744173e+00  2.62310121e+00  2.62310121e+00  2.62310121e+00
  7.28787731e+00  8.55055140e+00  8.55055140e+00  8.55055140e+00
  2.79079204e+01  2.79079204e+01  2.79079204e+01  3.46135036e+01
  1.22152530e+02  1.22152530e+02  1.22152530e+02  1.38708011e+02
  5.02779601e+02  1.87039178e+03  8.00003828e+03  4.77676774e+04]
E1 = -182.56384161520782  E_coul = 54.02676440765306
cycle= 4 E= -128.537077207555  delta_E= -1.6e-08  |g|= 7.05e-05  |ddm|= 0.000229
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000168999
diis-c [-6.51565342e-10  1.08656014e-04  4.95858260e-04 -1.36321866e-01
  1.13571735e+00]
  HOMO = -0.849634831590174  LUMO = 0.589352967017829
  mo_energy =
[-3.27751779e+01 -1.93102303e+00 -8.49634832e-01 -8.49634832e-01
 -8.49634832e-01  5.89352967e-01  5.89352967e-01  5.89352967e-01
  1.18742059e+00  2.62307251e+00  2.62307251e+00  2.62307251e+00
  7.28783327e+00  8.55050449e+00  8.55050449e+00  8.55050449e+00
  2.79078604e+01  2.79078604e+01  2.79078604e+01  3.46134432e+01
  1.22152464e+02  1.22152464e+02  1.22152464e+02  1.38707946e+02
  5.02779532e+02  1.87039171e+03  8.00003820e+03  4.77676773e+04]
E1 = -182.5639556440134  E_coul = 54.026878435964086
cycle= 5 E= -128.537077208049  delta_E= -4.95e-10  |g|= 2.44e-06  |ddm|= 3.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5639556440134  E_coul = 54.026878435964086
  HOMO = -0.849633951174477  LUMO = 0.589353054354082
  mo_energy =
[-3.27751757e+01 -1.93102184e+00 -8.49633951e-01 -8.49633951e-01
 -8.49633951e-01  5.89353054e-01  5.89353054e-01  5.89353054e-01
  1.18742101e+00  2.62307298e+00  2.62307298e+00  2.62307298e+00
  7.28783457e+00  8.55050566e+00  8.55050566e+00  8.55050566e+00
  2.79078623e+01  2.79078623e+01  2.79078623e+01  3.46134453e+01
  1.22152466e+02  1.22152466e+02  1.22152466e+02  1.38707948e+02
  5.02779533e+02  1.87039171e+03  8.00003820e+03  4.77676773e+04]
E1 = -182.56394827164846  E_coul = 54.026871063599074
Extra cycle  E= -128.537077208049  delta_E= -5.68e-14  |g|= 9.75e-07  |ddm|= 1.29e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271050e+02 2.35734835e+02
 7.64324288e+01 1.00366170e+01 2.70500252e+01 3.81490270e-01
 1.11719909e+00 2.88160089e+00 4.07926479e+00 1.24797063e+01
 5.47817834e+01 2.12932025e-01 1.54660182e+00 5.95183443e-01]
E = -128.53707720804937
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447027        1
[INPUT] 0    0    [1    /1   ]  833.271050449        1
[INPUT] 0    0    [1    /1   ]  235.734835404        1
[INPUT] 0    0    [1    /1   ]  76.4324288375        1
[INPUT] 0    0    [1    /1   ]  10.0366169988        1
[INPUT] 0    0    [1    /1   ]  27.0500251732        1
[INPUT] 0    0    [1    /1   ]  0.381490269756       1
[INPUT] 0    0    [1    /1   ]  1.11719908795        1
[INPUT] 0    0    [1    /1   ]  2.88160088934        1
[INPUT] 1    0    [1    /1   ]  4.07926479302        1
[INPUT] 1    0    [1    /1   ]  12.4797063043        1
[INPUT] 1    0    [1    /1   ]  54.7817833651        1
[INPUT] 1    0    [1    /1   ]  0.212932024914       1
[INPUT] 1    0    [1    /1   ]  1.54660181923        1
[INPUT] 1    0    [1    /1   ]  0.595183443096       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129985312, 1.0]], [0, [3661.4544702710978, 1.0]], [0, [833.2710504486707, 1.0]], [0, [235.73483540397598, 1.0]], [0, [76.43242883751907, 1.0]], [0, [10.036616998794148, 1.0]], [0, [27.050025173246425, 1.0]], [0, [0.3814902697558587, 1.0]], [0, [1.1171990879517766, 1.0]], [0, [2.881600889338571, 1.0]], [1, [4.079264793021646, 1.0]], [1, [12.479706304329959, 1.0]], [1, [54.78178336514024, 1.0]], [1, [0.21293202491446608, 1.0]], [1, [1.5466018192265105, 1.0]], [1, [0.5951834430955427, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45447027]
bas 2, expnt(s) = [833.27105045]
bas 3, expnt(s) = [235.7348354]
bas 4, expnt(s) = [76.43242884]
bas 5, expnt(s) = [10.036617]
bas 6, expnt(s) = [27.05002517]
bas 7, expnt(s) = [0.38149027]
bas 8, expnt(s) = [1.11719909]
bas 9, expnt(s) = [2.88160089]
bas 10, expnt(s) = [4.07926479]
bas 11, expnt(s) = [12.4797063]
bas 12, expnt(s) = [54.78178337]
bas 13, expnt(s) = [0.21293202]
bas 14, expnt(s) = [1.54660182]
bas 15, expnt(s) = [0.59518344]
CPU time:        56.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271050e+02 3.91836370e+02 2.35734835e+02 1.51996241e+02
 7.64324288e+01 6.53090355e+01 1.00366170e+01 1.42464133e+01
 2.70500252e+01 2.99668283e+01 3.81490270e-01 1.22638724e+00
 1.11719909e+00 2.74544630e+00 2.88160089e+00 5.58779412e+00
 4.07926479e+00 1.69126540e+01 1.24797063e+01 6.84289457e+01
 5.47817834e+01 4.34790053e+02 2.12932025e-01 4.21973932e-01
 1.54660182e+00 5.03161657e+00 5.95183443e-01 1.52509868e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999855460288845
cond(S) = 343.9448173661845
E1 = -183.58431416680122  E_coul = 55.079590771893876
init E= -128.504723394907
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774747505812984  LUMO = 0.600945767723082
  mo_energy =
[-3.25553179e+01 -1.85260173e+00 -7.74747506e-01 -7.74747506e-01
 -7.74747506e-01  6.00945768e-01  6.00945768e-01  6.00945768e-01
  1.21934120e+00  2.66881388e+00  2.66881388e+00  2.66881388e+00
  7.37882344e+00  8.64759491e+00  8.64759491e+00  8.64759491e+00
  2.80688745e+01  2.80688745e+01  2.80688745e+01  3.47813397e+01
  1.22373599e+02  1.22373599e+02  1.22373599e+02  1.38924516e+02
  5.03029686e+02  1.87067282e+03  8.00034595e+03  4.77680030e+04]
E1 = -182.04721128219484  E_coul = 53.51379717989811
cycle= 1 E= -128.533414102297  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547084
diis-c [-0.29930049  1.        ]
  HOMO = -0.885954797202909  LUMO = 0.583696041347184
  mo_energy =
[-3.28853675e+01 -1.96935693e+00 -8.85954797e-01 -8.85954797e-01
 -8.85954797e-01  5.83696041e-01  5.83696041e-01  5.83696041e-01
  1.17241796e+00  2.60134299e+00  2.60134299e+00  2.60134299e+00
  7.24359087e+00  8.50313854e+00  8.50313854e+00  8.50313854e+00
  2.78273158e+01  2.78273158e+01  2.78273158e+01  3.45290037e+01
  1.22042736e+02  1.22042736e+02  1.22042736e+02  1.38599787e+02
  5.02660497e+02  1.87026743e+03  7.99991150e+03  4.77675497e+04]
E1 = -182.83021131923735  E_coul = 54.29410659012053
cycle= 2 E= -128.536104729117  delta_E= -0.00269  |g|= 0.107  |ddm|= 0.0622
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280252
diis-c [-6.20304003e-04  3.38085327e-01  6.61914673e-01]
  HOMO = -0.849380224352566  LUMO = 0.589376857139638
  mo_energy =
[-3.27747575e+01 -1.93081381e+00 -8.49380224e-01 -8.49380224e-01
 -8.49380224e-01  5.89376857e-01  5.89376857e-01  5.89376857e-01
  1.18750918e+00  2.62320019e+00  2.62320019e+00  2.62320019e+00
  7.28805437e+00  8.55074276e+00  8.55074276e+00  8.55074276e+00
  2.79081975e+01  2.79081975e+01  2.79081975e+01  3.46137817e+01
  1.22152894e+02  1.22152894e+02  1.22152894e+02  1.38708366e+02
  5.02780048e+02  1.87039233e+03  8.00003891e+03  4.77676780e+04]
E1 = -182.56365557895808  E_coul = 54.02657838736494
cycle= 3 E= -128.537077191593  delta_E= -0.000972  |g|= 0.000391  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841044
diis-c [-1.00672727e-07 -1.93824130e-03 -1.00859400e-03  1.00294684e+00]
  HOMO = -0.84959563446212  LUMO = 0.589361535484725
  mo_energy =
[-3.27751119e+01 -1.93098719e+00 -8.49595634e-01 -8.49595634e-01
 -8.49595634e-01  5.89361535e-01  5.89361535e-01  5.89361535e-01
  1.18744173e+00  2.62310121e+00  2.62310121e+00  2.62310121e+00
  7.28787731e+00  8.55055140e+00  8.55055140e+00  8.55055140e+00
  2.79079204e+01  2.79079204e+01  2.79079204e+01  3.46135036e+01
  1.22152530e+02  1.22152530e+02  1.22152530e+02  1.38708011e+02
  5.02779601e+02  1.87039178e+03  8.00003828e+03  4.77676774e+04]
E1 = -182.56384161520782  E_coul = 54.02676440765306
cycle= 4 E= -128.537077207555  delta_E= -1.6e-08  |g|= 7.05e-05  |ddm|= 0.000229
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000168999
diis-c [-6.51565342e-10  1.08656014e-04  4.95858260e-04 -1.36321866e-01
  1.13571735e+00]
  HOMO = -0.849634831590174  LUMO = 0.589352967017829
  mo_energy =
[-3.27751779e+01 -1.93102303e+00 -8.49634832e-01 -8.49634832e-01
 -8.49634832e-01  5.89352967e-01  5.89352967e-01  5.89352967e-01
  1.18742059e+00  2.62307251e+00  2.62307251e+00  2.62307251e+00
  7.28783327e+00  8.55050449e+00  8.55050449e+00  8.55050449e+00
  2.79078604e+01  2.79078604e+01  2.79078604e+01  3.46134432e+01
  1.22152464e+02  1.22152464e+02  1.22152464e+02  1.38707946e+02
  5.02779532e+02  1.87039171e+03  8.00003820e+03  4.77676773e+04]
E1 = -182.5639556440134  E_coul = 54.026878435964086
cycle= 5 E= -128.537077208049  delta_E= -4.95e-10  |g|= 2.44e-06  |ddm|= 3.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5639556440134  E_coul = 54.026878435964086
  HOMO = -0.849633951174477  LUMO = 0.589353054354082
  mo_energy =
[-3.27751757e+01 -1.93102184e+00 -8.49633951e-01 -8.49633951e-01
 -8.49633951e-01  5.89353054e-01  5.89353054e-01  5.89353054e-01
  1.18742101e+00  2.62307298e+00  2.62307298e+00  2.62307298e+00
  7.28783457e+00  8.55050566e+00  8.55050566e+00  8.55050566e+00
  2.79078623e+01  2.79078623e+01  2.79078623e+01  3.46134453e+01
  1.22152466e+02  1.22152466e+02  1.22152466e+02  1.38707948e+02
  5.02779533e+02  1.87039171e+03  8.00003820e+03  4.77676773e+04]
E1 = -182.56394827164846  E_coul = 54.026871063599074
Extra cycle  E= -128.537077208049  delta_E= -5.68e-14  |g|= 9.75e-07  |ddm|= 1.29e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9448173661845
E1 = -182.56394827164846  E_coul = 54.026871063599074
init E= -128.537077208049
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849634493911049  LUMO = 0.589352960901664
  mo_energy =
[-3.27751772e+01 -1.93102237e+00 -8.49634494e-01 -8.49634494e-01
 -8.49634494e-01  5.89352961e-01  5.89352961e-01  5.89352961e-01
  1.18742078e+00  2.62307265e+00  2.62307265e+00  2.62307265e+00
  7.28783394e+00  8.55050496e+00  8.55050496e+00  8.55050496e+00
  2.79078612e+01  2.79078612e+01  2.79078612e+01  3.46134441e+01
  1.22152464e+02  1.22152464e+02  1.22152464e+02  1.38707946e+02
  5.02779532e+02  1.87039171e+03  8.00003820e+03  4.77676773e+04]
E1 = -182.56395183251755  E_coul = 54.02687462446782
cycle= 1 E= -128.53707720805  delta_E= -3.41e-13  |g|= 4.93e-07  |ddm|= 2.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56395183251755  E_coul = 54.02687462446782
  HOMO = -0.849634245723732  LUMO = 0.589352998279925
  mo_energy =
[-3.27751765e+01 -1.93102210e+00 -8.49634246e-01 -8.49634246e-01
 -8.49634246e-01  5.89352998e-01  5.89352998e-01  5.89352998e-01
  1.18742089e+00  2.62307279e+00  2.62307279e+00  2.62307279e+00
  7.28783425e+00  8.55050529e+00  8.55050529e+00  8.55050529e+00
  2.79078618e+01  2.79078618e+01  2.79078618e+01  3.46134447e+01
  1.22152465e+02  1.22152465e+02  1.22152465e+02  1.38707947e+02
  5.02779533e+02  1.87039171e+03  8.00003820e+03  4.77676773e+04]
E1 = -182.5639499513189  E_coul = 54.02687274326918
Extra cycle  E= -128.53707720805  delta_E=    0  |g|= 2.54e-07  |ddm|= 1.62e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271050e+02 2.35734835e+02
 7.64324288e+01 1.00366170e+01 2.70500252e+01 3.81490270e-01
 1.11719909e+00 2.88160089e+00 4.07926479e+00 1.24797063e+01
 5.47817834e+01 2.12932025e-01 1.54660182e+00 5.95183443e-01]
grad_E = [ 3.80801949e-11 -2.01278319e-09  4.81133491e-08 -7.14234519e-07
  4.58020892e-06  1.23560842e-06  3.52283924e-06 -1.87994560e-05
  6.27262074e-06  3.10610290e-06 -7.52978124e-04 -1.51010902e-03
  9.42344923e-05 -1.72675070e-03  4.23544894e-04  1.96720030e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447034        1
[INPUT] 0    0    [1    /1   ]  833.271048751        1
[INPUT] 0    0    [1    /1   ]  235.734860561        1
[INPUT] 0    0    [1    /1   ]  76.4322680068        1
[INPUT] 0    0    [1    /1   ]  10.0365693119        1
[INPUT] 0    0    [1    /1   ]  27.049897963         1
[INPUT] 0    0    [1    /1   ]  0.381524370258       1
[INPUT] 0    0    [1    /1   ]  1.11732354486        1
[INPUT] 0    0    [1    /1   ]  2.8814559853         1
[INPUT] 1    0    [1    /1   ]  4.10382390178        1
[INPUT] 1    0    [1    /1   ]  12.5262321718        1
[INPUT] 1    0    [1    /1   ]  54.7787503563        1
[INPUT] 1    0    [1    /1   ]  0.218925216472       1
[INPUT] 1    0    [1    /1   ]  1.57442714795        1
[INPUT] 1    0    [1    /1   ]  0.61487591697        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129983966, 1.0]], [0, [3661.454470342171, 1.0]], [0, [833.2710487513364, 1.0]], [0, [235.73486056073543, 1.0]], [0, [76.43226800679905, 1.0]], [0, [10.036569311930299, 1.0]], [0, [27.049897963029334, 1.0]], [0, [0.3815243702579566, 1.0]], [0, [1.1173235448572538, 1.0]], [0, [2.8814559853047097, 1.0]], [1, [4.103823901778269, 1.0]], [1, [12.526232171795314, 1.0]], [1, [54.77875035626505, 1.0]], [1, [0.2189252164720392, 1.0]], [1, [1.5744271479495617, 1.0]], [1, [0.6148759169700032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412998]
bas 1, expnt(s) = [3661.45447034]
bas 2, expnt(s) = [833.27104875]
bas 3, expnt(s) = [235.73486056]
bas 4, expnt(s) = [76.43226801]
bas 5, expnt(s) = [10.03656931]
bas 6, expnt(s) = [27.04989796]
bas 7, expnt(s) = [0.38152437]
bas 8, expnt(s) = [1.11732354]
bas 9, expnt(s) = [2.88145599]
bas 10, expnt(s) = [4.1038239]
bas 11, expnt(s) = [12.52623217]
bas 12, expnt(s) = [54.77875036]
bas 13, expnt(s) = [0.21892522]
bas 14, expnt(s) = [1.57442715]
bas 15, expnt(s) = [0.61487592]
CPU time:        58.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271049e+02 3.91836370e+02 2.35734861e+02 1.51996253e+02
 7.64322680e+01 6.53089324e+01 1.00365693e+01 1.42463625e+01
 2.70498980e+01 2.99667226e+01 3.81524370e-01 1.22646946e+00
 1.11732354e+00 2.74567568e+00 2.88145599e+00 5.58758338e+00
 4.10382390e+00 1.70400274e+01 1.25262322e+01 6.87479835e+01
 5.47787504e+01 4.34759963e+02 2.18925216e-01 4.36871916e-01
 1.57442715e+00 5.14502637e+00 6.14875917e-01 1.58843244e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999838831402142
cond(S) = 343.97231819193155
E1 = -183.58436897762377  E_coul = 55.07960474755633
init E= -128.504764230067
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774752460522381  LUMO = 0.621487937797411
  mo_energy =
[-3.25553103e+01 -1.85260199e+00 -7.74752461e-01 -7.74752461e-01
 -7.74752461e-01  6.21487938e-01  6.21487938e-01  6.21487938e-01
  1.21950653e+00  2.75112710e+00  2.75112710e+00  2.75112710e+00
  7.37916616e+00  8.82498515e+00  8.82498515e+00  8.82498515e+00
  2.83678421e+01  2.83678421e+01  2.83678421e+01  3.47813557e+01
  1.22728270e+02  1.22728270e+02  1.22728270e+02  1.38924007e+02
  5.03028691e+02  1.87067169e+03  8.00034491e+03  4.77680021e+04]
E1 = -182.0487339183521  E_coul = 53.51527333398194
cycle= 1 E= -128.53346058437  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547753
diis-c [-0.30003357  1.        ]
  HOMO = -0.885849562764288  LUMO = 0.603419541422158
  mo_energy =
[-3.28850916e+01 -1.96922788e+00 -8.85849563e-01 -8.85849563e-01
 -8.85849563e-01  6.03419541e-01  6.03419541e-01  6.03419541e-01
  1.17263961e+00  2.68226390e+00  2.68226390e+00  2.68226390e+00
  7.24407894e+00  8.67997936e+00  8.67997936e+00  8.67997936e+00
  2.81263750e+01  2.81263750e+01  2.81263750e+01  3.45292364e+01
  1.22397751e+02  1.22397751e+02  1.22397751e+02  1.38599543e+02
  5.02659795e+02  1.87026660e+03  7.99991077e+03  4.77675491e+04]
E1 = -182.8305991628799  E_coul = 54.29445223161622
cycle= 2 E= -128.536146931264  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0622
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280442
diis-c [-6.20793268e-04  3.37962768e-01  6.62037232e-01]
  HOMO = -0.849324903690367  LUMO = 0.609362709270595
  mo_energy =
[-3.27746053e+01 -1.93073921e+00 -8.49324904e-01 -8.49324904e-01
 -8.49324904e-01  6.09362709e-01  6.09362709e-01  6.09362709e-01
  1.18770447e+00  2.70456498e+00  2.70456498e+00  2.70456498e+00
  7.28848158e+00  8.72775410e+00  8.72775410e+00  8.72775410e+00
  2.82071972e+01  2.82071972e+01  2.82071972e+01  3.46139133e+01
  1.22507762e+02  1.22507762e+02  1.22507762e+02  1.38708001e+02
  5.02779215e+02  1.87039137e+03  8.00003804e+03  4.77676773e+04]
E1 = -182.5644587690464  E_coul = 54.027342049647736
cycle= 3 E= -128.537116719399  delta_E= -0.00097  |g|= 0.000399  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000862937
diis-c [-1.02794396e-07 -1.96278958e-03 -9.80338790e-04  1.00294313e+00]
  HOMO = -0.849543893571826  LUMO = 0.609345192478748
  mo_energy =
[-3.27749663e+01 -1.93091638e+00 -8.49543894e-01 -8.49543894e-01
 -8.49543894e-01  6.09345192e-01  6.09345192e-01  6.09345192e-01
  1.18763423e+00  2.70446051e+00  2.70446051e+00  2.70446051e+00
  7.28830040e+00  8.72755721e+00  8.72755721e+00  8.72755721e+00
  2.82069142e+01  2.82069142e+01  2.82069142e+01  3.46136294e+01
  1.22507391e+02  1.22507391e+02  1.22507391e+02  1.38707639e+02
  5.02778761e+02  1.87039081e+03  8.00003740e+03  4.77676767e+04]
E1 = -182.56465549812089  E_coul = 54.027538762110936
cycle= 4 E= -128.53711673601  delta_E= -1.66e-08  |g|= 7.16e-05  |ddm|= 0.000233
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172209
diis-c [-6.44018679e-10  1.10485002e-04  5.00799175e-04 -1.36682436e-01
  1.13607115e+00]
  HOMO = -0.849583627644931  LUMO = 0.609336131157719
  mo_energy =
[-3.27750335e+01 -1.93095280e+00 -8.49583628e-01 -8.49583628e-01
 -8.49583628e-01  6.09336131e-01  6.09336131e-01  6.09336131e-01
  1.18761273e+00  2.70443091e+00  2.70443091e+00  2.70443091e+00
  7.28825574e+00  8.72750948e+00  8.72750948e+00  8.72750948e+00
  2.82068533e+01  2.82068533e+01  2.82068533e+01  3.46135680e+01
  1.22507324e+02  1.22507324e+02  1.22507324e+02  1.38707572e+02
  5.02778690e+02  1.87039074e+03  8.00003732e+03  4.77676766e+04]
E1 = -182.56477162367045  E_coul = 54.027654887155485
cycle= 5 E= -128.537116736515  delta_E= -5.05e-10  |g|= 2.41e-06  |ddm|= 3.48e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56477162367045  E_coul = 54.027654887155485
  HOMO = -0.849582718539505  LUMO = 0.609336235177756
  mo_energy =
[-3.27750312e+01 -1.93095160e+00 -8.49582719e-01 -8.49582719e-01
 -8.49582719e-01  6.09336235e-01  6.09336235e-01  6.09336235e-01
  1.18761317e+00  2.70443143e+00  2.70443143e+00  2.70443143e+00
  7.28825707e+00  8.72751069e+00  8.72751069e+00  8.72751069e+00
  2.82068552e+01  2.82068552e+01  2.82068552e+01  3.46135702e+01
  1.22507326e+02  1.22507326e+02  1.22507326e+02  1.38707574e+02
  5.02778691e+02  1.87039074e+03  8.00003733e+03  4.77676766e+04]
E1 = -182.56476423425042  E_coul = 54.02764749773506
Extra cycle  E= -128.537116736515  delta_E= -3.98e-13  |g|= 9.79e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271049e+02 2.35734861e+02
 7.64322680e+01 1.00365693e+01 2.70498980e+01 3.81524370e-01
 1.11732354e+00 2.88145599e+00 4.10382390e+00 1.25262322e+01
 5.47787504e+01 2.18925216e-01 1.57442715e+00 6.14875917e-01]
E = -128.53711673651537
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447034        1
[INPUT] 0    0    [1    /1   ]  833.271048751        1
[INPUT] 0    0    [1    /1   ]  235.734860561        1
[INPUT] 0    0    [1    /1   ]  76.4322680068        1
[INPUT] 0    0    [1    /1   ]  10.0365693119        1
[INPUT] 0    0    [1    /1   ]  27.049897963         1
[INPUT] 0    0    [1    /1   ]  0.381524370258       1
[INPUT] 0    0    [1    /1   ]  1.11732354486        1
[INPUT] 0    0    [1    /1   ]  2.8814559853         1
[INPUT] 1    0    [1    /1   ]  4.10382390178        1
[INPUT] 1    0    [1    /1   ]  12.5262321718        1
[INPUT] 1    0    [1    /1   ]  54.7787503563        1
[INPUT] 1    0    [1    /1   ]  0.218925216472       1
[INPUT] 1    0    [1    /1   ]  1.57442714795        1
[INPUT] 1    0    [1    /1   ]  0.61487591697        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129983966, 1.0]], [0, [3661.454470342171, 1.0]], [0, [833.2710487513364, 1.0]], [0, [235.73486056073543, 1.0]], [0, [76.43226800679905, 1.0]], [0, [10.036569311930299, 1.0]], [0, [27.049897963029334, 1.0]], [0, [0.3815243702579566, 1.0]], [0, [1.1173235448572538, 1.0]], [0, [2.8814559853047097, 1.0]], [1, [4.103823901778269, 1.0]], [1, [12.526232171795314, 1.0]], [1, [54.77875035626505, 1.0]], [1, [0.2189252164720392, 1.0]], [1, [1.5744271479495617, 1.0]], [1, [0.6148759169700032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412998]
bas 1, expnt(s) = [3661.45447034]
bas 2, expnt(s) = [833.27104875]
bas 3, expnt(s) = [235.73486056]
bas 4, expnt(s) = [76.43226801]
bas 5, expnt(s) = [10.03656931]
bas 6, expnt(s) = [27.04989796]
bas 7, expnt(s) = [0.38152437]
bas 8, expnt(s) = [1.11732354]
bas 9, expnt(s) = [2.88145599]
bas 10, expnt(s) = [4.1038239]
bas 11, expnt(s) = [12.52623217]
bas 12, expnt(s) = [54.77875036]
bas 13, expnt(s) = [0.21892522]
bas 14, expnt(s) = [1.57442715]
bas 15, expnt(s) = [0.61487592]
CPU time:        59.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271049e+02 3.91836370e+02 2.35734861e+02 1.51996253e+02
 7.64322680e+01 6.53089324e+01 1.00365693e+01 1.42463625e+01
 2.70498980e+01 2.99667226e+01 3.81524370e-01 1.22646946e+00
 1.11732354e+00 2.74567568e+00 2.88145599e+00 5.58758338e+00
 4.10382390e+00 1.70400274e+01 1.25262322e+01 6.87479835e+01
 5.47787504e+01 4.34759963e+02 2.18925216e-01 4.36871916e-01
 1.57442715e+00 5.14502637e+00 6.14875917e-01 1.58843244e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999838831402142
cond(S) = 343.97231819193155
E1 = -183.58436897762377  E_coul = 55.07960474755633
init E= -128.504764230067
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774752460522381  LUMO = 0.621487937797411
  mo_energy =
[-3.25553103e+01 -1.85260199e+00 -7.74752461e-01 -7.74752461e-01
 -7.74752461e-01  6.21487938e-01  6.21487938e-01  6.21487938e-01
  1.21950653e+00  2.75112710e+00  2.75112710e+00  2.75112710e+00
  7.37916616e+00  8.82498515e+00  8.82498515e+00  8.82498515e+00
  2.83678421e+01  2.83678421e+01  2.83678421e+01  3.47813557e+01
  1.22728270e+02  1.22728270e+02  1.22728270e+02  1.38924007e+02
  5.03028691e+02  1.87067169e+03  8.00034491e+03  4.77680021e+04]
E1 = -182.0487339183521  E_coul = 53.51527333398194
cycle= 1 E= -128.53346058437  delta_E= -0.0287  |g|= 0.209  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547753
diis-c [-0.30003357  1.        ]
  HOMO = -0.885849562764288  LUMO = 0.603419541422158
  mo_energy =
[-3.28850916e+01 -1.96922788e+00 -8.85849563e-01 -8.85849563e-01
 -8.85849563e-01  6.03419541e-01  6.03419541e-01  6.03419541e-01
  1.17263961e+00  2.68226390e+00  2.68226390e+00  2.68226390e+00
  7.24407894e+00  8.67997936e+00  8.67997936e+00  8.67997936e+00
  2.81263750e+01  2.81263750e+01  2.81263750e+01  3.45292364e+01
  1.22397751e+02  1.22397751e+02  1.22397751e+02  1.38599543e+02
  5.02659795e+02  1.87026660e+03  7.99991077e+03  4.77675491e+04]
E1 = -182.8305991628799  E_coul = 54.29445223161622
cycle= 2 E= -128.536146931264  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0622
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280442
diis-c [-6.20793268e-04  3.37962768e-01  6.62037232e-01]
  HOMO = -0.849324903690367  LUMO = 0.609362709270595
  mo_energy =
[-3.27746053e+01 -1.93073921e+00 -8.49324904e-01 -8.49324904e-01
 -8.49324904e-01  6.09362709e-01  6.09362709e-01  6.09362709e-01
  1.18770447e+00  2.70456498e+00  2.70456498e+00  2.70456498e+00
  7.28848158e+00  8.72775410e+00  8.72775410e+00  8.72775410e+00
  2.82071972e+01  2.82071972e+01  2.82071972e+01  3.46139133e+01
  1.22507762e+02  1.22507762e+02  1.22507762e+02  1.38708001e+02
  5.02779215e+02  1.87039137e+03  8.00003804e+03  4.77676773e+04]
E1 = -182.5644587690464  E_coul = 54.027342049647736
cycle= 3 E= -128.537116719399  delta_E= -0.00097  |g|= 0.000399  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000862937
diis-c [-1.02794396e-07 -1.96278958e-03 -9.80338790e-04  1.00294313e+00]
  HOMO = -0.849543893571826  LUMO = 0.609345192478748
  mo_energy =
[-3.27749663e+01 -1.93091638e+00 -8.49543894e-01 -8.49543894e-01
 -8.49543894e-01  6.09345192e-01  6.09345192e-01  6.09345192e-01
  1.18763423e+00  2.70446051e+00  2.70446051e+00  2.70446051e+00
  7.28830040e+00  8.72755721e+00  8.72755721e+00  8.72755721e+00
  2.82069142e+01  2.82069142e+01  2.82069142e+01  3.46136294e+01
  1.22507391e+02  1.22507391e+02  1.22507391e+02  1.38707639e+02
  5.02778761e+02  1.87039081e+03  8.00003740e+03  4.77676767e+04]
E1 = -182.56465549812089  E_coul = 54.027538762110936
cycle= 4 E= -128.53711673601  delta_E= -1.66e-08  |g|= 7.16e-05  |ddm|= 0.000233
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172209
diis-c [-6.44018679e-10  1.10485002e-04  5.00799175e-04 -1.36682436e-01
  1.13607115e+00]
  HOMO = -0.849583627644931  LUMO = 0.609336131157719
  mo_energy =
[-3.27750335e+01 -1.93095280e+00 -8.49583628e-01 -8.49583628e-01
 -8.49583628e-01  6.09336131e-01  6.09336131e-01  6.09336131e-01
  1.18761273e+00  2.70443091e+00  2.70443091e+00  2.70443091e+00
  7.28825574e+00  8.72750948e+00  8.72750948e+00  8.72750948e+00
  2.82068533e+01  2.82068533e+01  2.82068533e+01  3.46135680e+01
  1.22507324e+02  1.22507324e+02  1.22507324e+02  1.38707572e+02
  5.02778690e+02  1.87039074e+03  8.00003732e+03  4.77676766e+04]
E1 = -182.56477162367045  E_coul = 54.027654887155485
cycle= 5 E= -128.537116736515  delta_E= -5.05e-10  |g|= 2.41e-06  |ddm|= 3.48e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56477162367045  E_coul = 54.027654887155485
  HOMO = -0.849582718539505  LUMO = 0.609336235177756
  mo_energy =
[-3.27750312e+01 -1.93095160e+00 -8.49582719e-01 -8.49582719e-01
 -8.49582719e-01  6.09336235e-01  6.09336235e-01  6.09336235e-01
  1.18761317e+00  2.70443143e+00  2.70443143e+00  2.70443143e+00
  7.28825707e+00  8.72751069e+00  8.72751069e+00  8.72751069e+00
  2.82068552e+01  2.82068552e+01  2.82068552e+01  3.46135702e+01
  1.22507326e+02  1.22507326e+02  1.22507326e+02  1.38707574e+02
  5.02778691e+02  1.87039074e+03  8.00003733e+03  4.77676766e+04]
E1 = -182.56476423425042  E_coul = 54.02764749773506
Extra cycle  E= -128.537116736515  delta_E= -3.98e-13  |g|= 9.79e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.97231819193155
E1 = -182.56476423425042  E_coul = 54.02764749773506
init E= -128.537116736515
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849583260979902  LUMO = 0.609336138668456
  mo_energy =
[-3.27750327e+01 -1.93095212e+00 -8.49583261e-01 -8.49583261e-01
 -8.49583261e-01  6.09336139e-01  6.09336139e-01  6.09336139e-01
  1.18761295e+00  2.70443108e+00  2.70443108e+00  2.70443108e+00
  7.28825644e+00  8.72750999e+00  8.72750999e+00  8.72750999e+00
  2.82068541e+01  2.82068541e+01  2.82068541e+01  3.46135690e+01
  1.22507324e+02  1.22507324e+02  1.22507324e+02  1.38707573e+02
  5.02778690e+02  1.87039074e+03  8.00003732e+03  4.77676766e+04]
E1 = -182.56476783607278  E_coul = 54.02765109955774
cycle= 1 E= -128.537116736515  delta_E= 3.41e-13  |g|= 4.98e-07  |ddm|= 2.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56476783607278  E_coul = 54.02765109955774
  HOMO = -0.849583009638385  LUMO = 0.609336178580737
  mo_energy =
[-3.27750319e+01 -1.93095185e+00 -8.49583010e-01 -8.49583010e-01
 -8.49583010e-01  6.09336179e-01  6.09336179e-01  6.09336179e-01
  1.18761305e+00  2.70443123e+00  2.70443123e+00  2.70443123e+00
  7.28825675e+00  8.72751032e+00  8.72751032e+00  8.72751032e+00
  2.82068547e+01  2.82068547e+01  2.82068547e+01  3.46135696e+01
  1.22507325e+02  1.22507325e+02  1.22507325e+02  1.38707574e+02
  5.02778691e+02  1.87039074e+03  8.00003732e+03  4.77676766e+04]
E1 = -182.56476594097282  E_coul = 54.02764920445739
Extra cycle  E= -128.537116736515  delta_E= -3.98e-13  |g|= 2.56e-07  |ddm|= 1.63e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271049e+02 2.35734861e+02
 7.64322680e+01 1.00365693e+01 2.70498980e+01 3.81524370e-01
 1.11732354e+00 2.88145599e+00 4.10382390e+00 1.25262322e+01
 5.47787504e+01 2.18925216e-01 1.57442715e+00 6.14875917e-01]
grad_E = [ 3.76091675e-11 -1.98841374e-09  4.76605848e-08 -7.09930642e-07
  4.55695302e-06  6.42993376e-07  3.65315095e-06 -3.26239857e-05
  2.30583991e-05  5.96657209e-07 -9.17814303e-04 -1.39651106e-03
  8.13484672e-05 -3.11932974e-03  2.06132995e-04  3.55630893e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447051        1
[INPUT] 0    0    [1    /1   ]  833.271044838        1
[INPUT] 0    0    [1    /1   ]  235.734918558        1
[INPUT] 0    0    [1    /1   ]  76.4318970724        1
[INPUT] 0    0    [1    /1   ]  10.0364585972        1
[INPUT] 0    0    [1    /1   ]  27.049606388         1
[INPUT] 0    0    [1    /1   ]  0.381618880902       1
[INPUT] 0    0    [1    /1   ]  1.11762933374        1
[INPUT] 0    0    [1    /1   ]  2.88112014276        1
[INPUT] 1    0    [1    /1   ]  4.1593414385         1
[INPUT] 1    0    [1    /1   ]  12.6366065129        1
[INPUT] 1    0    [1    /1   ]  54.7715824408        1
[INPUT] 1    0    [1    /1   ]  0.228529641933       1
[INPUT] 1    0    [1    /1   ]  1.62312880135        1
[INPUT] 1    0    [1    /1   ]  0.647074196943       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129980866, 1.0]], [0, [3661.4544705060184, 1.0]], [0, [833.271044838458, 1.0]], [0, [235.73491855782166, 1.0]], [0, [76.43189707238011, 1.0]], [0, [10.036458597202719, 1.0]], [0, [27.04960638798825, 1.0]], [0, [0.3816188809018877, 1.0]], [0, [1.1176293337392582, 1.0]], [0, [2.881120142763722, 1.0]], [1, [4.159341438501067, 1.0]], [1, [12.636606512911328, 1.0]], [1, [54.77158244080402, 1.0]], [1, [0.2285296419333528, 1.0]], [1, [1.6231288013490168, 1.0]], [1, [0.6470741969428082, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412998]
bas 1, expnt(s) = [3661.45447051]
bas 2, expnt(s) = [833.27104484]
bas 3, expnt(s) = [235.73491856]
bas 4, expnt(s) = [76.43189707]
bas 5, expnt(s) = [10.0364586]
bas 6, expnt(s) = [27.04960639]
bas 7, expnt(s) = [0.38161888]
bas 8, expnt(s) = [1.11762933]
bas 9, expnt(s) = [2.88112014]
bas 10, expnt(s) = [4.15934144]
bas 11, expnt(s) = [12.63660651]
bas 12, expnt(s) = [54.77158244]
bas 13, expnt(s) = [0.22852964]
bas 14, expnt(s) = [1.6231288]
bas 15, expnt(s) = [0.6470742]
CPU time:        62.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271045e+02 3.91836368e+02 2.35734919e+02 1.51996281e+02
 7.64318971e+01 6.53086947e+01 1.00364586e+01 1.42462446e+01
 2.70496064e+01 2.99664803e+01 3.81618881e-01 1.22669731e+00
 1.11762933e+00 2.74623924e+00 2.88112014e+00 5.58709493e+00
 4.15934144e+00 1.73286651e+01 1.26366065e+01 6.95060279e+01
 5.47715824e+01 4.34688853e+02 2.28529642e-01 4.60959284e-01
 1.62312880e+00 5.34472818e+00 6.47074197e-01 1.69307811e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999805135040194
cond(S) = 344.0437408410609
E1 = -183.58448388452246  E_coul = 55.07963322610258
init E= -128.50485065842
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774763746006801  LUMO = 0.654961390056735
  mo_energy =
[-3.25552945e+01 -1.85260283e+00 -7.74763746e-01 -7.74763746e-01
 -7.74763746e-01  6.54961390e-01  6.54961390e-01  6.54961390e-01
  1.21993099e+00  2.88651759e+00  2.88651759e+00  2.88651759e+00
  7.38008054e+00  9.13243547e+00  9.13243547e+00  9.13243547e+00
  2.89467869e+01  2.89467869e+01  2.89467869e+01  3.47815369e+01
  1.23471024e+02  1.23471024e+02  1.23471024e+02  1.38922961e+02
  5.03026511e+02  1.87066920e+03  8.00034261e+03  4.77680002e+04]
E1 = -182.0518304387315  E_coul = 53.518268859108176
cycle= 1 E= -128.533561579623  delta_E= -0.0287  |g|= 0.208  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548421
diis-c [-0.30076543  1.        ]
  HOMO = -0.885639592073262  LUMO = 0.635571317730382
  mo_energy =
[-3.28845221e+01 -1.96896860e+00 -8.85639592e-01 -8.85639592e-01
 -8.85639592e-01  6.35571318e-01  6.35571318e-01  6.35571318e-01
  1.17318043e+00  2.81538882e+00  2.81538882e+00  2.81538882e+00
  7.24528580e+00  8.98630798e+00  8.98630798e+00  8.98630798e+00
  2.87052898e+01  2.87052898e+01  2.87052898e+01  3.45298607e+01
  1.23141183e+02  1.23141183e+02  1.23141183e+02  1.38599045e+02
  5.02658221e+02  1.87026474e+03  7.99990911e+03  4.77675478e+04]
E1 = -182.83148420559368  E_coul = 54.2952448336731
cycle= 2 E= -128.536239371921  delta_E= -0.00268  |g|= 0.106  |ddm|= 0.0622
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.28048
diis-c [-6.21855889e-04  3.37719405e-01  6.62280595e-01]
  HOMO = -0.849211743595634  LUMO = 0.641938674982048
  mo_energy =
[-3.27742775e+01 -1.93058523e+00 -8.49211744e-01 -8.49211744e-01
 -8.49211744e-01  6.41938675e-01  6.41938675e-01  6.41938675e-01
  1.18819660e+00  2.83841407e+00  2.83841407e+00  2.83841407e+00
  7.28957025e+00  9.03443535e+00  9.03443535e+00  9.03443535e+00
  2.87860744e+01  2.87860744e+01  2.87860744e+01  3.46143402e+01
  1.23250915e+02  1.23250915e+02  1.23250915e+02  1.38707264e+02
  5.02777384e+02  1.87038924e+03  8.00003610e+03  4.77676758e+04]
E1 = -182.56617851811433  E_coul = 54.028974670558895
cycle= 3 E= -128.537203847555  delta_E= -0.000964  |g|= 0.000412  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000900688
diis-c [-1.05271674e-07 -2.00111641e-03 -9.19209627e-04  1.00292033e+00]
  HOMO = -0.849435935957743  LUMO = 0.641917795310999
  mo_energy =
[-3.27746493e+01 -1.93076748e+00 -8.49435936e-01 -8.49435936e-01
 -8.49435936e-01  6.41917795e-01  6.41917795e-01  6.41917795e-01
  1.18812283e+00  2.83830131e+00  2.83830131e+00  2.83830131e+00
  7.28938323e+00  9.03422988e+00  9.03422988e+00  9.03422988e+00
  2.87857817e+01  2.87857817e+01  2.87857817e+01  3.46140473e+01
  1.23250532e+02  1.23250532e+02  1.23250532e+02  1.38706892e+02
  5.02776917e+02  1.87038867e+03  8.00003545e+03  4.77676751e+04]
E1 = -182.566398950564  E_coul = 54.029195085596115
cycle= 4 E= -128.537203864968  delta_E= -1.74e-08  |g|= 7.31e-05  |ddm|= 0.000237
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176949
diis-c [-6.33247110e-10  1.13913828e-04  5.07403249e-04 -1.36977368e-01
  1.13635605e+00]
  HOMO = -0.849476233425055  LUMO = 0.641908032650582
  mo_energy =
[-3.27747180e+01 -1.93080439e+00 -8.49476233e-01 -8.49476233e-01
 -8.49476233e-01  6.41908033e-01  6.41908033e-01  6.41908033e-01
  1.18810108e+00  2.83827055e+00  2.83827055e+00  2.83827055e+00
  7.28933801e+00  9.03418116e+00  9.03418116e+00  9.03418116e+00
  2.87857197e+01  2.87857197e+01  2.87857197e+01  3.46139848e+01
  1.23250464e+02  1.23250464e+02  1.23250464e+02  1.38706824e+02
  5.02776845e+02  1.87038859e+03  8.00003537e+03  4.77676750e+04]
E1 = -182.56651865407966  E_coul = 54.02931478859749
cycle= 5 E= -128.537203865482  delta_E= -5.14e-10  |g|= 2.4e-06  |ddm|= 3.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56651865407966  E_coul = 54.02931478859749
  HOMO = -0.849475276747588  LUMO = 0.641908167870247
  mo_energy =
[-3.27747156e+01 -1.93080312e+00 -8.49475277e-01 -8.49475277e-01
 -8.49475277e-01  6.41908168e-01  6.41908168e-01  6.41908168e-01
  1.18810156e+00  2.83827113e+00  2.83827113e+00  2.83827113e+00
  7.28933939e+00  9.03418244e+00  9.03418244e+00  9.03418244e+00
  2.87857217e+01  2.87857217e+01  2.87857217e+01  3.46139869e+01
  1.23250466e+02  1.23250466e+02  1.23250466e+02  1.38706826e+02
  5.02776846e+02  1.87038860e+03  8.00003537e+03  4.77676750e+04]
E1 = -182.56651131328852  E_coul = 54.029307447805635
Extra cycle  E= -128.537203865483  delta_E= -6.82e-13  |g|= 9.77e-07  |ddm|= 1.11e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271045e+02 2.35734919e+02
 7.64318971e+01 1.00364586e+01 2.70496064e+01 3.81618881e-01
 1.11762933e+00 2.88112014e+00 4.15934144e+00 1.26366065e+01
 5.47715824e+01 2.28529642e-01 1.62312880e+00 6.47074197e-01]
E = -128.53720386548287
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447051        1
[INPUT] 0    0    [1    /1   ]  833.271044838        1
[INPUT] 0    0    [1    /1   ]  235.734918558        1
[INPUT] 0    0    [1    /1   ]  76.4318970724        1
[INPUT] 0    0    [1    /1   ]  10.0364585972        1
[INPUT] 0    0    [1    /1   ]  27.049606388         1
[INPUT] 0    0    [1    /1   ]  0.381618880902       1
[INPUT] 0    0    [1    /1   ]  1.11762933374        1
[INPUT] 0    0    [1    /1   ]  2.88112014276        1
[INPUT] 1    0    [1    /1   ]  4.1593414385         1
[INPUT] 1    0    [1    /1   ]  12.6366065129        1
[INPUT] 1    0    [1    /1   ]  54.7715824408        1
[INPUT] 1    0    [1    /1   ]  0.228529641933       1
[INPUT] 1    0    [1    /1   ]  1.62312880135        1
[INPUT] 1    0    [1    /1   ]  0.647074196943       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129980866, 1.0]], [0, [3661.4544705060184, 1.0]], [0, [833.271044838458, 1.0]], [0, [235.73491855782166, 1.0]], [0, [76.43189707238011, 1.0]], [0, [10.036458597202719, 1.0]], [0, [27.04960638798825, 1.0]], [0, [0.3816188809018877, 1.0]], [0, [1.1176293337392582, 1.0]], [0, [2.881120142763722, 1.0]], [1, [4.159341438501067, 1.0]], [1, [12.636606512911328, 1.0]], [1, [54.77158244080402, 1.0]], [1, [0.2285296419333528, 1.0]], [1, [1.6231288013490168, 1.0]], [1, [0.6470741969428082, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412998]
bas 1, expnt(s) = [3661.45447051]
bas 2, expnt(s) = [833.27104484]
bas 3, expnt(s) = [235.73491856]
bas 4, expnt(s) = [76.43189707]
bas 5, expnt(s) = [10.0364586]
bas 6, expnt(s) = [27.04960639]
bas 7, expnt(s) = [0.38161888]
bas 8, expnt(s) = [1.11762933]
bas 9, expnt(s) = [2.88112014]
bas 10, expnt(s) = [4.15934144]
bas 11, expnt(s) = [12.63660651]
bas 12, expnt(s) = [54.77158244]
bas 13, expnt(s) = [0.22852964]
bas 14, expnt(s) = [1.6231288]
bas 15, expnt(s) = [0.6470742]
CPU time:        62.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271045e+02 3.91836368e+02 2.35734919e+02 1.51996281e+02
 7.64318971e+01 6.53086947e+01 1.00364586e+01 1.42462446e+01
 2.70496064e+01 2.99664803e+01 3.81618881e-01 1.22669731e+00
 1.11762933e+00 2.74623924e+00 2.88112014e+00 5.58709493e+00
 4.15934144e+00 1.73286651e+01 1.26366065e+01 6.95060279e+01
 5.47715824e+01 4.34688853e+02 2.28529642e-01 4.60959284e-01
 1.62312880e+00 5.34472818e+00 6.47074197e-01 1.69307811e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999805135040194
cond(S) = 344.0437408410609
E1 = -183.58448388452246  E_coul = 55.07963322610258
init E= -128.50485065842
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774763746006801  LUMO = 0.654961390056735
  mo_energy =
[-3.25552945e+01 -1.85260283e+00 -7.74763746e-01 -7.74763746e-01
 -7.74763746e-01  6.54961390e-01  6.54961390e-01  6.54961390e-01
  1.21993099e+00  2.88651759e+00  2.88651759e+00  2.88651759e+00
  7.38008054e+00  9.13243547e+00  9.13243547e+00  9.13243547e+00
  2.89467869e+01  2.89467869e+01  2.89467869e+01  3.47815369e+01
  1.23471024e+02  1.23471024e+02  1.23471024e+02  1.38922961e+02
  5.03026511e+02  1.87066920e+03  8.00034261e+03  4.77680002e+04]
E1 = -182.0518304387315  E_coul = 53.518268859108176
cycle= 1 E= -128.533561579623  delta_E= -0.0287  |g|= 0.208  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548421
diis-c [-0.30076543  1.        ]
  HOMO = -0.885639592073262  LUMO = 0.635571317730382
  mo_energy =
[-3.28845221e+01 -1.96896860e+00 -8.85639592e-01 -8.85639592e-01
 -8.85639592e-01  6.35571318e-01  6.35571318e-01  6.35571318e-01
  1.17318043e+00  2.81538882e+00  2.81538882e+00  2.81538882e+00
  7.24528580e+00  8.98630798e+00  8.98630798e+00  8.98630798e+00
  2.87052898e+01  2.87052898e+01  2.87052898e+01  3.45298607e+01
  1.23141183e+02  1.23141183e+02  1.23141183e+02  1.38599045e+02
  5.02658221e+02  1.87026474e+03  7.99990911e+03  4.77675478e+04]
E1 = -182.83148420559368  E_coul = 54.2952448336731
cycle= 2 E= -128.536239371921  delta_E= -0.00268  |g|= 0.106  |ddm|= 0.0622
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.28048
diis-c [-6.21855889e-04  3.37719405e-01  6.62280595e-01]
  HOMO = -0.849211743595634  LUMO = 0.641938674982048
  mo_energy =
[-3.27742775e+01 -1.93058523e+00 -8.49211744e-01 -8.49211744e-01
 -8.49211744e-01  6.41938675e-01  6.41938675e-01  6.41938675e-01
  1.18819660e+00  2.83841407e+00  2.83841407e+00  2.83841407e+00
  7.28957025e+00  9.03443535e+00  9.03443535e+00  9.03443535e+00
  2.87860744e+01  2.87860744e+01  2.87860744e+01  3.46143402e+01
  1.23250915e+02  1.23250915e+02  1.23250915e+02  1.38707264e+02
  5.02777384e+02  1.87038924e+03  8.00003610e+03  4.77676758e+04]
E1 = -182.56617851811433  E_coul = 54.028974670558895
cycle= 3 E= -128.537203847555  delta_E= -0.000964  |g|= 0.000412  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000900688
diis-c [-1.05271674e-07 -2.00111641e-03 -9.19209627e-04  1.00292033e+00]
  HOMO = -0.849435935957743  LUMO = 0.641917795310999
  mo_energy =
[-3.27746493e+01 -1.93076748e+00 -8.49435936e-01 -8.49435936e-01
 -8.49435936e-01  6.41917795e-01  6.41917795e-01  6.41917795e-01
  1.18812283e+00  2.83830131e+00  2.83830131e+00  2.83830131e+00
  7.28938323e+00  9.03422988e+00  9.03422988e+00  9.03422988e+00
  2.87857817e+01  2.87857817e+01  2.87857817e+01  3.46140473e+01
  1.23250532e+02  1.23250532e+02  1.23250532e+02  1.38706892e+02
  5.02776917e+02  1.87038867e+03  8.00003545e+03  4.77676751e+04]
E1 = -182.566398950564  E_coul = 54.029195085596115
cycle= 4 E= -128.537203864968  delta_E= -1.74e-08  |g|= 7.31e-05  |ddm|= 0.000237
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176949
diis-c [-6.33247110e-10  1.13913828e-04  5.07403249e-04 -1.36977368e-01
  1.13635605e+00]
  HOMO = -0.849476233425055  LUMO = 0.641908032650582
  mo_energy =
[-3.27747180e+01 -1.93080439e+00 -8.49476233e-01 -8.49476233e-01
 -8.49476233e-01  6.41908033e-01  6.41908033e-01  6.41908033e-01
  1.18810108e+00  2.83827055e+00  2.83827055e+00  2.83827055e+00
  7.28933801e+00  9.03418116e+00  9.03418116e+00  9.03418116e+00
  2.87857197e+01  2.87857197e+01  2.87857197e+01  3.46139848e+01
  1.23250464e+02  1.23250464e+02  1.23250464e+02  1.38706824e+02
  5.02776845e+02  1.87038859e+03  8.00003537e+03  4.77676750e+04]
E1 = -182.56651865407966  E_coul = 54.02931478859749
cycle= 5 E= -128.537203865482  delta_E= -5.14e-10  |g|= 2.4e-06  |ddm|= 3.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56651865407966  E_coul = 54.02931478859749
  HOMO = -0.849475276747588  LUMO = 0.641908167870247
  mo_energy =
[-3.27747156e+01 -1.93080312e+00 -8.49475277e-01 -8.49475277e-01
 -8.49475277e-01  6.41908168e-01  6.41908168e-01  6.41908168e-01
  1.18810156e+00  2.83827113e+00  2.83827113e+00  2.83827113e+00
  7.28933939e+00  9.03418244e+00  9.03418244e+00  9.03418244e+00
  2.87857217e+01  2.87857217e+01  2.87857217e+01  3.46139869e+01
  1.23250466e+02  1.23250466e+02  1.23250466e+02  1.38706826e+02
  5.02776846e+02  1.87038860e+03  8.00003537e+03  4.77676750e+04]
E1 = -182.56651131328852  E_coul = 54.029307447805635
Extra cycle  E= -128.537203865483  delta_E= -6.82e-13  |g|= 9.77e-07  |ddm|= 1.11e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.0437408410609
E1 = -182.56651131328852  E_coul = 54.029307447805635
init E= -128.537203865483
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849475813707423  LUMO = 0.641908067729775
  mo_energy =
[-3.27747171e+01 -1.93080364e+00 -8.49475814e-01 -8.49475814e-01
 -8.49475814e-01  6.41908068e-01  6.41908068e-01  6.41908068e-01
  1.18810135e+00  2.83827078e+00  2.83827078e+00  2.83827078e+00
  7.28933877e+00  9.03418174e+00  9.03418174e+00  9.03418174e+00
  2.87857206e+01  2.87857206e+01  2.87857206e+01  3.46139858e+01
  1.23250464e+02  1.23250464e+02  1.23250464e+02  1.38706824e+02
  5.02776845e+02  1.87038859e+03  8.00003537e+03  4.77676750e+04]
E1 = -182.56651495563634  E_coul = 54.029311090153485
cycle= 1 E= -128.537203865483  delta_E=    0  |g|= 5.03e-07  |ddm|= 2.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56651495563634  E_coul = 54.029311090153485
  HOMO = -0.849475559218432  LUMO = 0.641908111606017
  mo_energy =
[-3.27747163e+01 -1.93080336e+00 -8.49475559e-01 -8.49475559e-01
 -8.49475559e-01  6.41908112e-01  6.41908112e-01  6.41908112e-01
  1.18810146e+00  2.83827094e+00  2.83827094e+00  2.83827094e+00
  7.28933909e+00  9.03418208e+00  9.03418208e+00  9.03418208e+00
  2.87857212e+01  2.87857212e+01  2.87857212e+01  3.46139864e+01
  1.23250465e+02  1.23250465e+02  1.23250465e+02  1.38706825e+02
  5.02776846e+02  1.87038859e+03  8.00003537e+03  4.77676750e+04]
E1 = -182.56651305407422  E_coul = 54.0293091885912
Extra cycle  E= -128.537203865483  delta_E= -1.71e-13  |g|= 2.57e-07  |ddm|= 1.65e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271045e+02 2.35734919e+02
 7.64318971e+01 1.00364586e+01 2.70496064e+01 3.81618881e-01
 1.11762933e+00 2.88112014e+00 4.15934144e+00 1.26366065e+01
 5.47715824e+01 2.28529642e-01 1.62312880e+00 6.47074197e-01]
grad_E = [ 3.65520377e-11 -1.93372792e-09  4.66471352e-08 -7.00355484e-07
  4.50581206e-06 -7.64849442e-07  3.95022374e-06 -4.80986124e-05
  5.32655821e-05 -4.91845504e-06 -1.01391164e-03 -1.20633674e-03
  5.48044892e-05 -4.85214361e-03 -2.33111399e-04  5.69814128e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.4544708         1
[INPUT] 0    0    [1    /1   ]  833.271037892        1
[INPUT] 0    0    [1    /1   ]  235.735021525        1
[INPUT] 0    0    [1    /1   ]  76.4312382665        1
[INPUT] 0    0    [1    /1   ]  10.0362630385        1
[INPUT] 0    0    [1    /1   ]  27.0490912703        1
[INPUT] 0    0    [1    /1   ]  0.381803250097       1
[INPUT] 0    0    [1    /1   ]  1.11818337467        1
[INPUT] 0    0    [1    /1   ]  2.88052967336        1
[INPUT] 1    0    [1    /1   ]  4.25258139659        1
[INPUT] 1    0    [1    /1   ]  12.8384851479        1
[INPUT] 1    0    [1    /1   ]  54.758543722         1
[INPUT] 1    0    [1    /1   ]  0.238928132376       1
[INPUT] 1    0    [1    /1   ]  1.68597068673        1
[INPUT] 1    0    [1    /1   ]  0.684486793488       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129975362, 1.0]], [0, [3661.454470796885, 1.0]], [0, [833.2710378920957, 1.0]], [0, [235.73502152477323, 1.0]], [0, [76.4312382665145, 1.0]], [0, [10.0362630385166, 1.0]], [0, [27.049091270269003, 1.0]], [0, [0.3818032500969515, 1.0]], [0, [1.1181833746730712, 1.0]], [0, [2.880529673357925, 1.0]], [1, [4.252581396594228, 1.0]], [1, [12.838485147928367, 1.0]], [1, [54.75854372197649, 1.0]], [1, [0.23892813237597404, 1.0]], [1, [1.6859706867309388, 1.0]], [1, [0.6844867934883057, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412998]
bas 1, expnt(s) = [3661.4544708]
bas 2, expnt(s) = [833.27103789]
bas 3, expnt(s) = [235.73502152]
bas 4, expnt(s) = [76.43123827]
bas 5, expnt(s) = [10.03626304]
bas 6, expnt(s) = [27.04909127]
bas 7, expnt(s) = [0.38180325]
bas 8, expnt(s) = [1.11818337]
bas 9, expnt(s) = [2.88052967]
bas 10, expnt(s) = [4.2525814]
bas 11, expnt(s) = [12.83848515]
bas 12, expnt(s) = [54.75854372]
bas 13, expnt(s) = [0.23892813]
bas 14, expnt(s) = [1.68597069]
bas 15, expnt(s) = [0.68448679]
CPU time:        65.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271038e+02 3.91836366e+02 2.35735022e+02 1.51996331e+02
 7.64312383e+01 6.53082725e+01 1.00362630e+01 1.42460364e+01
 2.70490913e+01 2.99660523e+01 3.81803250e-01 1.22714177e+00
 1.11818337e+00 2.74726022e+00 2.88052967e+00 5.58623613e+00
 4.25258140e+00 1.78155890e+01 1.28384851e+01 7.08967980e+01
 5.47585437e+01 4.34559506e+02 2.38928132e-01 4.87324789e-01
 1.68597069e+00 5.60462961e+00 6.84486793e-01 1.81631318e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999757049179898
cond(S) = 344.17788725235886
E1 = -183.58467401281598  E_coul = 55.07967956203417
init E= -128.504994450782
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774783805704337  LUMO = 0.692612704119301
  mo_energy =
[-3.25552685e+01 -1.85260439e+00 -7.74783806e-01 -7.74783806e-01
 -7.74783806e-01  6.92612704e-01  6.92612704e-01  6.92612704e-01
  1.22072554e+00  3.04462564e+00  3.04462564e+00  3.04462564e+00
  7.38181815e+00  9.52201139e+00  9.52201139e+00  9.52201139e+00
  2.97973419e+01  2.97973419e+01  2.97973419e+01  3.47820017e+01
  1.24667339e+02  1.24667339e+02  1.24667339e+02  1.38921242e+02
  5.03022767e+02  1.87066489e+03  8.00033863e+03  4.77679968e+04]
E1 = -182.05606079450854  E_coul = 53.522333226332314
cycle= 1 E= -128.533727568176  delta_E= -0.0287  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548526
diis-c [-0.30088118  1.        ]
  HOMO = -0.885365709676023  LUMO = 0.671731025062849
  mo_energy =
[-3.28837247e+01 -1.96862294e+00 -8.85365710e-01 -8.85365710e-01
 -8.85365710e-01  6.71731025e-01  6.71731025e-01  6.71731025e-01
  1.17412246e+00  2.97080908e+00  2.97080908e+00  2.97080908e+00
  7.24741615e+00  9.37412578e+00  9.37412578e+00  9.37412578e+00
  2.95553754e+01  2.95553754e+01  2.95553754e+01  3.45309345e+01
  1.24338414e+02  1.24338414e+02  1.24338414e+02  1.38598090e+02
  5.02655332e+02  1.87026133e+03  7.99990602e+03  4.77675454e+04]
E1 = -182.83276818045695  E_coul = 54.29637459634779
cycle= 2 E= -128.536393584109  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280129
diis-c [-6.23932020e-04  3.37392125e-01  6.62607875e-01]
  HOMO = -0.849066527372967  LUMO = 0.678575659985392
  mo_energy =
[-3.27738034e+01 -1.93037917e+00 -8.49066527e-01 -8.49066527e-01
 -8.49066527e-01  6.78575660e-01  6.78575660e-01  6.78575660e-01
  1.18907707e+00  2.99469258e+00  2.99469258e+00  2.99469258e+00
  7.29154356e+00  9.42281205e+00  9.42281205e+00  9.42281205e+00
  2.96362613e+01  2.96362613e+01  2.96362613e+01  3.46151501e+01
  1.24447778e+02  1.24447778e+02  1.24447778e+02  1.38705990e+02
  5.02774150e+02  1.87038547e+03  8.00003265e+03  4.77676730e+04]
E1 = -182.5685689570081  E_coul = 54.031217983302156
cycle= 3 E= -128.537350973706  delta_E= -0.000957  |g|= 0.00043  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000952956
diis-c [-1.08661361e-07 -2.05225179e-03 -8.26960330e-04  1.00287921e+00]
  HOMO = -0.849297820804395  LUMO = 0.678550511099612
  mo_energy =
[-3.27741910e+01 -1.93056814e+00 -8.49297821e-01 -8.49297821e-01
 -8.49297821e-01  6.78550511e-01  6.78550511e-01  6.78550511e-01
  1.18899895e+00  2.99456928e+00  2.99456928e+00  2.99456928e+00
  7.29134863e+00  9.42259456e+00  9.42259456e+00  9.42259456e+00
  2.96359547e+01  2.96359547e+01  2.96359547e+01  3.46148443e+01
  1.24447380e+02  1.24447380e+02  1.24447380e+02  1.38705602e+02
  5.02773665e+02  1.87038487e+03  8.00003197e+03  4.77676722e+04]
E1 = -182.56882628868442  E_coul = 54.03147529653294
cycle= 4 E= -128.537350992151  delta_E= -1.84e-08  |g|= 7.46e-05  |ddm|= 0.000241
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182228
diis-c [-6.21498925e-10  1.18998313e-04  5.12259167e-04 -1.37338870e-01
  1.13670761e+00]
  HOMO = -0.84933870064589  LUMO = 0.67853997034927
  mo_energy =
[-3.27742612e+01 -1.93060546e+00 -8.49338701e-01 -8.49338701e-01
 -8.49338701e-01  6.78539970e-01  6.78539970e-01  6.78539970e-01
  1.18897703e+00  2.99453719e+00  2.99453719e+00  2.99453719e+00
  7.29130287e+00  9.42254466e+00  9.42254466e+00  9.42254466e+00
  2.96358914e+01  2.96358914e+01  2.96358914e+01  3.46147806e+01
  1.24447310e+02  1.24447310e+02  1.24447310e+02  1.38705532e+02
  5.02773590e+02  1.87038480e+03  8.00003189e+03  4.77676722e+04]
E1 = -182.56895024146198  E_coul = 54.03159924878605
cycle= 5 E= -128.537350992676  delta_E= -5.24e-10  |g|= 2.43e-06  |ddm|= 3.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56895024146198  E_coul = 54.03159924878605
  HOMO = -0.849337678824381  LUMO = 0.678540146477502
  mo_energy =
[-3.27742587e+01 -1.93060411e+00 -8.49337679e-01 -8.49337679e-01
 -8.49337679e-01  6.78540146e-01  6.78540146e-01  6.78540146e-01
  1.18897757e+00  2.99453787e+00  2.99453787e+00  2.99453787e+00
  7.29130434e+00  9.42254605e+00  9.42254605e+00  9.42254605e+00
  2.96358936e+01  2.96358936e+01  2.96358936e+01  3.46147829e+01
  1.24447312e+02  1.24447312e+02  1.24447312e+02  1.38705534e+02
  5.02773592e+02  1.87038480e+03  8.00003189e+03  4.77676722e+04]
E1 = -182.56894291444664  E_coul = 54.03159192177003
Extra cycle  E= -128.537350992677  delta_E= -6.82e-13  |g|= 9.83e-07  |ddm|= 1.02e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271038e+02 2.35735022e+02
 7.64312383e+01 1.00362630e+01 2.70490913e+01 3.81803250e-01
 1.11818337e+00 2.88052967e+00 4.25258140e+00 1.28384851e+01
 5.47585437e+01 2.38928132e-01 1.68597069e+00 6.84486793e-01]
E = -128.5373509926766
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.4544708         1
[INPUT] 0    0    [1    /1   ]  833.271037892        1
[INPUT] 0    0    [1    /1   ]  235.735021525        1
[INPUT] 0    0    [1    /1   ]  76.4312382665        1
[INPUT] 0    0    [1    /1   ]  10.0362630385        1
[INPUT] 0    0    [1    /1   ]  27.0490912703        1
[INPUT] 0    0    [1    /1   ]  0.381803250097       1
[INPUT] 0    0    [1    /1   ]  1.11818337467        1
[INPUT] 0    0    [1    /1   ]  2.88052967336        1
[INPUT] 1    0    [1    /1   ]  4.25258139659        1
[INPUT] 1    0    [1    /1   ]  12.8384851479        1
[INPUT] 1    0    [1    /1   ]  54.758543722         1
[INPUT] 1    0    [1    /1   ]  0.238928132376       1
[INPUT] 1    0    [1    /1   ]  1.68597068673        1
[INPUT] 1    0    [1    /1   ]  0.684486793488       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129975362, 1.0]], [0, [3661.454470796885, 1.0]], [0, [833.2710378920957, 1.0]], [0, [235.73502152477323, 1.0]], [0, [76.4312382665145, 1.0]], [0, [10.0362630385166, 1.0]], [0, [27.049091270269003, 1.0]], [0, [0.3818032500969515, 1.0]], [0, [1.1181833746730712, 1.0]], [0, [2.880529673357925, 1.0]], [1, [4.252581396594228, 1.0]], [1, [12.838485147928367, 1.0]], [1, [54.75854372197649, 1.0]], [1, [0.23892813237597404, 1.0]], [1, [1.6859706867309388, 1.0]], [1, [0.6844867934883057, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412998]
bas 1, expnt(s) = [3661.4544708]
bas 2, expnt(s) = [833.27103789]
bas 3, expnt(s) = [235.73502152]
bas 4, expnt(s) = [76.43123827]
bas 5, expnt(s) = [10.03626304]
bas 6, expnt(s) = [27.04909127]
bas 7, expnt(s) = [0.38180325]
bas 8, expnt(s) = [1.11818337]
bas 9, expnt(s) = [2.88052967]
bas 10, expnt(s) = [4.2525814]
bas 11, expnt(s) = [12.83848515]
bas 12, expnt(s) = [54.75854372]
bas 13, expnt(s) = [0.23892813]
bas 14, expnt(s) = [1.68597069]
bas 15, expnt(s) = [0.68448679]
CPU time:        65.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271038e+02 3.91836366e+02 2.35735022e+02 1.51996331e+02
 7.64312383e+01 6.53082725e+01 1.00362630e+01 1.42460364e+01
 2.70490913e+01 2.99660523e+01 3.81803250e-01 1.22714177e+00
 1.11818337e+00 2.74726022e+00 2.88052967e+00 5.58623613e+00
 4.25258140e+00 1.78155890e+01 1.28384851e+01 7.08967980e+01
 5.47585437e+01 4.34559506e+02 2.38928132e-01 4.87324789e-01
 1.68597069e+00 5.60462961e+00 6.84486793e-01 1.81631318e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999757049179898
cond(S) = 344.17788725235886
E1 = -183.58467401281598  E_coul = 55.07967956203417
init E= -128.504994450782
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774783805704337  LUMO = 0.692612704119301
  mo_energy =
[-3.25552685e+01 -1.85260439e+00 -7.74783806e-01 -7.74783806e-01
 -7.74783806e-01  6.92612704e-01  6.92612704e-01  6.92612704e-01
  1.22072554e+00  3.04462564e+00  3.04462564e+00  3.04462564e+00
  7.38181815e+00  9.52201139e+00  9.52201139e+00  9.52201139e+00
  2.97973419e+01  2.97973419e+01  2.97973419e+01  3.47820017e+01
  1.24667339e+02  1.24667339e+02  1.24667339e+02  1.38921242e+02
  5.03022767e+02  1.87066489e+03  8.00033863e+03  4.77679968e+04]
E1 = -182.05606079450854  E_coul = 53.522333226332314
cycle= 1 E= -128.533727568176  delta_E= -0.0287  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548526
diis-c [-0.30088118  1.        ]
  HOMO = -0.885365709676023  LUMO = 0.671731025062849
  mo_energy =
[-3.28837247e+01 -1.96862294e+00 -8.85365710e-01 -8.85365710e-01
 -8.85365710e-01  6.71731025e-01  6.71731025e-01  6.71731025e-01
  1.17412246e+00  2.97080908e+00  2.97080908e+00  2.97080908e+00
  7.24741615e+00  9.37412578e+00  9.37412578e+00  9.37412578e+00
  2.95553754e+01  2.95553754e+01  2.95553754e+01  3.45309345e+01
  1.24338414e+02  1.24338414e+02  1.24338414e+02  1.38598090e+02
  5.02655332e+02  1.87026133e+03  7.99990602e+03  4.77675454e+04]
E1 = -182.83276818045695  E_coul = 54.29637459634779
cycle= 2 E= -128.536393584109  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0623
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.280129
diis-c [-6.23932020e-04  3.37392125e-01  6.62607875e-01]
  HOMO = -0.849066527372967  LUMO = 0.678575659985392
  mo_energy =
[-3.27738034e+01 -1.93037917e+00 -8.49066527e-01 -8.49066527e-01
 -8.49066527e-01  6.78575660e-01  6.78575660e-01  6.78575660e-01
  1.18907707e+00  2.99469258e+00  2.99469258e+00  2.99469258e+00
  7.29154356e+00  9.42281205e+00  9.42281205e+00  9.42281205e+00
  2.96362613e+01  2.96362613e+01  2.96362613e+01  3.46151501e+01
  1.24447778e+02  1.24447778e+02  1.24447778e+02  1.38705990e+02
  5.02774150e+02  1.87038547e+03  8.00003265e+03  4.77676730e+04]
E1 = -182.5685689570081  E_coul = 54.031217983302156
cycle= 3 E= -128.537350973706  delta_E= -0.000957  |g|= 0.00043  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000952956
diis-c [-1.08661361e-07 -2.05225179e-03 -8.26960330e-04  1.00287921e+00]
  HOMO = -0.849297820804395  LUMO = 0.678550511099612
  mo_energy =
[-3.27741910e+01 -1.93056814e+00 -8.49297821e-01 -8.49297821e-01
 -8.49297821e-01  6.78550511e-01  6.78550511e-01  6.78550511e-01
  1.18899895e+00  2.99456928e+00  2.99456928e+00  2.99456928e+00
  7.29134863e+00  9.42259456e+00  9.42259456e+00  9.42259456e+00
  2.96359547e+01  2.96359547e+01  2.96359547e+01  3.46148443e+01
  1.24447380e+02  1.24447380e+02  1.24447380e+02  1.38705602e+02
  5.02773665e+02  1.87038487e+03  8.00003197e+03  4.77676722e+04]
E1 = -182.56882628868442  E_coul = 54.03147529653294
cycle= 4 E= -128.537350992151  delta_E= -1.84e-08  |g|= 7.46e-05  |ddm|= 0.000241
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182228
diis-c [-6.21498925e-10  1.18998313e-04  5.12259167e-04 -1.37338870e-01
  1.13670761e+00]
  HOMO = -0.84933870064589  LUMO = 0.67853997034927
  mo_energy =
[-3.27742612e+01 -1.93060546e+00 -8.49338701e-01 -8.49338701e-01
 -8.49338701e-01  6.78539970e-01  6.78539970e-01  6.78539970e-01
  1.18897703e+00  2.99453719e+00  2.99453719e+00  2.99453719e+00
  7.29130287e+00  9.42254466e+00  9.42254466e+00  9.42254466e+00
  2.96358914e+01  2.96358914e+01  2.96358914e+01  3.46147806e+01
  1.24447310e+02  1.24447310e+02  1.24447310e+02  1.38705532e+02
  5.02773590e+02  1.87038480e+03  8.00003189e+03  4.77676722e+04]
E1 = -182.56895024146198  E_coul = 54.03159924878605
cycle= 5 E= -128.537350992676  delta_E= -5.24e-10  |g|= 2.43e-06  |ddm|= 3.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56895024146198  E_coul = 54.03159924878605
  HOMO = -0.849337678824381  LUMO = 0.678540146477502
  mo_energy =
[-3.27742587e+01 -1.93060411e+00 -8.49337679e-01 -8.49337679e-01
 -8.49337679e-01  6.78540146e-01  6.78540146e-01  6.78540146e-01
  1.18897757e+00  2.99453787e+00  2.99453787e+00  2.99453787e+00
  7.29130434e+00  9.42254605e+00  9.42254605e+00  9.42254605e+00
  2.96358936e+01  2.96358936e+01  2.96358936e+01  3.46147829e+01
  1.24447312e+02  1.24447312e+02  1.24447312e+02  1.38705534e+02
  5.02773592e+02  1.87038480e+03  8.00003189e+03  4.77676722e+04]
E1 = -182.56894291444664  E_coul = 54.03159192177003
Extra cycle  E= -128.537350992677  delta_E= -6.82e-13  |g|= 9.83e-07  |ddm|= 1.02e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.17788725235886
E1 = -182.56894291444664  E_coul = 54.03159192177003
init E= -128.537350992677
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849338212744388  LUMO = 0.678540041939722
  mo_energy =
[-3.27742603e+01 -1.93060462e+00 -8.49338213e-01 -8.49338213e-01
 -8.49338213e-01  6.78540042e-01  6.78540042e-01  6.78540042e-01
  1.18897737e+00  2.99453752e+00  2.99453752e+00  2.99453752e+00
  7.29130372e+00  9.42254534e+00  9.42254534e+00  9.42254534e+00
  2.96358924e+01  2.96358924e+01  2.96358924e+01  3.46147817e+01
  1.24447310e+02  1.24447310e+02  1.24447310e+02  1.38705533e+02
  5.02773590e+02  1.87038479e+03  8.00003189e+03  4.77676722e+04]
E1 = -182.568946625702  E_coul = 54.031595633025404
cycle= 1 E= -128.537350992677  delta_E=    0  |g|= 5.12e-07  |ddm|= 2.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.568946625702  E_coul = 54.031595633025404
  HOMO = -0.849337953164495  LUMO = 0.678540090726436
  mo_energy =
[-3.27742595e+01 -1.93060433e+00 -8.49337953e-01 -8.49337953e-01
 -8.49337953e-01  6.78540091e-01  6.78540091e-01  6.78540091e-01
  1.18897748e+00  2.99453769e+00  2.99453769e+00  2.99453769e+00
  7.29130405e+00  9.42254569e+00  9.42254569e+00  9.42254569e+00
  2.96358930e+01  2.96358930e+01  2.96358930e+01  3.46147823e+01
  1.24447311e+02  1.24447311e+02  1.24447311e+02  1.38705533e+02
  5.02773591e+02  1.87038480e+03  8.00003189e+03  4.77676722e+04]
E1 = -182.5689447049293  E_coul = 54.03159371225258
Extra cycle  E= -128.537350992677  delta_E= -1.14e-13  |g|= 2.6e-07  |ddm|= 1.68e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271038e+02 2.35735022e+02
 7.64312383e+01 1.00362630e+01 2.70490913e+01 3.81803250e-01
 1.11818337e+00 2.88052967e+00 4.25258140e+00 1.28384851e+01
 5.47585437e+01 2.38928132e-01 1.68597069e+00 6.84486793e-01]
grad_E = [ 3.47090273e-11 -1.83841022e-09  4.48840960e-08 -6.83799150e-07
  4.41871895e-06 -3.23407168e-06  4.46175507e-06 -5.90666347e-05
  9.63931890e-05 -1.40698202e-05 -9.91107743e-04 -9.31907064e-04
  1.09089141e-05 -7.08305718e-03 -8.60282954e-04  8.10848205e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447124        1
[INPUT] 0    0    [1    /1   ]  833.271027424        1
[INPUT] 0    0    [1    /1   ]  235.73517672         1
[INPUT] 0    0    [1    /1   ]  76.4302449169        1
[INPUT] 0    0    [1    /1   ]  10.0359721981        1
[INPUT] 0    0    [1    /1   ]  27.0483178899        1
[INPUT] 0    0    [1    /1   ]  0.382090798001       1
[INPUT] 0    0    [1    /1   ]  1.11900594649        1
[INPUT] 0    0    [1    /1   ]  2.87965637053        1
[INPUT] 1    0    [1    /1   ]  4.3849436016         1
[INPUT] 1    0    [1    /1   ]  13.1510898498        1
[INPUT] 1    0    [1    /1   ]  54.7384799248        1
[INPUT] 1    0    [1    /1   ]  0.246093375934       1
[INPUT] 1    0    [1    /1   ]  1.74762434253        1
[INPUT] 1    0    [1    /1   ]  0.713494812828       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129967067, 1.0]], [0, [3661.4544712352076, 1.0]], [0, [833.2710274236213, 1.0]], [0, [235.7351767195006, 1.0]], [0, [76.43024491686523, 1.0]], [0, [10.035972198140403, 1.0]], [0, [27.04831788990967, 1.0]], [0, [0.3820907980006861, 1.0]], [0, [1.119005946489872, 1.0]], [0, [2.8796563705299723, 1.0]], [1, [4.384943601597117, 1.0]], [1, [13.151089849751713, 1.0]], [1, [54.73847992481112, 1.0]], [1, [0.24609337593382694, 1.0]], [1, [1.747624342532482, 1.0]], [1, [0.7134948128284911, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412997]
bas 1, expnt(s) = [3661.45447124]
bas 2, expnt(s) = [833.27102742]
bas 3, expnt(s) = [235.73517672]
bas 4, expnt(s) = [76.43024492]
bas 5, expnt(s) = [10.0359722]
bas 6, expnt(s) = [27.04831789]
bas 7, expnt(s) = [0.3820908]
bas 8, expnt(s) = [1.11900595]
bas 9, expnt(s) = [2.87965637]
bas 10, expnt(s) = [4.3849436]
bas 11, expnt(s) = [13.15108985]
bas 12, expnt(s) = [54.73847992]
bas 13, expnt(s) = [0.24609338]
bas 14, expnt(s) = [1.74762434]
bas 15, expnt(s) = [0.71349481]
CPU time:        68.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271027e+02 3.91836362e+02 2.35735177e+02 1.51996406e+02
 7.64302449e+01 6.53076359e+01 1.00359722e+01 1.42457268e+01
 2.70483179e+01 2.99654098e+01 3.82090798e-01 1.22783486e+00
 1.11900595e+00 2.74877581e+00 2.87965637e+00 5.58496588e+00
 4.38494360e+00 1.85114061e+01 1.31510898e+01 7.30611618e+01
 5.47384799e+01 4.34360484e+02 2.46093376e-01 5.05660812e-01
 1.74762434e+00 5.86198225e+00 7.13494813e-01 1.91303501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999715335262177
cond(S) = 344.38201154707247
E1 = -183.58497314326712  E_coul = 55.07974755499235
init E= -128.505225588275
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77481697763897  LUMO = 0.72039487736268
  mo_energy =
[-3.25552331e+01 -1.85260545e+00 -7.74816978e-01 -7.74816978e-01
 -7.74816978e-01  7.20394877e-01  7.20394877e-01  7.20394877e-01
  1.22193461e+00  3.17238949e+00  3.17238949e+00  3.17238949e+00
  7.38446589e+00  9.89574558e+00  9.89574558e+00  9.89574558e+00
  3.08317060e+01  3.08317060e+01  3.08317060e+01  3.47827557e+01
  1.26295417e+02  1.26295417e+02  1.26295417e+02  1.38918721e+02
  5.03017196e+02  1.87065847e+03  8.00033267e+03  4.77679919e+04]
E1 = -182.05978271696708  E_coul = 53.52581235433968
cycle= 1 E= -128.533970362627  delta_E= -0.0287  |g|= 0.207  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548125
diis-c [-0.30044087  1.        ]
  HOMO = -0.885160640800551  LUMO = 0.69838071673054
  mo_energy =
[-3.28829926e+01 -1.96833883e+00 -8.85160641e-01 -8.85160641e-01
 -8.85160641e-01  6.98380717e-01  6.98380717e-01  6.98380717e-01
  1.17542609e+00  3.09616858e+00  3.09616858e+00  3.09616858e+00
  7.25039232e+00  9.74548150e+00  9.74548150e+00  9.74548150e+00
  3.05883965e+01  3.05883965e+01  3.05883965e+01  3.45322238e+01
  1.25967298e+02  1.25967298e+02  1.25967298e+02  1.38596263e+02
  5.02650561e+02  1.87025575e+03  7.99990093e+03  4.77675413e+04]
E1 = -182.83401430617184  E_coul = 54.29738845843597
cycle= 2 E= -128.536625847736  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0625
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279586
diis-c [-6.27476702e-04  3.37114963e-01  6.62885037e-01]
  HOMO = -0.848969321342825  LUMO = 0.705584097579948
  mo_energy =
[-3.27733440e+01 -1.93021165e+00 -8.48969321e-01 -8.48969321e-01
 -8.48969321e-01  7.05584098e-01  7.05584098e-01  7.05584098e-01
  1.19033456e+00  3.12081748e+00  3.12081748e+00  3.12081748e+00
  7.29438828e+00  9.79494025e+00  9.79494025e+00  9.79494025e+00
  3.06696957e+01  3.06696957e+01  3.06696957e+01  3.46162161e+01
  1.26076359e+02  1.26076359e+02  1.26076359e+02  1.38703893e+02
  5.02769086e+02  1.87037958e+03  8.00002724e+03  4.77676685e+04]
E1 = -182.57069827603723  E_coul = 54.033120894545355
cycle= 3 E= -128.537577381492  delta_E= -0.000952  |g|= 0.000451  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101038
diis-c [-1.13290679e-07 -2.10905407e-03 -7.25755684e-04  1.00283481e+00]
  HOMO = -0.849209241395691  LUMO = 0.705554581324536
  mo_energy =
[-3.27737510e+01 -1.93040904e+00 -8.49209241e-01 -8.49209241e-01
 -8.49209241e-01  7.05554581e-01  7.05554581e-01  7.05554581e-01
  1.19025120e+00  3.12068286e+00  3.12068286e+00  3.12068286e+00
  7.29418363e+00  9.79470812e+00  9.79470812e+00  9.79470812e+00
  3.06693717e+01  3.06693717e+01  3.06693717e+01  3.46158946e+01
  1.26075941e+02  1.26075941e+02  1.26075941e+02  1.38703485e+02
  5.02768577e+02  1.87037896e+03  8.00002654e+03  4.77676678e+04]
E1 = -182.57099697415475  E_coul = 54.03341957286465
cycle= 4 E= -128.53757740129  delta_E= -1.98e-08  |g|= 7.62e-05  |ddm|= 0.000245
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186921
diis-c [-6.11039610e-10  1.23958124e-04  5.12208478e-04 -1.37603792e-01
  1.13696763e+00]
  HOMO = -0.849250834235715  LUMO = 0.705543355009641
  mo_energy =
[-3.27738229e+01 -1.93044697e+00 -8.49250834e-01 -8.49250834e-01
 -8.49250834e-01  7.05543355e-01  7.05543355e-01  7.05543355e-01
  1.19022894e+00  3.12064940e+00  3.12064940e+00  3.12064940e+00
  7.29413715e+00  9.79465676e+00  9.79465676e+00  9.79465676e+00
  3.06693069e+01  3.06693069e+01  3.06693069e+01  3.46158296e+01
  1.26075869e+02  1.26075869e+02  1.26075869e+02  1.38703413e+02
  5.02768501e+02  1.87037888e+03  8.00002645e+03  4.77676677e+04]
E1 = -182.57112462592963  E_coul = 54.03354722410009
cycle= 5 E= -128.53757740183  delta_E= -5.39e-10  |g|= 2.48e-06  |ddm|= 3.39e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57112462592963  E_coul = 54.03354722410009
  HOMO = -0.849249751153014  LUMO = 0.70554356589463
  mo_energy =
[-3.27738203e+01 -1.93044554e+00 -8.49249751e-01 -8.49249751e-01
 -8.49249751e-01  7.05543566e-01  7.05543566e-01  7.05543566e-01
  1.19022954e+00  3.12065016e+00  3.12065016e+00  3.12065016e+00
  7.29413869e+00  9.79465825e+00  9.79465825e+00  9.79465825e+00
  3.06693092e+01  3.06693092e+01  3.06693092e+01  3.46158320e+01
  1.26075871e+02  1.26075871e+02  1.26075871e+02  1.38703416e+02
  5.02768503e+02  1.87037888e+03  8.00002646e+03  4.77676677e+04]
E1 = -182.57111719832727  E_coul = 54.033539796497216
Extra cycle  E= -128.53757740183  delta_E= -5.12e-13  |g|= 1e-06  |ddm|= 9.85e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271027e+02 2.35735177e+02
 7.64302449e+01 1.00359722e+01 2.70483179e+01 3.82090798e-01
 1.11900595e+00 2.87965637e+00 4.38494360e+00 1.31510898e+01
 5.47384799e+01 2.46093376e-01 1.74762434e+00 7.13494813e-01]
E = -128.53757740183005
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447124        1
[INPUT] 0    0    [1    /1   ]  833.271027424        1
[INPUT] 0    0    [1    /1   ]  235.73517672         1
[INPUT] 0    0    [1    /1   ]  76.4302449169        1
[INPUT] 0    0    [1    /1   ]  10.0359721981        1
[INPUT] 0    0    [1    /1   ]  27.0483178899        1
[INPUT] 0    0    [1    /1   ]  0.382090798001       1
[INPUT] 0    0    [1    /1   ]  1.11900594649        1
[INPUT] 0    0    [1    /1   ]  2.87965637053        1
[INPUT] 1    0    [1    /1   ]  4.3849436016         1
[INPUT] 1    0    [1    /1   ]  13.1510898498        1
[INPUT] 1    0    [1    /1   ]  54.7384799248        1
[INPUT] 1    0    [1    /1   ]  0.246093375934       1
[INPUT] 1    0    [1    /1   ]  1.74762434253        1
[INPUT] 1    0    [1    /1   ]  0.713494812828       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129967067, 1.0]], [0, [3661.4544712352076, 1.0]], [0, [833.2710274236213, 1.0]], [0, [235.7351767195006, 1.0]], [0, [76.43024491686523, 1.0]], [0, [10.035972198140403, 1.0]], [0, [27.04831788990967, 1.0]], [0, [0.3820907980006861, 1.0]], [0, [1.119005946489872, 1.0]], [0, [2.8796563705299723, 1.0]], [1, [4.384943601597117, 1.0]], [1, [13.151089849751713, 1.0]], [1, [54.73847992481112, 1.0]], [1, [0.24609337593382694, 1.0]], [1, [1.747624342532482, 1.0]], [1, [0.7134948128284911, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412997]
bas 1, expnt(s) = [3661.45447124]
bas 2, expnt(s) = [833.27102742]
bas 3, expnt(s) = [235.73517672]
bas 4, expnt(s) = [76.43024492]
bas 5, expnt(s) = [10.0359722]
bas 6, expnt(s) = [27.04831789]
bas 7, expnt(s) = [0.3820908]
bas 8, expnt(s) = [1.11900595]
bas 9, expnt(s) = [2.87965637]
bas 10, expnt(s) = [4.3849436]
bas 11, expnt(s) = [13.15108985]
bas 12, expnt(s) = [54.73847992]
bas 13, expnt(s) = [0.24609338]
bas 14, expnt(s) = [1.74762434]
bas 15, expnt(s) = [0.71349481]
CPU time:        68.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271027e+02 3.91836362e+02 2.35735177e+02 1.51996406e+02
 7.64302449e+01 6.53076359e+01 1.00359722e+01 1.42457268e+01
 2.70483179e+01 2.99654098e+01 3.82090798e-01 1.22783486e+00
 1.11900595e+00 2.74877581e+00 2.87965637e+00 5.58496588e+00
 4.38494360e+00 1.85114061e+01 1.31510898e+01 7.30611618e+01
 5.47384799e+01 4.34360484e+02 2.46093376e-01 5.05660812e-01
 1.74762434e+00 5.86198225e+00 7.13494813e-01 1.91303501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999715335262177
cond(S) = 344.38201154707247
E1 = -183.58497314326712  E_coul = 55.07974755499235
init E= -128.505225588275
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77481697763897  LUMO = 0.72039487736268
  mo_energy =
[-3.25552331e+01 -1.85260545e+00 -7.74816978e-01 -7.74816978e-01
 -7.74816978e-01  7.20394877e-01  7.20394877e-01  7.20394877e-01
  1.22193461e+00  3.17238949e+00  3.17238949e+00  3.17238949e+00
  7.38446589e+00  9.89574558e+00  9.89574558e+00  9.89574558e+00
  3.08317060e+01  3.08317060e+01  3.08317060e+01  3.47827557e+01
  1.26295417e+02  1.26295417e+02  1.26295417e+02  1.38918721e+02
  5.03017196e+02  1.87065847e+03  8.00033267e+03  4.77679919e+04]
E1 = -182.05978271696708  E_coul = 53.52581235433968
cycle= 1 E= -128.533970362627  delta_E= -0.0287  |g|= 0.207  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.548125
diis-c [-0.30044087  1.        ]
  HOMO = -0.885160640800551  LUMO = 0.69838071673054
  mo_energy =
[-3.28829926e+01 -1.96833883e+00 -8.85160641e-01 -8.85160641e-01
 -8.85160641e-01  6.98380717e-01  6.98380717e-01  6.98380717e-01
  1.17542609e+00  3.09616858e+00  3.09616858e+00  3.09616858e+00
  7.25039232e+00  9.74548150e+00  9.74548150e+00  9.74548150e+00
  3.05883965e+01  3.05883965e+01  3.05883965e+01  3.45322238e+01
  1.25967298e+02  1.25967298e+02  1.25967298e+02  1.38596263e+02
  5.02650561e+02  1.87025575e+03  7.99990093e+03  4.77675413e+04]
E1 = -182.83401430617184  E_coul = 54.29738845843597
cycle= 2 E= -128.536625847736  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0625
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279586
diis-c [-6.27476702e-04  3.37114963e-01  6.62885037e-01]
  HOMO = -0.848969321342825  LUMO = 0.705584097579948
  mo_energy =
[-3.27733440e+01 -1.93021165e+00 -8.48969321e-01 -8.48969321e-01
 -8.48969321e-01  7.05584098e-01  7.05584098e-01  7.05584098e-01
  1.19033456e+00  3.12081748e+00  3.12081748e+00  3.12081748e+00
  7.29438828e+00  9.79494025e+00  9.79494025e+00  9.79494025e+00
  3.06696957e+01  3.06696957e+01  3.06696957e+01  3.46162161e+01
  1.26076359e+02  1.26076359e+02  1.26076359e+02  1.38703893e+02
  5.02769086e+02  1.87037958e+03  8.00002724e+03  4.77676685e+04]
E1 = -182.57069827603723  E_coul = 54.033120894545355
cycle= 3 E= -128.537577381492  delta_E= -0.000952  |g|= 0.000451  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101038
diis-c [-1.13290679e-07 -2.10905407e-03 -7.25755684e-04  1.00283481e+00]
  HOMO = -0.849209241395691  LUMO = 0.705554581324536
  mo_energy =
[-3.27737510e+01 -1.93040904e+00 -8.49209241e-01 -8.49209241e-01
 -8.49209241e-01  7.05554581e-01  7.05554581e-01  7.05554581e-01
  1.19025120e+00  3.12068286e+00  3.12068286e+00  3.12068286e+00
  7.29418363e+00  9.79470812e+00  9.79470812e+00  9.79470812e+00
  3.06693717e+01  3.06693717e+01  3.06693717e+01  3.46158946e+01
  1.26075941e+02  1.26075941e+02  1.26075941e+02  1.38703485e+02
  5.02768577e+02  1.87037896e+03  8.00002654e+03  4.77676678e+04]
E1 = -182.57099697415475  E_coul = 54.03341957286465
cycle= 4 E= -128.53757740129  delta_E= -1.98e-08  |g|= 7.62e-05  |ddm|= 0.000245
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186921
diis-c [-6.11039610e-10  1.23958124e-04  5.12208478e-04 -1.37603792e-01
  1.13696763e+00]
  HOMO = -0.849250834235715  LUMO = 0.705543355009641
  mo_energy =
[-3.27738229e+01 -1.93044697e+00 -8.49250834e-01 -8.49250834e-01
 -8.49250834e-01  7.05543355e-01  7.05543355e-01  7.05543355e-01
  1.19022894e+00  3.12064940e+00  3.12064940e+00  3.12064940e+00
  7.29413715e+00  9.79465676e+00  9.79465676e+00  9.79465676e+00
  3.06693069e+01  3.06693069e+01  3.06693069e+01  3.46158296e+01
  1.26075869e+02  1.26075869e+02  1.26075869e+02  1.38703413e+02
  5.02768501e+02  1.87037888e+03  8.00002645e+03  4.77676677e+04]
E1 = -182.57112462592963  E_coul = 54.03354722410009
cycle= 5 E= -128.53757740183  delta_E= -5.39e-10  |g|= 2.48e-06  |ddm|= 3.39e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57112462592963  E_coul = 54.03354722410009
  HOMO = -0.849249751153014  LUMO = 0.70554356589463
  mo_energy =
[-3.27738203e+01 -1.93044554e+00 -8.49249751e-01 -8.49249751e-01
 -8.49249751e-01  7.05543566e-01  7.05543566e-01  7.05543566e-01
  1.19022954e+00  3.12065016e+00  3.12065016e+00  3.12065016e+00
  7.29413869e+00  9.79465825e+00  9.79465825e+00  9.79465825e+00
  3.06693092e+01  3.06693092e+01  3.06693092e+01  3.46158320e+01
  1.26075871e+02  1.26075871e+02  1.26075871e+02  1.38703416e+02
  5.02768503e+02  1.87037888e+03  8.00002646e+03  4.77676677e+04]
E1 = -182.57111719832727  E_coul = 54.033539796497216
Extra cycle  E= -128.53757740183  delta_E= -5.12e-13  |g|= 1e-06  |ddm|= 9.85e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.38201154707247
E1 = -182.57111719832727  E_coul = 54.033539796497216
init E= -128.53757740183
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849250290645903  LUMO = 0.705543456375002
  mo_energy =
[-3.27738219e+01 -1.93044605e+00 -8.49250291e-01 -8.49250291e-01
 -8.49250291e-01  7.05543456e-01  7.05543456e-01  7.05543456e-01
  1.19022934e+00  3.12064979e+00  3.12064979e+00  3.12064979e+00
  7.29413808e+00  9.79465753e+00  9.79465753e+00  9.79465753e+00
  3.06693080e+01  3.06693080e+01  3.06693080e+01  3.46158308e+01
  1.26075870e+02  1.26075870e+02  1.26075870e+02  1.38703414e+02
  5.02768501e+02  1.87037888e+03  8.00002645e+03  4.77676677e+04]
E1 = -182.57112101201304  E_coul = 54.033543610182896
cycle= 1 E= -128.53757740183  delta_E= -8.53e-14  |g|= 5.25e-07  |ddm|= 2.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57112101201304  E_coul = 54.033543610182896
  HOMO = -0.849250023671466  LUMO = 0.705543509662704
  mo_energy =
[-3.27738211e+01 -1.93044576e+00 -8.49250024e-01 -8.49250024e-01
 -8.49250024e-01  7.05543510e-01  7.05543510e-01  7.05543510e-01
  1.19022946e+00  3.12064997e+00  3.12064997e+00  3.12064997e+00
  7.29413841e+00  9.79465789e+00  9.79465789e+00  9.79465789e+00
  3.06693086e+01  3.06693086e+01  3.06693086e+01  3.46158314e+01
  1.26075871e+02  1.26075871e+02  1.26075871e+02  1.38703415e+02
  5.02768502e+02  1.87037888e+03  8.00002645e+03  4.77676677e+04]
E1 = -182.57111904895854  E_coul = 54.03354164712856
Extra cycle  E= -128.53757740183  delta_E= 1.42e-13  |g|= 2.66e-07  |ddm|= 1.73e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271027e+02 2.35735177e+02
 7.64302449e+01 1.00359722e+01 2.70483179e+01 3.82090798e-01
 1.11900595e+00 2.87965637e+00 4.38494360e+00 1.31510898e+01
 5.47384799e+01 2.46093376e-01 1.74762434e+00 7.13494813e-01]
grad_E = [ 3.20212147e-11 -1.69947880e-09  4.23228737e-08 -6.60026448e-07
  4.29736506e-06 -6.76076487e-06  5.17896097e-06 -6.69621900e-05
  1.50311081e-04 -2.66038897e-05 -9.06177315e-04 -5.84103808e-04
 -4.98235495e-05 -9.79658832e-03 -1.54348470e-03  1.04090693e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.4544719         1
[INPUT] 0    0    [1    /1   ]  833.271011568        1
[INPUT] 0    0    [1    /1   ]  235.735411819        1
[INPUT] 0    0    [1    /1   ]  76.4287395814        1
[INPUT] 0    0    [1    /1   ]  10.0355400266        1
[INPUT] 0    0    [1    /1   ]  27.0471491812        1
[INPUT] 0    0    [1    /1   ]  0.382532113482       1
[INPUT] 0    0    [1    /1   ]  1.12018373569        1
[INPUT] 0    0    [1    /1   ]  2.87836535165        1
[INPUT] 1    0    [1    /1   ]  4.5785122315         1
[INPUT] 1    0    [1    /1   ]  13.6342492754        1
[INPUT] 1    0    [1    /1   ]  54.7076664803        1
[INPUT] 1    0    [1    /1   ]  0.246696938555       1
[INPUT] 1    0    [1    /1   ]  1.79562887614        1
[INPUT] 1    0    [1    /1   ]  0.719070834533       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412995451, 1.0]], [0, [3661.454471898996, 1.0]], [0, [833.2710115684085, 1.0]], [0, [235.73541181887904, 1.0]], [0, [76.42873958136141, 1.0]], [0, [10.03554002656529, 1.0]], [0, [27.047149181220604, 1.0]], [0, [0.3825321134822825, 1.0]], [0, [1.1201837356905258, 1.0]], [0, [2.878365351650874, 1.0]], [1, [4.578512231503692, 1.0]], [1, [13.634249275438506, 1.0]], [1, [54.707666480268955, 1.0]], [1, [0.24669693855467772, 1.0]], [1, [1.7956288761395673, 1.0]], [1, [0.719070834532627, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412995]
bas 1, expnt(s) = [3661.4544719]
bas 2, expnt(s) = [833.27101157]
bas 3, expnt(s) = [235.73541182]
bas 4, expnt(s) = [76.42873958]
bas 5, expnt(s) = [10.03554003]
bas 6, expnt(s) = [27.04714918]
bas 7, expnt(s) = [0.38253211]
bas 8, expnt(s) = [1.12018374]
bas 9, expnt(s) = [2.87836535]
bas 10, expnt(s) = [4.57851223]
bas 11, expnt(s) = [13.63424928]
bas 12, expnt(s) = [54.70766648]
bas 13, expnt(s) = [0.24669694]
bas 14, expnt(s) = [1.79562888]
bas 15, expnt(s) = [0.71907083]
CPU time:        71.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33271012e+02 3.91836356e+02 2.35735412e+02 1.51996520e+02
 7.64287396e+01 6.53066712e+01 1.00355400e+01 1.42452667e+01
 2.70471492e+01 2.99644387e+01 3.82532113e-01 1.22889832e+00
 1.12018374e+00 2.75094540e+00 2.87836535e+00 5.58308787e+00
 4.57851223e+00 1.95384391e+01 1.36342493e+01 7.64316843e+01
 5.47076665e+01 4.34054868e+02 2.46696939e-01 5.07211501e-01
 1.79562888e+00 6.06394311e+00 7.19070835e-01 1.93174139e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999715570398063
cond(S) = 344.6834601665791
E1 = -183.585547432208  E_coul = 55.07988521396062
init E= -128.505662218247
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774871782227642  LUMO = 0.725265414893615
  mo_energy =
[-3.25551861e+01 -1.85259904e+00 -7.74871782e-01 -7.74871782e-01
 -7.74871782e-01  7.25265415e-01  7.25265415e-01  7.25265415e-01
  1.22373520e+00  3.21747538e+00  3.21747538e+00  3.21747538e+00
  7.38835181e+00  1.01761426e+01  1.01761426e+01  1.01761426e+01
  3.20712732e+01  3.20712732e+01  3.20712732e+01  3.47837550e+01
  1.28524199e+02  1.28524199e+02  1.28524199e+02  1.38914812e+02
  5.03008687e+02  1.87064867e+03  8.00032360e+03  4.77679843e+04]
E1 = -182.06178202692115  E_coul = 53.52743061046965
cycle= 1 E= -128.534351416451  delta_E= -0.0287  |g|= 0.207  |ddm|= 0.153
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547645
diis-c [-0.299915  1.      ]
  HOMO = -0.88512947601051  LUMO = 0.703000579739503
  mo_energy =
[-3.28825771e+01 -1.96822378e+00 -8.85129476e-01 -8.85129476e-01
 -8.85129476e-01  7.03000580e-01  7.03000580e-01  7.03000580e-01
  1.17721246e+00  3.13973499e+00  3.13973499e+00  3.13973499e+00
  7.25441142e+00  1.00225828e+01  1.00225828e+01  1.00225828e+01
  3.18251376e+01  3.18251376e+01  3.18251376e+01  3.45334913e+01
  1.28196468e+02  1.28196468e+02  1.28196468e+02  1.38592729e+02
  5.02642534e+02  1.87024649e+03  7.99989242e+03  4.77675342e+04]
E1 = -182.83520229082467  E_coul = 54.298200464055725
cycle= 2 E= -128.537001826769  delta_E= -0.00265  |g|= 0.105  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279242
diis-c [-6.32853552e-04  3.37027940e-01  6.62972060e-01]
  HOMO = -0.848972593517294  LUMO = 0.710280978113957
  mo_energy =
[-3.27730242e+01 -1.93013261e+00 -8.48972594e-01 -8.48972594e-01
 -8.48972594e-01  7.10280978e-01  7.10280978e-01  7.10280978e-01
  1.19212155e+00  3.16487554e+00  3.16487554e+00  3.16487554e+00
  7.29836529e+00  1.00731569e+01  1.00731569e+01  1.00731569e+01
  3.19074071e+01  3.19074071e+01  3.19074071e+01  3.46174050e+01
  1.28305432e+02  1.28305432e+02  1.28305432e+02  1.38700263e+02
  5.02760953e+02  1.87037021e+03  8.00001861e+03  4.77676614e+04]
E1 = -182.5721155166091  E_coul = 54.03416406362585
cycle= 3 E= -128.537951452983  delta_E= -0.00095  |g|= 0.000464  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104968
diis-c [-1.16090712e-07 -2.14347390e-03 -6.45377403e-04  1.00278885e+00]
  HOMO = -0.849217933044467  LUMO = 0.710249697057617
  mo_energy =
[-3.27734458e+01 -1.93033484e+00 -8.49217933e-01 -8.49217933e-01
 -8.49217933e-01  7.10249697e-01  7.10249697e-01  7.10249697e-01
  1.19203563e+00  3.16473434e+00  3.16473434e+00  3.16473434e+00
  7.29815470e+00  1.00729137e+01  1.00729137e+01  1.00729137e+01
  3.19070693e+01  3.19070693e+01  3.19070693e+01  3.46170727e+01
  1.28304999e+02  1.28304999e+02  1.28304999e+02  1.38699840e+02
  5.02760425e+02  1.87036956e+03  8.00001788e+03  4.77676606e+04]
E1 = -182.57244518027673  E_coul = 54.034493706653485
cycle= 4 E= -128.537951473623  delta_E= -2.06e-08  |g|= 7.71e-05  |ddm|= 0.000245
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018945
diis-c [-6.14399713e-10  1.27462651e-04  5.08738278e-04 -1.37928005e-01
  1.13729180e+00]
  HOMO = -0.84925996094707  LUMO = 0.710238256922103
  mo_energy =
[-3.27735186e+01 -1.93037305e+00 -8.49259961e-01 -8.49259961e-01
 -8.49259961e-01  7.10238257e-01  7.10238257e-01  7.10238257e-01
  1.19201322e+00  3.16470005e+00  3.16470005e+00  3.16470005e+00
  7.29810782e+00  1.00728612e+01  1.00728612e+01  1.00728612e+01
  3.19070033e+01  3.19070033e+01  3.19070033e+01  3.46170070e+01
  1.28304926e+02  1.28304926e+02  1.28304926e+02  1.38699768e+02
  5.02760347e+02  1.87036948e+03  8.00001779e+03  4.77676605e+04]
E1 = -182.5725749970367  E_coul = 54.03462352286368
cycle= 5 E= -128.537951474173  delta_E= -5.5e-10  |g|= 2.55e-06  |ddm|= 3.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5725749970367  E_coul = 54.03462352286368
  HOMO = -0.849258836621949  LUMO = 0.710238483530525
  mo_energy =
[-3.27735159e+01 -1.93037156e+00 -8.49258837e-01 -8.49258837e-01
 -8.49258837e-01  7.10238484e-01  7.10238484e-01  7.10238484e-01
  1.19201385e+00  3.16470086e+00  3.16470086e+00  3.16470086e+00
  7.29810942e+00  1.00728627e+01  1.00728627e+01  1.00728627e+01
  3.19070057e+01  3.19070057e+01  3.19070057e+01  3.46170095e+01
  1.28304929e+02  1.28304929e+02  1.28304929e+02  1.38699770e+02
  5.02760349e+02  1.87036948e+03  8.00001779e+03  4.77676605e+04]
E1 = -182.57256740499173  E_coul = 54.03461593081833
Extra cycle  E= -128.537951474173  delta_E= -3.69e-13  |g|= 1.03e-06  |ddm|= 9.98e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271012e+02 2.35735412e+02
 7.64287396e+01 1.00355400e+01 2.70471492e+01 3.82532113e-01
 1.12018374e+00 2.87836535e+00 4.57851223e+00 1.36342493e+01
 5.47076665e+01 2.46696939e-01 1.79562888e+00 7.19070835e-01]
E = -128.53795147417338
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.4544719         1
[INPUT] 0    0    [1    /1   ]  833.271011568        1
[INPUT] 0    0    [1    /1   ]  235.735411819        1
[INPUT] 0    0    [1    /1   ]  76.4287395814        1
[INPUT] 0    0    [1    /1   ]  10.0355400266        1
[INPUT] 0    0    [1    /1   ]  27.0471491812        1
[INPUT] 0    0    [1    /1   ]  0.382532113482       1
[INPUT] 0    0    [1    /1   ]  1.12018373569        1
[INPUT] 0    0    [1    /1   ]  2.87836535165        1
[INPUT] 1    0    [1    /1   ]  4.5785122315         1
[INPUT] 1    0    [1    /1   ]  13.6342492754        1
[INPUT] 1    0    [1    /1   ]  54.7076664803        1
[INPUT] 1    0    [1    /1   ]  0.246696938555       1
[INPUT] 1    0    [1    /1   ]  1.79562887614        1
[INPUT] 1    0    [1    /1   ]  0.719070834533       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412995451, 1.0]], [0, [3661.454471898996, 1.0]], [0, [833.2710115684085, 1.0]], [0, [235.73541181887904, 1.0]], [0, [76.42873958136141, 1.0]], [0, [10.03554002656529, 1.0]], [0, [27.047149181220604, 1.0]], [0, [0.3825321134822825, 1.0]], [0, [1.1201837356905258, 1.0]], [0, [2.878365351650874, 1.0]], [1, [4.578512231503692, 1.0]], [1, [13.634249275438506, 1.0]], [1, [54.707666480268955, 1.0]], [1, [0.24669693855467772, 1.0]], [1, [1.7956288761395673, 1.0]], [1, [0.719070834532627, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412995]
bas 1, expnt(s) = [3661.4544719]
bas 2, expnt(s) = [833.27101157]
bas 3, expnt(s) = [235.73541182]
bas 4, expnt(s) = [76.42873958]
bas 5, expnt(s) = [10.03554003]
bas 6, expnt(s) = [27.04714918]
bas 7, expnt(s) = [0.38253211]
bas 8, expnt(s) = [1.12018374]
bas 9, expnt(s) = [2.87836535]
bas 10, expnt(s) = [4.57851223]
bas 11, expnt(s) = [13.63424928]
bas 12, expnt(s) = [54.70766648]
bas 13, expnt(s) = [0.24669694]
bas 14, expnt(s) = [1.79562888]
bas 15, expnt(s) = [0.71907083]
CPU time:        72.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33271012e+02 3.91836356e+02 2.35735412e+02 1.51996520e+02
 7.64287396e+01 6.53066712e+01 1.00355400e+01 1.42452667e+01
 2.70471492e+01 2.99644387e+01 3.82532113e-01 1.22889832e+00
 1.12018374e+00 2.75094540e+00 2.87836535e+00 5.58308787e+00
 4.57851223e+00 1.95384391e+01 1.36342493e+01 7.64316843e+01
 5.47076665e+01 4.34054868e+02 2.46696939e-01 5.07211501e-01
 1.79562888e+00 6.06394311e+00 7.19070835e-01 1.93174139e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999715570398063
cond(S) = 344.6834601665791
E1 = -183.585547432208  E_coul = 55.07988521396062
init E= -128.505662218247
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774871782227642  LUMO = 0.725265414893615
  mo_energy =
[-3.25551861e+01 -1.85259904e+00 -7.74871782e-01 -7.74871782e-01
 -7.74871782e-01  7.25265415e-01  7.25265415e-01  7.25265415e-01
  1.22373520e+00  3.21747538e+00  3.21747538e+00  3.21747538e+00
  7.38835181e+00  1.01761426e+01  1.01761426e+01  1.01761426e+01
  3.20712732e+01  3.20712732e+01  3.20712732e+01  3.47837550e+01
  1.28524199e+02  1.28524199e+02  1.28524199e+02  1.38914812e+02
  5.03008687e+02  1.87064867e+03  8.00032360e+03  4.77679843e+04]
E1 = -182.06178202692115  E_coul = 53.52743061046965
cycle= 1 E= -128.534351416451  delta_E= -0.0287  |g|= 0.207  |ddm|= 0.153
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547645
diis-c [-0.299915  1.      ]
  HOMO = -0.88512947601051  LUMO = 0.703000579739503
  mo_energy =
[-3.28825771e+01 -1.96822378e+00 -8.85129476e-01 -8.85129476e-01
 -8.85129476e-01  7.03000580e-01  7.03000580e-01  7.03000580e-01
  1.17721246e+00  3.13973499e+00  3.13973499e+00  3.13973499e+00
  7.25441142e+00  1.00225828e+01  1.00225828e+01  1.00225828e+01
  3.18251376e+01  3.18251376e+01  3.18251376e+01  3.45334913e+01
  1.28196468e+02  1.28196468e+02  1.28196468e+02  1.38592729e+02
  5.02642534e+02  1.87024649e+03  7.99989242e+03  4.77675342e+04]
E1 = -182.83520229082467  E_coul = 54.298200464055725
cycle= 2 E= -128.537001826769  delta_E= -0.00265  |g|= 0.105  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279242
diis-c [-6.32853552e-04  3.37027940e-01  6.62972060e-01]
  HOMO = -0.848972593517294  LUMO = 0.710280978113957
  mo_energy =
[-3.27730242e+01 -1.93013261e+00 -8.48972594e-01 -8.48972594e-01
 -8.48972594e-01  7.10280978e-01  7.10280978e-01  7.10280978e-01
  1.19212155e+00  3.16487554e+00  3.16487554e+00  3.16487554e+00
  7.29836529e+00  1.00731569e+01  1.00731569e+01  1.00731569e+01
  3.19074071e+01  3.19074071e+01  3.19074071e+01  3.46174050e+01
  1.28305432e+02  1.28305432e+02  1.28305432e+02  1.38700263e+02
  5.02760953e+02  1.87037021e+03  8.00001861e+03  4.77676614e+04]
E1 = -182.5721155166091  E_coul = 54.03416406362585
cycle= 3 E= -128.537951452983  delta_E= -0.00095  |g|= 0.000464  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104968
diis-c [-1.16090712e-07 -2.14347390e-03 -6.45377403e-04  1.00278885e+00]
  HOMO = -0.849217933044467  LUMO = 0.710249697057617
  mo_energy =
[-3.27734458e+01 -1.93033484e+00 -8.49217933e-01 -8.49217933e-01
 -8.49217933e-01  7.10249697e-01  7.10249697e-01  7.10249697e-01
  1.19203563e+00  3.16473434e+00  3.16473434e+00  3.16473434e+00
  7.29815470e+00  1.00729137e+01  1.00729137e+01  1.00729137e+01
  3.19070693e+01  3.19070693e+01  3.19070693e+01  3.46170727e+01
  1.28304999e+02  1.28304999e+02  1.28304999e+02  1.38699840e+02
  5.02760425e+02  1.87036956e+03  8.00001788e+03  4.77676606e+04]
E1 = -182.57244518027673  E_coul = 54.034493706653485
cycle= 4 E= -128.537951473623  delta_E= -2.06e-08  |g|= 7.71e-05  |ddm|= 0.000245
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018945
diis-c [-6.14399713e-10  1.27462651e-04  5.08738278e-04 -1.37928005e-01
  1.13729180e+00]
  HOMO = -0.84925996094707  LUMO = 0.710238256922103
  mo_energy =
[-3.27735186e+01 -1.93037305e+00 -8.49259961e-01 -8.49259961e-01
 -8.49259961e-01  7.10238257e-01  7.10238257e-01  7.10238257e-01
  1.19201322e+00  3.16470005e+00  3.16470005e+00  3.16470005e+00
  7.29810782e+00  1.00728612e+01  1.00728612e+01  1.00728612e+01
  3.19070033e+01  3.19070033e+01  3.19070033e+01  3.46170070e+01
  1.28304926e+02  1.28304926e+02  1.28304926e+02  1.38699768e+02
  5.02760347e+02  1.87036948e+03  8.00001779e+03  4.77676605e+04]
E1 = -182.5725749970367  E_coul = 54.03462352286368
cycle= 5 E= -128.537951474173  delta_E= -5.5e-10  |g|= 2.55e-06  |ddm|= 3.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5725749970367  E_coul = 54.03462352286368
  HOMO = -0.849258836621949  LUMO = 0.710238483530525
  mo_energy =
[-3.27735159e+01 -1.93037156e+00 -8.49258837e-01 -8.49258837e-01
 -8.49258837e-01  7.10238484e-01  7.10238484e-01  7.10238484e-01
  1.19201385e+00  3.16470086e+00  3.16470086e+00  3.16470086e+00
  7.29810942e+00  1.00728627e+01  1.00728627e+01  1.00728627e+01
  3.19070057e+01  3.19070057e+01  3.19070057e+01  3.46170095e+01
  1.28304929e+02  1.28304929e+02  1.28304929e+02  1.38699770e+02
  5.02760349e+02  1.87036948e+03  8.00001779e+03  4.77676605e+04]
E1 = -182.57256740499173  E_coul = 54.03461593081833
Extra cycle  E= -128.537951474173  delta_E= -3.69e-13  |g|= 1.03e-06  |ddm|= 9.98e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.6834601665791
E1 = -182.57256740499173  E_coul = 54.03461593081833
init E= -128.537951474173
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.849259387545529  LUMO = 0.71023837118173
  mo_energy =
[-3.27735175e+01 -1.93037208e+00 -8.49259388e-01 -8.49259388e-01
 -8.49259388e-01  7.10238371e-01  7.10238371e-01  7.10238371e-01
  1.19201365e+00  3.16470048e+00  3.16470048e+00  3.16470048e+00
  7.29810879e+00  1.00728620e+01  1.00728620e+01  1.00728620e+01
  3.19070045e+01  3.19070045e+01  3.19070045e+01  3.46170082e+01
  1.28304927e+02  1.28304927e+02  1.28304927e+02  1.38699769e+02
  5.02760348e+02  1.87036948e+03  8.00001779e+03  4.77676605e+04]
E1 = -182.57257132539326  E_coul = 54.03461985121971
cycle= 1 E= -128.537951474174  delta_E= -1.71e-13  |g|= 5.4e-07  |ddm|= 2.99e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57257132539326  E_coul = 54.03461985121971
  HOMO = -0.849259113035827  LUMO = 0.710238426743255
  mo_energy =
[-3.27735167e+01 -1.93037178e+00 -8.49259113e-01 -8.49259113e-01
 -8.49259113e-01  7.10238427e-01  7.10238427e-01  7.10238427e-01
  1.19201377e+00  3.16470067e+00  3.16470067e+00  3.16470067e+00
  7.29810913e+00  1.00728624e+01  1.00728624e+01  1.00728624e+01
  3.19070051e+01  3.19070051e+01  3.19070051e+01  3.46170089e+01
  1.28304928e+02  1.28304928e+02  1.28304928e+02  1.38699769e+02
  5.02760348e+02  1.87036948e+03  8.00001779e+03  4.77676605e+04]
E1 = -182.5725693112043  E_coul = 54.034617837030524
Extra cycle  E= -128.537951474174  delta_E= -2.27e-13  |g|= 2.73e-07  |ddm|= 1.79e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271012e+02 2.35735412e+02
 7.64287396e+01 1.00355400e+01 2.70471492e+01 3.82532113e-01
 1.12018374e+00 2.87836535e+00 4.57851223e+00 1.36342493e+01
 5.47076665e+01 2.46696939e-01 1.79562888e+00 7.19070835e-01]
grad_E = [ 2.82992840e-11 -1.50740921e-09  3.88137490e-08 -6.28506616e-07
  4.14995476e-06 -1.13700542e-05  6.06706712e-06 -7.65145738e-05
  2.12987696e-04 -4.24235155e-05 -7.96201935e-04 -1.82887753e-04
 -1.28126782e-04 -1.03375403e-02 -2.03314168e-03  1.11323719e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447283        1
[INPUT] 0    0    [1    /1   ]  833.270989358        1
[INPUT] 0    0    [1    /1   ]  235.735741254        1
[INPUT] 0    0    [1    /1   ]  76.4266294119        1
[INPUT] 0    0    [1    /1   ]  10.0349504298        1
[INPUT] 0    0    [1    /1   ]  27.0455137104        1
[INPUT] 0    0    [1    /1   ]  0.3831814647         1
[INPUT] 0    0    [1    /1   ]  1.12166031881        1
[INPUT] 0    0    [1    /1   ]  2.87661442342        1
[INPUT] 1    0    [1    /1   ]  4.84550657548        1
[INPUT] 1    0    [1    /1   ]  14.3218948659        1
[INPUT] 1    0    [1    /1   ]  54.6641250162        1
[INPUT] 1    0    [1    /1   ]  0.231815151652       1
[INPUT] 1    0    [1    /1   ]  1.80282676106        1
[INPUT] 1    0    [1    /1   ]  0.673072394838       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412993692, 1.0]], [0, [3661.454472828679, 1.0]], [0, [833.270989357648, 1.0]], [0, [235.73574125401836, 1.0]], [0, [76.42662941187353, 1.0]], [0, [10.034950429763004, 1.0]], [0, [27.04551371042817, 1.0]], [0, [0.3831814646995623, 1.0]], [0, [1.1216603188067278, 1.0]], [0, [2.8766144234227404, 1.0]], [1, [4.845506575477037, 1.0]], [1, [14.321894865925547, 1.0]], [1, [54.664125016242025, 1.0]], [1, [0.2318151516515331, 1.0]], [1, [1.802826761055435, 1.0]], [1, [0.6730723948380458, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412994]
bas 1, expnt(s) = [3661.45447283]
bas 2, expnt(s) = [833.27098936]
bas 3, expnt(s) = [235.73574125]
bas 4, expnt(s) = [76.42662941]
bas 5, expnt(s) = [10.03495043]
bas 6, expnt(s) = [27.04551371]
bas 7, expnt(s) = [0.38318146]
bas 8, expnt(s) = [1.12166032]
bas 9, expnt(s) = [2.87661442]
bas 10, expnt(s) = [4.84550658]
bas 11, expnt(s) = [14.32189487]
bas 12, expnt(s) = [54.66412502]
bas 13, expnt(s) = [0.23181515]
bas 14, expnt(s) = [1.80282676]
bas 15, expnt(s) = [0.67307239]
CPU time:        74.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270989e+02 3.91836349e+02 2.35735741e+02 1.51996679e+02
 7.64266294e+01 6.53053188e+01 1.00349504e+01 1.42446390e+01
 2.70455137e+01 2.99630798e+01 3.83181465e-01 1.23046253e+00
 1.12166032e+00 2.75366460e+00 2.87661442e+00 5.58054050e+00
 4.84550658e+00 2.09728947e+01 1.43218949e+01 8.12802432e+01
 5.46641250e+01 4.33623084e+02 2.31815152e-01 4.69257979e-01
 1.80282676e+00 6.09434292e+00 6.73072395e-01 1.77853172e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99980224898319
cond(S) = 345.08892798305806
E1 = -183.58634501406235  E_coul = 55.08007779778526
init E= -128.506267216277
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774942705346508  LUMO = 0.675758034159304
  mo_energy =
[-3.25551398e+01 -1.85258303e+00 -7.74942705e-01 -7.74942705e-01
 -7.74942705e-01  6.75758034e-01  6.75758034e-01  6.75758034e-01
  1.22620436e+00  3.06294578e+00  3.06294578e+00  3.06294578e+00
  7.39350985e+00  1.01725860e+01  1.01725860e+01  1.01725860e+01
  3.33772015e+01  3.33772015e+01  3.33772015e+01  3.47847735e+01
  1.31324789e+02  1.31324789e+02  1.31324789e+02  1.38909038e+02
  5.02996518e+02  1.87063472e+03  8.00031070e+03  4.77679734e+04]
E1 = -182.05869344934865  E_coul = 53.523896615902046
cycle= 1 E= -128.534796833447  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546641
diis-c [-0.29881608  1.        ]
  HOMO = -0.88551276090687  LUMO = 0.655349480961498
  mo_energy =
[-3.28830935e+01 -1.96856364e+00 -8.85512761e-01 -8.85512761e-01
 -8.85512761e-01  6.55349481e-01  6.55349481e-01  6.55349481e-01
  1.17944073e+00  2.98600002e+00  2.98600002e+00  2.98600002e+00
  7.25917546e+00  1.00144314e+01  1.00144314e+01  1.00144314e+01
  3.31259825e+01  3.31259825e+01  3.31259825e+01  3.45340253e+01
  1.30996326e+02  1.30996326e+02  1.30996326e+02  1.38586424e+02
  5.02629894e+02  1.87023213e+03  7.99987913e+03  4.77675230e+04]
E1 = -182.83567941721128  E_coul = 54.298221203753094
cycle= 2 E= -128.537458213458  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0633
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279223
diis-c [-6.40094883e-04  3.37415765e-01  6.62584235e-01]
  HOMO = -0.849197045109335  LUMO = 0.662042279093168
  mo_energy =
[-3.27731601e+01 -1.93029708e+00 -8.49197045e-01 -8.49197045e-01
 -8.49197045e-01  6.62042279e-01  6.62042279e-01  6.62042279e-01
  1.19446471e+00  3.01092558e+00  3.01092558e+00  3.01092558e+00
  7.30332194e+00  1.00666476e+01  1.00666476e+01  1.00666476e+01
  3.32101219e+01  3.32101219e+01  3.32101219e+01  3.46182474e+01
  1.31105730e+02  1.31105730e+02  1.31105730e+02  1.38694329e+02
  5.02748708e+02  1.87035625e+03  8.00000572e+03  4.77676506e+04]
E1 = -182.57122451446818  E_coul = 54.03280842726034
cycle= 3 E= -128.538416087208  delta_E= -0.000958  |g|= 0.000444  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010138
diis-c [-1.09915650e-07 -2.09282255e-03 -6.63967060e-04  1.00275679e+00]
  HOMO = -0.849433018709716  LUMO = 0.662018055206612
  mo_energy =
[-3.27735710e+01 -1.93048792e+00 -8.49433019e-01 -8.49433019e-01
 -8.49433019e-01  6.62018055e-01  6.62018055e-01  6.62018055e-01
  1.19438777e+00  3.01079646e+00  3.01079646e+00  3.01079646e+00
  7.30312276e+00  1.00664126e+01  1.00664126e+01  1.00664126e+01
  3.32097921e+01  3.32097921e+01  3.32097921e+01  3.46179278e+01
  1.31105307e+02  1.31105307e+02  1.31105307e+02  1.38693917e+02
  5.02748187e+02  1.87035561e+03  8.00000499e+03  4.77676498e+04]
E1 = -182.57154376270242  E_coul = 54.03312765672448
cycle= 4 E= -128.538416105978  delta_E= -1.88e-08  |g|= 7.48e-05  |ddm|= 0.000231
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184337
diis-c [-6.54424118e-10  1.26333382e-04  5.01320901e-04 -1.38267872e-01
  1.13764022e+00]
  HOMO = -0.849473894372536  LUMO = 0.662007851064803
  mo_energy =
[-3.27736418e+01 -1.93052452e+00 -8.49473894e-01 -8.49473894e-01
 -8.49473894e-01  6.62007851e-01  6.62007851e-01  6.62007851e-01
  1.19436641e+00  3.01076360e+00  3.01076360e+00  3.01076360e+00
  7.30307738e+00  1.00663608e+01  1.00663608e+01  1.00663608e+01
  3.32097276e+01  3.32097276e+01  3.32097276e+01  3.46178641e+01
  1.31105236e+02  1.31105236e+02  1.31105236e+02  1.38693846e+02
  5.02748111e+02  1.87035553e+03  8.00000491e+03  4.77676497e+04]
E1 = -182.57167130315167  E_coul = 54.03325519664559
cycle= 5 E= -128.538416106506  delta_E= -5.28e-10  |g|= 2.69e-06  |ddm|= 3.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57167130315167  E_coul = 54.03325519664559
  HOMO = -0.849472780651611  LUMO = 0.662008047182459
  mo_energy =
[-3.27736391e+01 -1.93052300e+00 -8.49472781e-01 -8.49472781e-01
 -8.49472781e-01  6.62008047e-01  6.62008047e-01  6.62008047e-01
  1.19436705e+00  3.01076438e+00  3.01076438e+00  3.01076438e+00
  7.30307899e+00  1.00663625e+01  1.00663625e+01  1.00663625e+01
  3.32097300e+01  3.32097300e+01  3.32097300e+01  3.46178665e+01
  1.31105239e+02  1.31105239e+02  1.31105239e+02  1.38693849e+02
  5.02748113e+02  1.87035553e+03  8.00000491e+03  4.77676497e+04]
E1 = -182.57166351969312  E_coul = 54.03324741318668
Extra cycle  E= -128.538416106506  delta_E= -3.69e-13  |g|= 1.05e-06  |ddm|= 1.1e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270989e+02 2.35735741e+02
 7.64266294e+01 1.00349504e+01 2.70455137e+01 3.83181465e-01
 1.12166032e+00 2.87661442e+00 4.84550658e+00 1.43218949e+01
 5.46641250e+01 2.31815152e-01 1.80282676e+00 6.73072395e-01]
E = -128.53841610650645
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447283        1
[INPUT] 0    0    [1    /1   ]  833.270989358        1
[INPUT] 0    0    [1    /1   ]  235.735741254        1
[INPUT] 0    0    [1    /1   ]  76.4266294119        1
[INPUT] 0    0    [1    /1   ]  10.0349504298        1
[INPUT] 0    0    [1    /1   ]  27.0455137104        1
[INPUT] 0    0    [1    /1   ]  0.3831814647         1
[INPUT] 0    0    [1    /1   ]  1.12166031881        1
[INPUT] 0    0    [1    /1   ]  2.87661442342        1
[INPUT] 1    0    [1    /1   ]  4.84550657548        1
[INPUT] 1    0    [1    /1   ]  14.3218948659        1
[INPUT] 1    0    [1    /1   ]  54.6641250162        1
[INPUT] 1    0    [1    /1   ]  0.231815151652       1
[INPUT] 1    0    [1    /1   ]  1.80282676106        1
[INPUT] 1    0    [1    /1   ]  0.673072394838       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412993692, 1.0]], [0, [3661.454472828679, 1.0]], [0, [833.270989357648, 1.0]], [0, [235.73574125401836, 1.0]], [0, [76.42662941187353, 1.0]], [0, [10.034950429763004, 1.0]], [0, [27.04551371042817, 1.0]], [0, [0.3831814646995623, 1.0]], [0, [1.1216603188067278, 1.0]], [0, [2.8766144234227404, 1.0]], [1, [4.845506575477037, 1.0]], [1, [14.321894865925547, 1.0]], [1, [54.664125016242025, 1.0]], [1, [0.2318151516515331, 1.0]], [1, [1.802826761055435, 1.0]], [1, [0.6730723948380458, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412994]
bas 1, expnt(s) = [3661.45447283]
bas 2, expnt(s) = [833.27098936]
bas 3, expnt(s) = [235.73574125]
bas 4, expnt(s) = [76.42662941]
bas 5, expnt(s) = [10.03495043]
bas 6, expnt(s) = [27.04551371]
bas 7, expnt(s) = [0.38318146]
bas 8, expnt(s) = [1.12166032]
bas 9, expnt(s) = [2.87661442]
bas 10, expnt(s) = [4.84550658]
bas 11, expnt(s) = [14.32189487]
bas 12, expnt(s) = [54.66412502]
bas 13, expnt(s) = [0.23181515]
bas 14, expnt(s) = [1.80282676]
bas 15, expnt(s) = [0.67307239]
CPU time:        75.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270989e+02 3.91836349e+02 2.35735741e+02 1.51996679e+02
 7.64266294e+01 6.53053188e+01 1.00349504e+01 1.42446390e+01
 2.70455137e+01 2.99630798e+01 3.83181465e-01 1.23046253e+00
 1.12166032e+00 2.75366460e+00 2.87661442e+00 5.58054050e+00
 4.84550658e+00 2.09728947e+01 1.43218949e+01 8.12802432e+01
 5.46641250e+01 4.33623084e+02 2.31815152e-01 4.69257979e-01
 1.80282676e+00 6.09434292e+00 6.73072395e-01 1.77853172e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99980224898319
cond(S) = 345.08892798305806
E1 = -183.58634501406235  E_coul = 55.08007779778526
init E= -128.506267216277
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774942705346508  LUMO = 0.675758034159304
  mo_energy =
[-3.25551398e+01 -1.85258303e+00 -7.74942705e-01 -7.74942705e-01
 -7.74942705e-01  6.75758034e-01  6.75758034e-01  6.75758034e-01
  1.22620436e+00  3.06294578e+00  3.06294578e+00  3.06294578e+00
  7.39350985e+00  1.01725860e+01  1.01725860e+01  1.01725860e+01
  3.33772015e+01  3.33772015e+01  3.33772015e+01  3.47847735e+01
  1.31324789e+02  1.31324789e+02  1.31324789e+02  1.38909038e+02
  5.02996518e+02  1.87063472e+03  8.00031070e+03  4.77679734e+04]
E1 = -182.05869344934865  E_coul = 53.523896615902046
cycle= 1 E= -128.534796833447  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546641
diis-c [-0.29881608  1.        ]
  HOMO = -0.88551276090687  LUMO = 0.655349480961498
  mo_energy =
[-3.28830935e+01 -1.96856364e+00 -8.85512761e-01 -8.85512761e-01
 -8.85512761e-01  6.55349481e-01  6.55349481e-01  6.55349481e-01
  1.17944073e+00  2.98600002e+00  2.98600002e+00  2.98600002e+00
  7.25917546e+00  1.00144314e+01  1.00144314e+01  1.00144314e+01
  3.31259825e+01  3.31259825e+01  3.31259825e+01  3.45340253e+01
  1.30996326e+02  1.30996326e+02  1.30996326e+02  1.38586424e+02
  5.02629894e+02  1.87023213e+03  7.99987913e+03  4.77675230e+04]
E1 = -182.83567941721128  E_coul = 54.298221203753094
cycle= 2 E= -128.537458213458  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0633
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279223
diis-c [-6.40094883e-04  3.37415765e-01  6.62584235e-01]
  HOMO = -0.849197045109335  LUMO = 0.662042279093168
  mo_energy =
[-3.27731601e+01 -1.93029708e+00 -8.49197045e-01 -8.49197045e-01
 -8.49197045e-01  6.62042279e-01  6.62042279e-01  6.62042279e-01
  1.19446471e+00  3.01092558e+00  3.01092558e+00  3.01092558e+00
  7.30332194e+00  1.00666476e+01  1.00666476e+01  1.00666476e+01
  3.32101219e+01  3.32101219e+01  3.32101219e+01  3.46182474e+01
  1.31105730e+02  1.31105730e+02  1.31105730e+02  1.38694329e+02
  5.02748708e+02  1.87035625e+03  8.00000572e+03  4.77676506e+04]
E1 = -182.57122451446818  E_coul = 54.03280842726034
cycle= 3 E= -128.538416087208  delta_E= -0.000958  |g|= 0.000444  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010138
diis-c [-1.09915650e-07 -2.09282255e-03 -6.63967060e-04  1.00275679e+00]
  HOMO = -0.849433018709716  LUMO = 0.662018055206612
  mo_energy =
[-3.27735710e+01 -1.93048792e+00 -8.49433019e-01 -8.49433019e-01
 -8.49433019e-01  6.62018055e-01  6.62018055e-01  6.62018055e-01
  1.19438777e+00  3.01079646e+00  3.01079646e+00  3.01079646e+00
  7.30312276e+00  1.00664126e+01  1.00664126e+01  1.00664126e+01
  3.32097921e+01  3.32097921e+01  3.32097921e+01  3.46179278e+01
  1.31105307e+02  1.31105307e+02  1.31105307e+02  1.38693917e+02
  5.02748187e+02  1.87035561e+03  8.00000499e+03  4.77676498e+04]
E1 = -182.57154376270242  E_coul = 54.03312765672448
cycle= 4 E= -128.538416105978  delta_E= -1.88e-08  |g|= 7.48e-05  |ddm|= 0.000231
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184337
diis-c [-6.54424118e-10  1.26333382e-04  5.01320901e-04 -1.38267872e-01
  1.13764022e+00]
  HOMO = -0.849473894372536  LUMO = 0.662007851064803
  mo_energy =
[-3.27736418e+01 -1.93052452e+00 -8.49473894e-01 -8.49473894e-01
 -8.49473894e-01  6.62007851e-01  6.62007851e-01  6.62007851e-01
  1.19436641e+00  3.01076360e+00  3.01076360e+00  3.01076360e+00
  7.30307738e+00  1.00663608e+01  1.00663608e+01  1.00663608e+01
  3.32097276e+01  3.32097276e+01  3.32097276e+01  3.46178641e+01
  1.31105236e+02  1.31105236e+02  1.31105236e+02  1.38693846e+02
  5.02748111e+02  1.87035553e+03  8.00000491e+03  4.77676497e+04]
E1 = -182.57167130315167  E_coul = 54.03325519664559
cycle= 5 E= -128.538416106506  delta_E= -5.28e-10  |g|= 2.69e-06  |ddm|= 3.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57167130315167  E_coul = 54.03325519664559
  HOMO = -0.849472780651611  LUMO = 0.662008047182459
  mo_energy =
[-3.27736391e+01 -1.93052300e+00 -8.49472781e-01 -8.49472781e-01
 -8.49472781e-01  6.62008047e-01  6.62008047e-01  6.62008047e-01
  1.19436705e+00  3.01076438e+00  3.01076438e+00  3.01076438e+00
  7.30307899e+00  1.00663625e+01  1.00663625e+01  1.00663625e+01
  3.32097300e+01  3.32097300e+01  3.32097300e+01  3.46178665e+01
  1.31105239e+02  1.31105239e+02  1.31105239e+02  1.38693849e+02
  5.02748113e+02  1.87035553e+03  8.00000491e+03  4.77676497e+04]
E1 = -182.57166351969312  E_coul = 54.03324741318668
Extra cycle  E= -128.538416106506  delta_E= -3.69e-13  |g|= 1.05e-06  |ddm|= 1.1e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.08892798305806
E1 = -182.57166351969312  E_coul = 54.03324741318668
init E= -128.538416106506
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849473348601525  LUMO = 0.662007940035959
  mo_energy =
[-3.27736408e+01 -1.93052353e+00 -8.49473349e-01 -8.49473349e-01
 -8.49473349e-01  6.62007940e-01  6.62007940e-01  6.62007940e-01
  1.19436684e+00  3.01076399e+00  3.01076399e+00  3.01076399e+00
  7.30307835e+00  1.00663617e+01  1.00663617e+01  1.00663617e+01
  3.32097287e+01  3.32097287e+01  3.32097287e+01  3.46178653e+01
  1.31105237e+02  1.31105237e+02  1.31105237e+02  1.38693847e+02
  5.02748112e+02  1.87035553e+03  8.00000491e+03  4.77676497e+04]
E1 = -182.57166751244307  E_coul = 54.0332514059369
cycle= 1 E= -128.538416106506  delta_E= 2.84e-13  |g|= 5.51e-07  |ddm|= 3.05e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57166751244307  E_coul = 54.0332514059369
  HOMO = -0.849473069496546  LUMO = 0.662007991589944
  mo_energy =
[-3.27736399e+01 -1.93052323e+00 -8.49473069e-01 -8.49473069e-01
 -8.49473069e-01  6.62007992e-01  6.62007992e-01  6.62007992e-01
  1.19436696e+00  3.01076418e+00  3.01076418e+00  3.01076418e+00
  7.30307870e+00  1.00663621e+01  1.00663621e+01  1.00663621e+01
  3.32097294e+01  3.32097294e+01  3.32097294e+01  3.46178659e+01
  1.31105238e+02  1.31105238e+02  1.31105238e+02  1.38693848e+02
  5.02748112e+02  1.87035553e+03  8.00000491e+03  4.77676497e+04]
E1 = -182.57166545354187  E_coul = 54.03324934703527
Extra cycle  E= -128.538416106507  delta_E= -4.26e-13  |g|= 2.79e-07  |ddm|= 1.85e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270989e+02 2.35735741e+02
 7.64266294e+01 1.00349504e+01 2.70455137e+01 3.83181465e-01
 1.12166032e+00 2.87661442e+00 4.84550658e+00 1.43218949e+01
 5.46641250e+01 2.31815152e-01 1.80282676e+00 6.73072395e-01]
grad_E = [ 2.40886691e-11 -1.29111856e-09  3.49595165e-08 -5.97163863e-07
  4.04623752e-06 -1.57592412e-05  6.75048596e-06 -5.22488866e-05
  2.48261131e-04 -5.63482282e-05 -4.18381329e-04  1.20992612e-04
 -2.08439045e-04 -3.87264289e-03 -1.33071301e-03  4.90682547e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447312        1
[INPUT] 0    0    [1    /1   ]  833.270982392        1
[INPUT] 0    0    [1    /1   ]  235.735844672        1
[INPUT] 0    0    [1    /1   ]  76.4259667073        1
[INPUT] 0    0    [1    /1   ]  10.0347812291        1
[INPUT] 0    0    [1    /1   ]  27.0449954995        1
[INPUT] 0    0    [1    /1   ]  0.383405917845       1
[INPUT] 0    0    [1    /1   ]  1.12186114212        1
[INPUT] 0    0    [1    /1   ]  2.87611779262        1
[INPUT] 1    0    [1    /1   ]  4.94221351217        1
[INPUT] 1    0    [1    /1   ]  14.5321960625        1
[INPUT] 1    0    [1    /1   ]  54.6510031504        1
[INPUT] 1    0    [1    /1   ]  0.224530150941       1
[INPUT] 1    0    [1    /1   ]  1.80248271775        1
[INPUT] 1    0    [1    /1   ]  0.650185721244       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931408, 1.0]], [0, [3661.4544731200035, 1.0]], [0, [833.270982392228, 1.0]], [0, [235.73584467199365, 1.0]], [0, [76.42596670733604, 1.0]], [0, [10.034781229089374, 1.0]], [0, [27.044995499482404, 1.0]], [0, [0.3834059178445308, 1.0]], [0, [1.1218611421169133, 1.0]], [0, [2.876117792624679, 1.0]], [1, [4.942213512170162, 1.0]], [1, [14.53219606252269, 1.0]], [1, [54.6510031504476, 1.0]], [1, [0.22453015094113202, 1.0]], [1, [1.802482717747449, 1.0]], [1, [0.6501857212435629, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447312]
bas 2, expnt(s) = [833.27098239]
bas 3, expnt(s) = [235.73584467]
bas 4, expnt(s) = [76.42596671]
bas 5, expnt(s) = [10.03478123]
bas 6, expnt(s) = [27.0449955]
bas 7, expnt(s) = [0.38340592]
bas 8, expnt(s) = [1.12186114]
bas 9, expnt(s) = [2.87611779]
bas 10, expnt(s) = [4.94221351]
bas 11, expnt(s) = [14.53219606]
bas 12, expnt(s) = [54.65100315]
bas 13, expnt(s) = [0.22453015]
bas 14, expnt(s) = [1.80248272]
bas 15, expnt(s) = [0.65018572]
CPU time:        78.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735845e+02 1.51996729e+02
 7.64259667e+01 6.53048941e+01 1.00347812e+01 1.42444589e+01
 2.70449955e+01 2.99626492e+01 3.83405918e-01 1.23100306e+00
 1.12186114e+00 2.75403435e+00 2.87611779e+00 5.57981790e+00
 4.94221351e+00 2.14974166e+01 1.45321961e+01 8.27748597e+01
 5.46510032e+01 4.33492976e+02 2.24530151e-01 4.50897397e-01
 1.80248272e+00 6.09288918e+00 6.50185721e-01 1.70326090e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9998260882431
cond(S) = 345.17734768764967
E1 = -183.58638750316712  E_coul = 55.0800735653533
init E= -128.506313937814
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774953242152221  LUMO = 0.651070746561888
  mo_energy =
[-3.25551340e+01 -1.85258406e+00 -7.74953242e-01 -7.74953242e-01
 -7.74953242e-01  6.51070747e-01  6.51070747e-01  6.51070747e-01
  1.22684323e+00  2.98109106e+00  2.98109106e+00  2.98109106e+00
  7.39448864e+00  1.01346653e+01  1.01346653e+01  1.01346653e+01
  3.37753939e+01  3.37753939e+01  3.37753939e+01  3.47842634e+01
  1.32195900e+02  1.32195900e+02  1.32195900e+02  1.38906512e+02
  5.02992068e+02  1.87062978e+03  8.00030615e+03  4.77679696e+04]
E1 = -182.0572171496041  E_coul = 53.52239832313733
cycle= 1 E= -128.534818826467  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545902
diis-c [-0.29800911  1.        ]
  HOMO = -0.885640785822668  LUMO = 0.631653183975333
  mo_energy =
[-3.28833398e+01 -1.96870110e+00 -8.85640786e-01 -8.85640786e-01
 -8.85640786e-01  6.31653184e-01  6.31653184e-01  6.31653184e-01
  1.18003686e+00  2.90484133e+00  2.90484133e+00  2.90484133e+00
  7.25999746e+00  9.97481643e+00  9.97481643e+00  9.97481643e+00
  3.35224902e+01  3.35224902e+01  3.35224902e+01  3.45333150e+01
  1.31867114e+02  1.31867114e+02  1.31867114e+02  1.38583658e+02
  5.02625212e+02  1.87022698e+03  7.99987437e+03  4.77675190e+04]
E1 = -182.83581104313868  E_coul = 54.298325066505775
cycle= 2 E= -128.537485976633  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279036
diis-c [-6.42108656e-04  3.37565719e-01  6.62434281e-01]
  HOMO = -0.849252393625257  LUMO = 0.638042476624038
  mo_energy =
[-3.27732303e+01 -1.93035411e+00 -8.49252394e-01 -8.49252394e-01
 -8.49252394e-01  6.38042477e-01  6.38042477e-01  6.38042477e-01
  1.19511044e+00  2.92957730e+00  2.92957730e+00  2.92957730e+00
  7.30423013e+00  1.00276561e+01  1.00276561e+01  1.00276561e+01
  3.36072750e+01  3.36072750e+01  3.36072750e+01  3.46176798e+01
  1.31976717e+02  1.31976717e+02  1.31976717e+02  1.38691736e+02
  5.02744210e+02  1.87035128e+03  8.00000116e+03  4.77676467e+04]
E1 = -182.57088076328913  E_coul = 54.03243353701821
cycle= 3 E= -128.538447226271  delta_E= -0.000961  |g|= 0.000419  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000970579
diis-c [-1.01037086e-07 -2.03549807e-03 -6.94658109e-04  1.00273016e+00]
  HOMO = -0.849475527700025  LUMO = 0.638024703025774
  mo_energy =
[-3.27736225e+01 -1.93052969e+00 -8.49475528e-01 -8.49475528e-01
 -8.49475528e-01  6.38024703e-01  6.38024703e-01  6.38024703e-01
  1.19504513e+00  2.92946238e+00  2.92946238e+00  2.92946238e+00
  7.30404638e+00  1.00274366e+01  1.00274366e+01  1.00274366e+01
  3.36069623e+01  3.36069623e+01  3.36069623e+01  3.46173787e+01
  1.31976312e+02  1.31976312e+02  1.31976312e+02  1.38691342e+02
  5.02743707e+02  1.87035066e+03  8.00000044e+03  4.77676460e+04]
E1 = -182.57119125289913  E_coul = 54.03274401045318
cycle= 4 E= -128.538447242446  delta_E= -1.62e-08  |g|= 7.14e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178771
diis-c [-6.96704696e-10  1.26406275e-04  4.99159224e-04 -1.38328321e-01
  1.13770276e+00]
  HOMO = -0.849514273759294  LUMO = 0.638015654030271
  mo_energy =
[-3.27736900e+01 -1.93056346e+00 -8.49514274e-01 -8.49514274e-01
 -8.49514274e-01  6.38015654e-01  6.38015654e-01  6.38015654e-01
  1.19502576e+00  2.92943179e+00  2.92943179e+00  2.92943179e+00
  7.30400372e+00  1.00273874e+01  1.00273874e+01  1.00273874e+01
  3.36069008e+01  3.36069008e+01  3.36069008e+01  3.46173182e+01
  1.31976245e+02  1.31976245e+02  1.31976245e+02  1.38691275e+02
  5.02743634e+02  1.87035058e+03  8.00000036e+03  4.77676459e+04]
E1 = -182.57131730505927  E_coul = 54.03287006212856
cycle= 5 E= -128.538447242931  delta_E= -4.85e-10  |g|= 2.89e-06  |ddm|= 3.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57131730505927  E_coul = 54.03287006212856
  HOMO = -0.849513148242766  LUMO = 0.638015846708318
  mo_energy =
[-3.27736873e+01 -1.93056184e+00 -8.49513148e-01 -8.49513148e-01
 -8.49513148e-01  6.38015847e-01  6.38015847e-01  6.38015847e-01
  1.19502646e+00  2.92943259e+00  2.92943259e+00  2.92943259e+00
  7.30400540e+00  1.00273890e+01  1.00273890e+01  1.00273890e+01
  3.36069032e+01  3.36069032e+01  3.36069032e+01  3.46173207e+01
  1.31976247e+02  1.31976247e+02  1.31976247e+02  1.38691277e+02
  5.02743636e+02  1.87035058e+03  8.00000036e+03  4.77676459e+04]
E1 = -182.57130968130403  E_coul = 54.03286243837248
Extra cycle  E= -128.538447242932  delta_E= -8.24e-13  |g|= 1.04e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735845e+02
 7.64259667e+01 1.00347812e+01 2.70449955e+01 3.83405918e-01
 1.12186114e+00 2.87611779e+00 4.94221351e+00 1.45321961e+01
 5.46510032e+01 2.24530151e-01 1.80248272e+00 6.50185721e-01]
E = -128.53844724293154
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447312        1
[INPUT] 0    0    [1    /1   ]  833.270982392        1
[INPUT] 0    0    [1    /1   ]  235.735844672        1
[INPUT] 0    0    [1    /1   ]  76.4259667073        1
[INPUT] 0    0    [1    /1   ]  10.0347812291        1
[INPUT] 0    0    [1    /1   ]  27.0449954995        1
[INPUT] 0    0    [1    /1   ]  0.383405917845       1
[INPUT] 0    0    [1    /1   ]  1.12186114212        1
[INPUT] 0    0    [1    /1   ]  2.87611779262        1
[INPUT] 1    0    [1    /1   ]  4.94221351217        1
[INPUT] 1    0    [1    /1   ]  14.5321960625        1
[INPUT] 1    0    [1    /1   ]  54.6510031504        1
[INPUT] 1    0    [1    /1   ]  0.224530150941       1
[INPUT] 1    0    [1    /1   ]  1.80248271775        1
[INPUT] 1    0    [1    /1   ]  0.650185721244       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931408, 1.0]], [0, [3661.4544731200035, 1.0]], [0, [833.270982392228, 1.0]], [0, [235.73584467199365, 1.0]], [0, [76.42596670733604, 1.0]], [0, [10.034781229089374, 1.0]], [0, [27.044995499482404, 1.0]], [0, [0.3834059178445308, 1.0]], [0, [1.1218611421169133, 1.0]], [0, [2.876117792624679, 1.0]], [1, [4.942213512170162, 1.0]], [1, [14.53219606252269, 1.0]], [1, [54.6510031504476, 1.0]], [1, [0.22453015094113202, 1.0]], [1, [1.802482717747449, 1.0]], [1, [0.6501857212435629, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447312]
bas 2, expnt(s) = [833.27098239]
bas 3, expnt(s) = [235.73584467]
bas 4, expnt(s) = [76.42596671]
bas 5, expnt(s) = [10.03478123]
bas 6, expnt(s) = [27.0449955]
bas 7, expnt(s) = [0.38340592]
bas 8, expnt(s) = [1.12186114]
bas 9, expnt(s) = [2.87611779]
bas 10, expnt(s) = [4.94221351]
bas 11, expnt(s) = [14.53219606]
bas 12, expnt(s) = [54.65100315]
bas 13, expnt(s) = [0.22453015]
bas 14, expnt(s) = [1.80248272]
bas 15, expnt(s) = [0.65018572]
CPU time:        78.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735845e+02 1.51996729e+02
 7.64259667e+01 6.53048941e+01 1.00347812e+01 1.42444589e+01
 2.70449955e+01 2.99626492e+01 3.83405918e-01 1.23100306e+00
 1.12186114e+00 2.75403435e+00 2.87611779e+00 5.57981790e+00
 4.94221351e+00 2.14974166e+01 1.45321961e+01 8.27748597e+01
 5.46510032e+01 4.33492976e+02 2.24530151e-01 4.50897397e-01
 1.80248272e+00 6.09288918e+00 6.50185721e-01 1.70326090e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9998260882431
cond(S) = 345.17734768764967
E1 = -183.58638750316712  E_coul = 55.0800735653533
init E= -128.506313937814
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774953242152221  LUMO = 0.651070746561888
  mo_energy =
[-3.25551340e+01 -1.85258406e+00 -7.74953242e-01 -7.74953242e-01
 -7.74953242e-01  6.51070747e-01  6.51070747e-01  6.51070747e-01
  1.22684323e+00  2.98109106e+00  2.98109106e+00  2.98109106e+00
  7.39448864e+00  1.01346653e+01  1.01346653e+01  1.01346653e+01
  3.37753939e+01  3.37753939e+01  3.37753939e+01  3.47842634e+01
  1.32195900e+02  1.32195900e+02  1.32195900e+02  1.38906512e+02
  5.02992068e+02  1.87062978e+03  8.00030615e+03  4.77679696e+04]
E1 = -182.0572171496041  E_coul = 53.52239832313733
cycle= 1 E= -128.534818826467  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545902
diis-c [-0.29800911  1.        ]
  HOMO = -0.885640785822668  LUMO = 0.631653183975333
  mo_energy =
[-3.28833398e+01 -1.96870110e+00 -8.85640786e-01 -8.85640786e-01
 -8.85640786e-01  6.31653184e-01  6.31653184e-01  6.31653184e-01
  1.18003686e+00  2.90484133e+00  2.90484133e+00  2.90484133e+00
  7.25999746e+00  9.97481643e+00  9.97481643e+00  9.97481643e+00
  3.35224902e+01  3.35224902e+01  3.35224902e+01  3.45333150e+01
  1.31867114e+02  1.31867114e+02  1.31867114e+02  1.38583658e+02
  5.02625212e+02  1.87022698e+03  7.99987437e+03  4.77675190e+04]
E1 = -182.83581104313868  E_coul = 54.298325066505775
cycle= 2 E= -128.537485976633  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279036
diis-c [-6.42108656e-04  3.37565719e-01  6.62434281e-01]
  HOMO = -0.849252393625257  LUMO = 0.638042476624038
  mo_energy =
[-3.27732303e+01 -1.93035411e+00 -8.49252394e-01 -8.49252394e-01
 -8.49252394e-01  6.38042477e-01  6.38042477e-01  6.38042477e-01
  1.19511044e+00  2.92957730e+00  2.92957730e+00  2.92957730e+00
  7.30423013e+00  1.00276561e+01  1.00276561e+01  1.00276561e+01
  3.36072750e+01  3.36072750e+01  3.36072750e+01  3.46176798e+01
  1.31976717e+02  1.31976717e+02  1.31976717e+02  1.38691736e+02
  5.02744210e+02  1.87035128e+03  8.00000116e+03  4.77676467e+04]
E1 = -182.57088076328913  E_coul = 54.03243353701821
cycle= 3 E= -128.538447226271  delta_E= -0.000961  |g|= 0.000419  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000970579
diis-c [-1.01037086e-07 -2.03549807e-03 -6.94658109e-04  1.00273016e+00]
  HOMO = -0.849475527700025  LUMO = 0.638024703025774
  mo_energy =
[-3.27736225e+01 -1.93052969e+00 -8.49475528e-01 -8.49475528e-01
 -8.49475528e-01  6.38024703e-01  6.38024703e-01  6.38024703e-01
  1.19504513e+00  2.92946238e+00  2.92946238e+00  2.92946238e+00
  7.30404638e+00  1.00274366e+01  1.00274366e+01  1.00274366e+01
  3.36069623e+01  3.36069623e+01  3.36069623e+01  3.46173787e+01
  1.31976312e+02  1.31976312e+02  1.31976312e+02  1.38691342e+02
  5.02743707e+02  1.87035066e+03  8.00000044e+03  4.77676460e+04]
E1 = -182.57119125289913  E_coul = 54.03274401045318
cycle= 4 E= -128.538447242446  delta_E= -1.62e-08  |g|= 7.14e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178771
diis-c [-6.96704696e-10  1.26406275e-04  4.99159224e-04 -1.38328321e-01
  1.13770276e+00]
  HOMO = -0.849514273759294  LUMO = 0.638015654030271
  mo_energy =
[-3.27736900e+01 -1.93056346e+00 -8.49514274e-01 -8.49514274e-01
 -8.49514274e-01  6.38015654e-01  6.38015654e-01  6.38015654e-01
  1.19502576e+00  2.92943179e+00  2.92943179e+00  2.92943179e+00
  7.30400372e+00  1.00273874e+01  1.00273874e+01  1.00273874e+01
  3.36069008e+01  3.36069008e+01  3.36069008e+01  3.46173182e+01
  1.31976245e+02  1.31976245e+02  1.31976245e+02  1.38691275e+02
  5.02743634e+02  1.87035058e+03  8.00000036e+03  4.77676459e+04]
E1 = -182.57131730505927  E_coul = 54.03287006212856
cycle= 5 E= -128.538447242931  delta_E= -4.85e-10  |g|= 2.89e-06  |ddm|= 3.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57131730505927  E_coul = 54.03287006212856
  HOMO = -0.849513148242766  LUMO = 0.638015846708318
  mo_energy =
[-3.27736873e+01 -1.93056184e+00 -8.49513148e-01 -8.49513148e-01
 -8.49513148e-01  6.38015847e-01  6.38015847e-01  6.38015847e-01
  1.19502646e+00  2.92943259e+00  2.92943259e+00  2.92943259e+00
  7.30400540e+00  1.00273890e+01  1.00273890e+01  1.00273890e+01
  3.36069032e+01  3.36069032e+01  3.36069032e+01  3.46173207e+01
  1.31976247e+02  1.31976247e+02  1.31976247e+02  1.38691277e+02
  5.02743636e+02  1.87035058e+03  8.00000036e+03  4.77676459e+04]
E1 = -182.57130968130403  E_coul = 54.03286243837248
Extra cycle  E= -128.538447242932  delta_E= -8.24e-13  |g|= 1.04e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.17734768764967
E1 = -182.57130968130403  E_coul = 54.03286243837248
init E= -128.538447242932
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849513707351944  LUMO = 0.638015747194722
  mo_energy =
[-3.27736889e+01 -1.93056234e+00 -8.49513707e-01 -8.49513707e-01
 -8.49513707e-01  6.38015747e-01  6.38015747e-01  6.38015747e-01
  1.19502626e+00  2.92943221e+00  2.92943221e+00  2.92943221e+00
  7.30400478e+00  1.00273882e+01  1.00273882e+01  1.00273882e+01
  3.36069019e+01  3.36069019e+01  3.36069019e+01  3.46173194e+01
  1.31976246e+02  1.31976246e+02  1.31976246e+02  1.38691276e+02
  5.02743634e+02  1.87035058e+03  8.00000036e+03  4.77676459e+04]
E1 = -182.57131363591034  E_coul = 54.032866392978946
cycle= 1 E= -128.538447242931  delta_E= 1.42e-13  |g|= 5.49e-07  |ddm|= 3.09e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57131363591034  E_coul = 54.032866392978946
  HOMO = -0.849513431518168  LUMO = 0.638015795938358
  mo_energy =
[-3.27736881e+01 -1.93056204e+00 -8.49513432e-01 -8.49513432e-01
 -8.49513432e-01  6.38015796e-01  6.38015796e-01  6.38015796e-01
  1.19502639e+00  2.92943240e+00  2.92943240e+00  2.92943240e+00
  7.30400512e+00  1.00273887e+01  1.00273887e+01  1.00273887e+01
  3.36069026e+01  3.36069026e+01  3.36069026e+01  3.46173201e+01
  1.31976246e+02  1.31976246e+02  1.31976246e+02  1.38691276e+02
  5.02743635e+02  1.87035058e+03  8.00000036e+03  4.77676459e+04]
E1 = -182.57131160475987  E_coul = 54.032864361828196
Extra cycle  E= -128.538447242932  delta_E= -2.84e-13  |g|= 2.75e-07  |ddm|= 1.87e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735845e+02
 7.64259667e+01 1.00347812e+01 2.70449955e+01 3.83405918e-01
 1.12186114e+00 2.87611779e+00 4.94221351e+00 1.45321961e+01
 5.46510032e+01 2.24530151e-01 1.80248272e+00 6.50185721e-01]
grad_E = [ 2.38252656e-11 -1.27901974e-09  3.48714416e-08 -6.01045169e-07
  4.12688133e-06 -1.45650930e-05  6.28917425e-06  5.27661659e-05
  1.97155073e-04 -5.21146636e-05 -2.37136389e-04  1.28031664e-04
 -2.23234224e-04  2.80301289e-03  3.84779850e-04 -2.41886175e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447305        1
[INPUT] 0    0    [1    /1   ]  833.27098395         1
[INPUT] 0    0    [1    /1   ]  235.735821629        1
[INPUT] 0    0    [1    /1   ]  76.4261142745        1
[INPUT] 0    0    [1    /1   ]  10.0348315067        1
[INPUT] 0    0    [1    /1   ]  27.0451055599        1
[INPUT] 0    0    [1    /1   ]  0.383324969983       1
[INPUT] 0    0    [1    /1   ]  1.12159671959        1
[INPUT] 0    0    [1    /1   ]  2.87627022529        1
[INPUT] 1    0    [1    /1   ]  4.93368094207        1
[INPUT] 1    0    [1    /1   ]  14.4771488877        1
[INPUT] 1    0    [1    /1   ]  54.6545826693        1
[INPUT] 1    0    [1    /1   ]  0.228082655373       1
[INPUT] 1    0    [1    /1   ]  1.81551131287        1
[INPUT] 1    0    [1    /1   ]  0.661909854795       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129932645, 1.0]], [0, [3661.454473054659, 1.0]], [0, [833.2709839499711, 1.0]], [0, [235.7358216293716, 1.0]], [0, [76.42611427447906, 1.0]], [0, [10.034831506731098, 1.0]], [0, [27.045105559897753, 1.0]], [0, [0.38332496998343357, 1.0]], [0, [1.1215967195884442, 1.0]], [0, [2.876270225294071, 1.0]], [1, [4.93368094207128, 1.0]], [1, [14.477148887668198, 1.0]], [1, [54.65458266927525, 1.0]], [1, [0.2280826553731152, 1.0]], [1, [1.815511312874457, 1.0]], [1, [0.6619098547947787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447305]
bas 2, expnt(s) = [833.27098395]
bas 3, expnt(s) = [235.73582163]
bas 4, expnt(s) = [76.42611427]
bas 5, expnt(s) = [10.03483151]
bas 6, expnt(s) = [27.04510556]
bas 7, expnt(s) = [0.38332497]
bas 8, expnt(s) = [1.12159672]
bas 9, expnt(s) = [2.87627023]
bas 10, expnt(s) = [4.93368094]
bas 11, expnt(s) = [14.47714889]
bas 12, expnt(s) = [54.65458267]
bas 13, expnt(s) = [0.22808266]
bas 14, expnt(s) = [1.81551131]
bas 15, expnt(s) = [0.66190985]
CPU time:        81.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270984e+02 3.91836347e+02 2.35735822e+02 1.51996718e+02
 7.64261143e+01 6.53049887e+01 1.00348315e+01 1.42445124e+01
 2.70451056e+01 2.99627406e+01 3.83324970e-01 1.23080813e+00
 1.12159672e+00 2.75354750e+00 2.87627023e+00 5.58003969e+00
 4.93368094e+00 2.14510334e+01 1.44771489e+01 8.23831121e+01
 5.46545827e+01 4.33528468e+02 2.28082655e-01 4.59832558e-01
 1.81551131e+00 6.14798914e+00 6.61909855e-01 1.74173850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999816844322147
cond(S) = 345.11012068511053
E1 = -183.58642178151138  E_coul = 55.080095206749384
init E= -128.506326574762
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77495064986413  LUMO = 0.663498769508784
  mo_energy =
[-3.25551346e+01 -1.85258153e+00 -7.74950650e-01 -7.74950650e-01
 -7.74950650e-01  6.63498770e-01  6.63498770e-01  6.63498770e-01
  1.22650149e+00  3.02918494e+00  3.02918494e+00  3.02918494e+00
  7.39350507e+00  1.02157107e+01  1.02157107e+01  1.02157107e+01
  3.37864897e+01  3.37864897e+01  3.37864897e+01  3.47834796e+01
  1.32077784e+02  1.32077784e+02  1.32077784e+02  1.38906288e+02
  5.02992365e+02  1.87063027e+03  8.00030663e+03  4.77679700e+04]
E1 = -182.05824614834347  E_coul = 53.52341128019776
cycle= 1 E= -128.534834868146  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546262
diis-c [-0.29840246  1.        ]
  HOMO = -0.885561185085847  LUMO = 0.643581128073493
  mo_energy =
[-3.28831670e+01 -1.96860994e+00 -8.85561185e-01 -8.85561185e-01
 -8.85561185e-01  6.43581128e-01  6.43581128e-01  6.43581128e-01
  1.17973932e+00  2.95226920e+00  2.95226920e+00  2.95226920e+00
  7.25911791e+00  1.00560299e+01  1.00560299e+01  1.00560299e+01
  3.35341221e+01  3.35341221e+01  3.35341221e+01  3.45326712e+01
  1.31749222e+02  1.31749222e+02  1.31749222e+02  1.38583602e+02
  5.02625677e+02  1.87022762e+03  7.99987501e+03  4.77675196e+04]
E1 = -182.83599435790003  E_coul = 54.298495611790656
cycle= 2 E= -128.537498746109  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279122
diis-c [-6.41151899e-04  3.37488629e-01  6.62511371e-01]
  HOMO = -0.849210721097799  LUMO = 0.650127378181831
  mo_energy =
[-3.27731523e+01 -1.93030459e+00 -8.49210721e-01 -8.49210721e-01
 -8.49210721e-01  6.50127378e-01  6.50127378e-01  6.50127378e-01
  1.19478784e+00  2.97721119e+00  2.97721119e+00  2.97721119e+00
  7.30330356e+00  1.01087952e+01  1.01087952e+01  1.01087952e+01
  3.36186971e+01  3.36186971e+01  3.36186971e+01  3.46169597e+01
  1.31858714e+02  1.31858714e+02  1.31858714e+02  1.38691587e+02
  5.02744575e+02  1.87035183e+03  8.00000169e+03  4.77676472e+04]
E1 = -182.5713538506332  E_coul = 54.032895770821575
cycle= 3 E= -128.538458079812  delta_E= -0.000959  |g|= 0.000426  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985274
diis-c [-1.03384091e-07 -2.05259532e-03 -6.78981424e-04  1.00273158e+00]
  HOMO = -0.849437565684196  LUMO = 0.650107496046939
  mo_energy =
[-3.27735499e+01 -1.93048446e+00 -8.49437566e-01 -8.49437566e-01
 -8.49437566e-01  6.50107496e-01  6.50107496e-01  6.50107496e-01
  1.19471923e+00  2.97709138e+00  2.97709138e+00  2.97709138e+00
  7.30311542e+00  1.01085708e+01  1.01085708e+01  1.01085708e+01
  3.36183793e+01  3.36183793e+01  3.36183793e+01  3.46166532e+01
  1.31858304e+02  1.31858304e+02  1.31858304e+02  1.38691188e+02
  5.02744067e+02  1.87035120e+03  8.00000097e+03  4.77676464e+04]
E1 = -182.57166839803216  E_coul = 54.03321030135373
cycle= 4 E= -128.538458096678  delta_E= -1.69e-08  |g|= 7.24e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180829
diis-c [-6.83817071e-10  1.26902361e-04  5.01101250e-04 -1.38456696e-01
  1.13782869e+00]
  HOMO = -0.849476912963632  LUMO = 0.650098042510519
  mo_energy =
[-3.27736184e+01 -1.93051899e+00 -8.49476913e-01 -8.49476913e-01
 -8.49476913e-01  6.50098043e-01  6.50098043e-01  6.50098043e-01
  1.19469934e+00  2.97706001e+00  2.97706001e+00  2.97706001e+00
  7.30307202e+00  1.01085207e+01  1.01085207e+01  1.01085207e+01
  3.36183169e+01  3.36183169e+01  3.36183169e+01  3.46165917e+01
  1.31858235e+02  1.31858235e+02  1.31858235e+02  1.38691119e+02
  5.02743993e+02  1.87035112e+03  8.00000089e+03  4.77676464e+04]
E1 = -182.57179526921246  E_coul = 54.03333717203762
cycle= 5 E= -128.538458097175  delta_E= -4.96e-10  |g|= 2.84e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57179526921246  E_coul = 54.03333717203762
  HOMO = -0.849475782622765  LUMO = 0.65009824229801
  mo_energy =
[-3.27736157e+01 -1.93051738e+00 -8.49475783e-01 -8.49475783e-01
 -8.49475783e-01  6.50098242e-01  6.50098242e-01  6.50098242e-01
  1.19470003e+00  2.97706082e+00  2.97706082e+00  2.97706082e+00
  7.30307369e+00  1.01085224e+01  1.01085224e+01  1.01085224e+01
  3.36183193e+01  3.36183193e+01  3.36183193e+01  3.46165942e+01
  1.31858238e+02  1.31858238e+02  1.31858238e+02  1.38691122e+02
  5.02743995e+02  1.87035112e+03  8.00000089e+03  4.77676464e+04]
E1 = -182.57178761701604  E_coul = 54.03332951984066
Extra cycle  E= -128.538458097175  delta_E= -5.4e-13  |g|= 1.05e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270984e+02 2.35735822e+02
 7.64261143e+01 1.00348315e+01 2.70451056e+01 3.83324970e-01
 1.12159672e+00 2.87627023e+00 4.93368094e+00 1.44771489e+01
 5.46545827e+01 2.28082655e-01 1.81551131e+00 6.61909855e-01]
E = -128.53845809717538
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447305        1
[INPUT] 0    0    [1    /1   ]  833.27098395         1
[INPUT] 0    0    [1    /1   ]  235.735821629        1
[INPUT] 0    0    [1    /1   ]  76.4261142745        1
[INPUT] 0    0    [1    /1   ]  10.0348315067        1
[INPUT] 0    0    [1    /1   ]  27.0451055599        1
[INPUT] 0    0    [1    /1   ]  0.383324969983       1
[INPUT] 0    0    [1    /1   ]  1.12159671959        1
[INPUT] 0    0    [1    /1   ]  2.87627022529        1
[INPUT] 1    0    [1    /1   ]  4.93368094207        1
[INPUT] 1    0    [1    /1   ]  14.4771488877        1
[INPUT] 1    0    [1    /1   ]  54.6545826693        1
[INPUT] 1    0    [1    /1   ]  0.228082655373       1
[INPUT] 1    0    [1    /1   ]  1.81551131287        1
[INPUT] 1    0    [1    /1   ]  0.661909854795       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129932645, 1.0]], [0, [3661.454473054659, 1.0]], [0, [833.2709839499711, 1.0]], [0, [235.7358216293716, 1.0]], [0, [76.42611427447906, 1.0]], [0, [10.034831506731098, 1.0]], [0, [27.045105559897753, 1.0]], [0, [0.38332496998343357, 1.0]], [0, [1.1215967195884442, 1.0]], [0, [2.876270225294071, 1.0]], [1, [4.93368094207128, 1.0]], [1, [14.477148887668198, 1.0]], [1, [54.65458266927525, 1.0]], [1, [0.2280826553731152, 1.0]], [1, [1.815511312874457, 1.0]], [1, [0.6619098547947787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447305]
bas 2, expnt(s) = [833.27098395]
bas 3, expnt(s) = [235.73582163]
bas 4, expnt(s) = [76.42611427]
bas 5, expnt(s) = [10.03483151]
bas 6, expnt(s) = [27.04510556]
bas 7, expnt(s) = [0.38332497]
bas 8, expnt(s) = [1.12159672]
bas 9, expnt(s) = [2.87627023]
bas 10, expnt(s) = [4.93368094]
bas 11, expnt(s) = [14.47714889]
bas 12, expnt(s) = [54.65458267]
bas 13, expnt(s) = [0.22808266]
bas 14, expnt(s) = [1.81551131]
bas 15, expnt(s) = [0.66190985]
CPU time:        82.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270984e+02 3.91836347e+02 2.35735822e+02 1.51996718e+02
 7.64261143e+01 6.53049887e+01 1.00348315e+01 1.42445124e+01
 2.70451056e+01 2.99627406e+01 3.83324970e-01 1.23080813e+00
 1.12159672e+00 2.75354750e+00 2.87627023e+00 5.58003969e+00
 4.93368094e+00 2.14510334e+01 1.44771489e+01 8.23831121e+01
 5.46545827e+01 4.33528468e+02 2.28082655e-01 4.59832558e-01
 1.81551131e+00 6.14798914e+00 6.61909855e-01 1.74173850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999816844322147
cond(S) = 345.11012068511053
E1 = -183.58642178151138  E_coul = 55.080095206749384
init E= -128.506326574762
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77495064986413  LUMO = 0.663498769508784
  mo_energy =
[-3.25551346e+01 -1.85258153e+00 -7.74950650e-01 -7.74950650e-01
 -7.74950650e-01  6.63498770e-01  6.63498770e-01  6.63498770e-01
  1.22650149e+00  3.02918494e+00  3.02918494e+00  3.02918494e+00
  7.39350507e+00  1.02157107e+01  1.02157107e+01  1.02157107e+01
  3.37864897e+01  3.37864897e+01  3.37864897e+01  3.47834796e+01
  1.32077784e+02  1.32077784e+02  1.32077784e+02  1.38906288e+02
  5.02992365e+02  1.87063027e+03  8.00030663e+03  4.77679700e+04]
E1 = -182.05824614834347  E_coul = 53.52341128019776
cycle= 1 E= -128.534834868146  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546262
diis-c [-0.29840246  1.        ]
  HOMO = -0.885561185085847  LUMO = 0.643581128073493
  mo_energy =
[-3.28831670e+01 -1.96860994e+00 -8.85561185e-01 -8.85561185e-01
 -8.85561185e-01  6.43581128e-01  6.43581128e-01  6.43581128e-01
  1.17973932e+00  2.95226920e+00  2.95226920e+00  2.95226920e+00
  7.25911791e+00  1.00560299e+01  1.00560299e+01  1.00560299e+01
  3.35341221e+01  3.35341221e+01  3.35341221e+01  3.45326712e+01
  1.31749222e+02  1.31749222e+02  1.31749222e+02  1.38583602e+02
  5.02625677e+02  1.87022762e+03  7.99987501e+03  4.77675196e+04]
E1 = -182.83599435790003  E_coul = 54.298495611790656
cycle= 2 E= -128.537498746109  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279122
diis-c [-6.41151899e-04  3.37488629e-01  6.62511371e-01]
  HOMO = -0.849210721097799  LUMO = 0.650127378181831
  mo_energy =
[-3.27731523e+01 -1.93030459e+00 -8.49210721e-01 -8.49210721e-01
 -8.49210721e-01  6.50127378e-01  6.50127378e-01  6.50127378e-01
  1.19478784e+00  2.97721119e+00  2.97721119e+00  2.97721119e+00
  7.30330356e+00  1.01087952e+01  1.01087952e+01  1.01087952e+01
  3.36186971e+01  3.36186971e+01  3.36186971e+01  3.46169597e+01
  1.31858714e+02  1.31858714e+02  1.31858714e+02  1.38691587e+02
  5.02744575e+02  1.87035183e+03  8.00000169e+03  4.77676472e+04]
E1 = -182.5713538506332  E_coul = 54.032895770821575
cycle= 3 E= -128.538458079812  delta_E= -0.000959  |g|= 0.000426  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985274
diis-c [-1.03384091e-07 -2.05259532e-03 -6.78981424e-04  1.00273158e+00]
  HOMO = -0.849437565684196  LUMO = 0.650107496046939
  mo_energy =
[-3.27735499e+01 -1.93048446e+00 -8.49437566e-01 -8.49437566e-01
 -8.49437566e-01  6.50107496e-01  6.50107496e-01  6.50107496e-01
  1.19471923e+00  2.97709138e+00  2.97709138e+00  2.97709138e+00
  7.30311542e+00  1.01085708e+01  1.01085708e+01  1.01085708e+01
  3.36183793e+01  3.36183793e+01  3.36183793e+01  3.46166532e+01
  1.31858304e+02  1.31858304e+02  1.31858304e+02  1.38691188e+02
  5.02744067e+02  1.87035120e+03  8.00000097e+03  4.77676464e+04]
E1 = -182.57166839803216  E_coul = 54.03321030135373
cycle= 4 E= -128.538458096678  delta_E= -1.69e-08  |g|= 7.24e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180829
diis-c [-6.83817071e-10  1.26902361e-04  5.01101250e-04 -1.38456696e-01
  1.13782869e+00]
  HOMO = -0.849476912963632  LUMO = 0.650098042510519
  mo_energy =
[-3.27736184e+01 -1.93051899e+00 -8.49476913e-01 -8.49476913e-01
 -8.49476913e-01  6.50098043e-01  6.50098043e-01  6.50098043e-01
  1.19469934e+00  2.97706001e+00  2.97706001e+00  2.97706001e+00
  7.30307202e+00  1.01085207e+01  1.01085207e+01  1.01085207e+01
  3.36183169e+01  3.36183169e+01  3.36183169e+01  3.46165917e+01
  1.31858235e+02  1.31858235e+02  1.31858235e+02  1.38691119e+02
  5.02743993e+02  1.87035112e+03  8.00000089e+03  4.77676464e+04]
E1 = -182.57179526921246  E_coul = 54.03333717203762
cycle= 5 E= -128.538458097175  delta_E= -4.96e-10  |g|= 2.84e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57179526921246  E_coul = 54.03333717203762
  HOMO = -0.849475782622765  LUMO = 0.65009824229801
  mo_energy =
[-3.27736157e+01 -1.93051738e+00 -8.49475783e-01 -8.49475783e-01
 -8.49475783e-01  6.50098242e-01  6.50098242e-01  6.50098242e-01
  1.19470003e+00  2.97706082e+00  2.97706082e+00  2.97706082e+00
  7.30307369e+00  1.01085224e+01  1.01085224e+01  1.01085224e+01
  3.36183193e+01  3.36183193e+01  3.36183193e+01  3.46165942e+01
  1.31858238e+02  1.31858238e+02  1.31858238e+02  1.38691122e+02
  5.02743995e+02  1.87035112e+03  8.00000089e+03  4.77676464e+04]
E1 = -182.57178761701604  E_coul = 54.03332951984066
Extra cycle  E= -128.538458097175  delta_E= -5.4e-13  |g|= 1.05e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.11012068511053
E1 = -182.57178761701604  E_coul = 54.03332951984066
init E= -128.538458097175
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849476342790861  LUMO = 0.650098140127015
  mo_energy =
[-3.27736174e+01 -1.93051789e+00 -8.49476343e-01 -8.49476343e-01
 -8.49476343e-01  6.50098140e-01  6.50098140e-01  6.50098140e-01
  1.19469983e+00  2.97706044e+00  2.97706044e+00  2.97706044e+00
  7.30307306e+00  1.01085216e+01  1.01085216e+01  1.01085216e+01
  3.36183181e+01  3.36183181e+01  3.36183181e+01  3.46165930e+01
  1.31858236e+02  1.31858236e+02  1.31858236e+02  1.38691120e+02
  5.02743994e+02  1.87035112e+03  8.00000089e+03  4.77676464e+04]
E1 = -182.57179158491428  E_coul = 54.0333334877387
cycle= 1 E= -128.538458097176  delta_E= -1.99e-13  |g|= 5.5e-07  |ddm|= 3.08e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57179158491428  E_coul = 54.0333334877387
  HOMO = -0.849476065835519  LUMO = 0.650098190324366
  mo_energy =
[-3.27736165e+01 -1.93051758e+00 -8.49476066e-01 -8.49476066e-01
 -8.49476066e-01  6.50098190e-01  6.50098190e-01  6.50098190e-01
  1.19469996e+00  2.97706063e+00  2.97706063e+00  2.97706063e+00
  7.30307341e+00  1.01085220e+01  1.01085220e+01  1.01085220e+01
  3.36183187e+01  3.36183187e+01  3.36183187e+01  3.46165936e+01
  1.31858237e+02  1.31858237e+02  1.31858237e+02  1.38691121e+02
  5.02743994e+02  1.87035112e+03  8.00000089e+03  4.77676464e+04]
E1 = -182.57178954694334  E_coul = 54.03333144976806
Extra cycle  E= -128.538458097175  delta_E= 3.13e-13  |g|= 2.76e-07  |ddm|= 1.87e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270984e+02 2.35735822e+02
 7.64261143e+01 1.00348315e+01 2.70451056e+01 3.83324970e-01
 1.12159672e+00 2.87627023e+00 4.93368094e+00 1.44771489e+01
 5.46545827e+01 2.28082655e-01 1.81551131e+00 6.61909855e-01]
grad_E = [ 2.44907887e-11 -1.31369814e-09  3.55341180e-08 -6.08032003e-07
  4.17352509e-06 -1.34855785e-05  6.01247259e-06  7.16790655e-05
  1.87109890e-04 -4.97586981e-05 -2.56876106e-04  9.78213887e-05
 -2.16793332e-04  9.80562900e-04 -5.68358571e-05 -1.24959117e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447306        1
[INPUT] 0    0    [1    /1   ]  833.270983786        1
[INPUT] 0    0    [1    /1   ]  235.73582419         1
[INPUT] 0    0    [1    /1   ]  76.4260976082        1
[INPUT] 0    0    [1    /1   ]  10.0348451514        1
[INPUT] 0    0    [1    /1   ]  27.0450866595        1
[INPUT] 0    0    [1    /1   ]  0.383230859984       1
[INPUT] 0    0    [1    /1   ]  1.12132146341        1
[INPUT] 0    0    [1    /1   ]  2.87632025442        1
[INPUT] 1    0    [1    /1   ]  4.94863593752        1
[INPUT] 1    0    [1    /1   ]  14.4741374618        1
[INPUT] 1    0    [1    /1   ]  54.6550134986        1
[INPUT] 1    0    [1    /1   ]  0.228412441146       1
[INPUT] 1    0    [1    /1   ]  1.82588187106        1
[INPUT] 1    0    [1    /1   ]  0.665455982425       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412993252, 1.0]], [0, [3661.454473061263, 1.0]], [0, [833.270983785689, 1.0]], [0, [235.73582419003137, 1.0]], [0, [76.42609760815029, 1.0]], [0, [10.034845151399495, 1.0]], [0, [27.045086659494313, 1.0]], [0, [0.3832308599840906, 1.0]], [0, [1.1213214634062676, 1.0]], [0, [2.876320254421736, 1.0]], [1, [4.948635937522659, 1.0]], [1, [14.474137461759724, 1.0]], [1, [54.65501349855153, 1.0]], [1, [0.22841244114574905, 1.0]], [1, [1.825881871058486, 1.0]], [1, [0.6654559824248578, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447306]
bas 2, expnt(s) = [833.27098379]
bas 3, expnt(s) = [235.73582419]
bas 4, expnt(s) = [76.42609761]
bas 5, expnt(s) = [10.03484515]
bas 6, expnt(s) = [27.04508666]
bas 7, expnt(s) = [0.38323086]
bas 8, expnt(s) = [1.12132146]
bas 9, expnt(s) = [2.87632025]
bas 10, expnt(s) = [4.94863594]
bas 11, expnt(s) = [14.47413746]
bas 12, expnt(s) = [54.6550135]
bas 13, expnt(s) = [0.22841244]
bas 14, expnt(s) = [1.82588187]
bas 15, expnt(s) = [0.66545598]
CPU time:        84.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270984e+02 3.91836347e+02 2.35735824e+02 1.51996719e+02
 7.64260976e+01 6.53049780e+01 1.00348452e+01 1.42445269e+01
 2.70450867e+01 2.99627249e+01 3.83230860e-01 1.23058149e+00
 1.12132146e+00 2.75304066e+00 2.87632025e+00 5.58011249e+00
 4.94863594e+00 2.15323422e+01 1.44741375e+01 8.23616917e+01
 5.46550135e+01 4.33532739e+02 2.28412441e-01 4.60663801e-01
 1.82588187e+00 6.19191860e+00 6.65455982e-01 1.75341033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999814692583339
cond(S) = 345.034138593628
E1 = -183.58641969499234  E_coul = 55.08009587509719
init E= -128.506323819895
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950625495078  LUMO = 0.66549487916439
  mo_energy =
[-3.25551360e+01 -1.85258141e+00 -7.74950625e-01 -7.74950625e-01
 -7.74950625e-01  6.65494879e-01  6.65494879e-01  6.65494879e-01
  1.22610033e+00  3.04415347e+00  3.04415347e+00  3.04415347e+00
  7.39229285e+00  1.02665470e+01  1.02665470e+01  1.02665470e+01
  3.38736350e+01  3.38736350e+01  3.38736350e+01  3.47820944e+01
  1.32157397e+02  1.32157397e+02  1.32157397e+02  1.38905036e+02
  5.02991208e+02  1.87062922e+03  8.00030571e+03  4.77679693e+04]
E1 = -182.05807468706914  E_coul = 53.52323620468918
cycle= 1 E= -128.53483848238  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546319
diis-c [-0.29846478  1.        ]
  HOMO = -0.885578546720158  LUMO = 0.645459494523967
  mo_energy =
[-3.28831858e+01 -1.96862865e+00 -8.85578547e-01 -8.85578547e-01
 -8.85578547e-01  6.45459495e-01  6.45459495e-01  6.45459495e-01
  1.17933357e+00  2.96684832e+00  2.96684832e+00  2.96684832e+00
  7.25789066e+00  1.01065325e+01  1.01065325e+01  1.01065325e+01
  3.36212473e+01  3.36212473e+01  3.36212473e+01  3.45312615e+01
  1.31828842e+02  1.31828842e+02  1.31828842e+02  1.38582330e+02
  5.02624498e+02  1.87022655e+03  7.99987406e+03  4.77675188e+04]
E1 = -182.8358546286079  E_coul = 54.29835217589918
cycle= 2 E= -128.537502452709  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279161
diis-c [-6.40939897e-04  3.37496845e-01  6.62503155e-01]
  HOMO = -0.849227226950435  LUMO = 0.652041312871155
  mo_energy =
[-3.27731670e+01 -1.93032257e+00 -8.49227227e-01 -8.49227227e-01
 -8.49227227e-01  6.52041313e-01  6.52041313e-01  6.52041313e-01
  1.19437776e+00  2.99191256e+00  2.99191256e+00  2.99191256e+00
  7.30207599e+00  1.01594053e+01  1.01594053e+01  1.01594053e+01
  3.37058254e+01  3.37058254e+01  3.37058254e+01  3.46155532e+01
  1.31938330e+02  1.31938330e+02  1.31938330e+02  1.38690319e+02
  5.02743400e+02  1.87035076e+03  8.00000074e+03  4.77676464e+04]
E1 = -182.57117135851493  E_coul = 54.032709375774274
cycle= 3 E= -128.538461982741  delta_E= -0.00096  |g|= 0.00043  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00099076
diis-c [-1.04488394e-07 -2.06006684e-03 -6.75133080e-04  1.00273520e+00]
  HOMO = -0.849455939310794  LUMO = 0.652020615849847
  mo_energy =
[-3.27735673e+01 -1.93050473e+00 -8.49455939e-01 -8.49455939e-01
 -8.49455939e-01  6.52020616e-01  6.52020616e-01  6.52020616e-01
  1.19430751e+00  2.99179041e+00  2.99179041e+00  2.99179041e+00
  7.30188560e+00  1.01591781e+01  1.01591781e+01  1.01591781e+01
  3.37055050e+01  3.37055050e+01  3.37055050e+01  3.46152441e+01
  1.31937917e+02  1.31937917e+02  1.31937917e+02  1.38689917e+02
  5.02742889e+02  1.87035013e+03  8.00000002e+03  4.77676456e+04]
E1 = -182.5714869624815  E_coul = 54.033024962548616
cycle= 4 E= -128.538461999933  delta_E= -1.72e-08  |g|= 7.28e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181435
diis-c [-6.75915138e-10  1.26316476e-04  5.00453636e-04 -1.38228838e-01
  1.13760207e+00]
  HOMO = -0.849495583966179  LUMO = 0.652011013712855
  mo_energy =
[-3.27736362e+01 -1.93053968e+00 -8.49495584e-01 -8.49495584e-01
 -8.49495584e-01  6.52011014e-01  6.52011014e-01  6.52011014e-01
  1.19428733e+00  2.99175864e+00  2.99175864e+00  2.99175864e+00
  7.30184181e+00  1.01591276e+01  1.01591276e+01  1.01591276e+01
  3.37054422e+01  3.37054422e+01  3.37054422e+01  3.46151821e+01
  1.31937848e+02  1.31937848e+02  1.31937848e+02  1.38689848e+02
  5.02742815e+02  1.87035005e+03  7.99999994e+03  4.77676456e+04]
E1 = -182.57161400353323  E_coul = 54.033152003099744
cycle= 5 E= -128.538462000433  delta_E= -5.01e-10  |g|= 2.81e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57161400353323  E_coul = 54.033152003099744
  HOMO = -0.849494457849887  LUMO = 0.65201121273111
  mo_energy =
[-3.27736335e+01 -1.93053809e+00 -8.49494458e-01 -8.49494458e-01
 -8.49494458e-01  6.52011213e-01  6.52011213e-01  6.52011213e-01
  1.19428801e+00  2.99175945e+00  2.99175945e+00  2.99175945e+00
  7.30184347e+00  1.01591292e+01  1.01591292e+01  1.01591292e+01
  3.37054446e+01  3.37054446e+01  3.37054446e+01  3.46151846e+01
  1.31937851e+02  1.31937851e+02  1.31937851e+02  1.38689851e+02
  5.02742817e+02  1.87035005e+03  7.99999994e+03  4.77676456e+04]
E1 = -182.57160631707933  E_coul = 54.03314431664484
Extra cycle  E= -128.538462000434  delta_E= -1.02e-12  |g|= 1.05e-06  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270984e+02 2.35735824e+02
 7.64260976e+01 1.00348452e+01 2.70450867e+01 3.83230860e-01
 1.12132146e+00 2.87632025e+00 4.94863594e+00 1.44741375e+01
 5.46550135e+01 2.28412441e-01 1.82588187e+00 6.65455982e-01]
E = -128.5384620004345
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447306        1
[INPUT] 0    0    [1    /1   ]  833.270983786        1
[INPUT] 0    0    [1    /1   ]  235.73582419         1
[INPUT] 0    0    [1    /1   ]  76.4260976082        1
[INPUT] 0    0    [1    /1   ]  10.0348451514        1
[INPUT] 0    0    [1    /1   ]  27.0450866595        1
[INPUT] 0    0    [1    /1   ]  0.383230859984       1
[INPUT] 0    0    [1    /1   ]  1.12132146341        1
[INPUT] 0    0    [1    /1   ]  2.87632025442        1
[INPUT] 1    0    [1    /1   ]  4.94863593752        1
[INPUT] 1    0    [1    /1   ]  14.4741374618        1
[INPUT] 1    0    [1    /1   ]  54.6550134986        1
[INPUT] 1    0    [1    /1   ]  0.228412441146       1
[INPUT] 1    0    [1    /1   ]  1.82588187106        1
[INPUT] 1    0    [1    /1   ]  0.665455982425       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412993252, 1.0]], [0, [3661.454473061263, 1.0]], [0, [833.270983785689, 1.0]], [0, [235.73582419003137, 1.0]], [0, [76.42609760815029, 1.0]], [0, [10.034845151399495, 1.0]], [0, [27.045086659494313, 1.0]], [0, [0.3832308599840906, 1.0]], [0, [1.1213214634062676, 1.0]], [0, [2.876320254421736, 1.0]], [1, [4.948635937522659, 1.0]], [1, [14.474137461759724, 1.0]], [1, [54.65501349855153, 1.0]], [1, [0.22841244114574905, 1.0]], [1, [1.825881871058486, 1.0]], [1, [0.6654559824248578, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447306]
bas 2, expnt(s) = [833.27098379]
bas 3, expnt(s) = [235.73582419]
bas 4, expnt(s) = [76.42609761]
bas 5, expnt(s) = [10.03484515]
bas 6, expnt(s) = [27.04508666]
bas 7, expnt(s) = [0.38323086]
bas 8, expnt(s) = [1.12132146]
bas 9, expnt(s) = [2.87632025]
bas 10, expnt(s) = [4.94863594]
bas 11, expnt(s) = [14.47413746]
bas 12, expnt(s) = [54.6550135]
bas 13, expnt(s) = [0.22841244]
bas 14, expnt(s) = [1.82588187]
bas 15, expnt(s) = [0.66545598]
CPU time:        85.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270984e+02 3.91836347e+02 2.35735824e+02 1.51996719e+02
 7.64260976e+01 6.53049780e+01 1.00348452e+01 1.42445269e+01
 2.70450867e+01 2.99627249e+01 3.83230860e-01 1.23058149e+00
 1.12132146e+00 2.75304066e+00 2.87632025e+00 5.58011249e+00
 4.94863594e+00 2.15323422e+01 1.44741375e+01 8.23616917e+01
 5.46550135e+01 4.33532739e+02 2.28412441e-01 4.60663801e-01
 1.82588187e+00 6.19191860e+00 6.65455982e-01 1.75341033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999814692583339
cond(S) = 345.034138593628
E1 = -183.58641969499234  E_coul = 55.08009587509719
init E= -128.506323819895
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950625495078  LUMO = 0.66549487916439
  mo_energy =
[-3.25551360e+01 -1.85258141e+00 -7.74950625e-01 -7.74950625e-01
 -7.74950625e-01  6.65494879e-01  6.65494879e-01  6.65494879e-01
  1.22610033e+00  3.04415347e+00  3.04415347e+00  3.04415347e+00
  7.39229285e+00  1.02665470e+01  1.02665470e+01  1.02665470e+01
  3.38736350e+01  3.38736350e+01  3.38736350e+01  3.47820944e+01
  1.32157397e+02  1.32157397e+02  1.32157397e+02  1.38905036e+02
  5.02991208e+02  1.87062922e+03  8.00030571e+03  4.77679693e+04]
E1 = -182.05807468706914  E_coul = 53.52323620468918
cycle= 1 E= -128.53483848238  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546319
diis-c [-0.29846478  1.        ]
  HOMO = -0.885578546720158  LUMO = 0.645459494523967
  mo_energy =
[-3.28831858e+01 -1.96862865e+00 -8.85578547e-01 -8.85578547e-01
 -8.85578547e-01  6.45459495e-01  6.45459495e-01  6.45459495e-01
  1.17933357e+00  2.96684832e+00  2.96684832e+00  2.96684832e+00
  7.25789066e+00  1.01065325e+01  1.01065325e+01  1.01065325e+01
  3.36212473e+01  3.36212473e+01  3.36212473e+01  3.45312615e+01
  1.31828842e+02  1.31828842e+02  1.31828842e+02  1.38582330e+02
  5.02624498e+02  1.87022655e+03  7.99987406e+03  4.77675188e+04]
E1 = -182.8358546286079  E_coul = 54.29835217589918
cycle= 2 E= -128.537502452709  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279161
diis-c [-6.40939897e-04  3.37496845e-01  6.62503155e-01]
  HOMO = -0.849227226950435  LUMO = 0.652041312871155
  mo_energy =
[-3.27731670e+01 -1.93032257e+00 -8.49227227e-01 -8.49227227e-01
 -8.49227227e-01  6.52041313e-01  6.52041313e-01  6.52041313e-01
  1.19437776e+00  2.99191256e+00  2.99191256e+00  2.99191256e+00
  7.30207599e+00  1.01594053e+01  1.01594053e+01  1.01594053e+01
  3.37058254e+01  3.37058254e+01  3.37058254e+01  3.46155532e+01
  1.31938330e+02  1.31938330e+02  1.31938330e+02  1.38690319e+02
  5.02743400e+02  1.87035076e+03  8.00000074e+03  4.77676464e+04]
E1 = -182.57117135851493  E_coul = 54.032709375774274
cycle= 3 E= -128.538461982741  delta_E= -0.00096  |g|= 0.00043  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00099076
diis-c [-1.04488394e-07 -2.06006684e-03 -6.75133080e-04  1.00273520e+00]
  HOMO = -0.849455939310794  LUMO = 0.652020615849847
  mo_energy =
[-3.27735673e+01 -1.93050473e+00 -8.49455939e-01 -8.49455939e-01
 -8.49455939e-01  6.52020616e-01  6.52020616e-01  6.52020616e-01
  1.19430751e+00  2.99179041e+00  2.99179041e+00  2.99179041e+00
  7.30188560e+00  1.01591781e+01  1.01591781e+01  1.01591781e+01
  3.37055050e+01  3.37055050e+01  3.37055050e+01  3.46152441e+01
  1.31937917e+02  1.31937917e+02  1.31937917e+02  1.38689917e+02
  5.02742889e+02  1.87035013e+03  8.00000002e+03  4.77676456e+04]
E1 = -182.5714869624815  E_coul = 54.033024962548616
cycle= 4 E= -128.538461999933  delta_E= -1.72e-08  |g|= 7.28e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181435
diis-c [-6.75915138e-10  1.26316476e-04  5.00453636e-04 -1.38228838e-01
  1.13760207e+00]
  HOMO = -0.849495583966179  LUMO = 0.652011013712855
  mo_energy =
[-3.27736362e+01 -1.93053968e+00 -8.49495584e-01 -8.49495584e-01
 -8.49495584e-01  6.52011014e-01  6.52011014e-01  6.52011014e-01
  1.19428733e+00  2.99175864e+00  2.99175864e+00  2.99175864e+00
  7.30184181e+00  1.01591276e+01  1.01591276e+01  1.01591276e+01
  3.37054422e+01  3.37054422e+01  3.37054422e+01  3.46151821e+01
  1.31937848e+02  1.31937848e+02  1.31937848e+02  1.38689848e+02
  5.02742815e+02  1.87035005e+03  7.99999994e+03  4.77676456e+04]
E1 = -182.57161400353323  E_coul = 54.033152003099744
cycle= 5 E= -128.538462000433  delta_E= -5.01e-10  |g|= 2.81e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57161400353323  E_coul = 54.033152003099744
  HOMO = -0.849494457849887  LUMO = 0.65201121273111
  mo_energy =
[-3.27736335e+01 -1.93053809e+00 -8.49494458e-01 -8.49494458e-01
 -8.49494458e-01  6.52011213e-01  6.52011213e-01  6.52011213e-01
  1.19428801e+00  2.99175945e+00  2.99175945e+00  2.99175945e+00
  7.30184347e+00  1.01591292e+01  1.01591292e+01  1.01591292e+01
  3.37054446e+01  3.37054446e+01  3.37054446e+01  3.46151846e+01
  1.31937851e+02  1.31937851e+02  1.31937851e+02  1.38689851e+02
  5.02742817e+02  1.87035005e+03  7.99999994e+03  4.77676456e+04]
E1 = -182.57160631707933  E_coul = 54.03314431664484
Extra cycle  E= -128.538462000434  delta_E= -1.02e-12  |g|= 1.05e-06  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.034138593628
E1 = -182.57160631707933  E_coul = 54.03314431664484
init E= -128.538462000434
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849495020210505  LUMO = 0.652011109380618
  mo_energy =
[-3.27736352e+01 -1.93053861e+00 -8.49495020e-01 -8.49495020e-01
 -8.49495020e-01  6.52011109e-01  6.52011109e-01  6.52011109e-01
  1.19428781e+00  2.99175906e+00  2.99175906e+00  2.99175906e+00
  7.30184283e+00  1.01591284e+01  1.01591284e+01  1.01591284e+01
  3.37054433e+01  3.37054433e+01  3.37054433e+01  3.46151834e+01
  1.31937849e+02  1.31937849e+02  1.31937849e+02  1.38689849e+02
  5.02742816e+02  1.87035005e+03  7.99999994e+03  4.77676456e+04]
E1 = -182.57161029339025  E_coul = 54.033148292955815
cycle= 1 E= -128.538462000434  delta_E= 5.68e-14  |g|= 5.51e-07  |ddm|= 3.08e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57161029339025  E_coul = 54.033148292955815
  HOMO = -0.849494742584581  LUMO = 0.652011159929491
  mo_energy =
[-3.27736343e+01 -1.93053830e+00 -8.49494743e-01 -8.49494743e-01
 -8.49494743e-01  6.52011160e-01  6.52011160e-01  6.52011160e-01
  1.19428793e+00  2.99175925e+00  2.99175925e+00  2.99175925e+00
  7.30184318e+00  1.01591288e+01  1.01591288e+01  1.01591288e+01
  3.37054440e+01  3.37054440e+01  3.37054440e+01  3.46151840e+01
  1.31937850e+02  1.31937850e+02  1.31937850e+02  1.38689850e+02
  5.02742816e+02  1.87035005e+03  7.99999994e+03  4.77676456e+04]
E1 = -182.57160824912467  E_coul = 54.03314624869042
Extra cycle  E= -128.538462000434  delta_E= 1.99e-13  |g|= 2.77e-07  |ddm|= 1.87e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270984e+02 2.35735824e+02
 7.64260976e+01 1.00348452e+01 2.70450867e+01 3.83230860e-01
 1.12132146e+00 2.87632025e+00 4.94863594e+00 1.44741375e+01
 5.46550135e+01 2.28412441e-01 1.82588187e+00 6.65455982e-01]
grad_E = [ 2.51235488e-11 -1.34706206e-09  3.62088426e-08 -6.16350433e-07
  4.24247553e-06 -1.22020757e-05  5.62249950e-06  7.53637385e-05
  1.76493567e-04 -4.73193507e-05 -1.93217578e-04  6.18144363e-05
 -2.13378190e-04 -1.31451343e-04 -6.72695365e-05  3.25491942e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.4544731         1
[INPUT] 0    0    [1    /1   ]  833.270982848        1
[INPUT] 0    0    [1    /1   ]  235.735838389        1
[INPUT] 0    0    [1    /1   ]  76.42600593          1
[INPUT] 0    0    [1    /1   ]  10.0348621176        1
[INPUT] 0    0    [1    /1   ]  27.0450029714        1
[INPUT] 0    0    [1    /1   ]  0.383006276786       1
[INPUT] 0    0    [1    /1   ]  1.1207245467         1
[INPUT] 0    0    [1    /1   ]  2.87639816942        1
[INPUT] 1    0    [1    /1   ]  4.98550944434        1
[INPUT] 1    0    [1    /1   ]  14.4863963676        1
[INPUT] 1    0    [1    /1   ]  54.6548401852        1
[INPUT] 1    0    [1    /1   ]  0.229959528892       1
[INPUT] 1    0    [1    /1   ]  1.84620801103        1
[INPUT] 1    0    [1    /1   ]  0.671747825763       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931794, 1.0]], [0, [3661.454473099873, 1.0]], [0, [833.2709828480714, 1.0]], [0, [235.73583838898506, 1.0]], [0, [76.42600593002119, 1.0]], [0, [10.034862117633535, 1.0]], [0, [27.04500297142779, 1.0]], [0, [0.3830062767859319, 1.0]], [0, [1.1207245467001772, 1.0]], [0, [2.8763981694215093, 1.0]], [1, [4.98550944434385, 1.0]], [1, [14.486396367561937, 1.0]], [1, [54.65484018524686, 1.0]], [1, [0.22995952889183766, 1.0]], [1, [1.846208011029029, 1.0]], [1, [0.6717478257631819, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.4544731]
bas 2, expnt(s) = [833.27098285]
bas 3, expnt(s) = [235.73583839]
bas 4, expnt(s) = [76.42600593]
bas 5, expnt(s) = [10.03486212]
bas 6, expnt(s) = [27.04500297]
bas 7, expnt(s) = [0.38300628]
bas 8, expnt(s) = [1.12072455]
bas 9, expnt(s) = [2.87639817]
bas 10, expnt(s) = [4.98550944]
bas 11, expnt(s) = [14.48639637]
bas 12, expnt(s) = [54.65484019]
bas 13, expnt(s) = [0.22995953]
bas 14, expnt(s) = [1.84620801]
bas 15, expnt(s) = [0.67174783]
CPU time:        88.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270983e+02 3.91836346e+02 2.35735838e+02 1.51996726e+02
 7.64260059e+01 6.53049193e+01 1.00348621e+01 1.42445450e+01
 2.70450030e+01 2.99626554e+01 3.83006277e-01 1.23004059e+00
 1.12072455e+00 2.75194144e+00 2.87639817e+00 5.58022586e+00
 4.98550944e+00 2.17330822e+01 1.44863964e+01 8.24488965e+01
 5.46548402e+01 4.33531021e+02 2.29959529e-01 4.64567319e-01
 1.84620801e+00 6.27820050e+00 6.71747826e-01 1.77415774e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999809347921353
cond(S) = 344.86262093801037
E1 = -183.58642388854656  E_coul = 55.08010103606711
init E= -128.506322852479
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774949625061252  LUMO = 0.671504365255887
  mo_energy =
[-3.25551373e+01 -1.85258068e+00 -7.74949625e-01 -7.74949625e-01
 -7.74949625e-01  6.71504365e-01  6.71504365e-01  6.71504365e-01
  1.22516585e+00  3.07540194e+00  3.07540194e+00  3.07540194e+00
  7.38953692e+00  1.03725047e+01  1.03725047e+01  1.03725047e+01
  3.40854586e+01  3.40854586e+01  3.40854586e+01  3.47788433e+01
  1.32393160e+02  1.32393160e+02  1.32393160e+02  1.38901943e+02
  5.02988182e+02  1.87062639e+03  8.00030320e+03  4.77679672e+04]
E1 = -182.0586430107213  E_coul = 53.52379896415517
cycle= 1 E= -128.534844046566  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546495
diis-c [-0.29865628  1.        ]
  HOMO = -0.885536029856578  LUMO = 0.651219178813525
  mo_energy =
[-3.28830831e+01 -1.96857832e+00 -8.85536030e-01 -8.85536030e-01
 -8.85536030e-01  6.51219179e-01  6.51219179e-01  6.51219179e-01
  1.17845764e+00  2.99742590e+00  2.99742590e+00  2.99742590e+00
  7.25519785e+00  1.02118551e+01  1.02118551e+01  1.02118551e+01
  3.38330498e+01  3.38330498e+01  3.38330498e+01  3.45280907e+01
  1.32064754e+02  1.32064754e+02  1.32064754e+02  1.38579336e+02
  5.02621573e+02  1.87022383e+03  7.99987165e+03  4.77675168e+04]
E1 = -182.8360458393164  E_coul = 54.29853930582322
cycle= 2 E= -128.537506533493  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279202
diis-c [-6.40415138e-04  3.37458523e-01  6.62541477e-01]
  HOMO = -0.849201325283539  LUMO = 0.657883059053967
  mo_energy =
[-3.27731064e+01 -1.93029033e+00 -8.49201325e-01 -8.49201325e-01
 -8.49201325e-01  6.57883059e-01  6.57883059e-01  6.57883059e-01
  1.19348434e+00  3.02271058e+00  3.02271058e+00  3.02271058e+00
  7.29935915e+00  1.02649407e+01  1.02649407e+01  1.02649407e+01
  3.39176302e+01  3.39176302e+01  3.39176302e+01  3.46123491e+01
  1.32174185e+02  1.32174185e+02  1.32174185e+02  1.38687284e+02
  5.02740431e+02  1.87034799e+03  7.99999829e+03  4.77676444e+04]
E1 = -182.57152750626915  E_coul = 54.03306239971273
cycle= 3 E= -128.538465106556  delta_E= -0.000959  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000991867
diis-c [-1.03849334e-07 -2.05808630e-03 -6.66940685e-04  1.00272503e+00]
  HOMO = -0.849429237812522  LUMO = 0.657862403585554
  mo_energy =
[-3.27735055e+01 -1.93047124e+00 -8.49429238e-01 -8.49429238e-01
 -8.49429238e-01  6.57862404e-01  6.57862404e-01  6.57862404e-01
  1.19341505e+00  3.02258819e+00  3.02258819e+00  3.02258819e+00
  7.29916988e+00  1.02647137e+01  1.02647137e+01  1.02647137e+01
  3.39173108e+01  3.39173108e+01  3.39173108e+01  3.46120411e+01
  1.32173773e+02  1.32173773e+02  1.32173773e+02  1.38686884e+02
  5.02739921e+02  1.87034736e+03  7.99999757e+03  4.77676436e+04]
E1 = -182.57184557422806  E_coul = 54.033380450682564
cycle= 4 E= -128.538465123546  delta_E= -1.7e-08  |g|= 7.27e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181831
diis-c [-6.81173498e-10  1.27462570e-04  5.02476575e-04 -1.38627837e-01
  1.13799790e+00]
  HOMO = -0.849468705463137  LUMO = 0.657852777693359
  mo_energy =
[-3.27735743e+01 -1.93050587e+00 -8.49468705e-01 -8.49468705e-01
 -8.49468705e-01  6.57852778e-01  6.57852778e-01  6.57852778e-01
  1.19339513e+00  3.02255641e+00  3.02255641e+00  3.02255641e+00
  7.29912636e+00  1.02646633e+01  1.02646633e+01  1.02646633e+01
  3.39172481e+01  3.39172481e+01  3.39172481e+01  3.46119794e+01
  1.32173704e+02  1.32173704e+02  1.32173704e+02  1.38686815e+02
  5.02739847e+02  1.87034728e+03  7.99999749e+03  4.77676435e+04]
E1 = -182.571973250492  E_coul = 54.03350812644896
cycle= 5 E= -128.538465124043  delta_E= -4.98e-10  |g|= 2.85e-06  |ddm|= 3.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.571973250492  E_coul = 54.03350812644896
  HOMO = -0.849467556464832  LUMO = 0.657852988393845
  mo_energy =
[-3.27735716e+01 -1.93050424e+00 -8.49467556e-01 -8.49467556e-01
 -8.49467556e-01  6.57852988e-01  6.57852988e-01  6.57852988e-01
  1.19339583e+00  3.02255725e+00  3.02255725e+00  3.02255725e+00
  7.29912806e+00  1.02646650e+01  1.02646650e+01  1.02646650e+01
  3.39172506e+01  3.39172506e+01  3.39172506e+01  3.46119819e+01
  1.32173707e+02  1.32173707e+02  1.32173707e+02  1.38686818e+02
  5.02739849e+02  1.87034728e+03  7.99999749e+03  4.77676435e+04]
E1 = -182.57196557957923  E_coul = 54.03350045553537
Extra cycle  E= -128.538465124044  delta_E= -8.24e-13  |g|= 1.05e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270983e+02 2.35735838e+02
 7.64260059e+01 1.00348621e+01 2.70450030e+01 3.83006277e-01
 1.12072455e+00 2.87639817e+00 4.98550944e+00 1.44863964e+01
 5.46548402e+01 2.29959529e-01 1.84620801e+00 6.71747826e-01]
E = -128.53846512404385
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:15:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.4544731         1
[INPUT] 0    0    [1    /1   ]  833.270982848        1
[INPUT] 0    0    [1    /1   ]  235.735838389        1
[INPUT] 0    0    [1    /1   ]  76.42600593          1
[INPUT] 0    0    [1    /1   ]  10.0348621176        1
[INPUT] 0    0    [1    /1   ]  27.0450029714        1
[INPUT] 0    0    [1    /1   ]  0.383006276786       1
[INPUT] 0    0    [1    /1   ]  1.1207245467         1
[INPUT] 0    0    [1    /1   ]  2.87639816942        1
[INPUT] 1    0    [1    /1   ]  4.98550944434        1
[INPUT] 1    0    [1    /1   ]  14.4863963676        1
[INPUT] 1    0    [1    /1   ]  54.6548401852        1
[INPUT] 1    0    [1    /1   ]  0.229959528892       1
[INPUT] 1    0    [1    /1   ]  1.84620801103        1
[INPUT] 1    0    [1    /1   ]  0.671747825763       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931794, 1.0]], [0, [3661.454473099873, 1.0]], [0, [833.2709828480714, 1.0]], [0, [235.73583838898506, 1.0]], [0, [76.42600593002119, 1.0]], [0, [10.034862117633535, 1.0]], [0, [27.04500297142779, 1.0]], [0, [0.3830062767859319, 1.0]], [0, [1.1207245467001772, 1.0]], [0, [2.8763981694215093, 1.0]], [1, [4.98550944434385, 1.0]], [1, [14.486396367561937, 1.0]], [1, [54.65484018524686, 1.0]], [1, [0.22995952889183766, 1.0]], [1, [1.846208011029029, 1.0]], [1, [0.6717478257631819, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.4544731]
bas 2, expnt(s) = [833.27098285]
bas 3, expnt(s) = [235.73583839]
bas 4, expnt(s) = [76.42600593]
bas 5, expnt(s) = [10.03486212]
bas 6, expnt(s) = [27.04500297]
bas 7, expnt(s) = [0.38300628]
bas 8, expnt(s) = [1.12072455]
bas 9, expnt(s) = [2.87639817]
bas 10, expnt(s) = [4.98550944]
bas 11, expnt(s) = [14.48639637]
bas 12, expnt(s) = [54.65484019]
bas 13, expnt(s) = [0.22995953]
bas 14, expnt(s) = [1.84620801]
bas 15, expnt(s) = [0.67174783]
CPU time:        88.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270983e+02 3.91836346e+02 2.35735838e+02 1.51996726e+02
 7.64260059e+01 6.53049193e+01 1.00348621e+01 1.42445450e+01
 2.70450030e+01 2.99626554e+01 3.83006277e-01 1.23004059e+00
 1.12072455e+00 2.75194144e+00 2.87639817e+00 5.58022586e+00
 4.98550944e+00 2.17330822e+01 1.44863964e+01 8.24488965e+01
 5.46548402e+01 4.33531021e+02 2.29959529e-01 4.64567319e-01
 1.84620801e+00 6.27820050e+00 6.71747826e-01 1.77415774e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999809347921353
cond(S) = 344.86262093801037
E1 = -183.58642388854656  E_coul = 55.08010103606711
init E= -128.506322852479
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774949625061252  LUMO = 0.671504365255887
  mo_energy =
[-3.25551373e+01 -1.85258068e+00 -7.74949625e-01 -7.74949625e-01
 -7.74949625e-01  6.71504365e-01  6.71504365e-01  6.71504365e-01
  1.22516585e+00  3.07540194e+00  3.07540194e+00  3.07540194e+00
  7.38953692e+00  1.03725047e+01  1.03725047e+01  1.03725047e+01
  3.40854586e+01  3.40854586e+01  3.40854586e+01  3.47788433e+01
  1.32393160e+02  1.32393160e+02  1.32393160e+02  1.38901943e+02
  5.02988182e+02  1.87062639e+03  8.00030320e+03  4.77679672e+04]
E1 = -182.0586430107213  E_coul = 53.52379896415517
cycle= 1 E= -128.534844046566  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546495
diis-c [-0.29865628  1.        ]
  HOMO = -0.885536029856578  LUMO = 0.651219178813525
  mo_energy =
[-3.28830831e+01 -1.96857832e+00 -8.85536030e-01 -8.85536030e-01
 -8.85536030e-01  6.51219179e-01  6.51219179e-01  6.51219179e-01
  1.17845764e+00  2.99742590e+00  2.99742590e+00  2.99742590e+00
  7.25519785e+00  1.02118551e+01  1.02118551e+01  1.02118551e+01
  3.38330498e+01  3.38330498e+01  3.38330498e+01  3.45280907e+01
  1.32064754e+02  1.32064754e+02  1.32064754e+02  1.38579336e+02
  5.02621573e+02  1.87022383e+03  7.99987165e+03  4.77675168e+04]
E1 = -182.8360458393164  E_coul = 54.29853930582322
cycle= 2 E= -128.537506533493  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279202
diis-c [-6.40415138e-04  3.37458523e-01  6.62541477e-01]
  HOMO = -0.849201325283539  LUMO = 0.657883059053967
  mo_energy =
[-3.27731064e+01 -1.93029033e+00 -8.49201325e-01 -8.49201325e-01
 -8.49201325e-01  6.57883059e-01  6.57883059e-01  6.57883059e-01
  1.19348434e+00  3.02271058e+00  3.02271058e+00  3.02271058e+00
  7.29935915e+00  1.02649407e+01  1.02649407e+01  1.02649407e+01
  3.39176302e+01  3.39176302e+01  3.39176302e+01  3.46123491e+01
  1.32174185e+02  1.32174185e+02  1.32174185e+02  1.38687284e+02
  5.02740431e+02  1.87034799e+03  7.99999829e+03  4.77676444e+04]
E1 = -182.57152750626915  E_coul = 54.03306239971273
cycle= 3 E= -128.538465106556  delta_E= -0.000959  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000991867
diis-c [-1.03849334e-07 -2.05808630e-03 -6.66940685e-04  1.00272503e+00]
  HOMO = -0.849429237812522  LUMO = 0.657862403585554
  mo_energy =
[-3.27735055e+01 -1.93047124e+00 -8.49429238e-01 -8.49429238e-01
 -8.49429238e-01  6.57862404e-01  6.57862404e-01  6.57862404e-01
  1.19341505e+00  3.02258819e+00  3.02258819e+00  3.02258819e+00
  7.29916988e+00  1.02647137e+01  1.02647137e+01  1.02647137e+01
  3.39173108e+01  3.39173108e+01  3.39173108e+01  3.46120411e+01
  1.32173773e+02  1.32173773e+02  1.32173773e+02  1.38686884e+02
  5.02739921e+02  1.87034736e+03  7.99999757e+03  4.77676436e+04]
E1 = -182.57184557422806  E_coul = 54.033380450682564
cycle= 4 E= -128.538465123546  delta_E= -1.7e-08  |g|= 7.27e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181831
diis-c [-6.81173498e-10  1.27462570e-04  5.02476575e-04 -1.38627837e-01
  1.13799790e+00]
  HOMO = -0.849468705463137  LUMO = 0.657852777693359
  mo_energy =
[-3.27735743e+01 -1.93050587e+00 -8.49468705e-01 -8.49468705e-01
 -8.49468705e-01  6.57852778e-01  6.57852778e-01  6.57852778e-01
  1.19339513e+00  3.02255641e+00  3.02255641e+00  3.02255641e+00
  7.29912636e+00  1.02646633e+01  1.02646633e+01  1.02646633e+01
  3.39172481e+01  3.39172481e+01  3.39172481e+01  3.46119794e+01
  1.32173704e+02  1.32173704e+02  1.32173704e+02  1.38686815e+02
  5.02739847e+02  1.87034728e+03  7.99999749e+03  4.77676435e+04]
E1 = -182.571973250492  E_coul = 54.03350812644896
cycle= 5 E= -128.538465124043  delta_E= -4.98e-10  |g|= 2.85e-06  |ddm|= 3.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.571973250492  E_coul = 54.03350812644896
  HOMO = -0.849467556464832  LUMO = 0.657852988393845
  mo_energy =
[-3.27735716e+01 -1.93050424e+00 -8.49467556e-01 -8.49467556e-01
 -8.49467556e-01  6.57852988e-01  6.57852988e-01  6.57852988e-01
  1.19339583e+00  3.02255725e+00  3.02255725e+00  3.02255725e+00
  7.29912806e+00  1.02646650e+01  1.02646650e+01  1.02646650e+01
  3.39172506e+01  3.39172506e+01  3.39172506e+01  3.46119819e+01
  1.32173707e+02  1.32173707e+02  1.32173707e+02  1.38686818e+02
  5.02739849e+02  1.87034728e+03  7.99999749e+03  4.77676435e+04]
E1 = -182.57196557957923  E_coul = 54.03350045553537
Extra cycle  E= -128.538465124044  delta_E= -8.24e-13  |g|= 1.05e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.86262093801037
E1 = -182.57196557957923  E_coul = 54.03350045553537
init E= -128.538465124044
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.849468117421009  LUMO = 0.657852884776059
  mo_energy =
[-3.27735732e+01 -1.93050475e+00 -8.49468117e-01 -8.49468117e-01
 -8.49468117e-01  6.57852885e-01  6.57852885e-01  6.57852885e-01
  1.19339564e+00  3.02255686e+00  3.02255686e+00  3.02255686e+00
  7.29912743e+00  1.02646642e+01  1.02646642e+01  1.02646642e+01
  3.39172493e+01  3.39172493e+01  3.39172493e+01  3.46119806e+01
  1.32173705e+02  1.32173705e+02  1.32173705e+02  1.38686816e+02
  5.02739847e+02  1.87034728e+03  7.99999749e+03  4.77676435e+04]
E1 = -182.57196957387052  E_coul = 54.03350444982664
cycle= 1 E= -128.538465124044  delta_E= -2.84e-14  |g|= 5.53e-07  |ddm|= 3.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57196957387052  E_coul = 54.03350444982664
  HOMO = -0.849467838533895  LUMO = 0.657852936344068
  mo_energy =
[-3.27735724e+01 -1.93050444e+00 -8.49467839e-01 -8.49467839e-01
 -8.49467839e-01  6.57852936e-01  6.57852936e-01  6.57852936e-01
  1.19339576e+00  3.02255706e+00  3.02255706e+00  3.02255706e+00
  7.29912778e+00  1.02646646e+01  1.02646646e+01  1.02646646e+01
  3.39172500e+01  3.39172500e+01  3.39172500e+01  3.46119813e+01
  1.32173706e+02  1.32173706e+02  1.32173706e+02  1.38686817e+02
  5.02739848e+02  1.87034728e+03  7.99999749e+03  4.77676435e+04]
E1 = -182.5719675253519  E_coul = 54.03350240130779
Extra cycle  E= -128.538465124044  delta_E= -2.27e-13  |g|= 2.77e-07  |ddm|= 1.88e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270983e+02 2.35735838e+02
 7.64260059e+01 1.00348621e+01 2.70450030e+01 3.83006277e-01
 1.12072455e+00 2.87639817e+00 4.98550944e+00 1.44863964e+01
 5.46548402e+01 2.29959529e-01 1.84620801e+00 6.71747826e-01]
grad_E = [ 2.64313169e-11 -1.41617170e-09  3.76201350e-08 -6.34184723e-07
  4.39466344e-06 -9.41481073e-06  4.76077769e-06  6.25235286e-05
  1.55936045e-04 -4.22499334e-05 -8.25468059e-05 -4.23651863e-07
 -2.08402887e-04  3.65435400e-04  1.61244421e-04 -1.70252772e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447311        1
[INPUT] 0    0    [1    /1   ]  833.27098261         1
[INPUT] 0    0    [1    /1   ]  235.735842023        1
[INPUT] 0    0    [1    /1   ]  76.4259822062        1
[INPUT] 0    0    [1    /1   ]  10.0348710622        1
[INPUT] 0    0    [1    /1   ]  27.0449821395        1
[INPUT] 0    0    [1    /1   ]  0.38292531855        1
[INPUT] 0    0    [1    /1   ]  1.12050879606        1
[INPUT] 0    0    [1    /1   ]  2.87644286274        1
[INPUT] 1    0    [1    /1   ]  4.98980405575        1
[INPUT] 1    0    [1    /1   ]  14.4914071697        1
[INPUT] 1    0    [1    /1   ]  54.6548082308        1
[INPUT] 1    0    [1    /1   ]  0.22933444907        1
[INPUT] 1    0    [1    /1   ]  1.8464489645         1
[INPUT] 1    0    [1    /1   ]  0.670862003787       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412993161, 1.0]], [0, [3661.45447310959, 1.0]], [0, [833.270982610434, 1.0]], [0, [235.735842023389, 1.0]], [0, [76.42598220618977, 1.0]], [0, [10.034871062181853, 1.0]], [0, [27.044982139493857, 1.0]], [0, [0.3829253185499491, 1.0]], [0, [1.120508796055939, 1.0]], [0, [2.876442862743138, 1.0]], [1, [4.9898040557516605, 1.0]], [1, [14.49140716971371, 1.0]], [1, [54.65480823076471, 1.0]], [1, [0.22933444907013545, 1.0]], [1, [1.846448964503249, 1.0]], [1, [0.670862003787211, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447311]
bas 2, expnt(s) = [833.27098261]
bas 3, expnt(s) = [235.73584202]
bas 4, expnt(s) = [76.42598221]
bas 5, expnt(s) = [10.03487106]
bas 6, expnt(s) = [27.04498214]
bas 7, expnt(s) = [0.38292532]
bas 8, expnt(s) = [1.1205088]
bas 9, expnt(s) = [2.87644286]
bas 10, expnt(s) = [4.98980406]
bas 11, expnt(s) = [14.49140717]
bas 12, expnt(s) = [54.65480823]
bas 13, expnt(s) = [0.22933445]
bas 14, expnt(s) = [1.84644896]
bas 15, expnt(s) = [0.670862]
CPU time:        91.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270983e+02 3.91836346e+02 2.35735842e+02 1.51996728e+02
 7.64259822e+01 6.53049041e+01 1.00348711e+01 1.42445545e+01
 2.70449821e+01 2.99626381e+01 3.82925319e-01 1.22984558e+00
 1.12050880e+00 2.75154409e+00 2.87644286e+00 5.58029088e+00
 4.98980406e+00 2.17564863e+01 1.44914072e+01 8.24845466e+01
 5.46548082e+01 4.33530704e+02 2.29334449e-01 4.62989363e-01
 1.84644896e+00 6.27922475e+00 6.70862004e-01 1.77123378e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999810702143295
cond(S) = 344.80127846680006
E1 = -183.58641640197564  E_coul = 55.080096745261535
init E= -128.506319656714
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950242312102  LUMO = 0.669685055671416
  mo_energy =
[-3.25551379e+01 -1.85258127e+00 -7.74950242e-01 -7.74950242e-01
 -7.74950242e-01  6.69685056e-01  6.69685056e-01  6.69685056e-01
  1.22483080e+00  3.07103369e+00  3.07103369e+00  3.07103369e+00
  7.38856070e+00  1.03709075e+01  1.03709075e+01  1.03709075e+01
  3.40988827e+01  3.40988827e+01  3.40988827e+01  3.47777388e+01
  1.32419744e+02  1.32419744e+02  1.32419744e+02  1.38900928e+02
  5.02987216e+02  1.87062550e+03  8.00030242e+03  4.77679665e+04]
E1 = -182.0582524741246  E_coul = 53.523409723126704
cycle= 1 E= -128.534842750998  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546466
diis-c [-0.29862468  1.        ]
  HOMO = -0.885568658452581  LUMO = 0.649451399007376
  mo_energy =
[-3.28831439e+01 -1.96861488e+00 -8.85568658e-01 -8.85568658e-01
 -8.85568658e-01  6.49451399e-01  6.49451399e-01  6.49451399e-01
  1.17811009e+00  2.99305264e+00  2.99305264e+00  2.99305264e+00
  7.25418594e+00  1.02101413e+01  1.02101413e+01  1.02101413e+01
  3.38463733e+01  3.38463733e+01  3.38463733e+01  3.45269297e+01
  1.32091277e+02  1.32091277e+02  1.32091277e+02  1.38578262e+02
  5.02620545e+02  1.87022287e+03  7.99987080e+03  4.77675161e+04]
E1 = -182.83588863711088  E_coul = 54.298382490457236
cycle= 2 E= -128.537506146654  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279218
diis-c [-6.40504996e-04  3.37483081e-01  6.62516919e-01]
  HOMO = -0.849223866327979  LUMO = 0.656097350415659
  mo_energy =
[-3.27731406e+01 -1.93031602e+00 -8.49223866e-01 -8.49223866e-01
 -8.49223866e-01  6.56097350e-01  6.56097350e-01  6.56097350e-01
  1.19313851e+00  3.01833739e+00  3.01833739e+00  3.01833739e+00
  7.29835847e+00  1.02632662e+01  1.02632662e+01  1.02632662e+01
  3.39309912e+01  3.39309912e+01  3.39309912e+01  3.46112097e+01
  1.32200735e+02  1.32200735e+02  1.32200735e+02  1.38686236e+02
  5.02739431e+02  1.87034706e+03  7.99999747e+03  4.77676437e+04]
E1 = -182.57126246050595  E_coul = 54.03279711377892
cycle= 3 E= -128.538465346727  delta_E= -0.000959  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993128
diis-c [-1.04423426e-07 -2.06072921e-03 -6.68174482e-04  1.00272890e+00]
  HOMO = -0.849452603714362  LUMO = 0.656076462050092
  mo_energy =
[-3.27735408e+01 -1.93049801e+00 -8.49452604e-01 -8.49452604e-01
 -8.49452604e-01  6.56076462e-01  6.56076462e-01  6.56076462e-01
  1.19306846e+00  3.01821427e+00  3.01821427e+00  3.01821427e+00
  7.29816818e+00  1.02630380e+01  1.02630380e+01  1.02630380e+01
  3.39306706e+01  3.39306706e+01  3.39306706e+01  3.46109005e+01
  1.32200322e+02  1.32200322e+02  1.32200322e+02  1.38685834e+02
  5.02738920e+02  1.87034643e+03  7.99999675e+03  4.77676429e+04]
E1 = -182.5715799459701  E_coul = 54.03311458209334
cycle= 4 E= -128.538465363877  delta_E= -1.71e-08  |g|= 7.29e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181913
diis-c [-6.77202857e-10  1.26830728e-04  5.01567320e-04 -1.38431025e-01
  1.13780263e+00]
  HOMO = -0.849492228254641  LUMO = 0.656066800533135
  mo_energy =
[-3.27736098e+01 -1.93053288e+00 -8.49492228e-01 -8.49492228e-01
 -8.49492228e-01  6.56066801e-01  6.56066801e-01  6.56066801e-01
  1.19304836e+00  3.01818233e+00  3.01818233e+00  3.01818233e+00
  7.29812445e+00  1.02629874e+01  1.02629874e+01  1.02629874e+01
  3.39306077e+01  3.39306077e+01  3.39306077e+01  3.46108385e+01
  1.32200253e+02  1.32200253e+02  1.32200253e+02  1.38685766e+02
  5.02738846e+02  1.87034635e+03  7.99999666e+03  4.77676429e+04]
E1 = -182.5717075119006  E_coul = 54.03324214752354
cycle= 5 E= -128.538465364377  delta_E= -5e-10  |g|= 2.83e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5717075119006  E_coul = 54.03324214752354
  HOMO = -0.849491086732806  LUMO = 0.656067007388753
  mo_energy =
[-3.27736071e+01 -1.93053127e+00 -8.49491087e-01 -8.49491087e-01
 -8.49491087e-01  6.56067007e-01  6.56067007e-01  6.56067007e-01
  1.19304906e+00  3.01818316e+00  3.01818316e+00  3.01818316e+00
  7.29812613e+00  1.02629891e+01  1.02629891e+01  1.02629891e+01
  3.39306102e+01  3.39306102e+01  3.39306102e+01  3.46108411e+01
  1.32200255e+02  1.32200255e+02  1.32200255e+02  1.38685768e+02
  5.02738848e+02  1.87034635e+03  7.99999667e+03  4.77676429e+04]
E1 = -182.57169981578005  E_coul = 54.03323445140256
Extra cycle  E= -128.538465364377  delta_E= -4.26e-13  |g|= 1.05e-06  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270983e+02 2.35735842e+02
 7.64259822e+01 1.00348711e+01 2.70449821e+01 3.82925319e-01
 1.12050880e+00 2.87644286e+00 4.98980406e+00 1.44914072e+01
 5.46548082e+01 2.29334449e-01 1.84644896e+00 6.70862004e-01]
E = -128.5384653643775
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447311        1
[INPUT] 0    0    [1    /1   ]  833.27098261         1
[INPUT] 0    0    [1    /1   ]  235.735842023        1
[INPUT] 0    0    [1    /1   ]  76.4259822062        1
[INPUT] 0    0    [1    /1   ]  10.0348710622        1
[INPUT] 0    0    [1    /1   ]  27.0449821395        1
[INPUT] 0    0    [1    /1   ]  0.38292531855        1
[INPUT] 0    0    [1    /1   ]  1.12050879606        1
[INPUT] 0    0    [1    /1   ]  2.87644286274        1
[INPUT] 1    0    [1    /1   ]  4.98980405575        1
[INPUT] 1    0    [1    /1   ]  14.4914071697        1
[INPUT] 1    0    [1    /1   ]  54.6548082308        1
[INPUT] 1    0    [1    /1   ]  0.22933444907        1
[INPUT] 1    0    [1    /1   ]  1.8464489645         1
[INPUT] 1    0    [1    /1   ]  0.670862003787       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412993161, 1.0]], [0, [3661.45447310959, 1.0]], [0, [833.270982610434, 1.0]], [0, [235.735842023389, 1.0]], [0, [76.42598220618977, 1.0]], [0, [10.034871062181853, 1.0]], [0, [27.044982139493857, 1.0]], [0, [0.3829253185499491, 1.0]], [0, [1.120508796055939, 1.0]], [0, [2.876442862743138, 1.0]], [1, [4.9898040557516605, 1.0]], [1, [14.49140716971371, 1.0]], [1, [54.65480823076471, 1.0]], [1, [0.22933444907013545, 1.0]], [1, [1.846448964503249, 1.0]], [1, [0.670862003787211, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447311]
bas 2, expnt(s) = [833.27098261]
bas 3, expnt(s) = [235.73584202]
bas 4, expnt(s) = [76.42598221]
bas 5, expnt(s) = [10.03487106]
bas 6, expnt(s) = [27.04498214]
bas 7, expnt(s) = [0.38292532]
bas 8, expnt(s) = [1.1205088]
bas 9, expnt(s) = [2.87644286]
bas 10, expnt(s) = [4.98980406]
bas 11, expnt(s) = [14.49140717]
bas 12, expnt(s) = [54.65480823]
bas 13, expnt(s) = [0.22933445]
bas 14, expnt(s) = [1.84644896]
bas 15, expnt(s) = [0.670862]
CPU time:        92.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270983e+02 3.91836346e+02 2.35735842e+02 1.51996728e+02
 7.64259822e+01 6.53049041e+01 1.00348711e+01 1.42445545e+01
 2.70449821e+01 2.99626381e+01 3.82925319e-01 1.22984558e+00
 1.12050880e+00 2.75154409e+00 2.87644286e+00 5.58029088e+00
 4.98980406e+00 2.17564863e+01 1.44914072e+01 8.24845466e+01
 5.46548082e+01 4.33530704e+02 2.29334449e-01 4.62989363e-01
 1.84644896e+00 6.27922475e+00 6.70862004e-01 1.77123378e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999810702143295
cond(S) = 344.80127846680006
E1 = -183.58641640197564  E_coul = 55.080096745261535
init E= -128.506319656714
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950242312102  LUMO = 0.669685055671416
  mo_energy =
[-3.25551379e+01 -1.85258127e+00 -7.74950242e-01 -7.74950242e-01
 -7.74950242e-01  6.69685056e-01  6.69685056e-01  6.69685056e-01
  1.22483080e+00  3.07103369e+00  3.07103369e+00  3.07103369e+00
  7.38856070e+00  1.03709075e+01  1.03709075e+01  1.03709075e+01
  3.40988827e+01  3.40988827e+01  3.40988827e+01  3.47777388e+01
  1.32419744e+02  1.32419744e+02  1.32419744e+02  1.38900928e+02
  5.02987216e+02  1.87062550e+03  8.00030242e+03  4.77679665e+04]
E1 = -182.0582524741246  E_coul = 53.523409723126704
cycle= 1 E= -128.534842750998  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546466
diis-c [-0.29862468  1.        ]
  HOMO = -0.885568658452581  LUMO = 0.649451399007376
  mo_energy =
[-3.28831439e+01 -1.96861488e+00 -8.85568658e-01 -8.85568658e-01
 -8.85568658e-01  6.49451399e-01  6.49451399e-01  6.49451399e-01
  1.17811009e+00  2.99305264e+00  2.99305264e+00  2.99305264e+00
  7.25418594e+00  1.02101413e+01  1.02101413e+01  1.02101413e+01
  3.38463733e+01  3.38463733e+01  3.38463733e+01  3.45269297e+01
  1.32091277e+02  1.32091277e+02  1.32091277e+02  1.38578262e+02
  5.02620545e+02  1.87022287e+03  7.99987080e+03  4.77675161e+04]
E1 = -182.83588863711088  E_coul = 54.298382490457236
cycle= 2 E= -128.537506146654  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279218
diis-c [-6.40504996e-04  3.37483081e-01  6.62516919e-01]
  HOMO = -0.849223866327979  LUMO = 0.656097350415659
  mo_energy =
[-3.27731406e+01 -1.93031602e+00 -8.49223866e-01 -8.49223866e-01
 -8.49223866e-01  6.56097350e-01  6.56097350e-01  6.56097350e-01
  1.19313851e+00  3.01833739e+00  3.01833739e+00  3.01833739e+00
  7.29835847e+00  1.02632662e+01  1.02632662e+01  1.02632662e+01
  3.39309912e+01  3.39309912e+01  3.39309912e+01  3.46112097e+01
  1.32200735e+02  1.32200735e+02  1.32200735e+02  1.38686236e+02
  5.02739431e+02  1.87034706e+03  7.99999747e+03  4.77676437e+04]
E1 = -182.57126246050595  E_coul = 54.03279711377892
cycle= 3 E= -128.538465346727  delta_E= -0.000959  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993128
diis-c [-1.04423426e-07 -2.06072921e-03 -6.68174482e-04  1.00272890e+00]
  HOMO = -0.849452603714362  LUMO = 0.656076462050092
  mo_energy =
[-3.27735408e+01 -1.93049801e+00 -8.49452604e-01 -8.49452604e-01
 -8.49452604e-01  6.56076462e-01  6.56076462e-01  6.56076462e-01
  1.19306846e+00  3.01821427e+00  3.01821427e+00  3.01821427e+00
  7.29816818e+00  1.02630380e+01  1.02630380e+01  1.02630380e+01
  3.39306706e+01  3.39306706e+01  3.39306706e+01  3.46109005e+01
  1.32200322e+02  1.32200322e+02  1.32200322e+02  1.38685834e+02
  5.02738920e+02  1.87034643e+03  7.99999675e+03  4.77676429e+04]
E1 = -182.5715799459701  E_coul = 54.03311458209334
cycle= 4 E= -128.538465363877  delta_E= -1.71e-08  |g|= 7.29e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181913
diis-c [-6.77202857e-10  1.26830728e-04  5.01567320e-04 -1.38431025e-01
  1.13780263e+00]
  HOMO = -0.849492228254641  LUMO = 0.656066800533135
  mo_energy =
[-3.27736098e+01 -1.93053288e+00 -8.49492228e-01 -8.49492228e-01
 -8.49492228e-01  6.56066801e-01  6.56066801e-01  6.56066801e-01
  1.19304836e+00  3.01818233e+00  3.01818233e+00  3.01818233e+00
  7.29812445e+00  1.02629874e+01  1.02629874e+01  1.02629874e+01
  3.39306077e+01  3.39306077e+01  3.39306077e+01  3.46108385e+01
  1.32200253e+02  1.32200253e+02  1.32200253e+02  1.38685766e+02
  5.02738846e+02  1.87034635e+03  7.99999666e+03  4.77676429e+04]
E1 = -182.5717075119006  E_coul = 54.03324214752354
cycle= 5 E= -128.538465364377  delta_E= -5e-10  |g|= 2.83e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5717075119006  E_coul = 54.03324214752354
  HOMO = -0.849491086732806  LUMO = 0.656067007388753
  mo_energy =
[-3.27736071e+01 -1.93053127e+00 -8.49491087e-01 -8.49491087e-01
 -8.49491087e-01  6.56067007e-01  6.56067007e-01  6.56067007e-01
  1.19304906e+00  3.01818316e+00  3.01818316e+00  3.01818316e+00
  7.29812613e+00  1.02629891e+01  1.02629891e+01  1.02629891e+01
  3.39306102e+01  3.39306102e+01  3.39306102e+01  3.46108411e+01
  1.32200255e+02  1.32200255e+02  1.32200255e+02  1.38685768e+02
  5.02738848e+02  1.87034635e+03  7.99999667e+03  4.77676429e+04]
E1 = -182.57169981578005  E_coul = 54.03323445140256
Extra cycle  E= -128.538465364377  delta_E= -4.26e-13  |g|= 1.05e-06  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.80127846680006
E1 = -182.57169981578005  E_coul = 54.03323445140256
init E= -128.538465364377
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.849491649521696  LUMO = 0.656066903421735
  mo_energy =
[-3.27736087e+01 -1.93053179e+00 -8.49491650e-01 -8.49491650e-01
 -8.49491650e-01  6.56066903e-01  6.56066903e-01  6.56066903e-01
  1.19304886e+00  3.01818277e+00  3.01818277e+00  3.01818277e+00
  7.29812550e+00  1.02629883e+01  1.02629883e+01  1.02629883e+01
  3.39306089e+01  3.39306089e+01  3.39306089e+01  3.46108398e+01
  1.32200254e+02  1.32200254e+02  1.32200254e+02  1.38685767e+02
  5.02738846e+02  1.87034635e+03  7.99999666e+03  4.77676429e+04]
E1 = -182.57170381212413  E_coul = 54.033238447746456
cycle= 1 E= -128.538465364378  delta_E= -1.71e-13  |g|= 5.53e-07  |ddm|= 3.11e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57170381212413  E_coul = 54.033238447746456
  HOMO = -0.849491370463964  LUMO = 0.656066954814607
  mo_energy =
[-3.27736079e+01 -1.93053148e+00 -8.49491370e-01 -8.49491370e-01
 -8.49491370e-01  6.56066955e-01  6.56066955e-01  6.56066955e-01
  1.19304899e+00  3.01818297e+00  3.01818297e+00  3.01818297e+00
  7.29812585e+00  1.02629887e+01  1.02629887e+01  1.02629887e+01
  3.39306096e+01  3.39306096e+01  3.39306096e+01  3.46108405e+01
  1.32200255e+02  1.32200255e+02  1.32200255e+02  1.38685767e+02
  5.02738847e+02  1.87034635e+03  7.99999666e+03  4.77676429e+04]
E1 = -182.57170176027793  E_coul = 54.03323639590032
Extra cycle  E= -128.538465364378  delta_E= 5.68e-14  |g|= 2.78e-07  |ddm|= 1.88e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270983e+02 2.35735842e+02
 7.64259822e+01 1.00348711e+01 2.70449821e+01 3.82925319e-01
 1.12050880e+00 2.87644286e+00 4.98980406e+00 1.44914072e+01
 5.46548082e+01 2.29334449e-01 1.84644896e+00 6.70862004e-01]
grad_E = [ 2.68508322e-11 -1.43834223e-09  3.80720852e-08 -6.39893442e-07
  4.44367793e-06 -8.48180114e-06  4.47611347e-06  5.92062244e-05
  1.49033240e-04 -4.05651709e-05 -3.51616735e-05 -1.02748827e-05
 -2.07972069e-04 -2.00307251e-04  9.97502592e-05 -3.89657291e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447312        1
[INPUT] 0    0    [1    /1   ]  833.270982432        1
[INPUT] 0    0    [1    /1   ]  235.735844794        1
[INPUT] 0    0    [1    /1   ]  76.4259638985        1
[INPUT] 0    0    [1    /1   ]  10.0348829943        1
[INPUT] 0    0    [1    /1   ]  27.0449657976        1
[INPUT] 0    0    [1    /1   ]  0.382829681437       1
[INPUT] 0    0    [1    /1   ]  1.12025902356        1
[INPUT] 0    0    [1    /1   ]  2.87650257999        1
[INPUT] 1    0    [1    /1   ]  4.99212085431        1
[INPUT] 1    0    [1    /1   ]  14.4946476964        1
[INPUT] 1    0    [1    /1   ]  54.6549484331        1
[INPUT] 1    0    [1    /1   ]  0.229340180334       1
[INPUT] 1    0    [1    /1   ]  1.84653669394        1
[INPUT] 1    0    [1    /1   ]  0.670707259453       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931477, 1.0]], [0, [3661.4544731167857, 1.0]], [0, [833.2709824322028, 1.0]], [0, [235.73584479434365, 1.0]], [0, [76.42596389853959, 1.0]], [0, [10.034882994289045, 1.0]], [0, [27.044965797579298, 1.0]], [0, [0.38282968143739665, 1.0]], [0, [1.1202590235629604, 1.0]], [0, [2.876502579986898, 1.0]], [1, [4.992120854305939, 1.0]], [1, [14.494647696402104, 1.0]], [1, [54.654948433100984, 1.0]], [1, [0.2293401803337372, 1.0]], [1, [1.8465366939392054, 1.0]], [1, [0.6707072594532233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447312]
bas 2, expnt(s) = [833.27098243]
bas 3, expnt(s) = [235.73584479]
bas 4, expnt(s) = [76.4259639]
bas 5, expnt(s) = [10.03488299]
bas 6, expnt(s) = [27.0449658]
bas 7, expnt(s) = [0.38282968]
bas 8, expnt(s) = [1.12025902]
bas 9, expnt(s) = [2.87650258]
bas 10, expnt(s) = [4.99212085]
bas 11, expnt(s) = [14.4946477]
bas 12, expnt(s) = [54.65494843]
bas 13, expnt(s) = [0.22934018]
bas 14, expnt(s) = [1.84653669]
bas 15, expnt(s) = [0.67070726]
CPU time:        95.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735845e+02 1.51996729e+02
 7.64259639e+01 6.53048923e+01 1.00348830e+01 1.42445672e+01
 2.70449658e+01 2.99626245e+01 3.82829681e-01 1.22961521e+00
 1.12025902e+00 2.75108407e+00 2.87650258e+00 5.58037777e+00
 4.99212085e+00 2.17691141e+01 1.44946477e+01 8.25076034e+01
 5.46549484e+01 4.33532094e+02 2.29340180e-01 4.63003826e-01
 1.84653669e+00 6.27959768e+00 6.70707259e-01 1.77072309e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999810877768173
cond(S) = 344.72997593856024
E1 = -183.5864162044971  E_coul = 55.08009623194173
init E= -128.506319972555
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950331869907  LUMO = 0.669664604078787
  mo_energy =
[-3.25551379e+01 -1.85258143e+00 -7.74950332e-01 -7.74950332e-01
 -7.74950332e-01  6.69664604e-01  6.69664604e-01  6.69664604e-01
  1.22443741e+00  3.07073387e+00  3.07073387e+00  3.07073387e+00
  7.38743417e+00  1.03723044e+01  1.03723044e+01  1.03723044e+01
  3.41086305e+01  3.41086305e+01  3.41086305e+01  3.47764860e+01
  1.32437393e+02  1.32437393e+02  1.32437393e+02  1.38899808e+02
  5.02986176e+02  1.87062455e+03  8.00030158e+03  4.77679659e+04]
E1 = -182.05827180292192  E_coul = 53.52342889795943
cycle= 1 E= -128.534842904962  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.54648
diis-c [-0.29864086  1.        ]
  HOMO = -0.885567271911168  LUMO = 0.649434104225925
  mo_energy =
[-3.28831407e+01 -1.96861276e+00 -8.85567272e-01 -8.85567272e-01
 -8.85567272e-01  6.49434104e-01  6.49434104e-01  6.49434104e-01
  1.17773038e+00  2.99275608e+00  2.99275608e+00  2.99275608e+00
  7.25306546e+00  1.02115088e+01  1.02115088e+01  1.02115088e+01
  3.38561003e+01  3.38561003e+01  3.38561003e+01  3.45256776e+01
  1.32108928e+02  1.32108928e+02  1.32108928e+02  1.38577144e+02
  5.02619508e+02  1.87022192e+03  7.99986996e+03  4.77675154e+04]
E1 = -182.83590661527802  E_coul = 54.29840030169791
cycle= 2 E= -128.53750631358  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279223
diis-c [-6.40480895e-04  3.37481500e-01  6.62518500e-01]
  HOMO = -0.849222440513697  LUMO = 0.656079259536297
  mo_energy =
[-3.27731373e+01 -1.93031388e+00 -8.49222441e-01 -8.49222441e-01
 -8.49222441e-01  6.56079260e-01  6.56079260e-01  6.56079260e-01
  1.19275514e+00  3.01804054e+00  3.01804054e+00  3.01804054e+00
  7.29723662e+00  1.02646445e+01  1.02646445e+01  1.02646445e+01
  3.39407262e+01  3.39407262e+01  3.39407262e+01  3.46099580e+01
  1.32218386e+02  1.32218386e+02  1.32218386e+02  1.38685119e+02
  5.02738394e+02  1.87034611e+03  7.99999663e+03  4.77676430e+04]
E1 = -182.571285128011  E_coul = 54.03281963395387
cycle= 3 E= -128.538465494057  delta_E= -0.000959  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992744
diis-c [-1.04373642e-07 -2.05981810e-03 -6.67847404e-04  1.00272767e+00]
  HOMO = -0.849450948490946  LUMO = 0.656058451662886
  mo_energy =
[-3.27735372e+01 -1.93049555e+00 -8.49450948e-01 -8.49450948e-01
 -8.49450948e-01  6.56058452e-01  6.56058452e-01  6.56058452e-01
  1.19268532e+00  3.01791764e+00  3.01791764e+00  3.01791764e+00
  7.29704665e+00  1.02644166e+01  1.02644166e+01  1.02644166e+01
  3.39404060e+01  3.39404060e+01  3.39404060e+01  3.46096491e+01
  1.32217974e+02  1.32217974e+02  1.32217974e+02  1.38684717e+02
  5.02737883e+02  1.87034549e+03  7.99999591e+03  4.77676422e+04]
E1 = -182.57160251248538  E_coul = 54.03313700130884
cycle= 4 E= -128.538465511177  delta_E= -1.71e-08  |g|= 7.28e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018194
diis-c [-6.78741639e-10  1.27020424e-04  5.01920450e-04 -1.38535741e-01
  1.13790680e+00]
  HOMO = -0.849490549668555  LUMO = 0.656048801009008
  mo_energy =
[-3.27736062e+01 -1.93053038e+00 -8.49490550e-01 -8.49490550e-01
 -8.49490550e-01  6.56048801e-01  6.56048801e-01  6.56048801e-01
  1.19266527e+00  3.01788573e+00  3.01788573e+00  3.01788573e+00
  7.29700296e+00  1.02643660e+01  1.02643660e+01  1.02643660e+01
  3.39403431e+01  3.39403431e+01  3.39403431e+01  3.46095872e+01
  1.32217905e+02  1.32217905e+02  1.32217905e+02  1.38684648e+02
  5.02737809e+02  1.87034541e+03  7.99999583e+03  4.77676422e+04]
E1 = -182.57173012898141  E_coul = 54.033264617305164
cycle= 5 E= -128.538465511676  delta_E= -5e-10  |g|= 2.84e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57173012898141  E_coul = 54.033264617305164
  HOMO = -0.849489405188287  LUMO = 0.656049008801806
  mo_energy =
[-3.27736035e+01 -1.93052876e+00 -8.49489405e-01 -8.49489405e-01
 -8.49489405e-01  6.56049009e-01  6.56049009e-01  6.56049009e-01
  1.19266597e+00  3.01788656e+00  3.01788656e+00  3.01788656e+00
  7.29700465e+00  1.02643677e+01  1.02643677e+01  1.02643677e+01
  3.39403456e+01  3.39403456e+01  3.39403456e+01  3.46095897e+01
  1.32217907e+02  1.32217907e+02  1.32217907e+02  1.38684651e+02
  5.02737811e+02  1.87034541e+03  7.99999583e+03  4.77676422e+04]
E1 = -182.57172242923517  E_coul = 54.033256917558006
Extra cycle  E= -128.538465511677  delta_E= -9.09e-13  |g|= 1.05e-06  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735845e+02
 7.64259639e+01 1.00348830e+01 2.70449658e+01 3.82829681e-01
 1.12025902e+00 2.87650258e+00 4.99212085e+00 1.44946477e+01
 5.46549484e+01 2.29340180e-01 1.84653669e+00 6.70707259e-01]
E = -128.53846551167715
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447312        1
[INPUT] 0    0    [1    /1   ]  833.270982432        1
[INPUT] 0    0    [1    /1   ]  235.735844794        1
[INPUT] 0    0    [1    /1   ]  76.4259638985        1
[INPUT] 0    0    [1    /1   ]  10.0348829943        1
[INPUT] 0    0    [1    /1   ]  27.0449657976        1
[INPUT] 0    0    [1    /1   ]  0.382829681437       1
[INPUT] 0    0    [1    /1   ]  1.12025902356        1
[INPUT] 0    0    [1    /1   ]  2.87650257999        1
[INPUT] 1    0    [1    /1   ]  4.99212085431        1
[INPUT] 1    0    [1    /1   ]  14.4946476964        1
[INPUT] 1    0    [1    /1   ]  54.6549484331        1
[INPUT] 1    0    [1    /1   ]  0.229340180334       1
[INPUT] 1    0    [1    /1   ]  1.84653669394        1
[INPUT] 1    0    [1    /1   ]  0.670707259453       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931477, 1.0]], [0, [3661.4544731167857, 1.0]], [0, [833.2709824322028, 1.0]], [0, [235.73584479434365, 1.0]], [0, [76.42596389853959, 1.0]], [0, [10.034882994289045, 1.0]], [0, [27.044965797579298, 1.0]], [0, [0.38282968143739665, 1.0]], [0, [1.1202590235629604, 1.0]], [0, [2.876502579986898, 1.0]], [1, [4.992120854305939, 1.0]], [1, [14.494647696402104, 1.0]], [1, [54.654948433100984, 1.0]], [1, [0.2293401803337372, 1.0]], [1, [1.8465366939392054, 1.0]], [1, [0.6707072594532233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447312]
bas 2, expnt(s) = [833.27098243]
bas 3, expnt(s) = [235.73584479]
bas 4, expnt(s) = [76.4259639]
bas 5, expnt(s) = [10.03488299]
bas 6, expnt(s) = [27.0449658]
bas 7, expnt(s) = [0.38282968]
bas 8, expnt(s) = [1.12025902]
bas 9, expnt(s) = [2.87650258]
bas 10, expnt(s) = [4.99212085]
bas 11, expnt(s) = [14.4946477]
bas 12, expnt(s) = [54.65494843]
bas 13, expnt(s) = [0.22934018]
bas 14, expnt(s) = [1.84653669]
bas 15, expnt(s) = [0.67070726]
CPU time:        95.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735845e+02 1.51996729e+02
 7.64259639e+01 6.53048923e+01 1.00348830e+01 1.42445672e+01
 2.70449658e+01 2.99626245e+01 3.82829681e-01 1.22961521e+00
 1.12025902e+00 2.75108407e+00 2.87650258e+00 5.58037777e+00
 4.99212085e+00 2.17691141e+01 1.44946477e+01 8.25076034e+01
 5.46549484e+01 4.33532094e+02 2.29340180e-01 4.63003826e-01
 1.84653669e+00 6.27959768e+00 6.70707259e-01 1.77072309e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999810877768173
cond(S) = 344.72997593856024
E1 = -183.5864162044971  E_coul = 55.08009623194173
init E= -128.506319972555
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950331869907  LUMO = 0.669664604078787
  mo_energy =
[-3.25551379e+01 -1.85258143e+00 -7.74950332e-01 -7.74950332e-01
 -7.74950332e-01  6.69664604e-01  6.69664604e-01  6.69664604e-01
  1.22443741e+00  3.07073387e+00  3.07073387e+00  3.07073387e+00
  7.38743417e+00  1.03723044e+01  1.03723044e+01  1.03723044e+01
  3.41086305e+01  3.41086305e+01  3.41086305e+01  3.47764860e+01
  1.32437393e+02  1.32437393e+02  1.32437393e+02  1.38899808e+02
  5.02986176e+02  1.87062455e+03  8.00030158e+03  4.77679659e+04]
E1 = -182.05827180292192  E_coul = 53.52342889795943
cycle= 1 E= -128.534842904962  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.54648
diis-c [-0.29864086  1.        ]
  HOMO = -0.885567271911168  LUMO = 0.649434104225925
  mo_energy =
[-3.28831407e+01 -1.96861276e+00 -8.85567272e-01 -8.85567272e-01
 -8.85567272e-01  6.49434104e-01  6.49434104e-01  6.49434104e-01
  1.17773038e+00  2.99275608e+00  2.99275608e+00  2.99275608e+00
  7.25306546e+00  1.02115088e+01  1.02115088e+01  1.02115088e+01
  3.38561003e+01  3.38561003e+01  3.38561003e+01  3.45256776e+01
  1.32108928e+02  1.32108928e+02  1.32108928e+02  1.38577144e+02
  5.02619508e+02  1.87022192e+03  7.99986996e+03  4.77675154e+04]
E1 = -182.83590661527802  E_coul = 54.29840030169791
cycle= 2 E= -128.53750631358  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279223
diis-c [-6.40480895e-04  3.37481500e-01  6.62518500e-01]
  HOMO = -0.849222440513697  LUMO = 0.656079259536297
  mo_energy =
[-3.27731373e+01 -1.93031388e+00 -8.49222441e-01 -8.49222441e-01
 -8.49222441e-01  6.56079260e-01  6.56079260e-01  6.56079260e-01
  1.19275514e+00  3.01804054e+00  3.01804054e+00  3.01804054e+00
  7.29723662e+00  1.02646445e+01  1.02646445e+01  1.02646445e+01
  3.39407262e+01  3.39407262e+01  3.39407262e+01  3.46099580e+01
  1.32218386e+02  1.32218386e+02  1.32218386e+02  1.38685119e+02
  5.02738394e+02  1.87034611e+03  7.99999663e+03  4.77676430e+04]
E1 = -182.571285128011  E_coul = 54.03281963395387
cycle= 3 E= -128.538465494057  delta_E= -0.000959  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992744
diis-c [-1.04373642e-07 -2.05981810e-03 -6.67847404e-04  1.00272767e+00]
  HOMO = -0.849450948490946  LUMO = 0.656058451662886
  mo_energy =
[-3.27735372e+01 -1.93049555e+00 -8.49450948e-01 -8.49450948e-01
 -8.49450948e-01  6.56058452e-01  6.56058452e-01  6.56058452e-01
  1.19268532e+00  3.01791764e+00  3.01791764e+00  3.01791764e+00
  7.29704665e+00  1.02644166e+01  1.02644166e+01  1.02644166e+01
  3.39404060e+01  3.39404060e+01  3.39404060e+01  3.46096491e+01
  1.32217974e+02  1.32217974e+02  1.32217974e+02  1.38684717e+02
  5.02737883e+02  1.87034549e+03  7.99999591e+03  4.77676422e+04]
E1 = -182.57160251248538  E_coul = 54.03313700130884
cycle= 4 E= -128.538465511177  delta_E= -1.71e-08  |g|= 7.28e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018194
diis-c [-6.78741639e-10  1.27020424e-04  5.01920450e-04 -1.38535741e-01
  1.13790680e+00]
  HOMO = -0.849490549668555  LUMO = 0.656048801009008
  mo_energy =
[-3.27736062e+01 -1.93053038e+00 -8.49490550e-01 -8.49490550e-01
 -8.49490550e-01  6.56048801e-01  6.56048801e-01  6.56048801e-01
  1.19266527e+00  3.01788573e+00  3.01788573e+00  3.01788573e+00
  7.29700296e+00  1.02643660e+01  1.02643660e+01  1.02643660e+01
  3.39403431e+01  3.39403431e+01  3.39403431e+01  3.46095872e+01
  1.32217905e+02  1.32217905e+02  1.32217905e+02  1.38684648e+02
  5.02737809e+02  1.87034541e+03  7.99999583e+03  4.77676422e+04]
E1 = -182.57173012898141  E_coul = 54.033264617305164
cycle= 5 E= -128.538465511676  delta_E= -5e-10  |g|= 2.84e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57173012898141  E_coul = 54.033264617305164
  HOMO = -0.849489405188287  LUMO = 0.656049008801806
  mo_energy =
[-3.27736035e+01 -1.93052876e+00 -8.49489405e-01 -8.49489405e-01
 -8.49489405e-01  6.56049009e-01  6.56049009e-01  6.56049009e-01
  1.19266597e+00  3.01788656e+00  3.01788656e+00  3.01788656e+00
  7.29700465e+00  1.02643677e+01  1.02643677e+01  1.02643677e+01
  3.39403456e+01  3.39403456e+01  3.39403456e+01  3.46095897e+01
  1.32217907e+02  1.32217907e+02  1.32217907e+02  1.38684651e+02
  5.02737811e+02  1.87034541e+03  7.99999583e+03  4.77676422e+04]
E1 = -182.57172242923517  E_coul = 54.033256917558006
Extra cycle  E= -128.538465511677  delta_E= -9.09e-13  |g|= 1.05e-06  |ddm|= 1.17e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.72997593856024
E1 = -182.57172242923517  E_coul = 54.033256917558006
init E= -128.538465511677
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849489968235921  LUMO = 0.656048904870649
  mo_energy =
[-3.27736051e+01 -1.93052927e+00 -8.49489968e-01 -8.49489968e-01
 -8.49489968e-01  6.56048905e-01  6.56048905e-01  6.56048905e-01
  1.19266577e+00  3.01788617e+00  3.01788617e+00  3.01788617e+00
  7.29700401e+00  1.02643669e+01  1.02643669e+01  1.02643669e+01
  3.39403443e+01  3.39403443e+01  3.39403443e+01  3.46095884e+01
  1.32217906e+02  1.32217906e+02  1.32217906e+02  1.38684649e+02
  5.02737809e+02  1.87034541e+03  7.99999583e+03  4.77676422e+04]
E1 = -182.5717264299463  E_coul = 54.033260918269185
cycle= 1 E= -128.538465511677  delta_E= 2.84e-14  |g|= 5.54e-07  |ddm|= 3.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5717264299463  E_coul = 54.033260918269185
  HOMO = -0.849489688876433  LUMO = 0.656048956324834
  mo_energy =
[-3.27736043e+01 -1.93052896e+00 -8.49489689e-01 -8.49489689e-01
 -8.49489689e-01  6.56048956e-01  6.56048956e-01  6.56048956e-01
  1.19266589e+00  3.01788637e+00  3.01788637e+00  3.01788637e+00
  7.29700436e+00  1.02643673e+01  1.02643673e+01  1.02643673e+01
  3.39403450e+01  3.39403450e+01  3.39403450e+01  3.46095891e+01
  1.32217906e+02  1.32217906e+02  1.32217906e+02  1.38684650e+02
  5.02737810e+02  1.87034541e+03  7.99999583e+03  4.77676422e+04]
E1 = -182.57172437631795  E_coul = 54.03325886464077
Extra cycle  E= -128.538465511677  delta_E= -5.68e-14  |g|= 2.78e-07  |ddm|= 1.88e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735845e+02
 7.64259639e+01 1.00348830e+01 2.70449658e+01 3.82829681e-01
 1.12025902e+00 2.87650258e+00 4.99212085e+00 1.44946477e+01
 5.46549484e+01 2.29340180e-01 1.84653669e+00 6.70707259e-01]
grad_E = [ 2.73250464e-11 -1.46339002e-09  3.85808471e-08 -6.46275538e-07
  4.49820455e-06 -7.40583907e-06  4.15467432e-06  5.40368076e-05
  1.40818681e-04 -3.85715141e-05 -4.94001952e-06 -1.57702282e-05
 -2.07774205e-04 -8.30591125e-05  5.68467469e-05 -7.30758224e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447313        1
[INPUT] 0    0    [1    /1   ]  833.270982012        1
[INPUT] 0    0    [1    /1   ]  235.735851485        1
[INPUT] 0    0    [1    /1   ]  76.4259189334        1
[INPUT] 0    0    [1    /1   ]  10.0349288566        1
[INPUT] 0    0    [1    /1   ]  27.044924808         1
[INPUT] 0    0    [1    /1   ]  0.382489294172       1
[INPUT] 0    0    [1    /1   ]  1.11936576462        1
[INPUT] 0    0    [1    /1   ]  2.87673311722        1
[INPUT] 1    0    [1    /1   ]  4.99553084077        1
[INPUT] 1    0    [1    /1   ]  14.5001838905        1
[INPUT] 1    0    [1    /1   ]  54.6558685206        1
[INPUT] 1    0    [1    /1   ]  0.229430625529       1
[INPUT] 1    0    [1    /1   ]  1.84610113421        1
[INPUT] 1    0    [1    /1   ]  0.670501403631       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931164, 1.0]], [0, [3661.454473133424, 1.0]], [0, [833.270982012077, 1.0]], [0, [235.73585148476624, 1.0]], [0, [76.42591893336275, 1.0]], [0, [10.034928856572952, 1.0]], [0, [27.044924807950405, 1.0]], [0, [0.3824892941723902, 1.0]], [0, [1.1193657646210249, 1.0]], [0, [2.876733117221619, 1.0]], [1, [4.99553084076851, 1.0]], [1, [14.500183890494245, 1.0]], [1, [54.65586852060689, 1.0]], [1, [0.22943062552856827, 1.0]], [1, [1.846101134206051, 1.0]], [1, [0.6705014036312112, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447313]
bas 2, expnt(s) = [833.27098201]
bas 3, expnt(s) = [235.73585148]
bas 4, expnt(s) = [76.42591893]
bas 5, expnt(s) = [10.03492886]
bas 6, expnt(s) = [27.04492481]
bas 7, expnt(s) = [0.38248929]
bas 8, expnt(s) = [1.11936576]
bas 9, expnt(s) = [2.87673312]
bas 10, expnt(s) = [4.99553084]
bas 11, expnt(s) = [14.50018389]
bas 12, expnt(s) = [54.65586852]
bas 13, expnt(s) = [0.22943063]
bas 14, expnt(s) = [1.84610113]
bas 15, expnt(s) = [0.6705014]
CPU time:        98.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735851e+02 1.51996732e+02
 7.64259189e+01 6.53048635e+01 1.00349289e+01 1.42446160e+01
 2.70449248e+01 2.99625904e+01 3.82489294e-01 1.22879515e+00
 1.11936576e+00 2.74943869e+00 2.87673312e+00 5.58071320e+00
 4.99553084e+00 2.17877031e+01 1.45001839e+01 8.25469973e+01
 5.46558685e+01 4.33541217e+02 2.29430626e-01 4.63232081e-01
 1.84610113e+00 6.27774620e+00 6.70501404e-01 1.77004377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999811205187061
cond(S) = 344.4764280072708
E1 = -183.58641615002082  E_coul = 55.08009553780098
init E= -128.50632061222
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950457108786  LUMO = 0.669847778989519
  mo_energy =
[-3.25551378e+01 -1.85258190e+00 -7.74950457e-01 -7.74950457e-01
 -7.74950457e-01  6.69847779e-01  6.69847779e-01  6.69847779e-01
  1.22303718e+00  3.07037058e+00  3.07037058e+00  3.07037058e+00
  7.38343417e+00  1.03733213e+01  1.03733213e+01  1.03733213e+01
  3.41221538e+01  3.41221538e+01  3.41221538e+01  3.47720873e+01
  1.32465393e+02  1.32465393e+02  1.32465393e+02  1.38895939e+02
  5.02982649e+02  1.87062136e+03  8.00029876e+03  4.77679635e+04]
E1 = -182.05831954163804  E_coul = 53.5234762674626
cycle= 1 E= -128.534843274175  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546529
diis-c [-0.29869441  1.        ]
  HOMO = -0.885563940845834  LUMO = 0.649615723316311
  mo_energy =
[-3.28831326e+01 -1.96860722e+00 -8.85563941e-01 -8.85563941e-01
 -8.85563941e-01  6.49615723e-01  6.49615723e-01  6.49615723e-01
  1.17637569e+00  2.99240988e+00  2.99240988e+00  2.99240988e+00
  7.24908498e+00  1.02124940e+01  1.02124940e+01  1.02124940e+01
  3.38695920e+01  3.38695920e+01  3.38695920e+01  3.45212786e+01
  1.32136935e+02  1.32136935e+02  1.32136935e+02  1.38573282e+02
  5.02615988e+02  1.87021873e+03  7.99986715e+03  4.77675131e+04]
E1 = -182.83594151013517  E_coul = 54.29843481465769
cycle= 2 E= -128.537506695477  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279241
diis-c [-6.40407921e-04  3.37476201e-01  6.62523799e-01]
  HOMO = -0.849219427111211  LUMO = 0.656261535140371
  mo_energy =
[-3.27731301e+01 -1.93030883e+00 -8.49219427e-01 -8.49219427e-01
 -8.49219427e-01  6.56261535e-01  6.56261535e-01  6.56261535e-01
  1.19138697e+00  3.01768996e+00  3.01768996e+00  3.01768996e+00
  7.29325086e+00  1.02656415e+01  1.02656415e+01  1.02656415e+01
  3.39542303e+01  3.39542303e+01  3.39542303e+01  3.46055597e+01
  1.32246393e+02  1.32246393e+02  1.32246393e+02  1.38681256e+02
  5.02734873e+02  1.87034292e+03  7.99999382e+03  4.77676407e+04]
E1 = -182.57133213690966  E_coul = 54.032866323580095
cycle= 3 E= -128.53846581333  delta_E= -0.000959  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992724
diis-c [-1.04516062e-07 -2.05876489e-03 -6.66441666e-04  1.00272521e+00]
  HOMO = -0.849447636905194  LUMO = 0.656240802311659
  mo_energy =
[-3.27735296e+01 -1.93049000e+00 -8.49447637e-01 -8.49447637e-01
 -8.49447637e-01  6.56240802e-01  6.56240802e-01  6.56240802e-01
  1.19131751e+00  3.01756737e+00  3.01756737e+00  3.01756737e+00
  7.29306138e+00  1.02654140e+01  1.02654140e+01  1.02654140e+01
  3.39539105e+01  3.39539105e+01  3.39539105e+01  3.46052512e+01
  1.32245981e+02  1.32245981e+02  1.32245981e+02  1.38680854e+02
  5.02734363e+02  1.87034229e+03  7.99999310e+03  4.77676399e+04]
E1 = -182.57164934695587  E_coul = 54.03318351652074
cycle= 4 E= -128.538465830435  delta_E= -1.71e-08  |g|= 7.29e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182164
diis-c [-6.82202185e-10  1.27558279e-04  5.02973914e-04 -1.38846184e-01
  1.13821565e+00]
  HOMO = -0.849487236180257  LUMO = 0.656231155844203
  mo_energy =
[-3.27735986e+01 -1.93052477e+00 -8.49487236e-01 -8.49487236e-01
 -8.49487236e-01  6.56231156e-01  6.56231156e-01  6.56231156e-01
  1.19129751e+00  3.01753547e+00  3.01753547e+00  3.01753547e+00
  7.29301773e+00  1.02653634e+01  1.02653634e+01  1.02653634e+01
  3.39538476e+01  3.39538476e+01  3.39538476e+01  3.46051893e+01
  1.32245912e+02  1.32245912e+02  1.32245912e+02  1.38680786e+02
  5.02734288e+02  1.87034221e+03  7.99999302e+03  4.77676398e+04]
E1 = -182.5717771372203  E_coul = 54.03331130628418
cycle= 5 E= -128.538465830936  delta_E= -5.01e-10  |g|= 2.85e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5717771372203  E_coul = 54.03331130628418
  HOMO = -0.849486083638732  LUMO = 0.656231366092667
  mo_energy =
[-3.27735959e+01 -1.93052314e+00 -8.49486084e-01 -8.49486084e-01
 -8.49486084e-01  6.56231366e-01  6.56231366e-01  6.56231366e-01
  1.19129821e+00  3.01753631e+00  3.01753631e+00  3.01753631e+00
  7.29301942e+00  1.02653651e+01  1.02653651e+01  1.02653651e+01
  3.39538501e+01  3.39538501e+01  3.39538501e+01  3.46051919e+01
  1.32245914e+02  1.32245914e+02  1.32245914e+02  1.38680788e+02
  5.02734291e+02  1.87034222e+03  7.99999302e+03  4.77676398e+04]
E1 = -182.5717694191741  E_coul = 54.033303588237004
Extra cycle  E= -128.538465830937  delta_E= -9.95e-13  |g|= 1.06e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735851e+02
 7.64259189e+01 1.00349289e+01 2.70449248e+01 3.82489294e-01
 1.11936576e+00 2.87673312e+00 4.99553084e+00 1.45001839e+01
 5.46558685e+01 2.29430626e-01 1.84610113e+00 6.70501404e-01]
E = -128.5384658309371
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447313        1
[INPUT] 0    0    [1    /1   ]  833.270982012        1
[INPUT] 0    0    [1    /1   ]  235.735851485        1
[INPUT] 0    0    [1    /1   ]  76.4259189334        1
[INPUT] 0    0    [1    /1   ]  10.0349288566        1
[INPUT] 0    0    [1    /1   ]  27.044924808         1
[INPUT] 0    0    [1    /1   ]  0.382489294172       1
[INPUT] 0    0    [1    /1   ]  1.11936576462        1
[INPUT] 0    0    [1    /1   ]  2.87673311722        1
[INPUT] 1    0    [1    /1   ]  4.99553084077        1
[INPUT] 1    0    [1    /1   ]  14.5001838905        1
[INPUT] 1    0    [1    /1   ]  54.6558685206        1
[INPUT] 1    0    [1    /1   ]  0.229430625529       1
[INPUT] 1    0    [1    /1   ]  1.84610113421        1
[INPUT] 1    0    [1    /1   ]  0.670501403631       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129931164, 1.0]], [0, [3661.454473133424, 1.0]], [0, [833.270982012077, 1.0]], [0, [235.73585148476624, 1.0]], [0, [76.42591893336275, 1.0]], [0, [10.034928856572952, 1.0]], [0, [27.044924807950405, 1.0]], [0, [0.3824892941723902, 1.0]], [0, [1.1193657646210249, 1.0]], [0, [2.876733117221619, 1.0]], [1, [4.99553084076851, 1.0]], [1, [14.500183890494245, 1.0]], [1, [54.65586852060689, 1.0]], [1, [0.22943062552856827, 1.0]], [1, [1.846101134206051, 1.0]], [1, [0.6705014036312112, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447313]
bas 2, expnt(s) = [833.27098201]
bas 3, expnt(s) = [235.73585148]
bas 4, expnt(s) = [76.42591893]
bas 5, expnt(s) = [10.03492886]
bas 6, expnt(s) = [27.04492481]
bas 7, expnt(s) = [0.38248929]
bas 8, expnt(s) = [1.11936576]
bas 9, expnt(s) = [2.87673312]
bas 10, expnt(s) = [4.99553084]
bas 11, expnt(s) = [14.50018389]
bas 12, expnt(s) = [54.65586852]
bas 13, expnt(s) = [0.22943063]
bas 14, expnt(s) = [1.84610113]
bas 15, expnt(s) = [0.6705014]
CPU time:        99.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735851e+02 1.51996732e+02
 7.64259189e+01 6.53048635e+01 1.00349289e+01 1.42446160e+01
 2.70449248e+01 2.99625904e+01 3.82489294e-01 1.22879515e+00
 1.11936576e+00 2.74943869e+00 2.87673312e+00 5.58071320e+00
 4.99553084e+00 2.17877031e+01 1.45001839e+01 8.25469973e+01
 5.46558685e+01 4.33541217e+02 2.29430626e-01 4.63232081e-01
 1.84610113e+00 6.27774620e+00 6.70501404e-01 1.77004377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999811205187061
cond(S) = 344.4764280072708
E1 = -183.58641615002082  E_coul = 55.08009553780098
init E= -128.50632061222
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950457108786  LUMO = 0.669847778989519
  mo_energy =
[-3.25551378e+01 -1.85258190e+00 -7.74950457e-01 -7.74950457e-01
 -7.74950457e-01  6.69847779e-01  6.69847779e-01  6.69847779e-01
  1.22303718e+00  3.07037058e+00  3.07037058e+00  3.07037058e+00
  7.38343417e+00  1.03733213e+01  1.03733213e+01  1.03733213e+01
  3.41221538e+01  3.41221538e+01  3.41221538e+01  3.47720873e+01
  1.32465393e+02  1.32465393e+02  1.32465393e+02  1.38895939e+02
  5.02982649e+02  1.87062136e+03  8.00029876e+03  4.77679635e+04]
E1 = -182.05831954163804  E_coul = 53.5234762674626
cycle= 1 E= -128.534843274175  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546529
diis-c [-0.29869441  1.        ]
  HOMO = -0.885563940845834  LUMO = 0.649615723316311
  mo_energy =
[-3.28831326e+01 -1.96860722e+00 -8.85563941e-01 -8.85563941e-01
 -8.85563941e-01  6.49615723e-01  6.49615723e-01  6.49615723e-01
  1.17637569e+00  2.99240988e+00  2.99240988e+00  2.99240988e+00
  7.24908498e+00  1.02124940e+01  1.02124940e+01  1.02124940e+01
  3.38695920e+01  3.38695920e+01  3.38695920e+01  3.45212786e+01
  1.32136935e+02  1.32136935e+02  1.32136935e+02  1.38573282e+02
  5.02615988e+02  1.87021873e+03  7.99986715e+03  4.77675131e+04]
E1 = -182.83594151013517  E_coul = 54.29843481465769
cycle= 2 E= -128.537506695477  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279241
diis-c [-6.40407921e-04  3.37476201e-01  6.62523799e-01]
  HOMO = -0.849219427111211  LUMO = 0.656261535140371
  mo_energy =
[-3.27731301e+01 -1.93030883e+00 -8.49219427e-01 -8.49219427e-01
 -8.49219427e-01  6.56261535e-01  6.56261535e-01  6.56261535e-01
  1.19138697e+00  3.01768996e+00  3.01768996e+00  3.01768996e+00
  7.29325086e+00  1.02656415e+01  1.02656415e+01  1.02656415e+01
  3.39542303e+01  3.39542303e+01  3.39542303e+01  3.46055597e+01
  1.32246393e+02  1.32246393e+02  1.32246393e+02  1.38681256e+02
  5.02734873e+02  1.87034292e+03  7.99999382e+03  4.77676407e+04]
E1 = -182.57133213690966  E_coul = 54.032866323580095
cycle= 3 E= -128.53846581333  delta_E= -0.000959  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992724
diis-c [-1.04516062e-07 -2.05876489e-03 -6.66441666e-04  1.00272521e+00]
  HOMO = -0.849447636905194  LUMO = 0.656240802311659
  mo_energy =
[-3.27735296e+01 -1.93049000e+00 -8.49447637e-01 -8.49447637e-01
 -8.49447637e-01  6.56240802e-01  6.56240802e-01  6.56240802e-01
  1.19131751e+00  3.01756737e+00  3.01756737e+00  3.01756737e+00
  7.29306138e+00  1.02654140e+01  1.02654140e+01  1.02654140e+01
  3.39539105e+01  3.39539105e+01  3.39539105e+01  3.46052512e+01
  1.32245981e+02  1.32245981e+02  1.32245981e+02  1.38680854e+02
  5.02734363e+02  1.87034229e+03  7.99999310e+03  4.77676399e+04]
E1 = -182.57164934695587  E_coul = 54.03318351652074
cycle= 4 E= -128.538465830435  delta_E= -1.71e-08  |g|= 7.29e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182164
diis-c [-6.82202185e-10  1.27558279e-04  5.02973914e-04 -1.38846184e-01
  1.13821565e+00]
  HOMO = -0.849487236180257  LUMO = 0.656231155844203
  mo_energy =
[-3.27735986e+01 -1.93052477e+00 -8.49487236e-01 -8.49487236e-01
 -8.49487236e-01  6.56231156e-01  6.56231156e-01  6.56231156e-01
  1.19129751e+00  3.01753547e+00  3.01753547e+00  3.01753547e+00
  7.29301773e+00  1.02653634e+01  1.02653634e+01  1.02653634e+01
  3.39538476e+01  3.39538476e+01  3.39538476e+01  3.46051893e+01
  1.32245912e+02  1.32245912e+02  1.32245912e+02  1.38680786e+02
  5.02734288e+02  1.87034221e+03  7.99999302e+03  4.77676398e+04]
E1 = -182.5717771372203  E_coul = 54.03331130628418
cycle= 5 E= -128.538465830936  delta_E= -5.01e-10  |g|= 2.85e-06  |ddm|= 3.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5717771372203  E_coul = 54.03331130628418
  HOMO = -0.849486083638732  LUMO = 0.656231366092667
  mo_energy =
[-3.27735959e+01 -1.93052314e+00 -8.49486084e-01 -8.49486084e-01
 -8.49486084e-01  6.56231366e-01  6.56231366e-01  6.56231366e-01
  1.19129821e+00  3.01753631e+00  3.01753631e+00  3.01753631e+00
  7.29301942e+00  1.02653651e+01  1.02653651e+01  1.02653651e+01
  3.39538501e+01  3.39538501e+01  3.39538501e+01  3.46051919e+01
  1.32245914e+02  1.32245914e+02  1.32245914e+02  1.38680788e+02
  5.02734291e+02  1.87034222e+03  7.99999302e+03  4.77676398e+04]
E1 = -182.5717694191741  E_coul = 54.033303588237004
Extra cycle  E= -128.538465830937  delta_E= -9.95e-13  |g|= 1.06e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.4764280072708
E1 = -182.5717694191741  E_coul = 54.033303588237004
init E= -128.538465830937
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849486647942395  LUMO = 0.656231262071013
  mo_energy =
[-3.27735975e+01 -1.93052365e+00 -8.49486648e-01 -8.49486648e-01
 -8.49486648e-01  6.56231262e-01  6.56231262e-01  6.56231262e-01
  1.19129802e+00  3.01753592e+00  3.01753592e+00  3.01753592e+00
  7.29301879e+00  1.02653643e+01  1.02653643e+01  1.02653643e+01
  3.39538488e+01  3.39538488e+01  3.39538488e+01  3.46051906e+01
  1.32245913e+02  1.32245913e+02  1.32245913e+02  1.38680787e+02
  5.02734289e+02  1.87034221e+03  7.99999302e+03  4.77676398e+04]
E1 = -182.57177343464608  E_coul = 54.03330760370953
cycle= 1 E= -128.538465830937  delta_E= 5.4e-13  |g|= 5.56e-07  |ddm|= 3.14e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57177343464608  E_coul = 54.03330760370953
  HOMO = -0.849486367545955  LUMO = 0.656231313746295
  mo_energy =
[-3.27735967e+01 -1.93052334e+00 -8.49486368e-01 -8.49486368e-01
 -8.49486368e-01  6.56231314e-01  6.56231314e-01  6.56231314e-01
  1.19129814e+00  3.01753612e+00  3.01753612e+00  3.01753612e+00
  7.29301914e+00  1.02653647e+01  1.02653647e+01  1.02653647e+01
  3.39538495e+01  3.39538495e+01  3.39538495e+01  3.46051913e+01
  1.32245913e+02  1.32245913e+02  1.32245913e+02  1.38680787e+02
  5.02734290e+02  1.87034222e+03  7.99999302e+03  4.77676398e+04]
E1 = -182.5717713743828  E_coul = 54.03330554344596
Extra cycle  E= -128.538465830937  delta_E= -2.84e-13  |g|= 2.79e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735851e+02
 7.64259189e+01 1.00349289e+01 2.70449248e+01 3.82489294e-01
 1.11936576e+00 2.87673312e+00 4.99553084e+00 1.45001839e+01
 5.46558685e+01 2.29430626e-01 1.84610113e+00 6.70501404e-01]
grad_E = [ 2.89967256e-11 -1.55164896e-09  4.03692687e-08 -6.68596564e-07
  4.68812421e-06 -3.58124630e-06  3.02622637e-06  3.80616206e-05
  1.11154840e-04 -3.13675391e-05  7.16757054e-05 -2.81813586e-05
 -2.07259919e-04  6.17506774e-05 -1.10735246e-04  1.71708173e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447315        1
[INPUT] 0    0    [1    /1   ]  833.270981665        1
[INPUT] 0    0    [1    /1   ]  235.735857128        1
[INPUT] 0    0    [1    /1   ]  76.4258803586        1
[INPUT] 0    0    [1    /1   ]  10.0349770134        1
[INPUT] 0    0    [1    /1   ]  27.0448902371        1
[INPUT] 0    0    [1    /1   ]  0.382128836926       1
[INPUT] 0    0    [1    /1   ]  1.11841410236        1
[INPUT] 0    0    [1    /1   ]  2.87698807074        1
[INPUT] 1    0    [1    /1   ]  4.99690084218        1
[INPUT] 1    0    [1    /1   ]  14.5028143537        1
[INPUT] 1    0    [1    /1   ]  54.6571173294        1
[INPUT] 1    0    [1    /1   ]  0.229544128691       1
[INPUT] 1    0    [1    /1   ]  1.84586957015        1
[INPUT] 1    0    [1    /1   ]  0.670587369729       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129930913, 1.0]], [0, [3661.4544731469036, 1.0]], [0, [833.2709816654578, 1.0]], [0, [235.73585712845681, 1.0]], [0, [76.42588035855172, 1.0]], [0, [10.034977013425957, 1.0]], [0, [27.044890237098066, 1.0]], [0, [0.38212883692631694, 1.0]], [0, [1.1184141023614333, 1.0]], [0, [2.8769880707400053, 1.0]], [1, [4.996900842180252, 1.0]], [1, [14.502814353702703, 1.0]], [1, [54.657117329380696, 1.0]], [1, [0.22954412869118335, 1.0]], [1, [1.8458695701533867, 1.0]], [1, [0.6705873697288709, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447315]
bas 2, expnt(s) = [833.27098167]
bas 3, expnt(s) = [235.73585713]
bas 4, expnt(s) = [76.42588036]
bas 5, expnt(s) = [10.03497701]
bas 6, expnt(s) = [27.04489024]
bas 7, expnt(s) = [0.38212884]
bas 8, expnt(s) = [1.1184141]
bas 9, expnt(s) = [2.87698807]
bas 10, expnt(s) = [4.99690084]
bas 11, expnt(s) = [14.50281435]
bas 12, expnt(s) = [54.65711733]
bas 13, expnt(s) = [0.22954413]
bas 14, expnt(s) = [1.84586957]
bas 15, expnt(s) = [0.67058737]
CPU time:       102.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735857e+02 1.51996735e+02
 7.64258804e+01 6.53048388e+01 1.00349770e+01 1.42446673e+01
 2.70448902e+01 2.99625617e+01 3.82128837e-01 1.22792653e+00
 1.11841410e+00 2.74768536e+00 2.87698807e+00 5.58108414e+00
 4.99690084e+00 2.17951723e+01 1.45028144e+01 8.25657162e+01
 5.46571173e+01 4.33553599e+02 2.29544129e-01 4.63518560e-01
 1.84586957e+00 6.27676191e+00 6.70587370e-01 1.77032745e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999811345541811
cond(S) = 344.2080187389477
E1 = -183.58641693940845  E_coul = 55.08009603437043
init E= -128.506320905038
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950470215691  LUMO = 0.670166932960607
  mo_energy =
[-3.25551373e+01 -1.85258225e+00 -7.74950470e-01 -7.74950470e-01
 -7.74950470e-01  6.70166933e-01  6.70166933e-01  6.70166933e-01
  1.22155214e+00  3.07089653e+00  3.07089653e+00  3.07089653e+00
  7.37919376e+00  1.03744653e+01  1.03744653e+01  1.03744653e+01
  3.41286166e+01  3.41286166e+01  3.41286166e+01  3.47674462e+01
  1.32479646e+02  1.32479646e+02  1.32479646e+02  1.38891887e+02
  5.02978986e+02  1.87061805e+03  8.00029585e+03  4.77679611e+04]
E1 = -182.05834090920516  E_coul = 53.52349734767735
cycle= 1 E= -128.534843561528  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546571
diis-c [-0.29873931  1.        ]
  HOMO = -0.885562824726965  LUMO = 0.649924667548503
  mo_energy =
[-3.28831286e+01 -1.96860415e+00 -8.85562825e-01 -8.85562825e-01
 -8.85562825e-01  6.49924668e-01  6.49924668e-01  6.49924668e-01
  1.17493628e+00  2.99293730e+00  2.99293730e+00  2.99293730e+00
  7.24486222e+00  1.02136282e+01  1.02136282e+01  1.02136282e+01
  3.38760420e+01  3.38760420e+01  3.38760420e+01  3.45166341e+01
  1.32151190e+02  1.32151190e+02  1.32151190e+02  1.38569232e+02
  5.02612327e+02  1.87021543e+03  7.99986424e+03  4.77675107e+04]
E1 = -182.83595363586053  E_coul = 54.29844663587483
cycle= 2 E= -128.537506999986  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279257
diis-c [-6.40366688e-04  3.37472247e-01  6.62527753e-01]
  HOMO = -0.849218552409468  LUMO = 0.656573658969264
  mo_energy =
[-3.27731265e+01 -1.93030619e+00 -8.49218552e-01 -8.49218552e-01
 -8.49218552e-01  6.56573659e-01  6.56573659e-01  6.56573659e-01
  1.18993319e+00  3.01821723e+00  3.01821723e+00  3.01821723e+00
  7.28902269e+00  1.02667793e+01  1.02667793e+01  1.02667793e+01
  3.39606854e+01  3.39606854e+01  3.39606854e+01  3.46009162e+01
  1.32260648e+02  1.32260648e+02  1.32260648e+02  1.38677206e+02
  5.02731212e+02  1.87033962e+03  7.99999091e+03  4.77676383e+04]
E1 = -182.5713504597479  E_coul = 54.032884378135755
cycle= 3 E= -128.538466081612  delta_E= -0.000959  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993392
diis-c [-1.04803905e-07 -2.05891294e-03 -6.64992818e-04  1.00272391e+00]
  HOMO = -0.849446738471971  LUMO = 0.656552901546247
  mo_energy =
[-3.27735260e+01 -1.93048719e+00 -8.49446738e-01 -8.49446738e-01
 -8.49446738e-01  6.56552902e-01  6.56552902e-01  6.56552902e-01
  1.18986387e+00  3.01809466e+00  3.01809466e+00  3.01809466e+00
  7.28883336e+00  1.02665518e+01  1.02665518e+01  1.02665518e+01
  3.39603655e+01  3.39603655e+01  3.39603655e+01  3.46006078e+01
  1.32260236e+02  1.32260236e+02  1.32260236e+02  1.38676805e+02
  5.02730701e+02  1.87033899e+03  7.99999019e+03  4.77676375e+04]
E1 = -182.57166766960668  E_coul = 54.03320157086074
cycle= 4 E= -128.538466098746  delta_E= -1.71e-08  |g|= 7.29e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182443
diis-c [-6.84718256e-10  1.28033623e-04  5.03902177e-04 -1.39122284e-01
  1.13849035e+00]
  HOMO = -0.849486373092688  LUMO = 0.656543243229684
  mo_energy =
[-3.27735951e+01 -1.93052196e+00 -8.49486373e-01 -8.49486373e-01
 -8.49486373e-01  6.56543243e-01  6.56543243e-01  6.56543243e-01
  1.18984388e+00  3.01806275e+00  3.01806275e+00  3.01806275e+00
  7.28878969e+00  1.02665011e+01  1.02665011e+01  1.02665011e+01
  3.39603026e+01  3.39603026e+01  3.39603026e+01  3.46005458e+01
  1.32260167e+02  1.32260167e+02  1.32260167e+02  1.38676736e+02
  5.02730627e+02  1.87033891e+03  7.99999010e+03  4.77676374e+04]
E1 = -182.5717956371281  E_coul = 54.03332953787936
cycle= 5 E= -128.538466099249  delta_E= -5.03e-10  |g|= 2.86e-06  |ddm|= 3.13e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5717956371281  E_coul = 54.03332953787936
  HOMO = -0.849485213347178  LUMO = 0.656543455648282
  mo_energy =
[-3.27735923e+01 -1.93052032e+00 -8.49485213e-01 -8.49485213e-01
 -8.49485213e-01  6.56543456e-01  6.56543456e-01  6.56543456e-01
  1.18984459e+00  3.01806359e+00  3.01806359e+00  3.01806359e+00
  7.28879139e+00  1.02665029e+01  1.02665029e+01  1.02665029e+01
  3.39603051e+01  3.39603051e+01  3.39603051e+01  3.46005484e+01
  1.32260169e+02  1.32260169e+02  1.32260169e+02  1.38676738e+02
  5.02730629e+02  1.87033891e+03  7.99999011e+03  4.77676374e+04]
E1 = -182.57178789848405  E_coul = 54.03332179923482
Extra cycle  E= -128.538466099249  delta_E= -4.83e-13  |g|= 1.06e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735857e+02
 7.64258804e+01 1.00349770e+01 2.70448902e+01 3.82128837e-01
 1.11841410e+00 2.87698807e+00 4.99690084e+00 1.45028144e+01
 5.46571173e+01 2.29544129e-01 1.84586957e+00 6.70587370e-01]
E = -128.53846609924923
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447315        1
[INPUT] 0    0    [1    /1   ]  833.270981665        1
[INPUT] 0    0    [1    /1   ]  235.735857128        1
[INPUT] 0    0    [1    /1   ]  76.4258803586        1
[INPUT] 0    0    [1    /1   ]  10.0349770134        1
[INPUT] 0    0    [1    /1   ]  27.0448902371        1
[INPUT] 0    0    [1    /1   ]  0.382128836926       1
[INPUT] 0    0    [1    /1   ]  1.11841410236        1
[INPUT] 0    0    [1    /1   ]  2.87698807074        1
[INPUT] 1    0    [1    /1   ]  4.99690084218        1
[INPUT] 1    0    [1    /1   ]  14.5028143537        1
[INPUT] 1    0    [1    /1   ]  54.6571173294        1
[INPUT] 1    0    [1    /1   ]  0.229544128691       1
[INPUT] 1    0    [1    /1   ]  1.84586957015        1
[INPUT] 1    0    [1    /1   ]  0.670587369729       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129930913, 1.0]], [0, [3661.4544731469036, 1.0]], [0, [833.2709816654578, 1.0]], [0, [235.73585712845681, 1.0]], [0, [76.42588035855172, 1.0]], [0, [10.034977013425957, 1.0]], [0, [27.044890237098066, 1.0]], [0, [0.38212883692631694, 1.0]], [0, [1.1184141023614333, 1.0]], [0, [2.8769880707400053, 1.0]], [1, [4.996900842180252, 1.0]], [1, [14.502814353702703, 1.0]], [1, [54.657117329380696, 1.0]], [1, [0.22954412869118335, 1.0]], [1, [1.8458695701533867, 1.0]], [1, [0.6705873697288709, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447315]
bas 2, expnt(s) = [833.27098167]
bas 3, expnt(s) = [235.73585713]
bas 4, expnt(s) = [76.42588036]
bas 5, expnt(s) = [10.03497701]
bas 6, expnt(s) = [27.04489024]
bas 7, expnt(s) = [0.38212884]
bas 8, expnt(s) = [1.1184141]
bas 9, expnt(s) = [2.87698807]
bas 10, expnt(s) = [4.99690084]
bas 11, expnt(s) = [14.50281435]
bas 12, expnt(s) = [54.65711733]
bas 13, expnt(s) = [0.22954413]
bas 14, expnt(s) = [1.84586957]
bas 15, expnt(s) = [0.67058737]
CPU time:       102.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270982e+02 3.91836346e+02 2.35735857e+02 1.51996735e+02
 7.64258804e+01 6.53048388e+01 1.00349770e+01 1.42446673e+01
 2.70448902e+01 2.99625617e+01 3.82128837e-01 1.22792653e+00
 1.11841410e+00 2.74768536e+00 2.87698807e+00 5.58108414e+00
 4.99690084e+00 2.17951723e+01 1.45028144e+01 8.25657162e+01
 5.46571173e+01 4.33553599e+02 2.29544129e-01 4.63518560e-01
 1.84586957e+00 6.27676191e+00 6.70587370e-01 1.77032745e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999811345541811
cond(S) = 344.2080187389477
E1 = -183.58641693940845  E_coul = 55.08009603437043
init E= -128.506320905038
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950470215691  LUMO = 0.670166932960607
  mo_energy =
[-3.25551373e+01 -1.85258225e+00 -7.74950470e-01 -7.74950470e-01
 -7.74950470e-01  6.70166933e-01  6.70166933e-01  6.70166933e-01
  1.22155214e+00  3.07089653e+00  3.07089653e+00  3.07089653e+00
  7.37919376e+00  1.03744653e+01  1.03744653e+01  1.03744653e+01
  3.41286166e+01  3.41286166e+01  3.41286166e+01  3.47674462e+01
  1.32479646e+02  1.32479646e+02  1.32479646e+02  1.38891887e+02
  5.02978986e+02  1.87061805e+03  8.00029585e+03  4.77679611e+04]
E1 = -182.05834090920516  E_coul = 53.52349734767735
cycle= 1 E= -128.534843561528  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546571
diis-c [-0.29873931  1.        ]
  HOMO = -0.885562824726965  LUMO = 0.649924667548503
  mo_energy =
[-3.28831286e+01 -1.96860415e+00 -8.85562825e-01 -8.85562825e-01
 -8.85562825e-01  6.49924668e-01  6.49924668e-01  6.49924668e-01
  1.17493628e+00  2.99293730e+00  2.99293730e+00  2.99293730e+00
  7.24486222e+00  1.02136282e+01  1.02136282e+01  1.02136282e+01
  3.38760420e+01  3.38760420e+01  3.38760420e+01  3.45166341e+01
  1.32151190e+02  1.32151190e+02  1.32151190e+02  1.38569232e+02
  5.02612327e+02  1.87021543e+03  7.99986424e+03  4.77675107e+04]
E1 = -182.83595363586053  E_coul = 54.29844663587483
cycle= 2 E= -128.537506999986  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279257
diis-c [-6.40366688e-04  3.37472247e-01  6.62527753e-01]
  HOMO = -0.849218552409468  LUMO = 0.656573658969264
  mo_energy =
[-3.27731265e+01 -1.93030619e+00 -8.49218552e-01 -8.49218552e-01
 -8.49218552e-01  6.56573659e-01  6.56573659e-01  6.56573659e-01
  1.18993319e+00  3.01821723e+00  3.01821723e+00  3.01821723e+00
  7.28902269e+00  1.02667793e+01  1.02667793e+01  1.02667793e+01
  3.39606854e+01  3.39606854e+01  3.39606854e+01  3.46009162e+01
  1.32260648e+02  1.32260648e+02  1.32260648e+02  1.38677206e+02
  5.02731212e+02  1.87033962e+03  7.99999091e+03  4.77676383e+04]
E1 = -182.5713504597479  E_coul = 54.032884378135755
cycle= 3 E= -128.538466081612  delta_E= -0.000959  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993392
diis-c [-1.04803905e-07 -2.05891294e-03 -6.64992818e-04  1.00272391e+00]
  HOMO = -0.849446738471971  LUMO = 0.656552901546247
  mo_energy =
[-3.27735260e+01 -1.93048719e+00 -8.49446738e-01 -8.49446738e-01
 -8.49446738e-01  6.56552902e-01  6.56552902e-01  6.56552902e-01
  1.18986387e+00  3.01809466e+00  3.01809466e+00  3.01809466e+00
  7.28883336e+00  1.02665518e+01  1.02665518e+01  1.02665518e+01
  3.39603655e+01  3.39603655e+01  3.39603655e+01  3.46006078e+01
  1.32260236e+02  1.32260236e+02  1.32260236e+02  1.38676805e+02
  5.02730701e+02  1.87033899e+03  7.99999019e+03  4.77676375e+04]
E1 = -182.57166766960668  E_coul = 54.03320157086074
cycle= 4 E= -128.538466098746  delta_E= -1.71e-08  |g|= 7.29e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182443
diis-c [-6.84718256e-10  1.28033623e-04  5.03902177e-04 -1.39122284e-01
  1.13849035e+00]
  HOMO = -0.849486373092688  LUMO = 0.656543243229684
  mo_energy =
[-3.27735951e+01 -1.93052196e+00 -8.49486373e-01 -8.49486373e-01
 -8.49486373e-01  6.56543243e-01  6.56543243e-01  6.56543243e-01
  1.18984388e+00  3.01806275e+00  3.01806275e+00  3.01806275e+00
  7.28878969e+00  1.02665011e+01  1.02665011e+01  1.02665011e+01
  3.39603026e+01  3.39603026e+01  3.39603026e+01  3.46005458e+01
  1.32260167e+02  1.32260167e+02  1.32260167e+02  1.38676736e+02
  5.02730627e+02  1.87033891e+03  7.99999010e+03  4.77676374e+04]
E1 = -182.5717956371281  E_coul = 54.03332953787936
cycle= 5 E= -128.538466099249  delta_E= -5.03e-10  |g|= 2.86e-06  |ddm|= 3.13e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5717956371281  E_coul = 54.03332953787936
  HOMO = -0.849485213347178  LUMO = 0.656543455648282
  mo_energy =
[-3.27735923e+01 -1.93052032e+00 -8.49485213e-01 -8.49485213e-01
 -8.49485213e-01  6.56543456e-01  6.56543456e-01  6.56543456e-01
  1.18984459e+00  3.01806359e+00  3.01806359e+00  3.01806359e+00
  7.28879139e+00  1.02665029e+01  1.02665029e+01  1.02665029e+01
  3.39603051e+01  3.39603051e+01  3.39603051e+01  3.46005484e+01
  1.32260169e+02  1.32260169e+02  1.32260169e+02  1.38676738e+02
  5.02730629e+02  1.87033891e+03  7.99999011e+03  4.77676374e+04]
E1 = -182.57178789848405  E_coul = 54.03332179923482
Extra cycle  E= -128.538466099249  delta_E= -4.83e-13  |g|= 1.06e-06  |ddm|= 1.18e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.2080187389477
E1 = -182.57178789848405  E_coul = 54.03332179923482
init E= -128.538466099249
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.849485779046192  LUMO = 0.656543351432328
  mo_energy =
[-3.27735940e+01 -1.93052084e+00 -8.49485779e-01 -8.49485779e-01
 -8.49485779e-01  6.56543351e-01  6.56543351e-01  6.56543351e-01
  1.18984439e+00  3.01806320e+00  3.01806320e+00  3.01806320e+00
  7.28879076e+00  1.02665021e+01  1.02665021e+01  1.02665021e+01
  3.39603038e+01  3.39603038e+01  3.39603038e+01  3.46005471e+01
  1.32260168e+02  1.32260168e+02  1.32260168e+02  1.38676737e+02
  5.02730627e+02  1.87033891e+03  7.99999010e+03  4.77676374e+04]
E1 = -182.5717919285461  E_coul = 54.033325829296906
cycle= 1 E= -128.538466099249  delta_E= 2.84e-14  |g|= 5.58e-07  |ddm|= 3.15e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5717919285461  E_coul = 54.033325829296906
  HOMO = -0.849485497616703  LUMO = 0.656543403340769
  mo_energy =
[-3.27735931e+01 -1.93052052e+00 -8.49485498e-01 -8.49485498e-01
 -8.49485498e-01  6.56543403e-01  6.56543403e-01  6.56543403e-01
  1.18984452e+00  3.01806340e+00  3.01806340e+00  3.01806340e+00
  7.28879111e+00  1.02665025e+01  1.02665025e+01  1.02665025e+01
  3.39603045e+01  3.39603045e+01  3.39603045e+01  3.46005478e+01
  1.32260168e+02  1.32260168e+02  1.32260168e+02  1.38676737e+02
  5.02730628e+02  1.87033891e+03  7.99999010e+03  4.77676374e+04]
E1 = -182.57178986144652  E_coul = 54.03332376219716
Extra cycle  E= -128.538466099249  delta_E= -1.42e-13  |g|= 2.8e-07  |ddm|= 1.9e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270982e+02 2.35735857e+02
 7.64258804e+01 1.00349770e+01 2.70448902e+01 3.82128837e-01
 1.11841410e+00 2.87698807e+00 4.99690084e+00 1.45028144e+01
 5.46571173e+01 2.29544129e-01 1.84586957e+00 6.70587370e-01]
grad_E = [ 3.07461565e-11 -1.64400393e-09  4.22390665e-08 -6.91902923e-07
  4.88649037e-06  4.99894606e-07  1.83759274e-06  2.33409570e-05
  7.87155778e-05 -2.35063223e-05  1.14538197e-04 -3.45259741e-05
 -2.06981765e-04  7.08104946e-05 -2.29158820e-04  1.49405206e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447318        1
[INPUT] 0    0    [1    /1   ]  833.270980823        1
[INPUT] 0    0    [1    /1   ]  235.735870979        1
[INPUT] 0    0    [1    /1   ]  76.425784872         1
[INPUT] 0    0    [1    /1   ]  10.0350965421        1
[INPUT] 0    0    [1    /1   ]  27.0448083173        1
[INPUT] 0    0    [1    /1   ]  0.381192869157       1
[INPUT] 0    0    [1    /1   ]  1.1159342579         1
[INPUT] 0    0    [1    /1   ]  2.87766283505        1
[INPUT] 1    0    [1    /1   ]  4.99846454809        1
[INPUT] 1    0    [1    /1   ]  14.5069131262        1
[INPUT] 1    0    [1    /1   ]  54.6607094558        1
[INPUT] 1    0    [1    /1   ]  0.229769943427       1
[INPUT] 1    0    [1    /1   ]  1.84575573891        1
[INPUT] 1    0    [1    /1   ]  0.67096811922        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129930306, 1.0]], [0, [3661.454473179433, 1.0]], [0, [833.2709808226901, 1.0]], [0, [235.73587097890504, 1.0]], [0, [76.42578487195766, 1.0]], [0, [10.035096542089123, 1.0]], [0, [27.04480831728604, 1.0]], [0, [0.38119286915719336, 1.0]], [0, [1.1159342578977745, 1.0]], [0, [2.877662835053049, 1.0]], [1, [4.998464548090533, 1.0]], [1, [14.506913126232307, 1.0]], [1, [54.66070945581858, 1.0]], [1, [0.2297699434270697, 1.0]], [1, [1.8457557389058192, 1.0]], [1, [0.6709681192201831, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447318]
bas 2, expnt(s) = [833.27098082]
bas 3, expnt(s) = [235.73587098]
bas 4, expnt(s) = [76.42578487]
bas 5, expnt(s) = [10.03509654]
bas 6, expnt(s) = [27.04480832]
bas 7, expnt(s) = [0.38119287]
bas 8, expnt(s) = [1.11593426]
bas 9, expnt(s) = [2.87766284]
bas 10, expnt(s) = [4.99846455]
bas 11, expnt(s) = [14.50691313]
bas 12, expnt(s) = [54.66070946]
bas 13, expnt(s) = [0.22976994]
bas 14, expnt(s) = [1.84575574]
bas 15, expnt(s) = [0.67096812]
CPU time:       105.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270981e+02 3.91836346e+02 2.35735871e+02 1.51996742e+02
 7.64257849e+01 6.53047776e+01 1.00350965e+01 1.42447946e+01
 2.70448083e+01 2.99624937e+01 3.81192869e-01 1.22567012e+00
 1.11593426e+00 2.74311479e+00 2.87766284e+00 5.58206585e+00
 4.99846455e+00 2.18036982e+01 1.45069131e+01 8.25948855e+01
 5.46607095e+01 4.33589217e+02 2.29769943e-01 4.64088615e-01
 1.84575574e+00 6.27627807e+00 6.70968119e-01 1.77158400e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999811683796047
cond(S) = 343.51381909069215
E1 = -183.5864202526555  E_coul = 55.08009900057083
init E= -128.506321252085
    CPU time for initialize scf      0.04 sec, wall time      0.05 sec
  HOMO = -0.774950452535298  LUMO = 0.670859092110356
  mo_energy =
[-3.25551358e+01 -1.85258289e+00 -7.74950453e-01 -7.74950453e-01
 -7.74950453e-01  6.70859092e-01  6.70859092e-01  6.70859092e-01
  1.21769182e+00  3.07262674e+00  3.07262674e+00  3.07262674e+00
  7.36816658e+00  1.03774985e+01  1.03774985e+01  1.03774985e+01
  3.41389296e+01  3.41389296e+01  3.41389296e+01  3.47553952e+01
  1.32503927e+02  1.32503927e+02  1.32503927e+02  1.38881385e+02
  5.02969508e+02  1.87060950e+03  8.00028831e+03  4.77679549e+04]
E1 = -182.0583370389152  E_coul = 53.52349295988256
cycle= 1 E= -128.534844079033  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.546652
diis-c [-0.2988286  1.       ]
  HOMO = -0.885564830975705  LUMO = 0.65059084751468
  mo_energy =
[-3.28831276e+01 -1.96860171e+00 -8.85564831e-01 -8.85564831e-01
 -8.85564831e-01  6.50590848e-01  6.50590848e-01  6.50590848e-01
  1.17119093e+00  2.99465280e+00  2.99465280e+00  2.99465280e+00
  7.23387469e+00  1.02166465e+01  1.02166465e+01  1.02166465e+01
  3.38863346e+01  3.38863346e+01  3.38863346e+01  3.45045676e+01
  1.32175468e+02  1.32175468e+02  1.32175468e+02  1.38558725e+02
  5.02602847e+02  1.87020687e+03  7.99985671e+03  4.77675044e+04]
E1 = -182.8359528020806  E_coul = 54.298445161697
cycle= 2 E= -128.537507640384  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279292
diis-c [-6.40339679e-04  3.37466363e-01  6.62533637e-01]
  HOMO = -0.849220112105482  LUMO = 0.657247863096604
  mo_energy =
[-3.27731236e+01 -1.93030368e+00 -8.49220112e-01 -8.49220112e-01
 -8.49220112e-01  6.57247863e-01  6.57247863e-01  6.57247863e-01
  1.18615096e+00  3.01993765e+00  3.01993765e+00  3.01993765e+00
  7.27802240e+00  1.02698026e+01  1.02698026e+01  1.02698026e+01
  3.39709860e+01  3.39709860e+01  3.39709860e+01  3.45888548e+01
  1.32284928e+02  1.32284928e+02  1.32284928e+02  1.38666702e+02
  5.02721735e+02  1.87033107e+03  7.99998337e+03  4.77676320e+04]
E1 = -182.5713510036807  E_coul = 54.03288429093847
cycle= 3 E= -128.538466712742  delta_E= -0.000959  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000995362
diis-c [-1.05584768e-07 -2.06009926e-03 -6.61806478e-04  1.00272191e+00]
  HOMO = -0.849448419041279  LUMO = 0.657227008023897
  mo_energy =
[-3.27735233e+01 -1.93048448e+00 -8.49448419e-01 -8.49448419e-01
 -8.49448419e-01  6.57227008e-01  6.57227008e-01  6.57227008e-01
  1.18608184e+00  3.01981496e+00  3.01981496e+00  3.01981496e+00
  7.27783322e+00  1.02695750e+01  1.02695750e+01  1.02695750e+01
  3.39706660e+01  3.39706660e+01  3.39706660e+01  3.45885462e+01
  1.32284516e+02  1.32284516e+02  1.32284516e+02  1.38666301e+02
  5.02721224e+02  1.87033044e+03  7.99998265e+03  4.77676313e+04]
E1 = -182.5716683635787  E_coul = 54.033201633614674
cycle= 4 E= -128.538466729964  delta_E= -1.72e-08  |g|= 7.32e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183134
diis-c [-6.90493080e-10  1.29162730e-04  5.06043529e-04 -1.39774521e-01
  1.13913931e+00]
  HOMO = -0.849488157708185  LUMO = 0.65721731574985
  mo_energy =
[-3.27735926e+01 -1.93051927e+00 -8.49488158e-01 -8.49488158e-01
 -8.49488158e-01  6.57217316e-01  6.57217316e-01  6.57217316e-01
  1.18606188e+00  3.01978296e+00  3.01978296e+00  3.01978296e+00
  7.27778949e+00  1.02695242e+01  1.02695242e+01  1.02695242e+01
  3.39706029e+01  3.39706029e+01  3.39706029e+01  3.45884841e+01
  1.32284446e+02  1.32284446e+02  1.32284446e+02  1.38666232e+02
  5.02721149e+02  1.87033036e+03  7.99998257e+03  4.77676312e+04]
E1 = -182.57179676463878  E_coul = 54.03333003416885
cycle= 5 E= -128.53846673047  delta_E= -5.06e-10  |g|= 2.89e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57179676463878  E_coul = 54.03333003416885
  HOMO = -0.849486980422403  LUMO = 0.657217533363239
  mo_energy =
[-3.27735898e+01 -1.93051761e+00 -8.49486980e-01 -8.49486980e-01
 -8.49486980e-01  6.57217533e-01  6.57217533e-01  6.57217533e-01
  1.18606260e+00  3.01978382e+00  3.01978382e+00  3.01978382e+00
  7.27779122e+00  1.02695260e+01  1.02695260e+01  1.02695260e+01
  3.39706054e+01  3.39706054e+01  3.39706054e+01  3.45884867e+01
  1.32284449e+02  1.32284449e+02  1.32284449e+02  1.38666234e+02
  5.02721151e+02  1.87033036e+03  7.99998257e+03  4.77676312e+04]
E1 = -182.5717889737883  E_coul = 54.03332224331717
Extra cycle  E= -128.538466730471  delta_E= -1.19e-12  |g|= 1.07e-06  |ddm|= 1.19e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270981e+02 2.35735871e+02
 7.64257849e+01 1.00350965e+01 2.70448083e+01 3.81192869e-01
 1.11593426e+00 2.87766284e+00 4.99846455e+00 1.45069131e+01
 5.46607095e+01 2.29769943e-01 1.84575574e+00 6.70968119e-01]
E = -128.53846673047113
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447318        1
[INPUT] 0    0    [1    /1   ]  833.270980823        1
[INPUT] 0    0    [1    /1   ]  235.735870979        1
[INPUT] 0    0    [1    /1   ]  76.425784872         1
[INPUT] 0    0    [1    /1   ]  10.0350965421        1
[INPUT] 0    0    [1    /1   ]  27.0448083173        1
[INPUT] 0    0    [1    /1   ]  0.381192869157       1
[INPUT] 0    0    [1    /1   ]  1.1159342579         1
[INPUT] 0    0    [1    /1   ]  2.87766283505        1
[INPUT] 1    0    [1    /1   ]  4.99846454809        1
[INPUT] 1    0    [1    /1   ]  14.5069131262        1
[INPUT] 1    0    [1    /1   ]  54.6607094558        1
[INPUT] 1    0    [1    /1   ]  0.229769943427       1
[INPUT] 1    0    [1    /1   ]  1.84575573891        1
[INPUT] 1    0    [1    /1   ]  0.67096811922        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129930306, 1.0]], [0, [3661.454473179433, 1.0]], [0, [833.2709808226901, 1.0]], [0, [235.73587097890504, 1.0]], [0, [76.42578487195766, 1.0]], [0, [10.035096542089123, 1.0]], [0, [27.04480831728604, 1.0]], [0, [0.38119286915719336, 1.0]], [0, [1.1159342578977745, 1.0]], [0, [2.877662835053049, 1.0]], [1, [4.998464548090533, 1.0]], [1, [14.506913126232307, 1.0]], [1, [54.66070945581858, 1.0]], [1, [0.2297699434270697, 1.0]], [1, [1.8457557389058192, 1.0]], [1, [0.6709681192201831, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447318]
bas 2, expnt(s) = [833.27098082]
bas 3, expnt(s) = [235.73587098]
bas 4, expnt(s) = [76.42578487]
bas 5, expnt(s) = [10.03509654]
bas 6, expnt(s) = [27.04480832]
bas 7, expnt(s) = [0.38119287]
bas 8, expnt(s) = [1.11593426]
bas 9, expnt(s) = [2.87766284]
bas 10, expnt(s) = [4.99846455]
bas 11, expnt(s) = [14.50691313]
bas 12, expnt(s) = [54.66070946]
bas 13, expnt(s) = [0.22976994]
bas 14, expnt(s) = [1.84575574]
bas 15, expnt(s) = [0.67096812]
CPU time:       106.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270981e+02 3.91836346e+02 2.35735871e+02 1.51996742e+02
 7.64257849e+01 6.53047776e+01 1.00350965e+01 1.42447946e+01
 2.70448083e+01 2.99624937e+01 3.81192869e-01 1.22567012e+00
 1.11593426e+00 2.74311479e+00 2.87766284e+00 5.58206585e+00
 4.99846455e+00 2.18036982e+01 1.45069131e+01 8.25948855e+01
 5.46607095e+01 4.33589217e+02 2.29769943e-01 4.64088615e-01
 1.84575574e+00 6.27627807e+00 6.70968119e-01 1.77158400e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999811683796047
cond(S) = 343.51381909069215
E1 = -183.5864202526555  E_coul = 55.08009900057083
init E= -128.506321252085
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950452535298  LUMO = 0.670859092110356
  mo_energy =
[-3.25551358e+01 -1.85258289e+00 -7.74950453e-01 -7.74950453e-01
 -7.74950453e-01  6.70859092e-01  6.70859092e-01  6.70859092e-01
  1.21769182e+00  3.07262674e+00  3.07262674e+00  3.07262674e+00
  7.36816658e+00  1.03774985e+01  1.03774985e+01  1.03774985e+01
  3.41389296e+01  3.41389296e+01  3.41389296e+01  3.47553952e+01
  1.32503927e+02  1.32503927e+02  1.32503927e+02  1.38881385e+02
  5.02969508e+02  1.87060950e+03  8.00028831e+03  4.77679549e+04]
E1 = -182.0583370389152  E_coul = 53.52349295988256
cycle= 1 E= -128.534844079033  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.546652
diis-c [-0.2988286  1.       ]
  HOMO = -0.885564830975705  LUMO = 0.65059084751468
  mo_energy =
[-3.28831276e+01 -1.96860171e+00 -8.85564831e-01 -8.85564831e-01
 -8.85564831e-01  6.50590848e-01  6.50590848e-01  6.50590848e-01
  1.17119093e+00  2.99465280e+00  2.99465280e+00  2.99465280e+00
  7.23387469e+00  1.02166465e+01  1.02166465e+01  1.02166465e+01
  3.38863346e+01  3.38863346e+01  3.38863346e+01  3.45045676e+01
  1.32175468e+02  1.32175468e+02  1.32175468e+02  1.38558725e+02
  5.02602847e+02  1.87020687e+03  7.99985671e+03  4.77675044e+04]
E1 = -182.8359528020806  E_coul = 54.298445161697
cycle= 2 E= -128.537507640384  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279292
diis-c [-6.40339679e-04  3.37466363e-01  6.62533637e-01]
  HOMO = -0.849220112105482  LUMO = 0.657247863096604
  mo_energy =
[-3.27731236e+01 -1.93030368e+00 -8.49220112e-01 -8.49220112e-01
 -8.49220112e-01  6.57247863e-01  6.57247863e-01  6.57247863e-01
  1.18615096e+00  3.01993765e+00  3.01993765e+00  3.01993765e+00
  7.27802240e+00  1.02698026e+01  1.02698026e+01  1.02698026e+01
  3.39709860e+01  3.39709860e+01  3.39709860e+01  3.45888548e+01
  1.32284928e+02  1.32284928e+02  1.32284928e+02  1.38666702e+02
  5.02721735e+02  1.87033107e+03  7.99998337e+03  4.77676320e+04]
E1 = -182.5713510036807  E_coul = 54.03288429093847
cycle= 3 E= -128.538466712742  delta_E= -0.000959  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000995362
diis-c [-1.05584768e-07 -2.06009926e-03 -6.61806478e-04  1.00272191e+00]
  HOMO = -0.849448419041279  LUMO = 0.657227008023897
  mo_energy =
[-3.27735233e+01 -1.93048448e+00 -8.49448419e-01 -8.49448419e-01
 -8.49448419e-01  6.57227008e-01  6.57227008e-01  6.57227008e-01
  1.18608184e+00  3.01981496e+00  3.01981496e+00  3.01981496e+00
  7.27783322e+00  1.02695750e+01  1.02695750e+01  1.02695750e+01
  3.39706660e+01  3.39706660e+01  3.39706660e+01  3.45885462e+01
  1.32284516e+02  1.32284516e+02  1.32284516e+02  1.38666301e+02
  5.02721224e+02  1.87033044e+03  7.99998265e+03  4.77676313e+04]
E1 = -182.5716683635787  E_coul = 54.033201633614674
cycle= 4 E= -128.538466729964  delta_E= -1.72e-08  |g|= 7.32e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183134
diis-c [-6.90493080e-10  1.29162730e-04  5.06043529e-04 -1.39774521e-01
  1.13913931e+00]
  HOMO = -0.849488157708185  LUMO = 0.65721731574985
  mo_energy =
[-3.27735926e+01 -1.93051927e+00 -8.49488158e-01 -8.49488158e-01
 -8.49488158e-01  6.57217316e-01  6.57217316e-01  6.57217316e-01
  1.18606188e+00  3.01978296e+00  3.01978296e+00  3.01978296e+00
  7.27778949e+00  1.02695242e+01  1.02695242e+01  1.02695242e+01
  3.39706029e+01  3.39706029e+01  3.39706029e+01  3.45884841e+01
  1.32284446e+02  1.32284446e+02  1.32284446e+02  1.38666232e+02
  5.02721149e+02  1.87033036e+03  7.99998257e+03  4.77676312e+04]
E1 = -182.57179676463878  E_coul = 54.03333003416885
cycle= 5 E= -128.53846673047  delta_E= -5.06e-10  |g|= 2.89e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57179676463878  E_coul = 54.03333003416885
  HOMO = -0.849486980422403  LUMO = 0.657217533363239
  mo_energy =
[-3.27735898e+01 -1.93051761e+00 -8.49486980e-01 -8.49486980e-01
 -8.49486980e-01  6.57217533e-01  6.57217533e-01  6.57217533e-01
  1.18606260e+00  3.01978382e+00  3.01978382e+00  3.01978382e+00
  7.27779122e+00  1.02695260e+01  1.02695260e+01  1.02695260e+01
  3.39706054e+01  3.39706054e+01  3.39706054e+01  3.45884867e+01
  1.32284449e+02  1.32284449e+02  1.32284449e+02  1.38666234e+02
  5.02721151e+02  1.87033036e+03  7.99998257e+03  4.77676312e+04]
E1 = -182.5717889737883  E_coul = 54.03332224331717
Extra cycle  E= -128.538466730471  delta_E= -1.19e-12  |g|= 1.07e-06  |ddm|= 1.19e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.51381909069215
E1 = -182.5717889737883  E_coul = 54.03332224331717
init E= -128.538466730471
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.84948754965757  LUMO = 0.657217428629671
  mo_energy =
[-3.27735915e+01 -1.93051813e+00 -8.49487550e-01 -8.49487550e-01
 -8.49487550e-01  6.57217429e-01  6.57217429e-01  6.57217429e-01
  1.18606240e+00  3.01978343e+00  3.01978343e+00  3.01978343e+00
  7.27779058e+00  1.02695252e+01  1.02695252e+01  1.02695252e+01
  3.39706041e+01  3.39706041e+01  3.39706041e+01  3.45884854e+01
  1.32284447e+02  1.32284447e+02  1.32284447e+02  1.38666233e+02
  5.02721150e+02  1.87033036e+03  7.99998257e+03  4.77676312e+04]
E1 = -182.5717930399714  E_coul = 54.03332630950023
cycle= 1 E= -128.538466730471  delta_E= -2.84e-14  |g|= 5.63e-07  |ddm|= 3.18e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5717930399714  E_coul = 54.03332630950023
  HOMO = -0.849487265667563  LUMO = 0.657217481112929
  mo_energy =
[-3.27735906e+01 -1.93051781e+00 -8.49487266e-01 -8.49487266e-01
 -8.49487266e-01  6.57217481e-01  6.57217481e-01  6.57217481e-01
  1.18606253e+00  3.01978363e+00  3.01978363e+00  3.01978363e+00
  7.27779094e+00  1.02695256e+01  1.02695256e+01  1.02695256e+01
  3.39706048e+01  3.39706048e+01  3.39706048e+01  3.45884861e+01
  1.32284448e+02  1.32284448e+02  1.32284448e+02  1.38666234e+02
  5.02721151e+02  1.87033036e+03  7.99998257e+03  4.77676312e+04]
E1 = -182.5717909557681  E_coul = 54.03332422529711
Extra cycle  E= -128.538466730471  delta_E= 1.71e-13  |g|= 2.82e-07  |ddm|= 1.91e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270981e+02 2.35735871e+02
 7.64257849e+01 1.00350965e+01 2.70448083e+01 3.81192869e-01
 1.11593426e+00 2.87766284e+00 4.99846455e+00 1.45069131e+01
 5.46607095e+01 2.29769943e-01 1.84575574e+00 6.70968119e-01]
grad_E = [ 3.52404005e-11 -1.88126433e-09  4.70429554e-08 -7.51814051e-07
  5.39763191e-06  1.11962382e-05 -1.24499541e-06 -9.97173537e-06
 -8.91551228e-06 -2.40372143e-06  1.65606003e-04 -4.08169374e-05
 -2.06765345e-04  1.49827341e-05 -3.98352015e-04  3.94530615e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447322        1
[INPUT] 0    0    [1    /1   ]  833.270979676        1
[INPUT] 0    0    [1    /1   ]  235.73588995         1
[INPUT] 0    0    [1    /1   ]  76.4256530787        1
[INPUT] 0    0    [1    /1   ]  10.0352486639        1
[INPUT] 0    0    [1    /1   ]  27.0447032569        1
[INPUT] 0    0    [1    /1   ]  0.379894314174       1
[INPUT] 0    0    [1    /1   ]  1.11249796151        1
[INPUT] 0    0    [1    /1   ]  2.87861187219        1
[INPUT] 1    0    [1    /1   ]  4.99868278819        1
[INPUT] 1    0    [1    /1   ]  14.5099628743        1
[INPUT] 1    0    [1    /1   ]  54.6661827056        1
[INPUT] 1    0    [1    /1   ]  0.229936138618       1
[INPUT] 1    0    [1    /1   ]  1.84600689077        1
[INPUT] 1    0    [1    /1   ]  0.671432047304       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129929483, 1.0]], [0, [3661.4544732235026, 1.0]], [0, [833.2709796755407, 1.0]], [0, [235.73588995038997, 1.0]], [0, [76.42565307869778, 1.0]], [0, [10.035248663851737, 1.0]], [0, [27.044703256913696, 1.0]], [0, [0.3798943141737557, 1.0]], [0, [1.1124979615107033, 1.0]], [0, [2.878611872187179, 1.0]], [1, [4.998682788188187, 1.0]], [1, [14.50996287425282, 1.0]], [1, [54.666182705570634, 1.0]], [1, [0.22993613861838222, 1.0]], [1, [1.8460068907710188, 1.0]], [1, [0.6714320473043185, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447322]
bas 2, expnt(s) = [833.27097968]
bas 3, expnt(s) = [235.73588995]
bas 4, expnt(s) = [76.42565308]
bas 5, expnt(s) = [10.03524866]
bas 6, expnt(s) = [27.04470326]
bas 7, expnt(s) = [0.37989431]
bas 8, expnt(s) = [1.11249796]
bas 9, expnt(s) = [2.87861187]
bas 10, expnt(s) = [4.99868279]
bas 11, expnt(s) = [14.50996287]
bas 12, expnt(s) = [54.66618271]
bas 13, expnt(s) = [0.22993614]
bas 14, expnt(s) = [1.84600689]
bas 15, expnt(s) = [0.67143205]
CPU time:       109.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270980e+02 3.91836345e+02 2.35735890e+02 1.51996751e+02
 7.64256531e+01 6.53046932e+01 1.00352487e+01 1.42449565e+01
 2.70447033e+01 2.99624064e+01 3.79894314e-01 1.22253730e+00
 1.11249796e+00 2.73677719e+00 2.87861187e+00 5.58344649e+00
 4.99868279e+00 2.18048882e+01 1.45099629e+01 8.26165907e+01
 5.46661827e+01 4.33643487e+02 2.29936139e-01 4.64508253e-01
 1.84600689e+00 6.27734561e+00 6.71432047e-01 1.77311529e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999812338578996
cond(S) = 342.56119939638626
E1 = -183.58642617484753  E_coul = 55.08010487304237
init E= -128.506321301805
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77495047481705  LUMO = 0.671418525266509
  mo_energy =
[-3.25551331e+01 -1.85258337e+00 -7.74950475e-01 -7.74950475e-01
 -7.74950475e-01  6.71418525e-01  6.71418525e-01  6.71418525e-01
  1.21233936e+00  3.07452186e+00  3.07452186e+00  3.07452186e+00
  7.35288181e+00  1.03805368e+01  1.03805368e+01  1.03805368e+01
  3.41457519e+01  3.41457519e+01  3.41457519e+01  3.47387162e+01
  1.32524580e+02  1.32524580e+02  1.32524580e+02  1.38866856e+02
  5.02956404e+02  1.87059767e+03  8.00027790e+03  4.77679463e+04]
E1 = -182.05825202955148  E_coul = 53.52340756485983
cycle= 1 E= -128.534844464692  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546732
diis-c [-0.29891594  1.        ]
  HOMO = -0.885574184507928  LUMO = 0.651125217342658
  mo_energy =
[-3.28831389e+01 -1.96860552e+00 -8.85574185e-01 -8.85574185e-01
 -8.85574185e-01  6.51125217e-01  6.51125217e-01  6.51125217e-01
  1.16599388e+00  2.99651816e+00  2.99651816e+00  2.99651816e+00
  7.21863633e+00  1.02196711e+01  1.02196711e+01  1.02196711e+01
  3.38931353e+01  3.38931353e+01  3.38931353e+01  3.44878579e+01
  1.32196102e+02  1.32196102e+02  1.32196102e+02  1.38544179e+02
  5.02589729e+02  1.87019504e+03  7.99984628e+03  4.77674958e+04]
E1 = -182.83591727539772  E_coul = 54.29840893709979
cycle= 2 E= -128.537508338298  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27933
diis-c [-6.40405136e-04  3.37464530e-01  6.62535470e-01]
  HOMO = -0.849226966629192  LUMO = 0.65778996190842
  mo_energy =
[-3.27731275e+01 -1.93030533e+00 -8.49226967e-01 -8.49226967e-01
 -8.49226967e-01  6.57789962e-01  6.57789962e-01  6.57789962e-01
  1.18090370e+00  3.02181245e+00  3.02181245e+00  3.02181245e+00
  7.26276874e+00  1.02728317e+01  1.02728317e+01  1.02728317e+01
  3.39777955e+01  3.39777955e+01  3.39777955e+01  3.45721559e+01
  1.32305571e+02  1.32305571e+02  1.32305571e+02  1.38652165e+02
  5.02708624e+02  1.87031924e+03  7.99997296e+03  4.77676234e+04]
E1 = -182.57129693361364  E_coul = 54.0328294105072
cycle= 3 E= -128.538467523106  delta_E= -0.000959  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997865
diis-c [-1.06614982e-07 -2.06197923e-03 -6.58400148e-04  1.00272038e+00]
  HOMO = -0.849455494143575  LUMO = 0.657769008551151
  mo_energy =
[-3.27735275e+01 -1.93048593e+00 -8.49455494e-01 -8.49455494e-01
 -8.49455494e-01  6.57769009e-01  6.57769009e-01  6.57769009e-01
  1.18083484e+00  3.02168957e+00  3.02168957e+00  3.02168957e+00
  7.26257969e+00  1.02726038e+01  1.02726038e+01  1.02726038e+01
  3.39774754e+01  3.39774754e+01  3.39774754e+01  3.45718472e+01
  1.32305158e+02  1.32305158e+02  1.32305158e+02  1.38651763e+02
  5.02708113e+02  1.87031861e+03  7.99997224e+03  4.77676226e+04]
E1 = -182.57161456556074  E_coul = 54.03314702512566
cycle= 4 E= -128.538467540435  delta_E= -1.73e-08  |g|= 7.34e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183998
diis-c [-6.98299170e-10  1.30637145e-04  5.08721231e-04 -1.40621551e-01
  1.13998219e+00]
  HOMO = -0.849495366120776  LUMO = 0.657759278764861
  mo_energy =
[-3.27735971e+01 -1.93052074e+00 -8.49495366e-01 -8.49495366e-01
 -8.49495366e-01  6.57759279e-01  6.57759279e-01  6.57759279e-01
  1.18081492e+00  3.02165748e+00  3.02165748e+00  3.02165748e+00
  7.26253589e+00  1.02725529e+01  1.02725529e+01  1.02725529e+01
  3.39774121e+01  3.39774121e+01  3.39774121e+01  3.45717848e+01
  1.32305089e+02  1.32305089e+02  1.32305089e+02  1.38651694e+02
  5.02708038e+02  1.87031853e+03  7.99997215e+03  4.77676226e+04]
E1 = -182.57174352581671  E_coul = 54.03327598487009
cycle= 5 E= -128.538467540947  delta_E= -5.12e-10  |g|= 2.93e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57174352581671  E_coul = 54.03327598487009
  HOMO = -0.849494165216977  LUMO = 0.657759503182731
  mo_energy =
[-3.27735942e+01 -1.93051905e+00 -8.49494165e-01 -8.49494165e-01
 -8.49494165e-01  6.57759503e-01  6.57759503e-01  6.57759503e-01
  1.18081566e+00  3.02165836e+00  3.02165836e+00  3.02165836e+00
  7.26253765e+00  1.02725547e+01  1.02725547e+01  1.02725547e+01
  3.39774146e+01  3.39774146e+01  3.39774146e+01  3.45717875e+01
  1.32305091e+02  1.32305091e+02  1.32305091e+02  1.38651696e+02
  5.02708040e+02  1.87031853e+03  7.99997215e+03  4.77676226e+04]
E1 = -182.5717356648603  E_coul = 54.03326812391333
Extra cycle  E= -128.538467540947  delta_E= -3.69e-13  |g|= 1.08e-06  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270980e+02 2.35735890e+02
 7.64256531e+01 1.00352487e+01 2.70447033e+01 3.79894314e-01
 1.11249796e+00 2.87861187e+00 4.99868279e+00 1.45099629e+01
 5.46661827e+01 2.29936139e-01 1.84600689e+00 6.71432047e-01]
E = -128.53846754094698
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447322        1
[INPUT] 0    0    [1    /1   ]  833.270979676        1
[INPUT] 0    0    [1    /1   ]  235.73588995         1
[INPUT] 0    0    [1    /1   ]  76.4256530787        1
[INPUT] 0    0    [1    /1   ]  10.0352486639        1
[INPUT] 0    0    [1    /1   ]  27.0447032569        1
[INPUT] 0    0    [1    /1   ]  0.379894314174       1
[INPUT] 0    0    [1    /1   ]  1.11249796151        1
[INPUT] 0    0    [1    /1   ]  2.87861187219        1
[INPUT] 1    0    [1    /1   ]  4.99868278819        1
[INPUT] 1    0    [1    /1   ]  14.5099628743        1
[INPUT] 1    0    [1    /1   ]  54.6661827056        1
[INPUT] 1    0    [1    /1   ]  0.229936138618       1
[INPUT] 1    0    [1    /1   ]  1.84600689077        1
[INPUT] 1    0    [1    /1   ]  0.671432047304       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129929483, 1.0]], [0, [3661.4544732235026, 1.0]], [0, [833.2709796755407, 1.0]], [0, [235.73588995038997, 1.0]], [0, [76.42565307869778, 1.0]], [0, [10.035248663851737, 1.0]], [0, [27.044703256913696, 1.0]], [0, [0.3798943141737557, 1.0]], [0, [1.1124979615107033, 1.0]], [0, [2.878611872187179, 1.0]], [1, [4.998682788188187, 1.0]], [1, [14.50996287425282, 1.0]], [1, [54.666182705570634, 1.0]], [1, [0.22993613861838222, 1.0]], [1, [1.8460068907710188, 1.0]], [1, [0.6714320473043185, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447322]
bas 2, expnt(s) = [833.27097968]
bas 3, expnt(s) = [235.73588995]
bas 4, expnt(s) = [76.42565308]
bas 5, expnt(s) = [10.03524866]
bas 6, expnt(s) = [27.04470326]
bas 7, expnt(s) = [0.37989431]
bas 8, expnt(s) = [1.11249796]
bas 9, expnt(s) = [2.87861187]
bas 10, expnt(s) = [4.99868279]
bas 11, expnt(s) = [14.50996287]
bas 12, expnt(s) = [54.66618271]
bas 13, expnt(s) = [0.22993614]
bas 14, expnt(s) = [1.84600689]
bas 15, expnt(s) = [0.67143205]
CPU time:       110.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270980e+02 3.91836345e+02 2.35735890e+02 1.51996751e+02
 7.64256531e+01 6.53046932e+01 1.00352487e+01 1.42449565e+01
 2.70447033e+01 2.99624064e+01 3.79894314e-01 1.22253730e+00
 1.11249796e+00 2.73677719e+00 2.87861187e+00 5.58344649e+00
 4.99868279e+00 2.18048882e+01 1.45099629e+01 8.26165907e+01
 5.46661827e+01 4.33643487e+02 2.29936139e-01 4.64508253e-01
 1.84600689e+00 6.27734561e+00 6.71432047e-01 1.77311529e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999812338578996
cond(S) = 342.56119939638626
E1 = -183.58642617484753  E_coul = 55.08010487304237
init E= -128.506321301805
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77495047481705  LUMO = 0.671418525266509
  mo_energy =
[-3.25551331e+01 -1.85258337e+00 -7.74950475e-01 -7.74950475e-01
 -7.74950475e-01  6.71418525e-01  6.71418525e-01  6.71418525e-01
  1.21233936e+00  3.07452186e+00  3.07452186e+00  3.07452186e+00
  7.35288181e+00  1.03805368e+01  1.03805368e+01  1.03805368e+01
  3.41457519e+01  3.41457519e+01  3.41457519e+01  3.47387162e+01
  1.32524580e+02  1.32524580e+02  1.32524580e+02  1.38866856e+02
  5.02956404e+02  1.87059767e+03  8.00027790e+03  4.77679463e+04]
E1 = -182.05825202955148  E_coul = 53.52340756485983
cycle= 1 E= -128.534844464692  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546732
diis-c [-0.29891594  1.        ]
  HOMO = -0.885574184507928  LUMO = 0.651125217342658
  mo_energy =
[-3.28831389e+01 -1.96860552e+00 -8.85574185e-01 -8.85574185e-01
 -8.85574185e-01  6.51125217e-01  6.51125217e-01  6.51125217e-01
  1.16599388e+00  2.99651816e+00  2.99651816e+00  2.99651816e+00
  7.21863633e+00  1.02196711e+01  1.02196711e+01  1.02196711e+01
  3.38931353e+01  3.38931353e+01  3.38931353e+01  3.44878579e+01
  1.32196102e+02  1.32196102e+02  1.32196102e+02  1.38544179e+02
  5.02589729e+02  1.87019504e+03  7.99984628e+03  4.77674958e+04]
E1 = -182.83591727539772  E_coul = 54.29840893709979
cycle= 2 E= -128.537508338298  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27933
diis-c [-6.40405136e-04  3.37464530e-01  6.62535470e-01]
  HOMO = -0.849226966629192  LUMO = 0.65778996190842
  mo_energy =
[-3.27731275e+01 -1.93030533e+00 -8.49226967e-01 -8.49226967e-01
 -8.49226967e-01  6.57789962e-01  6.57789962e-01  6.57789962e-01
  1.18090370e+00  3.02181245e+00  3.02181245e+00  3.02181245e+00
  7.26276874e+00  1.02728317e+01  1.02728317e+01  1.02728317e+01
  3.39777955e+01  3.39777955e+01  3.39777955e+01  3.45721559e+01
  1.32305571e+02  1.32305571e+02  1.32305571e+02  1.38652165e+02
  5.02708624e+02  1.87031924e+03  7.99997296e+03  4.77676234e+04]
E1 = -182.57129693361364  E_coul = 54.0328294105072
cycle= 3 E= -128.538467523106  delta_E= -0.000959  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997865
diis-c [-1.06614982e-07 -2.06197923e-03 -6.58400148e-04  1.00272038e+00]
  HOMO = -0.849455494143575  LUMO = 0.657769008551151
  mo_energy =
[-3.27735275e+01 -1.93048593e+00 -8.49455494e-01 -8.49455494e-01
 -8.49455494e-01  6.57769009e-01  6.57769009e-01  6.57769009e-01
  1.18083484e+00  3.02168957e+00  3.02168957e+00  3.02168957e+00
  7.26257969e+00  1.02726038e+01  1.02726038e+01  1.02726038e+01
  3.39774754e+01  3.39774754e+01  3.39774754e+01  3.45718472e+01
  1.32305158e+02  1.32305158e+02  1.32305158e+02  1.38651763e+02
  5.02708113e+02  1.87031861e+03  7.99997224e+03  4.77676226e+04]
E1 = -182.57161456556074  E_coul = 54.03314702512566
cycle= 4 E= -128.538467540435  delta_E= -1.73e-08  |g|= 7.34e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183998
diis-c [-6.98299170e-10  1.30637145e-04  5.08721231e-04 -1.40621551e-01
  1.13998219e+00]
  HOMO = -0.849495366120776  LUMO = 0.657759278764861
  mo_energy =
[-3.27735971e+01 -1.93052074e+00 -8.49495366e-01 -8.49495366e-01
 -8.49495366e-01  6.57759279e-01  6.57759279e-01  6.57759279e-01
  1.18081492e+00  3.02165748e+00  3.02165748e+00  3.02165748e+00
  7.26253589e+00  1.02725529e+01  1.02725529e+01  1.02725529e+01
  3.39774121e+01  3.39774121e+01  3.39774121e+01  3.45717848e+01
  1.32305089e+02  1.32305089e+02  1.32305089e+02  1.38651694e+02
  5.02708038e+02  1.87031853e+03  7.99997215e+03  4.77676226e+04]
E1 = -182.57174352581671  E_coul = 54.03327598487009
cycle= 5 E= -128.538467540947  delta_E= -5.12e-10  |g|= 2.93e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57174352581671  E_coul = 54.03327598487009
  HOMO = -0.849494165216977  LUMO = 0.657759503182731
  mo_energy =
[-3.27735942e+01 -1.93051905e+00 -8.49494165e-01 -8.49494165e-01
 -8.49494165e-01  6.57759503e-01  6.57759503e-01  6.57759503e-01
  1.18081566e+00  3.02165836e+00  3.02165836e+00  3.02165836e+00
  7.26253765e+00  1.02725547e+01  1.02725547e+01  1.02725547e+01
  3.39774146e+01  3.39774146e+01  3.39774146e+01  3.45717875e+01
  1.32305091e+02  1.32305091e+02  1.32305091e+02  1.38651696e+02
  5.02708040e+02  1.87031853e+03  7.99997215e+03  4.77676226e+04]
E1 = -182.5717356648603  E_coul = 54.03326812391333
Extra cycle  E= -128.538467540947  delta_E= -3.69e-13  |g|= 1.08e-06  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 342.56119939638626
E1 = -182.5717356648603  E_coul = 54.03326812391333
init E= -128.538467540947
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849494739216872  LUMO = 0.657759397793521
  mo_energy =
[-3.27735959e+01 -1.93051957e+00 -8.49494739e-01 -8.49494739e-01
 -8.49494739e-01  6.57759398e-01  6.57759398e-01  6.57759398e-01
  1.18081546e+00  3.02165796e+00  3.02165796e+00  3.02165796e+00
  7.26253701e+00  1.02725539e+01  1.02725539e+01  1.02725539e+01
  3.39774133e+01  3.39774133e+01  3.39774133e+01  3.45717862e+01
  1.32305090e+02  1.32305090e+02  1.32305090e+02  1.38651695e+02
  5.02708038e+02  1.87031853e+03  7.99997215e+03  4.77676226e+04]
E1 = -182.57173977946312  E_coul = 54.03327223851599
cycle= 1 E= -128.538467540947  delta_E= -1.42e-13  |g|= 5.7e-07  |ddm|= 3.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57173977946312  E_coul = 54.03327223851599
  HOMO = -0.849494451796924  LUMO = 0.65775945102047
  mo_energy =
[-3.27735950e+01 -1.93051925e+00 -8.49494452e-01 -8.49494452e-01
 -8.49494452e-01  6.57759451e-01  6.57759451e-01  6.57759451e-01
  1.18081559e+00  3.02165817e+00  3.02165817e+00  3.02165817e+00
  7.26253737e+00  1.02725543e+01  1.02725543e+01  1.02725543e+01
  3.39774140e+01  3.39774140e+01  3.39774140e+01  3.45717869e+01
  1.32305091e+02  1.32305091e+02  1.32305091e+02  1.38651695e+02
  5.02708039e+02  1.87031853e+03  7.99997215e+03  4.77676226e+04]
E1 = -182.57173767224165  E_coul = 54.03327013129444
Extra cycle  E= -128.538467540947  delta_E= -8.53e-14  |g|= 2.85e-07  |ddm|= 1.93e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270980e+02 2.35735890e+02
 7.64256531e+01 1.00352487e+01 2.70447033e+01 3.79894314e-01
 1.11249796e+00 2.87861187e+00 4.99868279e+00 1.45099629e+01
 5.46661827e+01 2.29936139e-01 1.84600689e+00 6.71432047e-01]
grad_E = [ 4.13453562e-11 -2.20356074e-09  5.35718071e-08 -8.33340869e-07
  6.09596615e-06  2.61105635e-05 -5.48796799e-06 -5.13753030e-05
 -1.35323775e-04  2.79383068e-05  1.67314213e-04 -3.82811483e-05
 -2.07036035e-04 -7.02397684e-05 -4.51211785e-04  5.37824221e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447327        1
[INPUT] 0    0    [1    /1   ]  833.270978502        1
[INPUT] 0    0    [1    /1   ]  235.735909492        1
[INPUT] 0    0    [1    /1   ]  76.4255159004        1
[INPUT] 0    0    [1    /1   ]  10.0353752437        1
[INPUT] 0    0    [1    /1   ]  27.0446087865        1
[INPUT] 0    0    [1    /1   ]  0.378578842199       1
[INPUT] 0    0    [1    /1   ]  1.10904743487        1
[INPUT] 0    0    [1    /1   ]  2.87958720427        1
[INPUT] 1    0    [1    /1   ]  4.99662144456        1
[INPUT] 1    0    [1    /1   ]  14.5097641081        1
[INPUT] 1    0    [1    /1   ]  54.6725131696        1
[INPUT] 1    0    [1    /1   ]  0.22989653645        1
[INPUT] 1    0    [1    /1   ]  1.84643418206        1
[INPUT] 1    0    [1    /1   ]  0.671637448841       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129928647, 1.0]], [0, [3661.454473268392, 1.0]], [0, [833.2709785017424, 1.0]], [0, [235.73590949210586, 1.0]], [0, [76.42551590040252, 1.0]], [0, [10.035375243658219, 1.0]], [0, [27.044608786478996, 1.0]], [0, [0.37857884219924975, 1.0]], [0, [1.1090474348714368, 1.0]], [0, [2.8795872042682196, 1.0]], [1, [4.996621444556791, 1.0]], [1, [14.509764108130408, 1.0]], [1, [54.672513169609225, 1.0]], [1, [0.2298965364499744, 1.0]], [1, [1.8464341820632677, 1.0]], [1, [0.6716374488408128, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447327]
bas 2, expnt(s) = [833.2709785]
bas 3, expnt(s) = [235.73590949]
bas 4, expnt(s) = [76.4255159]
bas 5, expnt(s) = [10.03537524]
bas 6, expnt(s) = [27.04460879]
bas 7, expnt(s) = [0.37857884]
bas 8, expnt(s) = [1.10904743]
bas 9, expnt(s) = [2.8795872]
bas 10, expnt(s) = [4.99662144]
bas 11, expnt(s) = [14.50976411]
bas 12, expnt(s) = [54.67251317]
bas 13, expnt(s) = [0.22989654]
bas 14, expnt(s) = [1.84643418]
bas 15, expnt(s) = [0.67163745]
CPU time:       113.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270979e+02 3.91836345e+02 2.35735909e+02 1.51996760e+02
 7.64255159e+01 6.53046052e+01 1.00353752e+01 1.42450913e+01
 2.70446088e+01 2.99623279e+01 3.78578842e-01 1.21936094e+00
 1.10904743e+00 2.73040843e+00 2.87958720e+00 5.58486527e+00
 4.99662144e+00 2.17936490e+01 1.45097641e+01 8.26151760e+01
 5.46725132e+01 4.33706259e+02 2.29896536e-01 4.64408252e-01
 1.84643418e+00 6.27916191e+00 6.71637449e-01 1.77379335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999813379665591
cond(S) = 341.6126588260432
E1 = -183.58643330760012  E_coul = 55.08011230918413
init E= -128.506320998416
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950622352617  LUMO = 0.671368309240638
  mo_energy =
[-3.25551299e+01 -1.85258340e+00 -7.74950622e-01 -7.74950622e-01
 -7.74950622e-01  6.71368309e-01  6.71368309e-01  6.71368309e-01
  1.20693546e+00  3.07510058e+00  3.07510058e+00  3.07510058e+00
  7.33749180e+00  1.03806828e+01  1.03806828e+01  1.03806828e+01
  3.41418841e+01  3.41418841e+01  3.41418841e+01  3.47219536e+01
  1.32528503e+02  1.32528503e+02  1.32528503e+02  1.38852246e+02
  5.02943221e+02  1.87058577e+03  8.00026742e+03  4.77679376e+04]
E1 = -182.05806795410732  E_coul = 53.523223469848034
cycle= 1 E= -128.534844484259  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546775
diis-c [-0.29896321  1.        ]
  HOMO = -0.885591720833053  LUMO = 0.651069339219579
  mo_energy =
[-3.28831664e+01 -1.96861810e+00 -8.85591721e-01 -8.85591721e-01
 -8.85591721e-01  6.51069339e-01  6.51069339e-01  6.51069339e-01
  1.16074226e+00  2.99706957e+00  2.99706957e+00  2.99706957e+00
  7.20328230e+00  1.02198136e+01  1.02198136e+01  1.02198136e+01
  3.38892518e+01  3.38892518e+01  3.38892518e+01  3.44710527e+01
  1.32199989e+02  1.32199989e+02  1.32199989e+02  1.38529535e+02
  5.02576515e+02  1.87018311e+03  7.99983578e+03  4.77674871e+04]
E1 = -182.83584320194043  E_coul = 54.29833433318105
cycle= 2 E= -128.537508868759  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27936
diis-c [-6.40583033e-04  3.37470515e-01  6.62529485e-01]
  HOMO = -0.849239446377367  LUMO = 0.657735794080468
  mo_energy =
[-3.27731410e+01 -1.93031292e+00 -8.49239446e-01 -8.49239446e-01
 -8.49239446e-01  6.57735794e-01  6.57735794e-01  6.57735794e-01
  1.17560272e+00  3.02237225e+00  3.02237225e+00  3.02237225e+00
  7.24740256e+00  1.02729751e+01  1.02729751e+01  1.02729751e+01
  3.39739194e+01  3.39739194e+01  3.39739194e+01  3.45553670e+01
  1.32309473e+02  1.32309473e+02  1.32309473e+02  1.38637536e+02
  5.02695426e+02  1.87030733e+03  7.99996247e+03  4.77676147e+04]
E1 = -182.57117865406826  E_coul = 54.03271032789359
cycle= 3 E= -128.538468326175  delta_E= -0.000959  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999885
diis-c [-1.07560342e-07 -2.06376515e-03 -6.56242766e-04  1.00272001e+00]
  HOMO = -0.84946817721791  LUMO = 0.657714822989318
  mo_energy =
[-3.27735412e+01 -1.93049330e+00 -8.49468177e-01 -8.49468177e-01
 -8.49468177e-01  6.57714823e-01  6.57714823e-01  6.57714823e-01
  1.17553419e+00  3.02224924e+00  3.02224924e+00  3.02224924e+00
  7.24721364e+00  1.02727472e+01  1.02727472e+01  1.02727472e+01
  3.39735991e+01  3.39735991e+01  3.39735991e+01  3.45550581e+01
  1.32309060e+02  1.32309060e+02  1.32309060e+02  1.38637134e+02
  5.02694915e+02  1.87030670e+03  7.99996174e+03  4.77676140e+04]
E1 = -182.57149655051444  E_coul = 54.033028206932954
cycle= 4 E= -128.538468343581  delta_E= -1.74e-08  |g|= 7.37e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184749
diis-c [-7.06463877e-10  1.32063107e-04  5.11148464e-04 -1.41438291e-01
  1.14079508e+00]
  HOMO = -0.849508161180714  LUMO = 0.657705073050918
  mo_energy =
[-3.27736110e+01 -1.93052812e+00 -8.49508161e-01 -8.49508161e-01
 -8.49508161e-01  6.57705073e-01  6.57705073e-01  6.57705073e-01
  1.17551432e+00  3.02221707e+00  3.02221707e+00  3.02221707e+00
  7.24716978e+00  1.02726961e+01  1.02726961e+01  1.02726961e+01
  3.39735357e+01  3.39735357e+01  3.39735357e+01  3.45549956e+01
  1.32308990e+02  1.32308990e+02  1.32308990e+02  1.38637065e+02
  5.02694839e+02  1.87030662e+03  7.99996166e+03  4.77676139e+04]
E1 = -182.57162602632422  E_coul = 54.0331576822275
cycle= 5 E= -128.538468344097  delta_E= -5.15e-10  |g|= 2.97e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57162602632422  E_coul = 54.0331576822275
  HOMO = -0.849506936614278  LUMO = 0.657705303967915
  mo_energy =
[-3.27736081e+01 -1.93052640e+00 -8.49506937e-01 -8.49506937e-01
 -8.49506937e-01  6.57705304e-01  6.57705304e-01  6.57705304e-01
  1.17551508e+00  3.02221797e+00  3.02221797e+00  3.02221797e+00
  7.24717158e+00  1.02726979e+01  1.02726979e+01  1.02726979e+01
  3.39735383e+01  3.39735383e+01  3.39735383e+01  3.45549983e+01
  1.32308993e+02  1.32308993e+02  1.32308993e+02  1.38637067e+02
  5.02694842e+02  1.87030662e+03  7.99996166e+03  4.77676139e+04]
E1 = -182.5716180965752  E_coul = 54.033149752477634
Extra cycle  E= -128.538468344098  delta_E= -8.53e-13  |g|= 1.09e-06  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270979e+02 2.35735909e+02
 7.64255159e+01 1.00353752e+01 2.70446088e+01 3.78578842e-01
 1.10904743e+00 2.87958720e+00 4.99662144e+00 1.45097641e+01
 5.46725132e+01 2.29896536e-01 1.84643418e+00 6.71637449e-01]
E = -128.53846834409757
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447327        1
[INPUT] 0    0    [1    /1   ]  833.270978502        1
[INPUT] 0    0    [1    /1   ]  235.735909492        1
[INPUT] 0    0    [1    /1   ]  76.4255159004        1
[INPUT] 0    0    [1    /1   ]  10.0353752437        1
[INPUT] 0    0    [1    /1   ]  27.0446087865        1
[INPUT] 0    0    [1    /1   ]  0.378578842199       1
[INPUT] 0    0    [1    /1   ]  1.10904743487        1
[INPUT] 0    0    [1    /1   ]  2.87958720427        1
[INPUT] 1    0    [1    /1   ]  4.99662144456        1
[INPUT] 1    0    [1    /1   ]  14.5097641081        1
[INPUT] 1    0    [1    /1   ]  54.6725131696        1
[INPUT] 1    0    [1    /1   ]  0.22989653645        1
[INPUT] 1    0    [1    /1   ]  1.84643418206        1
[INPUT] 1    0    [1    /1   ]  0.671637448841       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129928647, 1.0]], [0, [3661.454473268392, 1.0]], [0, [833.2709785017424, 1.0]], [0, [235.73590949210586, 1.0]], [0, [76.42551590040252, 1.0]], [0, [10.035375243658219, 1.0]], [0, [27.044608786478996, 1.0]], [0, [0.37857884219924975, 1.0]], [0, [1.1090474348714368, 1.0]], [0, [2.8795872042682196, 1.0]], [1, [4.996621444556791, 1.0]], [1, [14.509764108130408, 1.0]], [1, [54.672513169609225, 1.0]], [1, [0.2298965364499744, 1.0]], [1, [1.8464341820632677, 1.0]], [1, [0.6716374488408128, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447327]
bas 2, expnt(s) = [833.2709785]
bas 3, expnt(s) = [235.73590949]
bas 4, expnt(s) = [76.4255159]
bas 5, expnt(s) = [10.03537524]
bas 6, expnt(s) = [27.04460879]
bas 7, expnt(s) = [0.37857884]
bas 8, expnt(s) = [1.10904743]
bas 9, expnt(s) = [2.8795872]
bas 10, expnt(s) = [4.99662144]
bas 11, expnt(s) = [14.50976411]
bas 12, expnt(s) = [54.67251317]
bas 13, expnt(s) = [0.22989654]
bas 14, expnt(s) = [1.84643418]
bas 15, expnt(s) = [0.67163745]
CPU time:       113.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270979e+02 3.91836345e+02 2.35735909e+02 1.51996760e+02
 7.64255159e+01 6.53046052e+01 1.00353752e+01 1.42450913e+01
 2.70446088e+01 2.99623279e+01 3.78578842e-01 1.21936094e+00
 1.10904743e+00 2.73040843e+00 2.87958720e+00 5.58486527e+00
 4.99662144e+00 2.17936490e+01 1.45097641e+01 8.26151760e+01
 5.46725132e+01 4.33706259e+02 2.29896536e-01 4.64408252e-01
 1.84643418e+00 6.27916191e+00 6.71637449e-01 1.77379335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999813379665591
cond(S) = 341.6126588260432
E1 = -183.58643330760012  E_coul = 55.08011230918413
init E= -128.506320998416
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950622352617  LUMO = 0.671368309240638
  mo_energy =
[-3.25551299e+01 -1.85258340e+00 -7.74950622e-01 -7.74950622e-01
 -7.74950622e-01  6.71368309e-01  6.71368309e-01  6.71368309e-01
  1.20693546e+00  3.07510058e+00  3.07510058e+00  3.07510058e+00
  7.33749180e+00  1.03806828e+01  1.03806828e+01  1.03806828e+01
  3.41418841e+01  3.41418841e+01  3.41418841e+01  3.47219536e+01
  1.32528503e+02  1.32528503e+02  1.32528503e+02  1.38852246e+02
  5.02943221e+02  1.87058577e+03  8.00026742e+03  4.77679376e+04]
E1 = -182.05806795410732  E_coul = 53.523223469848034
cycle= 1 E= -128.534844484259  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.546775
diis-c [-0.29896321  1.        ]
  HOMO = -0.885591720833053  LUMO = 0.651069339219579
  mo_energy =
[-3.28831664e+01 -1.96861810e+00 -8.85591721e-01 -8.85591721e-01
 -8.85591721e-01  6.51069339e-01  6.51069339e-01  6.51069339e-01
  1.16074226e+00  2.99706957e+00  2.99706957e+00  2.99706957e+00
  7.20328230e+00  1.02198136e+01  1.02198136e+01  1.02198136e+01
  3.38892518e+01  3.38892518e+01  3.38892518e+01  3.44710527e+01
  1.32199989e+02  1.32199989e+02  1.32199989e+02  1.38529535e+02
  5.02576515e+02  1.87018311e+03  7.99983578e+03  4.77674871e+04]
E1 = -182.83584320194043  E_coul = 54.29833433318105
cycle= 2 E= -128.537508868759  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27936
diis-c [-6.40583033e-04  3.37470515e-01  6.62529485e-01]
  HOMO = -0.849239446377367  LUMO = 0.657735794080468
  mo_energy =
[-3.27731410e+01 -1.93031292e+00 -8.49239446e-01 -8.49239446e-01
 -8.49239446e-01  6.57735794e-01  6.57735794e-01  6.57735794e-01
  1.17560272e+00  3.02237225e+00  3.02237225e+00  3.02237225e+00
  7.24740256e+00  1.02729751e+01  1.02729751e+01  1.02729751e+01
  3.39739194e+01  3.39739194e+01  3.39739194e+01  3.45553670e+01
  1.32309473e+02  1.32309473e+02  1.32309473e+02  1.38637536e+02
  5.02695426e+02  1.87030733e+03  7.99996247e+03  4.77676147e+04]
E1 = -182.57117865406826  E_coul = 54.03271032789359
cycle= 3 E= -128.538468326175  delta_E= -0.000959  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999885
diis-c [-1.07560342e-07 -2.06376515e-03 -6.56242766e-04  1.00272001e+00]
  HOMO = -0.84946817721791  LUMO = 0.657714822989318
  mo_energy =
[-3.27735412e+01 -1.93049330e+00 -8.49468177e-01 -8.49468177e-01
 -8.49468177e-01  6.57714823e-01  6.57714823e-01  6.57714823e-01
  1.17553419e+00  3.02224924e+00  3.02224924e+00  3.02224924e+00
  7.24721364e+00  1.02727472e+01  1.02727472e+01  1.02727472e+01
  3.39735991e+01  3.39735991e+01  3.39735991e+01  3.45550581e+01
  1.32309060e+02  1.32309060e+02  1.32309060e+02  1.38637134e+02
  5.02694915e+02  1.87030670e+03  7.99996174e+03  4.77676140e+04]
E1 = -182.57149655051444  E_coul = 54.033028206932954
cycle= 4 E= -128.538468343581  delta_E= -1.74e-08  |g|= 7.37e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184749
diis-c [-7.06463877e-10  1.32063107e-04  5.11148464e-04 -1.41438291e-01
  1.14079508e+00]
  HOMO = -0.849508161180714  LUMO = 0.657705073050918
  mo_energy =
[-3.27736110e+01 -1.93052812e+00 -8.49508161e-01 -8.49508161e-01
 -8.49508161e-01  6.57705073e-01  6.57705073e-01  6.57705073e-01
  1.17551432e+00  3.02221707e+00  3.02221707e+00  3.02221707e+00
  7.24716978e+00  1.02726961e+01  1.02726961e+01  1.02726961e+01
  3.39735357e+01  3.39735357e+01  3.39735357e+01  3.45549956e+01
  1.32308990e+02  1.32308990e+02  1.32308990e+02  1.38637065e+02
  5.02694839e+02  1.87030662e+03  7.99996166e+03  4.77676139e+04]
E1 = -182.57162602632422  E_coul = 54.0331576822275
cycle= 5 E= -128.538468344097  delta_E= -5.15e-10  |g|= 2.97e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57162602632422  E_coul = 54.0331576822275
  HOMO = -0.849506936614278  LUMO = 0.657705303967915
  mo_energy =
[-3.27736081e+01 -1.93052640e+00 -8.49506937e-01 -8.49506937e-01
 -8.49506937e-01  6.57705304e-01  6.57705304e-01  6.57705304e-01
  1.17551508e+00  3.02221797e+00  3.02221797e+00  3.02221797e+00
  7.24717158e+00  1.02726979e+01  1.02726979e+01  1.02726979e+01
  3.39735383e+01  3.39735383e+01  3.39735383e+01  3.45549983e+01
  1.32308993e+02  1.32308993e+02  1.32308993e+02  1.38637067e+02
  5.02694842e+02  1.87030662e+03  7.99996166e+03  4.77676139e+04]
E1 = -182.5716180965752  E_coul = 54.033149752477634
Extra cycle  E= -128.538468344098  delta_E= -8.53e-13  |g|= 1.09e-06  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.6126588260432
E1 = -182.5716180965752  E_coul = 54.033149752477634
init E= -128.538468344098
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.849507515317915  LUMO = 0.657705198027593
  mo_energy =
[-3.27736098e+01 -1.93052692e+00 -8.49507515e-01 -8.49507515e-01
 -8.49507515e-01  6.57705198e-01  6.57705198e-01  6.57705198e-01
  1.17551488e+00  3.02221757e+00  3.02221757e+00  3.02221757e+00
  7.24717093e+00  1.02726971e+01  1.02726971e+01  1.02726971e+01
  3.39735370e+01  3.39735370e+01  3.39735370e+01  3.45549970e+01
  1.32308991e+02  1.32308991e+02  1.32308991e+02  1.38637066e+02
  5.02694840e+02  1.87030662e+03  7.99996166e+03  4.77676139e+04]
E1 = -182.5716222589918  E_coul = 54.03315391489411
cycle= 1 E= -128.538468344098  delta_E= -1.14e-13  |g|= 5.76e-07  |ddm|= 3.28e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5716222589918  E_coul = 54.03315391489411
  HOMO = -0.84950722451663  LUMO = 0.657705251937294
  mo_energy =
[-3.27736089e+01 -1.93052660e+00 -8.49507225e-01 -8.49507225e-01
 -8.49507225e-01  6.57705252e-01  6.57705252e-01  6.57705252e-01
  1.17551501e+00  3.02221778e+00  3.02221778e+00  3.02221778e+00
  7.24717129e+00  1.02726975e+01  1.02726975e+01  1.02726975e+01
  3.39735376e+01  3.39735376e+01  3.39735376e+01  3.45549977e+01
  1.32308992e+02  1.32308992e+02  1.32308992e+02  1.38637066e+02
  5.02694841e+02  1.87030662e+03  7.99996166e+03  4.77676139e+04]
E1 = -182.57162012898536  E_coul = 54.03315178488771
Extra cycle  E= -128.538468344098  delta_E= 2.84e-14  |g|= 2.88e-07  |ddm|= 1.96e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270979e+02 2.35735909e+02
 7.64255159e+01 1.00353752e+01 2.70446088e+01 3.78578842e-01
 1.10904743e+00 2.87958720e+00 4.99662144e+00 1.45097641e+01
 5.46725132e+01 2.29896536e-01 1.84643418e+00 6.71637449e-01]
grad_E = [ 4.72021165e-11 -2.51279987e-09  5.98424659e-08 -9.11876336e-07
  6.77357466e-06  4.10396660e-05 -9.65593685e-06 -9.57642585e-05
 -2.65314624e-04  5.94400939e-05  9.67094284e-05 -2.44214564e-05
 -2.07827287e-04 -1.19696126e-04 -3.02494491e-04  4.30728629e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447329        1
[INPUT] 0    0    [1    /1   ]  833.270977946        1
[INPUT] 0    0    [1    /1   ]  235.73591885         1
[INPUT] 0    0    [1    /1   ]  76.4254485204        1
[INPUT] 0    0    [1    /1   ]  10.0353831472        1
[INPUT] 0    0    [1    /1   ]  27.0445842752        1
[INPUT] 0    0    [1    /1   ]  0.378045145217       1
[INPUT] 0    0    [1    /1   ]  1.10767928891        1
[INPUT] 0    0    [1    /1   ]  2.88000483527        1
[INPUT] 1    0    [1    /1   ]  4.99349954662        1
[INPUT] 1    0    [1    /1   ]  14.5060320051        1
[INPUT] 1    0    [1    /1   ]  54.6762541568        1
[INPUT] 1    0    [1    /1   ]  0.229668752622       1
[INPUT] 1    0    [1    /1   ]  1.84657868156        1
[INPUT] 1    0    [1    /1   ]  0.671373755674       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129928254, 1.0]], [0, [3661.45447328952, 1.0]], [0, [833.2709779459468, 1.0]], [0, [235.73591885015549, 1.0]], [0, [76.42544852037342, 1.0]], [0, [10.035383147238177, 1.0]], [0, [27.04458427522685, 1.0]], [0, [0.37804514521670346, 1.0]], [0, [1.1076792889070721, 1.0]], [0, [2.8800048352696224, 1.0]], [1, [4.993499546621677, 1.0]], [1, [14.506032005061236, 1.0]], [1, [54.67625415681708, 1.0]], [1, [0.22966875262218503, 1.0]], [1, [1.846578681559436, 1.0]], [1, [0.6713737556742533, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447329]
bas 2, expnt(s) = [833.27097795]
bas 3, expnt(s) = [235.73591885]
bas 4, expnt(s) = [76.42544852]
bas 5, expnt(s) = [10.03538315]
bas 6, expnt(s) = [27.04458428]
bas 7, expnt(s) = [0.37804515]
bas 8, expnt(s) = [1.10767929]
bas 9, expnt(s) = [2.88000484]
bas 10, expnt(s) = [4.99349955]
bas 11, expnt(s) = [14.50603201]
bas 12, expnt(s) = [54.67625416]
bas 13, expnt(s) = [0.22966875]
bas 14, expnt(s) = [1.84657868]
bas 15, expnt(s) = [0.67137376]
CPU time:       117.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270978e+02 3.91836345e+02 2.35735919e+02 1.51996765e+02
 7.64254485e+01 6.53045621e+01 1.00353831e+01 1.42450997e+01
 2.70445843e+01 2.99623075e+01 3.78045145e-01 1.21807148e+00
 1.10767929e+00 2.72788182e+00 2.88000484e+00 5.58547274e+00
 4.99349955e+00 2.17766294e+01 1.45060320e+01 8.25886147e+01
 5.46762542e+01 4.33743355e+02 2.29668753e-01 4.63833148e-01
 1.84657868e+00 6.27977617e+00 6.71373756e-01 1.77292287e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999814254354373
cond(S) = 341.2364219009865
E1 = -183.58643720382113  E_coul = 55.08011620768752
init E= -128.506320996134
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950807744555  LUMO = 0.670696535091552
  mo_energy =
[-3.25551283e+01 -1.85258316e+00 -7.74950808e-01 -7.74950808e-01
 -7.74950808e-01  6.70696535e-01  6.70696535e-01  6.70696535e-01
  1.20476114e+00  3.07367499e+00  3.07367499e+00  3.07367499e+00
  7.33136841e+00  1.03769996e+01  1.03769996e+01  1.03769996e+01
  3.41281431e+01  3.41281431e+01  3.41281431e+01  3.47152963e+01
  1.32511741e+02  1.32511741e+02  1.32511741e+02  1.38846404e+02
  5.02937922e+02  1.87058098e+03  8.00026319e+03  4.77679341e+04]
E1 = -182.0578985079123  E_coul = 53.523054222022736
cycle= 1 E= -128.53484428589  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546759
diis-c [-0.29894552  1.        ]
  HOMO = -0.88560660144029  LUMO = 0.650417256101932
  mo_energy =
[-3.28831932e+01 -1.96863169e+00 -8.85606601e-01 -8.85606601e-01
 -8.85606601e-01  6.50417256e-01  6.50417256e-01  6.50417256e-01
  1.15862463e+00  2.99564362e+00  2.99564362e+00  2.99564362e+00
  7.19716257e+00  1.02161425e+01  1.02161425e+01  1.02161425e+01
  3.38755116e+01  3.38755116e+01  3.38755116e+01  3.44643670e+01
  1.32183195e+02  1.32183195e+02  1.32183195e+02  1.38523663e+02
  5.02571189e+02  1.87017829e+03  7.99983152e+03  4.77674836e+04]
E1 = -182.83577777900757  E_coul = 54.29826870543543
cycle= 2 E= -128.537509073572  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279364
diis-c [-6.40750188e-04  3.37480544e-01  6.62519456e-01]
  HOMO = -0.849249755604739  LUMO = 0.657077572842623
  mo_energy =
[-3.27731558e+01 -1.93032172e+00 -8.49249756e-01 -8.49249756e-01
 -8.49249756e-01  6.57077573e-01  6.57077573e-01  6.57077573e-01
  1.17346667e+00  3.02094605e+00  3.02094605e+00  3.02094605e+00
  7.24128131e+00  1.02693001e+01  1.02693001e+01  1.02693001e+01
  3.39601803e+01  3.39601803e+01  3.39601803e+01  3.45486930e+01
  1.32292692e+02  1.32292692e+02  1.32292692e+02  1.38631677e+02
  5.02690113e+02  1.87030252e+03  7.99995823e+03  4.77676112e+04]
E1 = -182.57107071929153  E_coul = 54.03260192300035
cycle= 3 E= -128.538468796291  delta_E= -0.00096  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010001
diis-c [-1.07825339e-07 -2.06417934e-03 -6.56616198e-04  1.00272080e+00]
  HOMO = -0.849478513591778  LUMO = 0.657056689224907
  mo_energy =
[-3.27735559e+01 -1.93050194e+00 -8.49478514e-01 -8.49478514e-01
 -8.49478514e-01  6.57056689e-01  6.57056689e-01  6.57056689e-01
  1.17339836e+00  3.02082312e+00  3.02082312e+00  3.02082312e+00
  7.24109248e+00  1.02690722e+01  1.02690722e+01  1.02690722e+01
  3.39598601e+01  3.39598601e+01  3.39598601e+01  3.45483842e+01
  1.32292280e+02  1.32292280e+02  1.32292280e+02  1.38631275e+02
  5.02689601e+02  1.87030189e+03  7.99995751e+03  4.77676104e+04]
E1 = -182.57138866768508  E_coul = 54.0329198539886
cycle= 4 E= -128.538468813696  delta_E= -1.74e-08  |g|= 7.37e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184928
diis-c [-7.10250748e-10  1.32597363e-04  5.11899908e-04 -1.41744738e-01
  1.14110024e+00]
  HOMO = -0.849518516661551  LUMO = 0.657046951113841
  mo_energy =
[-3.27736257e+01 -1.93053673e+00 -8.49518517e-01 -8.49518517e-01
 -8.49518517e-01  6.57046951e-01  6.57046951e-01  6.57046951e-01
  1.17337854e+00  3.02079094e+00  3.02079094e+00  3.02079094e+00
  7.24104864e+00  1.02690211e+01  1.02690211e+01  1.02690211e+01
  3.39597966e+01  3.39597966e+01  3.39597966e+01  3.45483217e+01
  1.32292210e+02  1.32292210e+02  1.32292210e+02  1.38631206e+02
  5.02689526e+02  1.87030181e+03  7.99995742e+03  4.77676104e+04]
E1 = -182.5715183040179  E_coul = 54.03304948980506
cycle= 5 E= -128.538468814213  delta_E= -5.16e-10  |g|= 2.99e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5715183040179  E_coul = 54.03304948980506
  HOMO = -0.8495172825756  LUMO = 0.657047184307756
  mo_energy =
[-3.27736228e+01 -1.93053499e+00 -8.49517283e-01 -8.49517283e-01
 -8.49517283e-01  6.57047184e-01  6.57047184e-01  6.57047184e-01
  1.17337930e+00  3.02079185e+00  3.02079185e+00  3.02079185e+00
  7.24105045e+00  1.02690229e+01  1.02690229e+01  1.02690229e+01
  3.39597992e+01  3.39597992e+01  3.39597992e+01  3.45483244e+01
  1.32292212e+02  1.32292212e+02  1.32292212e+02  1.38631208e+02
  5.02689528e+02  1.87030181e+03  7.99995742e+03  4.77676104e+04]
E1 = -182.57151034917288  E_coul = 54.03304153495967
Extra cycle  E= -128.538468814213  delta_E= -3.69e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270978e+02 2.35735919e+02
 7.64254485e+01 1.00353831e+01 2.70445843e+01 3.78045145e-01
 1.10767929e+00 2.88000484e+00 4.99349955e+00 1.45060320e+01
 5.46762542e+01 2.29668753e-01 1.84657868e+00 6.71373756e-01]
E = -128.53846881421322
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447329        1
[INPUT] 0    0    [1    /1   ]  833.270977946        1
[INPUT] 0    0    [1    /1   ]  235.73591885         1
[INPUT] 0    0    [1    /1   ]  76.4254485204        1
[INPUT] 0    0    [1    /1   ]  10.0353831472        1
[INPUT] 0    0    [1    /1   ]  27.0445842752        1
[INPUT] 0    0    [1    /1   ]  0.378045145217       1
[INPUT] 0    0    [1    /1   ]  1.10767928891        1
[INPUT] 0    0    [1    /1   ]  2.88000483527        1
[INPUT] 1    0    [1    /1   ]  4.99349954662        1
[INPUT] 1    0    [1    /1   ]  14.5060320051        1
[INPUT] 1    0    [1    /1   ]  54.6762541568        1
[INPUT] 1    0    [1    /1   ]  0.229668752622       1
[INPUT] 1    0    [1    /1   ]  1.84657868156        1
[INPUT] 1    0    [1    /1   ]  0.671373755674       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129928254, 1.0]], [0, [3661.45447328952, 1.0]], [0, [833.2709779459468, 1.0]], [0, [235.73591885015549, 1.0]], [0, [76.42544852037342, 1.0]], [0, [10.035383147238177, 1.0]], [0, [27.04458427522685, 1.0]], [0, [0.37804514521670346, 1.0]], [0, [1.1076792889070721, 1.0]], [0, [2.8800048352696224, 1.0]], [1, [4.993499546621677, 1.0]], [1, [14.506032005061236, 1.0]], [1, [54.67625415681708, 1.0]], [1, [0.22966875262218503, 1.0]], [1, [1.846578681559436, 1.0]], [1, [0.6713737556742533, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447329]
bas 2, expnt(s) = [833.27097795]
bas 3, expnt(s) = [235.73591885]
bas 4, expnt(s) = [76.42544852]
bas 5, expnt(s) = [10.03538315]
bas 6, expnt(s) = [27.04458428]
bas 7, expnt(s) = [0.37804515]
bas 8, expnt(s) = [1.10767929]
bas 9, expnt(s) = [2.88000484]
bas 10, expnt(s) = [4.99349955]
bas 11, expnt(s) = [14.50603201]
bas 12, expnt(s) = [54.67625416]
bas 13, expnt(s) = [0.22966875]
bas 14, expnt(s) = [1.84657868]
bas 15, expnt(s) = [0.67137376]
CPU time:       117.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270978e+02 3.91836345e+02 2.35735919e+02 1.51996765e+02
 7.64254485e+01 6.53045621e+01 1.00353831e+01 1.42450997e+01
 2.70445843e+01 2.99623075e+01 3.78045145e-01 1.21807148e+00
 1.10767929e+00 2.72788182e+00 2.88000484e+00 5.58547274e+00
 4.99349955e+00 2.17766294e+01 1.45060320e+01 8.25886147e+01
 5.46762542e+01 4.33743355e+02 2.29668753e-01 4.63833148e-01
 1.84657868e+00 6.27977617e+00 6.71373756e-01 1.77292287e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999814254354373
cond(S) = 341.2364219009865
E1 = -183.58643720382113  E_coul = 55.08011620768752
init E= -128.506320996134
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950807744555  LUMO = 0.670696535091552
  mo_energy =
[-3.25551283e+01 -1.85258316e+00 -7.74950808e-01 -7.74950808e-01
 -7.74950808e-01  6.70696535e-01  6.70696535e-01  6.70696535e-01
  1.20476114e+00  3.07367499e+00  3.07367499e+00  3.07367499e+00
  7.33136841e+00  1.03769996e+01  1.03769996e+01  1.03769996e+01
  3.41281431e+01  3.41281431e+01  3.41281431e+01  3.47152963e+01
  1.32511741e+02  1.32511741e+02  1.32511741e+02  1.38846404e+02
  5.02937922e+02  1.87058098e+03  8.00026319e+03  4.77679341e+04]
E1 = -182.0578985079123  E_coul = 53.523054222022736
cycle= 1 E= -128.53484428589  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546759
diis-c [-0.29894552  1.        ]
  HOMO = -0.88560660144029  LUMO = 0.650417256101932
  mo_energy =
[-3.28831932e+01 -1.96863169e+00 -8.85606601e-01 -8.85606601e-01
 -8.85606601e-01  6.50417256e-01  6.50417256e-01  6.50417256e-01
  1.15862463e+00  2.99564362e+00  2.99564362e+00  2.99564362e+00
  7.19716257e+00  1.02161425e+01  1.02161425e+01  1.02161425e+01
  3.38755116e+01  3.38755116e+01  3.38755116e+01  3.44643670e+01
  1.32183195e+02  1.32183195e+02  1.32183195e+02  1.38523663e+02
  5.02571189e+02  1.87017829e+03  7.99983152e+03  4.77674836e+04]
E1 = -182.83577777900757  E_coul = 54.29826870543543
cycle= 2 E= -128.537509073572  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279364
diis-c [-6.40750188e-04  3.37480544e-01  6.62519456e-01]
  HOMO = -0.849249755604739  LUMO = 0.657077572842623
  mo_energy =
[-3.27731558e+01 -1.93032172e+00 -8.49249756e-01 -8.49249756e-01
 -8.49249756e-01  6.57077573e-01  6.57077573e-01  6.57077573e-01
  1.17346667e+00  3.02094605e+00  3.02094605e+00  3.02094605e+00
  7.24128131e+00  1.02693001e+01  1.02693001e+01  1.02693001e+01
  3.39601803e+01  3.39601803e+01  3.39601803e+01  3.45486930e+01
  1.32292692e+02  1.32292692e+02  1.32292692e+02  1.38631677e+02
  5.02690113e+02  1.87030252e+03  7.99995823e+03  4.77676112e+04]
E1 = -182.57107071929153  E_coul = 54.03260192300035
cycle= 3 E= -128.538468796291  delta_E= -0.00096  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010001
diis-c [-1.07825339e-07 -2.06417934e-03 -6.56616198e-04  1.00272080e+00]
  HOMO = -0.849478513591778  LUMO = 0.657056689224907
  mo_energy =
[-3.27735559e+01 -1.93050194e+00 -8.49478514e-01 -8.49478514e-01
 -8.49478514e-01  6.57056689e-01  6.57056689e-01  6.57056689e-01
  1.17339836e+00  3.02082312e+00  3.02082312e+00  3.02082312e+00
  7.24109248e+00  1.02690722e+01  1.02690722e+01  1.02690722e+01
  3.39598601e+01  3.39598601e+01  3.39598601e+01  3.45483842e+01
  1.32292280e+02  1.32292280e+02  1.32292280e+02  1.38631275e+02
  5.02689601e+02  1.87030189e+03  7.99995751e+03  4.77676104e+04]
E1 = -182.57138866768508  E_coul = 54.0329198539886
cycle= 4 E= -128.538468813696  delta_E= -1.74e-08  |g|= 7.37e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184928
diis-c [-7.10250748e-10  1.32597363e-04  5.11899908e-04 -1.41744738e-01
  1.14110024e+00]
  HOMO = -0.849518516661551  LUMO = 0.657046951113841
  mo_energy =
[-3.27736257e+01 -1.93053673e+00 -8.49518517e-01 -8.49518517e-01
 -8.49518517e-01  6.57046951e-01  6.57046951e-01  6.57046951e-01
  1.17337854e+00  3.02079094e+00  3.02079094e+00  3.02079094e+00
  7.24104864e+00  1.02690211e+01  1.02690211e+01  1.02690211e+01
  3.39597966e+01  3.39597966e+01  3.39597966e+01  3.45483217e+01
  1.32292210e+02  1.32292210e+02  1.32292210e+02  1.38631206e+02
  5.02689526e+02  1.87030181e+03  7.99995742e+03  4.77676104e+04]
E1 = -182.5715183040179  E_coul = 54.03304948980506
cycle= 5 E= -128.538468814213  delta_E= -5.16e-10  |g|= 2.99e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5715183040179  E_coul = 54.03304948980506
  HOMO = -0.8495172825756  LUMO = 0.657047184307756
  mo_energy =
[-3.27736228e+01 -1.93053499e+00 -8.49517283e-01 -8.49517283e-01
 -8.49517283e-01  6.57047184e-01  6.57047184e-01  6.57047184e-01
  1.17337930e+00  3.02079185e+00  3.02079185e+00  3.02079185e+00
  7.24105045e+00  1.02690229e+01  1.02690229e+01  1.02690229e+01
  3.39597992e+01  3.39597992e+01  3.39597992e+01  3.45483244e+01
  1.32292212e+02  1.32292212e+02  1.32292212e+02  1.38631208e+02
  5.02689528e+02  1.87030181e+03  7.99995742e+03  4.77676104e+04]
E1 = -182.57151034917288  E_coul = 54.03304153495967
Extra cycle  E= -128.538468814213  delta_E= -3.69e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.2364219009865
E1 = -182.57151034917288  E_coul = 54.03304153495967
init E= -128.538468814213
    CPU time for initialize scf      0.29 sec, wall time      0.30 sec
  HOMO = -0.849517863027138  LUMO = 0.657047078284343
  mo_energy =
[-3.27736245e+01 -1.93053552e+00 -8.49517863e-01 -8.49517863e-01
 -8.49517863e-01  6.57047078e-01  6.57047078e-01  6.57047078e-01
  1.17337911e+00  3.02079145e+00  3.02079145e+00  3.02079145e+00
  7.24104980e+00  1.02690221e+01  1.02690221e+01  1.02690221e+01
  3.39597979e+01  3.39597979e+01  3.39597979e+01  3.45483231e+01
  1.32292211e+02  1.32292211e+02  1.32292211e+02  1.38631207e+02
  5.02689526e+02  1.87030181e+03  7.99995742e+03  4.77676104e+04]
E1 = -182.5715145297405  E_coul = 54.0330457155273
cycle= 1 E= -128.538468814213  delta_E=    0  |g|= 5.79e-07  |ddm|= 3.3e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5715145297405  E_coul = 54.0330457155273
  HOMO = -0.84951757094953  LUMO = 0.657047132394163
  mo_energy =
[-3.27736236e+01 -1.93053519e+00 -8.49517571e-01 -8.49517571e-01
 -8.49517571e-01  6.57047132e-01  6.57047132e-01  6.57047132e-01
  1.17337924e+00  3.02079166e+00  3.02079166e+00  3.02079166e+00
  7.24105016e+00  1.02690225e+01  1.02690225e+01  1.02690225e+01
  3.39597986e+01  3.39597986e+01  3.39597986e+01  3.45483238e+01
  1.32292212e+02  1.32292212e+02  1.32292212e+02  1.38631207e+02
  5.02689527e+02  1.87030181e+03  7.99995742e+03  4.77676104e+04]
E1 = -182.57151239109058  E_coul = 54.03304357687725
Extra cycle  E= -128.538468814213  delta_E= -1.14e-13  |g|= 2.9e-07  |ddm|= 1.97e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270978e+02 2.35735919e+02
 7.64254485e+01 1.00353831e+01 2.70445843e+01 3.78045145e-01
 1.10767929e+00 2.88000484e+00 4.99349955e+00 1.45060320e+01
 5.46762542e+01 2.29668753e-01 1.84657868e+00 6.71373756e-01]
grad_E = [ 4.90320165e-11 -2.60959376e-09  6.18140937e-08 -9.37021558e-07
  6.99787296e-06  4.66045521e-05 -1.11138356e-05 -1.22837897e-04
 -3.15127071e-04  7.21525112e-05  5.33408380e-06 -9.58767323e-06
 -2.08481847e-04 -8.19869235e-05 -5.92888813e-05  1.40576981e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.4544733         1
[INPUT] 0    0    [1    /1   ]  833.270977701        1
[INPUT] 0    0    [1    /1   ]  235.735922992        1
[INPUT] 0    0    [1    /1   ]  76.4254170928        1
[INPUT] 0    0    [1    /1   ]  10.035309099         1
[INPUT] 0    0    [1    /1   ]  27.0446002882        1
[INPUT] 0    0    [1    /1   ]  0.378023551329       1
[INPUT] 0    0    [1    /1   ]  1.10762722808        1
[INPUT] 0    0    [1    /1   ]  2.88006810906        1
[INPUT] 1    0    [1    /1   ]  4.99085707218        1
[INPUT] 1    0    [1    /1   ]  14.5014487544        1
[INPUT] 1    0    [1    /1   ]  54.6784047278        1
[INPUT] 1    0    [1    /1   ]  0.229433237567       1
[INPUT] 1    0    [1    /1   ]  1.84646768982        1
[INPUT] 1    0    [1    /1   ]  0.670956592722       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412992808, 1.0]], [0, [3661.4544732988893, 1.0]], [0, [833.2709777012059, 1.0]], [0, [235.7359229915907, 1.0]], [0, [76.42541709277123, 1.0]], [0, [10.035309098995018, 1.0]], [0, [27.044600288152925, 1.0]], [0, [0.37802355132871, 1.0]], [0, [1.1076272280824437, 1.0]], [0, [2.8800681090644007, 1.0]], [1, [4.99085707218083, 1.0]], [1, [14.50144875437017, 1.0]], [1, [54.67840472783669, 1.0]], [1, [0.2294332375665987, 1.0]], [1, [1.8464676898226124, 1.0]], [1, [0.6709565927219011, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.4544733]
bas 2, expnt(s) = [833.2709777]
bas 3, expnt(s) = [235.73592299]
bas 4, expnt(s) = [76.42541709]
bas 5, expnt(s) = [10.0353091]
bas 6, expnt(s) = [27.04460029]
bas 7, expnt(s) = [0.37802355]
bas 8, expnt(s) = [1.10762723]
bas 9, expnt(s) = [2.88006811]
bas 10, expnt(s) = [4.99085707]
bas 11, expnt(s) = [14.50144875]
bas 12, expnt(s) = [54.67840473]
bas 13, expnt(s) = [0.22943324]
bas 14, expnt(s) = [1.84646769]
bas 15, expnt(s) = [0.67095659]
CPU time:       120.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270978e+02 3.91836344e+02 2.35735923e+02 1.51996767e+02
 7.64254171e+01 6.53045419e+01 1.00353091e+01 1.42450209e+01
 2.70446003e+01 2.99623208e+01 3.78023551e-01 1.21801929e+00
 1.10762723e+00 2.72778566e+00 2.88006811e+00 5.58556478e+00
 4.99085707e+00 2.17622256e+01 1.45014488e+01 8.25559982e+01
 5.46784047e+01 4.33764681e+02 2.29433238e-01 4.63238674e-01
 1.84646769e+00 6.27930435e+00 6.70956593e-01 1.77154596e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99981481018148
cond(S) = 341.2220309569443
E1 = -183.58643884302134  E_coul = 55.08011728738488
init E= -128.506321555636
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774950948800003  LUMO = 0.669962153445442
  mo_energy =
[-3.25551279e+01 -1.85258299e+00 -7.74950949e-01 -7.74950949e-01
 -7.74950949e-01  6.69962153e-01  6.69962153e-01  6.69962153e-01
  1.20467532e+00  3.07170891e+00  3.07170891e+00  3.07170891e+00
  7.33118629e+00  1.03724598e+01  1.03724598e+01  1.03724598e+01
  3.41133809e+01  3.41133809e+01  3.41133809e+01  3.47150863e+01
  1.32490357e+02  1.32490357e+02  1.32490357e+02  1.38846124e+02
  5.02937598e+02  1.87058065e+03  8.00026290e+03  4.77679338e+04]
E1 = -182.05779662182448  E_coul = 53.522952400478026
cycle= 1 E= -128.534844221346  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546724
diis-c [-0.2989074  1.       ]
  HOMO = -0.885614970583897  LUMO = 0.649708186561476
  mo_energy =
[-3.28832102e+01 -1.96864087e+00 -8.85614971e-01 -8.85614971e-01
 -8.85614971e-01  6.49708187e-01  6.49708187e-01  6.49708187e-01
  1.15853660e+00  2.99369294e+00  2.99369294e+00  2.99369294e+00
  7.19696983e+00  1.02116205e+01  1.02116205e+01  1.02116205e+01
  3.38607598e+01  3.38607598e+01  3.38607598e+01  3.44641446e+01
  1.32161791e+02  1.32161791e+02  1.32161791e+02  1.38523367e+02
  5.02570848e+02  1.87017795e+03  7.99983122e+03  4.77674833e+04]
E1 = -182.83574230312263  E_coul = 54.298233072701414
cycle= 2 E= -128.537509230421  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279357
diis-c [-6.40846984e-04  3.37488894e-01  6.62511106e-01]
  HOMO = -0.849255292250923  LUMO = 0.656360666078799
  mo_energy =
[-3.27731656e+01 -1.93032780e+00 -8.49255292e-01 -8.49255292e-01
 -8.49255292e-01  6.56360666e-01  6.56360666e-01  6.56360666e-01
  1.17337944e+00  3.01899033e+00  3.01899033e+00  3.01899033e+00
  7.24109198e+00  1.02647724e+01  1.02647724e+01  1.02647724e+01
  3.39454257e+01  3.39454257e+01  3.39454257e+01  3.45484765e+01
  1.32271296e+02  1.32271296e+02  1.32271296e+02  1.38631388e+02
  5.02689780e+02  1.87030219e+03  7.99995793e+03  4.77676110e+04]
E1 = -182.57100846935342  E_coul = 54.032539345987466
cycle= 3 E= -128.538469123366  delta_E= -0.00096  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999318
diis-c [-1.07678802e-07 -2.06363129e-03 -6.58011032e-04  1.00272164e+00]
  HOMO = -0.849483944529629  LUMO = 0.656339901559654
  mo_energy =
[-3.27735654e+01 -1.93050790e+00 -8.49483945e-01 -8.49483945e-01
 -8.49483945e-01  6.56339902e-01  6.56339902e-01  6.56339902e-01
  1.17331127e+00  3.01886757e+00  3.01886757e+00  3.01886757e+00
  7.24090327e+00  1.02645447e+01  1.02645447e+01  1.02645447e+01
  3.39451057e+01  3.39451057e+01  3.39451057e+01  3.45481679e+01
  1.32270883e+02  1.32270883e+02  1.32270883e+02  1.38630986e+02
  5.02689269e+02  1.87030156e+03  7.99995721e+03  4.77676102e+04]
E1 = -182.57132630298474  E_coul = 54.03285716225737
cycle= 4 E= -128.538469140727  delta_E= -1.74e-08  |g|= 7.36e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184788
diis-c [-7.10899992e-10  1.32556392e-04  5.11680070e-04 -1.41724700e-01
  1.14108046e+00]
  HOMO = -0.849523913740059  LUMO = 0.656330187563008
  mo_energy =
[-3.27736352e+01 -1.93054264e+00 -8.49523914e-01 -8.49523914e-01
 -8.49523914e-01  6.56330188e-01  6.56330188e-01  6.56330188e-01
  1.17329148e+00  3.01883543e+00  3.01883543e+00  3.01883543e+00
  7.24085946e+00  1.02644937e+01  1.02644937e+01  1.02644937e+01
  3.39450423e+01  3.39450423e+01  3.39450423e+01  3.45481054e+01
  1.32270813e+02  1.32270813e+02  1.32270813e+02  1.38630916e+02
  5.02689193e+02  1.87030148e+03  7.99995712e+03  4.77676101e+04]
E1 = -182.57145588720377  E_coul = 54.032986745960635
cycle= 5 E= -128.538469141243  delta_E= -5.16e-10  |g|= 2.99e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57145588720377  E_coul = 54.032986745960635
  HOMO = -0.849522679654742  LUMO = 0.65633042039625
  mo_energy =
[-3.27736323e+01 -1.93054091e+00 -8.49522680e-01 -8.49522680e-01
 -8.49522680e-01  6.56330420e-01  6.56330420e-01  6.56330420e-01
  1.17329224e+00  3.01883634e+00  3.01883634e+00  3.01883634e+00
  7.24086127e+00  1.02644955e+01  1.02644955e+01  1.02644955e+01
  3.39450449e+01  3.39450449e+01  3.39450449e+01  3.45481081e+01
  1.32270816e+02  1.32270816e+02  1.32270816e+02  1.38630919e+02
  5.02689196e+02  1.87030148e+03  7.99995712e+03  4.77676101e+04]
E1 = -182.57144793586917  E_coul = 54.032978794625656
Extra cycle  E= -128.538469141244  delta_E= -3.98e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270978e+02 2.35735923e+02
 7.64254171e+01 1.00353091e+01 2.70446003e+01 3.78023551e-01
 1.10762723e+00 2.88006811e+00 4.99085707e+00 1.45014488e+01
 5.46784047e+01 2.29433238e-01 1.84646769e+00 6.70956593e-01]
E = -128.53846914124352
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.4544733         1
[INPUT] 0    0    [1    /1   ]  833.270977701        1
[INPUT] 0    0    [1    /1   ]  235.735922992        1
[INPUT] 0    0    [1    /1   ]  76.4254170928        1
[INPUT] 0    0    [1    /1   ]  10.035309099         1
[INPUT] 0    0    [1    /1   ]  27.0446002882        1
[INPUT] 0    0    [1    /1   ]  0.378023551329       1
[INPUT] 0    0    [1    /1   ]  1.10762722808        1
[INPUT] 0    0    [1    /1   ]  2.88006810906        1
[INPUT] 1    0    [1    /1   ]  4.99085707218        1
[INPUT] 1    0    [1    /1   ]  14.5014487544        1
[INPUT] 1    0    [1    /1   ]  54.6784047278        1
[INPUT] 1    0    [1    /1   ]  0.229433237567       1
[INPUT] 1    0    [1    /1   ]  1.84646768982        1
[INPUT] 1    0    [1    /1   ]  0.670956592722       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412992808, 1.0]], [0, [3661.4544732988893, 1.0]], [0, [833.2709777012059, 1.0]], [0, [235.7359229915907, 1.0]], [0, [76.42541709277123, 1.0]], [0, [10.035309098995018, 1.0]], [0, [27.044600288152925, 1.0]], [0, [0.37802355132871, 1.0]], [0, [1.1076272280824437, 1.0]], [0, [2.8800681090644007, 1.0]], [1, [4.99085707218083, 1.0]], [1, [14.50144875437017, 1.0]], [1, [54.67840472783669, 1.0]], [1, [0.2294332375665987, 1.0]], [1, [1.8464676898226124, 1.0]], [1, [0.6709565927219011, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.4544733]
bas 2, expnt(s) = [833.2709777]
bas 3, expnt(s) = [235.73592299]
bas 4, expnt(s) = [76.42541709]
bas 5, expnt(s) = [10.0353091]
bas 6, expnt(s) = [27.04460029]
bas 7, expnt(s) = [0.37802355]
bas 8, expnt(s) = [1.10762723]
bas 9, expnt(s) = [2.88006811]
bas 10, expnt(s) = [4.99085707]
bas 11, expnt(s) = [14.50144875]
bas 12, expnt(s) = [54.67840473]
bas 13, expnt(s) = [0.22943324]
bas 14, expnt(s) = [1.84646769]
bas 15, expnt(s) = [0.67095659]
CPU time:       121.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270978e+02 3.91836344e+02 2.35735923e+02 1.51996767e+02
 7.64254171e+01 6.53045419e+01 1.00353091e+01 1.42450209e+01
 2.70446003e+01 2.99623208e+01 3.78023551e-01 1.21801929e+00
 1.10762723e+00 2.72778566e+00 2.88006811e+00 5.58556478e+00
 4.99085707e+00 2.17622256e+01 1.45014488e+01 8.25559982e+01
 5.46784047e+01 4.33764681e+02 2.29433238e-01 4.63238674e-01
 1.84646769e+00 6.27930435e+00 6.70956593e-01 1.77154596e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99981481018148
cond(S) = 341.2220309569443
E1 = -183.58643884302134  E_coul = 55.08011728738488
init E= -128.506321555636
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774950948800003  LUMO = 0.669962153445442
  mo_energy =
[-3.25551279e+01 -1.85258299e+00 -7.74950949e-01 -7.74950949e-01
 -7.74950949e-01  6.69962153e-01  6.69962153e-01  6.69962153e-01
  1.20467532e+00  3.07170891e+00  3.07170891e+00  3.07170891e+00
  7.33118629e+00  1.03724598e+01  1.03724598e+01  1.03724598e+01
  3.41133809e+01  3.41133809e+01  3.41133809e+01  3.47150863e+01
  1.32490357e+02  1.32490357e+02  1.32490357e+02  1.38846124e+02
  5.02937598e+02  1.87058065e+03  8.00026290e+03  4.77679338e+04]
E1 = -182.05779662182448  E_coul = 53.522952400478026
cycle= 1 E= -128.534844221346  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546724
diis-c [-0.2989074  1.       ]
  HOMO = -0.885614970583897  LUMO = 0.649708186561476
  mo_energy =
[-3.28832102e+01 -1.96864087e+00 -8.85614971e-01 -8.85614971e-01
 -8.85614971e-01  6.49708187e-01  6.49708187e-01  6.49708187e-01
  1.15853660e+00  2.99369294e+00  2.99369294e+00  2.99369294e+00
  7.19696983e+00  1.02116205e+01  1.02116205e+01  1.02116205e+01
  3.38607598e+01  3.38607598e+01  3.38607598e+01  3.44641446e+01
  1.32161791e+02  1.32161791e+02  1.32161791e+02  1.38523367e+02
  5.02570848e+02  1.87017795e+03  7.99983122e+03  4.77674833e+04]
E1 = -182.83574230312263  E_coul = 54.298233072701414
cycle= 2 E= -128.537509230421  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279357
diis-c [-6.40846984e-04  3.37488894e-01  6.62511106e-01]
  HOMO = -0.849255292250923  LUMO = 0.656360666078799
  mo_energy =
[-3.27731656e+01 -1.93032780e+00 -8.49255292e-01 -8.49255292e-01
 -8.49255292e-01  6.56360666e-01  6.56360666e-01  6.56360666e-01
  1.17337944e+00  3.01899033e+00  3.01899033e+00  3.01899033e+00
  7.24109198e+00  1.02647724e+01  1.02647724e+01  1.02647724e+01
  3.39454257e+01  3.39454257e+01  3.39454257e+01  3.45484765e+01
  1.32271296e+02  1.32271296e+02  1.32271296e+02  1.38631388e+02
  5.02689780e+02  1.87030219e+03  7.99995793e+03  4.77676110e+04]
E1 = -182.57100846935342  E_coul = 54.032539345987466
cycle= 3 E= -128.538469123366  delta_E= -0.00096  |g|= 0.000431  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999318
diis-c [-1.07678802e-07 -2.06363129e-03 -6.58011032e-04  1.00272164e+00]
  HOMO = -0.849483944529629  LUMO = 0.656339901559654
  mo_energy =
[-3.27735654e+01 -1.93050790e+00 -8.49483945e-01 -8.49483945e-01
 -8.49483945e-01  6.56339902e-01  6.56339902e-01  6.56339902e-01
  1.17331127e+00  3.01886757e+00  3.01886757e+00  3.01886757e+00
  7.24090327e+00  1.02645447e+01  1.02645447e+01  1.02645447e+01
  3.39451057e+01  3.39451057e+01  3.39451057e+01  3.45481679e+01
  1.32270883e+02  1.32270883e+02  1.32270883e+02  1.38630986e+02
  5.02689269e+02  1.87030156e+03  7.99995721e+03  4.77676102e+04]
E1 = -182.57132630298474  E_coul = 54.03285716225737
cycle= 4 E= -128.538469140727  delta_E= -1.74e-08  |g|= 7.36e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184788
diis-c [-7.10899992e-10  1.32556392e-04  5.11680070e-04 -1.41724700e-01
  1.14108046e+00]
  HOMO = -0.849523913740059  LUMO = 0.656330187563008
  mo_energy =
[-3.27736352e+01 -1.93054264e+00 -8.49523914e-01 -8.49523914e-01
 -8.49523914e-01  6.56330188e-01  6.56330188e-01  6.56330188e-01
  1.17329148e+00  3.01883543e+00  3.01883543e+00  3.01883543e+00
  7.24085946e+00  1.02644937e+01  1.02644937e+01  1.02644937e+01
  3.39450423e+01  3.39450423e+01  3.39450423e+01  3.45481054e+01
  1.32270813e+02  1.32270813e+02  1.32270813e+02  1.38630916e+02
  5.02689193e+02  1.87030148e+03  7.99995712e+03  4.77676101e+04]
E1 = -182.57145588720377  E_coul = 54.032986745960635
cycle= 5 E= -128.538469141243  delta_E= -5.16e-10  |g|= 2.99e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57145588720377  E_coul = 54.032986745960635
  HOMO = -0.849522679654742  LUMO = 0.65633042039625
  mo_energy =
[-3.27736323e+01 -1.93054091e+00 -8.49522680e-01 -8.49522680e-01
 -8.49522680e-01  6.56330420e-01  6.56330420e-01  6.56330420e-01
  1.17329224e+00  3.01883634e+00  3.01883634e+00  3.01883634e+00
  7.24086127e+00  1.02644955e+01  1.02644955e+01  1.02644955e+01
  3.39450449e+01  3.39450449e+01  3.39450449e+01  3.45481081e+01
  1.32270816e+02  1.32270816e+02  1.32270816e+02  1.38630919e+02
  5.02689196e+02  1.87030148e+03  7.99995712e+03  4.77676101e+04]
E1 = -182.57144793586917  E_coul = 54.032978794625656
Extra cycle  E= -128.538469141244  delta_E= -3.98e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.2220309569443
E1 = -182.57144793586917  E_coul = 54.032978794625656
init E= -128.538469141244
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849523259905569  LUMO = 0.656330314542948
  mo_energy =
[-3.27736340e+01 -1.93054143e+00 -8.49523260e-01 -8.49523260e-01
 -8.49523260e-01  6.56330315e-01  6.56330315e-01  6.56330315e-01
  1.17329204e+00  3.01883594e+00  3.01883594e+00  3.01883594e+00
  7.24086062e+00  1.02644947e+01  1.02644947e+01  1.02644947e+01
  3.39450436e+01  3.39450436e+01  3.39450436e+01  3.45481068e+01
  1.32270814e+02  1.32270814e+02  1.32270814e+02  1.38630917e+02
  5.02689194e+02  1.87030148e+03  7.99995712e+03  4.77676101e+04]
E1 = -182.57145211503845  E_coul = 54.03298297379464
cycle= 1 E= -128.538469141244  delta_E= -2.84e-13  |g|= 5.79e-07  |ddm|= 3.3e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57145211503845  E_coul = 54.03298297379464
  HOMO = -0.849522967936522  LUMO = 0.656330368565926
  mo_energy =
[-3.27736331e+01 -1.93054110e+00 -8.49522968e-01 -8.49522968e-01
 -8.49522968e-01  6.56330369e-01  6.56330369e-01  6.56330369e-01
  1.17329217e+00  3.01883615e+00  3.01883615e+00  3.01883615e+00
  7.24086099e+00  1.02644951e+01  1.02644951e+01  1.02644951e+01
  3.39450443e+01  3.39450443e+01  3.39450443e+01  3.45481075e+01
  1.32270815e+02  1.32270815e+02  1.32270815e+02  1.38630918e+02
  5.02689195e+02  1.87030148e+03  7.99995712e+03  4.77676101e+04]
E1 = -182.57144997710324  E_coul = 54.03298083585975
Extra cycle  E= -128.538469141243  delta_E= 3.13e-13  |g|= 2.89e-07  |ddm|= 1.97e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270978e+02 2.35735923e+02
 7.64254171e+01 1.00353091e+01 2.70446003e+01 3.78023551e-01
 1.10762723e+00 2.88006811e+00 4.99085707e+00 1.45014488e+01
 5.46784047e+01 2.29433238e-01 1.84646769e+00 6.70956593e-01]
grad_E = [ 4.82694202e-11 -2.56968178e-09  6.10205782e-08 -9.27928318e-07
  6.93227443e-06  4.62172829e-05 -1.08460367e-05 -1.25975445e-04
 -3.17070690e-04  7.29955996e-05 -6.10759025e-05 -4.75425292e-07
 -2.08708328e-04 -2.78827029e-06  1.39866254e-04 -1.38205740e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447332        1
[INPUT] 0    0    [1    /1   ]  833.270977221        1
[INPUT] 0    0    [1    /1   ]  235.735930919        1
[INPUT] 0    0    [1    /1   ]  76.4253575236        1
[INPUT] 0    0    [1    /1   ]  10.0351327003        1
[INPUT] 0    0    [1    /1   ]  27.0446374882        1
[INPUT] 0    0    [1    /1   ]  0.378167233173       1
[INPUT] 0    0    [1    /1   ]  1.10798462763        1
[INPUT] 0    0    [1    /1   ]  2.88006146333        1
[INPUT] 1    0    [1    /1   ]  4.9876754542         1
[INPUT] 1    0    [1    /1   ]  14.4951052649        1
[INPUT] 1    0    [1    /1   ]  54.6819166081        1
[INPUT] 1    0    [1    /1   ]  0.229148480326       1
[INPUT] 1    0    [1    /1   ]  1.84610658329        1
[INPUT] 1    0    [1    /1   ]  0.670363652999       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412992773, 1.0]], [0, [3661.4544733176626, 1.0]], [0, [833.2709772213508, 1.0]], [0, [235.73593091867954, 1.0]], [0, [76.42535752359262, 1.0]], [0, [10.035132700323382, 1.0]], [0, [27.04463748822126, 1.0]], [0, [0.378167233173486, 1.0]], [0, [1.10798462763372, 1.0]], [0, [2.880061463327315, 1.0]], [1, [4.987675454198927, 1.0]], [1, [14.495105264857333, 1.0]], [1, [54.68191660807347, 1.0]], [1, [0.22914848032583182, 1.0]], [1, [1.8461065832913006, 1.0]], [1, [0.6703636529987191, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447332]
bas 2, expnt(s) = [833.27097722]
bas 3, expnt(s) = [235.73593092]
bas 4, expnt(s) = [76.42535752]
bas 5, expnt(s) = [10.0351327]
bas 6, expnt(s) = [27.04463749]
bas 7, expnt(s) = [0.37816723]
bas 8, expnt(s) = [1.10798463]
bas 9, expnt(s) = [2.88006146]
bas 10, expnt(s) = [4.98767545]
bas 11, expnt(s) = [14.49510526]
bas 12, expnt(s) = [54.68191661]
bas 13, expnt(s) = [0.22914848]
bas 14, expnt(s) = [1.84610658]
bas 15, expnt(s) = [0.67036365]
CPU time:       124.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270977e+02 3.91836344e+02 2.35735931e+02 1.51996771e+02
 7.64253575e+01 6.53045037e+01 1.00351327e+01 1.42448331e+01
 2.70446375e+01 2.99623517e+01 3.78167233e-01 1.21836649e+00
 1.10798463e+00 2.72844576e+00 2.88006146e+00 5.58555511e+00
 4.98767545e+00 2.17448855e+01 1.44951053e+01 8.25108592e+01
 5.46819166e+01 4.33799506e+02 2.29148480e-01 4.62520109e-01
 1.84610658e+00 6.27776936e+00 6.70363653e-01 1.76958923e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999815390951419
cond(S) = 341.32170890078277
E1 = -183.58644034415525  E_coul = 55.08011752641808
init E= -128.506322817737
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77495113708295  LUMO = 0.669048035184102
  mo_energy =
[-3.25551278e+01 -1.85258283e+00 -7.74951137e-01 -7.74951137e-01
 -7.74951137e-01  6.69048035e-01  6.69048035e-01  6.69048035e-01
  1.20525612e+00  3.06899510e+00  3.06899510e+00  3.06899510e+00
  7.33292484e+00  1.03661062e+01  1.03661062e+01  1.03661062e+01
  3.40936116e+01  3.40936116e+01  3.40936116e+01  3.47169256e+01
  1.32462554e+02  1.32462554e+02  1.32462554e+02  1.38847482e+02
  5.02938636e+02  1.87058151e+03  8.00026364e+03  4.77679344e+04]
E1 = -182.05770302126155  E_coul = 53.522858646509825
cycle= 1 E= -128.534844374752  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546678
diis-c [-0.29885647  1.        ]
  HOMO = -0.885622356247886  LUMO = 0.648827420435836
  mo_energy =
[-3.28832262e+01 -1.96864990e+00 -8.85622356e-01 -8.85622356e-01
 -8.85622356e-01  6.48827420e-01  6.48827420e-01  6.48827420e-01
  1.15909588e+00  2.99100828e+00  2.99100828e+00  2.99100828e+00
  7.19869142e+00  1.02052948e+01  1.02052948e+01  1.02052948e+01
  3.38410095e+01  3.38410095e+01  3.38410095e+01  3.44659751e+01
  1.32133968e+02  1.32133968e+02  1.32133968e+02  1.38524710e+02
  5.02571870e+02  1.87017879e+03  7.99983194e+03  4.77674839e+04]
E1 = -182.83571418347333  E_coul = 54.298204599836374
cycle= 2 E= -128.537509583637  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279345
diis-c [-6.40926582e-04  3.37498078e-01  6.62501922e-01]
  HOMO = -0.849259920433717  LUMO = 0.655469594319899
  mo_energy =
[-3.27731749e+01 -1.93033374e+00 -8.49259920e-01 -8.49259920e-01
 -8.49259920e-01  6.55469594e-01  6.55469594e-01  6.55469594e-01
  1.17394593e+00  3.01629635e+00  3.01629635e+00  3.01629635e+00
  7.24281928e+00  1.02584378e+01  1.02584378e+01  1.02584378e+01
  3.39256698e+01  3.39256698e+01  3.39256698e+01  3.45503118e+01
  1.32243481e+02  1.32243481e+02  1.32243481e+02  1.38632737e+02
  5.02690809e+02  1.87030303e+03  7.99995865e+03  4.77676116e+04]
E1 = -182.57095467233216  E_coul = 54.032485029667676
cycle= 3 E= -128.538469642664  delta_E= -0.00096  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997966
diis-c [-1.07354724e-07 -2.06248416e-03 -6.59997543e-04  1.00272248e+00]
  HOMO = -0.849488368573217  LUMO = 0.655448992090002
  mo_energy =
[-3.27735743e+01 -1.93051366e+00 -8.49488369e-01 -8.49488369e-01
 -8.49488369e-01  6.55448992e-01  6.55448992e-01  6.55448992e-01
  1.17387791e+00  3.01617387e+00  3.01617387e+00  3.01617387e+00
  7.24263074e+00  1.02582104e+01  1.02582104e+01  1.02582104e+01
  3.39253502e+01  3.39253502e+01  3.39253502e+01  3.45500036e+01
  1.32243069e+02  1.32243069e+02  1.32243069e+02  1.38632336e+02
  5.02690298e+02  1.87030240e+03  7.99995793e+03  4.77676108e+04]
E1 = -182.57127227196233  E_coul = 54.03280261200715
cycle= 4 E= -128.538469659955  delta_E= -1.73e-08  |g|= 7.35e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184505
diis-c [-7.10648807e-10  1.32307799e-04  5.11096577e-04 -1.41590957e-01
  1.14094755e+00]
  HOMO = -0.849528275958874  LUMO = 0.655439312446848
  mo_energy =
[-3.27736439e+01 -1.93054835e+00 -8.49528276e-01 -8.49528276e-01
 -8.49528276e-01  6.55439312e-01  6.55439312e-01  6.55439312e-01
  1.17385816e+00  3.01614180e+00  3.01614180e+00  3.01614180e+00
  7.24258700e+00  1.02581595e+01  1.02581595e+01  1.02581595e+01
  3.39252869e+01  3.39252869e+01  3.39252869e+01  3.45499412e+01
  1.32242999e+02  1.32242999e+02  1.32242999e+02  1.38632267e+02
  5.02690223e+02  1.87030232e+03  7.99995785e+03  4.77676107e+04]
E1 = -182.57140171974993  E_coul = 54.03293205928041
cycle= 5 E= -128.53846966047  delta_E= -5.14e-10  |g|= 2.99e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57140171974993  E_coul = 54.03293205928041
  HOMO = -0.849527045182974  LUMO = 0.655439543932146
  mo_energy =
[-3.27736410e+01 -1.93054662e+00 -8.49527045e-01 -8.49527045e-01
 -8.49527045e-01  6.55439544e-01  6.55439544e-01  6.55439544e-01
  1.17385892e+00  3.01614271e+00  3.01614271e+00  3.01614271e+00
  7.24258881e+00  1.02581613e+01  1.02581613e+01  1.02581613e+01
  3.39252895e+01  3.39252895e+01  3.39252895e+01  3.45499439e+01
  1.32243002e+02  1.32243002e+02  1.32243002e+02  1.38632269e+02
  5.02690225e+02  1.87030232e+03  7.99995785e+03  4.77676107e+04]
E1 = -182.5713937826777  E_coul = 54.03292412220806
Extra cycle  E= -128.53846966047  delta_E= -1.14e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270977e+02 2.35735931e+02
 7.64253575e+01 1.00351327e+01 2.70446375e+01 3.78167233e-01
 1.10798463e+00 2.88006146e+00 4.98767545e+00 1.44951053e+01
 5.46819166e+01 2.29148480e-01 1.84610658e+00 6.70363653e-01]
E = -128.53846966046962
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447332        1
[INPUT] 0    0    [1    /1   ]  833.270977221        1
[INPUT] 0    0    [1    /1   ]  235.735930919        1
[INPUT] 0    0    [1    /1   ]  76.4253575236        1
[INPUT] 0    0    [1    /1   ]  10.0351327003        1
[INPUT] 0    0    [1    /1   ]  27.0446374882        1
[INPUT] 0    0    [1    /1   ]  0.378167233173       1
[INPUT] 0    0    [1    /1   ]  1.10798462763        1
[INPUT] 0    0    [1    /1   ]  2.88006146333        1
[INPUT] 1    0    [1    /1   ]  4.9876754542         1
[INPUT] 1    0    [1    /1   ]  14.4951052649        1
[INPUT] 1    0    [1    /1   ]  54.6819166081        1
[INPUT] 1    0    [1    /1   ]  0.229148480326       1
[INPUT] 1    0    [1    /1   ]  1.84610658329        1
[INPUT] 1    0    [1    /1   ]  0.670363652999       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412992773, 1.0]], [0, [3661.4544733176626, 1.0]], [0, [833.2709772213508, 1.0]], [0, [235.73593091867954, 1.0]], [0, [76.42535752359262, 1.0]], [0, [10.035132700323382, 1.0]], [0, [27.04463748822126, 1.0]], [0, [0.378167233173486, 1.0]], [0, [1.10798462763372, 1.0]], [0, [2.880061463327315, 1.0]], [1, [4.987675454198927, 1.0]], [1, [14.495105264857333, 1.0]], [1, [54.68191660807347, 1.0]], [1, [0.22914848032583182, 1.0]], [1, [1.8461065832913006, 1.0]], [1, [0.6703636529987191, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447332]
bas 2, expnt(s) = [833.27097722]
bas 3, expnt(s) = [235.73593092]
bas 4, expnt(s) = [76.42535752]
bas 5, expnt(s) = [10.0351327]
bas 6, expnt(s) = [27.04463749]
bas 7, expnt(s) = [0.37816723]
bas 8, expnt(s) = [1.10798463]
bas 9, expnt(s) = [2.88006146]
bas 10, expnt(s) = [4.98767545]
bas 11, expnt(s) = [14.49510526]
bas 12, expnt(s) = [54.68191661]
bas 13, expnt(s) = [0.22914848]
bas 14, expnt(s) = [1.84610658]
bas 15, expnt(s) = [0.67036365]
CPU time:       125.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270977e+02 3.91836344e+02 2.35735931e+02 1.51996771e+02
 7.64253575e+01 6.53045037e+01 1.00351327e+01 1.42448331e+01
 2.70446375e+01 2.99623517e+01 3.78167233e-01 1.21836649e+00
 1.10798463e+00 2.72844576e+00 2.88006146e+00 5.58555511e+00
 4.98767545e+00 2.17448855e+01 1.44951053e+01 8.25108592e+01
 5.46819166e+01 4.33799506e+02 2.29148480e-01 4.62520109e-01
 1.84610658e+00 6.27776936e+00 6.70363653e-01 1.76958923e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999815390951419
cond(S) = 341.32170890078277
E1 = -183.58644034415525  E_coul = 55.08011752641808
init E= -128.506322817737
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77495113708295  LUMO = 0.669048035184102
  mo_energy =
[-3.25551278e+01 -1.85258283e+00 -7.74951137e-01 -7.74951137e-01
 -7.74951137e-01  6.69048035e-01  6.69048035e-01  6.69048035e-01
  1.20525612e+00  3.06899510e+00  3.06899510e+00  3.06899510e+00
  7.33292484e+00  1.03661062e+01  1.03661062e+01  1.03661062e+01
  3.40936116e+01  3.40936116e+01  3.40936116e+01  3.47169256e+01
  1.32462554e+02  1.32462554e+02  1.32462554e+02  1.38847482e+02
  5.02938636e+02  1.87058151e+03  8.00026364e+03  4.77679344e+04]
E1 = -182.05770302126155  E_coul = 53.522858646509825
cycle= 1 E= -128.534844374752  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546678
diis-c [-0.29885647  1.        ]
  HOMO = -0.885622356247886  LUMO = 0.648827420435836
  mo_energy =
[-3.28832262e+01 -1.96864990e+00 -8.85622356e-01 -8.85622356e-01
 -8.85622356e-01  6.48827420e-01  6.48827420e-01  6.48827420e-01
  1.15909588e+00  2.99100828e+00  2.99100828e+00  2.99100828e+00
  7.19869142e+00  1.02052948e+01  1.02052948e+01  1.02052948e+01
  3.38410095e+01  3.38410095e+01  3.38410095e+01  3.44659751e+01
  1.32133968e+02  1.32133968e+02  1.32133968e+02  1.38524710e+02
  5.02571870e+02  1.87017879e+03  7.99983194e+03  4.77674839e+04]
E1 = -182.83571418347333  E_coul = 54.298204599836374
cycle= 2 E= -128.537509583637  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279345
diis-c [-6.40926582e-04  3.37498078e-01  6.62501922e-01]
  HOMO = -0.849259920433717  LUMO = 0.655469594319899
  mo_energy =
[-3.27731749e+01 -1.93033374e+00 -8.49259920e-01 -8.49259920e-01
 -8.49259920e-01  6.55469594e-01  6.55469594e-01  6.55469594e-01
  1.17394593e+00  3.01629635e+00  3.01629635e+00  3.01629635e+00
  7.24281928e+00  1.02584378e+01  1.02584378e+01  1.02584378e+01
  3.39256698e+01  3.39256698e+01  3.39256698e+01  3.45503118e+01
  1.32243481e+02  1.32243481e+02  1.32243481e+02  1.38632737e+02
  5.02690809e+02  1.87030303e+03  7.99995865e+03  4.77676116e+04]
E1 = -182.57095467233216  E_coul = 54.032485029667676
cycle= 3 E= -128.538469642664  delta_E= -0.00096  |g|= 0.00043  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997966
diis-c [-1.07354724e-07 -2.06248416e-03 -6.59997543e-04  1.00272248e+00]
  HOMO = -0.849488368573217  LUMO = 0.655448992090002
  mo_energy =
[-3.27735743e+01 -1.93051366e+00 -8.49488369e-01 -8.49488369e-01
 -8.49488369e-01  6.55448992e-01  6.55448992e-01  6.55448992e-01
  1.17387791e+00  3.01617387e+00  3.01617387e+00  3.01617387e+00
  7.24263074e+00  1.02582104e+01  1.02582104e+01  1.02582104e+01
  3.39253502e+01  3.39253502e+01  3.39253502e+01  3.45500036e+01
  1.32243069e+02  1.32243069e+02  1.32243069e+02  1.38632336e+02
  5.02690298e+02  1.87030240e+03  7.99995793e+03  4.77676108e+04]
E1 = -182.57127227196233  E_coul = 54.03280261200715
cycle= 4 E= -128.538469659955  delta_E= -1.73e-08  |g|= 7.35e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184505
diis-c [-7.10648807e-10  1.32307799e-04  5.11096577e-04 -1.41590957e-01
  1.14094755e+00]
  HOMO = -0.849528275958874  LUMO = 0.655439312446848
  mo_energy =
[-3.27736439e+01 -1.93054835e+00 -8.49528276e-01 -8.49528276e-01
 -8.49528276e-01  6.55439312e-01  6.55439312e-01  6.55439312e-01
  1.17385816e+00  3.01614180e+00  3.01614180e+00  3.01614180e+00
  7.24258700e+00  1.02581595e+01  1.02581595e+01  1.02581595e+01
  3.39252869e+01  3.39252869e+01  3.39252869e+01  3.45499412e+01
  1.32242999e+02  1.32242999e+02  1.32242999e+02  1.38632267e+02
  5.02690223e+02  1.87030232e+03  7.99995785e+03  4.77676107e+04]
E1 = -182.57140171974993  E_coul = 54.03293205928041
cycle= 5 E= -128.53846966047  delta_E= -5.14e-10  |g|= 2.99e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57140171974993  E_coul = 54.03293205928041
  HOMO = -0.849527045182974  LUMO = 0.655439543932146
  mo_energy =
[-3.27736410e+01 -1.93054662e+00 -8.49527045e-01 -8.49527045e-01
 -8.49527045e-01  6.55439544e-01  6.55439544e-01  6.55439544e-01
  1.17385892e+00  3.01614271e+00  3.01614271e+00  3.01614271e+00
  7.24258881e+00  1.02581613e+01  1.02581613e+01  1.02581613e+01
  3.39252895e+01  3.39252895e+01  3.39252895e+01  3.45499439e+01
  1.32243002e+02  1.32243002e+02  1.32243002e+02  1.38632269e+02
  5.02690225e+02  1.87030232e+03  7.99995785e+03  4.77676107e+04]
E1 = -182.5713937826777  E_coul = 54.03292412220806
Extra cycle  E= -128.53846966047  delta_E= -1.14e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.32170890078277
E1 = -182.5713937826777  E_coul = 54.03292412220806
init E= -128.53846966047
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.849527624510715  LUMO = 0.655439438377942
  mo_energy =
[-3.27736428e+01 -1.93054714e+00 -8.49527625e-01 -8.49527625e-01
 -8.49527625e-01  6.55439438e-01  6.55439438e-01  6.55439438e-01
  1.17385872e+00  3.01614231e+00  3.01614231e+00  3.01614231e+00
  7.24258816e+00  1.02581605e+01  1.02581605e+01  1.02581605e+01
  3.39252882e+01  3.39252882e+01  3.39252882e+01  3.45499426e+01
  1.32243000e+02  1.32243000e+02  1.32243000e+02  1.38632268e+02
  5.02690223e+02  1.87030232e+03  7.99995785e+03  4.77676107e+04]
E1 = -182.57139795335632  E_coul = 54.03292829288645
cycle= 1 E= -128.53846966047  delta_E= -2.56e-13  |g|= 5.77e-07  |ddm|= 3.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57139795335632  E_coul = 54.03292829288645
  HOMO = -0.849527333154998  LUMO = 0.655439492194797
  mo_energy =
[-3.27736419e+01 -1.93054681e+00 -8.49527333e-01 -8.49527333e-01
 -8.49527333e-01  6.55439492e-01  6.55439492e-01  6.55439492e-01
  1.17385885e+00  3.01614251e+00  3.01614251e+00  3.01614251e+00
  7.24258853e+00  1.02581609e+01  1.02581609e+01  1.02581609e+01
  3.39252889e+01  3.39252889e+01  3.39252889e+01  3.45499433e+01
  1.32243001e+02  1.32243001e+02  1.32243001e+02  1.38632269e+02
  5.02690224e+02  1.87030232e+03  7.99995785e+03  4.77676107e+04]
E1 = -182.5713958195553  E_coul = 54.0329261590854
Extra cycle  E= -128.53846966047  delta_E= -2.84e-14  |g|= 2.89e-07  |ddm|= 1.96e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270977e+02 2.35735931e+02
 7.64253575e+01 1.00351327e+01 2.70446375e+01 3.78167233e-01
 1.10798463e+00 2.88006146e+00 4.98767545e+00 1.44951053e+01
 5.46819166e+01 2.29148480e-01 1.84610658e+00 6.70363653e-01]
grad_E = [ 4.58825331e-11 -2.44442885e-09  5.85163750e-08 -8.98418812e-07
  6.70521576e-06  4.33982366e-05 -9.73061767e-06 -1.16114495e-04
 -3.06204134e-04  7.05725494e-05 -1.27113282e-04  7.07182850e-06
 -2.08651653e-04  1.16030860e-04  3.53400669e-04 -4.63600224e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447338        1
[INPUT] 0    0    [1    /1   ]  833.270975561        1
[INPUT] 0    0    [1    /1   ]  235.735958019        1
[INPUT] 0    0    [1    /1   ]  76.4251582832        1
[INPUT] 0    0    [1    /1   ]  10.034643592         1
[INPUT] 0    0    [1    /1   ]  27.0447164396        1
[INPUT] 0    0    [1    /1   ]  0.37846783561        1
[INPUT] 0    0    [1    /1   ]  1.10873421567        1
[INPUT] 0    0    [1    /1   ]  2.88010022233        1
[INPUT] 1    0    [1    /1   ]  4.98213420276        1
[INPUT] 1    0    [1    /1   ]  14.4837014271        1
[INPUT] 1    0    [1    /1   ]  54.6918954556        1
[INPUT] 1    0    [1    /1   ]  0.228677291242       1
[INPUT] 1    0    [1    /1   ]  1.84520891989        1
[INPUT] 1    0    [1    /1   ]  0.669292066189       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129926508, 1.0]], [0, [3661.4544733831026, 1.0]], [0, [833.2709755605646, 1.0]], [0, [235.7359580188548, 1.0]], [0, [76.42515828319243, 1.0]], [0, [10.034643592001073, 1.0]], [0, [27.044716439625574, 1.0]], [0, [0.37846783560957226, 1.0]], [0, [1.108734215665498, 1.0]], [0, [2.880100222334697, 1.0]], [1, [4.982134202759403, 1.0]], [1, [14.483701427064869, 1.0]], [1, [54.69189545555666, 1.0]], [1, [0.22867729124185232, 1.0]], [1, [1.845208919894885, 1.0]], [1, [0.6692920661885284, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447338]
bas 2, expnt(s) = [833.27097556]
bas 3, expnt(s) = [235.73595802]
bas 4, expnt(s) = [76.42515828]
bas 5, expnt(s) = [10.03464359]
bas 6, expnt(s) = [27.04471644]
bas 7, expnt(s) = [0.37846784]
bas 8, expnt(s) = [1.10873422]
bas 9, expnt(s) = [2.88010022]
bas 10, expnt(s) = [4.9821342]
bas 11, expnt(s) = [14.48370143]
bas 12, expnt(s) = [54.69189546]
bas 13, expnt(s) = [0.22867729]
bas 14, expnt(s) = [1.84520892]
bas 15, expnt(s) = [0.66929207]
CPU time:       128.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270976e+02 3.91836344e+02 2.35735958e+02 1.51996784e+02
 7.64251583e+01 6.53043761e+01 1.00346436e+01 1.42443123e+01
 2.70447164e+01 2.99624173e+01 3.78467836e-01 1.21909277e+00
 1.10873422e+00 2.72983006e+00 2.88010022e+00 5.58561149e+00
 4.98213420e+00 2.17146918e+01 1.44837014e+01 8.24297242e+01
 5.46918955e+01 4.33898463e+02 2.28677291e-01 4.61331587e-01
 1.84520892e+00 6.27395391e+00 6.69292066e-01 1.76605404e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999816312842341
cond(S) = 341.5307190560267
E1 = -183.58644301806703  E_coul = 55.08011705589111
init E= -128.506325962176
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774951556709896  LUMO = 0.667507323926777
  mo_energy =
[-3.25551280e+01 -1.85258261e+00 -7.74951557e-01 -7.74951557e-01
 -7.74951557e-01  6.67507324e-01  6.67507324e-01  6.67507324e-01
  1.20647505e+00  3.06412605e+00  3.06412605e+00  3.06412605e+00
  7.33662236e+00  1.03543343e+01  1.03543343e+01  1.03543343e+01
  3.40577994e+01  3.40577994e+01  3.40577994e+01  3.47207678e+01
  1.32418032e+02  1.32418032e+02  1.32418032e+02  1.38850074e+02
  5.02940377e+02  1.87058282e+03  8.00026474e+03  4.77679353e+04]
E1 = -182.05756647967482  E_coul = 53.52272134736586
cycle= 1 E= -128.534845132309  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546599
diis-c [-0.29877004  1.        ]
  HOMO = -0.885633056642223  LUMO = 0.647344481421371
  mo_energy =
[-3.28832501e+01 -1.96866339e+00 -8.85633057e-01 -8.85633057e-01
 -8.85633057e-01  6.47344481e-01  6.47344481e-01  6.47344481e-01
  1.16027237e+00  2.98619923e+00  2.98619923e+00  2.98619923e+00
  7.20235901e+00  1.01935787e+01  1.01935787e+01  1.01935787e+01
  3.38052345e+01  3.38052345e+01  3.38052345e+01  3.44698064e+01
  1.32089414e+02  1.32089414e+02  1.32089414e+02  1.38527280e+02
  5.02573587e+02  1.87018008e+03  7.99983302e+03  4.77674848e+04]
E1 = -182.83567756652337  E_coul = 54.29816693037042
cycle= 2 E= -128.537510636153  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279322
diis-c [-6.41026294e-04  3.37512462e-01  6.62487538e-01]
  HOMO = -0.849266419764861  LUMO = 0.653968802838383
  mo_energy =
[-3.27731886e+01 -1.93034249e+00 -8.49266420e-01 -8.49266420e-01
 -8.49266420e-01  6.53968803e-01  6.53968803e-01  6.53968803e-01
  1.17513670e+00  3.01146823e+00  3.01146823e+00  3.01146823e+00
  7.24649714e+00  1.02467038e+01  1.02467038e+01  1.02467038e+01
  3.38898837e+01  3.38898837e+01  3.38898837e+01  3.45541498e+01
  1.32198939e+02  1.32198939e+02  1.32198939e+02  1.38635317e+02
  5.02692536e+02  1.87030433e+03  7.99995975e+03  4.77676125e+04]
E1 = -182.5708796632904  E_coul = 54.032408717575684
cycle= 3 E= -128.538470945715  delta_E= -0.00096  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000995559
diis-c [-1.06766101e-07 -2.06027679e-03 -6.63215155e-04  1.00272349e+00]
  HOMO = -0.849494479226515  LUMO = 0.653948482530139
  mo_energy =
[-3.27735873e+01 -1.93052209e+00 -8.49494479e-01 -8.49494479e-01
 -8.49494479e-01  6.53948483e-01  6.53948483e-01  6.53948483e-01
  1.17506896e+00  3.01134627e+00  3.01134627e+00  3.01134627e+00
  7.24630894e+00  1.02464770e+01  1.02464770e+01  1.02464770e+01
  3.38895648e+01  3.38895648e+01  3.38895648e+01  3.45538422e+01
  1.32198527e+02  1.32198527e+02  1.32198527e+02  1.38634917e+02
  5.02692026e+02  1.87030370e+03  7.99995903e+03  4.77676117e+04]
E1 = -182.57119684211474  E_coul = 54.032725879233254
cycle= 4 E= -128.538470962881  delta_E= -1.72e-08  |g|= 7.33e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184
diis-c [-7.09964024e-10  1.31831307e-04  5.10025655e-04 -1.41336820e-01
  1.14069496e+00]
  HOMO = -0.849534274481368  LUMO = 0.653938862821018
  mo_energy =
[-3.27736567e+01 -1.93055667e+00 -8.49534274e-01 -8.49534274e-01
 -8.49534274e-01  6.53938863e-01  6.53938863e-01  6.53938863e-01
  1.17504927e+00  3.01131431e+00  3.01131431e+00  3.01131431e+00
  7.24626531e+00  1.02464263e+01  1.02464263e+01  1.02464263e+01
  3.38895017e+01  3.38895017e+01  3.38895017e+01  3.45537800e+01
  1.32198458e+02  1.32198458e+02  1.32198458e+02  1.38634848e+02
  5.02691951e+02  1.87030362e+03  7.99995894e+03  4.77676116e+04]
E1 = -182.57132603988978  E_coul = 54.03285507649759
cycle= 5 E= -128.538470963392  delta_E= -5.11e-10  |g|= 2.98e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57132603988978  E_coul = 54.03285507649759
  HOMO = -0.849533050261851  LUMO = 0.65393909177601
  mo_energy =
[-3.27736538e+01 -1.93055494e+00 -8.49533050e-01 -8.49533050e-01
 -8.49533050e-01  6.53939092e-01  6.53939092e-01  6.53939092e-01
  1.17505002e+00  3.01131522e+00  3.01131522e+00  3.01131522e+00
  7.24626711e+00  1.02464281e+01  1.02464281e+01  1.02464281e+01
  3.38895042e+01  3.38895042e+01  3.38895042e+01  3.45537827e+01
  1.32198460e+02  1.32198460e+02  1.32198460e+02  1.38634850e+02
  5.02691954e+02  1.87030363e+03  7.99995895e+03  4.77676116e+04]
E1 = -182.57131812995675  E_coul = 54.03284716656368
Extra cycle  E= -128.538470963393  delta_E= -8.81e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270976e+02 2.35735958e+02
 7.64251583e+01 1.00346436e+01 2.70447164e+01 3.78467836e-01
 1.10873422e+00 2.88010022e+00 4.98213420e+00 1.44837014e+01
 5.46918955e+01 2.28677291e-01 1.84520892e+00 6.69292066e-01]
E = -128.53847096339308
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447338        1
[INPUT] 0    0    [1    /1   ]  833.270975561        1
[INPUT] 0    0    [1    /1   ]  235.735958019        1
[INPUT] 0    0    [1    /1   ]  76.4251582832        1
[INPUT] 0    0    [1    /1   ]  10.034643592         1
[INPUT] 0    0    [1    /1   ]  27.0447164396        1
[INPUT] 0    0    [1    /1   ]  0.37846783561        1
[INPUT] 0    0    [1    /1   ]  1.10873421567        1
[INPUT] 0    0    [1    /1   ]  2.88010022233        1
[INPUT] 1    0    [1    /1   ]  4.98213420276        1
[INPUT] 1    0    [1    /1   ]  14.4837014271        1
[INPUT] 1    0    [1    /1   ]  54.6918954556        1
[INPUT] 1    0    [1    /1   ]  0.228677291242       1
[INPUT] 1    0    [1    /1   ]  1.84520891989        1
[INPUT] 1    0    [1    /1   ]  0.669292066189       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129926508, 1.0]], [0, [3661.4544733831026, 1.0]], [0, [833.2709755605646, 1.0]], [0, [235.7359580188548, 1.0]], [0, [76.42515828319243, 1.0]], [0, [10.034643592001073, 1.0]], [0, [27.044716439625574, 1.0]], [0, [0.37846783560957226, 1.0]], [0, [1.108734215665498, 1.0]], [0, [2.880100222334697, 1.0]], [1, [4.982134202759403, 1.0]], [1, [14.483701427064869, 1.0]], [1, [54.69189545555666, 1.0]], [1, [0.22867729124185232, 1.0]], [1, [1.845208919894885, 1.0]], [1, [0.6692920661885284, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412993]
bas 1, expnt(s) = [3661.45447338]
bas 2, expnt(s) = [833.27097556]
bas 3, expnt(s) = [235.73595802]
bas 4, expnt(s) = [76.42515828]
bas 5, expnt(s) = [10.03464359]
bas 6, expnt(s) = [27.04471644]
bas 7, expnt(s) = [0.37846784]
bas 8, expnt(s) = [1.10873422]
bas 9, expnt(s) = [2.88010022]
bas 10, expnt(s) = [4.9821342]
bas 11, expnt(s) = [14.48370143]
bas 12, expnt(s) = [54.69189546]
bas 13, expnt(s) = [0.22867729]
bas 14, expnt(s) = [1.84520892]
bas 15, expnt(s) = [0.66929207]
CPU time:       128.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270976e+02 3.91836344e+02 2.35735958e+02 1.51996784e+02
 7.64251583e+01 6.53043761e+01 1.00346436e+01 1.42443123e+01
 2.70447164e+01 2.99624173e+01 3.78467836e-01 1.21909277e+00
 1.10873422e+00 2.72983006e+00 2.88010022e+00 5.58561149e+00
 4.98213420e+00 2.17146918e+01 1.44837014e+01 8.24297242e+01
 5.46918955e+01 4.33898463e+02 2.28677291e-01 4.61331587e-01
 1.84520892e+00 6.27395391e+00 6.69292066e-01 1.76605404e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999816312842341
cond(S) = 341.5307190560267
E1 = -183.58644301806703  E_coul = 55.08011705589111
init E= -128.506325962176
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774951556709896  LUMO = 0.667507323926777
  mo_energy =
[-3.25551280e+01 -1.85258261e+00 -7.74951557e-01 -7.74951557e-01
 -7.74951557e-01  6.67507324e-01  6.67507324e-01  6.67507324e-01
  1.20647505e+00  3.06412605e+00  3.06412605e+00  3.06412605e+00
  7.33662236e+00  1.03543343e+01  1.03543343e+01  1.03543343e+01
  3.40577994e+01  3.40577994e+01  3.40577994e+01  3.47207678e+01
  1.32418032e+02  1.32418032e+02  1.32418032e+02  1.38850074e+02
  5.02940377e+02  1.87058282e+03  8.00026474e+03  4.77679353e+04]
E1 = -182.05756647967482  E_coul = 53.52272134736586
cycle= 1 E= -128.534845132309  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546599
diis-c [-0.29877004  1.        ]
  HOMO = -0.885633056642223  LUMO = 0.647344481421371
  mo_energy =
[-3.28832501e+01 -1.96866339e+00 -8.85633057e-01 -8.85633057e-01
 -8.85633057e-01  6.47344481e-01  6.47344481e-01  6.47344481e-01
  1.16027237e+00  2.98619923e+00  2.98619923e+00  2.98619923e+00
  7.20235901e+00  1.01935787e+01  1.01935787e+01  1.01935787e+01
  3.38052345e+01  3.38052345e+01  3.38052345e+01  3.44698064e+01
  1.32089414e+02  1.32089414e+02  1.32089414e+02  1.38527280e+02
  5.02573587e+02  1.87018008e+03  7.99983302e+03  4.77674848e+04]
E1 = -182.83567756652337  E_coul = 54.29816693037042
cycle= 2 E= -128.537510636153  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279322
diis-c [-6.41026294e-04  3.37512462e-01  6.62487538e-01]
  HOMO = -0.849266419764861  LUMO = 0.653968802838383
  mo_energy =
[-3.27731886e+01 -1.93034249e+00 -8.49266420e-01 -8.49266420e-01
 -8.49266420e-01  6.53968803e-01  6.53968803e-01  6.53968803e-01
  1.17513670e+00  3.01146823e+00  3.01146823e+00  3.01146823e+00
  7.24649714e+00  1.02467038e+01  1.02467038e+01  1.02467038e+01
  3.38898837e+01  3.38898837e+01  3.38898837e+01  3.45541498e+01
  1.32198939e+02  1.32198939e+02  1.32198939e+02  1.38635317e+02
  5.02692536e+02  1.87030433e+03  7.99995975e+03  4.77676125e+04]
E1 = -182.5708796632904  E_coul = 54.032408717575684
cycle= 3 E= -128.538470945715  delta_E= -0.00096  |g|= 0.000429  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000995559
diis-c [-1.06766101e-07 -2.06027679e-03 -6.63215155e-04  1.00272349e+00]
  HOMO = -0.849494479226515  LUMO = 0.653948482530139
  mo_energy =
[-3.27735873e+01 -1.93052209e+00 -8.49494479e-01 -8.49494479e-01
 -8.49494479e-01  6.53948483e-01  6.53948483e-01  6.53948483e-01
  1.17506896e+00  3.01134627e+00  3.01134627e+00  3.01134627e+00
  7.24630894e+00  1.02464770e+01  1.02464770e+01  1.02464770e+01
  3.38895648e+01  3.38895648e+01  3.38895648e+01  3.45538422e+01
  1.32198527e+02  1.32198527e+02  1.32198527e+02  1.38634917e+02
  5.02692026e+02  1.87030370e+03  7.99995903e+03  4.77676117e+04]
E1 = -182.57119684211474  E_coul = 54.032725879233254
cycle= 4 E= -128.538470962881  delta_E= -1.72e-08  |g|= 7.33e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184
diis-c [-7.09964024e-10  1.31831307e-04  5.10025655e-04 -1.41336820e-01
  1.14069496e+00]
  HOMO = -0.849534274481368  LUMO = 0.653938862821018
  mo_energy =
[-3.27736567e+01 -1.93055667e+00 -8.49534274e-01 -8.49534274e-01
 -8.49534274e-01  6.53938863e-01  6.53938863e-01  6.53938863e-01
  1.17504927e+00  3.01131431e+00  3.01131431e+00  3.01131431e+00
  7.24626531e+00  1.02464263e+01  1.02464263e+01  1.02464263e+01
  3.38895017e+01  3.38895017e+01  3.38895017e+01  3.45537800e+01
  1.32198458e+02  1.32198458e+02  1.32198458e+02  1.38634848e+02
  5.02691951e+02  1.87030362e+03  7.99995894e+03  4.77676116e+04]
E1 = -182.57132603988978  E_coul = 54.03285507649759
cycle= 5 E= -128.538470963392  delta_E= -5.11e-10  |g|= 2.98e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57132603988978  E_coul = 54.03285507649759
  HOMO = -0.849533050261851  LUMO = 0.65393909177601
  mo_energy =
[-3.27736538e+01 -1.93055494e+00 -8.49533050e-01 -8.49533050e-01
 -8.49533050e-01  6.53939092e-01  6.53939092e-01  6.53939092e-01
  1.17505002e+00  3.01131522e+00  3.01131522e+00  3.01131522e+00
  7.24626711e+00  1.02464281e+01  1.02464281e+01  1.02464281e+01
  3.38895042e+01  3.38895042e+01  3.38895042e+01  3.45537827e+01
  1.32198460e+02  1.32198460e+02  1.32198460e+02  1.38634850e+02
  5.02691954e+02  1.87030363e+03  7.99995895e+03  4.77676116e+04]
E1 = -182.57131812995675  E_coul = 54.03284716656368
Extra cycle  E= -128.538470963393  delta_E= -8.81e-13  |g|= 1.09e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.5307190560267
E1 = -182.57131812995675  E_coul = 54.03284716656368
init E= -128.538470963393
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.849533627822417  LUMO = 0.653938986758543
  mo_energy =
[-3.27736555e+01 -1.93055547e+00 -8.49533628e-01 -8.49533628e-01
 -8.49533628e-01  6.53938987e-01  6.53938987e-01  6.53938987e-01
  1.17504983e+00  3.01131482e+00  3.01131482e+00  3.01131482e+00
  7.24626646e+00  1.02464273e+01  1.02464273e+01  1.02464273e+01
  3.38895029e+01  3.38895029e+01  3.38895029e+01  3.45537814e+01
  1.32198459e+02  1.32198459e+02  1.32198459e+02  1.38634849e+02
  5.02691952e+02  1.87030362e+03  7.99995894e+03  4.77676116e+04]
E1 = -182.57132228427037  E_coul = 54.03285132087736
cycle= 1 E= -128.538470963393  delta_E= 8.53e-14  |g|= 5.75e-07  |ddm|= 3.28e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57132228427037  E_coul = 54.03285132087736
  HOMO = -0.849533337646325  LUMO = 0.653939040197034
  mo_energy =
[-3.27736547e+01 -1.93055514e+00 -8.49533338e-01 -8.49533338e-01
 -8.49533338e-01  6.53939040e-01  6.53939040e-01  6.53939040e-01
  1.17504996e+00  3.01131502e+00  3.01131502e+00  3.01131502e+00
  7.24626683e+00  1.02464277e+01  1.02464277e+01  1.02464277e+01
  3.38895036e+01  3.38895036e+01  3.38895036e+01  3.45537821e+01
  1.32198460e+02  1.32198460e+02  1.32198460e+02  1.38634850e+02
  5.02691953e+02  1.87030363e+03  7.99995894e+03  4.77676116e+04]
E1 = -182.57132015844388  E_coul = 54.032849195050844
Extra cycle  E= -128.538470963393  delta_E= -2.84e-14  |g|= 2.88e-07  |ddm|= 1.96e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270976e+02 2.35735958e+02
 7.64251583e+01 1.00346436e+01 2.70447164e+01 3.78467836e-01
 1.10873422e+00 2.88010022e+00 4.98213420e+00 1.44837014e+01
 5.46918955e+01 2.28677291e-01 1.84520892e+00 6.69292066e-01]
grad_E = [ 3.96264322e-11 -2.11630263e-09  5.19678692e-08 -8.21714162e-07
  6.12146330e-06  3.65292466e-05 -6.91364356e-06 -9.36651225e-05
 -2.83680500e-04  6.57309211e-05 -2.24291910e-04  1.62977200e-05
 -2.08139400e-04  3.31935898e-04  6.81965747e-04 -9.89297067e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447359        1
[INPUT] 0    0    [1    /1   ]  833.270970428        1
[INPUT] 0    0    [1    /1   ]  235.736041307        1
[INPUT] 0    0    [1    /1   ]  76.4245532646        1
[INPUT] 0    0    [1    /1   ]  10.0333580925        1
[INPUT] 0    0    [1    /1   ]  27.0448709549        1
[INPUT] 0    0    [1    /1   ]  0.378960460439       1
[INPUT] 0    0    [1    /1   ]  1.10997632113        1
[INPUT] 0    0    [1    /1   ]  2.8803939754         1
[INPUT] 1    0    [1    /1   ]  4.97302493453        1
[INPUT] 1    0    [1    /1   ]  14.4651994412        1
[INPUT] 1    0    [1    /1   ]  54.7193882961        1
[INPUT] 1    0    [1    /1   ]  0.227934900392       1
[INPUT] 1    0    [1    /1   ]  1.84349711397        1
[INPUT] 1    0    [1    /1   ]  0.667516834172       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129922717, 1.0]], [0, [3661.4544735858785, 1.0]], [0, [833.2709704283081, 1.0]], [0, [235.7360413069923, 1.0]], [0, [76.42455326464953, 1.0]], [0, [10.033358092463123, 1.0]], [0, [27.04487095487545, 1.0]], [0, [0.37896046043853837, 1.0]], [0, [1.1099763211273828, 1.0]], [0, [2.8803939754041563, 1.0]], [1, [4.973024934534282, 1.0]], [1, [14.465199441241525, 1.0]], [1, [54.719388296147926, 1.0]], [1, [0.2279349003915766, 1.0]], [1, [1.8434971139706988, 1.0]], [1, [0.667516834171957, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412992]
bas 1, expnt(s) = [3661.45447359]
bas 2, expnt(s) = [833.27097043]
bas 3, expnt(s) = [235.73604131]
bas 4, expnt(s) = [76.42455326]
bas 5, expnt(s) = [10.03335809]
bas 6, expnt(s) = [27.04487095]
bas 7, expnt(s) = [0.37896046]
bas 8, expnt(s) = [1.10997632]
bas 9, expnt(s) = [2.88039398]
bas 10, expnt(s) = [4.97302493]
bas 11, expnt(s) = [14.46519944]
bas 12, expnt(s) = [54.7193883]
bas 13, expnt(s) = [0.2279349]
bas 14, expnt(s) = [1.84349711]
bas 15, expnt(s) = [0.66751683]
CPU time:       131.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270970e+02 3.91836342e+02 2.35736041e+02 1.51996824e+02
 7.64245533e+01 6.53039883e+01 1.00333581e+01 1.42429437e+01
 2.70448710e+01 2.99625457e+01 3.78960460e-01 1.22028268e+00
 1.10997632e+00 2.73212339e+00 2.88039398e+00 5.58603876e+00
 4.97302493e+00 2.16650746e+01 1.44651994e+01 8.22981220e+01
 5.47193883e+01 4.34171123e+02 2.27934900e-01 4.59460231e-01
 1.84349711e+00 6.26667930e+00 6.67516834e-01 1.76020063e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999817681046839
cond(S) = 341.8762728521796
E1 = -183.58644867865644  E_coul = 55.08011514291311
init E= -128.506333535743
    CPU time for initialize scf      0.05 sec, wall time      0.11 sec
  HOMO = -0.774952518911889  LUMO = 0.6650529237782
  mo_energy =
[-3.25551284e+01 -1.85258232e+00 -7.74952519e-01 -7.74952519e-01
 -7.74952519e-01  6.65052924e-01  6.65052924e-01  6.65052924e-01
  1.20848911e+00  3.05608692e+00  3.05608692e+00  3.05608692e+00
  7.34297374e+00  1.03344946e+01  1.03344946e+01  1.03344946e+01
  3.39984171e+01  3.39984171e+01  3.39984171e+01  3.47271362e+01
  1.32361690e+02  1.32361690e+02  1.32361690e+02  1.38853472e+02
  5.02941710e+02  1.87058328e+03  8.00026499e+03  4.77679355e+04]
E1 = -182.057369322369  E_coul = 53.52252170318152
cycle= 1 E= -128.534847619187  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546466
diis-c [-0.29862515  1.        ]
  HOMO = -0.885648762893999  LUMO = 0.644983646521003
  mo_energy =
[-3.28832851e+01 -1.96868310e+00 -8.85648763e-01 -8.85648763e-01
 -8.85648763e-01  6.44983647e-01  6.44983647e-01  6.44983647e-01
  1.16221727e+00  2.97826629e+00  2.97826629e+00  2.97826629e+00
  7.20866078e+00  1.01738369e+01  1.01738369e+01  1.01738369e+01
  3.37459152e+01  3.37459152e+01  3.37459152e+01  3.44761611e+01
  1.32033014e+02  1.32033014e+02  1.32033014e+02  1.38530647e+02
  5.02574885e+02  1.87018050e+03  7.99983323e+03  4.77674849e+04]
E1 = -182.8356295089336  E_coul = 54.29811595707805
cycle= 2 E= -128.537513551856  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279282
diis-c [-6.41150321e-04  3.37534023e-01  6.62465977e-01]
  HOMO = -0.849275850209188  LUMO = 0.651579069432775
  mo_energy =
[-3.27732084e+01 -1.93035508e+00 -8.49275850e-01 -8.49275850e-01
 -8.49275850e-01  6.51579069e-01  6.51579069e-01  6.51579069e-01
  1.17710503e+00  3.00350160e+00  3.00350160e+00  3.00350160e+00
  7.25281611e+00  1.02269306e+01  1.02269306e+01  1.02269306e+01
  3.38305455e+01  3.38305455e+01  3.38305455e+01  3.45605140e+01
  1.32142560e+02  1.32142560e+02  1.32142560e+02  1.38638699e+02
  5.02693851e+02  1.87030477e+03  7.99995998e+03  4.77676126e+04]
E1 = -182.57077515585175  E_coul = 54.03230092409464
cycle= 3 E= -128.538474231757  delta_E= -0.000961  |g|= 0.000428  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000991762
diis-c [-1.05827473e-07 -2.05656069e-03 -6.67761738e-04  1.00272432e+00]
  HOMO = -0.849503257444443  LUMO = 0.651559208064048
  mo_energy =
[-3.27736060e+01 -1.93053411e+00 -8.49503257e-01 -8.49503257e-01
 -8.49503257e-01  6.51559208e-01  6.51559208e-01  6.51559208e-01
  1.17703776e+00  3.00338051e+00  3.00338051e+00  3.00338051e+00
  7.25262848e+00  1.02267048e+01  1.02267048e+01  1.02267048e+01
  3.38302277e+01  3.38302277e+01  3.38302277e+01  3.45602074e+01
  1.32142150e+02  1.32142150e+02  1.32142150e+02  1.38638299e+02
  5.02693342e+02  1.87030415e+03  7.99995926e+03  4.77676119e+04]
E1 = -182.57109176466864  E_coul = 54.032617515946
cycle= 4 E= -128.538474248723  delta_E= -1.7e-08  |g|= 7.3e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183197
diis-c [-7.09063918e-10  1.31086261e-04  5.08306485e-04 -1.40940271e-01
  1.14030088e+00]
  HOMO = -0.849542868365103  LUMO = 0.651549686028346
  mo_energy =
[-3.27736750e+01 -1.93056852e+00 -8.49542868e-01 -8.49542868e-01
 -8.49542868e-01  6.51549686e-01  6.51549686e-01  6.51549686e-01
  1.17701816e+00  3.00334875e+00  3.00334875e+00  3.00334875e+00
  7.25258504e+00  1.02266543e+01  1.02266543e+01  1.02266543e+01
  3.38301648e+01  3.38301648e+01  3.38301648e+01  3.45601455e+01
  1.32142081e+02  1.32142081e+02  1.32142081e+02  1.38638230e+02
  5.02693267e+02  1.87030407e+03  7.99995918e+03  4.77676118e+04]
E1 = -182.57122057304417  E_coul = 54.032746323815736
cycle= 5 E= -128.538474249228  delta_E= -5.06e-10  |g|= 2.98e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57122057304417  E_coul = 54.032746323815736
  HOMO = -0.849541654267757  LUMO = 0.651549911075767
  mo_energy =
[-3.27736722e+01 -1.93056680e+00 -8.49541654e-01 -8.49541654e-01
 -8.49541654e-01  6.51549911e-01  6.51549911e-01  6.51549911e-01
  1.17701891e+00  3.00334964e+00  3.00334964e+00  3.00334964e+00
  7.25258683e+00  1.02266561e+01  1.02266561e+01  1.02266561e+01
  3.38301674e+01  3.38301674e+01  3.38301674e+01  3.45601481e+01
  1.32142083e+02  1.32142083e+02  1.32142083e+02  1.38638233e+02
  5.02693269e+02  1.87030407e+03  7.99995918e+03  4.77676118e+04]
E1 = -182.57121270646607  E_coul = 54.032738457236725
Extra cycle  E= -128.538474249229  delta_E= -9.09e-13  |g|= 1.08e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.19 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270970e+02 2.35736041e+02
 7.64245533e+01 1.00333581e+01 2.70448710e+01 3.78960460e-01
 1.10997632e+00 2.88039398e+00 4.97302493e+00 1.44651994e+01
 5.47193883e+01 2.27934900e-01 1.84349711e+00 6.67516834e-01]
E = -128.53847424922935
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447359        1
[INPUT] 0    0    [1    /1   ]  833.270970428        1
[INPUT] 0    0    [1    /1   ]  235.736041307        1
[INPUT] 0    0    [1    /1   ]  76.4245532646        1
[INPUT] 0    0    [1    /1   ]  10.0333580925        1
[INPUT] 0    0    [1    /1   ]  27.0448709549        1
[INPUT] 0    0    [1    /1   ]  0.378960460439       1
[INPUT] 0    0    [1    /1   ]  1.10997632113        1
[INPUT] 0    0    [1    /1   ]  2.8803939754         1
[INPUT] 1    0    [1    /1   ]  4.97302493453        1
[INPUT] 1    0    [1    /1   ]  14.4651994412        1
[INPUT] 1    0    [1    /1   ]  54.7193882961        1
[INPUT] 1    0    [1    /1   ]  0.227934900392       1
[INPUT] 1    0    [1    /1   ]  1.84349711397        1
[INPUT] 1    0    [1    /1   ]  0.667516834172       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129922717, 1.0]], [0, [3661.4544735858785, 1.0]], [0, [833.2709704283081, 1.0]], [0, [235.7360413069923, 1.0]], [0, [76.42455326464953, 1.0]], [0, [10.033358092463123, 1.0]], [0, [27.04487095487545, 1.0]], [0, [0.37896046043853837, 1.0]], [0, [1.1099763211273828, 1.0]], [0, [2.8803939754041563, 1.0]], [1, [4.973024934534282, 1.0]], [1, [14.465199441241525, 1.0]], [1, [54.719388296147926, 1.0]], [1, [0.2279349003915766, 1.0]], [1, [1.8434971139706988, 1.0]], [1, [0.667516834171957, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412992]
bas 1, expnt(s) = [3661.45447359]
bas 2, expnt(s) = [833.27097043]
bas 3, expnt(s) = [235.73604131]
bas 4, expnt(s) = [76.42455326]
bas 5, expnt(s) = [10.03335809]
bas 6, expnt(s) = [27.04487095]
bas 7, expnt(s) = [0.37896046]
bas 8, expnt(s) = [1.10997632]
bas 9, expnt(s) = [2.88039398]
bas 10, expnt(s) = [4.97302493]
bas 11, expnt(s) = [14.46519944]
bas 12, expnt(s) = [54.7193883]
bas 13, expnt(s) = [0.2279349]
bas 14, expnt(s) = [1.84349711]
bas 15, expnt(s) = [0.66751683]
CPU time:       132.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270970e+02 3.91836342e+02 2.35736041e+02 1.51996824e+02
 7.64245533e+01 6.53039883e+01 1.00333581e+01 1.42429437e+01
 2.70448710e+01 2.99625457e+01 3.78960460e-01 1.22028268e+00
 1.10997632e+00 2.73212339e+00 2.88039398e+00 5.58603876e+00
 4.97302493e+00 2.16650746e+01 1.44651994e+01 8.22981220e+01
 5.47193883e+01 4.34171123e+02 2.27934900e-01 4.59460231e-01
 1.84349711e+00 6.26667930e+00 6.67516834e-01 1.76020063e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999817681046839
cond(S) = 341.8762728521796
E1 = -183.58644867865644  E_coul = 55.08011514291311
init E= -128.506333535743
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774952518911889  LUMO = 0.6650529237782
  mo_energy =
[-3.25551284e+01 -1.85258232e+00 -7.74952519e-01 -7.74952519e-01
 -7.74952519e-01  6.65052924e-01  6.65052924e-01  6.65052924e-01
  1.20848911e+00  3.05608692e+00  3.05608692e+00  3.05608692e+00
  7.34297374e+00  1.03344946e+01  1.03344946e+01  1.03344946e+01
  3.39984171e+01  3.39984171e+01  3.39984171e+01  3.47271362e+01
  1.32361690e+02  1.32361690e+02  1.32361690e+02  1.38853472e+02
  5.02941710e+02  1.87058328e+03  8.00026499e+03  4.77679355e+04]
E1 = -182.057369322369  E_coul = 53.52252170318152
cycle= 1 E= -128.534847619187  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546466
diis-c [-0.29862515  1.        ]
  HOMO = -0.885648762893999  LUMO = 0.644983646521003
  mo_energy =
[-3.28832851e+01 -1.96868310e+00 -8.85648763e-01 -8.85648763e-01
 -8.85648763e-01  6.44983647e-01  6.44983647e-01  6.44983647e-01
  1.16221727e+00  2.97826629e+00  2.97826629e+00  2.97826629e+00
  7.20866078e+00  1.01738369e+01  1.01738369e+01  1.01738369e+01
  3.37459152e+01  3.37459152e+01  3.37459152e+01  3.44761611e+01
  1.32033014e+02  1.32033014e+02  1.32033014e+02  1.38530647e+02
  5.02574885e+02  1.87018050e+03  7.99983323e+03  4.77674849e+04]
E1 = -182.8356295089336  E_coul = 54.29811595707805
cycle= 2 E= -128.537513551856  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279282
diis-c [-6.41150321e-04  3.37534023e-01  6.62465977e-01]
  HOMO = -0.849275850209188  LUMO = 0.651579069432775
  mo_energy =
[-3.27732084e+01 -1.93035508e+00 -8.49275850e-01 -8.49275850e-01
 -8.49275850e-01  6.51579069e-01  6.51579069e-01  6.51579069e-01
  1.17710503e+00  3.00350160e+00  3.00350160e+00  3.00350160e+00
  7.25281611e+00  1.02269306e+01  1.02269306e+01  1.02269306e+01
  3.38305455e+01  3.38305455e+01  3.38305455e+01  3.45605140e+01
  1.32142560e+02  1.32142560e+02  1.32142560e+02  1.38638699e+02
  5.02693851e+02  1.87030477e+03  7.99995998e+03  4.77676126e+04]
E1 = -182.57077515585175  E_coul = 54.03230092409464
cycle= 3 E= -128.538474231757  delta_E= -0.000961  |g|= 0.000428  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000991762
diis-c [-1.05827473e-07 -2.05656069e-03 -6.67761738e-04  1.00272432e+00]
  HOMO = -0.849503257444443  LUMO = 0.651559208064048
  mo_energy =
[-3.27736060e+01 -1.93053411e+00 -8.49503257e-01 -8.49503257e-01
 -8.49503257e-01  6.51559208e-01  6.51559208e-01  6.51559208e-01
  1.17703776e+00  3.00338051e+00  3.00338051e+00  3.00338051e+00
  7.25262848e+00  1.02267048e+01  1.02267048e+01  1.02267048e+01
  3.38302277e+01  3.38302277e+01  3.38302277e+01  3.45602074e+01
  1.32142150e+02  1.32142150e+02  1.32142150e+02  1.38638299e+02
  5.02693342e+02  1.87030415e+03  7.99995926e+03  4.77676119e+04]
E1 = -182.57109176466864  E_coul = 54.032617515946
cycle= 4 E= -128.538474248723  delta_E= -1.7e-08  |g|= 7.3e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183197
diis-c [-7.09063918e-10  1.31086261e-04  5.08306485e-04 -1.40940271e-01
  1.14030088e+00]
  HOMO = -0.849542868365103  LUMO = 0.651549686028346
  mo_energy =
[-3.27736750e+01 -1.93056852e+00 -8.49542868e-01 -8.49542868e-01
 -8.49542868e-01  6.51549686e-01  6.51549686e-01  6.51549686e-01
  1.17701816e+00  3.00334875e+00  3.00334875e+00  3.00334875e+00
  7.25258504e+00  1.02266543e+01  1.02266543e+01  1.02266543e+01
  3.38301648e+01  3.38301648e+01  3.38301648e+01  3.45601455e+01
  1.32142081e+02  1.32142081e+02  1.32142081e+02  1.38638230e+02
  5.02693267e+02  1.87030407e+03  7.99995918e+03  4.77676118e+04]
E1 = -182.57122057304417  E_coul = 54.032746323815736
cycle= 5 E= -128.538474249228  delta_E= -5.06e-10  |g|= 2.98e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57122057304417  E_coul = 54.032746323815736
  HOMO = -0.849541654267757  LUMO = 0.651549911075767
  mo_energy =
[-3.27736722e+01 -1.93056680e+00 -8.49541654e-01 -8.49541654e-01
 -8.49541654e-01  6.51549911e-01  6.51549911e-01  6.51549911e-01
  1.17701891e+00  3.00334964e+00  3.00334964e+00  3.00334964e+00
  7.25258683e+00  1.02266561e+01  1.02266561e+01  1.02266561e+01
  3.38301674e+01  3.38301674e+01  3.38301674e+01  3.45601481e+01
  1.32142083e+02  1.32142083e+02  1.32142083e+02  1.38638233e+02
  5.02693269e+02  1.87030407e+03  7.99995918e+03  4.77676118e+04]
E1 = -182.57121270646607  E_coul = 54.032738457236725
Extra cycle  E= -128.538474249229  delta_E= -9.09e-13  |g|= 1.08e-06  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.8762728521796
E1 = -182.57121270646607  E_coul = 54.032738457236725
init E= -128.538474249229
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.849542229003547  LUMO = 0.651549806927464
  mo_energy =
[-3.27736739e+01 -1.93056732e+00 -8.49542229e-01 -8.49542229e-01
 -8.49542229e-01  6.51549807e-01  6.51549807e-01  6.51549807e-01
  1.17701872e+00  3.00334925e+00  3.00334925e+00  3.00334925e+00
  7.25258618e+00  1.02266553e+01  1.02266553e+01  1.02266553e+01
  3.38301661e+01  3.38301661e+01  3.38301661e+01  3.45601468e+01
  1.32142082e+02  1.32142082e+02  1.32142082e+02  1.38638231e+02
  5.02693268e+02  1.87030407e+03  7.99995918e+03  4.77676118e+04]
E1 = -182.57121683498153  E_coul = 54.032742585752146
cycle= 1 E= -128.538474249229  delta_E= -2.84e-14  |g|= 5.72e-07  |ddm|= 3.25e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57121683498153  E_coul = 54.032742585752146
  HOMO = -0.849541940688524  LUMO = 0.651549859767805
  mo_energy =
[-3.27736730e+01 -1.93056700e+00 -8.49541941e-01 -8.49541941e-01
 -8.49541941e-01  6.51549860e-01  6.51549860e-01  6.51549860e-01
  1.17701885e+00  3.00334945e+00  3.00334945e+00  3.00334945e+00
  7.25258654e+00  1.02266557e+01  1.02266557e+01  1.02266557e+01
  3.38301668e+01  3.38301668e+01  3.38301668e+01  3.45601475e+01
  1.32142082e+02  1.32142082e+02  1.32142082e+02  1.38638232e+02
  5.02693269e+02  1.87030407e+03  7.99995918e+03  4.77676118e+04]
E1 = -182.57121472179332  E_coul = 54.03274047256392
Extra cycle  E= -128.538474249229  delta_E= -2.84e-14  |g|= 2.86e-07  |ddm|= 1.95e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270970e+02 2.35736041e+02
 7.64245533e+01 1.00333581e+01 2.70448710e+01 3.78960460e-01
 1.10997632e+00 2.88039398e+00 4.97302493e+00 1.44651994e+01
 5.47193883e+01 2.27934900e-01 1.84349711e+00 6.67516834e-01]
grad_E = [ 2.42046138e-11 -1.30791727e-09  3.58675668e-08 -6.34467292e-07
  4.71628464e-06  2.13414143e-05 -3.09766291e-07 -5.59238609e-05
 -2.46643653e-04  5.89251915e-05 -3.68054774e-04  2.73828318e-05
 -2.06685113e-04  6.98274176e-04  1.18337682e-03 -1.81883633e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447418        1
[INPUT] 0    0    [1    /1   ]  833.270955504        1
[INPUT] 0    0    [1    /1   ]  235.736282793        1
[INPUT] 0    0    [1    /1   ]  76.4228108239        1
[INPUT] 0    0    [1    /1   ]  10.029976928         1
[INPUT] 0    0    [1    /1   ]  27.0451762348        1
[INPUT] 0    0    [1    /1   ]  0.379736864148       1
[INPUT] 0    0    [1    /1   ]  1.11197325487        1
[INPUT] 0    0    [1    /1   ]  2.88149876334        1
[INPUT] 1    0    [1    /1   ]  4.95906873838        1
[INPUT] 1    0    [1    /1   ]  14.4384106423        1
[INPUT] 1    0    [1    /1   ]  54.7939682154        1
[INPUT] 1    0    [1    /1   ]  0.22680104135        1
[INPUT] 1    0    [1    /1   ]  1.84080470789        1
[INPUT] 1    0    [1    /1   ]  0.664750953042       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412991167, 1.0]], [0, [3661.4544741763652, 1.0]], [0, [833.2709555040393, 1.0]], [0, [235.73628279341037, 1.0]], [0, [76.42281082386755, 1.0]], [0, [10.02997692804861, 1.0]], [0, [27.04517623483095, 1.0]], [0, [0.3797368641482487, 1.0]], [0, [1.1119732548664818, 1.0]], [0, [2.8814987633387283, 1.0]], [1, [4.9590687383779235, 1.0]], [1, [14.438410642253512, 1.0]], [1, [54.79396821537077, 1.0]], [1, [0.22680104134971749, 1.0]], [1, [1.8408047078904075, 1.0]], [1, [0.664750953042387, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412991]
bas 1, expnt(s) = [3661.45447418]
bas 2, expnt(s) = [833.2709555]
bas 3, expnt(s) = [235.73628279]
bas 4, expnt(s) = [76.42281082]
bas 5, expnt(s) = [10.02997693]
bas 6, expnt(s) = [27.04517623]
bas 7, expnt(s) = [0.37973686]
bas 8, expnt(s) = [1.11197325]
bas 9, expnt(s) = [2.88149876]
bas 10, expnt(s) = [4.95906874]
bas 11, expnt(s) = [14.43841064]
bas 12, expnt(s) = [54.79396822]
bas 13, expnt(s) = [0.22680104]
bas 14, expnt(s) = [1.84080471]
bas 15, expnt(s) = [0.66475095]
CPU time:       135.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270956e+02 3.91836337e+02 2.35736283e+02 1.51996941e+02
 7.64228108e+01 6.53028716e+01 1.00299769e+01 1.42393438e+01
 2.70451762e+01 2.99627994e+01 3.79736864e-01 1.22215727e+00
 1.11197325e+00 2.73580904e+00 2.88149876e+00 5.58764559e+00
 4.95906874e+00 2.15891007e+01 1.44384106e+01 8.21076513e+01
 5.47939682e+01 4.34910942e+02 2.26801041e-01 4.56605037e-01
 1.84080471e+00 6.25524087e+00 6.64750953e-01 1.75108853e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999819478578246
cond(S) = 342.42923317266457
E1 = -183.5864622731906  E_coul = 55.08010993827442
init E= -128.506352334916
    CPU time for initialize scf      0.04 sec, wall time      0.05 sec
  HOMO = -0.774954809969583  LUMO = 0.661290357299126
  mo_energy =
[-3.25551293e+01 -1.85258195e+00 -7.74954810e-01 -7.74954810e-01
 -7.74954810e-01  6.61290357e-01  6.61290357e-01  6.61290357e-01
  1.21170984e+00  3.04363666e+00  3.04363666e+00  3.04363666e+00
  7.35380220e+00  1.03038680e+01  1.03038680e+01  1.03038680e+01
  3.39087329e+01  3.39087329e+01  3.39087329e+01  3.47373617e+01
  1.32328920e+02  1.32328920e+02  1.32328920e+02  1.38856415e+02
  5.02939498e+02  1.87057920e+03  8.00026097e+03  4.77679321e+04]
E1 = -182.05709967271102  E_coul = 53.522244681975536
cycle= 1 E= -128.534854990735  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546232
diis-c [-0.29836889  1.        ]
  HOMO = -0.885671228910584  LUMO = 0.64136610656916
  mo_energy =
[-3.28833334e+01 -1.96871052e+00 -8.85671229e-01 -8.85671229e-01
 -8.85671229e-01  6.41366107e-01  6.41366107e-01  6.41366107e-01
  1.16532823e+00  2.96598433e+00  2.96598433e+00  2.96598433e+00
  7.21940595e+00  1.01433619e+01  1.01433619e+01  1.01433619e+01
  3.36563231e+01  3.36563231e+01  3.36563231e+01  3.44863743e+01
  1.32000135e+02  1.32000135e+02  1.32000135e+02  1.38533549e+02
  5.02572623e+02  1.87017637e+03  7.99982916e+03  4.77674815e+04]
E1 = -182.83557172453925  E_coul = 54.29805022446983
cycle= 2 E= -128.537521500069  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.279201
diis-c [-6.41300844e-04  3.37564923e-01  6.62435077e-01]
  HOMO = -0.849289392301312  LUMO = 0.647916849737644
  mo_energy =
[-3.27732354e+01 -1.93037232e+00 -8.49289392e-01 -8.49289392e-01
 -8.49289392e-01  6.47916850e-01  6.47916850e-01  6.47916850e-01
  1.18025339e+00  2.99116641e+00  2.99116641e+00  2.99116641e+00
  7.26359030e+00  1.01964069e+01  1.01964069e+01  1.01964069e+01
  3.37409260e+01  3.37409260e+01  3.37409260e+01  3.45707386e+01
  1.32109720e+02  1.32109720e+02  1.32109720e+02  1.38641620e+02
  5.02691611e+02  1.87030067e+03  7.99995593e+03  4.77676092e+04]
E1 = -182.5706382166159  E_coul = 54.032155514576665
cycle= 3 E= -128.538482702039  delta_E= -0.000961  |g|= 0.000426  |ddm|= 0.0223
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000986154
diis-c [-1.04377983e-07 -2.05061972e-03 -6.73223325e-04  1.00272384e+00]
  HOMO = -0.849515759345873  LUMO = 0.647897717631925
  mo_energy =
[-3.27736312e+01 -1.93055041e+00 -8.49515759e-01 -8.49515759e-01
 -8.49515759e-01  6.47897718e-01  6.47897718e-01  6.47897718e-01
  1.18018690e+00  2.99104671e+00  2.99104671e+00  2.99104671e+00
  7.26340361e+00  1.01961827e+01  1.01961827e+01  1.01961827e+01
  3.37406098e+01  3.37406098e+01  3.37406098e+01  3.45704335e+01
  1.32109311e+02  1.32109311e+02  1.32109311e+02  1.38641222e+02
  5.02691104e+02  1.87030004e+03  7.99995522e+03  4.77676084e+04]
E1 = -182.57095438054046  E_coul = 54.03247166185175
cycle= 4 E= -128.538482718689  delta_E= -1.66e-08  |g|= 7.25e-05  |ddm|= 0.000217
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000181962
diis-c [-7.08249233e-10  1.29994094e-04  5.05585367e-04 -1.40348928e-01
  1.13971335e+00]
  HOMO = -0.84955507152031  LUMO = 0.647888351717152
  mo_energy =
[-3.27736998e+01 -1.93058453e+00 -8.49555072e-01 -8.49555072e-01
 -8.49555072e-01  6.47888352e-01  6.47888352e-01  6.47888352e-01
  1.18016747e+00  2.99101528e+00  2.99101528e+00  2.99101528e+00
  7.26336047e+00  1.01961327e+01  1.01961327e+01  1.01961327e+01
  3.37405475e+01  3.37405475e+01  3.37405475e+01  3.45703721e+01
  1.32109242e+02  1.32109242e+02  1.32109242e+02  1.38641154e+02
  5.02691030e+02  1.87029996e+03  7.99995514e+03  4.77676083e+04]
E1 = -182.57108262401852  E_coul = 54.03259990483118
cycle= 5 E= -128.538482719187  delta_E= -4.99e-10  |g|= 2.98e-06  |ddm|= 3.1e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57108262401852  E_coul = 54.03259990483118
  HOMO = -0.849553871576045  LUMO = 0.647888571261533
  mo_energy =
[-3.27736970e+01 -1.93058283e+00 -8.49553872e-01 -8.49553872e-01
 -8.49553872e-01  6.47888571e-01  6.47888571e-01  6.47888571e-01
  1.18016822e+00  2.99101615e+00  2.99101615e+00  2.99101615e+00
  7.26336224e+00  1.01961344e+01  1.01961344e+01  1.01961344e+01
  3.37405500e+01  3.37405500e+01  3.37405500e+01  3.45703747e+01
  1.32109245e+02  1.32109245e+02  1.32109245e+02  1.38641156e+02
  5.02691032e+02  1.87029996e+03  7.99995514e+03  4.77676083e+04]
E1 = -182.57107482369065  E_coul = 54.03259210450266
Extra cycle  E= -128.538482719188  delta_E= -6.54e-13  |g|= 1.07e-06  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.17 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270956e+02 2.35736283e+02
 7.64228108e+01 1.00299769e+01 2.70451762e+01 3.79736864e-01
 1.11197325e+00 2.88149876e+00 4.95906874e+00 1.44384106e+01
 5.47939682e+01 2.26801041e-01 1.84080471e+00 6.64750953e-01]
E = -128.53848271918798
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447418        1
[INPUT] 0    0    [1    /1   ]  833.270955504        1
[INPUT] 0    0    [1    /1   ]  235.736282793        1
[INPUT] 0    0    [1    /1   ]  76.4228108239        1
[INPUT] 0    0    [1    /1   ]  10.029976928         1
[INPUT] 0    0    [1    /1   ]  27.0451762348        1
[INPUT] 0    0    [1    /1   ]  0.379736864148       1
[INPUT] 0    0    [1    /1   ]  1.11197325487        1
[INPUT] 0    0    [1    /1   ]  2.88149876334        1
[INPUT] 1    0    [1    /1   ]  4.95906873838        1
[INPUT] 1    0    [1    /1   ]  14.4384106423        1
[INPUT] 1    0    [1    /1   ]  54.7939682154        1
[INPUT] 1    0    [1    /1   ]  0.22680104135        1
[INPUT] 1    0    [1    /1   ]  1.84080470789        1
[INPUT] 1    0    [1    /1   ]  0.664750953042       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412991167, 1.0]], [0, [3661.4544741763652, 1.0]], [0, [833.2709555040393, 1.0]], [0, [235.73628279341037, 1.0]], [0, [76.42281082386755, 1.0]], [0, [10.02997692804861, 1.0]], [0, [27.04517623483095, 1.0]], [0, [0.3797368641482487, 1.0]], [0, [1.1119732548664818, 1.0]], [0, [2.8814987633387283, 1.0]], [1, [4.9590687383779235, 1.0]], [1, [14.438410642253512, 1.0]], [1, [54.79396821537077, 1.0]], [1, [0.22680104134971749, 1.0]], [1, [1.8408047078904075, 1.0]], [1, [0.664750953042387, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412991]
bas 1, expnt(s) = [3661.45447418]
bas 2, expnt(s) = [833.2709555]
bas 3, expnt(s) = [235.73628279]
bas 4, expnt(s) = [76.42281082]
bas 5, expnt(s) = [10.02997693]
bas 6, expnt(s) = [27.04517623]
bas 7, expnt(s) = [0.37973686]
bas 8, expnt(s) = [1.11197325]
bas 9, expnt(s) = [2.88149876]
bas 10, expnt(s) = [4.95906874]
bas 11, expnt(s) = [14.43841064]
bas 12, expnt(s) = [54.79396822]
bas 13, expnt(s) = [0.22680104]
bas 14, expnt(s) = [1.84080471]
bas 15, expnt(s) = [0.66475095]
CPU time:       136.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33270956e+02 3.91836337e+02 2.35736283e+02 1.51996941e+02
 7.64228108e+01 6.53028716e+01 1.00299769e+01 1.42393438e+01
 2.70451762e+01 2.99627994e+01 3.79736864e-01 1.22215727e+00
 1.11197325e+00 2.73580904e+00 2.88149876e+00 5.58764559e+00
 4.95906874e+00 2.15891007e+01 1.44384106e+01 8.21076513e+01
 5.47939682e+01 4.34910942e+02 2.26801041e-01 4.56605037e-01
 1.84080471e+00 6.25524087e+00 6.64750953e-01 1.75108853e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999819478578246
cond(S) = 342.42923317266457
E1 = -183.5864622731906  E_coul = 55.08010993827442
init E= -128.506352334916
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774954809969583  LUMO = 0.661290357299126
  mo_energy =
[-3.25551293e+01 -1.85258195e+00 -7.74954810e-01 -7.74954810e-01
 -7.74954810e-01  6.61290357e-01  6.61290357e-01  6.61290357e-01
  1.21170984e+00  3.04363666e+00  3.04363666e+00  3.04363666e+00
  7.35380220e+00  1.03038680e+01  1.03038680e+01  1.03038680e+01
  3.39087329e+01  3.39087329e+01  3.39087329e+01  3.47373617e+01
  1.32328920e+02  1.32328920e+02  1.32328920e+02  1.38856415e+02
  5.02939498e+02  1.87057920e+03  8.00026097e+03  4.77679321e+04]
E1 = -182.05709967271102  E_coul = 53.522244681975536
cycle= 1 E= -128.534854990735  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.546232
diis-c [-0.29836889  1.        ]
  HOMO = -0.885671228910584  LUMO = 0.64136610656916
  mo_energy =
[-3.28833334e+01 -1.96871052e+00 -8.85671229e-01 -8.85671229e-01
 -8.85671229e-01  6.41366107e-01  6.41366107e-01  6.41366107e-01
  1.16532823e+00  2.96598433e+00  2.96598433e+00  2.96598433e+00
  7.21940595e+00  1.01433619e+01  1.01433619e+01  1.01433619e+01
  3.36563231e+01  3.36563231e+01  3.36563231e+01  3.44863743e+01
  1.32000135e+02  1.32000135e+02  1.32000135e+02  1.38533549e+02
  5.02572623e+02  1.87017637e+03  7.99982916e+03  4.77674815e+04]
E1 = -182.83557172453925  E_coul = 54.29805022446983
cycle= 2 E= -128.537521500069  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279201
diis-c [-6.41300844e-04  3.37564923e-01  6.62435077e-01]
  HOMO = -0.849289392301312  LUMO = 0.647916849737644
  mo_energy =
[-3.27732354e+01 -1.93037232e+00 -8.49289392e-01 -8.49289392e-01
 -8.49289392e-01  6.47916850e-01  6.47916850e-01  6.47916850e-01
  1.18025339e+00  2.99116641e+00  2.99116641e+00  2.99116641e+00
  7.26359030e+00  1.01964069e+01  1.01964069e+01  1.01964069e+01
  3.37409260e+01  3.37409260e+01  3.37409260e+01  3.45707386e+01
  1.32109720e+02  1.32109720e+02  1.32109720e+02  1.38641620e+02
  5.02691611e+02  1.87030067e+03  7.99995593e+03  4.77676092e+04]
E1 = -182.5706382166159  E_coul = 54.032155514576665
cycle= 3 E= -128.538482702039  delta_E= -0.000961  |g|= 0.000426  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000986154
diis-c [-1.04377983e-07 -2.05061972e-03 -6.73223325e-04  1.00272384e+00]
  HOMO = -0.849515759345873  LUMO = 0.647897717631925
  mo_energy =
[-3.27736312e+01 -1.93055041e+00 -8.49515759e-01 -8.49515759e-01
 -8.49515759e-01  6.47897718e-01  6.47897718e-01  6.47897718e-01
  1.18018690e+00  2.99104671e+00  2.99104671e+00  2.99104671e+00
  7.26340361e+00  1.01961827e+01  1.01961827e+01  1.01961827e+01
  3.37406098e+01  3.37406098e+01  3.37406098e+01  3.45704335e+01
  1.32109311e+02  1.32109311e+02  1.32109311e+02  1.38641222e+02
  5.02691104e+02  1.87030004e+03  7.99995522e+03  4.77676084e+04]
E1 = -182.57095438054046  E_coul = 54.03247166185175
cycle= 4 E= -128.538482718689  delta_E= -1.66e-08  |g|= 7.25e-05  |ddm|= 0.000217
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181962
diis-c [-7.08249233e-10  1.29994094e-04  5.05585367e-04 -1.40348928e-01
  1.13971335e+00]
  HOMO = -0.84955507152031  LUMO = 0.647888351717152
  mo_energy =
[-3.27736998e+01 -1.93058453e+00 -8.49555072e-01 -8.49555072e-01
 -8.49555072e-01  6.47888352e-01  6.47888352e-01  6.47888352e-01
  1.18016747e+00  2.99101528e+00  2.99101528e+00  2.99101528e+00
  7.26336047e+00  1.01961327e+01  1.01961327e+01  1.01961327e+01
  3.37405475e+01  3.37405475e+01  3.37405475e+01  3.45703721e+01
  1.32109242e+02  1.32109242e+02  1.32109242e+02  1.38641154e+02
  5.02691030e+02  1.87029996e+03  7.99995514e+03  4.77676083e+04]
E1 = -182.57108262401852  E_coul = 54.03259990483118
cycle= 5 E= -128.538482719187  delta_E= -4.99e-10  |g|= 2.98e-06  |ddm|= 3.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57108262401852  E_coul = 54.03259990483118
  HOMO = -0.849553871576045  LUMO = 0.647888571261533
  mo_energy =
[-3.27736970e+01 -1.93058283e+00 -8.49553872e-01 -8.49553872e-01
 -8.49553872e-01  6.47888571e-01  6.47888571e-01  6.47888571e-01
  1.18016822e+00  2.99101615e+00  2.99101615e+00  2.99101615e+00
  7.26336224e+00  1.01961344e+01  1.01961344e+01  1.01961344e+01
  3.37405500e+01  3.37405500e+01  3.37405500e+01  3.45703747e+01
  1.32109245e+02  1.32109245e+02  1.32109245e+02  1.38641156e+02
  5.02691032e+02  1.87029996e+03  7.99995514e+03  4.77676083e+04]
E1 = -182.57107482369065  E_coul = 54.03259210450266
Extra cycle  E= -128.538482719188  delta_E= -6.54e-13  |g|= 1.07e-06  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 342.42923317266457
E1 = -182.57107482369065  E_coul = 54.03259210450266
init E= -128.538482719188
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.84955444199288  LUMO = 0.647888468475097
  mo_energy =
[-3.27736986e+01 -1.93058334e+00 -8.49554442e-01 -8.49554442e-01
 -8.49554442e-01  6.47888468e-01  6.47888468e-01  6.47888468e-01
  1.18016803e+00  2.99101576e+00  2.99101576e+00  2.99101576e+00
  7.26336161e+00  1.01961336e+01  1.01961336e+01  1.01961336e+01
  3.37405487e+01  3.37405487e+01  3.37405487e+01  3.45703734e+01
  1.32109243e+02  1.32109243e+02  1.32109243e+02  1.38641155e+02
  5.02691031e+02  1.87029996e+03  7.99995514e+03  4.77676083e+04]
E1 = -182.5710789140665  E_coul = 54.03259619487841
cycle= 1 E= -128.538482719188  delta_E= -1.14e-13  |g|= 5.67e-07  |ddm|= 3.22e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5710789140665  E_coul = 54.03259619487841
  HOMO = -0.84955415643478  LUMO = 0.647888520426106
  mo_energy =
[-3.27736978e+01 -1.93058302e+00 -8.49554156e-01 -8.49554156e-01
 -8.49554156e-01  6.47888520e-01  6.47888520e-01  6.47888520e-01
  1.18016815e+00  2.99101596e+00  2.99101596e+00  2.99101596e+00
  7.26336196e+00  1.01961340e+01  1.01961340e+01  1.01961340e+01
  3.37405494e+01  3.37405494e+01  3.37405494e+01  3.45703741e+01
  1.32109244e+02  1.32109244e+02  1.32109244e+02  1.38641156e+02
  5.02691031e+02  1.87029996e+03  7.99995514e+03  4.77676083e+04]
E1 = -182.5710768197748  E_coul = 54.0325941005866
Extra cycle  E= -128.538482719188  delta_E= -8.53e-14  |g|= 2.83e-07  |ddm|= 1.93e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145447e+03 8.33270956e+02 2.35736283e+02
 7.64228108e+01 1.00299769e+01 2.70451762e+01 3.79736864e-01
 1.11197325e+00 2.88149876e+00 4.95906874e+00 1.44384106e+01
 5.47939682e+01 2.26801041e-01 1.84080471e+00 6.64750953e-01]
grad_E = [-1.45537615e-11  7.22991168e-10 -4.51298925e-09 -1.67327110e-07
  1.24936752e-06 -1.35585058e-05  1.56503768e-05  4.45891804e-06
 -1.87338329e-04  5.12999624e-05 -5.85821860e-04  4.04154967e-05
 -2.03256028e-04  1.31315286e-03  1.96235349e-03 -3.14151293e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447579        1
[INPUT] 0    0    [1    /1   ]  833.2709147          1
[INPUT] 0    0    [1    /1   ]  235.736941934        1
[INPUT] 0    0    [1    /1   ]  76.4180741417        1
[INPUT] 0    0    [1    /1   ]  10.0213038666        1
[INPUT] 0    0    [1    /1   ]  27.0457723256        1
[INPUT] 0    0    [1    /1   ]  0.38091065235        1
[INPUT] 0    0    [1    /1   ]  1.11509352476        1
[INPUT] 0    0    [1    /1   ]  2.88484642385        1
[INPUT] 1    0    [1    /1   ]  4.94143795948        1
[INPUT] 1    0    [1    /1   ]  14.4101380541        1
[INPUT] 1    0    [1    /1   ]  54.9889985367        1
[INPUT] 1    0    [1    /1   ]  0.225242208843       1
[INPUT] 1    0    [1    /1   ]  1.83790663576        1
[INPUT] 1    0    [1    /1   ]  0.661022507978       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129881433, 1.0]], [0, [3661.4544757920517, 1.0]], [0, [833.2709146995142, 1.0]], [0, [235.73694193372722, 1.0]], [0, [76.41807414165102, 1.0]], [0, [10.021303866607523, 1.0]], [0, [27.04577232564823, 1.0]], [0, [0.38091065234992033, 1.0]], [0, [1.1150935247649185, 1.0]], [0, [2.8848464238498686, 1.0]], [1, [4.941437959479475, 1.0]], [1, [14.41013805408209, 1.0]], [1, [54.98899853668735, 1.0]], [1, [0.22524220884283236, 1.0]], [1, [1.837906635764182, 1.0]], [1, [0.6610225079777364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412988]
bas 1, expnt(s) = [3661.45447579]
bas 2, expnt(s) = [833.2709147]
bas 3, expnt(s) = [235.73694193]
bas 4, expnt(s) = [76.41807414]
bas 5, expnt(s) = [10.02130387]
bas 6, expnt(s) = [27.04577233]
bas 7, expnt(s) = [0.38091065]
bas 8, expnt(s) = [1.11509352]
bas 9, expnt(s) = [2.88484642]
bas 10, expnt(s) = [4.94143796]
bas 11, expnt(s) = [14.41013805]
bas 12, expnt(s) = [54.98899854]
bas 13, expnt(s) = [0.22524221]
bas 14, expnt(s) = [1.83790664]
bas 15, expnt(s) = [0.66102251]
CPU time:       139.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145448e+03 1.18920097e+03
 8.33270915e+02 3.91836322e+02 2.35736942e+02 1.51997260e+02
 7.64180741e+01 6.52998360e+01 1.00213039e+01 1.42301080e+01
 2.70457723e+01 2.99632947e+01 3.80910652e-01 1.22498949e+00
 1.11509352e+00 2.74156467e+00 2.88484642e+00 5.59251359e+00
 4.94143796e+00 2.14931998e+01 1.44101381e+01 8.19067266e+01
 5.49889985e+01 4.36846797e+02 2.25242209e-01 4.52685532e-01
 1.83790664e+00 6.24293337e+00 6.61022508e-01 1.73882030e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999821098872836
cond(S) = 343.2864375171164
E1 = -183.58649621733866  E_coul = 55.0800975584073
init E= -128.506398658931
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77496029625915  LUMO = 0.656152267289992
  mo_energy =
[-3.25551307e+01 -1.85258154e+00 -7.74960296e-01 -7.74960296e-01
 -7.74960296e-01  6.56152267e-01  6.56152267e-01  6.56152267e-01
  1.21670072e+00  3.02712914e+00  3.02712914e+00  3.02712914e+00
  7.37230536e+00  1.02654259e+01  1.02654259e+01  1.02654259e+01
  3.38020312e+01  3.38020312e+01  3.38020312e+01  3.47532548e+01
  1.32457811e+02  1.32457811e+02  1.32457811e+02  1.38854397e+02
  5.02924607e+02  1.87056017e+03  8.00024306e+03  4.77679171e+04]
E1 = -182.05680151718474  E_coul = 53.52192620852956
cycle= 1 E= -128.534875308655  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545806
diis-c [-0.29790368  1.        ]
  HOMO = -0.88569930370896  LUMO = 0.636427409112568
  mo_energy =
[-3.28833878e+01 -1.96874246e+00 -8.85699304e-01 -8.85699304e-01
 -8.85699304e-01  6.36427409e-01  6.36427409e-01  6.36427409e-01
  1.17015091e+00  2.94969043e+00  2.94969043e+00  2.94969043e+00
  7.23777007e+00  1.01050948e+01  1.01050948e+01  1.01050948e+01
  3.35497117e+01  3.35497117e+01  3.35497117e+01  3.45022733e+01
  1.32128814e+02  1.32128814e+02  1.32128814e+02  1.38531488e+02
  5.02557674e+02  1.87015728e+03  7.99981120e+03  4.77674664e+04]
E1 = -182.83552730353804  E_coul = 54.297984901019696
cycle= 2 E= -128.537542402518  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279032
diis-c [-6.41460140e-04  3.37603134e-01  6.62396866e-01]
  HOMO = -0.849306796925498  LUMO = 0.64291716453088
  mo_energy =
[-3.27732648e+01 -1.93039189e+00 -8.49306797e-01 -8.49306797e-01
 -8.49306797e-01  6.42917165e-01  6.42917165e-01  6.42917165e-01
  1.18513364e+00  2.97480553e+00  2.97480553e+00  2.97480553e+00
  7.28200287e+00  1.01580844e+01  1.01580844e+01  1.01580844e+01
  3.36342895e+01  3.36342895e+01  3.36342895e+01  3.45866454e+01
  1.32238468e+02  1.32238468e+02  1.32238468e+02  1.38639579e+02
  5.02676687e+02  1.87028160e+03  7.99993800e+03  4.77675941e+04]
E1 = -182.57050063561434  E_coul = 54.031996411371075
cycle= 3 E= -128.538504224243  delta_E= -0.000962  |g|= 0.000422  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000979045
diis-c [-1.02291058e-07 -2.04200896e-03 -6.76731689e-04  1.00271874e+00]
  HOMO = -0.849531662446925  LUMO = 0.642899107635704
  mo_energy =
[-3.27736582e+01 -1.93056854e+00 -8.49531662e-01 -8.49531662e-01
 -8.49531662e-01  6.42899108e-01  6.42899108e-01  6.42899108e-01
  1.18506837e+00  2.97468784e+00  2.97468784e+00  2.97468784e+00
  7.28181751e+00  1.01578623e+01  1.01578623e+01  1.01578623e+01
  3.36339755e+01  3.36339755e+01  3.36339755e+01  3.45863425e+01
  1.32238062e+02  1.32238062e+02  1.32238062e+02  1.38639184e+02
  5.02676183e+02  1.87028098e+03  7.99993729e+03  4.77675934e+04]
E1 = -182.57081753516124  E_coul = 54.03231329473162
cycle= 4 E= -128.53850424043  delta_E= -1.62e-08  |g|= 7.17e-05  |ddm|= 0.000213
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180208
diis-c [-7.08322131e-10  1.28572659e-04  5.01438049e-04 -1.39535782e-01
  1.13890577e+00]
  HOMO = -0.849570512597808  LUMO = 0.642889975127075
  mo_energy =
[-3.27737260e+01 -1.93060219e+00 -8.49570513e-01 -8.49570513e-01
 -8.49570513e-01  6.42889975e-01  6.42889975e-01  6.42889975e-01
  1.18504922e+00  2.97465690e+00  2.97465690e+00  2.97465690e+00
  7.28177485e+00  1.01578129e+01  1.01578129e+01  1.01578129e+01
  3.36339139e+01  3.36339139e+01  3.36339139e+01  3.45862818e+01
  1.32237994e+02  1.32237994e+02  1.32237994e+02  1.38639117e+02
  5.02676110e+02  1.87028090e+03  7.99993720e+03  4.77675933e+04]
E1 = -182.57094507597333  E_coul = 54.032440835056775
cycle= 5 E= -128.538504240917  delta_E= -4.87e-10  |g|= 2.98e-06  |ddm|= 3.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57094507597333  E_coul = 54.032440835056775
  HOMO = -0.849569328867964  LUMO = 0.642890188307982
  mo_energy =
[-3.27737232e+01 -1.93060049e+00 -8.49569329e-01 -8.49569329e-01
 -8.49569329e-01  6.42890188e-01  6.42890188e-01  6.42890188e-01
  1.18504997e+00  2.97465776e+00  2.97465776e+00  2.97465776e+00
  7.28177661e+00  1.01578146e+01  1.01578146e+01  1.01578146e+01
  3.36339164e+01  3.36339164e+01  3.36339164e+01  3.45862843e+01
  1.32237996e+02  1.32237996e+02  1.32237996e+02  1.38639119e+02
  5.02676112e+02  1.87028090e+03  7.99993721e+03  4.77675933e+04]
E1 = -182.57093736820156  E_coul = 54.03243312728431
Extra cycle  E= -128.538504240917  delta_E= -6.82e-13  |g|= 1.06e-06  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145448e+03 8.33270915e+02 2.35736942e+02
 7.64180741e+01 1.00213039e+01 2.70457723e+01 3.80910652e-01
 1.11509352e+00 2.88484642e+00 4.94143796e+00 1.44101381e+01
 5.49889985e+01 2.25242209e-01 1.83790664e+00 6.61022508e-01]
E = -128.53850424091723
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447579        1
[INPUT] 0    0    [1    /1   ]  833.2709147          1
[INPUT] 0    0    [1    /1   ]  235.736941934        1
[INPUT] 0    0    [1    /1   ]  76.4180741417        1
[INPUT] 0    0    [1    /1   ]  10.0213038666        1
[INPUT] 0    0    [1    /1   ]  27.0457723256        1
[INPUT] 0    0    [1    /1   ]  0.38091065235        1
[INPUT] 0    0    [1    /1   ]  1.11509352476        1
[INPUT] 0    0    [1    /1   ]  2.88484642385        1
[INPUT] 1    0    [1    /1   ]  4.94143795948        1
[INPUT] 1    0    [1    /1   ]  14.4101380541        1
[INPUT] 1    0    [1    /1   ]  54.9889985367        1
[INPUT] 1    0    [1    /1   ]  0.225242208843       1
[INPUT] 1    0    [1    /1   ]  1.83790663576        1
[INPUT] 1    0    [1    /1   ]  0.661022507978       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794129881433, 1.0]], [0, [3661.4544757920517, 1.0]], [0, [833.2709146995142, 1.0]], [0, [235.73694193372722, 1.0]], [0, [76.41807414165102, 1.0]], [0, [10.021303866607523, 1.0]], [0, [27.04577232564823, 1.0]], [0, [0.38091065234992033, 1.0]], [0, [1.1150935247649185, 1.0]], [0, [2.8848464238498686, 1.0]], [1, [4.941437959479475, 1.0]], [1, [14.41013805408209, 1.0]], [1, [54.98899853668735, 1.0]], [1, [0.22524220884283236, 1.0]], [1, [1.837906635764182, 1.0]], [1, [0.6610225079777364, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412988]
bas 1, expnt(s) = [3661.45447579]
bas 2, expnt(s) = [833.2709147]
bas 3, expnt(s) = [235.73694193]
bas 4, expnt(s) = [76.41807414]
bas 5, expnt(s) = [10.02130387]
bas 6, expnt(s) = [27.04577233]
bas 7, expnt(s) = [0.38091065]
bas 8, expnt(s) = [1.11509352]
bas 9, expnt(s) = [2.88484642]
bas 10, expnt(s) = [4.94143796]
bas 11, expnt(s) = [14.41013805]
bas 12, expnt(s) = [54.98899854]
bas 13, expnt(s) = [0.22524221]
bas 14, expnt(s) = [1.83790664]
bas 15, expnt(s) = [0.66102251]
CPU time:       140.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145448e+03 1.18920097e+03
 8.33270915e+02 3.91836322e+02 2.35736942e+02 1.51997260e+02
 7.64180741e+01 6.52998360e+01 1.00213039e+01 1.42301080e+01
 2.70457723e+01 2.99632947e+01 3.80910652e-01 1.22498949e+00
 1.11509352e+00 2.74156467e+00 2.88484642e+00 5.59251359e+00
 4.94143796e+00 2.14931998e+01 1.44101381e+01 8.19067266e+01
 5.49889985e+01 4.36846797e+02 2.25242209e-01 4.52685532e-01
 1.83790664e+00 6.24293337e+00 6.61022508e-01 1.73882030e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999821098872836
cond(S) = 343.2864375171164
E1 = -183.58649621733866  E_coul = 55.0800975584073
init E= -128.506398658931
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77496029625915  LUMO = 0.656152267289992
  mo_energy =
[-3.25551307e+01 -1.85258154e+00 -7.74960296e-01 -7.74960296e-01
 -7.74960296e-01  6.56152267e-01  6.56152267e-01  6.56152267e-01
  1.21670072e+00  3.02712914e+00  3.02712914e+00  3.02712914e+00
  7.37230536e+00  1.02654259e+01  1.02654259e+01  1.02654259e+01
  3.38020312e+01  3.38020312e+01  3.38020312e+01  3.47532548e+01
  1.32457811e+02  1.32457811e+02  1.32457811e+02  1.38854397e+02
  5.02924607e+02  1.87056017e+03  8.00024306e+03  4.77679171e+04]
E1 = -182.05680151718474  E_coul = 53.52192620852956
cycle= 1 E= -128.534875308655  delta_E= -0.0285  |g|= 0.208  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545806
diis-c [-0.29790368  1.        ]
  HOMO = -0.88569930370896  LUMO = 0.636427409112568
  mo_energy =
[-3.28833878e+01 -1.96874246e+00 -8.85699304e-01 -8.85699304e-01
 -8.85699304e-01  6.36427409e-01  6.36427409e-01  6.36427409e-01
  1.17015091e+00  2.94969043e+00  2.94969043e+00  2.94969043e+00
  7.23777007e+00  1.01050948e+01  1.01050948e+01  1.01050948e+01
  3.35497117e+01  3.35497117e+01  3.35497117e+01  3.45022733e+01
  1.32128814e+02  1.32128814e+02  1.32128814e+02  1.38531488e+02
  5.02557674e+02  1.87015728e+03  7.99981120e+03  4.77674664e+04]
E1 = -182.83552730353804  E_coul = 54.297984901019696
cycle= 2 E= -128.537542402518  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0636
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.279032
diis-c [-6.41460140e-04  3.37603134e-01  6.62396866e-01]
  HOMO = -0.849306796925498  LUMO = 0.64291716453088
  mo_energy =
[-3.27732648e+01 -1.93039189e+00 -8.49306797e-01 -8.49306797e-01
 -8.49306797e-01  6.42917165e-01  6.42917165e-01  6.42917165e-01
  1.18513364e+00  2.97480553e+00  2.97480553e+00  2.97480553e+00
  7.28200287e+00  1.01580844e+01  1.01580844e+01  1.01580844e+01
  3.36342895e+01  3.36342895e+01  3.36342895e+01  3.45866454e+01
  1.32238468e+02  1.32238468e+02  1.32238468e+02  1.38639579e+02
  5.02676687e+02  1.87028160e+03  7.99993800e+03  4.77675941e+04]
E1 = -182.57050063561434  E_coul = 54.031996411371075
cycle= 3 E= -128.538504224243  delta_E= -0.000962  |g|= 0.000422  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000979045
diis-c [-1.02291058e-07 -2.04200896e-03 -6.76731689e-04  1.00271874e+00]
  HOMO = -0.849531662446925  LUMO = 0.642899107635704
  mo_energy =
[-3.27736582e+01 -1.93056854e+00 -8.49531662e-01 -8.49531662e-01
 -8.49531662e-01  6.42899108e-01  6.42899108e-01  6.42899108e-01
  1.18506837e+00  2.97468784e+00  2.97468784e+00  2.97468784e+00
  7.28181751e+00  1.01578623e+01  1.01578623e+01  1.01578623e+01
  3.36339755e+01  3.36339755e+01  3.36339755e+01  3.45863425e+01
  1.32238062e+02  1.32238062e+02  1.32238062e+02  1.38639184e+02
  5.02676183e+02  1.87028098e+03  7.99993729e+03  4.77675934e+04]
E1 = -182.57081753516124  E_coul = 54.03231329473162
cycle= 4 E= -128.53850424043  delta_E= -1.62e-08  |g|= 7.17e-05  |ddm|= 0.000213
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180208
diis-c [-7.08322131e-10  1.28572659e-04  5.01438049e-04 -1.39535782e-01
  1.13890577e+00]
  HOMO = -0.849570512597808  LUMO = 0.642889975127075
  mo_energy =
[-3.27737260e+01 -1.93060219e+00 -8.49570513e-01 -8.49570513e-01
 -8.49570513e-01  6.42889975e-01  6.42889975e-01  6.42889975e-01
  1.18504922e+00  2.97465690e+00  2.97465690e+00  2.97465690e+00
  7.28177485e+00  1.01578129e+01  1.01578129e+01  1.01578129e+01
  3.36339139e+01  3.36339139e+01  3.36339139e+01  3.45862818e+01
  1.32237994e+02  1.32237994e+02  1.32237994e+02  1.38639117e+02
  5.02676110e+02  1.87028090e+03  7.99993720e+03  4.77675933e+04]
E1 = -182.57094507597333  E_coul = 54.032440835056775
cycle= 5 E= -128.538504240917  delta_E= -4.87e-10  |g|= 2.98e-06  |ddm|= 3.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57094507597333  E_coul = 54.032440835056775
  HOMO = -0.849569328867964  LUMO = 0.642890188307982
  mo_energy =
[-3.27737232e+01 -1.93060049e+00 -8.49569329e-01 -8.49569329e-01
 -8.49569329e-01  6.42890188e-01  6.42890188e-01  6.42890188e-01
  1.18504997e+00  2.97465776e+00  2.97465776e+00  2.97465776e+00
  7.28177661e+00  1.01578146e+01  1.01578146e+01  1.01578146e+01
  3.36339164e+01  3.36339164e+01  3.36339164e+01  3.45862843e+01
  1.32237996e+02  1.32237996e+02  1.32237996e+02  1.38639119e+02
  5.02676112e+02  1.87028090e+03  7.99993721e+03  4.77675933e+04]
E1 = -182.57093736820156  E_coul = 54.03243312728431
Extra cycle  E= -128.538504240917  delta_E= -6.82e-13  |g|= 1.06e-06  |ddm|= 1.24e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.2864375171164
E1 = -182.57093736820156  E_coul = 54.03243312728431
init E= -128.538504240917
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.849569893237472  LUMO = 0.642890087480096
  mo_energy =
[-3.27737249e+01 -1.93060100e+00 -8.49569893e-01 -8.49569893e-01
 -8.49569893e-01  6.42890087e-01  6.42890087e-01  6.42890087e-01
  1.18504978e+00  2.97465737e+00  2.97465737e+00  2.97465737e+00
  7.28177598e+00  1.01578138e+01  1.01578138e+01  1.01578138e+01
  3.36339152e+01  3.36339152e+01  3.36339152e+01  3.45862831e+01
  1.32237995e+02  1.32237995e+02  1.32237995e+02  1.38639118e+02
  5.02676110e+02  1.87028090e+03  7.99993720e+03  4.77675933e+04]
E1 = -182.57094140884223  E_coul = 54.032437167925096
cycle= 1 E= -128.538504240917  delta_E= 1.14e-13  |g|= 5.61e-07  |ddm|= 3.19e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57094140884223  E_coul = 54.032437167925096
  HOMO = -0.849569611287599  LUMO = 0.642890138274918
  mo_energy =
[-3.27737240e+01 -1.93060068e+00 -8.49569611e-01 -8.49569611e-01
 -8.49569611e-01  6.42890138e-01  6.42890138e-01  6.42890138e-01
  1.18504991e+00  2.97465757e+00  2.97465757e+00  2.97465757e+00
  7.28177634e+00  1.01578142e+01  1.01578142e+01  1.01578142e+01
  3.36339158e+01  3.36339158e+01  3.36339158e+01  3.45862838e+01
  1.32237996e+02  1.32237996e+02  1.32237996e+02  1.38639119e+02
  5.02676111e+02  1.87028090e+03  7.99993720e+03  4.77675933e+04]
E1 = -182.5709393397854  E_coul = 54.03243509886839
Extra cycle  E= -128.538504240917  delta_E= 1.14e-13  |g|= 2.8e-07  |ddm|= 1.92e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145448e+03 8.33270915e+02 2.35736942e+02
 7.64180741e+01 1.00213039e+01 2.70457723e+01 3.80910652e-01
 1.11509352e+00 2.88484642e+00 4.94143796e+00 1.44101381e+01
 5.49889985e+01 2.25242209e-01 1.83790664e+00 6.61022508e-01]
grad_E = [-1.11011451e-10  5.77709742e-09 -1.04852168e-07  9.89678873e-07
 -7.26679528e-06 -9.49820296e-05  5.43315545e-05  9.66421920e-05
 -9.43339526e-05  4.75646659e-05 -9.06990071e-04  5.40308756e-05
 -1.95921328e-04  2.30026815e-03  3.13869331e-03 -5.18378649e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45447999        1
[INPUT] 0    0    [1    /1   ]  833.270808679        1
[INPUT] 0    0    [1    /1   ]  235.738652967        1
[INPUT] 0    0    [1    /1   ]  76.4058103404        1
[INPUT] 0    0    [1    /1   ]  9.99971059853        1
[INPUT] 0    0    [1    /1   ]  27.04691125          1
[INPUT] 0    0    [1    /1   ]  0.382576513922       1
[INPUT] 0    0    [1    /1   ]  1.11977483285        1
[INPUT] 0    0    [1    /1   ]  2.89396232371        1
[INPUT] 1    0    [1    /1   ]  4.92947521727        1
[INPUT] 1    0    [1    /1   ]  14.4117407548        1
[INPUT] 1    0    [1    /1   ]  55.481165775         1
[INPUT] 1    0    [1    /1   ]  0.223557338373       1
[INPUT] 1    0    [1    /1   ]  1.83854881257        1
[INPUT] 1    0    [1    /1   ]  0.657495801297       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412980283, 1.0]], [0, [3661.454479991459, 1.0]], [0, [833.2708086791923, 1.0]], [0, [235.7386529670156, 1.0]], [0, [76.4058103404001, 1.0]], [0, [9.999710598532607, 1.0]], [0, [27.04691125002002, 1.0]], [0, [0.38257651392171704, 1.0]], [0, [1.1197748328494228, 1.0]], [0, [2.8939623237060768, 1.0]], [1, [4.92947521727326, 1.0]], [1, [14.41174075478457, 1.0]], [1, [55.48116577496764, 1.0]], [1, [0.22355733837254238, 1.0]], [1, [1.838548812570615, 1.0]], [1, [0.6574958012967156, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941298]
bas 1, expnt(s) = [3661.45447999]
bas 2, expnt(s) = [833.27080868]
bas 3, expnt(s) = [235.73865297]
bas 4, expnt(s) = [76.40581034]
bas 5, expnt(s) = [9.9997106]
bas 6, expnt(s) = [27.04691125]
bas 7, expnt(s) = [0.38257651]
bas 8, expnt(s) = [1.11977483]
bas 9, expnt(s) = [2.89396232]
bas 10, expnt(s) = [4.92947522]
bas 11, expnt(s) = [14.41174075]
bas 12, expnt(s) = [55.48116577]
bas 13, expnt(s) = [0.22355734]
bas 14, expnt(s) = [1.83854881]
bas 15, expnt(s) = [0.6574958]
CPU time:       143.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145448e+03 1.18920097e+03
 8.33270809e+02 3.91836285e+02 2.35738653e+02 1.51998087e+02
 7.64058103e+01 6.52919762e+01 9.99971060e+00 1.42071052e+01
 2.70469113e+01 2.99642410e+01 3.82576514e-01 1.22900529e+00
 1.11977483e+00 2.75019223e+00 2.89396232e+00 5.60576230e+00
 4.92947522e+00 2.14281783e+01 1.44117408e+01 8.19181138e+01
 5.54811658e+01 4.41739632e+02 2.23557338e-01 4.48456740e-01
 1.83854881e+00 6.24566014e+00 6.57495801e-01 1.72723179e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999820653496961
cond(S) = 344.55823676486256
E1 = -183.5865810206422  E_coul = 55.08007162725449
init E= -128.506509393388
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774973443675268  LUMO = 0.650786692373993
  mo_energy =
[-3.25551310e+01 -1.85258107e+00 -7.74973444e-01 -7.74973444e-01
 -7.74973444e-01  6.50786692e-01  6.50786692e-01  6.50786692e-01
  1.22409787e+00  3.01251998e+00  3.01251998e+00  3.01251998e+00
  7.40406851e+00  1.02410134e+01  1.02410134e+01  1.02410134e+01
  3.37559193e+01  3.37559193e+01  3.37559193e+01  3.47767931e+01
  1.33158135e+02  1.33158135e+02  1.33158135e+02  1.38834410e+02
  5.02872956e+02  1.87049918e+03  8.00018642e+03  4.77678697e+04]
E1 = -182.0566701787706  E_coul = 53.5217420363895
cycle= 1 E= -128.534928142381  delta_E= -0.0284  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545028
diis-c [-0.29705518  1.        ]
  HOMO = -0.885723933853879  LUMO = 0.631269677673824
  mo_energy =
[-3.28834127e+01 -1.96876265e+00 -8.85723934e-01 -8.85723934e-01
 -8.85723934e-01  6.31269678e-01  6.31269678e-01  6.31269678e-01
  1.17730329e+00  2.93521083e+00  2.93521083e+00  2.93521083e+00
  7.26930276e+00  1.00807152e+01  1.00807152e+01  1.00807152e+01
  3.35035507e+01  3.35035507e+01  3.35035507e+01  3.45258851e+01
  1.32828724e+02  1.32828724e+02  1.32828724e+02  1.38511493e+02
  5.02505984e+02  1.87009624e+03  7.99975451e+03  4.77674189e+04]
E1 = -182.83557624362837  E_coul = 54.29798095727122
cycle= 2 E= -128.537595286357  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278676
diis-c [-6.41575859e-04  3.37634843e-01  6.62365157e-01]
  HOMO = -0.849323940623917  LUMO = 0.637697362640337
  mo_energy =
[-3.27732740e+01 -1.93040275e+00 -8.49323941e-01 -8.49323941e-01
 -8.49323941e-01  6.37697363e-01  6.37697363e-01  6.37697363e-01
  1.19237010e+00  2.96028764e+00  2.96028764e+00  2.96028764e+00
  7.31361552e+00  1.01336979e+01  1.01336979e+01  1.01336979e+01
  3.35881517e+01  3.35881517e+01  3.35881517e+01  3.46102431e+01
  1.32938503e+02  1.32938503e+02  1.32938503e+02  1.38619592e+02
  5.02625013e+02  1.87022058e+03  7.99988132e+03  4.77675467e+04]
E1 = -182.57048644535968  E_coul = 54.03192890666109
cycle= 3 E= -128.538557538699  delta_E= -0.000962  |g|= 0.000419  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000973143
diis-c [-9.96896242e-08 -2.03166532e-03 -6.69027844e-04  1.00270069e+00]
  HOMO = -0.849547024518687  LUMO = 0.637680679136479
  mo_energy =
[-3.27736651e+01 -1.93057753e+00 -8.49547025e-01 -8.49547025e-01
 -8.49547025e-01  6.37680679e-01  6.37680679e-01  6.37680679e-01
  1.19230653e+00  2.96017229e+00  2.96017229e+00  2.96017229e+00
  7.31343168e+00  1.01334782e+01  1.01334782e+01  1.01334782e+01
  3.35878399e+01  3.35878399e+01  3.35878399e+01  3.46099425e+01
  1.32938098e+02  1.32938098e+02  1.32938098e+02  1.38619199e+02
  5.02624511e+02  1.87021996e+03  7.99988061e+03  4.77675459e+04]
E1 = -182.57080818201354  E_coul = 54.032250627718795
cycle= 4 E= -128.538557554295  delta_E= -1.56e-08  |g|= 7.06e-05  |ddm|= 0.000208
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178104
diis-c [-7.11386134e-10  1.27225416e-04  4.95618659e-04 -1.38629471e-01
  1.13800663e+00]
  HOMO = -0.849585224978056  LUMO = 0.637671852424258
  mo_energy =
[-3.27737318e+01 -1.93061046e+00 -8.49585225e-01 -8.49585225e-01
 -8.49585225e-01  6.37671852e-01  6.37671852e-01  6.37671852e-01
  1.19228784e+00  2.96014199e+00  2.96014199e+00  2.96014199e+00
  7.31338971e+00  1.01334296e+01  1.01334296e+01  1.01334296e+01
  3.35877792e+01  3.35877792e+01  3.35877792e+01  3.46098827e+01
  1.32938031e+02  1.32938031e+02  1.32938031e+02  1.38619132e+02
  5.02624439e+02  1.87021988e+03  7.99988053e+03  4.77675458e+04]
E1 = -182.5709351615837  E_coul = 54.0323776068171
cycle= 5 E= -128.538557554767  delta_E= -4.72e-10  |g|= 3.01e-06  |ddm|= 2.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5709351615837  E_coul = 54.0323776068171
  HOMO = -0.849584049538448  LUMO = 0.637672061966706
  mo_energy =
[-3.27737291e+01 -1.93060875e+00 -8.49584050e-01 -8.49584050e-01
 -8.49584050e-01  6.37672062e-01  6.37672062e-01  6.37672062e-01
  1.19228859e+00  2.96014285e+00  2.96014285e+00  2.96014285e+00
  7.31339147e+00  1.01334313e+01  1.01334313e+01  1.01334313e+01
  3.35877817e+01  3.35877817e+01  3.35877817e+01  3.46098853e+01
  1.32938033e+02  1.32938033e+02  1.32938033e+02  1.38619135e+02
  5.02624441e+02  1.87021989e+03  7.99988054e+03  4.77675458e+04]
E1 = -182.57092755486437  E_coul = 54.03237000009712
Extra cycle  E= -128.538557554767  delta_E= -6.54e-13  |g|= 1.05e-06  |ddm|= 1.27e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145448e+03 8.33270809e+02 2.35738653e+02
 7.64058103e+01 9.99971060e+00 2.70469113e+01 3.82576514e-01
 1.11977483e+00 2.89396232e+00 4.92947522e+00 1.44117408e+01
 5.54811658e+01 2.23557338e-01 1.83854881e+00 6.57495801e-01]
E = -128.53855755476724
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45447999        1
[INPUT] 0    0    [1    /1   ]  833.270808679        1
[INPUT] 0    0    [1    /1   ]  235.738652967        1
[INPUT] 0    0    [1    /1   ]  76.4058103404        1
[INPUT] 0    0    [1    /1   ]  9.99971059853        1
[INPUT] 0    0    [1    /1   ]  27.04691125          1
[INPUT] 0    0    [1    /1   ]  0.382576513922       1
[INPUT] 0    0    [1    /1   ]  1.11977483285        1
[INPUT] 0    0    [1    /1   ]  2.89396232371        1
[INPUT] 1    0    [1    /1   ]  4.92947521727        1
[INPUT] 1    0    [1    /1   ]  14.4117407548        1
[INPUT] 1    0    [1    /1   ]  55.481165775         1
[INPUT] 1    0    [1    /1   ]  0.223557338373       1
[INPUT] 1    0    [1    /1   ]  1.83854881257        1
[INPUT] 1    0    [1    /1   ]  0.657495801297       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412980283, 1.0]], [0, [3661.454479991459, 1.0]], [0, [833.2708086791923, 1.0]], [0, [235.7386529670156, 1.0]], [0, [76.4058103404001, 1.0]], [0, [9.999710598532607, 1.0]], [0, [27.04691125002002, 1.0]], [0, [0.38257651392171704, 1.0]], [0, [1.1197748328494228, 1.0]], [0, [2.8939623237060768, 1.0]], [1, [4.92947521727326, 1.0]], [1, [14.41174075478457, 1.0]], [1, [55.48116577496764, 1.0]], [1, [0.22355733837254238, 1.0]], [1, [1.838548812570615, 1.0]], [1, [0.6574958012967156, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941298]
bas 1, expnt(s) = [3661.45447999]
bas 2, expnt(s) = [833.27080868]
bas 3, expnt(s) = [235.73865297]
bas 4, expnt(s) = [76.40581034]
bas 5, expnt(s) = [9.9997106]
bas 6, expnt(s) = [27.04691125]
bas 7, expnt(s) = [0.38257651]
bas 8, expnt(s) = [1.11977483]
bas 9, expnt(s) = [2.89396232]
bas 10, expnt(s) = [4.92947522]
bas 11, expnt(s) = [14.41174075]
bas 12, expnt(s) = [55.48116577]
bas 13, expnt(s) = [0.22355734]
bas 14, expnt(s) = [1.83854881]
bas 15, expnt(s) = [0.6574958]
CPU time:       144.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145448e+03 1.18920097e+03
 8.33270809e+02 3.91836285e+02 2.35738653e+02 1.51998087e+02
 7.64058103e+01 6.52919762e+01 9.99971060e+00 1.42071052e+01
 2.70469113e+01 2.99642410e+01 3.82576514e-01 1.22900529e+00
 1.11977483e+00 2.75019223e+00 2.89396232e+00 5.60576230e+00
 4.92947522e+00 2.14281783e+01 1.44117408e+01 8.19181138e+01
 5.54811658e+01 4.41739632e+02 2.23557338e-01 4.48456740e-01
 1.83854881e+00 6.24566014e+00 6.57495801e-01 1.72723179e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999820653496961
cond(S) = 344.55823676486256
E1 = -183.5865810206422  E_coul = 55.08007162725449
init E= -128.506509393388
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774973443675268  LUMO = 0.650786692373993
  mo_energy =
[-3.25551310e+01 -1.85258107e+00 -7.74973444e-01 -7.74973444e-01
 -7.74973444e-01  6.50786692e-01  6.50786692e-01  6.50786692e-01
  1.22409787e+00  3.01251998e+00  3.01251998e+00  3.01251998e+00
  7.40406851e+00  1.02410134e+01  1.02410134e+01  1.02410134e+01
  3.37559193e+01  3.37559193e+01  3.37559193e+01  3.47767931e+01
  1.33158135e+02  1.33158135e+02  1.33158135e+02  1.38834410e+02
  5.02872956e+02  1.87049918e+03  8.00018642e+03  4.77678697e+04]
E1 = -182.0566701787706  E_coul = 53.5217420363895
cycle= 1 E= -128.534928142381  delta_E= -0.0284  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.545028
diis-c [-0.29705518  1.        ]
  HOMO = -0.885723933853879  LUMO = 0.631269677673824
  mo_energy =
[-3.28834127e+01 -1.96876265e+00 -8.85723934e-01 -8.85723934e-01
 -8.85723934e-01  6.31269678e-01  6.31269678e-01  6.31269678e-01
  1.17730329e+00  2.93521083e+00  2.93521083e+00  2.93521083e+00
  7.26930276e+00  1.00807152e+01  1.00807152e+01  1.00807152e+01
  3.35035507e+01  3.35035507e+01  3.35035507e+01  3.45258851e+01
  1.32828724e+02  1.32828724e+02  1.32828724e+02  1.38511493e+02
  5.02505984e+02  1.87009624e+03  7.99975451e+03  4.77674189e+04]
E1 = -182.83557624362837  E_coul = 54.29798095727122
cycle= 2 E= -128.537595286357  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278676
diis-c [-6.41575859e-04  3.37634843e-01  6.62365157e-01]
  HOMO = -0.849323940623917  LUMO = 0.637697362640337
  mo_energy =
[-3.27732740e+01 -1.93040275e+00 -8.49323941e-01 -8.49323941e-01
 -8.49323941e-01  6.37697363e-01  6.37697363e-01  6.37697363e-01
  1.19237010e+00  2.96028764e+00  2.96028764e+00  2.96028764e+00
  7.31361552e+00  1.01336979e+01  1.01336979e+01  1.01336979e+01
  3.35881517e+01  3.35881517e+01  3.35881517e+01  3.46102431e+01
  1.32938503e+02  1.32938503e+02  1.32938503e+02  1.38619592e+02
  5.02625013e+02  1.87022058e+03  7.99988132e+03  4.77675467e+04]
E1 = -182.57048644535968  E_coul = 54.03192890666109
cycle= 3 E= -128.538557538699  delta_E= -0.000962  |g|= 0.000419  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000973143
diis-c [-9.96896242e-08 -2.03166532e-03 -6.69027844e-04  1.00270069e+00]
  HOMO = -0.849547024518687  LUMO = 0.637680679136479
  mo_energy =
[-3.27736651e+01 -1.93057753e+00 -8.49547025e-01 -8.49547025e-01
 -8.49547025e-01  6.37680679e-01  6.37680679e-01  6.37680679e-01
  1.19230653e+00  2.96017229e+00  2.96017229e+00  2.96017229e+00
  7.31343168e+00  1.01334782e+01  1.01334782e+01  1.01334782e+01
  3.35878399e+01  3.35878399e+01  3.35878399e+01  3.46099425e+01
  1.32938098e+02  1.32938098e+02  1.32938098e+02  1.38619199e+02
  5.02624511e+02  1.87021996e+03  7.99988061e+03  4.77675459e+04]
E1 = -182.57080818201354  E_coul = 54.032250627718795
cycle= 4 E= -128.538557554295  delta_E= -1.56e-08  |g|= 7.06e-05  |ddm|= 0.000208
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178104
diis-c [-7.11386134e-10  1.27225416e-04  4.95618659e-04 -1.38629471e-01
  1.13800663e+00]
  HOMO = -0.849585224978056  LUMO = 0.637671852424258
  mo_energy =
[-3.27737318e+01 -1.93061046e+00 -8.49585225e-01 -8.49585225e-01
 -8.49585225e-01  6.37671852e-01  6.37671852e-01  6.37671852e-01
  1.19228784e+00  2.96014199e+00  2.96014199e+00  2.96014199e+00
  7.31338971e+00  1.01334296e+01  1.01334296e+01  1.01334296e+01
  3.35877792e+01  3.35877792e+01  3.35877792e+01  3.46098827e+01
  1.32938031e+02  1.32938031e+02  1.32938031e+02  1.38619132e+02
  5.02624439e+02  1.87021988e+03  7.99988053e+03  4.77675458e+04]
E1 = -182.5709351615837  E_coul = 54.0323776068171
cycle= 5 E= -128.538557554767  delta_E= -4.72e-10  |g|= 3.01e-06  |ddm|= 2.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5709351615837  E_coul = 54.0323776068171
  HOMO = -0.849584049538448  LUMO = 0.637672061966706
  mo_energy =
[-3.27737291e+01 -1.93060875e+00 -8.49584050e-01 -8.49584050e-01
 -8.49584050e-01  6.37672062e-01  6.37672062e-01  6.37672062e-01
  1.19228859e+00  2.96014285e+00  2.96014285e+00  2.96014285e+00
  7.31339147e+00  1.01334313e+01  1.01334313e+01  1.01334313e+01
  3.35877817e+01  3.35877817e+01  3.35877817e+01  3.46098853e+01
  1.32938033e+02  1.32938033e+02  1.32938033e+02  1.38619135e+02
  5.02624441e+02  1.87021989e+03  7.99988054e+03  4.77675458e+04]
E1 = -182.57092755486437  E_coul = 54.03237000009712
Extra cycle  E= -128.538557554767  delta_E= -6.54e-13  |g|= 1.05e-06  |ddm|= 1.27e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.55823676486256
E1 = -182.57092755486437  E_coul = 54.03237000009712
init E= -128.538557554767
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849584607275995  LUMO = 0.637671963437993
  mo_energy =
[-3.27737307e+01 -1.93060925e+00 -8.49584607e-01 -8.49584607e-01
 -8.49584607e-01  6.37671963e-01  6.37671963e-01  6.37671963e-01
  1.19228841e+00  2.96014247e+00  2.96014247e+00  2.96014247e+00
  7.31339085e+00  1.01334305e+01  1.01334305e+01  1.01334305e+01
  3.35877805e+01  3.35877805e+01  3.35877805e+01  3.46098841e+01
  1.32938032e+02  1.32938032e+02  1.32938032e+02  1.38619133e+02
  5.02624439e+02  1.87021988e+03  7.99988053e+03  4.77675458e+04]
E1 = -182.57093155072556  E_coul = 54.032373995958004
cycle= 1 E= -128.538557554768  delta_E= -3.13e-13  |g|= 5.55e-07  |ddm|= 3.18e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57093155072556  E_coul = 54.032373995958004
  HOMO = -0.84958432861272  LUMO = 0.637672013185922
  mo_energy =
[-3.27737299e+01 -1.93060893e+00 -8.49584329e-01 -8.49584329e-01
 -8.49584329e-01  6.37672013e-01  6.37672013e-01  6.37672013e-01
  1.19228853e+00  2.96014266e+00  2.96014266e+00  2.96014266e+00
  7.31339120e+00  1.01334309e+01  1.01334309e+01  1.01334309e+01
  3.35877811e+01  3.35877811e+01  3.35877811e+01  3.46098847e+01
  1.32938033e+02  1.32938033e+02  1.32938033e+02  1.38619134e+02
  5.02624440e+02  1.87021989e+03  7.99988053e+03  4.77675458e+04]
E1 = -182.57092950606508  E_coul = 54.03237195129737
Extra cycle  E= -128.538557554768  delta_E= -1.71e-13  |g|= 2.77e-07  |ddm|= 1.91e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145448e+03 8.33270809e+02 2.35738653e+02
 7.64058103e+01 9.99971060e+00 2.70469113e+01 3.82576514e-01
 1.11977483e+00 2.89396232e+00 4.92947522e+00 1.44117408e+01
 5.54811658e+01 2.23557338e-01 1.83854881e+00 6.57495801e-01]
grad_E = [-3.46178507e-10  1.81052651e-08 -3.49157723e-07  3.80374620e-06
 -2.78387050e-05 -2.84767851e-04  1.47147355e-04  2.25873730e-04
  4.84264195e-05  6.09187730e-05 -1.34837265e-03  6.44578374e-05
 -1.81403225e-04  3.76715829e-03  4.79754080e-03 -8.12171944e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448998        1
[INPUT] 0    0    [1    /1   ]  833.270556405        1
[INPUT] 0    0    [1    /1   ]  235.742722715        1
[INPUT] 0    0    [1    /1   ]  76.3766912953        1
[INPUT] 0    0    [1    /1   ]  9.94989623322        1
[INPUT] 0    0    [1    /1   ]  27.0489060464        1
[INPUT] 0    0    [1    /1   ]  0.384513240875       1
[INPUT] 0    0    [1    /1   ]  1.12584070507        1
[INPUT] 0    0    [1    /1   ]  2.91620023519        1
[INPUT] 1    0    [1    /1   ]  4.95410460881        1
[INPUT] 1    0    [1    /1   ]  14.5356598597        1
[INPUT] 1    0    [1    /1   ]  56.6298561568        1
[INPUT] 1    0    [1    /1   ]  0.223063588267       1
[INPUT] 1    0    [1    /1   ]  1.85352377806        1
[INPUT] 1    0    [1    /1   ]  0.658527191378       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412961577, 1.0]], [0, [3661.4544899841503, 1.0]], [0, [833.2705564049602, 1.0]], [0, [235.74272271495136, 1.0]], [0, [76.37669129531544, 1.0]], [0, [9.94989623322109, 1.0]], [0, [27.048906046403093, 1.0]], [0, [0.38451324087519084, 1.0]], [0, [1.1258407050713797, 1.0]], [0, [2.9162002351904923, 1.0]], [1, [4.954104608806986, 1.0]], [1, [14.535659859658177, 1.0]], [1, [56.62985615679577, 1.0]], [1, [0.22306358826666178, 1.0]], [1, [1.8535237780589238, 1.0]], [1, [0.6585271913782491, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412962]
bas 1, expnt(s) = [3661.45448998]
bas 2, expnt(s) = [833.2705564]
bas 3, expnt(s) = [235.74272271]
bas 4, expnt(s) = [76.3766913]
bas 5, expnt(s) = [9.94989623]
bas 6, expnt(s) = [27.04890605]
bas 7, expnt(s) = [0.38451324]
bas 8, expnt(s) = [1.12584071]
bas 9, expnt(s) = [2.91620024]
bas 10, expnt(s) = [4.95410461]
bas 11, expnt(s) = [14.53565986]
bas 12, expnt(s) = [56.62985616]
bas 13, expnt(s) = [0.22306359]
bas 14, expnt(s) = [1.85352378]
bas 15, expnt(s) = [0.65852719]
CPU time:       147.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145449e+03 1.18920097e+03
 8.33270556e+02 3.91836196e+02 2.35742723e+02 1.52000055e+02
 7.63766913e+01 6.52733127e+01 9.94989623e+00 1.41539917e+01
 2.70489060e+01 2.99658984e+01 3.84513241e-01 1.23366857e+00
 1.12584071e+00 2.76135812e+00 2.91620024e+00 5.63803840e+00
 4.95410461e+00 2.15620902e+01 1.45356599e+01 8.27995225e+01
 5.66298562e+01 4.53201372e+02 2.23063588e-01 4.47219002e-01
 1.85352378e+00 6.30931332e+00 6.58527191e-01 1.73061926e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999814629888037
cond(S) = 346.19395965039865
E1 = -183.5867796342998  E_coul = 55.08003258194793
init E= -128.506747052352
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775003528346918  LUMO = 0.64994978188695
  mo_energy =
[-3.25551196e+01 -1.85257964e+00 -7.75003528e-01 -7.75003528e-01
 -7.75003528e-01  6.49949782e-01  6.49949782e-01  6.49949782e-01
  1.23350675e+00  3.02117790e+00  3.02117790e+00  3.02117790e+00
  7.45542186e+00  1.03013269e+01  1.03013269e+01  1.03013269e+01
  3.40125882e+01  3.40125882e+01  3.40125882e+01  3.48063415e+01
  1.35409930e+02  1.35409930e+02  1.35409930e+02  1.38765083e+02
  5.02730940e+02  1.87033705e+03  8.00003670e+03  4.77677445e+04]
E1 = -182.0572683235001  E_coul = 53.52221599192134
cycle= 1 E= -128.535052331579  delta_E= -0.0283  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.5437
diis-c [-0.29560962  1.        ]
  HOMO = -0.885716270861869  LUMO = 0.630457272056083
  mo_energy =
[-3.28832997e+01 -1.96872197e+00 -8.85716271e-01 -8.85716271e-01
 -8.85716271e-01  6.30457272e-01  6.30457272e-01  6.30457272e-01
  1.18641002e+00  2.94349321e+00  2.94349321e+00  2.94349321e+00
  7.32029909e+00  1.01404183e+01  1.01404183e+01  1.01404183e+01
  3.37596332e+01  3.37596332e+01  3.37596332e+01  3.45556871e+01
  1.35079738e+02  1.35079738e+02  1.35079738e+02  1.38442294e+02
  5.02364044e+02  1.86993416e+03  7.99960484e+03  4.77672938e+04]
E1 = -182.83593847135776  E_coul = 54.298220938310756
cycle= 2 E= -128.537717533047  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0638
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27798
diis-c [-6.41561462e-04  3.37616924e-01  6.62383076e-01]
  HOMO = -0.849326541924763  LUMO = 0.636883238021163
  mo_energy =
[-3.27731915e+01 -1.93037161e+00 -8.49326542e-01 -8.49326542e-01
 -8.49326542e-01  6.36883238e-01  6.36883238e-01  6.36883238e-01
  1.20158126e+00  2.96869731e+00  2.96869731e+00  2.96869731e+00
  7.36473491e+00  1.01936106e+01  1.01936106e+01  1.01936106e+01
  3.38444389e+01  3.38444389e+01  3.38444389e+01  3.46399644e+01
  1.35189735e+02  1.35189735e+02  1.35189735e+02  1.38550348e+02
  5.02483038e+02  1.87005846e+03  7.99973162e+03  4.77674215e+04]
E1 = -182.57094166934397  E_coul = 54.03226248747348
cycle= 3 E= -128.53867918187  delta_E= -0.000962  |g|= 0.000419  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000977841
diis-c [-9.78279763e-08 -2.02566221e-03 -6.27344299e-04  1.00265301e+00]
  HOMO = -0.849548670456181  LUMO = 0.636867660920347
  mo_energy =
[-3.27735830e+01 -1.93054487e+00 -8.49548670e-01 -8.49548670e-01
 -8.49548670e-01  6.36867661e-01  6.36867661e-01  6.36867661e-01
  1.20151938e+00  2.96858303e+00  2.96858303e+00  2.96858303e+00
  7.36455158e+00  1.01933911e+01  1.01933911e+01  1.01933911e+01
  3.38441265e+01  3.38441265e+01  3.38441265e+01  3.46396642e+01
  1.35189328e+02  1.35189328e+02  1.35189328e+02  1.38549954e+02
  5.02482535e+02  1.87005784e+03  7.99973091e+03  4.77674207e+04]
E1 = -182.57127855042359  E_coul = 54.03259935342541
cycle= 4 E= -128.538679196998  delta_E= -1.51e-08  |g|= 6.98e-05  |ddm|= 0.000203
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176834
diis-c [-7.22459240e-10  1.27713077e-04  4.89478850e-04 -1.38452356e-01
  1.13783516e+00]
  HOMO = -0.849586206843179  LUMO = 0.636859096249317
  mo_energy =
[-3.27736488e+01 -1.93057692e+00 -8.49586207e-01 -8.49586207e-01
 -8.49586207e-01  6.36859096e-01  6.36859096e-01  6.36859096e-01
  1.20150126e+00  2.96855328e+00  2.96855328e+00  2.96855328e+00
  7.36451035e+00  1.01933432e+01  1.01933432e+01  1.01933432e+01
  3.38440666e+01  3.38440666e+01  3.38440666e+01  3.46396054e+01
  1.35189262e+02  1.35189262e+02  1.35189262e+02  1.38549889e+02
  5.02482464e+02  1.87005776e+03  7.99973083e+03  4.77674206e+04]
E1 = -182.57140605921745  E_coul = 54.032726861758924
cycle= 5 E= -128.538679197459  delta_E= -4.6e-10  |g|= 3.1e-06  |ddm|= 2.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57140605921745  E_coul = 54.032726861758924
  HOMO = -0.849584998551957  LUMO = 0.636859315843871
  mo_energy =
[-3.27736460e+01 -1.93057515e+00 -8.49584999e-01 -8.49584999e-01
 -8.49584999e-01  6.36859316e-01  6.36859316e-01  6.36859316e-01
  1.20150207e+00  2.96855417e+00  2.96855417e+00  2.96855417e+00
  7.36451217e+00  1.01933450e+01  1.01933450e+01  1.01933450e+01
  3.38440692e+01  3.38440692e+01  3.38440692e+01  3.46396080e+01
  1.35189264e+02  1.35189264e+02  1.35189264e+02  1.38549891e+02
  5.02482466e+02  1.87005776e+03  7.99973083e+03  4.77674206e+04]
E1 = -182.5713984481936  E_coul = 54.03271925073447
Extra cycle  E= -128.538679197459  delta_E= -6.25e-13  |g|= 1.06e-06  |ddm|= 1.32e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145449e+03 8.33270556e+02 2.35742723e+02
 7.63766913e+01 9.94989623e+00 2.70489060e+01 3.84513241e-01
 1.12584071e+00 2.91620024e+00 4.95410461e+00 1.45356599e+01
 5.66298562e+01 2.23063588e-01 1.85352378e+00 6.58527191e-01]
E = -128.53867919745915
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448998        1
[INPUT] 0    0    [1    /1   ]  833.270556405        1
[INPUT] 0    0    [1    /1   ]  235.742722715        1
[INPUT] 0    0    [1    /1   ]  76.3766912953        1
[INPUT] 0    0    [1    /1   ]  9.94989623322        1
[INPUT] 0    0    [1    /1   ]  27.0489060464        1
[INPUT] 0    0    [1    /1   ]  0.384513240875       1
[INPUT] 0    0    [1    /1   ]  1.12584070507        1
[INPUT] 0    0    [1    /1   ]  2.91620023519        1
[INPUT] 1    0    [1    /1   ]  4.95410460881        1
[INPUT] 1    0    [1    /1   ]  14.5356598597        1
[INPUT] 1    0    [1    /1   ]  56.6298561568        1
[INPUT] 1    0    [1    /1   ]  0.223063588267       1
[INPUT] 1    0    [1    /1   ]  1.85352377806        1
[INPUT] 1    0    [1    /1   ]  0.658527191378       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412961577, 1.0]], [0, [3661.4544899841503, 1.0]], [0, [833.2705564049602, 1.0]], [0, [235.74272271495136, 1.0]], [0, [76.37669129531544, 1.0]], [0, [9.94989623322109, 1.0]], [0, [27.048906046403093, 1.0]], [0, [0.38451324087519084, 1.0]], [0, [1.1258407050713797, 1.0]], [0, [2.9162002351904923, 1.0]], [1, [4.954104608806986, 1.0]], [1, [14.535659859658177, 1.0]], [1, [56.62985615679577, 1.0]], [1, [0.22306358826666178, 1.0]], [1, [1.8535237780589238, 1.0]], [1, [0.6585271913782491, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412962]
bas 1, expnt(s) = [3661.45448998]
bas 2, expnt(s) = [833.2705564]
bas 3, expnt(s) = [235.74272271]
bas 4, expnt(s) = [76.3766913]
bas 5, expnt(s) = [9.94989623]
bas 6, expnt(s) = [27.04890605]
bas 7, expnt(s) = [0.38451324]
bas 8, expnt(s) = [1.12584071]
bas 9, expnt(s) = [2.91620024]
bas 10, expnt(s) = [4.95410461]
bas 11, expnt(s) = [14.53565986]
bas 12, expnt(s) = [56.62985616]
bas 13, expnt(s) = [0.22306359]
bas 14, expnt(s) = [1.85352378]
bas 15, expnt(s) = [0.65852719]
CPU time:       147.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145449e+03 1.18920097e+03
 8.33270556e+02 3.91836196e+02 2.35742723e+02 1.52000055e+02
 7.63766913e+01 6.52733127e+01 9.94989623e+00 1.41539917e+01
 2.70489060e+01 2.99658984e+01 3.84513241e-01 1.23366857e+00
 1.12584071e+00 2.76135812e+00 2.91620024e+00 5.63803840e+00
 4.95410461e+00 2.15620902e+01 1.45356599e+01 8.27995225e+01
 5.66298562e+01 4.53201372e+02 2.23063588e-01 4.47219002e-01
 1.85352378e+00 6.30931332e+00 6.58527191e-01 1.73061926e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999814629888037
cond(S) = 346.19395965039865
E1 = -183.5867796342998  E_coul = 55.08003258194793
init E= -128.506747052352
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775003528346918  LUMO = 0.64994978188695
  mo_energy =
[-3.25551196e+01 -1.85257964e+00 -7.75003528e-01 -7.75003528e-01
 -7.75003528e-01  6.49949782e-01  6.49949782e-01  6.49949782e-01
  1.23350675e+00  3.02117790e+00  3.02117790e+00  3.02117790e+00
  7.45542186e+00  1.03013269e+01  1.03013269e+01  1.03013269e+01
  3.40125882e+01  3.40125882e+01  3.40125882e+01  3.48063415e+01
  1.35409930e+02  1.35409930e+02  1.35409930e+02  1.38765083e+02
  5.02730940e+02  1.87033705e+03  8.00003670e+03  4.77677445e+04]
E1 = -182.0572683235001  E_coul = 53.52221599192134
cycle= 1 E= -128.535052331579  delta_E= -0.0283  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.5437
diis-c [-0.29560962  1.        ]
  HOMO = -0.885716270861869  LUMO = 0.630457272056083
  mo_energy =
[-3.28832997e+01 -1.96872197e+00 -8.85716271e-01 -8.85716271e-01
 -8.85716271e-01  6.30457272e-01  6.30457272e-01  6.30457272e-01
  1.18641002e+00  2.94349321e+00  2.94349321e+00  2.94349321e+00
  7.32029909e+00  1.01404183e+01  1.01404183e+01  1.01404183e+01
  3.37596332e+01  3.37596332e+01  3.37596332e+01  3.45556871e+01
  1.35079738e+02  1.35079738e+02  1.35079738e+02  1.38442294e+02
  5.02364044e+02  1.86993416e+03  7.99960484e+03  4.77672938e+04]
E1 = -182.83593847135776  E_coul = 54.298220938310756
cycle= 2 E= -128.537717533047  delta_E= -0.00267  |g|= 0.106  |ddm|= 0.0638
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27798
diis-c [-6.41561462e-04  3.37616924e-01  6.62383076e-01]
  HOMO = -0.849326541924763  LUMO = 0.636883238021163
  mo_energy =
[-3.27731915e+01 -1.93037161e+00 -8.49326542e-01 -8.49326542e-01
 -8.49326542e-01  6.36883238e-01  6.36883238e-01  6.36883238e-01
  1.20158126e+00  2.96869731e+00  2.96869731e+00  2.96869731e+00
  7.36473491e+00  1.01936106e+01  1.01936106e+01  1.01936106e+01
  3.38444389e+01  3.38444389e+01  3.38444389e+01  3.46399644e+01
  1.35189735e+02  1.35189735e+02  1.35189735e+02  1.38550348e+02
  5.02483038e+02  1.87005846e+03  7.99973162e+03  4.77674215e+04]
E1 = -182.57094166934397  E_coul = 54.03226248747348
cycle= 3 E= -128.53867918187  delta_E= -0.000962  |g|= 0.000419  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000977841
diis-c [-9.78279763e-08 -2.02566221e-03 -6.27344299e-04  1.00265301e+00]
  HOMO = -0.849548670456181  LUMO = 0.636867660920347
  mo_energy =
[-3.27735830e+01 -1.93054487e+00 -8.49548670e-01 -8.49548670e-01
 -8.49548670e-01  6.36867661e-01  6.36867661e-01  6.36867661e-01
  1.20151938e+00  2.96858303e+00  2.96858303e+00  2.96858303e+00
  7.36455158e+00  1.01933911e+01  1.01933911e+01  1.01933911e+01
  3.38441265e+01  3.38441265e+01  3.38441265e+01  3.46396642e+01
  1.35189328e+02  1.35189328e+02  1.35189328e+02  1.38549954e+02
  5.02482535e+02  1.87005784e+03  7.99973091e+03  4.77674207e+04]
E1 = -182.57127855042359  E_coul = 54.03259935342541
cycle= 4 E= -128.538679196998  delta_E= -1.51e-08  |g|= 6.98e-05  |ddm|= 0.000203
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176834
diis-c [-7.22459240e-10  1.27713077e-04  4.89478850e-04 -1.38452356e-01
  1.13783516e+00]
  HOMO = -0.849586206843179  LUMO = 0.636859096249317
  mo_energy =
[-3.27736488e+01 -1.93057692e+00 -8.49586207e-01 -8.49586207e-01
 -8.49586207e-01  6.36859096e-01  6.36859096e-01  6.36859096e-01
  1.20150126e+00  2.96855328e+00  2.96855328e+00  2.96855328e+00
  7.36451035e+00  1.01933432e+01  1.01933432e+01  1.01933432e+01
  3.38440666e+01  3.38440666e+01  3.38440666e+01  3.46396054e+01
  1.35189262e+02  1.35189262e+02  1.35189262e+02  1.38549889e+02
  5.02482464e+02  1.87005776e+03  7.99973083e+03  4.77674206e+04]
E1 = -182.57140605921745  E_coul = 54.032726861758924
cycle= 5 E= -128.538679197459  delta_E= -4.6e-10  |g|= 3.1e-06  |ddm|= 2.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57140605921745  E_coul = 54.032726861758924
  HOMO = -0.849584998551957  LUMO = 0.636859315843871
  mo_energy =
[-3.27736460e+01 -1.93057515e+00 -8.49584999e-01 -8.49584999e-01
 -8.49584999e-01  6.36859316e-01  6.36859316e-01  6.36859316e-01
  1.20150207e+00  2.96855417e+00  2.96855417e+00  2.96855417e+00
  7.36451217e+00  1.01933450e+01  1.01933450e+01  1.01933450e+01
  3.38440692e+01  3.38440692e+01  3.38440692e+01  3.46396080e+01
  1.35189264e+02  1.35189264e+02  1.35189264e+02  1.38549891e+02
  5.02482466e+02  1.87005776e+03  7.99973083e+03  4.77674206e+04]
E1 = -182.5713984481936  E_coul = 54.03271925073447
Extra cycle  E= -128.538679197459  delta_E= -6.25e-13  |g|= 1.06e-06  |ddm|= 1.32e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.19395965039865
E1 = -182.5713984481936  E_coul = 54.03271925073447
init E= -128.538679197459
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849585556613269  LUMO = 0.636859218104485
  mo_energy =
[-3.27736477e+01 -1.93057564e+00 -8.49585557e-01 -8.49585557e-01
 -8.49585557e-01  6.36859218e-01  6.36859218e-01  6.36859218e-01
  1.20150188e+00  2.96855379e+00  2.96855379e+00  2.96855379e+00
  7.36451155e+00  1.01933442e+01  1.01933442e+01  1.01933442e+01
  3.38440679e+01  3.38440679e+01  3.38440679e+01  3.46396067e+01
  1.35189263e+02  1.35189263e+02  1.35189263e+02  1.38549890e+02
  5.02482464e+02  1.87005776e+03  7.99973083e+03  4.77674206e+04]
E1 = -182.5714024784746  E_coul = 54.03272328101528
cycle= 1 E= -128.538679197459  delta_E= -1.71e-13  |g|= 5.61e-07  |ddm|= 3.26e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5714024784746  E_coul = 54.03272328101528
  HOMO = -0.84958527560662  LUMO = 0.636859268414618
  mo_energy =
[-3.27736468e+01 -1.93057532e+00 -8.49585276e-01 -8.49585276e-01
 -8.49585276e-01  6.36859268e-01  6.36859268e-01  6.36859268e-01
  1.20150201e+00  2.96855399e+00  2.96855399e+00  2.96855399e+00
  7.36451191e+00  1.01933446e+01  1.01933446e+01  1.01933446e+01
  3.38440686e+01  3.38440686e+01  3.38440686e+01  3.46396074e+01
  1.35189263e+02  1.35189263e+02  1.35189263e+02  1.38549890e+02
  5.02482465e+02  1.87005776e+03  7.99973083e+03  4.77674206e+04]
E1 = -182.57140042183033  E_coul = 54.03272122437124
Extra cycle  E= -128.538679197459  delta_E= 2.27e-13  |g|= 2.78e-07  |ddm|= 1.94e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145449e+03 8.33270556e+02 2.35742723e+02
 7.63766913e+01 9.94989623e+00 2.70489060e+01 3.84513241e-01
 1.12584071e+00 2.91620024e+00 4.95410461e+00 1.45356599e+01
 5.66298562e+01 2.23063588e-01 1.85352378e+00 6.58527191e-01]
grad_E = [-8.79589680e-10  4.61106361e-08 -9.02460684e-07  1.01889629e-05
 -7.41732367e-05 -7.01369585e-04  3.56316786e-04  3.57687866e-04
  2.47022336e-04  1.18782830e-04 -1.82474171e-03  6.39495113e-05
 -1.56594588e-04  5.52074185e-03  6.65530409e-03 -1.14608221e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941293        1
[INPUT] 0    0    [1    /1   ]  3661.45450942        1
[INPUT] 0    0    [1    /1   ]  833.270065654        1
[INPUT] 0    0    [1    /1   ]  235.750639987        1
[INPUT] 0    0    [1    /1   ]  76.3201142815        1
[INPUT] 0    0    [1    /1   ]  9.85549890477        1
[INPUT] 0    0    [1    /1   ]  27.051575798         1
[INPUT] 0    0    [1    /1   ]  0.385411979701       1
[INPUT] 0    0    [1    /1   ]  1.13025787952        1
[INPUT] 0    0    [1    /1   ]  2.96025585791        1
[INPUT] 1    0    [1    /1   ]  5.07182229687        1
[INPUT] 1    0    [1    /1   ]  14.9457338231        1
[INPUT] 1    0    [1    /1   ]  58.8357980046        1
[INPUT] 1    0    [1    /1   ]  0.226426133933       1
[INPUT] 1    0    [1    /1   ]  1.89876771347        1
[INPUT] 1    0    [1    /1   ]  0.672122164476       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412925197, 1.0]], [0, [3661.454509416909, 1.0]], [0, [833.270065653501, 1.0]], [0, [235.75063998683868, 1.0]], [0, [76.32011428147744, 1.0]], [0, [9.855498904769416, 1.0]], [0, [27.05157579804432, 1.0]], [0, [0.38541197970108887, 1.0]], [0, [1.130257879517521, 1.0]], [0, [2.960255857910259, 1.0]], [1, [5.071822296870898, 1.0]], [1, [14.94573382306832, 1.0]], [1, [58.83579800464026, 1.0]], [1, [0.22642613393254513, 1.0]], [1, [1.89876771346781, 1.0]], [1, [0.6721221644759137, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412925]
bas 1, expnt(s) = [3661.45450942]
bas 2, expnt(s) = [833.27006565]
bas 3, expnt(s) = [235.75063999]
bas 4, expnt(s) = [76.32011428]
bas 5, expnt(s) = [9.8554989]
bas 6, expnt(s) = [27.0515758]
bas 7, expnt(s) = [0.38541198]
bas 8, expnt(s) = [1.13025788]
bas 9, expnt(s) = [2.96025586]
bas 10, expnt(s) = [5.0718223]
bas 11, expnt(s) = [14.94573382]
bas 12, expnt(s) = [58.835798]
bas 13, expnt(s) = [0.22642613]
bas 14, expnt(s) = [1.89876771]
bas 15, expnt(s) = [0.67212216]
CPU time:       150.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145451e+03 1.18920097e+03
 8.33270066e+02 3.91836023e+02 2.35750640e+02 1.52003884e+02
 7.63201143e+01 6.52370454e+01 9.85549890e+00 1.40531598e+01
 2.70515758e+01 2.99681167e+01 3.85411980e-01 1.23583056e+00
 1.13025788e+00 2.76947967e+00 2.96025586e+00 5.70179976e+00
 5.07182230e+00 2.22044197e+01 1.49457338e+01 8.57296295e+01
 5.88357980e+01 4.75375125e+02 2.26426134e-01 4.55661758e-01
 1.89876771e+00 6.50240761e+00 6.72122164e-01 1.77539366e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999801003589933
cond(S) = 347.46230752494006
E1 = -183.5871503325868  E_coul = 55.0800238554412
init E= -128.507126477146
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775061444839762  LUMO = 0.663037134504929
  mo_energy =
[-3.25550580e+01 -1.85257330e+00 -7.75061445e-01 -7.75061445e-01
 -7.75061445e-01  6.63037135e-01  6.63037135e-01  6.63037135e-01
  1.24004760e+00  3.09155857e+00  3.09155857e+00  3.09155857e+00
  7.52001751e+00  1.05671949e+01  1.05671949e+01  1.05671949e+01
  3.48251304e+01  3.50001970e+01  3.50001970e+01  3.50001970e+01
  1.38598937e+02  1.40600240e+02  1.40600240e+02  1.40600240e+02
  5.02427353e+02  1.86999736e+03  7.99972414e+03  4.77674833e+04]
E1 = -182.0596031596005  E_coul = 53.52432191855094
cycle= 1 E= -128.53528124105  delta_E= -0.0282  |g|= 0.208  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.54178
diis-c [-0.29352562  1.        ]
  HOMO = -0.885621095891807  LUMO = 0.643007688676827
  mo_energy =
[-3.28828330e+01 -1.96852803e+00 -8.85621096e-01 -8.85621096e-01
 -8.85621096e-01  6.43007689e-01  6.43007689e-01  6.43007689e-01
  1.19275776e+00  3.01231104e+00  3.01231104e+00  3.01231104e+00
  7.38446693e+00  1.04042317e+01  1.04042317e+01  1.04042317e+01
  3.45750615e+01  3.47454751e+01  3.47454751e+01  3.47454751e+01
  1.38276590e+02  1.40268833e+02  1.40268833e+02  1.40268833e+02
  5.02060835e+02  1.86959479e+03  7.99929262e+03  4.77670329e+04]
E1 = -182.83700030875065  E_coul = 54.299060292256854
cycle= 2 E= -128.537940016494  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276822
diis-c [-6.41487079e-04  3.37468584e-01  6.62531416e-01]
  HOMO = -0.84928554078641  LUMO = 0.649610632090989
  mo_energy =
[-3.27728686e+01 -1.93023518e+00 -8.49285541e-01 -8.49285541e-01
 -8.49285541e-01  6.49610632e-01  6.49610632e-01  6.49610632e-01
  1.20799794e+00  3.03802793e+00  3.03802793e+00  3.03802793e+00
  7.42904957e+00  1.04581165e+01  1.04581165e+01  1.04581165e+01
  3.46591264e+01  3.48308815e+01  3.48308815e+01  3.48308815e+01
  1.38384475e+02  1.40379140e+02  1.40379140e+02  1.40379140e+02
  5.02179672e+02  1.86971893e+03  7.99941924e+03  4.77671605e+04]
E1 = -182.57247243864845  E_coul = 54.03357393724297
cycle= 3 E= -128.538898501405  delta_E= -0.000958  |g|= 0.000428  |ddm|= 0.0224
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101218
diis-c [-1.00593897e-07 -2.04086672e-03 -5.18800964e-04  1.00255967e+00]
  HOMO = -0.84951046041403  LUMO = 0.649594248962766
  mo_energy =
[-3.27732691e+01 -1.93040968e+00 -8.49510460e-01 -8.49510460e-01
 -8.49510460e-01  6.49594249e-01  6.49594249e-01  6.49594249e-01
  1.20793597e+00  3.03790951e+00  3.03790951e+00  3.03790951e+00
  7.42886281e+00  1.04578901e+01  1.04578901e+01  1.04578901e+01
  3.46588197e+01  3.48305600e+01  3.48305600e+01  3.48305600e+01
  1.38384072e+02  1.40378720e+02  1.40378720e+02  1.40378720e+02
  5.02179156e+02  1.86971829e+03  7.99941851e+03  4.77671597e+04]
E1 = -182.5728423263725  E_coul = 54.03394380947446
cycle= 4 E= -128.538898516898  delta_E= -1.55e-08  |g|= 7.03e-05  |ddm|= 0.0002
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179523
diis-c [-7.48610850e-10  1.34159150e-04  4.88039396e-04 -1.41175000e-01
  1.14055280e+00]
  HOMO = -0.849548012414307  LUMO = 0.649585556211582
  mo_energy =
[-3.27733356e+01 -1.93044129e+00 -8.49548012e-01 -8.49548012e-01
 -8.49548012e-01  6.49585556e-01  6.49585556e-01  6.49585556e-01
  1.20791819e+00  3.03787941e+00  3.03787941e+00  3.03787941e+00
  7.42882166e+00  1.04578418e+01  1.04578418e+01  1.04578418e+01
  3.46587606e+01  3.48304997e+01  3.48304997e+01  3.48304997e+01
  1.38384005e+02  1.40378653e+02  1.40378653e+02  1.40378653e+02
  5.02179083e+02  1.86971821e+03  7.99941843e+03  4.77671596e+04]
E1 = -182.57297331272838  E_coul = 54.03407479536217
cycle= 5 E= -128.538898517366  delta_E= -4.68e-10  |g|= 3.32e-06  |ddm|= 2.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57297331272838  E_coul = 54.03407479536217
  HOMO = -0.849546665241078  LUMO = 0.649585819961578
  mo_energy =
[-3.27733325e+01 -1.93043934e+00 -8.49546665e-01 -8.49546665e-01
 -8.49546665e-01  6.49585820e-01  6.49585820e-01  6.49585820e-01
  1.20791910e+00  3.03788044e+00  3.03788044e+00  3.03788044e+00
  7.42882367e+00  1.04578438e+01  1.04578438e+01  1.04578438e+01
  3.46587635e+01  3.48305025e+01  3.48305025e+01  3.48305025e+01
  1.38384008e+02  1.40378655e+02  1.40378655e+02  1.40378655e+02
  5.02179086e+02  1.86971822e+03  7.99941843e+03  4.77671596e+04]
E1 = -182.57296527762057  E_coul = 54.034066760253374
Extra cycle  E= -128.538898517367  delta_E= -9.95e-13  |g|= 1.13e-06  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145451e+03 8.33270066e+02 2.35750640e+02
 7.63201143e+01 9.85549890e+00 2.70515758e+01 3.85411980e-01
 1.13025788e+00 2.96025586e+00 5.07182230e+00 1.49457338e+01
 5.88357980e+01 2.26426134e-01 1.89876771e+00 6.72122164e-01]
E = -128.5388985173672
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:16:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941293        1
[INPUT] 0    0    [1    /1   ]  3661.45450942        1
[INPUT] 0    0    [1    /1   ]  833.270065654        1
[INPUT] 0    0    [1    /1   ]  235.750639987        1
[INPUT] 0    0    [1    /1   ]  76.3201142815        1
[INPUT] 0    0    [1    /1   ]  9.85549890477        1
[INPUT] 0    0    [1    /1   ]  27.051575798         1
[INPUT] 0    0    [1    /1   ]  0.385411979701       1
[INPUT] 0    0    [1    /1   ]  1.13025787952        1
[INPUT] 0    0    [1    /1   ]  2.96025585791        1
[INPUT] 1    0    [1    /1   ]  5.07182229687        1
[INPUT] 1    0    [1    /1   ]  14.9457338231        1
[INPUT] 1    0    [1    /1   ]  58.8357980046        1
[INPUT] 1    0    [1    /1   ]  0.226426133933       1
[INPUT] 1    0    [1    /1   ]  1.89876771347        1
[INPUT] 1    0    [1    /1   ]  0.672122164476       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412925197, 1.0]], [0, [3661.454509416909, 1.0]], [0, [833.270065653501, 1.0]], [0, [235.75063998683868, 1.0]], [0, [76.32011428147744, 1.0]], [0, [9.855498904769416, 1.0]], [0, [27.05157579804432, 1.0]], [0, [0.38541197970108887, 1.0]], [0, [1.130257879517521, 1.0]], [0, [2.960255857910259, 1.0]], [1, [5.071822296870898, 1.0]], [1, [14.94573382306832, 1.0]], [1, [58.83579800464026, 1.0]], [1, [0.22642613393254513, 1.0]], [1, [1.89876771346781, 1.0]], [1, [0.6721221644759137, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412925]
bas 1, expnt(s) = [3661.45450942]
bas 2, expnt(s) = [833.27006565]
bas 3, expnt(s) = [235.75063999]
bas 4, expnt(s) = [76.32011428]
bas 5, expnt(s) = [9.8554989]
bas 6, expnt(s) = [27.0515758]
bas 7, expnt(s) = [0.38541198]
bas 8, expnt(s) = [1.13025788]
bas 9, expnt(s) = [2.96025586]
bas 10, expnt(s) = [5.0718223]
bas 11, expnt(s) = [14.94573382]
bas 12, expnt(s) = [58.835798]
bas 13, expnt(s) = [0.22642613]
bas 14, expnt(s) = [1.89876771]
bas 15, expnt(s) = [0.67212216]
CPU time:       151.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145451e+03 1.18920097e+03
 8.33270066e+02 3.91836023e+02 2.35750640e+02 1.52003884e+02
 7.63201143e+01 6.52370454e+01 9.85549890e+00 1.40531598e+01
 2.70515758e+01 2.99681167e+01 3.85411980e-01 1.23583056e+00
 1.13025788e+00 2.76947967e+00 2.96025586e+00 5.70179976e+00
 5.07182230e+00 2.22044197e+01 1.49457338e+01 8.57296295e+01
 5.88357980e+01 4.75375125e+02 2.26426134e-01 4.55661758e-01
 1.89876771e+00 6.50240761e+00 6.72122164e-01 1.77539366e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999801003589933
cond(S) = 347.46230752494006
E1 = -183.5871503325868  E_coul = 55.0800238554412
init E= -128.507126477146
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775061444839762  LUMO = 0.663037134504929
  mo_energy =
[-3.25550580e+01 -1.85257330e+00 -7.75061445e-01 -7.75061445e-01
 -7.75061445e-01  6.63037135e-01  6.63037135e-01  6.63037135e-01
  1.24004760e+00  3.09155857e+00  3.09155857e+00  3.09155857e+00
  7.52001751e+00  1.05671949e+01  1.05671949e+01  1.05671949e+01
  3.48251304e+01  3.50001970e+01  3.50001970e+01  3.50001970e+01
  1.38598937e+02  1.40600240e+02  1.40600240e+02  1.40600240e+02
  5.02427353e+02  1.86999736e+03  7.99972414e+03  4.77674833e+04]
E1 = -182.0596031596005  E_coul = 53.52432191855094
cycle= 1 E= -128.53528124105  delta_E= -0.0282  |g|= 0.208  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.54178
diis-c [-0.29352562  1.        ]
  HOMO = -0.885621095891807  LUMO = 0.643007688676827
  mo_energy =
[-3.28828330e+01 -1.96852803e+00 -8.85621096e-01 -8.85621096e-01
 -8.85621096e-01  6.43007689e-01  6.43007689e-01  6.43007689e-01
  1.19275776e+00  3.01231104e+00  3.01231104e+00  3.01231104e+00
  7.38446693e+00  1.04042317e+01  1.04042317e+01  1.04042317e+01
  3.45750615e+01  3.47454751e+01  3.47454751e+01  3.47454751e+01
  1.38276590e+02  1.40268833e+02  1.40268833e+02  1.40268833e+02
  5.02060835e+02  1.86959479e+03  7.99929262e+03  4.77670329e+04]
E1 = -182.83700030875065  E_coul = 54.299060292256854
cycle= 2 E= -128.537940016494  delta_E= -0.00266  |g|= 0.106  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276822
diis-c [-6.41487079e-04  3.37468584e-01  6.62531416e-01]
  HOMO = -0.84928554078641  LUMO = 0.649610632090989
  mo_energy =
[-3.27728686e+01 -1.93023518e+00 -8.49285541e-01 -8.49285541e-01
 -8.49285541e-01  6.49610632e-01  6.49610632e-01  6.49610632e-01
  1.20799794e+00  3.03802793e+00  3.03802793e+00  3.03802793e+00
  7.42904957e+00  1.04581165e+01  1.04581165e+01  1.04581165e+01
  3.46591264e+01  3.48308815e+01  3.48308815e+01  3.48308815e+01
  1.38384475e+02  1.40379140e+02  1.40379140e+02  1.40379140e+02
  5.02179672e+02  1.86971893e+03  7.99941924e+03  4.77671605e+04]
E1 = -182.57247243864845  E_coul = 54.03357393724297
cycle= 3 E= -128.538898501405  delta_E= -0.000958  |g|= 0.000428  |ddm|= 0.0224
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101218
diis-c [-1.00593897e-07 -2.04086672e-03 -5.18800964e-04  1.00255967e+00]
  HOMO = -0.84951046041403  LUMO = 0.649594248962766
  mo_energy =
[-3.27732691e+01 -1.93040968e+00 -8.49510460e-01 -8.49510460e-01
 -8.49510460e-01  6.49594249e-01  6.49594249e-01  6.49594249e-01
  1.20793597e+00  3.03790951e+00  3.03790951e+00  3.03790951e+00
  7.42886281e+00  1.04578901e+01  1.04578901e+01  1.04578901e+01
  3.46588197e+01  3.48305600e+01  3.48305600e+01  3.48305600e+01
  1.38384072e+02  1.40378720e+02  1.40378720e+02  1.40378720e+02
  5.02179156e+02  1.86971829e+03  7.99941851e+03  4.77671597e+04]
E1 = -182.5728423263725  E_coul = 54.03394380947446
cycle= 4 E= -128.538898516898  delta_E= -1.55e-08  |g|= 7.03e-05  |ddm|= 0.0002
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179523
diis-c [-7.48610850e-10  1.34159150e-04  4.88039396e-04 -1.41175000e-01
  1.14055280e+00]
  HOMO = -0.849548012414307  LUMO = 0.649585556211582
  mo_energy =
[-3.27733356e+01 -1.93044129e+00 -8.49548012e-01 -8.49548012e-01
 -8.49548012e-01  6.49585556e-01  6.49585556e-01  6.49585556e-01
  1.20791819e+00  3.03787941e+00  3.03787941e+00  3.03787941e+00
  7.42882166e+00  1.04578418e+01  1.04578418e+01  1.04578418e+01
  3.46587606e+01  3.48304997e+01  3.48304997e+01  3.48304997e+01
  1.38384005e+02  1.40378653e+02  1.40378653e+02  1.40378653e+02
  5.02179083e+02  1.86971821e+03  7.99941843e+03  4.77671596e+04]
E1 = -182.57297331272838  E_coul = 54.03407479536217
cycle= 5 E= -128.538898517366  delta_E= -4.68e-10  |g|= 3.32e-06  |ddm|= 2.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57297331272838  E_coul = 54.03407479536217
  HOMO = -0.849546665241078  LUMO = 0.649585819961578
  mo_energy =
[-3.27733325e+01 -1.93043934e+00 -8.49546665e-01 -8.49546665e-01
 -8.49546665e-01  6.49585820e-01  6.49585820e-01  6.49585820e-01
  1.20791910e+00  3.03788044e+00  3.03788044e+00  3.03788044e+00
  7.42882367e+00  1.04578438e+01  1.04578438e+01  1.04578438e+01
  3.46587635e+01  3.48305025e+01  3.48305025e+01  3.48305025e+01
  1.38384008e+02  1.40378655e+02  1.40378655e+02  1.40378655e+02
  5.02179086e+02  1.86971822e+03  7.99941843e+03  4.77671596e+04]
E1 = -182.57296527762057  E_coul = 54.034066760253374
Extra cycle  E= -128.538898517367  delta_E= -9.95e-13  |g|= 1.13e-06  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 347.46230752494006
E1 = -182.57296527762057  E_coul = 54.034066760253374
init E= -128.538898517367
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849547251770894  LUMO = 0.649585716192789
  mo_energy =
[-3.27733343e+01 -1.93043985e+00 -8.49547252e-01 -8.49547252e-01
 -8.49547252e-01  6.49585716e-01  6.49585716e-01  6.49585716e-01
  1.20791891e+00  3.03788003e+00  3.03788003e+00  3.03788003e+00
  7.42882301e+00  1.04578429e+01  1.04578429e+01  1.04578429e+01
  3.46587622e+01  3.48305011e+01  3.48305011e+01  3.48305011e+01
  1.38384007e+02  1.40378654e+02  1.40378654e+02  1.40378654e+02
  5.02179084e+02  1.86971821e+03  7.99941843e+03  4.77671596e+04]
E1 = -182.57296959754223  E_coul = 54.03407108017503
cycle= 1 E= -128.538898517367  delta_E=    0  |g|= 6e-07  |ddm|= 3.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57296959754223  E_coul = 54.03407108017503
  HOMO = -0.849546950193819  LUMO = 0.649585772029507
  mo_energy =
[-3.27733334e+01 -1.93043951e+00 -8.49546950e-01 -8.49546950e-01
 -8.49546950e-01  6.49585772e-01  6.49585772e-01  6.49585772e-01
  1.20791905e+00  3.03788025e+00  3.03788025e+00  3.03788025e+00
  7.42882340e+00  1.04578434e+01  1.04578434e+01  1.04578434e+01
  3.46587629e+01  3.48305019e+01  3.48305019e+01  3.48305019e+01
  1.38384008e+02  1.40378655e+02  1.40378655e+02  1.40378655e+02
  5.02179085e+02  1.86971822e+03  7.99941843e+03  4.77671596e+04]
E1 = -182.57296740387645  E_coul = 54.034068886509274
Extra cycle  E= -128.538898517367  delta_E= 2.84e-14  |g|= 2.97e-07  |ddm|= 2.09e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145451e+03 8.33270066e+02 2.35750640e+02
 7.63201143e+01 9.85549890e+00 2.70515758e+01 3.85411980e-01
 1.13025788e+00 2.96025586e+00 5.07182230e+00 1.49457338e+01
 5.88357980e+01 2.26426134e-01 1.89876771e+00 6.72122164e-01]
grad_E = [-1.87327947e-09  9.84490158e-08 -1.93098348e-06  2.21303502e-05
 -1.59957534e-04 -1.45626727e-03  7.47195741e-04  3.52797971e-04
  4.22698319e-04  2.47987988e-04 -1.98072186e-03  4.51623444e-05
 -1.26304480e-04  6.45812534e-03  7.37029672e-03 -1.26833890e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941288        1
[INPUT] 0    0    [1    /1   ]  3661.45453226        1
[INPUT] 0    0    [1    /1   ]  833.269488182        1
[INPUT] 0    0    [1    /1   ]  235.759963147        1
[INPUT] 0    0    [1    /1   ]  76.2535628172        1
[INPUT] 0    0    [1    /1   ]  9.74781516776        1
[INPUT] 0    0    [1    /1   ]  27.0529445993        1
[INPUT] 0    0    [1    /1   ]  0.383202135218       1
[INPUT] 0    0    [1    /1   ]  1.12661336693        1
[INPUT] 0    0    [1    /1   ]  3.01318512089        1
[INPUT] 1    0    [1    /1   ]  5.26659663717        1
[INPUT] 1    0    [1    /1   ]  15.6050113672        1
[INPUT] 1    0    [1    /1   ]  61.409172753         1
[INPUT] 1    0    [1    /1   ]  0.23281540091        1
[INPUT] 1    0    [1    /1   ]  1.95510313658        1
[INPUT] 1    0    [1    /1   ]  0.693866052962       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128824306, 1.0]], [0, [3661.454532260986, 1.0]], [0, [833.2694881820678, 1.0]], [0, [235.75996314739706, 1.0]], [0, [76.25356281724565, 1.0]], [0, [9.747815167759612, 1.0]], [0, [27.052944599300552, 1.0]], [0, [0.3832021352176631, 1.0]], [0, [1.1266133669262115, 1.0]], [0, [3.013185120892738, 1.0]], [1, [5.266596637167297, 1.0]], [1, [15.60501136719755, 1.0]], [1, [61.4091727530172, 1.0]], [1, [0.23281540091007882, 1.0]], [1, [1.955103136583334, 1.0]], [1, [0.6938660529618487, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412882]
bas 1, expnt(s) = [3661.45453226]
bas 2, expnt(s) = [833.26948818]
bas 3, expnt(s) = [235.75996315]
bas 4, expnt(s) = [76.25356282]
bas 5, expnt(s) = [9.74781517]
bas 6, expnt(s) = [27.0529446]
bas 7, expnt(s) = [0.38320214]
bas 8, expnt(s) = [1.12661337]
bas 9, expnt(s) = [3.01318512]
bas 10, expnt(s) = [5.26659664]
bas 11, expnt(s) = [15.60501137]
bas 12, expnt(s) = [61.40917275]
bas 13, expnt(s) = [0.2328154]
bas 14, expnt(s) = [1.95510314]
bas 15, expnt(s) = [0.69386605]
CPU time:       154.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145453e+03 1.18920098e+03
 8.33269488e+02 3.91835819e+02 2.35759963e+02 1.52008392e+02
 7.62535628e+01 6.51943755e+01 9.74781517e+00 1.39378404e+01
 2.70529446e+01 2.99692539e+01 3.83202135e-01 1.23051231e+00
 1.12661337e+00 2.76277934e+00 3.01318512e+00 5.77809110e+00
 5.26659664e+00 2.32753899e+01 1.56050114e+01 9.04824818e+01
 6.14091728e+01 5.01505790e+02 2.32815401e-01 4.71790319e-01
 1.95510314e+00 6.74444913e+00 6.93866053e-01 1.84747659e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9997863837938
cond(S) = 346.8326756146655
E1 = -183.5875249686913  E_coul = 55.08009244409912
init E= -128.507432524592
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775130194357256  LUMO = 0.686718907730421
  mo_energy =
[-3.25549277e+01 -1.85256244e+00 -7.75130194e-01 -7.75130194e-01
 -7.75130194e-01  6.86718908e-01  6.86718908e-01  6.86718908e-01
  1.23393973e+00  3.20035441e+00  3.20035441e+00  3.20035441e+00
  7.55411620e+00  1.09601407e+01  1.09601407e+01  1.09601407e+01
  3.48020631e+01  3.65585044e+01  3.65585044e+01  3.65585044e+01
  1.38367527e+02  1.47462055e+02  1.47462055e+02  1.47462055e+02
  5.02038649e+02  1.86956956e+03  7.99933170e+03  4.77671557e+04]
E1 = -182.0630928310223  E_coul = 53.527575924854816
cycle= 1 E= -128.535516906167  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539791
diis-c [-0.29137447  1.        ]
  HOMO = -0.885464217885324  LUMO = 0.665728736133428
  mo_energy =
[-3.28820877e+01 -1.96822328e+00 -8.85464218e-01 -8.85464218e-01
 -8.85464218e-01  6.65728736e-01  6.65728736e-01  6.65728736e-01
  1.18685426e+00  3.11895386e+00  3.11895386e+00  3.11895386e+00
  7.41831761e+00  1.07942093e+01  1.07942093e+01  1.07942093e+01
  3.45527065e+01  3.63011007e+01  3.63011007e+01  3.63011007e+01
  1.38045825e+02  1.47129462e+02  1.47129462e+02  1.47129462e+02
  5.01672745e+02  1.86916755e+03  7.99890077e+03  4.77667058e+04]
E1 = -182.83845706011155  E_coul = 54.30029065521895
cycle= 2 E= -128.538166404893  delta_E= -0.00265  |g|= 0.106  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275495
diis-c [-6.41927855e-04  3.37208649e-01  6.62791351e-01]
  HOMO = -0.84921412270609  LUMO = 0.67263627125385
  mo_energy =
[-3.27723464e+01 -1.93002364e+00 -8.49214123e-01 -8.49214123e-01
 -8.49214123e-01  6.72636271e-01  6.72636271e-01  6.72636271e-01
  1.20202756e+00  3.14536964e+00  3.14536964e+00  3.14536964e+00
  7.46298674e+00  1.08490865e+01  1.08490865e+01  1.08490865e+01
  3.46364939e+01  3.63874138e+01  3.63874138e+01  3.63874138e+01
  1.38153464e+02  1.47240046e+02  1.47240046e+02  1.47240046e+02
  5.01791340e+02  1.86929144e+03  7.99902713e+03  4.77668331e+04]
E1 = -182.5746458487576  E_coul = 54.035525968688155
cycle= 3 E= -128.539119880069  delta_E= -0.000953  |g|= 0.000449  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107721
diis-c [-1.11052414e-07 -2.08927998e-03 -3.70122294e-04  1.00245940e+00]
  HOMO = -0.849447526073624  LUMO = 0.672616030182637
  mo_energy =
[-3.27727669e+01 -1.93020451e+00 -8.49447526e-01 -8.49447526e-01
 -8.49447526e-01  6.72616030e-01  6.72616030e-01  6.72616030e-01
  1.20196173e+00  3.14524032e+00  3.14524032e+00  3.14524032e+00
  7.46279091e+00  1.08488441e+01  1.08488441e+01  1.08488441e+01
  3.46361717e+01  3.63870727e+01  3.63870727e+01  3.63870727e+01
  1.38153040e+02  1.47239600e+02  1.47239600e+02  1.47239600e+02
  5.01790798e+02  1.86929078e+03  7.99902637e+03  4.77668323e+04]
E1 = -182.5750581601027  E_coul = 54.03593826281379
cycle= 4 E= -128.539119897289  delta_E= -1.72e-08  |g|= 7.32e-05  |ddm|= 0.000204
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187292
diis-c [-7.77326436e-10  1.45371027e-04  4.92967087e-04 -1.46337584e-01
  1.14569925e+00]
  HOMO = -0.849486428227603  LUMO = 0.67260661881677
  mo_energy =
[-3.27728364e+01 -1.93023693e+00 -8.49486428e-01 -8.49486428e-01
 -8.49486428e-01  6.72606619e-01  6.72606619e-01  6.72606619e-01
  1.20194353e+00  3.14520847e+00  3.14520847e+00  3.14520847e+00
  7.46274843e+00  1.08487935e+01  1.08487935e+01  1.08487935e+01
  3.46361103e+01  3.63870096e+01  3.63870096e+01  3.63870096e+01
  1.38152971e+02  1.47239530e+02  1.47239530e+02  1.47239530e+02
  5.01790721e+02  1.86929069e+03  7.99902628e+03  4.77668322e+04]
E1 = -182.57519526356646  E_coul = 54.036075365768696
cycle= 5 E= -128.539119897798  delta_E= -5.09e-10  |g|= 3.58e-06  |ddm|= 2.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57519526356646  E_coul = 54.036075365768696
  HOMO = -0.849484872739722  LUMO = 0.672606950919509
  mo_energy =
[-3.27728329e+01 -1.93023475e+00 -8.49484873e-01 -8.49484873e-01
 -8.49484873e-01  6.72606951e-01  6.72606951e-01  6.72606951e-01
  1.20194457e+00  3.14520971e+00  3.14520971e+00  3.14520971e+00
  7.46275071e+00  1.08487958e+01  1.08487958e+01  1.08487958e+01
  3.46361136e+01  3.63870128e+01  3.63870128e+01  3.63870128e+01
  1.38152974e+02  1.47239533e+02  1.47239533e+02  1.47239533e+02
  5.01790724e+02  1.86929070e+03  7.99902629e+03  4.77668322e+04]
E1 = -182.57518638577142  E_coul = 54.03606648797263
Extra cycle  E= -128.539119897799  delta_E= -1.02e-12  |g|= 1.25e-06  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145453e+03 8.33269488e+02 2.35759963e+02
 7.62535628e+01 9.74781517e+00 2.70529446e+01 3.83202135e-01
 1.12661337e+00 3.01318512e+00 5.26659664e+00 1.56050114e+01
 6.14091728e+01 2.32815401e-01 1.95510314e+00 6.93866053e-01]
E = -128.5391198977988
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941288        1
[INPUT] 0    0    [1    /1   ]  3661.45453226        1
[INPUT] 0    0    [1    /1   ]  833.269488182        1
[INPUT] 0    0    [1    /1   ]  235.759963147        1
[INPUT] 0    0    [1    /1   ]  76.2535628172        1
[INPUT] 0    0    [1    /1   ]  9.74781516776        1
[INPUT] 0    0    [1    /1   ]  27.0529445993        1
[INPUT] 0    0    [1    /1   ]  0.383202135218       1
[INPUT] 0    0    [1    /1   ]  1.12661336693        1
[INPUT] 0    0    [1    /1   ]  3.01318512089        1
[INPUT] 1    0    [1    /1   ]  5.26659663717        1
[INPUT] 1    0    [1    /1   ]  15.6050113672        1
[INPUT] 1    0    [1    /1   ]  61.409172753         1
[INPUT] 1    0    [1    /1   ]  0.23281540091        1
[INPUT] 1    0    [1    /1   ]  1.95510313658        1
[INPUT] 1    0    [1    /1   ]  0.693866052962       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128824306, 1.0]], [0, [3661.454532260986, 1.0]], [0, [833.2694881820678, 1.0]], [0, [235.75996314739706, 1.0]], [0, [76.25356281724565, 1.0]], [0, [9.747815167759612, 1.0]], [0, [27.052944599300552, 1.0]], [0, [0.3832021352176631, 1.0]], [0, [1.1266133669262115, 1.0]], [0, [3.013185120892738, 1.0]], [1, [5.266596637167297, 1.0]], [1, [15.60501136719755, 1.0]], [1, [61.4091727530172, 1.0]], [1, [0.23281540091007882, 1.0]], [1, [1.955103136583334, 1.0]], [1, [0.6938660529618487, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412882]
bas 1, expnt(s) = [3661.45453226]
bas 2, expnt(s) = [833.26948818]
bas 3, expnt(s) = [235.75996315]
bas 4, expnt(s) = [76.25356282]
bas 5, expnt(s) = [9.74781517]
bas 6, expnt(s) = [27.0529446]
bas 7, expnt(s) = [0.38320214]
bas 8, expnt(s) = [1.12661337]
bas 9, expnt(s) = [3.01318512]
bas 10, expnt(s) = [5.26659664]
bas 11, expnt(s) = [15.60501137]
bas 12, expnt(s) = [61.40917275]
bas 13, expnt(s) = [0.2328154]
bas 14, expnt(s) = [1.95510314]
bas 15, expnt(s) = [0.69386605]
CPU time:       155.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145453e+03 1.18920098e+03
 8.33269488e+02 3.91835819e+02 2.35759963e+02 1.52008392e+02
 7.62535628e+01 6.51943755e+01 9.74781517e+00 1.39378404e+01
 2.70529446e+01 2.99692539e+01 3.83202135e-01 1.23051231e+00
 1.12661337e+00 2.76277934e+00 3.01318512e+00 5.77809110e+00
 5.26659664e+00 2.32753899e+01 1.56050114e+01 9.04824818e+01
 6.14091728e+01 5.01505790e+02 2.32815401e-01 4.71790319e-01
 1.95510314e+00 6.74444913e+00 6.93866053e-01 1.84747659e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9997863837938
cond(S) = 346.8326756146655
E1 = -183.5875249686913  E_coul = 55.08009244409912
init E= -128.507432524592
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775130194357256  LUMO = 0.686718907730421
  mo_energy =
[-3.25549277e+01 -1.85256244e+00 -7.75130194e-01 -7.75130194e-01
 -7.75130194e-01  6.86718908e-01  6.86718908e-01  6.86718908e-01
  1.23393973e+00  3.20035441e+00  3.20035441e+00  3.20035441e+00
  7.55411620e+00  1.09601407e+01  1.09601407e+01  1.09601407e+01
  3.48020631e+01  3.65585044e+01  3.65585044e+01  3.65585044e+01
  1.38367527e+02  1.47462055e+02  1.47462055e+02  1.47462055e+02
  5.02038649e+02  1.86956956e+03  7.99933170e+03  4.77671557e+04]
E1 = -182.0630928310223  E_coul = 53.527575924854816
cycle= 1 E= -128.535516906167  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539791
diis-c [-0.29137447  1.        ]
  HOMO = -0.885464217885324  LUMO = 0.665728736133428
  mo_energy =
[-3.28820877e+01 -1.96822328e+00 -8.85464218e-01 -8.85464218e-01
 -8.85464218e-01  6.65728736e-01  6.65728736e-01  6.65728736e-01
  1.18685426e+00  3.11895386e+00  3.11895386e+00  3.11895386e+00
  7.41831761e+00  1.07942093e+01  1.07942093e+01  1.07942093e+01
  3.45527065e+01  3.63011007e+01  3.63011007e+01  3.63011007e+01
  1.38045825e+02  1.47129462e+02  1.47129462e+02  1.47129462e+02
  5.01672745e+02  1.86916755e+03  7.99890077e+03  4.77667058e+04]
E1 = -182.83845706011155  E_coul = 54.30029065521895
cycle= 2 E= -128.538166404893  delta_E= -0.00265  |g|= 0.106  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275495
diis-c [-6.41927855e-04  3.37208649e-01  6.62791351e-01]
  HOMO = -0.84921412270609  LUMO = 0.67263627125385
  mo_energy =
[-3.27723464e+01 -1.93002364e+00 -8.49214123e-01 -8.49214123e-01
 -8.49214123e-01  6.72636271e-01  6.72636271e-01  6.72636271e-01
  1.20202756e+00  3.14536964e+00  3.14536964e+00  3.14536964e+00
  7.46298674e+00  1.08490865e+01  1.08490865e+01  1.08490865e+01
  3.46364939e+01  3.63874138e+01  3.63874138e+01  3.63874138e+01
  1.38153464e+02  1.47240046e+02  1.47240046e+02  1.47240046e+02
  5.01791340e+02  1.86929144e+03  7.99902713e+03  4.77668331e+04]
E1 = -182.5746458487576  E_coul = 54.035525968688155
cycle= 3 E= -128.539119880069  delta_E= -0.000953  |g|= 0.000449  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107721
diis-c [-1.11052414e-07 -2.08927998e-03 -3.70122294e-04  1.00245940e+00]
  HOMO = -0.849447526073624  LUMO = 0.672616030182637
  mo_energy =
[-3.27727669e+01 -1.93020451e+00 -8.49447526e-01 -8.49447526e-01
 -8.49447526e-01  6.72616030e-01  6.72616030e-01  6.72616030e-01
  1.20196173e+00  3.14524032e+00  3.14524032e+00  3.14524032e+00
  7.46279091e+00  1.08488441e+01  1.08488441e+01  1.08488441e+01
  3.46361717e+01  3.63870727e+01  3.63870727e+01  3.63870727e+01
  1.38153040e+02  1.47239600e+02  1.47239600e+02  1.47239600e+02
  5.01790798e+02  1.86929078e+03  7.99902637e+03  4.77668323e+04]
E1 = -182.5750581601027  E_coul = 54.03593826281379
cycle= 4 E= -128.539119897289  delta_E= -1.72e-08  |g|= 7.32e-05  |ddm|= 0.000204
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187292
diis-c [-7.77326436e-10  1.45371027e-04  4.92967087e-04 -1.46337584e-01
  1.14569925e+00]
  HOMO = -0.849486428227603  LUMO = 0.67260661881677
  mo_energy =
[-3.27728364e+01 -1.93023693e+00 -8.49486428e-01 -8.49486428e-01
 -8.49486428e-01  6.72606619e-01  6.72606619e-01  6.72606619e-01
  1.20194353e+00  3.14520847e+00  3.14520847e+00  3.14520847e+00
  7.46274843e+00  1.08487935e+01  1.08487935e+01  1.08487935e+01
  3.46361103e+01  3.63870096e+01  3.63870096e+01  3.63870096e+01
  1.38152971e+02  1.47239530e+02  1.47239530e+02  1.47239530e+02
  5.01790721e+02  1.86929069e+03  7.99902628e+03  4.77668322e+04]
E1 = -182.57519526356646  E_coul = 54.036075365768696
cycle= 5 E= -128.539119897798  delta_E= -5.09e-10  |g|= 3.58e-06  |ddm|= 2.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57519526356646  E_coul = 54.036075365768696
  HOMO = -0.849484872739722  LUMO = 0.672606950919509
  mo_energy =
[-3.27728329e+01 -1.93023475e+00 -8.49484873e-01 -8.49484873e-01
 -8.49484873e-01  6.72606951e-01  6.72606951e-01  6.72606951e-01
  1.20194457e+00  3.14520971e+00  3.14520971e+00  3.14520971e+00
  7.46275071e+00  1.08487958e+01  1.08487958e+01  1.08487958e+01
  3.46361136e+01  3.63870128e+01  3.63870128e+01  3.63870128e+01
  1.38152974e+02  1.47239533e+02  1.47239533e+02  1.47239533e+02
  5.01790724e+02  1.86929070e+03  7.99902629e+03  4.77668322e+04]
E1 = -182.57518638577142  E_coul = 54.03606648797263
Extra cycle  E= -128.539119897799  delta_E= -1.02e-12  |g|= 1.25e-06  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.8326756146655
E1 = -182.57518638577142  E_coul = 54.03606648797263
init E= -128.539119897799
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849485516173284  LUMO = 0.672606833375761
  mo_energy =
[-3.27728348e+01 -1.93023532e+00 -8.49485516e-01 -8.49485516e-01
 -8.49485516e-01  6.72606833e-01  6.72606833e-01  6.72606833e-01
  1.20194436e+00  3.14520926e+00  3.14520926e+00  3.14520926e+00
  7.46274998e+00  1.08487949e+01  1.08487949e+01  1.08487949e+01
  3.46361121e+01  3.63870113e+01  3.63870113e+01  3.63870113e+01
  1.38152972e+02  1.47239531e+02  1.47239531e+02  1.47239531e+02
  5.01790722e+02  1.86929069e+03  7.99902628e+03  4.77668322e+04]
E1 = -182.5751912133995  E_coul = 54.036071315600566
cycle= 1 E= -128.539119897799  delta_E= -1.42e-13  |g|= 6.68e-07  |ddm|= 4.04e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5751912133995  E_coul = 54.036071315600566
  HOMO = -0.849485178418408  LUMO = 0.672606899148183
  mo_energy =
[-3.27728338e+01 -1.93023494e+00 -8.49485178e-01 -8.49485178e-01
 -8.49485178e-01  6.72606899e-01  6.72606899e-01  6.72606899e-01
  1.20194452e+00  3.14520951e+00  3.14520951e+00  3.14520951e+00
  7.46275041e+00  1.08487954e+01  1.08487954e+01  1.08487954e+01
  3.46361129e+01  3.63870121e+01  3.63870121e+01  3.63870121e+01
  1.38152973e+02  1.47239532e+02  1.47239532e+02  1.47239532e+02
  5.01790723e+02  1.86929070e+03  7.99902628e+03  4.77668322e+04]
E1 = -182.57518877024106  E_coul = 54.03606887244228
Extra cycle  E= -128.539119897799  delta_E= 1.71e-13  |g|= 3.31e-07  |ddm|= 2.32e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145453e+03 8.33269488e+02 2.35759963e+02
 7.62535628e+01 9.74781517e+00 2.70529446e+01 3.83202135e-01
 1.12661337e+00 3.01318512e+00 5.26659664e+00 1.56050114e+01
 6.14091728e+01 2.32815401e-01 1.95510314e+00 6.93866053e-01]
grad_E = [-2.98499065e-09  1.57264488e-07 -3.07840480e-06  3.55701486e-05
 -2.55294027e-04 -2.27472327e-03  1.18785881e-03  1.98491458e-04
  2.88790809e-04  4.17947697e-04 -1.42994884e-03  1.74538133e-05
 -1.09165686e-04  4.82908619e-03  5.34319195e-03 -8.87254689e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941286        1
[INPUT] 0    0    [1    /1   ]  3661.45454374        1
[INPUT] 0    0    [1    /1   ]  833.269197072        1
[INPUT] 0    0    [1    /1   ]  235.764677713        1
[INPUT] 0    0    [1    /1   ]  76.21996276          1
[INPUT] 0    0    [1    /1   ]  9.69719722897        1
[INPUT] 0    0    [1    /1   ]  27.0514929786        1
[INPUT] 0    0    [1    /1   ]  0.379851296064       1
[INPUT] 0    0    [1    /1   ]  1.11872726555        1
[INPUT] 0    0    [1    /1   ]  3.04045161656        1
[INPUT] 1    0    [1    /1   ]  5.39565295059        1
[INPUT] 1    0    [1    /1   ]  16.0812149907        1
[INPUT] 1    0    [1    /1   ]  62.6983702449        1
[INPUT] 1    0    [1    /1   ]  0.23589899971        1
[INPUT] 1    0    [1    /1   ]  1.97226005371        1
[INPUT] 1    0    [1    /1   ]  0.702793251481       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128609516, 1.0]], [0, [3661.4545437353354, 1.0]], [0, [833.2691970716717, 1.0]], [0, [235.76467771274508, 1.0]], [0, [76.21996276002213, 1.0]], [0, [9.697197228967775, 1.0]], [0, [27.051492978573172, 1.0]], [0, [0.37985129606388995, 1.0]], [0, [1.1187272655510612, 1.0]], [0, [3.040451616557569, 1.0]], [1, [5.3956529505914705, 1.0]], [1, [16.08121499065944, 1.0]], [1, [62.69837024487195, 1.0]], [1, [0.23589899971030184, 1.0]], [1, [1.9722600537106076, 1.0]], [1, [0.7027932514808776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412861]
bas 1, expnt(s) = [3661.45454374]
bas 2, expnt(s) = [833.26919707]
bas 3, expnt(s) = [235.76467771]
bas 4, expnt(s) = [76.21996276]
bas 5, expnt(s) = [9.69719723]
bas 6, expnt(s) = [27.05149298]
bas 7, expnt(s) = [0.3798513]
bas 8, expnt(s) = [1.11872727]
bas 9, expnt(s) = [3.04045162]
bas 10, expnt(s) = [5.39565295]
bas 11, expnt(s) = [16.08121499]
bas 12, expnt(s) = [62.69837024]
bas 13, expnt(s) = [0.235899]
bas 14, expnt(s) = [1.97226005]
bas 15, expnt(s) = [0.70279325]
CPU time:       158.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269197e+02 3.91835716e+02 2.35764678e+02 1.52010672e+02
 7.62199628e+01 6.51728290e+01 9.69719723e+00 1.38835234e+01
 2.70514930e+01 2.99680478e+01 3.79851296e-01 1.22243347e+00
 1.11872727e+00 2.74826237e+00 3.04045162e+00 5.81726163e+00
 5.39565295e+00 2.39905057e+01 1.60812150e+01 9.39470105e+01
 6.26983702e+01 5.14700639e+02 2.35899000e-01 4.79614182e-01
 1.97226005e+00 6.81851210e+00 7.02793251e-01 1.87723599e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999782179209445
cond(S) = 345.05003300699343
E1 = -183.58768102174992  E_coul = 55.08013598358138
init E= -128.507545038169
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775167762967795  LUMO = 0.697908124875803
  mo_energy =
[-3.25548430e+01 -1.85255946e+00 -7.75167763e-01 -7.75167763e-01
 -7.75167763e-01  6.97908125e-01  6.97908125e-01  6.97908125e-01
  1.22135598e+00  3.24465550e+00  3.24465550e+00  3.24465550e+00
  7.54266820e+00  1.11460403e+01  1.11460403e+01  1.11460403e+01
  3.47616700e+01  3.75491552e+01  3.75491552e+01  3.75491552e+01
  1.38228574e+02  1.51429873e+02  1.51429873e+02  1.51429873e+02
  5.01822204e+02  1.86933520e+03  7.99911738e+03  4.77669768e+04]
E1 = -182.06453299040624  E_coul = 53.52890678590223
cycle= 1 E= -128.535626204504  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53876
diis-c [-0.29026267  1.        ]
  HOMO = -0.885418407087165  LUMO = 0.676456082150157
  mo_energy =
[-3.28817390e+01 -1.96809384e+00 -8.85418407e-01 -8.85418407e-01
 -8.85418407e-01  6.76456082e-01  6.76456082e-01  6.76456082e-01
  1.17462734e+00  3.16240344e+00  3.16240344e+00  3.16240344e+00
  7.40683352e+00  1.09783474e+01  1.09783474e+01  1.09783474e+01
  3.45125630e+01  3.72897646e+01  3.72897646e+01  3.72897646e+01
  1.37907143e+02  1.51096646e+02  1.51096646e+02  1.51096646e+02
  5.01456578e+02  1.86893345e+03  7.99868671e+03  4.77665272e+04]
E1 = -182.8390223425167  E_coul = 54.30075028670765
cycle= 2 E= -128.538272055809  delta_E= -0.00265  |g|= 0.105  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274795
diis-c [-6.42890081e-04  3.37062965e-01  6.62937035e-01]
  HOMO = -0.849203294603936  LUMO = 0.683501245322211
  mo_energy =
[-3.27720869e+01 -1.92993370e+00 -8.49203295e-01 -8.49203295e-01
 -8.49203295e-01  6.83501245e-01  6.83501245e-01  6.83501245e-01
  1.18967626e+00  3.18908967e+00  3.18908967e+00  3.18908967e+00
  7.45152002e+00  1.10338119e+01  1.10338119e+01  1.10338119e+01
  3.45962414e+01  3.73767554e+01  3.73767554e+01  3.73767554e+01
  1.38014683e+02  1.51207393e+02  1.51207393e+02  1.51207393e+02
  5.01575075e+02  1.86905724e+03  7.99881297e+03  4.77666544e+04]
E1 = -182.57546566308898  E_coul = 54.036242237494385
cycle= 3 E= -128.539223425595  delta_E= -0.000951  |g|= 0.000468  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112669
diis-c [-1.21715770e-07 -2.13711981e-03 -2.84949093e-04  1.00242207e+00]
  HOMO = -0.849445493840247  LUMO = 0.683476957385433
  mo_energy =
[-3.27725257e+01 -1.93012262e+00 -8.49445494e-01 -8.49445494e-01
 -8.49445494e-01  6.83476957e-01  6.83476957e-01  6.83476957e-01
  1.18960493e+00  3.18895060e+00  3.18895060e+00  3.18895060e+00
  7.45131495e+00  1.10335550e+01  1.10335550e+01  1.10335550e+01
  3.45959043e+01  3.73763966e+01  3.73763966e+01  3.73763966e+01
  1.38014240e+02  1.51206926e+02  1.51206926e+02  1.51206926e+02
  5.01574510e+02  1.86905655e+03  7.99881218e+03  4.77666535e+04]
E1 = -182.5759011483804  E_coul = 54.03667770360188
cycle= 4 E= -128.539223444779  delta_E= -1.92e-08  |g|= 7.61e-05  |ddm|= 0.000212
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000193825
diis-c [-7.78679915e-10  1.50061144e-04  4.96471294e-04 -1.48535793e-01
  1.14788926e+00]
  HOMO = -0.849486095836224  LUMO = 0.683466821443185
  mo_energy =
[-3.27725983e+01 -1.93015665e+00 -8.49486096e-01 -8.49486096e-01
 -8.49486096e-01  6.83466821e-01  6.83466821e-01  6.83466821e-01
  1.18958576e+00  3.18891694e+00  3.18891694e+00  3.18891694e+00
  7.45127062e+00  1.10335018e+01  1.10335018e+01  1.10335018e+01
  3.45958403e+01  3.73763306e+01  3.73763306e+01  3.73763306e+01
  1.38014167e+02  1.51206852e+02  1.51206852e+02  1.51206852e+02
  5.01574431e+02  1.86905646e+03  7.99881209e+03  4.77666535e+04]
E1 = -182.5760421682917  E_coul = 54.036818722962806
cycle= 5 E= -128.539223445329  delta_E= -5.5e-10  |g|= 3.64e-06  |ddm|= 3.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5760421682917  E_coul = 54.036818722962806
  HOMO = -0.849484457584497  LUMO = 0.683467181576567
  mo_energy =
[-3.27725946e+01 -1.93015440e+00 -8.49484458e-01 -8.49484458e-01
 -8.49484458e-01  6.83467182e-01  6.83467182e-01  6.83467182e-01
  1.18958682e+00  3.18891826e+00  3.18891826e+00  3.18891826e+00
  7.45127299e+00  1.10335042e+01  1.10335042e+01  1.10335042e+01
  3.45958437e+01  3.73763340e+01  3.73763340e+01  3.73763340e+01
  1.38014171e+02  1.51206856e+02  1.51206856e+02  1.51206856e+02
  5.01574434e+02  1.86905647e+03  7.99881209e+03  4.77666535e+04]
E1 = -182.57603281091002  E_coul = 54.036809365580034
Extra cycle  E= -128.53922344533  delta_E= -1.08e-12  |g|= 1.31e-06  |ddm|= 1.5e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269197e+02 2.35764678e+02
 7.62199628e+01 9.69719723e+00 2.70514930e+01 3.79851296e-01
 1.11872727e+00 3.04045162e+00 5.39565295e+00 1.60812150e+01
 6.26983702e+01 2.35899000e-01 1.97226005e+00 7.02793251e-01]
E = -128.53922344532998
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941286        1
[INPUT] 0    0    [1    /1   ]  3661.45454374        1
[INPUT] 0    0    [1    /1   ]  833.269197072        1
[INPUT] 0    0    [1    /1   ]  235.764677713        1
[INPUT] 0    0    [1    /1   ]  76.21996276          1
[INPUT] 0    0    [1    /1   ]  9.69719722897        1
[INPUT] 0    0    [1    /1   ]  27.0514929786        1
[INPUT] 0    0    [1    /1   ]  0.379851296064       1
[INPUT] 0    0    [1    /1   ]  1.11872726555        1
[INPUT] 0    0    [1    /1   ]  3.04045161656        1
[INPUT] 1    0    [1    /1   ]  5.39565295059        1
[INPUT] 1    0    [1    /1   ]  16.0812149907        1
[INPUT] 1    0    [1    /1   ]  62.6983702449        1
[INPUT] 1    0    [1    /1   ]  0.23589899971        1
[INPUT] 1    0    [1    /1   ]  1.97226005371        1
[INPUT] 1    0    [1    /1   ]  0.702793251481       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128609516, 1.0]], [0, [3661.4545437353354, 1.0]], [0, [833.2691970716717, 1.0]], [0, [235.76467771274508, 1.0]], [0, [76.21996276002213, 1.0]], [0, [9.697197228967775, 1.0]], [0, [27.051492978573172, 1.0]], [0, [0.37985129606388995, 1.0]], [0, [1.1187272655510612, 1.0]], [0, [3.040451616557569, 1.0]], [1, [5.3956529505914705, 1.0]], [1, [16.08121499065944, 1.0]], [1, [62.69837024487195, 1.0]], [1, [0.23589899971030184, 1.0]], [1, [1.9722600537106076, 1.0]], [1, [0.7027932514808776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412861]
bas 1, expnt(s) = [3661.45454374]
bas 2, expnt(s) = [833.26919707]
bas 3, expnt(s) = [235.76467771]
bas 4, expnt(s) = [76.21996276]
bas 5, expnt(s) = [9.69719723]
bas 6, expnt(s) = [27.05149298]
bas 7, expnt(s) = [0.3798513]
bas 8, expnt(s) = [1.11872727]
bas 9, expnt(s) = [3.04045162]
bas 10, expnt(s) = [5.39565295]
bas 11, expnt(s) = [16.08121499]
bas 12, expnt(s) = [62.69837024]
bas 13, expnt(s) = [0.235899]
bas 14, expnt(s) = [1.97226005]
bas 15, expnt(s) = [0.70279325]
CPU time:       159.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269197e+02 3.91835716e+02 2.35764678e+02 1.52010672e+02
 7.62199628e+01 6.51728290e+01 9.69719723e+00 1.38835234e+01
 2.70514930e+01 2.99680478e+01 3.79851296e-01 1.22243347e+00
 1.11872727e+00 2.74826237e+00 3.04045162e+00 5.81726163e+00
 5.39565295e+00 2.39905057e+01 1.60812150e+01 9.39470105e+01
 6.26983702e+01 5.14700639e+02 2.35899000e-01 4.79614182e-01
 1.97226005e+00 6.81851210e+00 7.02793251e-01 1.87723599e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999782179209445
cond(S) = 345.05003300699343
E1 = -183.58768102174992  E_coul = 55.08013598358138
init E= -128.507545038169
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775167762967795  LUMO = 0.697908124875803
  mo_energy =
[-3.25548430e+01 -1.85255946e+00 -7.75167763e-01 -7.75167763e-01
 -7.75167763e-01  6.97908125e-01  6.97908125e-01  6.97908125e-01
  1.22135598e+00  3.24465550e+00  3.24465550e+00  3.24465550e+00
  7.54266820e+00  1.11460403e+01  1.11460403e+01  1.11460403e+01
  3.47616700e+01  3.75491552e+01  3.75491552e+01  3.75491552e+01
  1.38228574e+02  1.51429873e+02  1.51429873e+02  1.51429873e+02
  5.01822204e+02  1.86933520e+03  7.99911738e+03  4.77669768e+04]
E1 = -182.06453299040624  E_coul = 53.52890678590223
cycle= 1 E= -128.535626204504  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53876
diis-c [-0.29026267  1.        ]
  HOMO = -0.885418407087165  LUMO = 0.676456082150157
  mo_energy =
[-3.28817390e+01 -1.96809384e+00 -8.85418407e-01 -8.85418407e-01
 -8.85418407e-01  6.76456082e-01  6.76456082e-01  6.76456082e-01
  1.17462734e+00  3.16240344e+00  3.16240344e+00  3.16240344e+00
  7.40683352e+00  1.09783474e+01  1.09783474e+01  1.09783474e+01
  3.45125630e+01  3.72897646e+01  3.72897646e+01  3.72897646e+01
  1.37907143e+02  1.51096646e+02  1.51096646e+02  1.51096646e+02
  5.01456578e+02  1.86893345e+03  7.99868671e+03  4.77665272e+04]
E1 = -182.8390223425167  E_coul = 54.30075028670765
cycle= 2 E= -128.538272055809  delta_E= -0.00265  |g|= 0.105  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274795
diis-c [-6.42890081e-04  3.37062965e-01  6.62937035e-01]
  HOMO = -0.849203294603936  LUMO = 0.683501245322211
  mo_energy =
[-3.27720869e+01 -1.92993370e+00 -8.49203295e-01 -8.49203295e-01
 -8.49203295e-01  6.83501245e-01  6.83501245e-01  6.83501245e-01
  1.18967626e+00  3.18908967e+00  3.18908967e+00  3.18908967e+00
  7.45152002e+00  1.10338119e+01  1.10338119e+01  1.10338119e+01
  3.45962414e+01  3.73767554e+01  3.73767554e+01  3.73767554e+01
  1.38014683e+02  1.51207393e+02  1.51207393e+02  1.51207393e+02
  5.01575075e+02  1.86905724e+03  7.99881297e+03  4.77666544e+04]
E1 = -182.57546566308898  E_coul = 54.036242237494385
cycle= 3 E= -128.539223425595  delta_E= -0.000951  |g|= 0.000468  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112669
diis-c [-1.21715770e-07 -2.13711981e-03 -2.84949093e-04  1.00242207e+00]
  HOMO = -0.849445493840247  LUMO = 0.683476957385433
  mo_energy =
[-3.27725257e+01 -1.93012262e+00 -8.49445494e-01 -8.49445494e-01
 -8.49445494e-01  6.83476957e-01  6.83476957e-01  6.83476957e-01
  1.18960493e+00  3.18895060e+00  3.18895060e+00  3.18895060e+00
  7.45131495e+00  1.10335550e+01  1.10335550e+01  1.10335550e+01
  3.45959043e+01  3.73763966e+01  3.73763966e+01  3.73763966e+01
  1.38014240e+02  1.51206926e+02  1.51206926e+02  1.51206926e+02
  5.01574510e+02  1.86905655e+03  7.99881218e+03  4.77666535e+04]
E1 = -182.5759011483804  E_coul = 54.03667770360188
cycle= 4 E= -128.539223444779  delta_E= -1.92e-08  |g|= 7.61e-05  |ddm|= 0.000212
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000193825
diis-c [-7.78679915e-10  1.50061144e-04  4.96471294e-04 -1.48535793e-01
  1.14788926e+00]
  HOMO = -0.849486095836224  LUMO = 0.683466821443185
  mo_energy =
[-3.27725983e+01 -1.93015665e+00 -8.49486096e-01 -8.49486096e-01
 -8.49486096e-01  6.83466821e-01  6.83466821e-01  6.83466821e-01
  1.18958576e+00  3.18891694e+00  3.18891694e+00  3.18891694e+00
  7.45127062e+00  1.10335018e+01  1.10335018e+01  1.10335018e+01
  3.45958403e+01  3.73763306e+01  3.73763306e+01  3.73763306e+01
  1.38014167e+02  1.51206852e+02  1.51206852e+02  1.51206852e+02
  5.01574431e+02  1.86905646e+03  7.99881209e+03  4.77666535e+04]
E1 = -182.5760421682917  E_coul = 54.036818722962806
cycle= 5 E= -128.539223445329  delta_E= -5.5e-10  |g|= 3.64e-06  |ddm|= 3.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5760421682917  E_coul = 54.036818722962806
  HOMO = -0.849484457584497  LUMO = 0.683467181576567
  mo_energy =
[-3.27725946e+01 -1.93015440e+00 -8.49484458e-01 -8.49484458e-01
 -8.49484458e-01  6.83467182e-01  6.83467182e-01  6.83467182e-01
  1.18958682e+00  3.18891826e+00  3.18891826e+00  3.18891826e+00
  7.45127299e+00  1.10335042e+01  1.10335042e+01  1.10335042e+01
  3.45958437e+01  3.73763340e+01  3.73763340e+01  3.73763340e+01
  1.38014171e+02  1.51206856e+02  1.51206856e+02  1.51206856e+02
  5.01574434e+02  1.86905647e+03  7.99881209e+03  4.77666535e+04]
E1 = -182.57603281091002  E_coul = 54.036809365580034
Extra cycle  E= -128.53922344533  delta_E= -1.08e-12  |g|= 1.31e-06  |ddm|= 1.5e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.05003300699343
E1 = -182.57603281091002  E_coul = 54.036809365580034
init E= -128.53922344533
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849485133647561  LUMO = 0.683467055626894
  mo_energy =
[-3.27725966e+01 -1.93015500e+00 -8.49485134e-01 -8.49485134e-01
 -8.49485134e-01  6.83467056e-01  6.83467056e-01  6.83467056e-01
  1.18958661e+00  3.18891777e+00  3.18891777e+00  3.18891777e+00
  7.45127222e+00  1.10335032e+01  1.10335032e+01  1.10335032e+01
  3.45958421e+01  3.73763324e+01  3.73763324e+01  3.73763324e+01
  1.38014169e+02  1.51206854e+02  1.51206854e+02  1.51206854e+02
  5.01574431e+02  1.86905646e+03  7.99881209e+03  4.77666535e+04]
E1 = -182.57603789748566  E_coul = 54.036814452155525
cycle= 1 E= -128.53922344533  delta_E= -1.71e-13  |g|= 7.03e-07  |ddm|= 4.25e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57603789748566  E_coul = 54.036814452155525
  HOMO = -0.849484777367214  LUMO = 0.683467126442172
  mo_energy =
[-3.27725956e+01 -1.93015460e+00 -8.49484777e-01 -8.49484777e-01
 -8.49484777e-01  6.83467126e-01  6.83467126e-01  6.83467126e-01
  1.18958677e+00  3.18891804e+00  3.18891804e+00  3.18891804e+00
  7.45127267e+00  1.10335038e+01  1.10335038e+01  1.10335038e+01
  3.45958430e+01  3.73763333e+01  3.73763333e+01  3.73763333e+01
  1.38014170e+02  1.51206855e+02  1.51206855e+02  1.51206855e+02
  5.01574433e+02  1.86905647e+03  7.99881209e+03  4.77666535e+04]
E1 = -182.57603532245358  E_coul = 54.036811877123476
Extra cycle  E= -128.53922344533  delta_E= 5.68e-14  |g|= 3.49e-07  |ddm|= 2.44e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269197e+02 2.35764678e+02
 7.62199628e+01 9.69719723e+00 2.70514930e+01 3.79851296e-01
 1.11872727e+00 3.04045162e+00 5.39565295e+00 1.60812150e+01
 6.26983702e+01 2.35899000e-01 1.97226005e+00 7.02793251e-01]
grad_E = [-3.49387908e-09  1.84273946e-07 -3.60196374e-06  4.17302247e-05
 -2.98436740e-04 -2.63004303e-03  1.38851738e-03  1.47684441e-04
 -8.35352273e-05  5.41825395e-04 -5.34853370e-04 -7.21982399e-06
 -1.09991866e-04  1.43355589e-03  1.96415545e-03 -3.16935447e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941286        1
[INPUT] 0    0    [1    /1   ]  3661.45454446        1
[INPUT] 0    0    [1    /1   ]  833.269177057        1
[INPUT] 0    0    [1    /1   ]  235.765023913        1
[INPUT] 0    0    [1    /1   ]  76.2175464           1
[INPUT] 0    0    [1    /1   ]  9.69802520321        1
[INPUT] 0    0    [1    /1   ]  27.0486760707        1
[INPUT] 0    0    [1    /1   ]  0.378193543622       1
[INPUT] 0    0    [1    /1   ]  1.11491435215        1
[INPUT] 0    0    [1    /1   ]  3.04214518326        1
[INPUT] 1    0    [1    /1   ]  5.4498842154         1
[INPUT] 1    0    [1    /1   ]  16.2511798567        1
[INPUT] 1    0    [1    /1   ]  62.7867234981        1
[INPUT] 1    0    [1    /1   ]  0.237760322944       1
[INPUT] 1    0    [1    /1   ]  1.97622523842        1
[INPUT] 1    0    [1    /1   ]  0.706764284738       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412859592, 1.0]], [0, [3661.454544463619, 1.0]], [0, [833.2691770574536, 1.0]], [0, [235.7650239129647, 1.0]], [0, [76.21754639997935, 1.0]], [0, [9.69802520320867, 1.0]], [0, [27.04867607071795, 1.0]], [0, [0.37819354362248053, 1.0]], [0, [1.1149143521472635, 1.0]], [0, [3.042145183257385, 1.0]], [1, [5.449884215399088, 1.0]], [1, [16.251179856747672, 1.0]], [1, [62.78672349810656, 1.0]], [1, [0.23776032294409757, 1.0]], [1, [1.976225238419945, 1.0]], [1, [0.7067642847375407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941286]
bas 1, expnt(s) = [3661.45454446]
bas 2, expnt(s) = [833.26917706]
bas 3, expnt(s) = [235.76502391]
bas 4, expnt(s) = [76.2175464]
bas 5, expnt(s) = [9.6980252]
bas 6, expnt(s) = [27.04867607]
bas 7, expnt(s) = [0.37819354]
bas 8, expnt(s) = [1.11491435]
bas 9, expnt(s) = [3.04214518]
bas 10, expnt(s) = [5.44988422]
bas 11, expnt(s) = [16.25117986]
bas 12, expnt(s) = [62.7867235]
bas 13, expnt(s) = [0.23776032]
bas 14, expnt(s) = [1.97622524]
bas 15, expnt(s) = [0.70676428]
CPU time:       162.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269177e+02 3.91835709e+02 2.35765024e+02 1.52010839e+02
 7.62175464e+01 6.51712794e+01 9.69802520e+00 1.38844124e+01
 2.70486761e+01 2.99657074e+01 3.78193544e-01 1.21843007e+00
 1.11491435e+00 2.74123428e+00 3.04214518e+00 5.81969168e+00
 5.44988422e+00 2.42922917e+01 1.62511799e+01 9.51898217e+01
 6.27867235e+01 5.15607431e+02 2.37760323e-01 4.84349237e-01
 1.97622524e+00 6.83565199e+00 7.06764285e-01 1.89050416e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99977826582581
cond(S) = 344.02369997273775
E1 = -183.5877290881502  E_coul = 55.080139713925064
init E= -128.507589374225
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775171838654239  LUMO = 0.70415289915171
  mo_energy =
[-3.25548405e+01 -1.85256149e+00 -7.75171839e-01 -7.75171839e-01
 -7.75171839e-01  7.04152899e-01  7.04152899e-01  7.04152899e-01
  1.21478643e+00  3.26407429e+00  3.26407429e+00  3.26407429e+00
  7.52534860e+00  1.12177803e+01  1.12177803e+01  1.12177803e+01
  3.47446603e+01  3.79235709e+01  3.79235709e+01  3.79235709e+01
  1.38209055e+02  1.52294330e+02  1.52294330e+02  1.52294330e+02
  5.01796777e+02  1.86930889e+03  7.99909354e+03  4.77669570e+04]
E1 = -182.06522485885188  E_coul = 53.52956505262683
cycle= 1 E= -128.535659806225  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538741
diis-c [-0.29024136  1.        ]
  HOMO = -0.885375254717688  LUMO = 0.682464406930802
  mo_energy =
[-3.28816186e+01 -1.96802910e+00 -8.85375255e-01 -8.85375255e-01
 -8.85375255e-01  6.82464407e-01  6.82464407e-01  6.82464407e-01
  1.16827147e+00  3.18154826e+00  3.18154826e+00  3.18154826e+00
  7.38963291e+00  1.10494682e+01  1.10494682e+01  1.10494682e+01
  3.44956041e+01  3.76635181e+01  3.76635181e+01  3.76635181e+01
  1.37887734e+02  1.51961150e+02  1.51961150e+02  1.51961150e+02
  5.01431279e+02  1.86890727e+03  7.99866299e+03  4.77665075e+04]
E1 = -182.8392333225515  E_coul = 54.30092912357633
cycle= 2 E= -128.538304198975  delta_E= -0.00264  |g|= 0.105  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274687
diis-c [-6.43175446e-04  3.36982133e-01  6.63017867e-01]
  HOMO = -0.849179653985572  LUMO = 0.689580012975412
  mo_energy =
[-3.27720142e+01 -1.92989101e+00 -8.49179654e-01 -8.49179654e-01
 -8.49179654e-01  6.89580013e-01  6.89580013e-01  6.89580013e-01
  1.18324684e+00  3.20832066e+00  3.20832066e+00  3.20832066e+00
  7.43428080e+00  1.11051377e+01  1.11051377e+01  1.11051377e+01
  3.45792504e+01  3.77507285e+01  3.77507285e+01  3.77507285e+01
  1.37995228e+02  1.52071872e+02  1.52071872e+02  1.52071872e+02
  5.01549725e+02  1.86903100e+03  7.99878919e+03  4.77666346e+04]
E1 = -182.57584434782368  E_coul = 54.03658997901918
cycle= 3 E= -128.539254368805  delta_E= -0.00095  |g|= 0.000476  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114489
diis-c [-1.26233724e-07 -2.15723705e-03 -2.61895957e-04  1.00241913e+00]
  HOMO = -0.849425248404268  LUMO = 0.689553826247063
  mo_energy =
[-3.27724598e+01 -1.93008302e+00 -8.49425248e-01 -8.49425248e-01
 -8.49425248e-01  6.89553826e-01  6.89553826e-01  6.89553826e-01
  1.18317321e+00  3.20817767e+00  3.20817767e+00  3.20817767e+00
  7.43407241e+00  1.11048754e+01  1.11048754e+01  1.11048754e+01
  3.45789077e+01  3.77503632e+01  3.77503632e+01  3.77503632e+01
  1.37994778e+02  1.52071399e+02  1.52071399e+02  1.52071399e+02
  5.01549152e+02  1.86903030e+03  7.99878839e+03  4.77666337e+04]
E1 = -182.5762857255489  E_coul = 54.03703133664989
cycle= 4 E= -128.539254388899  delta_E= -2.01e-08  |g|= 7.74e-05  |ddm|= 0.000217
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000196708
diis-c [-7.79818629e-10  1.52103123e-04  4.99983043e-04 -1.49417189e-01
  1.14876510e+00]
  HOMO = -0.849466610351581  LUMO = 0.689543337376638
  mo_energy =
[-3.27725337e+01 -1.93011777e+00 -8.49466610e-01 -8.49466610e-01
 -8.49466610e-01  6.89543337e-01  6.89543337e-01  6.89543337e-01
  1.18315360e+00  3.20814323e+00  3.20814323e+00  3.20814323e+00
  7.43402728e+00  1.11048210e+01  1.11048210e+01  1.11048210e+01
  3.45788425e+01  3.77502959e+01  3.77502959e+01  3.77502959e+01
  1.37994704e+02  1.52071324e+02  1.52071324e+02  1.52071324e+02
  5.01549071e+02  1.86903021e+03  7.99878829e+03  4.77666336e+04]
E1 = -182.57642820605867  E_coul = 54.037173816589494
cycle= 5 E= -128.539254389469  delta_E= -5.7e-10  |g|= 3.66e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57642820605867  E_coul = 54.037173816589494
  HOMO = -0.849464945491807  LUMO = 0.689543709051771
  mo_energy =
[-3.27725299e+01 -1.93011550e+00 -8.49464945e-01 -8.49464945e-01
 -8.49464945e-01  6.89543709e-01  6.89543709e-01  6.89543709e-01
  1.18315467e+00  3.20814457e+00  3.20814457e+00  3.20814457e+00
  7.43402968e+00  1.11048235e+01  1.11048235e+01  1.11048235e+01
  3.45788460e+01  3.77502993e+01  3.77502993e+01  3.77502993e+01
  1.37994708e+02  1.52071327e+02  1.52071327e+02  1.52071327e+02
  5.01549074e+02  1.86903022e+03  7.99878830e+03  4.77666336e+04]
E1 = -182.57641870132215  E_coul = 54.03716431185166
Extra cycle  E= -128.53925438947  delta_E= -1.34e-12  |g|= 1.33e-06  |ddm|= 1.5e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269177e+02 2.35765024e+02
 7.62175464e+01 9.69802520e+00 2.70486761e+01 3.78193544e-01
 1.11491435e+00 3.04214518e+00 5.44988422e+00 1.62511799e+01
 6.27867235e+01 2.37760323e-01 1.97622524e+00 7.06764285e-01]
E = -128.5392543894705
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941286        1
[INPUT] 0    0    [1    /1   ]  3661.45454446        1
[INPUT] 0    0    [1    /1   ]  833.269177057        1
[INPUT] 0    0    [1    /1   ]  235.765023913        1
[INPUT] 0    0    [1    /1   ]  76.2175464           1
[INPUT] 0    0    [1    /1   ]  9.69802520321        1
[INPUT] 0    0    [1    /1   ]  27.0486760707        1
[INPUT] 0    0    [1    /1   ]  0.378193543622       1
[INPUT] 0    0    [1    /1   ]  1.11491435215        1
[INPUT] 0    0    [1    /1   ]  3.04214518326        1
[INPUT] 1    0    [1    /1   ]  5.4498842154         1
[INPUT] 1    0    [1    /1   ]  16.2511798567        1
[INPUT] 1    0    [1    /1   ]  62.7867234981        1
[INPUT] 1    0    [1    /1   ]  0.237760322944       1
[INPUT] 1    0    [1    /1   ]  1.97622523842        1
[INPUT] 1    0    [1    /1   ]  0.706764284738       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412859592, 1.0]], [0, [3661.454544463619, 1.0]], [0, [833.2691770574536, 1.0]], [0, [235.7650239129647, 1.0]], [0, [76.21754639997935, 1.0]], [0, [9.69802520320867, 1.0]], [0, [27.04867607071795, 1.0]], [0, [0.37819354362248053, 1.0]], [0, [1.1149143521472635, 1.0]], [0, [3.042145183257385, 1.0]], [1, [5.449884215399088, 1.0]], [1, [16.251179856747672, 1.0]], [1, [62.78672349810656, 1.0]], [1, [0.23776032294409757, 1.0]], [1, [1.976225238419945, 1.0]], [1, [0.7067642847375407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941286]
bas 1, expnt(s) = [3661.45454446]
bas 2, expnt(s) = [833.26917706]
bas 3, expnt(s) = [235.76502391]
bas 4, expnt(s) = [76.2175464]
bas 5, expnt(s) = [9.6980252]
bas 6, expnt(s) = [27.04867607]
bas 7, expnt(s) = [0.37819354]
bas 8, expnt(s) = [1.11491435]
bas 9, expnt(s) = [3.04214518]
bas 10, expnt(s) = [5.44988422]
bas 11, expnt(s) = [16.25117986]
bas 12, expnt(s) = [62.7867235]
bas 13, expnt(s) = [0.23776032]
bas 14, expnt(s) = [1.97622524]
bas 15, expnt(s) = [0.70676428]
CPU time:       162.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269177e+02 3.91835709e+02 2.35765024e+02 1.52010839e+02
 7.62175464e+01 6.51712794e+01 9.69802520e+00 1.38844124e+01
 2.70486761e+01 2.99657074e+01 3.78193544e-01 1.21843007e+00
 1.11491435e+00 2.74123428e+00 3.04214518e+00 5.81969168e+00
 5.44988422e+00 2.42922917e+01 1.62511799e+01 9.51898217e+01
 6.27867235e+01 5.15607431e+02 2.37760323e-01 4.84349237e-01
 1.97622524e+00 6.83565199e+00 7.06764285e-01 1.89050416e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99977826582581
cond(S) = 344.02369997273775
E1 = -183.5877290881502  E_coul = 55.080139713925064
init E= -128.507589374225
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775171838654239  LUMO = 0.70415289915171
  mo_energy =
[-3.25548405e+01 -1.85256149e+00 -7.75171839e-01 -7.75171839e-01
 -7.75171839e-01  7.04152899e-01  7.04152899e-01  7.04152899e-01
  1.21478643e+00  3.26407429e+00  3.26407429e+00  3.26407429e+00
  7.52534860e+00  1.12177803e+01  1.12177803e+01  1.12177803e+01
  3.47446603e+01  3.79235709e+01  3.79235709e+01  3.79235709e+01
  1.38209055e+02  1.52294330e+02  1.52294330e+02  1.52294330e+02
  5.01796777e+02  1.86930889e+03  7.99909354e+03  4.77669570e+04]
E1 = -182.06522485885188  E_coul = 53.52956505262683
cycle= 1 E= -128.535659806225  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538741
diis-c [-0.29024136  1.        ]
  HOMO = -0.885375254717688  LUMO = 0.682464406930802
  mo_energy =
[-3.28816186e+01 -1.96802910e+00 -8.85375255e-01 -8.85375255e-01
 -8.85375255e-01  6.82464407e-01  6.82464407e-01  6.82464407e-01
  1.16827147e+00  3.18154826e+00  3.18154826e+00  3.18154826e+00
  7.38963291e+00  1.10494682e+01  1.10494682e+01  1.10494682e+01
  3.44956041e+01  3.76635181e+01  3.76635181e+01  3.76635181e+01
  1.37887734e+02  1.51961150e+02  1.51961150e+02  1.51961150e+02
  5.01431279e+02  1.86890727e+03  7.99866299e+03  4.77665075e+04]
E1 = -182.8392333225515  E_coul = 54.30092912357633
cycle= 2 E= -128.538304198975  delta_E= -0.00264  |g|= 0.105  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274687
diis-c [-6.43175446e-04  3.36982133e-01  6.63017867e-01]
  HOMO = -0.849179653985572  LUMO = 0.689580012975412
  mo_energy =
[-3.27720142e+01 -1.92989101e+00 -8.49179654e-01 -8.49179654e-01
 -8.49179654e-01  6.89580013e-01  6.89580013e-01  6.89580013e-01
  1.18324684e+00  3.20832066e+00  3.20832066e+00  3.20832066e+00
  7.43428080e+00  1.11051377e+01  1.11051377e+01  1.11051377e+01
  3.45792504e+01  3.77507285e+01  3.77507285e+01  3.77507285e+01
  1.37995228e+02  1.52071872e+02  1.52071872e+02  1.52071872e+02
  5.01549725e+02  1.86903100e+03  7.99878919e+03  4.77666346e+04]
E1 = -182.57584434782368  E_coul = 54.03658997901918
cycle= 3 E= -128.539254368805  delta_E= -0.00095  |g|= 0.000476  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114489
diis-c [-1.26233724e-07 -2.15723705e-03 -2.61895957e-04  1.00241913e+00]
  HOMO = -0.849425248404268  LUMO = 0.689553826247063
  mo_energy =
[-3.27724598e+01 -1.93008302e+00 -8.49425248e-01 -8.49425248e-01
 -8.49425248e-01  6.89553826e-01  6.89553826e-01  6.89553826e-01
  1.18317321e+00  3.20817767e+00  3.20817767e+00  3.20817767e+00
  7.43407241e+00  1.11048754e+01  1.11048754e+01  1.11048754e+01
  3.45789077e+01  3.77503632e+01  3.77503632e+01  3.77503632e+01
  1.37994778e+02  1.52071399e+02  1.52071399e+02  1.52071399e+02
  5.01549152e+02  1.86903030e+03  7.99878839e+03  4.77666337e+04]
E1 = -182.5762857255489  E_coul = 54.03703133664989
cycle= 4 E= -128.539254388899  delta_E= -2.01e-08  |g|= 7.74e-05  |ddm|= 0.000217
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000196708
diis-c [-7.79818629e-10  1.52103123e-04  4.99983043e-04 -1.49417189e-01
  1.14876510e+00]
  HOMO = -0.849466610351581  LUMO = 0.689543337376638
  mo_energy =
[-3.27725337e+01 -1.93011777e+00 -8.49466610e-01 -8.49466610e-01
 -8.49466610e-01  6.89543337e-01  6.89543337e-01  6.89543337e-01
  1.18315360e+00  3.20814323e+00  3.20814323e+00  3.20814323e+00
  7.43402728e+00  1.11048210e+01  1.11048210e+01  1.11048210e+01
  3.45788425e+01  3.77502959e+01  3.77502959e+01  3.77502959e+01
  1.37994704e+02  1.52071324e+02  1.52071324e+02  1.52071324e+02
  5.01549071e+02  1.86903021e+03  7.99878829e+03  4.77666336e+04]
E1 = -182.57642820605867  E_coul = 54.037173816589494
cycle= 5 E= -128.539254389469  delta_E= -5.7e-10  |g|= 3.66e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57642820605867  E_coul = 54.037173816589494
  HOMO = -0.849464945491807  LUMO = 0.689543709051771
  mo_energy =
[-3.27725299e+01 -1.93011550e+00 -8.49464945e-01 -8.49464945e-01
 -8.49464945e-01  6.89543709e-01  6.89543709e-01  6.89543709e-01
  1.18315467e+00  3.20814457e+00  3.20814457e+00  3.20814457e+00
  7.43402968e+00  1.11048235e+01  1.11048235e+01  1.11048235e+01
  3.45788460e+01  3.77502993e+01  3.77502993e+01  3.77502993e+01
  1.37994708e+02  1.52071327e+02  1.52071327e+02  1.52071327e+02
  5.01549074e+02  1.86903022e+03  7.99878830e+03  4.77666336e+04]
E1 = -182.57641870132215  E_coul = 54.03716431185166
Extra cycle  E= -128.53925438947  delta_E= -1.34e-12  |g|= 1.33e-06  |ddm|= 1.5e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.02369997273775
E1 = -182.57641870132215  E_coul = 54.03716431185166
init E= -128.53925438947
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.849465631395179  LUMO = 0.689543580036304
  mo_energy =
[-3.27725320e+01 -1.93011612e+00 -8.49465631e-01 -8.49465631e-01
 -8.49465631e-01  6.89543580e-01  6.89543580e-01  6.89543580e-01
  1.18315445e+00  3.20814407e+00  3.20814407e+00  3.20814407e+00
  7.43402889e+00  1.11048225e+01  1.11048225e+01  1.11048225e+01
  3.45788445e+01  3.77502977e+01  3.77502977e+01  3.77502977e+01
  1.37994706e+02  1.52071325e+02  1.52071325e+02  1.52071325e+02
  5.01549072e+02  1.86903021e+03  7.99878829e+03  4.77666336e+04]
E1 = -182.57642386873383  E_coul = 54.037169479263305
cycle= 1 E= -128.539254389471  delta_E= -2.84e-14  |g|= 7.13e-07  |ddm|= 4.33e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57642386873383  E_coul = 54.037169479263305
  HOMO = -0.849465269307506  LUMO = 0.689543652770044
  mo_energy =
[-3.27725309e+01 -1.93011571e+00 -8.49465269e-01 -8.49465269e-01
 -8.49465269e-01  6.89543653e-01  6.89543653e-01  6.89543653e-01
  1.18315461e+00  3.20814435e+00  3.20814435e+00  3.20814435e+00
  7.43402935e+00  1.11048230e+01  1.11048230e+01  1.11048230e+01
  3.45788453e+01  3.77502986e+01  3.77502986e+01  3.77502986e+01
  1.37994707e+02  1.52071326e+02  1.52071326e+02  1.52071326e+02
  5.01549073e+02  1.86903021e+03  7.99878830e+03  4.77666336e+04]
E1 = -182.57642125314655  E_coul = 54.037166863676035
Extra cycle  E= -128.53925438947  delta_E= 2.84e-14  |g|= 3.55e-07  |ddm|= 2.47e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269177e+02 2.35765024e+02
 7.62175464e+01 9.69802520e+00 2.70486761e+01 3.78193544e-01
 1.11491435e+00 3.04214518e+00 5.44988422e+00 1.62511799e+01
 6.27867235e+01 2.37760323e-01 1.97622524e+00 7.06764285e-01]
grad_E = [-3.47525456e-09  1.83274566e-07 -3.58186506e-06  4.14680560e-05
 -2.96372002e-04 -2.60435493e-03  1.37778005e-03 -1.38868083e-06
 -2.11764541e-04  5.74939359e-04  6.70135178e-05 -2.84119628e-05
 -1.16228566e-04 -7.87335876e-05 -2.09482168e-04  1.17835728e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941286        1
[INPUT] 0    0    [1    /1   ]  3661.45454267        1
[INPUT] 0    0    [1    /1   ]  833.269220327        1
[INPUT] 0    0    [1    /1   ]  235.76435714         1
[INPUT] 0    0    [1    /1   ]  76.2223519236        1
[INPUT] 0    0    [1    /1   ]  9.71130647886        1
[INPUT] 0    0    [1    /1   ]  27.0451446071        1
[INPUT] 0    0    [1    /1   ]  0.377434674262       1
[INPUT] 0    0    [1    /1   ]  1.11322740709        1
[INPUT] 0    0    [1    /1   ]  3.03760136672        1
[INPUT] 1    0    [1    /1   ]  5.48952688297        1
[INPUT] 1    0    [1    /1   ]  16.3220451159        1
[INPUT] 1    0    [1    /1   ]  62.6056115048        1
[INPUT] 1    0    [1    /1   ]  0.239878971062       1
[INPUT] 1    0    [1    /1   ]  1.98789750606        1
[INPUT] 1    0    [1    /1   ]  0.712853498003       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412862962, 1.0]], [0, [3661.454542667168, 1.0]], [0, [833.2692203268155, 1.0]], [0, [235.7643571395186, 1.0]], [0, [76.22235192357465, 1.0]], [0, [9.711306478862214, 1.0]], [0, [27.045144607064344, 1.0]], [0, [0.37743467426171545, 1.0]], [0, [1.1132274070914212, 1.0]], [0, [3.0376013667177326, 1.0]], [1, [5.489526882965299, 1.0]], [1, [16.32204511586293, 1.0]], [1, [62.6056115047908, 1.0]], [1, [0.23987897106213957, 1.0]], [1, [1.9878975060610684, 1.0]], [1, [0.7128534980027044, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412863]
bas 1, expnt(s) = [3661.45454267]
bas 2, expnt(s) = [833.26922033]
bas 3, expnt(s) = [235.76435714]
bas 4, expnt(s) = [76.22235192]
bas 5, expnt(s) = [9.71130648]
bas 6, expnt(s) = [27.04514461]
bas 7, expnt(s) = [0.37743467]
bas 8, expnt(s) = [1.11322741]
bas 9, expnt(s) = [3.03760137]
bas 10, expnt(s) = [5.48952688]
bas 11, expnt(s) = [16.32204512]
bas 12, expnt(s) = [62.6056115]
bas 13, expnt(s) = [0.23987897]
bas 14, expnt(s) = [1.98789751]
bas 15, expnt(s) = [0.7128535]
CPU time:       166.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269220e+02 3.91835725e+02 2.35764357e+02 1.52010517e+02
 7.62223519e+01 6.51743612e+01 9.71130648e+00 1.38986708e+01
 2.70451446e+01 2.99627731e+01 3.77434674e-01 1.21659596e+00
 1.11322741e+00 2.73812293e+00 3.03760137e+00 5.81317114e+00
 5.48952688e+00 2.45133710e+01 1.63220451e+01 9.57089628e+01
 6.26056115e+01 5.13748977e+02 2.39878971e-01 4.89750191e-01
 1.98789751e+00 6.88615634e+00 7.12853498e-01 1.91088587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999770756760586
cond(S) = 343.4998790093634
E1 = -183.58776955058482  E_coul = 55.08014654678859
init E= -128.507623003796
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775166340151312  LUMO = 0.711646078443713
  mo_energy =
[-3.25548592e+01 -1.85256280e+00 -7.75166340e-01 -7.75166340e-01
 -7.75166340e-01  7.11646078e-01  7.11646078e-01  7.11646078e-01
  1.21164394e+00  3.29323703e+00  3.29323703e+00  3.29323703e+00
  7.51244308e+00  1.13060610e+01  1.13060610e+01  1.13060610e+01
  3.47400651e+01  3.81803549e+01  3.81803549e+01  3.81803549e+01
  1.38223596e+02  1.52413567e+02  1.52413567e+02  1.52413567e+02
  5.01820937e+02  1.86933539e+03  7.99911784e+03  4.77669772e+04]
E1 = -182.06604597916873  E_coul = 53.53036466414428
cycle= 1 E= -128.535681315024  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538916
diis-c [-0.29043028  1.        ]
  HOMO = -0.885308660093082  LUMO = 0.689669819753909
  mo_energy =
[-3.28815001e+01 -1.96795540e+00 -8.85308660e-01 -8.85308660e-01
 -8.85308660e-01  6.89669820e-01  6.89669820e-01  6.89669820e-01
  1.16526598e+00  3.21025038e+00  3.21025038e+00  3.21025038e+00
  7.37688643e+00  1.11372861e+01  1.11372861e+01  1.11372861e+01
  3.44910716e+01  3.79201182e+01  3.79201182e+01  3.79201182e+01
  1.37902402e+02  1.52080658e+02  1.52080658e+02  1.52080658e+02
  5.01455585e+02  1.86893392e+03  7.99868744e+03  4.77665279e+04]
E1 = -182.83945886685146  E_coul = 54.30113514023045
cycle= 2 E= -128.538323726621  delta_E= -0.00264  |g|= 0.105  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274686
diis-c [-6.43096014e-04  3.36908314e-01  6.63091686e-01]
  HOMO = -0.849138727915245  LUMO = 0.696876030817683
  mo_energy =
[-3.27719595e+01 -1.92984561e+00 -8.49138728e-01 -8.49138728e-01
 -8.49138728e-01  6.96876031e-01  6.96876031e-01  6.96876031e-01
  1.18019455e+00  3.23717085e+00  3.23717085e+00  3.23717085e+00
  7.42147716e+00  1.11931062e+01  1.11931062e+01  1.11931062e+01
  3.45746819e+01  3.80073783e+01  3.80073783e+01  3.80073783e+01
  1.38009837e+02  1.52191282e+02  1.52191282e+02  1.52191282e+02
  5.01573964e+02  1.86905759e+03  7.99881357e+03  4.77666550e+04]
E1 = -182.57630751141414  E_coul = 54.03703509440669
cycle= 3 E= -128.539272417007  delta_E= -0.000949  |g|= 0.000479  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115257
diis-c [-1.27771488e-07 -2.16634825e-03 -2.54123265e-04  1.00242047e+00]
  HOMO = -0.849385453984417  LUMO = 0.69684883152793
  mo_energy =
[-3.27724072e+01 -1.93003847e+00 -8.49385454e-01 -8.49385454e-01
 -8.49385454e-01  6.96848832e-01  6.96848832e-01  6.96848832e-01
  1.18012022e+00  3.23702582e+00  3.23702582e+00  3.23702582e+00
  7.42126782e+00  1.11928417e+01  1.11928417e+01  1.11928417e+01
  3.45743374e+01  3.80070109e+01  3.80070109e+01  3.80070109e+01
  1.38009385e+02  1.52190806e+02  1.52190806e+02  1.52190806e+02
  5.01573389e+02  1.86905688e+03  7.99881276e+03  4.77666541e+04]
E1 = -182.5767516061606  E_coul = 54.03747916872328
cycle= 4 E= -128.539272437437  delta_E= -2.04e-08  |g|= 7.79e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000198091
diis-c [-7.83094173e-10  1.54098750e-04  5.03191752e-04 -1.50113494e-01
  1.14945620e+00]
  HOMO = -0.849427061538743  LUMO = 0.696838143626345
  mo_energy =
[-3.27724816e+01 -1.93007339e+00 -8.49427062e-01 -8.49427062e-01
 -8.49427062e-01  6.96838144e-01  6.96838144e-01  6.96838144e-01
  1.18010053e+00  3.23699101e+00  3.23699101e+00  3.23699101e+00
  7.42122248e+00  1.11927869e+01  1.11927869e+01  1.11927869e+01
  3.45742718e+01  3.80069431e+01  3.80069431e+01  3.80069431e+01
  1.38009311e+02  1.52190730e+02  1.52190730e+02  1.52190730e+02
  5.01573307e+02  1.86905679e+03  7.99881267e+03  4.77666540e+04]
E1 = -182.5768948775839  E_coul = 54.03762243956895
cycle= 5 E= -128.539272438015  delta_E= -5.78e-10  |g|= 3.69e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5768948775839  E_coul = 54.03762243956895
  HOMO = -0.849425371301762  LUMO = 0.696838528883874
  mo_energy =
[-3.27724778e+01 -1.93007109e+00 -8.49425371e-01 -8.49425371e-01
 -8.49425371e-01  6.96838529e-01  6.96838529e-01  6.96838529e-01
  1.18010162e+00  3.23699238e+00  3.23699238e+00  3.23699238e+00
  7.42122491e+00  1.11927894e+01  1.11927894e+01  1.11927894e+01
  3.45742754e+01  3.80069467e+01  3.80069467e+01  3.80069467e+01
  1.38009314e+02  1.52190734e+02  1.52190734e+02  1.52190734e+02
  5.01573310e+02  1.86905680e+03  7.99881267e+03  4.77666540e+04]
E1 = -182.5768853095158  E_coul = 54.037612871499945
Extra cycle  E= -128.539272438016  delta_E= -9.09e-13  |g|= 1.34e-06  |ddm|= 1.51e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269220e+02 2.35764357e+02
 7.62223519e+01 9.71130648e+00 2.70451446e+01 3.77434674e-01
 1.11322741e+00 3.03760137e+00 5.48952688e+00 1.63220451e+01
 6.26056115e+01 2.39878971e-01 1.98789751e+00 7.12853498e-01]
E = -128.53927243801587
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941286        1
[INPUT] 0    0    [1    /1   ]  3661.45454267        1
[INPUT] 0    0    [1    /1   ]  833.269220327        1
[INPUT] 0    0    [1    /1   ]  235.76435714         1
[INPUT] 0    0    [1    /1   ]  76.2223519236        1
[INPUT] 0    0    [1    /1   ]  9.71130647886        1
[INPUT] 0    0    [1    /1   ]  27.0451446071        1
[INPUT] 0    0    [1    /1   ]  0.377434674262       1
[INPUT] 0    0    [1    /1   ]  1.11322740709        1
[INPUT] 0    0    [1    /1   ]  3.03760136672        1
[INPUT] 1    0    [1    /1   ]  5.48952688297        1
[INPUT] 1    0    [1    /1   ]  16.3220451159        1
[INPUT] 1    0    [1    /1   ]  62.6056115048        1
[INPUT] 1    0    [1    /1   ]  0.239878971062       1
[INPUT] 1    0    [1    /1   ]  1.98789750606        1
[INPUT] 1    0    [1    /1   ]  0.712853498003       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412862962, 1.0]], [0, [3661.454542667168, 1.0]], [0, [833.2692203268155, 1.0]], [0, [235.7643571395186, 1.0]], [0, [76.22235192357465, 1.0]], [0, [9.711306478862214, 1.0]], [0, [27.045144607064344, 1.0]], [0, [0.37743467426171545, 1.0]], [0, [1.1132274070914212, 1.0]], [0, [3.0376013667177326, 1.0]], [1, [5.489526882965299, 1.0]], [1, [16.32204511586293, 1.0]], [1, [62.6056115047908, 1.0]], [1, [0.23987897106213957, 1.0]], [1, [1.9878975060610684, 1.0]], [1, [0.7128534980027044, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412863]
bas 1, expnt(s) = [3661.45454267]
bas 2, expnt(s) = [833.26922033]
bas 3, expnt(s) = [235.76435714]
bas 4, expnt(s) = [76.22235192]
bas 5, expnt(s) = [9.71130648]
bas 6, expnt(s) = [27.04514461]
bas 7, expnt(s) = [0.37743467]
bas 8, expnt(s) = [1.11322741]
bas 9, expnt(s) = [3.03760137]
bas 10, expnt(s) = [5.48952688]
bas 11, expnt(s) = [16.32204512]
bas 12, expnt(s) = [62.6056115]
bas 13, expnt(s) = [0.23987897]
bas 14, expnt(s) = [1.98789751]
bas 15, expnt(s) = [0.7128535]
CPU time:       166.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269220e+02 3.91835725e+02 2.35764357e+02 1.52010517e+02
 7.62223519e+01 6.51743612e+01 9.71130648e+00 1.38986708e+01
 2.70451446e+01 2.99627731e+01 3.77434674e-01 1.21659596e+00
 1.11322741e+00 2.73812293e+00 3.03760137e+00 5.81317114e+00
 5.48952688e+00 2.45133710e+01 1.63220451e+01 9.57089628e+01
 6.26056115e+01 5.13748977e+02 2.39878971e-01 4.89750191e-01
 1.98789751e+00 6.88615634e+00 7.12853498e-01 1.91088587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999770756760586
cond(S) = 343.4998790093634
E1 = -183.58776955058482  E_coul = 55.08014654678859
init E= -128.507623003796
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775166340151312  LUMO = 0.711646078443713
  mo_energy =
[-3.25548592e+01 -1.85256280e+00 -7.75166340e-01 -7.75166340e-01
 -7.75166340e-01  7.11646078e-01  7.11646078e-01  7.11646078e-01
  1.21164394e+00  3.29323703e+00  3.29323703e+00  3.29323703e+00
  7.51244308e+00  1.13060610e+01  1.13060610e+01  1.13060610e+01
  3.47400651e+01  3.81803549e+01  3.81803549e+01  3.81803549e+01
  1.38223596e+02  1.52413567e+02  1.52413567e+02  1.52413567e+02
  5.01820937e+02  1.86933539e+03  7.99911784e+03  4.77669772e+04]
E1 = -182.06604597916873  E_coul = 53.53036466414428
cycle= 1 E= -128.535681315024  delta_E= -0.0281  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538916
diis-c [-0.29043028  1.        ]
  HOMO = -0.885308660093082  LUMO = 0.689669819753909
  mo_energy =
[-3.28815001e+01 -1.96795540e+00 -8.85308660e-01 -8.85308660e-01
 -8.85308660e-01  6.89669820e-01  6.89669820e-01  6.89669820e-01
  1.16526598e+00  3.21025038e+00  3.21025038e+00  3.21025038e+00
  7.37688643e+00  1.11372861e+01  1.11372861e+01  1.11372861e+01
  3.44910716e+01  3.79201182e+01  3.79201182e+01  3.79201182e+01
  1.37902402e+02  1.52080658e+02  1.52080658e+02  1.52080658e+02
  5.01455585e+02  1.86893392e+03  7.99868744e+03  4.77665279e+04]
E1 = -182.83945886685146  E_coul = 54.30113514023045
cycle= 2 E= -128.538323726621  delta_E= -0.00264  |g|= 0.105  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274686
diis-c [-6.43096014e-04  3.36908314e-01  6.63091686e-01]
  HOMO = -0.849138727915245  LUMO = 0.696876030817683
  mo_energy =
[-3.27719595e+01 -1.92984561e+00 -8.49138728e-01 -8.49138728e-01
 -8.49138728e-01  6.96876031e-01  6.96876031e-01  6.96876031e-01
  1.18019455e+00  3.23717085e+00  3.23717085e+00  3.23717085e+00
  7.42147716e+00  1.11931062e+01  1.11931062e+01  1.11931062e+01
  3.45746819e+01  3.80073783e+01  3.80073783e+01  3.80073783e+01
  1.38009837e+02  1.52191282e+02  1.52191282e+02  1.52191282e+02
  5.01573964e+02  1.86905759e+03  7.99881357e+03  4.77666550e+04]
E1 = -182.57630751141414  E_coul = 54.03703509440669
cycle= 3 E= -128.539272417007  delta_E= -0.000949  |g|= 0.000479  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115257
diis-c [-1.27771488e-07 -2.16634825e-03 -2.54123265e-04  1.00242047e+00]
  HOMO = -0.849385453984417  LUMO = 0.69684883152793
  mo_energy =
[-3.27724072e+01 -1.93003847e+00 -8.49385454e-01 -8.49385454e-01
 -8.49385454e-01  6.96848832e-01  6.96848832e-01  6.96848832e-01
  1.18012022e+00  3.23702582e+00  3.23702582e+00  3.23702582e+00
  7.42126782e+00  1.11928417e+01  1.11928417e+01  1.11928417e+01
  3.45743374e+01  3.80070109e+01  3.80070109e+01  3.80070109e+01
  1.38009385e+02  1.52190806e+02  1.52190806e+02  1.52190806e+02
  5.01573389e+02  1.86905688e+03  7.99881276e+03  4.77666541e+04]
E1 = -182.5767516061606  E_coul = 54.03747916872328
cycle= 4 E= -128.539272437437  delta_E= -2.04e-08  |g|= 7.79e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000198091
diis-c [-7.83094173e-10  1.54098750e-04  5.03191752e-04 -1.50113494e-01
  1.14945620e+00]
  HOMO = -0.849427061538743  LUMO = 0.696838143626345
  mo_energy =
[-3.27724816e+01 -1.93007339e+00 -8.49427062e-01 -8.49427062e-01
 -8.49427062e-01  6.96838144e-01  6.96838144e-01  6.96838144e-01
  1.18010053e+00  3.23699101e+00  3.23699101e+00  3.23699101e+00
  7.42122248e+00  1.11927869e+01  1.11927869e+01  1.11927869e+01
  3.45742718e+01  3.80069431e+01  3.80069431e+01  3.80069431e+01
  1.38009311e+02  1.52190730e+02  1.52190730e+02  1.52190730e+02
  5.01573307e+02  1.86905679e+03  7.99881267e+03  4.77666540e+04]
E1 = -182.5768948775839  E_coul = 54.03762243956895
cycle= 5 E= -128.539272438015  delta_E= -5.78e-10  |g|= 3.69e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5768948775839  E_coul = 54.03762243956895
  HOMO = -0.849425371301762  LUMO = 0.696838528883874
  mo_energy =
[-3.27724778e+01 -1.93007109e+00 -8.49425371e-01 -8.49425371e-01
 -8.49425371e-01  6.96838529e-01  6.96838529e-01  6.96838529e-01
  1.18010162e+00  3.23699238e+00  3.23699238e+00  3.23699238e+00
  7.42122491e+00  1.11927894e+01  1.11927894e+01  1.11927894e+01
  3.45742754e+01  3.80069467e+01  3.80069467e+01  3.80069467e+01
  1.38009314e+02  1.52190734e+02  1.52190734e+02  1.52190734e+02
  5.01573310e+02  1.86905680e+03  7.99881267e+03  4.77666540e+04]
E1 = -182.5768853095158  E_coul = 54.037612871499945
Extra cycle  E= -128.539272438016  delta_E= -9.09e-13  |g|= 1.34e-06  |ddm|= 1.51e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.4998790093634
E1 = -182.5768853095158  E_coul = 54.037612871499945
init E= -128.539272438016
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.849426061145858  LUMO = 0.696838397768108
  mo_energy =
[-3.27724799e+01 -1.93007171e+00 -8.49426061e-01 -8.49426061e-01
 -8.49426061e-01  6.96838398e-01  6.96838398e-01  6.96838398e-01
  1.18010140e+00  3.23699188e+00  3.23699188e+00  3.23699188e+00
  7.42122412e+00  1.11927884e+01  1.11927884e+01  1.11927884e+01
  3.45742738e+01  3.80069450e+01  3.80069450e+01  3.80069450e+01
  1.38009312e+02  1.52190732e+02  1.52190732e+02  1.52190732e+02
  5.01573308e+02  1.86905679e+03  7.99881267e+03  4.77666540e+04]
E1 = -182.57689052285184  E_coul = 54.03761808483587
cycle= 1 E= -128.539272438016  delta_E= -1.14e-13  |g|= 7.19e-07  |ddm|= 4.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57689052285184  E_coul = 54.03761808483587
  HOMO = -0.849425695770243  LUMO = 0.696838472194478
  mo_energy =
[-3.27724788e+01 -1.93007130e+00 -8.49425696e-01 -8.49425696e-01
 -8.49425696e-01  6.96838472e-01  6.96838472e-01  6.96838472e-01
  1.18010157e+00  3.23699216e+00  3.23699216e+00  3.23699216e+00
  7.42122459e+00  1.11927889e+01  1.11927889e+01  1.11927889e+01
  3.45742746e+01  3.80069459e+01  3.80069459e+01  3.80069459e+01
  1.38009313e+02  1.52190733e+02  1.52190733e+02  1.52190733e+02
  5.01573309e+02  1.86905679e+03  7.99881267e+03  4.77666540e+04]
E1 = -182.57688788638623  E_coul = 54.03761544837028
Extra cycle  E= -128.539272438016  delta_E= 2.84e-14  |g|= 3.57e-07  |ddm|= 2.49e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269220e+02 2.35764357e+02
 7.62223519e+01 9.71130648e+00 2.70451446e+01 3.77434674e-01
 1.11322741e+00 3.03760137e+00 5.48952688e+00 1.63220451e+01
 6.26056115e+01 2.39878971e-01 1.98789751e+00 7.12853498e-01]
grad_E = [-3.32871817e-09  1.75478934e-07 -3.42991065e-06  3.96447735e-05
 -2.83329311e-04 -2.48849452e-03  1.31587171e-03 -1.28729076e-04
 -2.42809847e-04  5.77556162e-04  3.42630161e-04 -3.83961422e-05
 -1.22122962e-04 -5.69137442e-04 -1.15348279e-03  1.65693128e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941287        1
[INPUT] 0    0    [1    /1   ]  3661.45454029        1
[INPUT] 0    0    [1    /1   ]  833.269275539        1
[INPUT] 0    0    [1    /1   ]  235.763541369        1
[INPUT] 0    0    [1    /1   ]  76.2282395893        1
[INPUT] 0    0    [1    /1   ]  9.7324833171         1
[INPUT] 0    0    [1    /1   ]  27.0376409272        1
[INPUT] 0    0    [1    /1   ]  0.37687587158        1
[INPUT] 0    0    [1    /1   ]  1.11214842877        1
[INPUT] 0    0    [1    /1   ]  3.03098163546        1
[INPUT] 1    0    [1    /1   ]  5.55113305155        1
[INPUT] 1    0    [1    /1   ]  16.4344877605        1
[INPUT] 1    0    [1    /1   ]  62.4063339263        1
[INPUT] 1    0    [1    /1   ]  0.242630433044       1
[INPUT] 1    0    [1    /1   ]  2.00953939438        1
[INPUT] 1    0    [1    /1   ]  0.72225303437        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128674384, 1.0]], [0, [3661.4545402857507, 1.0]], [0, [833.2692755391643, 1.0]], [0, [235.76354136947046, 1.0]], [0, [76.22823958928477, 1.0]], [0, [9.732483317102933, 1.0]], [0, [27.037640927231276, 1.0]], [0, [0.37687587158032615, 1.0]], [0, [1.112148428769316, 1.0]], [0, [3.0309816354646824, 1.0]], [1, [5.551133051545416, 1.0]], [1, [16.434487760482053, 1.0]], [1, [62.40633392625891, 1.0]], [1, [0.24263043304366008, 1.0]], [1, [2.0095393943758535, 1.0]], [1, [0.7222530343702983, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412867]
bas 1, expnt(s) = [3661.45454029]
bas 2, expnt(s) = [833.26927554]
bas 3, expnt(s) = [235.76354137]
bas 4, expnt(s) = [76.22823959]
bas 5, expnt(s) = [9.73248332]
bas 6, expnt(s) = [27.03764093]
bas 7, expnt(s) = [0.37687587]
bas 8, expnt(s) = [1.11214843]
bas 9, expnt(s) = [3.03098164]
bas 10, expnt(s) = [5.55113305]
bas 11, expnt(s) = [16.43448776]
bas 12, expnt(s) = [62.40633393]
bas 13, expnt(s) = [0.24263043]
bas 14, expnt(s) = [2.00953939]
bas 15, expnt(s) = [0.72225303]
CPU time:       169.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269276e+02 3.91835744e+02 2.35763541e+02 1.52010123e+02
 7.62282396e+01 6.51781369e+01 9.73248332e+00 1.39213956e+01
 2.70376409e+01 2.99565380e+01 3.76875872e-01 1.21524481e+00
 1.11214843e+00 2.73613227e+00 3.03098164e+00 5.80366723e+00
 5.55113305e+00 2.48577284e+01 1.64344878e+01 9.65338457e+01
 6.24063339e+01 5.11705672e+02 2.42630433e-01 4.96782152e-01
 2.00953939e+00 6.97999398e+00 7.22253034e-01 1.94243329e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999758667540647
cond(S) = 343.1741358656646
E1 = -183.5878248230709  E_coul = 55.08015784942762
init E= -128.507666973643
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775158101950746  LUMO = 0.721899923942744
  mo_energy =
[-3.25548885e+01 -1.85256419e+00 -7.75158102e-01 -7.75158102e-01
 -7.75158102e-01  7.21899924e-01  7.21899924e-01  7.21899924e-01
  1.20931901e+00  3.33824639e+00  3.33824639e+00  3.33824639e+00
  7.50066897e+00  1.14502809e+01  1.14502809e+01  1.14502809e+01
  3.47439587e+01  3.85924138e+01  3.85924138e+01  3.85924138e+01
  1.38252822e+02  1.52743058e+02  1.52743058e+02  1.52743058e+02
  5.01858748e+02  1.86937432e+03  7.99915311e+03  4.77670066e+04]
E1 = -182.06709563187297  E_coul = 53.53138011159213
cycle= 1 E= -128.535715520281  delta_E= -0.028  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538981
diis-c [-0.29050102  1.        ]
  HOMO = -0.885223785143571  LUMO = 0.69951255233863
  mo_energy =
[-3.28813501e+01 -1.96786543e+00 -8.85223785e-01 -8.85223785e-01
 -8.85223785e-01  6.99512552e-01  6.99512552e-01  6.99512552e-01
  1.16306385e+00  3.25446064e+00  3.25446064e+00  3.25446064e+00
  7.36529415e+00  1.12807098e+01  1.12807098e+01  1.12807098e+01
  3.44950453e+01  3.83318573e+01  3.83318573e+01  3.83318573e+01
  1.37931800e+02  1.52410484e+02  1.52410484e+02  1.52410484e+02
  5.01493592e+02  1.86897305e+03  7.99872291e+03  4.77665575e+04]
E1 = -182.8397113564032  E_coul = 54.30135620904006
cycle= 2 E= -128.538355147363  delta_E= -0.00264  |g|= 0.105  |ddm|= 0.0649
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27461
diis-c [-6.43135461e-04  3.36819043e-01  6.63180957e-01]
  HOMO = -0.849088808201981  LUMO = 0.706848594290161
  mo_energy =
[-3.27718963e+01 -1.92979399e+00 -8.49088808e-01 -8.49088808e-01
 -8.49088808e-01  7.06848594e-01  7.06848594e-01  7.06848594e-01
  1.17794756e+00  3.28163721e+00  3.28163721e+00  3.28163721e+00
  7.40981526e+00  1.13367897e+01  1.13367897e+01  1.13367897e+01
  3.45786082e+01  3.84192065e+01  3.84192065e+01  3.84192065e+01
  1.38039153e+02  1.52520980e+02  1.52520980e+02  1.52520980e+02
  5.01611880e+02  1.86909663e+03  7.99884895e+03  4.77666844e+04]
E1 = -182.57687090393458  E_coul = 54.03756899462953
cycle= 3 E= -128.539301909305  delta_E= -0.000947  |g|= 0.000483  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116114
diis-c [-1.28967103e-07 -2.17843947e-03 -2.47434681e-04  1.00242587e+00]
  HOMO = -0.849337127408558  LUMO = 0.706820040913978
  mo_energy =
[-3.27723467e+01 -1.92998831e+00 -8.49337127e-01 -8.49337127e-01
 -8.49337127e-01  7.06820041e-01  7.06820041e-01  7.06820041e-01
  1.17787211e+00  3.28148909e+00  3.28148909e+00  3.28148909e+00
  7.40960433e+00  1.13365219e+01  1.13365219e+01  1.13365219e+01
  3.45782612e+01  3.84188361e+01  3.84188361e+01  3.84188361e+01
  1.38038699e+02  1.52520502e+02  1.52520502e+02  1.52520502e+02
  5.01611302e+02  1.86909592e+03  7.99884814e+03  4.77666836e+04]
E1 = -182.57731877404083  E_coul = 54.03801684394432
cycle= 4 E= -128.539301930097  delta_E= -2.08e-08  |g|= 7.84e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199338
diis-c [-7.82588946e-10  1.56120438e-04  5.06211085e-04 -1.50586897e-01
  1.14992457e+00]
  HOMO = -0.849378971708733  LUMO = 0.706809102355089
  mo_energy =
[-3.27724216e+01 -1.93002341e+00 -8.49378972e-01 -8.49378972e-01
 -8.49378972e-01  7.06809102e-01  7.06809102e-01  7.06809102e-01
  1.17785233e+00  3.28145380e+00  3.28145380e+00  3.28145380e+00
  7.40955879e+00  1.13364666e+01  1.13364666e+01  1.13364666e+01
  3.45781953e+01  3.84187679e+01  3.84187679e+01  3.84187679e+01
  1.38038624e+02  1.52520426e+02  1.52520426e+02  1.52520426e+02
  5.01611220e+02  1.86909583e+03  7.99884805e+03  4.77666835e+04]
E1 = -182.57746279462688  E_coul = 54.038160863947276
cycle= 5 E= -128.53930193068  delta_E= -5.83e-10  |g|= 3.72e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57746279462688  E_coul = 54.038160863947276
  HOMO = -0.849377257616745  LUMO = 0.7068095037382
  mo_energy =
[-3.27724177e+01 -1.93002108e+00 -8.49377258e-01 -8.49377258e-01
 -8.49377258e-01  7.06809504e-01  7.06809504e-01  7.06809504e-01
  1.17785344e+00  3.28145521e+00  3.28145521e+00  3.28145521e+00
  7.40956125e+00  1.13364692e+01  1.13364692e+01  1.13364692e+01
  3.45781989e+01  3.84187715e+01  3.84187715e+01  3.84187715e+01
  1.38038627e+02  1.52520430e+02  1.52520430e+02  1.52520430e+02
  5.01611223e+02  1.86909583e+03  7.99884805e+03  4.77666835e+04]
E1 = -182.57745318661352  E_coul = 54.03815125593283
Extra cycle  E= -128.539301930681  delta_E= -1.08e-12  |g|= 1.35e-06  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269276e+02 2.35763541e+02
 7.62282396e+01 9.73248332e+00 2.70376409e+01 3.76875872e-01
 1.11214843e+00 3.03098164e+00 5.55113305e+00 1.64344878e+01
 6.24063339e+01 2.42630433e-01 2.00953939e+00 7.22253034e-01]
E = -128.5393019306807
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941287        1
[INPUT] 0    0    [1    /1   ]  3661.45454029        1
[INPUT] 0    0    [1    /1   ]  833.269275539        1
[INPUT] 0    0    [1    /1   ]  235.763541369        1
[INPUT] 0    0    [1    /1   ]  76.2282395893        1
[INPUT] 0    0    [1    /1   ]  9.7324833171         1
[INPUT] 0    0    [1    /1   ]  27.0376409272        1
[INPUT] 0    0    [1    /1   ]  0.37687587158        1
[INPUT] 0    0    [1    /1   ]  1.11214842877        1
[INPUT] 0    0    [1    /1   ]  3.03098163546        1
[INPUT] 1    0    [1    /1   ]  5.55113305155        1
[INPUT] 1    0    [1    /1   ]  16.4344877605        1
[INPUT] 1    0    [1    /1   ]  62.4063339263        1
[INPUT] 1    0    [1    /1   ]  0.242630433044       1
[INPUT] 1    0    [1    /1   ]  2.00953939438        1
[INPUT] 1    0    [1    /1   ]  0.72225303437        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128674384, 1.0]], [0, [3661.4545402857507, 1.0]], [0, [833.2692755391643, 1.0]], [0, [235.76354136947046, 1.0]], [0, [76.22823958928477, 1.0]], [0, [9.732483317102933, 1.0]], [0, [27.037640927231276, 1.0]], [0, [0.37687587158032615, 1.0]], [0, [1.112148428769316, 1.0]], [0, [3.0309816354646824, 1.0]], [1, [5.551133051545416, 1.0]], [1, [16.434487760482053, 1.0]], [1, [62.40633392625891, 1.0]], [1, [0.24263043304366008, 1.0]], [1, [2.0095393943758535, 1.0]], [1, [0.7222530343702983, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412867]
bas 1, expnt(s) = [3661.45454029]
bas 2, expnt(s) = [833.26927554]
bas 3, expnt(s) = [235.76354137]
bas 4, expnt(s) = [76.22823959]
bas 5, expnt(s) = [9.73248332]
bas 6, expnt(s) = [27.03764093]
bas 7, expnt(s) = [0.37687587]
bas 8, expnt(s) = [1.11214843]
bas 9, expnt(s) = [3.03098164]
bas 10, expnt(s) = [5.55113305]
bas 11, expnt(s) = [16.43448776]
bas 12, expnt(s) = [62.40633393]
bas 13, expnt(s) = [0.24263043]
bas 14, expnt(s) = [2.00953939]
bas 15, expnt(s) = [0.72225303]
CPU time:       170.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269276e+02 3.91835744e+02 2.35763541e+02 1.52010123e+02
 7.62282396e+01 6.51781369e+01 9.73248332e+00 1.39213956e+01
 2.70376409e+01 2.99565380e+01 3.76875872e-01 1.21524481e+00
 1.11214843e+00 2.73613227e+00 3.03098164e+00 5.80366723e+00
 5.55113305e+00 2.48577284e+01 1.64344878e+01 9.65338457e+01
 6.24063339e+01 5.11705672e+02 2.42630433e-01 4.96782152e-01
 2.00953939e+00 6.97999398e+00 7.22253034e-01 1.94243329e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999758667540647
cond(S) = 343.1741358656646
E1 = -183.5878248230709  E_coul = 55.08015784942762
init E= -128.507666973643
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775158101950746  LUMO = 0.721899923942744
  mo_energy =
[-3.25548885e+01 -1.85256419e+00 -7.75158102e-01 -7.75158102e-01
 -7.75158102e-01  7.21899924e-01  7.21899924e-01  7.21899924e-01
  1.20931901e+00  3.33824639e+00  3.33824639e+00  3.33824639e+00
  7.50066897e+00  1.14502809e+01  1.14502809e+01  1.14502809e+01
  3.47439587e+01  3.85924138e+01  3.85924138e+01  3.85924138e+01
  1.38252822e+02  1.52743058e+02  1.52743058e+02  1.52743058e+02
  5.01858748e+02  1.86937432e+03  7.99915311e+03  4.77670066e+04]
E1 = -182.06709563187297  E_coul = 53.53138011159213
cycle= 1 E= -128.535715520281  delta_E= -0.028  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538981
diis-c [-0.29050102  1.        ]
  HOMO = -0.885223785143571  LUMO = 0.69951255233863
  mo_energy =
[-3.28813501e+01 -1.96786543e+00 -8.85223785e-01 -8.85223785e-01
 -8.85223785e-01  6.99512552e-01  6.99512552e-01  6.99512552e-01
  1.16306385e+00  3.25446064e+00  3.25446064e+00  3.25446064e+00
  7.36529415e+00  1.12807098e+01  1.12807098e+01  1.12807098e+01
  3.44950453e+01  3.83318573e+01  3.83318573e+01  3.83318573e+01
  1.37931800e+02  1.52410484e+02  1.52410484e+02  1.52410484e+02
  5.01493592e+02  1.86897305e+03  7.99872291e+03  4.77665575e+04]
E1 = -182.8397113564032  E_coul = 54.30135620904006
cycle= 2 E= -128.538355147363  delta_E= -0.00264  |g|= 0.105  |ddm|= 0.0649
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27461
diis-c [-6.43135461e-04  3.36819043e-01  6.63180957e-01]
  HOMO = -0.849088808201981  LUMO = 0.706848594290161
  mo_energy =
[-3.27718963e+01 -1.92979399e+00 -8.49088808e-01 -8.49088808e-01
 -8.49088808e-01  7.06848594e-01  7.06848594e-01  7.06848594e-01
  1.17794756e+00  3.28163721e+00  3.28163721e+00  3.28163721e+00
  7.40981526e+00  1.13367897e+01  1.13367897e+01  1.13367897e+01
  3.45786082e+01  3.84192065e+01  3.84192065e+01  3.84192065e+01
  1.38039153e+02  1.52520980e+02  1.52520980e+02  1.52520980e+02
  5.01611880e+02  1.86909663e+03  7.99884895e+03  4.77666844e+04]
E1 = -182.57687090393458  E_coul = 54.03756899462953
cycle= 3 E= -128.539301909305  delta_E= -0.000947  |g|= 0.000483  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116114
diis-c [-1.28967103e-07 -2.17843947e-03 -2.47434681e-04  1.00242587e+00]
  HOMO = -0.849337127408558  LUMO = 0.706820040913978
  mo_energy =
[-3.27723467e+01 -1.92998831e+00 -8.49337127e-01 -8.49337127e-01
 -8.49337127e-01  7.06820041e-01  7.06820041e-01  7.06820041e-01
  1.17787211e+00  3.28148909e+00  3.28148909e+00  3.28148909e+00
  7.40960433e+00  1.13365219e+01  1.13365219e+01  1.13365219e+01
  3.45782612e+01  3.84188361e+01  3.84188361e+01  3.84188361e+01
  1.38038699e+02  1.52520502e+02  1.52520502e+02  1.52520502e+02
  5.01611302e+02  1.86909592e+03  7.99884814e+03  4.77666836e+04]
E1 = -182.57731877404083  E_coul = 54.03801684394432
cycle= 4 E= -128.539301930097  delta_E= -2.08e-08  |g|= 7.84e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199338
diis-c [-7.82588946e-10  1.56120438e-04  5.06211085e-04 -1.50586897e-01
  1.14992457e+00]
  HOMO = -0.849378971708733  LUMO = 0.706809102355089
  mo_energy =
[-3.27724216e+01 -1.93002341e+00 -8.49378972e-01 -8.49378972e-01
 -8.49378972e-01  7.06809102e-01  7.06809102e-01  7.06809102e-01
  1.17785233e+00  3.28145380e+00  3.28145380e+00  3.28145380e+00
  7.40955879e+00  1.13364666e+01  1.13364666e+01  1.13364666e+01
  3.45781953e+01  3.84187679e+01  3.84187679e+01  3.84187679e+01
  1.38038624e+02  1.52520426e+02  1.52520426e+02  1.52520426e+02
  5.01611220e+02  1.86909583e+03  7.99884805e+03  4.77666835e+04]
E1 = -182.57746279462688  E_coul = 54.038160863947276
cycle= 5 E= -128.53930193068  delta_E= -5.83e-10  |g|= 3.72e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57746279462688  E_coul = 54.038160863947276
  HOMO = -0.849377257616745  LUMO = 0.7068095037382
  mo_energy =
[-3.27724177e+01 -1.93002108e+00 -8.49377258e-01 -8.49377258e-01
 -8.49377258e-01  7.06809504e-01  7.06809504e-01  7.06809504e-01
  1.17785344e+00  3.28145521e+00  3.28145521e+00  3.28145521e+00
  7.40956125e+00  1.13364692e+01  1.13364692e+01  1.13364692e+01
  3.45781989e+01  3.84187715e+01  3.84187715e+01  3.84187715e+01
  1.38038627e+02  1.52520430e+02  1.52520430e+02  1.52520430e+02
  5.01611223e+02  1.86909583e+03  7.99884805e+03  4.77666835e+04]
E1 = -182.57745318661352  E_coul = 54.03815125593283
Extra cycle  E= -128.539301930681  delta_E= -1.08e-12  |g|= 1.35e-06  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.1741358656646
E1 = -182.57745318661352  E_coul = 54.03815125593283
init E= -128.539301930681
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849377949655268  LUMO = 0.706809370140048
  mo_energy =
[-3.27724198e+01 -1.93002170e+00 -8.49377950e-01 -8.49377950e-01
 -8.49377950e-01  7.06809370e-01  7.06809370e-01  7.06809370e-01
  1.17785322e+00  3.28145470e+00  3.28145470e+00  3.28145470e+00
  7.40956046e+00  1.13364682e+01  1.13364682e+01  1.13364682e+01
  3.45781973e+01  3.84187698e+01  3.84187698e+01  3.84187698e+01
  1.38038625e+02  1.52520428e+02  1.52520428e+02  1.52520428e+02
  5.01611221e+02  1.86909583e+03  7.99884805e+03  4.77666835e+04]
E1 = -182.57745843482562  E_coul = 54.038156504144816
cycle= 1 E= -128.539301930681  delta_E= -1.14e-13  |g|= 7.24e-07  |ddm|= 4.45e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57745843482562  E_coul = 54.038156504144816
  HOMO = -0.849377581769244  LUMO = 0.706809446549661
  mo_energy =
[-3.27724187e+01 -1.93002129e+00 -8.49377582e-01 -8.49377582e-01
 -8.49377582e-01  7.06809447e-01  7.06809447e-01  7.06809447e-01
  1.17785339e+00  3.28145499e+00  3.28145499e+00  3.28145499e+00
  7.40956092e+00  1.13364687e+01  1.13364687e+01  1.13364687e+01
  3.45781982e+01  3.84187707e+01  3.84187707e+01  3.84187707e+01
  1.38038626e+02  1.52520429e+02  1.52520429e+02  1.52520429e+02
  5.01611222e+02  1.86909583e+03  7.99884805e+03  4.77666835e+04]
E1 = -182.5774557834453  E_coul = 54.03815385276491
Extra cycle  E= -128.53930193068  delta_E= 4.26e-13  |g|= 3.6e-07  |ddm|= 2.51e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269276e+02 2.35763541e+02
 7.62282396e+01 9.73248332e+00 2.70376409e+01 3.76875872e-01
 1.11214843e+00 3.03098164e+00 5.55113305e+00 1.64344878e+01
 6.24063339e+01 2.42630433e-01 2.00953939e+00 7.22253034e-01]
grad_E = [-3.09103564e-09  1.62841444e-07 -3.18291695e-06  3.66770193e-05
 -2.62000786e-04 -2.30268361e-03  1.21547638e-03 -2.66030126e-04
 -2.54283076e-04  5.68887285e-04  5.59805353e-04 -3.25112407e-05
 -1.30732324e-04 -1.34058522e-03 -1.94246472e-03  3.20523191e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941287        1
[INPUT] 0    0    [1    /1   ]  3661.45453878        1
[INPUT] 0    0    [1    /1   ]  833.26930184         1
[INPUT] 0    0    [1    /1   ]  235.763297592        1
[INPUT] 0    0    [1    /1   ]  76.2300733687        1
[INPUT] 0    0    [1    /1   ]  9.76141067578        1
[INPUT] 0    0    [1    /1   ]  27.0210035019        1
[INPUT] 0    0    [1    /1   ]  0.376733852084       1
[INPUT] 0    0    [1    /1   ]  1.11248907949        1
[INPUT] 0    0    [1    /1   ]  3.02480075183        1
[INPUT] 1    0    [1    /1   ]  5.66042797682        1
[INPUT] 1    0    [1    /1   ]  16.6776724326        1
[INPUT] 1    0    [1    /1   ]  62.4265035256        1
[INPUT] 1    0    [1    /1   ]  0.246465581908       1
[INPUT] 1    0    [1    /1   ]  2.04777674685        1
[INPUT] 1    0    [1    /1   ]  0.736781545813       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128703048, 1.0]], [0, [3661.4545387794237, 1.0]], [0, [833.26930183955, 1.0]], [0, [235.763297592242, 1.0]], [0, [76.2300733687492, 1.0]], [0, [9.761410675775519, 1.0]], [0, [27.02100350187945, 1.0]], [0, [0.37673385208377685, 1.0]], [0, [1.112489079485756, 1.0]], [0, [3.0248007518332662, 1.0]], [1, [5.66042797681643, 1.0]], [1, [16.67767243258522, 1.0]], [1, [62.42650352558722, 1.0]], [1, [0.24646558190761086, 1.0]], [1, [2.0477767468528394, 1.0]], [1, [0.7367815458125346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941287]
bas 1, expnt(s) = [3661.45453878]
bas 2, expnt(s) = [833.26930184]
bas 3, expnt(s) = [235.76329759]
bas 4, expnt(s) = [76.23007337]
bas 5, expnt(s) = [9.76141068]
bas 6, expnt(s) = [27.0210035]
bas 7, expnt(s) = [0.37673385]
bas 8, expnt(s) = [1.11248908]
bas 9, expnt(s) = [3.02480075]
bas 10, expnt(s) = [5.66042798]
bas 11, expnt(s) = [16.67767243]
bas 12, expnt(s) = [62.42650353]
bas 13, expnt(s) = [0.24646558]
bas 14, expnt(s) = [2.04777675]
bas 15, expnt(s) = [0.73678155]
CPU time:       173.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269302e+02 3.91835753e+02 2.35763298e+02 1.52010005e+02
 7.62300734e+01 6.51793128e+01 9.76141068e+00 1.39524175e+01
 2.70210035e+01 2.99427118e+01 3.76733852e-01 1.21490133e+00
 1.11248908e+00 2.73676081e+00 3.02480075e+00 5.79478869e+00
 5.66042798e+00 2.54709990e+01 1.66776724e+01 9.83226765e+01
 6.24265035e+01 5.11912408e+02 2.46465582e-01 5.06616981e-01
 2.04777675e+00 7.14640544e+00 7.36781546e-01 1.99139686e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99973864426998
cond(S) = 343.395700655479
E1 = -183.58790701612446  E_coul = 55.08017554561046
init E= -128.507731470514
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775150292573572  LUMO = 0.736781353307642
  mo_energy =
[-3.25549257e+01 -1.85256543e+00 -7.75150293e-01 -7.75150293e-01
 -7.75150293e-01  7.36781353e-01  7.36781353e-01  7.36781353e-01
  1.20892998e+00  3.40916931e+00  3.40916931e+00  3.40916931e+00
  7.49670634e+00  1.16956355e+01  1.16956355e+01  1.16956355e+01
  3.47675675e+01  3.93626342e+01  3.93626342e+01  3.93626342e+01
  1.38295524e+02  1.54035593e+02  1.54035593e+02  1.54035593e+02
  5.01891914e+02  1.86940170e+03  7.99917674e+03  4.77670261e+04]
E1 = -182.06875298696355  E_coul = 53.53297124650315
cycle= 1 E= -128.53578174046  delta_E= -0.0281  |g|= 0.206  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53857
diis-c [-0.29005743  1.        ]
  HOMO = -0.885096681900099  LUMO = 0.713785605003367
  mo_energy =
[-3.28810997e+01 -1.96772835e+00 -8.85096682e-01 -8.85096682e-01
 -8.85096682e-01  7.13785605e-01  7.13785605e-01  7.13785605e-01
  1.16275977e+00  3.32403668e+00  3.32403668e+00  3.32403668e+00
  7.36151275e+00  1.15245916e+01  1.15245916e+01  1.15245916e+01
  3.45188083e+01  3.91013062e+01  3.91013062e+01  3.91013062e+01
  1.37974791e+02  1.53703327e+02  1.53703327e+02  1.53703327e+02
  5.01527077e+02  1.86900076e+03  7.99874687e+03  4.77665773e+04]
E1 = -182.84013211969844  E_coul = 54.30171539137228
cycle= 2 E= -128.538416728326  delta_E= -0.00263  |g|= 0.105  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274247
diis-c [-6.43492600e-04  3.36691137e-01  6.63308863e-01]
  HOMO = -0.849016372590091  LUMO = 0.721314569322485
  mo_energy =
[-3.27717832e+01 -1.92971649e+00 -8.49016373e-01 -8.49016373e-01
 -8.49016373e-01  7.21314569e-01  7.21314569e-01  7.21314569e-01
  1.17760838e+00  3.35164567e+00  3.35164567e+00  3.35164567e+00
  7.40595865e+00  1.15811555e+01  1.15811555e+01  1.15811555e+01
  3.46022895e+01  3.91888877e+01  3.91888877e+01  3.91888877e+01
  1.38082010e+02  1.53813686e+02  1.53813686e+02  1.53813686e+02
  5.01645219e+02  1.86912419e+03  7.99887274e+03  4.77667041e+04]
E1 = -182.57776983396266  E_coul = 54.03840931265257
cycle= 3 E= -128.53936052131  delta_E= -0.000944  |g|= 0.000488  |ddm|= 0.0228
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117183
diis-c [-1.29760543e-07 -2.19535543e-03 -2.37836346e-04  1.00243319e+00]
  HOMO = -0.849266843522579  LUMO = 0.721284180746461
  mo_energy =
[-3.27722373e+01 -1.92991291e+00 -8.49266844e-01 -8.49266844e-01
 -8.49266844e-01  7.21284181e-01  7.21284181e-01  7.21284181e-01
  1.17753136e+00  3.35149296e+00  3.35149296e+00  3.35149296e+00
  7.40574533e+00  1.15808828e+01  1.15808828e+01  1.15808828e+01
  3.46019392e+01  3.91885129e+01  3.91885129e+01  3.91885129e+01
  1.38081552e+02  1.53813204e+02  1.53813204e+02  1.53813204e+02
  5.01644638e+02  1.86912348e+03  7.99887194e+03  4.77667032e+04]
E1 = -182.57822478262418  E_coul = 54.03886424013706
cycle= 4 E= -128.539360542487  delta_E= -2.12e-08  |g|= 7.88e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000200324
diis-c [-7.79039959e-10  1.58772012e-04  5.08767186e-04 -1.50944751e-01
  1.15027721e+00]
  HOMO = -0.849308867981876  LUMO = 0.72127292655315
  mo_energy =
[-3.27723125e+01 -1.92994814e+00 -8.49308868e-01 -8.49308868e-01
 -8.49308868e-01  7.21272927e-01  7.21272927e-01  7.21272927e-01
  1.17751152e+00  3.35145707e+00  3.35145707e+00  3.35145707e+00
  7.40569962e+00  1.15808269e+01  1.15808269e+01  1.15808269e+01
  3.46018730e+01  3.91884442e+01  3.91884442e+01  3.91884442e+01
  1.38081477e+02  1.53813128e+02  1.53813128e+02  1.53813128e+02
  5.01644555e+02  1.86912339e+03  7.99887184e+03  4.77667031e+04]
E1 = -182.57836960235176  E_coul = 54.039009059277916
cycle= 5 E= -128.539360543074  delta_E= -5.87e-10  |g|= 3.76e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57836960235176  E_coul = 54.039009059277916
  HOMO = -0.849307122742844  LUMO = 0.721273350938336
  mo_energy =
[-3.27723086e+01 -1.92994578e+00 -8.49307123e-01 -8.49307123e-01
 -8.49307123e-01  7.21273351e-01  7.21273351e-01  7.21273351e-01
  1.17751265e+00  3.35145853e+00  3.35145853e+00  3.35145853e+00
  7.40570211e+00  1.15808296e+01  1.15808296e+01  1.15808296e+01
  3.46018766e+01  3.91884479e+01  3.91884479e+01  3.91884479e+01
  1.38081481e+02  1.53813132e+02  1.53813132e+02  1.53813132e+02
  5.01644559e+02  1.86912339e+03  7.99887184e+03  4.77667031e+04]
E1 = -182.57835995471538  E_coul = 54.038999411640326
Extra cycle  E= -128.539360543075  delta_E= -1.22e-12  |g|= 1.36e-06  |ddm|= 1.54e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269302e+02 2.35763298e+02
 7.62300734e+01 9.76141068e+00 2.70210035e+01 3.76733852e-01
 1.11248908e+00 3.02480075e+00 5.66042798e+00 1.66776724e+01
 6.24265035e+01 2.46465582e-01 2.04777675e+00 7.36781546e-01]
E = -128.53936054307505
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941287        1
[INPUT] 0    0    [1    /1   ]  3661.45453878        1
[INPUT] 0    0    [1    /1   ]  833.26930184         1
[INPUT] 0    0    [1    /1   ]  235.763297592        1
[INPUT] 0    0    [1    /1   ]  76.2300733687        1
[INPUT] 0    0    [1    /1   ]  9.76141067578        1
[INPUT] 0    0    [1    /1   ]  27.0210035019        1
[INPUT] 0    0    [1    /1   ]  0.376733852084       1
[INPUT] 0    0    [1    /1   ]  1.11248907949        1
[INPUT] 0    0    [1    /1   ]  3.02480075183        1
[INPUT] 1    0    [1    /1   ]  5.66042797682        1
[INPUT] 1    0    [1    /1   ]  16.6776724326        1
[INPUT] 1    0    [1    /1   ]  62.4265035256        1
[INPUT] 1    0    [1    /1   ]  0.246465581908       1
[INPUT] 1    0    [1    /1   ]  2.04777674685        1
[INPUT] 1    0    [1    /1   ]  0.736781545813       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128703048, 1.0]], [0, [3661.4545387794237, 1.0]], [0, [833.26930183955, 1.0]], [0, [235.763297592242, 1.0]], [0, [76.2300733687492, 1.0]], [0, [9.761410675775519, 1.0]], [0, [27.02100350187945, 1.0]], [0, [0.37673385208377685, 1.0]], [0, [1.112489079485756, 1.0]], [0, [3.0248007518332662, 1.0]], [1, [5.66042797681643, 1.0]], [1, [16.67767243258522, 1.0]], [1, [62.42650352558722, 1.0]], [1, [0.24646558190761086, 1.0]], [1, [2.0477767468528394, 1.0]], [1, [0.7367815458125346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941287]
bas 1, expnt(s) = [3661.45453878]
bas 2, expnt(s) = [833.26930184]
bas 3, expnt(s) = [235.76329759]
bas 4, expnt(s) = [76.23007337]
bas 5, expnt(s) = [9.76141068]
bas 6, expnt(s) = [27.0210035]
bas 7, expnt(s) = [0.37673385]
bas 8, expnt(s) = [1.11248908]
bas 9, expnt(s) = [3.02480075]
bas 10, expnt(s) = [5.66042798]
bas 11, expnt(s) = [16.67767243]
bas 12, expnt(s) = [62.42650353]
bas 13, expnt(s) = [0.24646558]
bas 14, expnt(s) = [2.04777675]
bas 15, expnt(s) = [0.73678155]
CPU time:       174.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269302e+02 3.91835753e+02 2.35763298e+02 1.52010005e+02
 7.62300734e+01 6.51793128e+01 9.76141068e+00 1.39524175e+01
 2.70210035e+01 2.99427118e+01 3.76733852e-01 1.21490133e+00
 1.11248908e+00 2.73676081e+00 3.02480075e+00 5.79478869e+00
 5.66042798e+00 2.54709990e+01 1.66776724e+01 9.83226765e+01
 6.24265035e+01 5.11912408e+02 2.46465582e-01 5.06616981e-01
 2.04777675e+00 7.14640544e+00 7.36781546e-01 1.99139686e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99973864426998
cond(S) = 343.395700655479
E1 = -183.58790701612446  E_coul = 55.08017554561046
init E= -128.507731470514
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775150292573572  LUMO = 0.736781353307642
  mo_energy =
[-3.25549257e+01 -1.85256543e+00 -7.75150293e-01 -7.75150293e-01
 -7.75150293e-01  7.36781353e-01  7.36781353e-01  7.36781353e-01
  1.20892998e+00  3.40916931e+00  3.40916931e+00  3.40916931e+00
  7.49670634e+00  1.16956355e+01  1.16956355e+01  1.16956355e+01
  3.47675675e+01  3.93626342e+01  3.93626342e+01  3.93626342e+01
  1.38295524e+02  1.54035593e+02  1.54035593e+02  1.54035593e+02
  5.01891914e+02  1.86940170e+03  7.99917674e+03  4.77670261e+04]
E1 = -182.06875298696355  E_coul = 53.53297124650315
cycle= 1 E= -128.53578174046  delta_E= -0.0281  |g|= 0.206  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53857
diis-c [-0.29005743  1.        ]
  HOMO = -0.885096681900099  LUMO = 0.713785605003367
  mo_energy =
[-3.28810997e+01 -1.96772835e+00 -8.85096682e-01 -8.85096682e-01
 -8.85096682e-01  7.13785605e-01  7.13785605e-01  7.13785605e-01
  1.16275977e+00  3.32403668e+00  3.32403668e+00  3.32403668e+00
  7.36151275e+00  1.15245916e+01  1.15245916e+01  1.15245916e+01
  3.45188083e+01  3.91013062e+01  3.91013062e+01  3.91013062e+01
  1.37974791e+02  1.53703327e+02  1.53703327e+02  1.53703327e+02
  5.01527077e+02  1.86900076e+03  7.99874687e+03  4.77665773e+04]
E1 = -182.84013211969844  E_coul = 54.30171539137228
cycle= 2 E= -128.538416728326  delta_E= -0.00263  |g|= 0.105  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274247
diis-c [-6.43492600e-04  3.36691137e-01  6.63308863e-01]
  HOMO = -0.849016372590091  LUMO = 0.721314569322485
  mo_energy =
[-3.27717832e+01 -1.92971649e+00 -8.49016373e-01 -8.49016373e-01
 -8.49016373e-01  7.21314569e-01  7.21314569e-01  7.21314569e-01
  1.17760838e+00  3.35164567e+00  3.35164567e+00  3.35164567e+00
  7.40595865e+00  1.15811555e+01  1.15811555e+01  1.15811555e+01
  3.46022895e+01  3.91888877e+01  3.91888877e+01  3.91888877e+01
  1.38082010e+02  1.53813686e+02  1.53813686e+02  1.53813686e+02
  5.01645219e+02  1.86912419e+03  7.99887274e+03  4.77667041e+04]
E1 = -182.57776983396266  E_coul = 54.03840931265257
cycle= 3 E= -128.53936052131  delta_E= -0.000944  |g|= 0.000488  |ddm|= 0.0228
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117183
diis-c [-1.29760543e-07 -2.19535543e-03 -2.37836346e-04  1.00243319e+00]
  HOMO = -0.849266843522579  LUMO = 0.721284180746461
  mo_energy =
[-3.27722373e+01 -1.92991291e+00 -8.49266844e-01 -8.49266844e-01
 -8.49266844e-01  7.21284181e-01  7.21284181e-01  7.21284181e-01
  1.17753136e+00  3.35149296e+00  3.35149296e+00  3.35149296e+00
  7.40574533e+00  1.15808828e+01  1.15808828e+01  1.15808828e+01
  3.46019392e+01  3.91885129e+01  3.91885129e+01  3.91885129e+01
  1.38081552e+02  1.53813204e+02  1.53813204e+02  1.53813204e+02
  5.01644638e+02  1.86912348e+03  7.99887194e+03  4.77667032e+04]
E1 = -182.57822478262418  E_coul = 54.03886424013706
cycle= 4 E= -128.539360542487  delta_E= -2.12e-08  |g|= 7.88e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000200324
diis-c [-7.79039959e-10  1.58772012e-04  5.08767186e-04 -1.50944751e-01
  1.15027721e+00]
  HOMO = -0.849308867981876  LUMO = 0.72127292655315
  mo_energy =
[-3.27723125e+01 -1.92994814e+00 -8.49308868e-01 -8.49308868e-01
 -8.49308868e-01  7.21272927e-01  7.21272927e-01  7.21272927e-01
  1.17751152e+00  3.35145707e+00  3.35145707e+00  3.35145707e+00
  7.40569962e+00  1.15808269e+01  1.15808269e+01  1.15808269e+01
  3.46018730e+01  3.91884442e+01  3.91884442e+01  3.91884442e+01
  1.38081477e+02  1.53813128e+02  1.53813128e+02  1.53813128e+02
  5.01644555e+02  1.86912339e+03  7.99887184e+03  4.77667031e+04]
E1 = -182.57836960235176  E_coul = 54.039009059277916
cycle= 5 E= -128.539360543074  delta_E= -5.87e-10  |g|= 3.76e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57836960235176  E_coul = 54.039009059277916
  HOMO = -0.849307122742844  LUMO = 0.721273350938336
  mo_energy =
[-3.27723086e+01 -1.92994578e+00 -8.49307123e-01 -8.49307123e-01
 -8.49307123e-01  7.21273351e-01  7.21273351e-01  7.21273351e-01
  1.17751265e+00  3.35145853e+00  3.35145853e+00  3.35145853e+00
  7.40570211e+00  1.15808296e+01  1.15808296e+01  1.15808296e+01
  3.46018766e+01  3.91884479e+01  3.91884479e+01  3.91884479e+01
  1.38081481e+02  1.53813132e+02  1.53813132e+02  1.53813132e+02
  5.01644559e+02  1.86912339e+03  7.99887184e+03  4.77667031e+04]
E1 = -182.57835995471538  E_coul = 54.038999411640326
Extra cycle  E= -128.539360543075  delta_E= -1.22e-12  |g|= 1.36e-06  |ddm|= 1.54e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.395700655479
E1 = -182.57835995471538  E_coul = 54.038999411640326
init E= -128.539360543075
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.849307816759345  LUMO = 0.721273213811438
  mo_energy =
[-3.27723107e+01 -1.92994640e+00 -8.49307817e-01 -8.49307817e-01
 -8.49307817e-01  7.21273214e-01  7.21273214e-01  7.21273214e-01
  1.17751243e+00  3.35145802e+00  3.35145802e+00  3.35145802e+00
  7.40570132e+00  1.15808285e+01  1.15808285e+01  1.15808285e+01
  3.46018750e+01  3.91884462e+01  3.91884462e+01  3.91884462e+01
  1.38081479e+02  1.53813129e+02  1.53813129e+02  1.53813129e+02
  5.01644556e+02  1.86912339e+03  7.99887184e+03  4.77667031e+04]
E1 = -182.5783652426365  E_coul = 54.03900469956132
cycle= 1 E= -128.539360543075  delta_E= -1.42e-13  |g|= 7.29e-07  |ddm|= 4.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5783652426365  E_coul = 54.03900469956132
  HOMO = -0.849307446022675  LUMO = 0.721273293018608
  mo_energy =
[-3.27723096e+01 -1.92994599e+00 -8.49307446e-01 -8.49307446e-01
 -8.49307446e-01  7.21273293e-01  7.21273293e-01  7.21273293e-01
  1.17751260e+00  3.35145830e+00  3.35145830e+00  3.35145830e+00
  7.40570179e+00  1.15808291e+01  1.15808291e+01  1.15808291e+01
  3.46018759e+01  3.91884471e+01  3.91884471e+01  3.91884471e+01
  1.38081480e+02  1.53813131e+02  1.53813131e+02  1.53813131e+02
  5.01644557e+02  1.86912339e+03  7.99887184e+03  4.77667031e+04]
E1 = -182.5783625749657  E_coul = 54.03900203189071
Extra cycle  E= -128.539360543075  delta_E= 1.99e-13  |g|= 3.62e-07  |ddm|= 2.53e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269302e+02 2.35763298e+02
 7.62300734e+01 9.76141068e+00 2.70210035e+01 3.76733852e-01
 1.11248908e+00 3.02480075e+00 5.66042798e+00 1.66776724e+01
 6.24265035e+01 2.46465582e-01 2.04777675e+00 7.36781546e-01]
grad_E = [-2.75099378e-09  1.44770441e-07 -2.82779768e-06  3.23850072e-05
 -2.30791032e-04 -2.03632713e-03  1.07011210e-03 -4.06516965e-04
 -2.41758353e-04  5.44900205e-04  7.14436049e-04 -6.21492081e-08
 -1.41911847e-04 -2.33814799e-03 -2.61768704e-03  4.81155539e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941287        1
[INPUT] 0    0    [1    /1   ]  3661.45454093        1
[INPUT] 0    0    [1    /1   ]  833.26921806         1
[INPUT] 0    0    [1    /1   ]  235.765104103        1
[INPUT] 0    0    [1    /1   ]  76.2173251971        1
[INPUT] 0    0    [1    /1   ]  9.80327716832        1
[INPUT] 0    0    [1    /1   ]  26.9811228586        1
[INPUT] 0    0    [1    /1   ]  0.377585166671       1
[INPUT] 0    0    [1    /1   ]  1.11634428013        1
[INPUT] 0    0    [1    /1   ]  3.02327329486        1
[INPUT] 1    0    [1    /1   ]  5.87925621017        1
[INPUT] 1    0    [1    /1   ]  17.2463508825        1
[INPUT] 1    0    [1    /1   ]  63.1817278214        1
[INPUT] 1    0    [1    /1   ]  0.252390595915       1
[INPUT] 1    0    [1    /1   ]  2.12109312324        1
[INPUT] 1    0    [1    /1   ]  0.761397864852       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128663936, 1.0]], [0, [3661.454540932635, 1.0]], [0, [833.2692180602746, 1.0]], [0, [235.76510410320995, 1.0]], [0, [76.21732519714583, 1.0]], [0, [9.80327716831776, 1.0]], [0, [26.98112285855314, 1.0]], [0, [0.37758516667064934, 1.0]], [0, [1.116344280133417, 1.0]], [0, [3.0232732948558767, 1.0]], [1, [5.879256210166447, 1.0]], [1, [17.246350882483245, 1.0]], [1, [63.18172782139349, 1.0]], [1, [0.25239059591490104, 1.0]], [1, [2.1210931232439854, 1.0]], [1, [0.7613978648519117, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412866]
bas 1, expnt(s) = [3661.45454093]
bas 2, expnt(s) = [833.26921806]
bas 3, expnt(s) = [235.7651041]
bas 4, expnt(s) = [76.2173252]
bas 5, expnt(s) = [9.80327717]
bas 6, expnt(s) = [26.98112286]
bas 7, expnt(s) = [0.37758517]
bas 8, expnt(s) = [1.11634428]
bas 9, expnt(s) = [3.02327329]
bas 10, expnt(s) = [5.87925621]
bas 11, expnt(s) = [17.24635088]
bas 12, expnt(s) = [63.18172782]
bas 13, expnt(s) = [0.2523906]
bas 14, expnt(s) = [2.12109312]
bas 15, expnt(s) = [0.76139786]
CPU time:       177.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269218e+02 3.91835724e+02 2.35765104e+02 1.52010878e+02
 7.62173252e+01 6.51711376e+01 9.80327717e+00 1.39972747e+01
 2.69811229e+01 2.99095610e+01 3.77585167e-01 1.21695976e+00
 1.11634428e+00 2.74387067e+00 3.02327329e+00 5.79259387e+00
 5.87925621e+00 2.67077545e+01 1.72463509e+01 1.02531170e+02
 6.31817278e+01 5.19665356e+02 2.52390596e-01 5.21886249e-01
 2.12109312e+00 7.46765185e+00 7.61397865e-01 2.07490855e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999701499468307
cond(S) = 345.0402005303569
E1 = -183.5880435721601  E_coul = 55.080204514147354
init E= -128.507839058013
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775147823523866  LUMO = 0.760775799066207
  mo_energy =
[-3.25549730e+01 -1.85256581e+00 -7.75147824e-01 -7.75147824e-01
 -7.75147824e-01  7.60775799e-01  7.60775799e-01  7.60775799e-01
  1.21334071e+00  3.53275908e+00  3.53275908e+00  3.53275908e+00
  7.51572142e+00  1.21601689e+01  1.21601689e+01  1.21601689e+01
  3.48413587e+01  4.09700481e+01  4.09700481e+01  4.09700481e+01
  1.38359222e+02  1.57962787e+02  1.57962787e+02  1.57962787e+02
  5.01889728e+02  1.86937349e+03  7.99914664e+03  4.77670002e+04]
E1 = -182.07181373758425  E_coul = 53.53588705397265
cycle= 1 E= -128.535926683612  delta_E= -0.0281  |g|= 0.206  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.536829
diis-c [-0.28818537  1.        ]
  HOMO = -0.884876890284393  LUMO = 0.736785467666801
  mo_energy =
[-3.28806084e+01 -1.96748208e+00 -8.84876890e-01 -8.84876890e-01
 -8.84876890e-01  7.36785468e-01  7.36785468e-01  7.36785468e-01
  1.16715214e+00  3.44516402e+00  3.44516402e+00  3.44516402e+00
  7.38065253e+00  1.19861640e+01  1.19861640e+01  1.19861640e+01
  3.45929358e+01  4.07068629e+01  4.07068629e+01  4.07068629e+01
  1.38039053e+02  1.57630616e+02  1.57630616e+02  1.57630616e+02
  5.01525491e+02  1.86897318e+03  7.99871739e+03  4.77665521e+04]
E1 = -182.84098900164665  E_coul = 54.30243617843318
cycle= 2 E= -128.538552823213  delta_E= -0.00263  |g|= 0.105  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273109
diis-c [-6.44482903e-04  3.36478345e-01  6.63521655e-01]
  HOMO = -0.848894493910349  LUMO = 0.744631043544476
  mo_energy =
[-3.27715413e+01 -1.92957630e+00 -8.48894494e-01 -8.48894494e-01
 -8.48894494e-01  7.44631044e-01  7.44631044e-01  7.44631044e-01
  1.18199520e+00  3.47356554e+00  3.47356554e+00  3.47356554e+00
  7.42503142e+00  1.20437073e+01  1.20437073e+01  1.20437073e+01
  3.46762558e+01  4.07950251e+01  4.07950251e+01  4.07950251e+01
  1.38146022e+02  1.57740859e+02  1.57740859e+02  1.57740859e+02
  5.01643368e+02  1.86909633e+03  7.99884299e+03  4.77666786e+04]
E1 = -182.57947569182664  E_coul = 54.03998435866702
cycle= 3 E= -128.53949133316  delta_E= -0.000939  |g|= 0.000495  |ddm|= 0.0229
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118642
diis-c [-1.29782767e-07 -2.22132449e-03 -2.19428386e-04  1.00244075e+00]
  HOMO = -0.849148059766965  LUMO = 0.744597922899884
  mo_energy =
[-3.27720010e+01 -1.92977583e+00 -8.49148060e-01 -8.49148060e-01
 -8.49148060e-01  7.44597923e-01  7.44597923e-01  7.44597923e-01
  1.18191591e+00  3.47340537e+00  3.47340537e+00  3.47340537e+00
  7.42481418e+00  1.20434262e+01  1.20434262e+01  1.20434262e+01
  3.46759003e+01  4.07946426e+01  4.07946426e+01  4.07946426e+01
  1.38145559e+02  1.57740371e+02  1.57740371e+02  1.57740371e+02
  5.01642781e+02  1.86909562e+03  7.99884217e+03  4.77666777e+04]
E1 = -182.57994536630176  E_coul = 54.04045401156082
cycle= 4 E= -128.539491354741  delta_E= -2.16e-08  |g|= 7.9e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000200563
diis-c [-7.70889267e-10  1.63021994e-04  5.09844883e-04 -1.51223876e-01
  1.15055101e+00]
  HOMO = -0.84919009957319  LUMO = 0.744586248188269
  mo_energy =
[-3.27720764e+01 -1.92981100e+00 -8.49190100e-01 -8.49190100e-01
 -8.49190100e-01  7.44586248e-01  7.44586248e-01  7.44586248e-01
  1.18189610e+00  3.47336867e+00  3.47336867e+00  3.47336867e+00
  7.42476847e+00  1.20433697e+01  1.20433697e+01  1.20433697e+01
  3.46758340e+01  4.07945737e+01  4.07945737e+01  4.07945737e+01
  1.38145483e+02  1.57740294e+02  1.57740294e+02  1.57740294e+02
  5.01642698e+02  1.86909553e+03  7.99884208e+03  4.77666776e+04]
E1 = -182.58009105633417  E_coul = 54.040599701007494
cycle= 5 E= -128.539491355327  delta_E= -5.86e-10  |g|= 3.84e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58009105633417  E_coul = 54.040599701007494
  HOMO = -0.849188303296552  LUMO = 0.744586710880918
  mo_energy =
[-3.27720723e+01 -1.92980857e+00 -8.49188303e-01 -8.49188303e-01
 -8.49188303e-01  7.44586711e-01  7.44586711e-01  7.44586711e-01
  1.18189728e+00  3.47337023e+00  3.47337023e+00  3.47337023e+00
  7.42477102e+00  1.20433725e+01  1.20433725e+01  1.20433725e+01
  3.46758377e+01  4.07945774e+01  4.07945774e+01  4.07945774e+01
  1.38145487e+02  1.57740298e+02  1.57740298e+02  1.57740298e+02
  5.01642702e+02  1.86909553e+03  7.99884208e+03  4.77666776e+04]
E1 = -182.58008134415346  E_coul = 54.04058998882608
Extra cycle  E= -128.539491355327  delta_E= -7.11e-13  |g|= 1.37e-06  |ddm|= 1.58e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269218e+02 2.35765104e+02
 7.62173252e+01 9.80327717e+00 2.69811229e+01 3.77585167e-01
 1.11634428e+00 3.02327329e+00 5.87925621e+00 1.72463509e+01
 6.31817278e+01 2.52390596e-01 2.12109312e+00 7.61397865e-01]
E = -128.53949135532739
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941287        1
[INPUT] 0    0    [1    /1   ]  3661.45454093        1
[INPUT] 0    0    [1    /1   ]  833.26921806         1
[INPUT] 0    0    [1    /1   ]  235.765104103        1
[INPUT] 0    0    [1    /1   ]  76.2173251971        1
[INPUT] 0    0    [1    /1   ]  9.80327716832        1
[INPUT] 0    0    [1    /1   ]  26.9811228586        1
[INPUT] 0    0    [1    /1   ]  0.377585166671       1
[INPUT] 0    0    [1    /1   ]  1.11634428013        1
[INPUT] 0    0    [1    /1   ]  3.02327329486        1
[INPUT] 1    0    [1    /1   ]  5.87925621017        1
[INPUT] 1    0    [1    /1   ]  17.2463508825        1
[INPUT] 1    0    [1    /1   ]  63.1817278214        1
[INPUT] 1    0    [1    /1   ]  0.252390595915       1
[INPUT] 1    0    [1    /1   ]  2.12109312324        1
[INPUT] 1    0    [1    /1   ]  0.761397864852       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128663936, 1.0]], [0, [3661.454540932635, 1.0]], [0, [833.2692180602746, 1.0]], [0, [235.76510410320995, 1.0]], [0, [76.21732519714583, 1.0]], [0, [9.80327716831776, 1.0]], [0, [26.98112285855314, 1.0]], [0, [0.37758516667064934, 1.0]], [0, [1.116344280133417, 1.0]], [0, [3.0232732948558767, 1.0]], [1, [5.879256210166447, 1.0]], [1, [17.246350882483245, 1.0]], [1, [63.18172782139349, 1.0]], [1, [0.25239059591490104, 1.0]], [1, [2.1210931232439854, 1.0]], [1, [0.7613978648519117, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412866]
bas 1, expnt(s) = [3661.45454093]
bas 2, expnt(s) = [833.26921806]
bas 3, expnt(s) = [235.7651041]
bas 4, expnt(s) = [76.2173252]
bas 5, expnt(s) = [9.80327717]
bas 6, expnt(s) = [26.98112286]
bas 7, expnt(s) = [0.37758517]
bas 8, expnt(s) = [1.11634428]
bas 9, expnt(s) = [3.02327329]
bas 10, expnt(s) = [5.87925621]
bas 11, expnt(s) = [17.24635088]
bas 12, expnt(s) = [63.18172782]
bas 13, expnt(s) = [0.2523906]
bas 14, expnt(s) = [2.12109312]
bas 15, expnt(s) = [0.76139786]
CPU time:       178.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145454e+03 1.18920098e+03
 8.33269218e+02 3.91835724e+02 2.35765104e+02 1.52010878e+02
 7.62173252e+01 6.51711376e+01 9.80327717e+00 1.39972747e+01
 2.69811229e+01 2.99095610e+01 3.77585167e-01 1.21695976e+00
 1.11634428e+00 2.74387067e+00 3.02327329e+00 5.79259387e+00
 5.87925621e+00 2.67077545e+01 1.72463509e+01 1.02531170e+02
 6.31817278e+01 5.19665356e+02 2.52390596e-01 5.21886249e-01
 2.12109312e+00 7.46765185e+00 7.61397865e-01 2.07490855e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999701499468307
cond(S) = 345.0402005303569
E1 = -183.5880435721601  E_coul = 55.080204514147354
init E= -128.507839058013
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775147823523866  LUMO = 0.760775799066207
  mo_energy =
[-3.25549730e+01 -1.85256581e+00 -7.75147824e-01 -7.75147824e-01
 -7.75147824e-01  7.60775799e-01  7.60775799e-01  7.60775799e-01
  1.21334071e+00  3.53275908e+00  3.53275908e+00  3.53275908e+00
  7.51572142e+00  1.21601689e+01  1.21601689e+01  1.21601689e+01
  3.48413587e+01  4.09700481e+01  4.09700481e+01  4.09700481e+01
  1.38359222e+02  1.57962787e+02  1.57962787e+02  1.57962787e+02
  5.01889728e+02  1.86937349e+03  7.99914664e+03  4.77670002e+04]
E1 = -182.07181373758425  E_coul = 53.53588705397265
cycle= 1 E= -128.535926683612  delta_E= -0.0281  |g|= 0.206  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.536829
diis-c [-0.28818537  1.        ]
  HOMO = -0.884876890284393  LUMO = 0.736785467666801
  mo_energy =
[-3.28806084e+01 -1.96748208e+00 -8.84876890e-01 -8.84876890e-01
 -8.84876890e-01  7.36785468e-01  7.36785468e-01  7.36785468e-01
  1.16715214e+00  3.44516402e+00  3.44516402e+00  3.44516402e+00
  7.38065253e+00  1.19861640e+01  1.19861640e+01  1.19861640e+01
  3.45929358e+01  4.07068629e+01  4.07068629e+01  4.07068629e+01
  1.38039053e+02  1.57630616e+02  1.57630616e+02  1.57630616e+02
  5.01525491e+02  1.86897318e+03  7.99871739e+03  4.77665521e+04]
E1 = -182.84098900164665  E_coul = 54.30243617843318
cycle= 2 E= -128.538552823213  delta_E= -0.00263  |g|= 0.105  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273109
diis-c [-6.44482903e-04  3.36478345e-01  6.63521655e-01]
  HOMO = -0.848894493910349  LUMO = 0.744631043544476
  mo_energy =
[-3.27715413e+01 -1.92957630e+00 -8.48894494e-01 -8.48894494e-01
 -8.48894494e-01  7.44631044e-01  7.44631044e-01  7.44631044e-01
  1.18199520e+00  3.47356554e+00  3.47356554e+00  3.47356554e+00
  7.42503142e+00  1.20437073e+01  1.20437073e+01  1.20437073e+01
  3.46762558e+01  4.07950251e+01  4.07950251e+01  4.07950251e+01
  1.38146022e+02  1.57740859e+02  1.57740859e+02  1.57740859e+02
  5.01643368e+02  1.86909633e+03  7.99884299e+03  4.77666786e+04]
E1 = -182.57947569182664  E_coul = 54.03998435866702
cycle= 3 E= -128.53949133316  delta_E= -0.000939  |g|= 0.000495  |ddm|= 0.0229
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118642
diis-c [-1.29782767e-07 -2.22132449e-03 -2.19428386e-04  1.00244075e+00]
  HOMO = -0.849148059766965  LUMO = 0.744597922899884
  mo_energy =
[-3.27720010e+01 -1.92977583e+00 -8.49148060e-01 -8.49148060e-01
 -8.49148060e-01  7.44597923e-01  7.44597923e-01  7.44597923e-01
  1.18191591e+00  3.47340537e+00  3.47340537e+00  3.47340537e+00
  7.42481418e+00  1.20434262e+01  1.20434262e+01  1.20434262e+01
  3.46759003e+01  4.07946426e+01  4.07946426e+01  4.07946426e+01
  1.38145559e+02  1.57740371e+02  1.57740371e+02  1.57740371e+02
  5.01642781e+02  1.86909562e+03  7.99884217e+03  4.77666777e+04]
E1 = -182.57994536630176  E_coul = 54.04045401156082
cycle= 4 E= -128.539491354741  delta_E= -2.16e-08  |g|= 7.9e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000200563
diis-c [-7.70889267e-10  1.63021994e-04  5.09844883e-04 -1.51223876e-01
  1.15055101e+00]
  HOMO = -0.84919009957319  LUMO = 0.744586248188269
  mo_energy =
[-3.27720764e+01 -1.92981100e+00 -8.49190100e-01 -8.49190100e-01
 -8.49190100e-01  7.44586248e-01  7.44586248e-01  7.44586248e-01
  1.18189610e+00  3.47336867e+00  3.47336867e+00  3.47336867e+00
  7.42476847e+00  1.20433697e+01  1.20433697e+01  1.20433697e+01
  3.46758340e+01  4.07945737e+01  4.07945737e+01  4.07945737e+01
  1.38145483e+02  1.57740294e+02  1.57740294e+02  1.57740294e+02
  5.01642698e+02  1.86909553e+03  7.99884208e+03  4.77666776e+04]
E1 = -182.58009105633417  E_coul = 54.040599701007494
cycle= 5 E= -128.539491355327  delta_E= -5.86e-10  |g|= 3.84e-06  |ddm|= 3.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58009105633417  E_coul = 54.040599701007494
  HOMO = -0.849188303296552  LUMO = 0.744586710880918
  mo_energy =
[-3.27720723e+01 -1.92980857e+00 -8.49188303e-01 -8.49188303e-01
 -8.49188303e-01  7.44586711e-01  7.44586711e-01  7.44586711e-01
  1.18189728e+00  3.47337023e+00  3.47337023e+00  3.47337023e+00
  7.42477102e+00  1.20433725e+01  1.20433725e+01  1.20433725e+01
  3.46758377e+01  4.07945774e+01  4.07945774e+01  4.07945774e+01
  1.38145487e+02  1.57740298e+02  1.57740298e+02  1.57740298e+02
  5.01642702e+02  1.86909553e+03  7.99884208e+03  4.77666776e+04]
E1 = -182.58008134415346  E_coul = 54.04058998882608
Extra cycle  E= -128.539491355327  delta_E= -7.11e-13  |g|= 1.37e-06  |ddm|= 1.58e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.0402005303569
E1 = -182.58008134415346  E_coul = 54.04058998882608
init E= -128.539491355327
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849189000669903  LUMO = 0.744586567770325
  mo_energy =
[-3.27720745e+01 -1.92980919e+00 -8.49189001e-01 -8.49189001e-01
 -8.49189001e-01  7.44586568e-01  7.44586568e-01  7.44586568e-01
  1.18189706e+00  3.47336969e+00  3.47336969e+00  3.47336969e+00
  7.42477023e+00  1.20433714e+01  1.20433714e+01  1.20433714e+01
  3.46758361e+01  4.07945757e+01  4.07945757e+01  4.07945757e+01
  1.38145485e+02  1.57740296e+02  1.57740296e+02  1.57740296e+02
  5.01642699e+02  1.86909553e+03  7.99884208e+03  4.77666776e+04]
E1 = -182.58008669490727  E_coul = 54.040595339579355
cycle= 1 E= -128.539491355328  delta_E= -5.4e-13  |g|= 7.38e-07  |ddm|= 4.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58008669490727  E_coul = 54.040595339579355
  HOMO = -0.849188625461158  LUMO = 0.744586651610624
  mo_energy =
[-3.27720734e+01 -1.92980877e+00 -8.49188625e-01 -8.49188625e-01
 -8.49188625e-01  7.44586652e-01  7.44586652e-01  7.44586652e-01
  1.18189723e+00  3.47336999e+00  3.47336999e+00  3.47336999e+00
  7.42477071e+00  1.20433720e+01  1.20433720e+01  1.20433720e+01
  3.46758370e+01  4.07945766e+01  4.07945766e+01  4.07945766e+01
  1.38145486e+02  1.57740297e+02  1.57740297e+02  1.57740297e+02
  5.01642701e+02  1.86909553e+03  7.99884208e+03  4.77666776e+04]
E1 = -182.58008400133994  E_coul = 54.04059264601205
Extra cycle  E= -128.539491355328  delta_E= 2.84e-14  |g|= 3.65e-07  |ddm|= 2.57e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145454e+03 8.33269218e+02 2.35765104e+02
 7.62173252e+01 9.80327717e+00 2.69811229e+01 3.77585167e-01
 1.11634428e+00 3.02327329e+00 5.87925621e+00 1.72463509e+01
 6.31817278e+01 2.52390596e-01 2.12109312e+00 7.61397865e-01]
grad_E = [-2.22235443e-09  1.16696234e-07 -2.27150787e-06  2.55993655e-05
 -1.80494511e-04 -1.62111940e-03  8.39653517e-04 -5.27922471e-04
 -1.95126192e-04  4.91935759e-04  7.85840844e-04  6.68416776e-05
 -1.53102746e-04 -3.69005039e-03 -3.13412196e-03  6.51207117e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941284        1
[INPUT] 0    0    [1    /1   ]  3661.45455266        1
[INPUT] 0    0    [1    /1   ]  833.26886            1
[INPUT] 0    0    [1    /1   ]  235.771841406        1
[INPUT] 0    0    [1    /1   ]  76.1694198447        1
[INPUT] 0    0    [1    /1   ]  9.85385156051        1
[INPUT] 0    0    [1    /1   ]  26.8996356368        1
[INPUT] 0    0    [1    /1   ]  0.38049714313        1
[INPUT] 0    0    [1    /1   ]  1.12734846486        1
[INPUT] 0    0    [1    /1   ]  3.03740675218        1
[INPUT] 1    0    [1    /1   ]  6.25429404955        1
[INPUT] 1    0    [1    /1   ]  18.3583049358        1
[INPUT] 1    0    [1    /1   ]  65.6330918978        1
[INPUT] 1    0    [1    /1   ]  0.259759742607       1
[INPUT] 1    0    [1    /1   ]  2.23819520127        1
[INPUT] 1    0    [1    /1   ]  0.795458027621       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128446927, 1.0]], [0, [3661.4545526623365, 1.0]], [0, [833.2688600003518, 1.0]], [0, [235.7718414061711, 1.0]], [0, [76.1694198447344, 1.0]], [0, [9.853851560510092, 1.0]], [0, [26.899635636822886, 1.0]], [0, [0.380497143129762, 1.0]], [0, [1.127348464859224, 1.0]], [0, [3.0374067521801424, 1.0]], [1, [6.254294049545826, 1.0]], [1, [18.35830493578503, 1.0]], [1, [65.63309189777054, 1.0]], [1, [0.25975974260704815, 1.0]], [1, [2.23819520127407, 1.0]], [1, [0.795458027621188, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412845]
bas 1, expnt(s) = [3661.45455266]
bas 2, expnt(s) = [833.26886]
bas 3, expnt(s) = [235.77184141]
bas 4, expnt(s) = [76.16941984]
bas 5, expnt(s) = [9.85385156]
bas 6, expnt(s) = [26.89963564]
bas 7, expnt(s) = [0.38049714]
bas 8, expnt(s) = [1.12734846]
bas 9, expnt(s) = [3.03740675]
bas 10, expnt(s) = [6.25429405]
bas 11, expnt(s) = [18.35830494]
bas 12, expnt(s) = [65.6330919]
bas 13, expnt(s) = [0.25975974]
bas 14, expnt(s) = [2.2381952]
bas 15, expnt(s) = [0.79545803]
CPU time:       181.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145455e+03 1.18920098e+03
 8.33268860e+02 3.91835598e+02 2.35771841e+02 1.52014136e+02
 7.61694198e+01 6.51404133e+01 9.85385156e+00 1.40513980e+01
 2.68996356e+01 2.98417867e+01 3.80497143e-01 1.22399199e+00
 1.12734846e+00 2.76413123e+00 3.03740675e+00 5.81289181e+00
 6.25429405e+00 2.88540821e+01 1.83583049e+01 1.10860062e+02
 6.56330919e+01 5.44989296e+02 2.59759743e-01 5.41002409e-01
 2.23819520e+00 7.98650638e+00 7.95458028e-01 2.19157319e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644053961912
cond(S) = 349.63860635941
E1 = -183.58823195809063  E_coul = 55.080239386889964
init E= -128.507992571201
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775163225313258  LUMO = 0.792291028218028
  mo_energy =
[-3.25550181e+01 -1.85256317e+00 -7.75163225e-01 -7.75163225e-01
 -7.75163225e-01  7.92291028e-01  7.92291028e-01  7.92291028e-01
  1.22785731e+00  3.71130850e+00  3.71130850e+00  3.71130850e+00
  7.58755320e+00  1.29053246e+01  1.29053246e+01  1.29053246e+01
  3.50105662e+01  4.38344167e+01  4.38344167e+01  4.38344167e+01
  1.38437217e+02  1.66878567e+02  1.66878567e+02  1.66878567e+02
  5.01778652e+02  1.86919410e+03  7.99897273e+03  4.77668534e+04]
E1 = -182.0765383150969  E_coul = 53.540344244221224
cycle= 1 E= -128.536194070876  delta_E= -0.0282  |g|= 0.206  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53256
diis-c [-0.28361964  1.        ]
  HOMO = -0.884562437517552  LUMO = 0.766973673056514
  mo_energy =
[-3.28798089e+01 -1.96711246e+00 -8.84562438e-01 -8.84562438e-01
 -8.84562438e-01  7.66973673e-01  7.66973673e-01  7.66973673e-01
  1.18137556e+00  3.61999055e+00  3.61999055e+00  3.61999055e+00
  7.45232184e+00  1.27263728e+01  1.27263728e+01  1.27263728e+01
  3.47627247e+01  4.35676923e+01  4.35676923e+01  4.35676923e+01
  1.38117970e+02  1.66545759e+02  1.66545759e+02  1.66545759e+02
  5.01415358e+02  1.86879477e+03  7.99854444e+03  4.77664062e+04]
E1 = -182.84246629102307  E_coul = 54.30365997445999
cycle= 2 E= -128.538806316563  delta_E= -0.00261  |g|= 0.104  |ddm|= 0.0658
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.270601
diis-c [-6.46450579e-04  3.36184686e-01  6.63815314e-01]
  HOMO = -0.84872487656329  LUMO = 0.775243662892433
  mo_energy =
[-3.27711162e+01 -1.92936263e+00 -8.48724877e-01 -8.48724877e-01
 -8.48724877e-01  7.75243663e-01  7.75243663e-01  7.75243663e-01
  1.19630081e+00  3.64959459e+00  3.64959459e+00  3.64959459e+00
  7.49672002e+00  1.27855636e+01  1.27855636e+01  1.27855636e+01
  3.48457869e+01  4.36569868e+01  4.36569868e+01  4.36569868e+01
  1.38224549e+02  1.66656057e+02  1.66656057e+02  1.66656057e+02
  5.01532835e+02  1.86891751e+03  7.99866963e+03  4.77665323e+04]
E1 = -182.58220306036537  E_coul = 54.04246602309481
cycle= 3 E= -128.539737037271  delta_E= -0.000931  |g|= 0.000503  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120055
diis-c [-1.28000778e-07 -2.25262972e-03 -1.89944280e-04  1.00244257e+00]
  HOMO = -0.848981694287569  LUMO = 0.775207353789741
  mo_energy =
[-3.27715828e+01 -1.92956554e+00 -8.48981694e-01 -8.48981694e-01
 -8.48981694e-01  7.75207354e-01  7.75207354e-01  7.75207354e-01
  1.19621903e+00  3.64942463e+00  3.64942463e+00  3.64942463e+00
  7.49649774e+00  1.27852709e+01  1.27852709e+01  1.27852709e+01
  3.48454253e+01  4.36565933e+01  4.36565933e+01  4.36565933e+01
  1.38224080e+02  1.66655559e+02  1.66655559e+02  1.66655559e+02
  5.01532241e+02  1.86891679e+03  7.99866881e+03  4.77665314e+04]
E1 = -182.58269718299755  E_coul = 54.042960123946926
cycle= 4 E= -128.539737059051  delta_E= -2.18e-08  |g|= 7.84e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000198637
diis-c [-7.57151891e-10  1.68793271e-04  5.06335187e-04 -1.51291589e-01
  1.15061646e+00]
  HOMO = -0.849023314155775  LUMO = 0.775195277656944
  mo_energy =
[-3.27716576e+01 -1.92960019e+00 -8.49023314e-01 -8.49023314e-01
 -8.49023314e-01  7.75195278e-01  7.75195278e-01  7.75195278e-01
  1.19619949e+00  3.64938715e+00  3.64938715e+00  3.64938715e+00
  7.49645241e+00  1.27852140e+01  1.27852140e+01  1.27852140e+01
  3.48453596e+01  4.36565245e+01  4.36565245e+01  4.36565245e+01
  1.38224005e+02  1.66655482e+02  1.66655482e+02  1.66655482e+02
  5.01532159e+02  1.86891670e+03  7.99866872e+03  4.77665313e+04]
E1 = -182.58284329042974  E_coul = 54.043106230805535
cycle= 5 E= -128.539737059624  delta_E= -5.74e-10  |g|= 3.95e-06  |ddm|= 3.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58284329042974  E_coul = 54.043106230805535
  HOMO = -0.849021448235568  LUMO = 0.775195792963021
  mo_energy =
[-3.27716534e+01 -1.92959767e+00 -8.49021448e-01 -8.49021448e-01
 -8.49021448e-01  7.75195793e-01  7.75195793e-01  7.75195793e-01
  1.19620073e+00  3.64938884e+00  3.64938884e+00  3.64938884e+00
  7.49645507e+00  1.27852169e+01  1.27852169e+01  1.27852169e+01
  3.48453634e+01  4.36565284e+01  4.36565284e+01  4.36565284e+01
  1.38224009e+02  1.66655486e+02  1.66655486e+02  1.66655486e+02
  5.01532162e+02  1.86891670e+03  7.99866872e+03  4.77665313e+04]
E1 = -182.58283347274678  E_coul = 54.0430964131216
Extra cycle  E= -128.539737059625  delta_E= -9.66e-13  |g|= 1.39e-06  |ddm|= 1.65e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145455e+03 8.33268860e+02 2.35771841e+02
 7.61694198e+01 9.85385156e+00 2.68996356e+01 3.80497143e-01
 1.12734846e+00 3.03740675e+00 6.25429405e+00 1.83583049e+01
 6.56330919e+01 2.59759743e-01 2.23819520e+00 7.95458028e-01]
E = -128.53973705962517
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941284        1
[INPUT] 0    0    [1    /1   ]  3661.45455266        1
[INPUT] 0    0    [1    /1   ]  833.26886            1
[INPUT] 0    0    [1    /1   ]  235.771841406        1
[INPUT] 0    0    [1    /1   ]  76.1694198447        1
[INPUT] 0    0    [1    /1   ]  9.85385156051        1
[INPUT] 0    0    [1    /1   ]  26.8996356368        1
[INPUT] 0    0    [1    /1   ]  0.38049714313        1
[INPUT] 0    0    [1    /1   ]  1.12734846486        1
[INPUT] 0    0    [1    /1   ]  3.03740675218        1
[INPUT] 1    0    [1    /1   ]  6.25429404955        1
[INPUT] 1    0    [1    /1   ]  18.3583049358        1
[INPUT] 1    0    [1    /1   ]  65.6330918978        1
[INPUT] 1    0    [1    /1   ]  0.259759742607       1
[INPUT] 1    0    [1    /1   ]  2.23819520127        1
[INPUT] 1    0    [1    /1   ]  0.795458027621       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794128446927, 1.0]], [0, [3661.4545526623365, 1.0]], [0, [833.2688600003518, 1.0]], [0, [235.7718414061711, 1.0]], [0, [76.1694198447344, 1.0]], [0, [9.853851560510092, 1.0]], [0, [26.899635636822886, 1.0]], [0, [0.380497143129762, 1.0]], [0, [1.127348464859224, 1.0]], [0, [3.0374067521801424, 1.0]], [1, [6.254294049545826, 1.0]], [1, [18.35830493578503, 1.0]], [1, [65.63309189777054, 1.0]], [1, [0.25975974260704815, 1.0]], [1, [2.23819520127407, 1.0]], [1, [0.795458027621188, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412845]
bas 1, expnt(s) = [3661.45455266]
bas 2, expnt(s) = [833.26886]
bas 3, expnt(s) = [235.77184141]
bas 4, expnt(s) = [76.16941984]
bas 5, expnt(s) = [9.85385156]
bas 6, expnt(s) = [26.89963564]
bas 7, expnt(s) = [0.38049714]
bas 8, expnt(s) = [1.12734846]
bas 9, expnt(s) = [3.03740675]
bas 10, expnt(s) = [6.25429405]
bas 11, expnt(s) = [18.35830494]
bas 12, expnt(s) = [65.6330919]
bas 13, expnt(s) = [0.25975974]
bas 14, expnt(s) = [2.2381952]
bas 15, expnt(s) = [0.79545803]
CPU time:       182.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145455e+03 1.18920098e+03
 8.33268860e+02 3.91835598e+02 2.35771841e+02 1.52014136e+02
 7.61694198e+01 6.51404133e+01 9.85385156e+00 1.40513980e+01
 2.68996356e+01 2.98417867e+01 3.80497143e-01 1.22399199e+00
 1.12734846e+00 2.76413123e+00 3.03740675e+00 5.81289181e+00
 6.25429405e+00 2.88540821e+01 1.83583049e+01 1.10860062e+02
 6.56330919e+01 5.44989296e+02 2.59759743e-01 5.41002409e-01
 2.23819520e+00 7.98650638e+00 7.95458028e-01 2.19157319e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644053961912
cond(S) = 349.63860635941
E1 = -183.58823195809063  E_coul = 55.080239386889964
init E= -128.507992571201
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775163225313258  LUMO = 0.792291028218028
  mo_energy =
[-3.25550181e+01 -1.85256317e+00 -7.75163225e-01 -7.75163225e-01
 -7.75163225e-01  7.92291028e-01  7.92291028e-01  7.92291028e-01
  1.22785731e+00  3.71130850e+00  3.71130850e+00  3.71130850e+00
  7.58755320e+00  1.29053246e+01  1.29053246e+01  1.29053246e+01
  3.50105662e+01  4.38344167e+01  4.38344167e+01  4.38344167e+01
  1.38437217e+02  1.66878567e+02  1.66878567e+02  1.66878567e+02
  5.01778652e+02  1.86919410e+03  7.99897273e+03  4.77668534e+04]
E1 = -182.0765383150969  E_coul = 53.540344244221224
cycle= 1 E= -128.536194070876  delta_E= -0.0282  |g|= 0.206  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53256
diis-c [-0.28361964  1.        ]
  HOMO = -0.884562437517552  LUMO = 0.766973673056514
  mo_energy =
[-3.28798089e+01 -1.96711246e+00 -8.84562438e-01 -8.84562438e-01
 -8.84562438e-01  7.66973673e-01  7.66973673e-01  7.66973673e-01
  1.18137556e+00  3.61999055e+00  3.61999055e+00  3.61999055e+00
  7.45232184e+00  1.27263728e+01  1.27263728e+01  1.27263728e+01
  3.47627247e+01  4.35676923e+01  4.35676923e+01  4.35676923e+01
  1.38117970e+02  1.66545759e+02  1.66545759e+02  1.66545759e+02
  5.01415358e+02  1.86879477e+03  7.99854444e+03  4.77664062e+04]
E1 = -182.84246629102307  E_coul = 54.30365997445999
cycle= 2 E= -128.538806316563  delta_E= -0.00261  |g|= 0.104  |ddm|= 0.0658
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.270601
diis-c [-6.46450579e-04  3.36184686e-01  6.63815314e-01]
  HOMO = -0.84872487656329  LUMO = 0.775243662892433
  mo_energy =
[-3.27711162e+01 -1.92936263e+00 -8.48724877e-01 -8.48724877e-01
 -8.48724877e-01  7.75243663e-01  7.75243663e-01  7.75243663e-01
  1.19630081e+00  3.64959459e+00  3.64959459e+00  3.64959459e+00
  7.49672002e+00  1.27855636e+01  1.27855636e+01  1.27855636e+01
  3.48457869e+01  4.36569868e+01  4.36569868e+01  4.36569868e+01
  1.38224549e+02  1.66656057e+02  1.66656057e+02  1.66656057e+02
  5.01532835e+02  1.86891751e+03  7.99866963e+03  4.77665323e+04]
E1 = -182.58220306036537  E_coul = 54.04246602309481
cycle= 3 E= -128.539737037271  delta_E= -0.000931  |g|= 0.000503  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120055
diis-c [-1.28000778e-07 -2.25262972e-03 -1.89944280e-04  1.00244257e+00]
  HOMO = -0.848981694287569  LUMO = 0.775207353789741
  mo_energy =
[-3.27715828e+01 -1.92956554e+00 -8.48981694e-01 -8.48981694e-01
 -8.48981694e-01  7.75207354e-01  7.75207354e-01  7.75207354e-01
  1.19621903e+00  3.64942463e+00  3.64942463e+00  3.64942463e+00
  7.49649774e+00  1.27852709e+01  1.27852709e+01  1.27852709e+01
  3.48454253e+01  4.36565933e+01  4.36565933e+01  4.36565933e+01
  1.38224080e+02  1.66655559e+02  1.66655559e+02  1.66655559e+02
  5.01532241e+02  1.86891679e+03  7.99866881e+03  4.77665314e+04]
E1 = -182.58269718299755  E_coul = 54.042960123946926
cycle= 4 E= -128.539737059051  delta_E= -2.18e-08  |g|= 7.84e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000198637
diis-c [-7.57151891e-10  1.68793271e-04  5.06335187e-04 -1.51291589e-01
  1.15061646e+00]
  HOMO = -0.849023314155775  LUMO = 0.775195277656944
  mo_energy =
[-3.27716576e+01 -1.92960019e+00 -8.49023314e-01 -8.49023314e-01
 -8.49023314e-01  7.75195278e-01  7.75195278e-01  7.75195278e-01
  1.19619949e+00  3.64938715e+00  3.64938715e+00  3.64938715e+00
  7.49645241e+00  1.27852140e+01  1.27852140e+01  1.27852140e+01
  3.48453596e+01  4.36565245e+01  4.36565245e+01  4.36565245e+01
  1.38224005e+02  1.66655482e+02  1.66655482e+02  1.66655482e+02
  5.01532159e+02  1.86891670e+03  7.99866872e+03  4.77665313e+04]
E1 = -182.58284329042974  E_coul = 54.043106230805535
cycle= 5 E= -128.539737059624  delta_E= -5.74e-10  |g|= 3.95e-06  |ddm|= 3.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58284329042974  E_coul = 54.043106230805535
  HOMO = -0.849021448235568  LUMO = 0.775195792963021
  mo_energy =
[-3.27716534e+01 -1.92959767e+00 -8.49021448e-01 -8.49021448e-01
 -8.49021448e-01  7.75195793e-01  7.75195793e-01  7.75195793e-01
  1.19620073e+00  3.64938884e+00  3.64938884e+00  3.64938884e+00
  7.49645507e+00  1.27852169e+01  1.27852169e+01  1.27852169e+01
  3.48453634e+01  4.36565284e+01  4.36565284e+01  4.36565284e+01
  1.38224009e+02  1.66655486e+02  1.66655486e+02  1.66655486e+02
  5.01532162e+02  1.86891670e+03  7.99866872e+03  4.77665313e+04]
E1 = -182.58283347274678  E_coul = 54.0430964131216
Extra cycle  E= -128.539737059625  delta_E= -9.66e-13  |g|= 1.39e-06  |ddm|= 1.65e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 349.63860635941
E1 = -182.58283347274678  E_coul = 54.0430964131216
init E= -128.539737059625
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.849022151672491  LUMO = 0.775195641095795
  mo_energy =
[-3.27716556e+01 -1.92959830e+00 -8.49022152e-01 -8.49022152e-01
 -8.49022152e-01  7.75195641e-01  7.75195641e-01  7.75195641e-01
  1.19620052e+00  3.64938828e+00  3.64938828e+00  3.64938828e+00
  7.49645426e+00  1.27852158e+01  1.27852158e+01  1.27852158e+01
  3.48453617e+01  4.36565267e+01  4.36565267e+01  4.36565267e+01
  1.38224007e+02  1.66655484e+02  1.66655484e+02  1.66655484e+02
  5.01532160e+02  1.86891670e+03  7.99866872e+03  4.77665313e+04]
E1 = -182.58283891219148  E_coul = 54.043101852566345
cycle= 1 E= -128.539737059625  delta_E= 2.84e-14  |g|= 7.5e-07  |ddm|= 4.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58283891219148  E_coul = 54.043101852566345
  HOMO = -0.849021770214825  LUMO = 0.775195731364857
  mo_energy =
[-3.27716544e+01 -1.92959787e+00 -8.49021770e-01 -8.49021770e-01
 -8.49021770e-01  7.75195731e-01  7.75195731e-01  7.75195731e-01
  1.19620069e+00  3.64938860e+00  3.64938860e+00  3.64938860e+00
  7.49645475e+00  1.27852164e+01  1.27852164e+01  1.27852164e+01
  3.48453626e+01  4.36565276e+01  4.36565276e+01  4.36565276e+01
  1.38224008e+02  1.66655485e+02  1.66655485e+02  1.66655485e+02
  5.01532161e+02  1.86891670e+03  7.99866872e+03  4.77665313e+04]
E1 = -182.58283618077144  E_coul = 54.04309912114602
Extra cycle  E= -128.539737059625  delta_E= -2.84e-13  |g|= 3.71e-07  |ddm|= 2.64e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145455e+03 8.33268860e+02 2.35771841e+02
 7.61694198e+01 9.85385156e+00 2.68996356e+01 3.80497143e-01
 1.12734846e+00 3.03740675e+00 6.25429405e+00 1.83583049e+01
 6.56330919e+01 2.59759743e-01 2.23819520e+00 7.95458028e-01]
grad_E = [-1.51267813e-09  7.90414523e-08 -1.51626806e-06  1.62560530e-05
 -1.09116990e-04 -1.06673373e-03  5.21069514e-04 -5.20281417e-04
 -1.06536047e-04  4.00974481e-04  7.30109561e-04  1.44684836e-04
 -1.52460599e-04 -5.09521206e-03 -3.15528381e-03  7.49434799e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794128         1
[INPUT] 0    0    [1    /1   ]  3661.45457894        1
[INPUT] 0    0    [1    /1   ]  833.268096815        1
[INPUT] 0    0    [1    /1   ]  235.78570577         1
[INPUT] 0    0    [1    /1   ]  76.0705941611        1
[INPUT] 0    0    [1    /1   ]  9.89610613436        1
[INPUT] 0    0    [1    /1   ]  26.7713663806        1
[INPUT] 0    0    [1    /1   ]  0.385828611606       1
[INPUT] 0    0    [1    /1   ]  1.14704489239        1
[INPUT] 0    0    [1    /1   ]  3.07861933373        1
[INPUT] 1    0    [1    /1   ]  6.72851698497        1
[INPUT] 1    0    [1    /1   ]  19.9940150858        1
[INPUT] 1    0    [1    /1   ]  70.4785399375        1
[INPUT] 1    0    [1    /1   ]  0.265677390775       1
[INPUT] 1    0    [1    /1   ]  2.37106968604        1
[INPUT] 1    0    [1    /1   ]  0.826894889598       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.7941279592, 1.0]], [0, [3661.4545789408, 1.0]], [0, [833.2680968150917, 1.0]], [0, [235.7857057704641, 1.0]], [0, [76.07059416107101, 1.0]], [0, [9.89610613435509, 1.0]], [0, [26.77136638064981, 1.0]], [0, [0.385828611605776, 1.0]], [0, [1.1470448923941414, 1.0]], [0, [3.078619333729039, 1.0]], [1, [6.728516984972437, 1.0]], [1, [19.994015085810442, 1.0]], [1, [70.47853993749864, 1.0]], [1, [0.2656773907745234, 1.0]], [1, [2.371069686039763, 1.0]], [1, [0.8268948895975026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412796]
bas 1, expnt(s) = [3661.45457894]
bas 2, expnt(s) = [833.26809682]
bas 3, expnt(s) = [235.78570577]
bas 4, expnt(s) = [76.07059416]
bas 5, expnt(s) = [9.89610613]
bas 6, expnt(s) = [26.77136638]
bas 7, expnt(s) = [0.38582861]
bas 8, expnt(s) = [1.14704489]
bas 9, expnt(s) = [3.07861933]
bas 10, expnt(s) = [6.72851698]
bas 11, expnt(s) = [19.99401509]
bas 12, expnt(s) = [70.47853994]
bas 13, expnt(s) = [0.26567739]
bas 14, expnt(s) = [2.37106969]
bas 15, expnt(s) = [0.82689489]
CPU time:       185.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145458e+03 1.18920099e+03
 8.33268097e+02 3.91835328e+02 2.35785706e+02 1.52020840e+02
 7.60705942e+01 6.50770160e+01 9.89610613e+00 1.40965645e+01
 2.67713664e+01 2.97349989e+01 3.85828612e-01 1.23683238e+00
 1.14704489e+00 2.80027276e+00 3.07861933e+00 5.87194553e+00
 6.72851698e+00 3.16143010e+01 1.99940151e+01 1.23341553e+02
 7.04785399e+01 5.95738292e+02 2.65677391e-01 5.56451912e-01
 2.37106969e+00 8.58350749e+00 8.26894890e-01 2.30036779e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584669547364
cond(S) = 358.09226154735694
E1 = -183.58843461193314  E_coul = 55.08025610130066
init E= -128.508178510632
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775206002169667  LUMO = 0.819574592251821
  mo_energy =
[-3.25550428e+01 -1.85255550e+00 -7.75206002e-01 -7.75206002e-01
 -7.75206002e-01  8.19574592e-01  8.19574592e-01  8.19574592e-01
  1.25483682e+00  3.88948655e+00  3.88948655e+00  3.88948655e+00
  7.73134911e+00  1.37722698e+01  1.37722698e+01  1.37722698e+01
  3.52918199e+01  4.76666982e+01  4.76666982e+01  4.76666982e+01
  1.38500682e+02  1.81573559e+02  1.81573559e+02  1.81573559e+02
  5.01486634e+02  1.86877881e+03  7.99857644e+03  4.77665198e+04]
E1 = -182.0816256329084  E_coul = 53.54506799321037
cycle= 1 E= -128.536557639698  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.525842
diis-c [-0.27650951  1.        ]
  HOMO = -0.884256785807227  LUMO = 0.793086060955944
  mo_energy =
[-3.28789125e+01 -1.96672782e+00 -8.84256786e-01 -8.84256786e-01
 -8.84256786e-01  7.93086061e-01  7.93086061e-01  7.93086061e-01
  1.20765638e+00  3.79419558e+00  3.79419558e+00  3.79419558e+00
  7.59537577e+00  1.35873078e+01  1.35873078e+01  1.35873078e+01
  3.50446594e+01  4.73950813e+01  4.73950813e+01  4.73950813e+01
  1.38182505e+02  1.81238924e+02  1.81238924e+02  1.81238924e+02
  5.01124378e+02  1.86838055e+03  7.99814921e+03  4.77660737e+04]
E1 = -182.84436722725454  E_coul = 54.3052119677395
cycle= 2 E= -128.539155259515  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0665
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266895
diis-c [-6.49579504e-04  3.35915929e-01  6.64084071e-01]
  HOMO = -0.848561686188661  LUMO = 0.801736449715377
  mo_energy =
[-3.27705954e+01 -1.92912985e+00 -8.48561686e-01 -8.48561686e-01
 -8.48561686e-01  8.01736450e-01  8.01736450e-01  8.01736450e-01
  1.22280643e+00  3.82509575e+00  3.82509575e+00  3.82509575e+00
  7.63999490e+00  1.36485246e+01  1.36485246e+01  1.36485246e+01
  3.51274503e+01  4.74859773e+01  4.74859773e+01  4.74859773e+01
  1.38288670e+02  1.81349620e+02  1.81349620e+02  1.81349620e+02
  5.01241447e+02  1.86850288e+03  7.99827398e+03  4.77661994e+04]
E1 = -182.58535583089665  E_coul = 54.04527759387318
cycle= 3 E= -128.540078237023  delta_E= -0.000923  |g|= 0.000504  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120025
diis-c [-1.23516527e-07 -2.27005803e-03 -1.63846169e-04  1.00243390e+00]
  HOMO = -0.848818400156473  LUMO = 0.801698695129422
  mo_energy =
[-3.27710646e+01 -1.92933266e+00 -8.48818400e-01 -8.48818400e-01
 -8.48818400e-01  8.01698695e-01  8.01698695e-01  8.01698695e-01
  1.22272442e+00  3.82491909e+00  3.82491909e+00  3.82491909e+00
  7.63977038e+00  1.36482231e+01  1.36482231e+01  1.36482231e+01
  3.51270868e+01  4.74855753e+01  4.74855753e+01  4.74855753e+01
  1.38288199e+02  1.81349113e+02  1.81349113e+02  1.81349113e+02
  5.01240851e+02  1.86850215e+03  7.99827315e+03  4.77661985e+04]
E1 = -182.58587563468166  E_coul = 54.04579737636348
cycle= 4 E= -128.540078258318  delta_E= -2.13e-08  |g|= 7.68e-05  |ddm|= 0.00021
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001936
diis-c [-7.46281754e-10  1.74950222e-04  4.97849868e-04 -1.51512463e-01
  1.15083966e+00]
  HOMO = -0.848858894849867  LUMO = 0.801686555782413
  mo_energy =
[-3.27711378e+01 -1.92936603e+00 -8.48858895e-01 -8.48858895e-01
 -8.48858895e-01  8.01686556e-01  8.01686556e-01  8.01686556e-01
  1.22270552e+00  3.82488150e+00  3.82488150e+00  3.82488150e+00
  7.63972611e+00  1.36481666e+01  1.36481666e+01  1.36481666e+01
  3.51270227e+01  4.74855075e+01  4.74855075e+01  4.74855075e+01
  1.38288126e+02  1.81349038e+02  1.81349038e+02  1.81349038e+02
  5.01240770e+02  1.86850206e+03  7.99827306e+03  4.77661984e+04]
E1 = -182.58602106984014  E_coul = 54.04594281097445
cycle= 5 E= -128.540078258866  delta_E= -5.48e-10  |g|= 4.09e-06  |ddm|= 2.94e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58602106984014  E_coul = 54.04594281097445
  HOMO = -0.848856951754924  LUMO = 0.801687123043303
  mo_energy =
[-3.27711334e+01 -1.92936342e+00 -8.48856952e-01 -8.48856952e-01
 -8.48856952e-01  8.01687123e-01  8.01687123e-01  8.01687123e-01
  1.22270685e+00  3.82488333e+00  3.82488333e+00  3.82488333e+00
  7.63972888e+00  1.36481698e+01  1.36481698e+01  1.36481698e+01
  3.51270266e+01  4.74855116e+01  4.74855116e+01  4.74855116e+01
  1.38288130e+02  1.81349042e+02  1.81349042e+02  1.81349042e+02
  5.01240774e+02  1.86850206e+03  7.99827306e+03  4.77661984e+04]
E1 = -182.58601106839942  E_coul = 54.04593280953238
Extra cycle  E= -128.540078258867  delta_E= -1.34e-12  |g|= 1.42e-06  |ddm|= 1.72e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145458e+03 8.33268097e+02 2.35785706e+02
 7.60705942e+01 9.89610613e+00 2.67713664e+01 3.85828612e-01
 1.14704489e+00 3.07861933e+00 6.72851698e+00 1.99940151e+01
 7.04785399e+01 2.65677391e-01 2.37106969e+00 8.26894890e-01]
E = -128.54007825886703
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794128         1
[INPUT] 0    0    [1    /1   ]  3661.45457894        1
[INPUT] 0    0    [1    /1   ]  833.268096815        1
[INPUT] 0    0    [1    /1   ]  235.78570577         1
[INPUT] 0    0    [1    /1   ]  76.0705941611        1
[INPUT] 0    0    [1    /1   ]  9.89610613436        1
[INPUT] 0    0    [1    /1   ]  26.7713663806        1
[INPUT] 0    0    [1    /1   ]  0.385828611606       1
[INPUT] 0    0    [1    /1   ]  1.14704489239        1
[INPUT] 0    0    [1    /1   ]  3.07861933373        1
[INPUT] 1    0    [1    /1   ]  6.72851698497        1
[INPUT] 1    0    [1    /1   ]  19.9940150858        1
[INPUT] 1    0    [1    /1   ]  70.4785399375        1
[INPUT] 1    0    [1    /1   ]  0.265677390775       1
[INPUT] 1    0    [1    /1   ]  2.37106968604        1
[INPUT] 1    0    [1    /1   ]  0.826894889598       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.7941279592, 1.0]], [0, [3661.4545789408, 1.0]], [0, [833.2680968150917, 1.0]], [0, [235.7857057704641, 1.0]], [0, [76.07059416107101, 1.0]], [0, [9.89610613435509, 1.0]], [0, [26.77136638064981, 1.0]], [0, [0.385828611605776, 1.0]], [0, [1.1470448923941414, 1.0]], [0, [3.078619333729039, 1.0]], [1, [6.728516984972437, 1.0]], [1, [19.994015085810442, 1.0]], [1, [70.47853993749864, 1.0]], [1, [0.2656773907745234, 1.0]], [1, [2.371069686039763, 1.0]], [1, [0.8268948895975026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412796]
bas 1, expnt(s) = [3661.45457894]
bas 2, expnt(s) = [833.26809682]
bas 3, expnt(s) = [235.78570577]
bas 4, expnt(s) = [76.07059416]
bas 5, expnt(s) = [9.89610613]
bas 6, expnt(s) = [26.77136638]
bas 7, expnt(s) = [0.38582861]
bas 8, expnt(s) = [1.14704489]
bas 9, expnt(s) = [3.07861933]
bas 10, expnt(s) = [6.72851698]
bas 11, expnt(s) = [19.99401509]
bas 12, expnt(s) = [70.47853994]
bas 13, expnt(s) = [0.26567739]
bas 14, expnt(s) = [2.37106969]
bas 15, expnt(s) = [0.82689489]
CPU time:       185.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145458e+03 1.18920099e+03
 8.33268097e+02 3.91835328e+02 2.35785706e+02 1.52020840e+02
 7.60705942e+01 6.50770160e+01 9.89610613e+00 1.40965645e+01
 2.67713664e+01 2.97349989e+01 3.85828612e-01 1.23683238e+00
 1.14704489e+00 2.80027276e+00 3.07861933e+00 5.87194553e+00
 6.72851698e+00 3.16143010e+01 1.99940151e+01 1.23341553e+02
 7.04785399e+01 5.95738292e+02 2.65677391e-01 5.56451912e-01
 2.37106969e+00 8.58350749e+00 8.26894890e-01 2.30036779e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584669547364
cond(S) = 358.09226154735694
E1 = -183.58843461193314  E_coul = 55.08025610130066
init E= -128.508178510632
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775206002169667  LUMO = 0.819574592251821
  mo_energy =
[-3.25550428e+01 -1.85255550e+00 -7.75206002e-01 -7.75206002e-01
 -7.75206002e-01  8.19574592e-01  8.19574592e-01  8.19574592e-01
  1.25483682e+00  3.88948655e+00  3.88948655e+00  3.88948655e+00
  7.73134911e+00  1.37722698e+01  1.37722698e+01  1.37722698e+01
  3.52918199e+01  4.76666982e+01  4.76666982e+01  4.76666982e+01
  1.38500682e+02  1.81573559e+02  1.81573559e+02  1.81573559e+02
  5.01486634e+02  1.86877881e+03  7.99857644e+03  4.77665198e+04]
E1 = -182.0816256329084  E_coul = 53.54506799321037
cycle= 1 E= -128.536557639698  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.525842
diis-c [-0.27650951  1.        ]
  HOMO = -0.884256785807227  LUMO = 0.793086060955944
  mo_energy =
[-3.28789125e+01 -1.96672782e+00 -8.84256786e-01 -8.84256786e-01
 -8.84256786e-01  7.93086061e-01  7.93086061e-01  7.93086061e-01
  1.20765638e+00  3.79419558e+00  3.79419558e+00  3.79419558e+00
  7.59537577e+00  1.35873078e+01  1.35873078e+01  1.35873078e+01
  3.50446594e+01  4.73950813e+01  4.73950813e+01  4.73950813e+01
  1.38182505e+02  1.81238924e+02  1.81238924e+02  1.81238924e+02
  5.01124378e+02  1.86838055e+03  7.99814921e+03  4.77660737e+04]
E1 = -182.84436722725454  E_coul = 54.3052119677395
cycle= 2 E= -128.539155259515  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0665
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266895
diis-c [-6.49579504e-04  3.35915929e-01  6.64084071e-01]
  HOMO = -0.848561686188661  LUMO = 0.801736449715377
  mo_energy =
[-3.27705954e+01 -1.92912985e+00 -8.48561686e-01 -8.48561686e-01
 -8.48561686e-01  8.01736450e-01  8.01736450e-01  8.01736450e-01
  1.22280643e+00  3.82509575e+00  3.82509575e+00  3.82509575e+00
  7.63999490e+00  1.36485246e+01  1.36485246e+01  1.36485246e+01
  3.51274503e+01  4.74859773e+01  4.74859773e+01  4.74859773e+01
  1.38288670e+02  1.81349620e+02  1.81349620e+02  1.81349620e+02
  5.01241447e+02  1.86850288e+03  7.99827398e+03  4.77661994e+04]
E1 = -182.58535583089665  E_coul = 54.04527759387318
cycle= 3 E= -128.540078237023  delta_E= -0.000923  |g|= 0.000504  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120025
diis-c [-1.23516527e-07 -2.27005803e-03 -1.63846169e-04  1.00243390e+00]
  HOMO = -0.848818400156473  LUMO = 0.801698695129422
  mo_energy =
[-3.27710646e+01 -1.92933266e+00 -8.48818400e-01 -8.48818400e-01
 -8.48818400e-01  8.01698695e-01  8.01698695e-01  8.01698695e-01
  1.22272442e+00  3.82491909e+00  3.82491909e+00  3.82491909e+00
  7.63977038e+00  1.36482231e+01  1.36482231e+01  1.36482231e+01
  3.51270868e+01  4.74855753e+01  4.74855753e+01  4.74855753e+01
  1.38288199e+02  1.81349113e+02  1.81349113e+02  1.81349113e+02
  5.01240851e+02  1.86850215e+03  7.99827315e+03  4.77661985e+04]
E1 = -182.58587563468166  E_coul = 54.04579737636348
cycle= 4 E= -128.540078258318  delta_E= -2.13e-08  |g|= 7.68e-05  |ddm|= 0.00021
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001936
diis-c [-7.46281754e-10  1.74950222e-04  4.97849868e-04 -1.51512463e-01
  1.15083966e+00]
  HOMO = -0.848858894849867  LUMO = 0.801686555782413
  mo_energy =
[-3.27711378e+01 -1.92936603e+00 -8.48858895e-01 -8.48858895e-01
 -8.48858895e-01  8.01686556e-01  8.01686556e-01  8.01686556e-01
  1.22270552e+00  3.82488150e+00  3.82488150e+00  3.82488150e+00
  7.63972611e+00  1.36481666e+01  1.36481666e+01  1.36481666e+01
  3.51270227e+01  4.74855075e+01  4.74855075e+01  4.74855075e+01
  1.38288126e+02  1.81349038e+02  1.81349038e+02  1.81349038e+02
  5.01240770e+02  1.86850206e+03  7.99827306e+03  4.77661984e+04]
E1 = -182.58602106984014  E_coul = 54.04594281097445
cycle= 5 E= -128.540078258866  delta_E= -5.48e-10  |g|= 4.09e-06  |ddm|= 2.94e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58602106984014  E_coul = 54.04594281097445
  HOMO = -0.848856951754924  LUMO = 0.801687123043303
  mo_energy =
[-3.27711334e+01 -1.92936342e+00 -8.48856952e-01 -8.48856952e-01
 -8.48856952e-01  8.01687123e-01  8.01687123e-01  8.01687123e-01
  1.22270685e+00  3.82488333e+00  3.82488333e+00  3.82488333e+00
  7.63972888e+00  1.36481698e+01  1.36481698e+01  1.36481698e+01
  3.51270266e+01  4.74855116e+01  4.74855116e+01  4.74855116e+01
  1.38288130e+02  1.81349042e+02  1.81349042e+02  1.81349042e+02
  5.01240774e+02  1.86850206e+03  7.99827306e+03  4.77661984e+04]
E1 = -182.58601106839942  E_coul = 54.04593280953238
Extra cycle  E= -128.540078258867  delta_E= -1.34e-12  |g|= 1.42e-06  |ddm|= 1.72e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 358.09226154735694
E1 = -182.58601106839942  E_coul = 54.04593280953238
init E= -128.540078258867
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848857667102685  LUMO = 0.801686961405072
  mo_energy =
[-3.27711357e+01 -1.92936405e+00 -8.48857667e-01 -8.48857667e-01
 -8.48857667e-01  8.01686961e-01  8.01686961e-01  8.01686961e-01
  1.22270663e+00  3.82488273e+00  3.82488273e+00  3.82488273e+00
  7.63972806e+00  1.36481685e+01  1.36481685e+01  1.36481685e+01
  3.51270249e+01  4.74855097e+01  4.74855097e+01  4.74855097e+01
  1.38288127e+02  1.81349040e+02  1.81349040e+02  1.81349040e+02
  5.01240772e+02  1.86850206e+03  7.99827306e+03  4.77661984e+04]
E1 = -182.5860166304138  E_coul = 54.04593837154658
cycle= 1 E= -128.540078258867  delta_E= -1.99e-13  |g|= 7.68e-07  |ddm|= 5.11e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5860166304138  E_coul = 54.04593837154658
  HOMO = -0.848857277063494  LUMO = 0.801687058331803
  mo_energy =
[-3.27711345e+01 -1.92936362e+00 -8.48857277e-01 -8.48857277e-01
 -8.48857277e-01  8.01687058e-01  8.01687058e-01  8.01687058e-01
  1.22270681e+00  3.82488308e+00  3.82488308e+00  3.82488308e+00
  7.63972856e+00  1.36481692e+01  1.36481692e+01  1.36481692e+01
  3.51270259e+01  4.74855107e+01  4.74855107e+01  4.74855107e+01
  1.38288129e+02  1.81349041e+02  1.81349041e+02  1.81349041e+02
  5.01240773e+02  1.86850206e+03  7.99827306e+03  4.77661984e+04]
E1 = -182.58601384272612  E_coul = 54.04593558385884
Extra cycle  E= -128.540078258867  delta_E= -5.68e-14  |g|= 3.78e-07  |ddm|= 2.73e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145458e+03 8.33268097e+02 2.35785706e+02
 7.60705942e+01 9.89610613e+00 2.67713664e+01 3.85828612e-01
 1.14704489e+00 3.07861933e+00 6.72851698e+00 1.99940151e+01
 7.04785399e+01 2.65677391e-01 2.37106969e+00 8.26894890e-01]
grad_E = [-7.99031153e-10  4.11787598e-08 -7.43054820e-07  6.43824454e-06
 -3.04687834e-05 -5.17942629e-04  1.83015631e-04 -3.02753690e-04
  2.08967185e-05  2.93884569e-04  5.53361162e-04  1.98327841e-04
 -1.32485913e-04 -5.01283693e-03 -2.29348563e-03  6.00841236e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941273        1
[INPUT] 0    0    [1    /1   ]  3661.45461431        1
[INPUT] 0    0    [1    /1   ]  833.267095183        1
[INPUT] 0    0    [1    /1   ]  235.80356353         1
[INPUT] 0    0    [1    /1   ]  75.9430744933        1
[INPUT] 0    0    [1    /1   ]  9.90554291213        1
[INPUT] 0    0    [1    /1   ]  26.6349265916        1
[INPUT] 0    0    [1    /1   ]  0.391279608905       1
[INPUT] 0    0    [1    /1   ]  1.16836008093        1
[INPUT] 0    0    [1    /1   ]  3.141414604          1
[INPUT] 1    0    [1    /1   ]  7.06927100915        1
[INPUT] 1    0    [1    /1   ]  21.5225667586        1
[INPUT] 1    0    [1    /1   ]  76.598222919         1
[INPUT] 1    0    [1    /1   ]  0.26788216232        1
[INPUT] 1    0    [1    /1   ]  2.45206923973        1
[INPUT] 1    0    [1    /1   ]  0.840531896883       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412730184, 1.0]], [0, [3661.4546143062676, 1.0]], [0, [833.267095182507, 1.0]], [0, [235.8035635302889, 1.0]], [0, [75.94307449325159, 1.0]], [0, [9.905542912126247, 1.0]], [0, [26.634926591604728, 1.0]], [0, [0.39127960890485697, 1.0]], [0, [1.1683600809283892, 1.0]], [0, [3.141414603998885, 1.0]], [1, [7.0692710091507465, 1.0]], [1, [21.522566758605464, 1.0]], [1, [76.59822291898789, 1.0]], [1, [0.2678821623200321, 1.0]], [1, [2.452069239726969, 1.0]], [1, [0.840531896882733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941273]
bas 1, expnt(s) = [3661.45461431]
bas 2, expnt(s) = [833.26709518]
bas 3, expnt(s) = [235.80356353]
bas 4, expnt(s) = [75.94307449]
bas 5, expnt(s) = [9.90554291]
bas 6, expnt(s) = [26.63492659]
bas 7, expnt(s) = [0.39127961]
bas 8, expnt(s) = [1.16836008]
bas 9, expnt(s) = [3.1414146]
bas 10, expnt(s) = [7.06927101]
bas 11, expnt(s) = [21.52256676]
bas 12, expnt(s) = [76.59822292]
bas 13, expnt(s) = [0.26788216]
bas 14, expnt(s) = [2.45206924]
bas 15, expnt(s) = [0.8405319]
CPU time:       189.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145461e+03 1.18920100e+03
 8.33267095e+02 3.91834975e+02 2.35803564e+02 1.52029476e+02
 7.59430745e+01 6.49951807e+01 9.90554291e+00 1.41066450e+01
 2.66349266e+01 2.96212685e+01 3.91279609e-01 1.24991487e+00
 1.16836008e+00 2.83921027e+00 3.14141460e+00 5.96154694e+00
 7.06927101e+00 3.36281272e+01 2.15225668e+01 1.35239007e+02
 7.65982229e+01 6.61085696e+02 2.67882162e-01 5.62230158e-01
 2.45206924e+00 8.95159251e+00 8.40531897e-01 2.34788673e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99955403508045
cond(S) = 367.9416874696466
E1 = -183.58864712503197  E_coul = 55.08024160937443
init E= -128.508405515658
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775262456032193  LUMO = 0.830789774775928
  mo_energy =
[-3.25550459e+01 -1.85254465e+00 -7.75262456e-01 -7.75262456e-01
 -7.75262456e-01  8.30789775e-01  8.30789775e-01  8.30789775e-01
  1.28402201e+00  3.98101805e+00  3.98101805e+00  3.98101805e+00
  7.90431450e+00  1.43343568e+01  1.43343568e+01  1.43343568e+01
  3.55957189e+01  5.08074046e+01  5.08074046e+01  5.08074046e+01
  1.38504756e+02  1.97439582e+02  1.97439582e+02  1.97439582e+02
  5.01058006e+02  1.86820480e+03  7.99803327e+03  4.77660633e+04]
E1 = -182.08519465953637  E_coul = 53.54829702118329
cycle= 1 E= -128.536897638353  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51949
diis-c [-0.26987001  1.        ]
  HOMO = -0.884070766364731  LUMO = 0.803835980058423
  mo_energy =
[-3.28782814e+01 -1.96646171e+00 -8.84070766e-01 -8.84070766e-01
 -8.84070766e-01  8.03835980e-01  8.03835980e-01  8.03835980e-01
  1.23600051e+00  3.88346485e+00  3.88346485e+00  3.88346485e+00
  7.76717778e+00  1.41451867e+01  1.41451867e+01  1.41451867e+01
  3.53490877e+01  5.05315624e+01  5.05315624e+01  5.05315624e+01
  1.38187399e+02  1.97102455e+02  1.97102455e+02  1.97102455e+02
  5.00696472e+02  1.86780726e+03  7.99760675e+03  4.77656180e+04]
E1 = -182.8461605441622  E_coul = 54.30667433374467
cycle= 2 E= -128.539486210418  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0671
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263539
diis-c [-6.52912930e-04  3.35779803e-01  6.64220197e-01]
  HOMO = -0.848454714179927  LUMO = 0.812648870592182
  mo_energy =
[-3.27701822e+01 -1.92894617e+00 -8.48454714e-01 -8.48454714e-01
 -8.48454714e-01  8.12648871e-01  8.12648871e-01  8.12648871e-01
  1.25144351e+00  3.91512376e+00  3.91512376e+00  3.91512376e+00
  7.81218744e+00  1.42078523e+01  1.42078523e+01  1.42078523e+01
  3.54317054e+01  5.06238760e+01  5.06238760e+01  5.06238760e+01
  1.38293292e+02  1.97213785e+02  1.97213785e+02  1.97213785e+02
  5.00813299e+02  1.86792935e+03  7.99773128e+03  4.77657434e+04]
E1 = -182.58791271289488  E_coul = 54.04750810834375
cycle= 3 E= -128.540404604551  delta_E= -0.000918  |g|= 0.000494  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011804
diis-c [-1.18802348e-07 -2.25918628e-03 -1.60923931e-04  1.00242011e+00]
  HOMO = -0.848705511983083  LUMO = 0.812613168867001
  mo_energy =
[-3.27706452e+01 -1.92914212e+00 -8.48705512e-01 -8.48705512e-01
 -8.48705512e-01  8.12613169e-01  8.12613169e-01  8.12613169e-01
  1.25136581e+00  3.91494951e+00  3.91494951e+00  3.91494951e+00
  7.81196750e+00  1.42075525e+01  1.42075525e+01  1.42075525e+01
  3.54313487e+01  5.06234749e+01  5.06234749e+01  5.06234749e+01
  1.38292827e+02  1.97213276e+02  1.97213276e+02  1.97213276e+02
  5.00812709e+02  1.86792863e+03  7.99773046e+03  4.77657426e+04]
E1 = -182.58844488355876  E_coul = 54.04804025884928
cycle= 4 E= -128.540404624709  delta_E= -2.02e-08  |g|= 7.46e-05  |ddm|= 0.0002
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188043
diis-c [-7.59453835e-10  1.82174516e-04  4.92215286e-04 -1.53645479e-01
  1.15297109e+00]
  HOMO = -0.848744510535087  LUMO = 0.812601420772229
  mo_energy =
[-3.27707162e+01 -1.92917364e+00 -8.48744511e-01 -8.48744511e-01
 -8.48744511e-01  8.12601421e-01  8.12601421e-01  8.12601421e-01
  1.25134791e+00  3.91491279e+00  3.91491279e+00  3.91491279e+00
  7.81192476e+00  1.42074972e+01  1.42074972e+01  1.42074972e+01
  3.54312866e+01  5.06234089e+01  5.06234089e+01  5.06234089e+01
  1.38292756e+02  1.97213203e+02  1.97213203e+02  1.97213203e+02
  5.00812630e+02  1.86792854e+03  7.99773037e+03  4.77657425e+04]
E1 = -182.58858930117023  E_coul = 54.048184675936
cycle= 5 E= -128.540404625234  delta_E= -5.25e-10  |g|= 4.27e-06  |ddm|= 2.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58858930117023  E_coul = 54.048184675936
  HOMO = -0.848742465719253  LUMO = 0.812602031105539
  mo_energy =
[-3.27707117e+01 -1.92917091e+00 -8.48742466e-01 -8.48742466e-01
 -8.48742466e-01  8.12602031e-01  8.12602031e-01  8.12602031e-01
  1.25134933e+00  3.91491477e+00  3.91491477e+00  3.91491477e+00
  7.81192769e+00  1.42075006e+01  1.42075006e+01  1.42075006e+01
  3.54312908e+01  5.06234132e+01  5.06234132e+01  5.06234132e+01
  1.38292760e+02  1.97213207e+02  1.97213207e+02  1.97213207e+02
  5.00812634e+02  1.86792855e+03  7.99773037e+03  4.77657425e+04]
E1 = -182.5885789248516  E_coul = 54.048174299615916
Extra cycle  E= -128.540404625236  delta_E= -1.45e-12  |g|= 1.48e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145461e+03 8.33267095e+02 2.35803564e+02
 7.59430745e+01 9.90554291e+00 2.66349266e+01 3.91279609e-01
 1.16836008e+00 3.14141460e+00 7.06927101e+00 2.15225668e+01
 7.65982229e+01 2.67882162e-01 2.45206924e+00 8.40531897e-01]
E = -128.54040462523568
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941273        1
[INPUT] 0    0    [1    /1   ]  3661.45461431        1
[INPUT] 0    0    [1    /1   ]  833.267095183        1
[INPUT] 0    0    [1    /1   ]  235.80356353         1
[INPUT] 0    0    [1    /1   ]  75.9430744933        1
[INPUT] 0    0    [1    /1   ]  9.90554291213        1
[INPUT] 0    0    [1    /1   ]  26.6349265916        1
[INPUT] 0    0    [1    /1   ]  0.391279608905       1
[INPUT] 0    0    [1    /1   ]  1.16836008093        1
[INPUT] 0    0    [1    /1   ]  3.141414604          1
[INPUT] 1    0    [1    /1   ]  7.06927100915        1
[INPUT] 1    0    [1    /1   ]  21.5225667586        1
[INPUT] 1    0    [1    /1   ]  76.598222919         1
[INPUT] 1    0    [1    /1   ]  0.26788216232        1
[INPUT] 1    0    [1    /1   ]  2.45206923973        1
[INPUT] 1    0    [1    /1   ]  0.840531896883       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412730184, 1.0]], [0, [3661.4546143062676, 1.0]], [0, [833.267095182507, 1.0]], [0, [235.8035635302889, 1.0]], [0, [75.94307449325159, 1.0]], [0, [9.905542912126247, 1.0]], [0, [26.634926591604728, 1.0]], [0, [0.39127960890485697, 1.0]], [0, [1.1683600809283892, 1.0]], [0, [3.141414603998885, 1.0]], [1, [7.0692710091507465, 1.0]], [1, [21.522566758605464, 1.0]], [1, [76.59822291898789, 1.0]], [1, [0.2678821623200321, 1.0]], [1, [2.452069239726969, 1.0]], [1, [0.840531896882733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941273]
bas 1, expnt(s) = [3661.45461431]
bas 2, expnt(s) = [833.26709518]
bas 3, expnt(s) = [235.80356353]
bas 4, expnt(s) = [75.94307449]
bas 5, expnt(s) = [9.90554291]
bas 6, expnt(s) = [26.63492659]
bas 7, expnt(s) = [0.39127961]
bas 8, expnt(s) = [1.16836008]
bas 9, expnt(s) = [3.1414146]
bas 10, expnt(s) = [7.06927101]
bas 11, expnt(s) = [21.52256676]
bas 12, expnt(s) = [76.59822292]
bas 13, expnt(s) = [0.26788216]
bas 14, expnt(s) = [2.45206924]
bas 15, expnt(s) = [0.8405319]
CPU time:       189.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145461e+03 1.18920100e+03
 8.33267095e+02 3.91834975e+02 2.35803564e+02 1.52029476e+02
 7.59430745e+01 6.49951807e+01 9.90554291e+00 1.41066450e+01
 2.66349266e+01 2.96212685e+01 3.91279609e-01 1.24991487e+00
 1.16836008e+00 2.83921027e+00 3.14141460e+00 5.96154694e+00
 7.06927101e+00 3.36281272e+01 2.15225668e+01 1.35239007e+02
 7.65982229e+01 6.61085696e+02 2.67882162e-01 5.62230158e-01
 2.45206924e+00 8.95159251e+00 8.40531897e-01 2.34788673e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99955403508045
cond(S) = 367.9416874696466
E1 = -183.58864712503197  E_coul = 55.08024160937443
init E= -128.508405515658
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775262456032193  LUMO = 0.830789774775928
  mo_energy =
[-3.25550459e+01 -1.85254465e+00 -7.75262456e-01 -7.75262456e-01
 -7.75262456e-01  8.30789775e-01  8.30789775e-01  8.30789775e-01
  1.28402201e+00  3.98101805e+00  3.98101805e+00  3.98101805e+00
  7.90431450e+00  1.43343568e+01  1.43343568e+01  1.43343568e+01
  3.55957189e+01  5.08074046e+01  5.08074046e+01  5.08074046e+01
  1.38504756e+02  1.97439582e+02  1.97439582e+02  1.97439582e+02
  5.01058006e+02  1.86820480e+03  7.99803327e+03  4.77660633e+04]
E1 = -182.08519465953637  E_coul = 53.54829702118329
cycle= 1 E= -128.536897638353  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51949
diis-c [-0.26987001  1.        ]
  HOMO = -0.884070766364731  LUMO = 0.803835980058423
  mo_energy =
[-3.28782814e+01 -1.96646171e+00 -8.84070766e-01 -8.84070766e-01
 -8.84070766e-01  8.03835980e-01  8.03835980e-01  8.03835980e-01
  1.23600051e+00  3.88346485e+00  3.88346485e+00  3.88346485e+00
  7.76717778e+00  1.41451867e+01  1.41451867e+01  1.41451867e+01
  3.53490877e+01  5.05315624e+01  5.05315624e+01  5.05315624e+01
  1.38187399e+02  1.97102455e+02  1.97102455e+02  1.97102455e+02
  5.00696472e+02  1.86780726e+03  7.99760675e+03  4.77656180e+04]
E1 = -182.8461605441622  E_coul = 54.30667433374467
cycle= 2 E= -128.539486210418  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0671
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263539
diis-c [-6.52912930e-04  3.35779803e-01  6.64220197e-01]
  HOMO = -0.848454714179927  LUMO = 0.812648870592182
  mo_energy =
[-3.27701822e+01 -1.92894617e+00 -8.48454714e-01 -8.48454714e-01
 -8.48454714e-01  8.12648871e-01  8.12648871e-01  8.12648871e-01
  1.25144351e+00  3.91512376e+00  3.91512376e+00  3.91512376e+00
  7.81218744e+00  1.42078523e+01  1.42078523e+01  1.42078523e+01
  3.54317054e+01  5.06238760e+01  5.06238760e+01  5.06238760e+01
  1.38293292e+02  1.97213785e+02  1.97213785e+02  1.97213785e+02
  5.00813299e+02  1.86792935e+03  7.99773128e+03  4.77657434e+04]
E1 = -182.58791271289488  E_coul = 54.04750810834375
cycle= 3 E= -128.540404604551  delta_E= -0.000918  |g|= 0.000494  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011804
diis-c [-1.18802348e-07 -2.25918628e-03 -1.60923931e-04  1.00242011e+00]
  HOMO = -0.848705511983083  LUMO = 0.812613168867001
  mo_energy =
[-3.27706452e+01 -1.92914212e+00 -8.48705512e-01 -8.48705512e-01
 -8.48705512e-01  8.12613169e-01  8.12613169e-01  8.12613169e-01
  1.25136581e+00  3.91494951e+00  3.91494951e+00  3.91494951e+00
  7.81196750e+00  1.42075525e+01  1.42075525e+01  1.42075525e+01
  3.54313487e+01  5.06234749e+01  5.06234749e+01  5.06234749e+01
  1.38292827e+02  1.97213276e+02  1.97213276e+02  1.97213276e+02
  5.00812709e+02  1.86792863e+03  7.99773046e+03  4.77657426e+04]
E1 = -182.58844488355876  E_coul = 54.04804025884928
cycle= 4 E= -128.540404624709  delta_E= -2.02e-08  |g|= 7.46e-05  |ddm|= 0.0002
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188043
diis-c [-7.59453835e-10  1.82174516e-04  4.92215286e-04 -1.53645479e-01
  1.15297109e+00]
  HOMO = -0.848744510535087  LUMO = 0.812601420772229
  mo_energy =
[-3.27707162e+01 -1.92917364e+00 -8.48744511e-01 -8.48744511e-01
 -8.48744511e-01  8.12601421e-01  8.12601421e-01  8.12601421e-01
  1.25134791e+00  3.91491279e+00  3.91491279e+00  3.91491279e+00
  7.81192476e+00  1.42074972e+01  1.42074972e+01  1.42074972e+01
  3.54312866e+01  5.06234089e+01  5.06234089e+01  5.06234089e+01
  1.38292756e+02  1.97213203e+02  1.97213203e+02  1.97213203e+02
  5.00812630e+02  1.86792854e+03  7.99773037e+03  4.77657425e+04]
E1 = -182.58858930117023  E_coul = 54.048184675936
cycle= 5 E= -128.540404625234  delta_E= -5.25e-10  |g|= 4.27e-06  |ddm|= 2.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58858930117023  E_coul = 54.048184675936
  HOMO = -0.848742465719253  LUMO = 0.812602031105539
  mo_energy =
[-3.27707117e+01 -1.92917091e+00 -8.48742466e-01 -8.48742466e-01
 -8.48742466e-01  8.12602031e-01  8.12602031e-01  8.12602031e-01
  1.25134933e+00  3.91491477e+00  3.91491477e+00  3.91491477e+00
  7.81192769e+00  1.42075006e+01  1.42075006e+01  1.42075006e+01
  3.54312908e+01  5.06234132e+01  5.06234132e+01  5.06234132e+01
  1.38292760e+02  1.97213207e+02  1.97213207e+02  1.97213207e+02
  5.00812634e+02  1.86792855e+03  7.99773037e+03  4.77657425e+04]
E1 = -182.5885789248516  E_coul = 54.048174299615916
Extra cycle  E= -128.540404625236  delta_E= -1.45e-12  |g|= 1.48e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 367.9416874696466
E1 = -182.5885789248516  E_coul = 54.048174299615916
init E= -128.540404625236
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848743206732879  LUMO = 0.812601860440073
  mo_energy =
[-3.27707140e+01 -1.92917156e+00 -8.48743207e-01 -8.48743207e-01
 -8.48743207e-01  8.12601860e-01  8.12601860e-01  8.12601860e-01
  1.25134910e+00  3.91491413e+00  3.91491413e+00  3.91491413e+00
  7.81192683e+00  1.42074993e+01  1.42074993e+01  1.42074993e+01
  3.54312890e+01  5.06234112e+01  5.06234112e+01  5.06234112e+01
  1.38292758e+02  1.97213204e+02  1.97213204e+02  1.97213204e+02
  5.00812631e+02  1.86792854e+03  7.99773037e+03  4.77657425e+04]
E1 = -182.5885847066459  E_coul = 54.0481800814103
cycle= 1 E= -128.540404625236  delta_E= 8.53e-14  |g|= 7.98e-07  |ddm|= 5.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5885847066459  E_coul = 54.0481800814103
  HOMO = -0.848742801227363  LUMO = 0.812601963300598
  mo_energy =
[-3.27707128e+01 -1.92917111e+00 -8.48742801e-01 -8.48742801e-01
 -8.48742801e-01  8.12601963e-01  8.12601963e-01  8.12601963e-01
  1.25134929e+00  3.91491449e+00  3.91491449e+00  3.91491449e+00
  7.81192735e+00  1.42075000e+01  1.42075000e+01  1.42075000e+01
  3.54312900e+01  5.06234123e+01  5.06234123e+01  5.06234123e+01
  1.38292759e+02  1.97213206e+02  1.97213206e+02  1.97213206e+02
  5.00812632e+02  1.86792854e+03  7.99773037e+03  4.77657425e+04]
E1 = -182.5885818119491  E_coul = 54.04817718671386
Extra cycle  E= -128.540404625235  delta_E= 3.69e-13  |g|= 3.93e-07  |ddm|= 2.87e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145461e+03 8.33267095e+02 2.35803564e+02
 7.59430745e+01 9.90554291e+00 2.66349266e+01 3.91279609e-01
 1.16836008e+00 3.14141460e+00 7.06927101e+00 2.15225668e+01
 7.65982229e+01 2.67882162e-01 2.45206924e+00 8.40531897e-01]
grad_E = [-4.17193475e-10  2.07984664e-08 -3.10081255e-07  5.04867033e-07
  2.16612450e-05 -2.20641483e-04 -3.00116743e-05 -1.18678256e-04
  1.79582304e-04  2.33517917e-04  2.47984755e-04  2.40239344e-04
 -1.06026215e-04 -1.81985981e-03 -7.60763909e-04  1.89175284e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941266        1
[INPUT] 0    0    [1    /1   ]  3661.4546536         1
[INPUT] 0    0    [1    /1   ]  833.266000005        1
[INPUT] 0    0    [1    /1   ]  235.822851981        1
[INPUT] 0    0    [1    /1   ]  75.8050916989        1
[INPUT] 0    0    [1    /1   ]  9.88165025859        1
[INPUT] 0    0    [1    /1   ]  26.5094666171        1
[INPUT] 0    0    [1    /1   ]  0.395255801731       1
[INPUT] 0    0    [1    /1   ]  1.18593683724        1
[INPUT] 0    0    [1    /1   ]  3.21768622512        1
[INPUT] 1    0    [1    /1   ]  7.17875481804        1
[INPUT] 1    0    [1    /1   ]  22.5814071303        1
[INPUT] 1    0    [1    /1   ]  83.1497376591        1
[INPUT] 1    0    [1    /1   ]  0.267427343338       1
[INPUT] 1    0    [1    /1   ]  2.46821400243        1
[INPUT] 1    0    [1    /1   ]  0.840279681439       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794126570887, 1.0]], [0, [3661.4546535968416, 1.0]], [0, [833.2660000047018, 1.0]], [0, [235.8228519805352, 1.0]], [0, [75.80509169888546, 1.0]], [0, [9.881650258586108, 1.0]], [0, [26.509466617146952, 1.0]], [0, [0.3952558017308968, 1.0]], [0, [1.185936837238613, 1.0]], [0, [3.2176862251196017, 1.0]], [1, [7.1787548180363805, 1.0]], [1, [22.581407130315785, 1.0]], [1, [83.1497376591111, 1.0]], [1, [0.2674273433382555, 1.0]], [1, [2.4682140024288857, 1.0]], [1, [0.8402796814390058, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412657]
bas 1, expnt(s) = [3661.4546536]
bas 2, expnt(s) = [833.266]
bas 3, expnt(s) = [235.82285198]
bas 4, expnt(s) = [75.8050917]
bas 5, expnt(s) = [9.88165026]
bas 6, expnt(s) = [26.50946662]
bas 7, expnt(s) = [0.3952558]
bas 8, expnt(s) = [1.18593684]
bas 9, expnt(s) = [3.21768623]
bas 10, expnt(s) = [7.17875482]
bas 11, expnt(s) = [22.58140713]
bas 12, expnt(s) = [83.14973766]
bas 13, expnt(s) = [0.26742734]
bas 14, expnt(s) = [2.468214]
bas 15, expnt(s) = [0.84027968]
CPU time:       192.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145465e+03 1.18920101e+03
 8.33266000e+02 3.91834589e+02 2.35822852e+02 1.52038802e+02
 7.58050917e+01 6.49065921e+01 9.88165026e+00 1.40811179e+01
 2.65094666e+01 2.95165617e+01 3.95255802e-01 1.25942907e+00
 1.18593684e+00 2.87118511e+00 3.21768623e+00 6.06977780e+00
 7.17875482e+00 3.42803931e+01 2.25814071e+01 1.43606185e+02
 8.31497377e+01 7.32504837e+02 2.67427343e-01 5.61037196e-01
 2.46821400e+00 9.02532620e+00 8.40279681e-01 2.34700611e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999549610163662
cond(S) = 377.41386405261875
E1 = -183.5889116043916  E_coul = 55.08022755220851
init E= -128.508684052183
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775317528104995  LUMO = 0.829735237671178
  mo_energy =
[-3.25550434e+01 -1.85253137e+00 -7.75317528e-01 -7.75317528e-01
 -7.75317528e-01  8.29735238e-01  8.29735238e-01  8.29735238e-01
  1.30769875e+00  3.99073017e+00  3.99073017e+00  3.99073017e+00
  8.07127173e+00  1.44809996e+01  1.44809996e+01  1.44809996e+01
  3.58689862e+01  5.24930553e+01  5.24930553e+01  5.24930553e+01
  1.38442513e+02  2.11726271e+02  2.11726271e+02  2.11726271e+02
  5.00548369e+02  1.86754910e+03  7.99741647e+03  4.77655456e+04]
E1 = -182.08669877390525  E_coul = 53.54950424599109
cycle= 1 E= -128.537194527914  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.514761
diis-c [-0.26497843  1.        ]
  HOMO = -0.884037309967351  LUMO = 0.802838870784734
  mo_energy =
[-3.28780237e+01 -1.96636083e+00 -8.84037310e-01 -8.84037310e-01
 -8.84037310e-01  8.02838871e-01  8.02838871e-01  8.02838871e-01
  1.25887771e+00  3.89272211e+00  3.89272211e+00  3.89272211e+00
  7.93275983e+00  1.42902790e+01  1.42902790e+01  1.42902790e+01
  3.56226393e+01  5.22143833e+01  5.22143833e+01  5.22143833e+01
  1.38125604e+02  2.11386400e+02  2.11386400e+02  2.11386400e+02
  5.00187136e+02  1.86715184e+03  7.99699023e+03  4.77651006e+04]
E1 = -182.84719098701314  E_coul = 54.307411540428205
cycle= 2 E= -128.539779446585  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26116
diis-c [-6.55669299e-04  3.35779115e-01  6.64220885e-01]
  HOMO = -0.848443232781087  LUMO = 0.811642308794583
  mo_energy =
[-3.27699940e+01 -1.92886657e+00 -8.48443233e-01 -8.48443233e-01
 -8.48443233e-01  8.11642309e-01  8.11642309e-01  8.11642309e-01
  1.27459609e+00  3.92454194e+00  3.92454194e+00  3.92454194e+00
  7.97823751e+00  1.43534931e+01  1.43534931e+01  1.43534931e+01
  3.57051800e+01  5.23076564e+01  5.23076564e+01  5.23076564e+01
  1.38231367e+02  2.11498447e+02  2.11498447e+02  2.11498447e+02
  5.00303878e+02  1.86727385e+03  7.99711468e+03  4.77652259e+04]
E1 = -182.58915868523673  E_coul = 54.0484621610094
cycle= 3 E= -128.540696524227  delta_E= -0.000917  |g|= 0.000486  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116141
diis-c [-1.16500827e-07 -2.24716119e-03 -1.70179384e-04  1.00241734e+00]
  HOMO = -0.84868956793332  LUMO = 0.811608774329573
  mo_energy =
[-3.27704513e+01 -1.92905728e+00 -8.48689568e-01 -8.48689568e-01
 -8.48689568e-01  8.11608774e-01  8.11608774e-01  8.11608774e-01
  1.27452142e+00  3.92437170e+00  3.92437170e+00  3.92437170e+00
  7.97802068e+00  1.43531971e+01  1.43531971e+01  1.43531971e+01
  3.57048289e+01  5.23072572e+01  5.23072572e+01  5.23072572e+01
  1.38230908e+02  2.11497936e+02  2.11497936e+02  2.11497936e+02
  5.00303293e+02  1.86727313e+03  7.99711386e+03  4.77652251e+04]
E1 = -182.58969416112438  E_coul = 54.04899761748065
cycle= 4 E= -128.540696543644  delta_E= -1.94e-08  |g|= 7.33e-05  |ddm|= 0.000193
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184208
diis-c [-7.70702154e-10  1.86509895e-04  4.88526941e-04 -1.55513876e-01
  1.15483884e+00]
  HOMO = -0.84872764023664  LUMO = 0.811597400536481
  mo_energy =
[-3.27705209e+01 -1.92908765e+00 -8.48727640e-01 -8.48727640e-01
 -8.48727640e-01  8.11597401e-01  8.11597401e-01  8.11597401e-01
  1.27450408e+00  3.92433579e+00  3.92433579e+00  3.92433579e+00
  7.97797879e+00  1.43531429e+01  1.43531429e+01  1.43531429e+01
  3.57047683e+01  5.23071922e+01  5.23071922e+01  5.23071922e+01
  1.38230838e+02  2.11497864e+02  2.11497864e+02  2.11497864e+02
  5.00303215e+02  1.86727305e+03  7.99711377e+03  4.77652250e+04]
E1 = -182.58983773780332  E_coul = 54.04914119364767
cycle= 5 E= -128.540696544156  delta_E= -5.12e-10  |g|= 4.37e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58983773780332  E_coul = 54.04914119364767
  HOMO = -0.848725526948112  LUMO = 0.811598030271466
  mo_energy =
[-3.27705163e+01 -1.92908484e+00 -8.48725527e-01 -8.48725527e-01
 -8.48725527e-01  8.11598030e-01  8.11598030e-01  8.11598030e-01
  1.27450556e+00  3.92433784e+00  3.92433784e+00  3.92433784e+00
  7.97798183e+00  1.43531464e+01  1.43531464e+01  1.43531464e+01
  3.57047725e+01  5.23071967e+01  5.23071967e+01  5.23071967e+01
  1.38230843e+02  2.11497868e+02  2.11497868e+02  2.11497868e+02
  5.00303219e+02  1.86727305e+03  7.99711377e+03  4.77652250e+04]
E1 = -182.58982707146083  E_coul = 54.04913052730355
Extra cycle  E= -128.540696544157  delta_E= -1.65e-12  |g|= 1.52e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145465e+03 8.33266000e+02 2.35822852e+02
 7.58050917e+01 9.88165026e+00 2.65094666e+01 3.95255802e-01
 1.18593684e+00 3.21768623e+00 7.17875482e+00 2.25814071e+01
 8.31497377e+01 2.67427343e-01 2.46821400e+00 8.40279681e-01]
E = -128.5406965441573
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941266        1
[INPUT] 0    0    [1    /1   ]  3661.4546536         1
[INPUT] 0    0    [1    /1   ]  833.266000005        1
[INPUT] 0    0    [1    /1   ]  235.822851981        1
[INPUT] 0    0    [1    /1   ]  75.8050916989        1
[INPUT] 0    0    [1    /1   ]  9.88165025859        1
[INPUT] 0    0    [1    /1   ]  26.5094666171        1
[INPUT] 0    0    [1    /1   ]  0.395255801731       1
[INPUT] 0    0    [1    /1   ]  1.18593683724        1
[INPUT] 0    0    [1    /1   ]  3.21768622512        1
[INPUT] 1    0    [1    /1   ]  7.17875481804        1
[INPUT] 1    0    [1    /1   ]  22.5814071303        1
[INPUT] 1    0    [1    /1   ]  83.1497376591        1
[INPUT] 1    0    [1    /1   ]  0.267427343338       1
[INPUT] 1    0    [1    /1   ]  2.46821400243        1
[INPUT] 1    0    [1    /1   ]  0.840279681439       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794126570887, 1.0]], [0, [3661.4546535968416, 1.0]], [0, [833.2660000047018, 1.0]], [0, [235.8228519805352, 1.0]], [0, [75.80509169888546, 1.0]], [0, [9.881650258586108, 1.0]], [0, [26.509466617146952, 1.0]], [0, [0.3952558017308968, 1.0]], [0, [1.185936837238613, 1.0]], [0, [3.2176862251196017, 1.0]], [1, [7.1787548180363805, 1.0]], [1, [22.581407130315785, 1.0]], [1, [83.1497376591111, 1.0]], [1, [0.2674273433382555, 1.0]], [1, [2.4682140024288857, 1.0]], [1, [0.8402796814390058, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412657]
bas 1, expnt(s) = [3661.4546536]
bas 2, expnt(s) = [833.266]
bas 3, expnt(s) = [235.82285198]
bas 4, expnt(s) = [75.8050917]
bas 5, expnt(s) = [9.88165026]
bas 6, expnt(s) = [26.50946662]
bas 7, expnt(s) = [0.3952558]
bas 8, expnt(s) = [1.18593684]
bas 9, expnt(s) = [3.21768623]
bas 10, expnt(s) = [7.17875482]
bas 11, expnt(s) = [22.58140713]
bas 12, expnt(s) = [83.14973766]
bas 13, expnt(s) = [0.26742734]
bas 14, expnt(s) = [2.468214]
bas 15, expnt(s) = [0.84027968]
CPU time:       193.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145465e+03 1.18920101e+03
 8.33266000e+02 3.91834589e+02 2.35822852e+02 1.52038802e+02
 7.58050917e+01 6.49065921e+01 9.88165026e+00 1.40811179e+01
 2.65094666e+01 2.95165617e+01 3.95255802e-01 1.25942907e+00
 1.18593684e+00 2.87118511e+00 3.21768623e+00 6.06977780e+00
 7.17875482e+00 3.42803931e+01 2.25814071e+01 1.43606185e+02
 8.31497377e+01 7.32504837e+02 2.67427343e-01 5.61037196e-01
 2.46821400e+00 9.02532620e+00 8.40279681e-01 2.34700611e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999549610163662
cond(S) = 377.41386405261875
E1 = -183.5889116043916  E_coul = 55.08022755220851
init E= -128.508684052183
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775317528104995  LUMO = 0.829735237671178
  mo_energy =
[-3.25550434e+01 -1.85253137e+00 -7.75317528e-01 -7.75317528e-01
 -7.75317528e-01  8.29735238e-01  8.29735238e-01  8.29735238e-01
  1.30769875e+00  3.99073017e+00  3.99073017e+00  3.99073017e+00
  8.07127173e+00  1.44809996e+01  1.44809996e+01  1.44809996e+01
  3.58689862e+01  5.24930553e+01  5.24930553e+01  5.24930553e+01
  1.38442513e+02  2.11726271e+02  2.11726271e+02  2.11726271e+02
  5.00548369e+02  1.86754910e+03  7.99741647e+03  4.77655456e+04]
E1 = -182.08669877390525  E_coul = 53.54950424599109
cycle= 1 E= -128.537194527914  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.514761
diis-c [-0.26497843  1.        ]
  HOMO = -0.884037309967351  LUMO = 0.802838870784734
  mo_energy =
[-3.28780237e+01 -1.96636083e+00 -8.84037310e-01 -8.84037310e-01
 -8.84037310e-01  8.02838871e-01  8.02838871e-01  8.02838871e-01
  1.25887771e+00  3.89272211e+00  3.89272211e+00  3.89272211e+00
  7.93275983e+00  1.42902790e+01  1.42902790e+01  1.42902790e+01
  3.56226393e+01  5.22143833e+01  5.22143833e+01  5.22143833e+01
  1.38125604e+02  2.11386400e+02  2.11386400e+02  2.11386400e+02
  5.00187136e+02  1.86715184e+03  7.99699023e+03  4.77651006e+04]
E1 = -182.84719098701314  E_coul = 54.307411540428205
cycle= 2 E= -128.539779446585  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26116
diis-c [-6.55669299e-04  3.35779115e-01  6.64220885e-01]
  HOMO = -0.848443232781087  LUMO = 0.811642308794583
  mo_energy =
[-3.27699940e+01 -1.92886657e+00 -8.48443233e-01 -8.48443233e-01
 -8.48443233e-01  8.11642309e-01  8.11642309e-01  8.11642309e-01
  1.27459609e+00  3.92454194e+00  3.92454194e+00  3.92454194e+00
  7.97823751e+00  1.43534931e+01  1.43534931e+01  1.43534931e+01
  3.57051800e+01  5.23076564e+01  5.23076564e+01  5.23076564e+01
  1.38231367e+02  2.11498447e+02  2.11498447e+02  2.11498447e+02
  5.00303878e+02  1.86727385e+03  7.99711468e+03  4.77652259e+04]
E1 = -182.58915868523673  E_coul = 54.0484621610094
cycle= 3 E= -128.540696524227  delta_E= -0.000917  |g|= 0.000486  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116141
diis-c [-1.16500827e-07 -2.24716119e-03 -1.70179384e-04  1.00241734e+00]
  HOMO = -0.84868956793332  LUMO = 0.811608774329573
  mo_energy =
[-3.27704513e+01 -1.92905728e+00 -8.48689568e-01 -8.48689568e-01
 -8.48689568e-01  8.11608774e-01  8.11608774e-01  8.11608774e-01
  1.27452142e+00  3.92437170e+00  3.92437170e+00  3.92437170e+00
  7.97802068e+00  1.43531971e+01  1.43531971e+01  1.43531971e+01
  3.57048289e+01  5.23072572e+01  5.23072572e+01  5.23072572e+01
  1.38230908e+02  2.11497936e+02  2.11497936e+02  2.11497936e+02
  5.00303293e+02  1.86727313e+03  7.99711386e+03  4.77652251e+04]
E1 = -182.58969416112438  E_coul = 54.04899761748065
cycle= 4 E= -128.540696543644  delta_E= -1.94e-08  |g|= 7.33e-05  |ddm|= 0.000193
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184208
diis-c [-7.70702154e-10  1.86509895e-04  4.88526941e-04 -1.55513876e-01
  1.15483884e+00]
  HOMO = -0.84872764023664  LUMO = 0.811597400536481
  mo_energy =
[-3.27705209e+01 -1.92908765e+00 -8.48727640e-01 -8.48727640e-01
 -8.48727640e-01  8.11597401e-01  8.11597401e-01  8.11597401e-01
  1.27450408e+00  3.92433579e+00  3.92433579e+00  3.92433579e+00
  7.97797879e+00  1.43531429e+01  1.43531429e+01  1.43531429e+01
  3.57047683e+01  5.23071922e+01  5.23071922e+01  5.23071922e+01
  1.38230838e+02  2.11497864e+02  2.11497864e+02  2.11497864e+02
  5.00303215e+02  1.86727305e+03  7.99711377e+03  4.77652250e+04]
E1 = -182.58983773780332  E_coul = 54.04914119364767
cycle= 5 E= -128.540696544156  delta_E= -5.12e-10  |g|= 4.37e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58983773780332  E_coul = 54.04914119364767
  HOMO = -0.848725526948112  LUMO = 0.811598030271466
  mo_energy =
[-3.27705163e+01 -1.92908484e+00 -8.48725527e-01 -8.48725527e-01
 -8.48725527e-01  8.11598030e-01  8.11598030e-01  8.11598030e-01
  1.27450556e+00  3.92433784e+00  3.92433784e+00  3.92433784e+00
  7.97798183e+00  1.43531464e+01  1.43531464e+01  1.43531464e+01
  3.57047725e+01  5.23071967e+01  5.23071967e+01  5.23071967e+01
  1.38230843e+02  2.11497868e+02  2.11497868e+02  2.11497868e+02
  5.00303219e+02  1.86727305e+03  7.99711377e+03  4.77652250e+04]
E1 = -182.58982707146083  E_coul = 54.04913052730355
Extra cycle  E= -128.540696544157  delta_E= -1.65e-12  |g|= 1.52e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 377.41386405261875
E1 = -182.58982707146083  E_coul = 54.04913052730355
init E= -128.540696544157
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848726287819029  LUMO = 0.811597855181143
  mo_energy =
[-3.27705186e+01 -1.92908551e+00 -8.48726288e-01 -8.48726288e-01
 -8.48726288e-01  8.11597855e-01  8.11597855e-01  8.11597855e-01
  1.27450531e+00  3.92433718e+00  3.92433718e+00  3.92433718e+00
  7.97798092e+00  1.43531450e+01  1.43531450e+01  1.43531450e+01
  3.57047707e+01  5.23071946e+01  5.23071946e+01  5.23071946e+01
  1.38230841e+02  2.11497866e+02  2.11497866e+02  2.11497866e+02
  5.00303217e+02  1.86727305e+03  7.99711377e+03  4.77652250e+04]
E1 = -182.5898330176198  E_coul = 54.04913647346263
cycle= 1 E= -128.540696544157  delta_E= 1.14e-13  |g|= 8.2e-07  |ddm|= 5.53e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5898330176198  E_coul = 54.04913647346263
  HOMO = -0.848725870659621  LUMO = 0.811597960923641
  mo_energy =
[-3.27705174e+01 -1.92908505e+00 -8.48725871e-01 -8.48725871e-01
 -8.48725871e-01  8.11597961e-01  8.11597961e-01  8.11597961e-01
  1.27450552e+00  3.92433756e+00  3.92433756e+00  3.92433756e+00
  7.97798147e+00  1.43531458e+01  1.43531458e+01  1.43531458e+01
  3.57047717e+01  5.23071957e+01  5.23071957e+01  5.23071957e+01
  1.38230842e+02  2.11497867e+02  2.11497867e+02  2.11497867e+02
  5.00303218e+02  1.86727305e+03  7.99711377e+03  4.77652250e+04]
E1 = -182.58983004104365  E_coul = 54.049133496886476
Extra cycle  E= -128.540696544157  delta_E=    0  |g|= 4.04e-07  |ddm|= 2.96e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145465e+03 8.33266000e+02 2.35822852e+02
 7.58050917e+01 9.88165026e+00 2.65094666e+01 3.95255802e-01
 1.18593684e+00 3.21768623e+00 7.17875482e+00 2.25814071e+01
 8.31497377e+01 2.67427343e-01 2.46821400e+00 8.40279681e-01]
grad_E = [-3.94871958e-10  1.93113913e-08 -2.51905263e-07 -1.06152780e-06
  4.17995242e-05 -1.69922565e-04 -1.03930667e-04 -9.89436879e-05
  3.13459965e-04  2.39078450e-04 -3.13044949e-04  3.12579069e-04
 -8.19472147e-05  5.81602878e-04  7.44667847e-04 -1.25662362e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941259        1
[INPUT] 0    0    [1    /1   ]  3661.45468768        1
[INPUT] 0    0    [1    /1   ]  833.265059162        1
[INPUT] 0    0    [1    /1   ]  235.839300066        1
[INPUT] 0    0    [1    /1   ]  75.687193892         1
[INPUT] 0    0    [1    /1   ]  9.84101817994        1
[INPUT] 0    0    [1    /1   ]  26.4156510017        1
[INPUT] 0    0    [1    /1   ]  0.397104620138       1
[INPUT] 0    0    [1    /1   ]  1.19583196293        1
[INPUT] 0    0    [1    /1   ]  3.28856667866        1
[INPUT] 1    0    [1    /1   ]  7.08489789693        1
[INPUT] 1    0    [1    /1   ]  22.9668646601        1
[INPUT] 1    0    [1    /1   ]  88.7365397451        1
[INPUT] 1    0    [1    /1   ]  0.265650081161       1
[INPUT] 1    0    [1    /1   ]  2.43770401305        1
[INPUT] 1    0    [1    /1   ]  0.832546274104       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412593651, 1.0]], [0, [3661.4546876816485, 1.0]], [0, [833.2650591618254, 1.0]], [0, [235.83930006648816, 1.0]], [0, [75.68719389204628, 1.0]], [0, [9.84101817994056, 1.0]], [0, [26.415651001693256, 1.0]], [0, [0.3971046201382895, 1.0]], [0, [1.1958319629255316, 1.0]], [0, [3.2885666786597105, 1.0]], [1, [7.084897896932541, 1.0]], [1, [22.966864660075316, 1.0]], [1, [88.73653974514778, 1.0]], [1, [0.26565008116091565, 1.0]], [1, [2.437704013051171, 1.0]], [1, [0.8325462741036126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412594]
bas 1, expnt(s) = [3661.45468768]
bas 2, expnt(s) = [833.26505916]
bas 3, expnt(s) = [235.83930007]
bas 4, expnt(s) = [75.68719389]
bas 5, expnt(s) = [9.84101818]
bas 6, expnt(s) = [26.415651]
bas 7, expnt(s) = [0.39710462]
bas 8, expnt(s) = [1.19583196]
bas 9, expnt(s) = [3.28856668]
bas 10, expnt(s) = [7.0848979]
bas 11, expnt(s) = [22.96686466]
bas 12, expnt(s) = [88.73653975]
bas 13, expnt(s) = [0.26565008]
bas 14, expnt(s) = [2.43770401]
bas 15, expnt(s) = [0.83254627]
CPU time:       196.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145469e+03 1.18920102e+03
 8.33265059e+02 3.91834257e+02 2.35839300e+02 1.52046755e+02
 7.56871939e+01 6.48308667e+01 9.84101818e+00 1.40376707e+01
 2.64156510e+01 2.94381838e+01 3.97104620e-01 1.26384475e+00
 1.19583196e+00 2.88913371e+00 3.28856668e+00 6.16978476e+00
 7.08489790e+00 3.37210732e+01 2.29668647e+01 1.46676835e+02
 8.87365397e+01 7.94534033e+02 2.65650081e-01 5.56380414e-01
 2.43770401e+00 8.88608796e+00 8.32546274e-01 2.32003678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999561930068127
cond(S) = 384.5743278610269
E1 = -183.589147182462  E_coul = 55.08023270012055
init E= -128.508914482341
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775352872214717  LUMO = 0.822203155111069
  mo_energy =
[-3.25550437e+01 -1.85251785e+00 -7.75352872e-01 -7.75352872e-01
 -7.75352872e-01  8.22203155e-01  8.22203155e-01  8.22203155e-01
  1.32095377e+00  3.94948439e+00  3.94948439e+00  3.94948439e+00
  8.19441248e+00  1.42997499e+01  1.42997499e+01  1.42997499e+01
  3.60617081e+01  5.25955061e+01  5.25955061e+01  5.25955061e+01
  1.38344442e+02  2.21685853e+02  2.21685853e+02  2.21685853e+02
  5.00081487e+02  1.86696473e+03  7.99686912e+03  4.77650866e+04]
E1 = -182.0865113340129  E_coul = 53.549126855769046
cycle= 1 E= -128.537384478244  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512236
diis-c [-0.26238566  1.        ]
  HOMO = -0.884104036725489  LUMO = 0.795635032404729
  mo_energy =
[-3.28780800e+01 -1.96638917e+00 -8.84104037e-01 -8.84104037e-01
 -8.84104037e-01  7.95635032e-01  7.95635032e-01  7.95635032e-01
  1.27157256e+00  3.85227931e+00  3.85227931e+00  3.85227931e+00
  8.05468470e+00  1.41098065e+01  1.41098065e+01  1.41098065e+01
  3.58154203e+01  5.23156983e+01  5.23156983e+01  5.23156983e+01
  1.38027638e+02  2.21343590e+02  2.21343590e+02  2.21343590e+02
  4.99720198e+02  1.86656737e+03  7.99644278e+03  4.77646414e+04]
E1 = -182.84737041205244  E_coul = 54.307400874092835
cycle= 2 E= -128.53996953796  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259998
diis-c [-6.56766474e-04  3.35873224e-01  6.64126776e-01]
  HOMO = -0.84849579947591  LUMO = 0.804335374334642
  mo_energy =
[-3.27700227e+01 -1.92887850e+00 -8.48495799e-01 -8.48495799e-01
 -8.48495799e-01  8.04335374e-01  8.04335374e-01  8.04335374e-01
  1.28747681e+00  3.88383435e+00  3.88383435e+00  3.88383435e+00
  8.10057260e+00  1.41727668e+01  1.41727668e+01  1.41727668e+01
  3.58979544e+01  5.24093559e+01  5.24093559e+01  5.24093559e+01
  1.38133377e+02  2.21456255e+02  2.21456255e+02  2.21456255e+02
  4.99836961e+02  1.86668941e+03  7.99656726e+03  4.77647668e+04]
E1 = -182.58917964344656  E_coul = 54.048292124709015
cycle= 3 E= -128.540887518738  delta_E= -0.000918  |g|= 0.000481  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114508
diis-c [-1.15543691e-07 -2.23612804e-03 -1.91843641e-04  1.00242797e+00]
  HOMO = -0.848740199958416  LUMO = 0.804303178391781
  mo_energy =
[-3.27704754e+01 -1.92906713e+00 -8.48740200e-01 -8.48740200e-01
 -8.48740200e-01  8.04303178e-01  8.04303178e-01  8.04303178e-01
  1.28740294e+00  3.88366741e+00  3.88366741e+00  3.88366741e+00
  8.10035646e+00  1.41724748e+01  1.41724748e+01  1.41724748e+01
  3.58976069e+01  5.24089593e+01  5.24089593e+01  5.24089593e+01
  1.38132923e+02  2.21455742e+02  2.21455742e+02  2.21455742e+02
  4.99836381e+02  1.86668870e+03  7.99656645e+03  4.77647660e+04]
E1 = -182.58970912400943  E_coul = 54.04882158624858
cycle= 4 E= -128.540887537761  delta_E= -1.9e-08  |g|= 7.27e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182097
diis-c [-7.70290671e-10  1.86782282e-04  4.87112659e-04 -1.56232192e-01
  1.15555830e+00]
  HOMO = -0.848777962393558  LUMO = 0.80429203141737
  mo_energy =
[-3.27705444e+01 -1.92909718e+00 -8.48777962e-01 -8.48777962e-01
 -8.48777962e-01  8.04292031e-01  8.04292031e-01  8.04292031e-01
  1.28738565e+00  3.88363203e+00  3.88363203e+00  3.88363203e+00
  8.10031468e+00  1.41724212e+01  1.41724212e+01  1.41724212e+01
  3.58975467e+01  5.24088947e+01  5.24088947e+01  5.24088947e+01
  1.38132854e+02  2.21455670e+02  2.21455670e+02  2.21455670e+02
  4.99836304e+02  1.86668862e+03  7.99656636e+03  4.77647659e+04]
E1 = -182.58985187160857  E_coul = 54.04896433334259
cycle= 5 E= -128.540887538266  delta_E= -5.05e-10  |g|= 4.38e-06  |ddm|= 2.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58985187160857  E_coul = 54.04896433334259
  HOMO = -0.848775831444545  LUMO = 0.804292657617665
  mo_energy =
[-3.27705398e+01 -1.92909435e+00 -8.48775831e-01 -8.48775831e-01
 -8.48775831e-01  8.04292658e-01  8.04292658e-01  8.04292658e-01
  1.28738715e+00  3.88363407e+00  3.88363407e+00  3.88363407e+00
  8.10031775e+00  1.41724247e+01  1.41724247e+01  1.41724247e+01
  3.58975509e+01  5.24088992e+01  5.24088992e+01  5.24088992e+01
  1.38132859e+02  2.21455674e+02  2.21455674e+02  2.21455674e+02
  4.99836308e+02  1.86668862e+03  7.99656637e+03  4.77647659e+04]
E1 = -182.58984112317862  E_coul = 54.048953584910905
Extra cycle  E= -128.540887538268  delta_E= -1.73e-12  |g|= 1.53e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145469e+03 8.33265059e+02 2.35839300e+02
 7.56871939e+01 9.84101818e+00 2.64156510e+01 3.97104620e-01
 1.19583196e+00 3.28856668e+00 7.08489790e+00 2.29668647e+01
 8.87365397e+01 2.65650081e-01 2.43770401e+00 8.32546274e-01]
E = -128.54088753826773
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941259        1
[INPUT] 0    0    [1    /1   ]  3661.45468768        1
[INPUT] 0    0    [1    /1   ]  833.265059162        1
[INPUT] 0    0    [1    /1   ]  235.839300066        1
[INPUT] 0    0    [1    /1   ]  75.687193892         1
[INPUT] 0    0    [1    /1   ]  9.84101817994        1
[INPUT] 0    0    [1    /1   ]  26.4156510017        1
[INPUT] 0    0    [1    /1   ]  0.397104620138       1
[INPUT] 0    0    [1    /1   ]  1.19583196293        1
[INPUT] 0    0    [1    /1   ]  3.28856667866        1
[INPUT] 1    0    [1    /1   ]  7.08489789693        1
[INPUT] 1    0    [1    /1   ]  22.9668646601        1
[INPUT] 1    0    [1    /1   ]  88.7365397451        1
[INPUT] 1    0    [1    /1   ]  0.265650081161       1
[INPUT] 1    0    [1    /1   ]  2.43770401305        1
[INPUT] 1    0    [1    /1   ]  0.832546274104       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412593651, 1.0]], [0, [3661.4546876816485, 1.0]], [0, [833.2650591618254, 1.0]], [0, [235.83930006648816, 1.0]], [0, [75.68719389204628, 1.0]], [0, [9.84101817994056, 1.0]], [0, [26.415651001693256, 1.0]], [0, [0.3971046201382895, 1.0]], [0, [1.1958319629255316, 1.0]], [0, [3.2885666786597105, 1.0]], [1, [7.084897896932541, 1.0]], [1, [22.966864660075316, 1.0]], [1, [88.73653974514778, 1.0]], [1, [0.26565008116091565, 1.0]], [1, [2.437704013051171, 1.0]], [1, [0.8325462741036126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412594]
bas 1, expnt(s) = [3661.45468768]
bas 2, expnt(s) = [833.26505916]
bas 3, expnt(s) = [235.83930007]
bas 4, expnt(s) = [75.68719389]
bas 5, expnt(s) = [9.84101818]
bas 6, expnt(s) = [26.415651]
bas 7, expnt(s) = [0.39710462]
bas 8, expnt(s) = [1.19583196]
bas 9, expnt(s) = [3.28856668]
bas 10, expnt(s) = [7.0848979]
bas 11, expnt(s) = [22.96686466]
bas 12, expnt(s) = [88.73653975]
bas 13, expnt(s) = [0.26565008]
bas 14, expnt(s) = [2.43770401]
bas 15, expnt(s) = [0.83254627]
CPU time:       197.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145469e+03 1.18920102e+03
 8.33265059e+02 3.91834257e+02 2.35839300e+02 1.52046755e+02
 7.56871939e+01 6.48308667e+01 9.84101818e+00 1.40376707e+01
 2.64156510e+01 2.94381838e+01 3.97104620e-01 1.26384475e+00
 1.19583196e+00 2.88913371e+00 3.28856668e+00 6.16978476e+00
 7.08489790e+00 3.37210732e+01 2.29668647e+01 1.46676835e+02
 8.87365397e+01 7.94534033e+02 2.65650081e-01 5.56380414e-01
 2.43770401e+00 8.88608796e+00 8.32546274e-01 2.32003678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999561930068127
cond(S) = 384.5743278610269
E1 = -183.589147182462  E_coul = 55.08023270012055
init E= -128.508914482341
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775352872214717  LUMO = 0.822203155111069
  mo_energy =
[-3.25550437e+01 -1.85251785e+00 -7.75352872e-01 -7.75352872e-01
 -7.75352872e-01  8.22203155e-01  8.22203155e-01  8.22203155e-01
  1.32095377e+00  3.94948439e+00  3.94948439e+00  3.94948439e+00
  8.19441248e+00  1.42997499e+01  1.42997499e+01  1.42997499e+01
  3.60617081e+01  5.25955061e+01  5.25955061e+01  5.25955061e+01
  1.38344442e+02  2.21685853e+02  2.21685853e+02  2.21685853e+02
  5.00081487e+02  1.86696473e+03  7.99686912e+03  4.77650866e+04]
E1 = -182.0865113340129  E_coul = 53.549126855769046
cycle= 1 E= -128.537384478244  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512236
diis-c [-0.26238566  1.        ]
  HOMO = -0.884104036725489  LUMO = 0.795635032404729
  mo_energy =
[-3.28780800e+01 -1.96638917e+00 -8.84104037e-01 -8.84104037e-01
 -8.84104037e-01  7.95635032e-01  7.95635032e-01  7.95635032e-01
  1.27157256e+00  3.85227931e+00  3.85227931e+00  3.85227931e+00
  8.05468470e+00  1.41098065e+01  1.41098065e+01  1.41098065e+01
  3.58154203e+01  5.23156983e+01  5.23156983e+01  5.23156983e+01
  1.38027638e+02  2.21343590e+02  2.21343590e+02  2.21343590e+02
  4.99720198e+02  1.86656737e+03  7.99644278e+03  4.77646414e+04]
E1 = -182.84737041205244  E_coul = 54.307400874092835
cycle= 2 E= -128.53996953796  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259998
diis-c [-6.56766474e-04  3.35873224e-01  6.64126776e-01]
  HOMO = -0.84849579947591  LUMO = 0.804335374334642
  mo_energy =
[-3.27700227e+01 -1.92887850e+00 -8.48495799e-01 -8.48495799e-01
 -8.48495799e-01  8.04335374e-01  8.04335374e-01  8.04335374e-01
  1.28747681e+00  3.88383435e+00  3.88383435e+00  3.88383435e+00
  8.10057260e+00  1.41727668e+01  1.41727668e+01  1.41727668e+01
  3.58979544e+01  5.24093559e+01  5.24093559e+01  5.24093559e+01
  1.38133377e+02  2.21456255e+02  2.21456255e+02  2.21456255e+02
  4.99836961e+02  1.86668941e+03  7.99656726e+03  4.77647668e+04]
E1 = -182.58917964344656  E_coul = 54.048292124709015
cycle= 3 E= -128.540887518738  delta_E= -0.000918  |g|= 0.000481  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114508
diis-c [-1.15543691e-07 -2.23612804e-03 -1.91843641e-04  1.00242797e+00]
  HOMO = -0.848740199958416  LUMO = 0.804303178391781
  mo_energy =
[-3.27704754e+01 -1.92906713e+00 -8.48740200e-01 -8.48740200e-01
 -8.48740200e-01  8.04303178e-01  8.04303178e-01  8.04303178e-01
  1.28740294e+00  3.88366741e+00  3.88366741e+00  3.88366741e+00
  8.10035646e+00  1.41724748e+01  1.41724748e+01  1.41724748e+01
  3.58976069e+01  5.24089593e+01  5.24089593e+01  5.24089593e+01
  1.38132923e+02  2.21455742e+02  2.21455742e+02  2.21455742e+02
  4.99836381e+02  1.86668870e+03  7.99656645e+03  4.77647660e+04]
E1 = -182.58970912400943  E_coul = 54.04882158624858
cycle= 4 E= -128.540887537761  delta_E= -1.9e-08  |g|= 7.27e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182097
diis-c [-7.70290671e-10  1.86782282e-04  4.87112659e-04 -1.56232192e-01
  1.15555830e+00]
  HOMO = -0.848777962393558  LUMO = 0.80429203141737
  mo_energy =
[-3.27705444e+01 -1.92909718e+00 -8.48777962e-01 -8.48777962e-01
 -8.48777962e-01  8.04292031e-01  8.04292031e-01  8.04292031e-01
  1.28738565e+00  3.88363203e+00  3.88363203e+00  3.88363203e+00
  8.10031468e+00  1.41724212e+01  1.41724212e+01  1.41724212e+01
  3.58975467e+01  5.24088947e+01  5.24088947e+01  5.24088947e+01
  1.38132854e+02  2.21455670e+02  2.21455670e+02  2.21455670e+02
  4.99836304e+02  1.86668862e+03  7.99656636e+03  4.77647659e+04]
E1 = -182.58985187160857  E_coul = 54.04896433334259
cycle= 5 E= -128.540887538266  delta_E= -5.05e-10  |g|= 4.38e-06  |ddm|= 2.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58985187160857  E_coul = 54.04896433334259
  HOMO = -0.848775831444545  LUMO = 0.804292657617665
  mo_energy =
[-3.27705398e+01 -1.92909435e+00 -8.48775831e-01 -8.48775831e-01
 -8.48775831e-01  8.04292658e-01  8.04292658e-01  8.04292658e-01
  1.28738715e+00  3.88363407e+00  3.88363407e+00  3.88363407e+00
  8.10031775e+00  1.41724247e+01  1.41724247e+01  1.41724247e+01
  3.58975509e+01  5.24088992e+01  5.24088992e+01  5.24088992e+01
  1.38132859e+02  2.21455674e+02  2.21455674e+02  2.21455674e+02
  4.99836308e+02  1.86668862e+03  7.99656637e+03  4.77647659e+04]
E1 = -182.58984112317862  E_coul = 54.048953584910905
Extra cycle  E= -128.540887538268  delta_E= -1.73e-12  |g|= 1.53e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 384.5743278610269
E1 = -182.58984112317862  E_coul = 54.048953584910905
init E= -128.540887538268
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848776597729753  LUMO = 0.804292483397409
  mo_energy =
[-3.27705422e+01 -1.92909503e+00 -8.48776598e-01 -8.48776598e-01
 -8.48776598e-01  8.04292483e-01  8.04292483e-01  8.04292483e-01
  1.28738690e+00  3.88363342e+00  3.88363342e+00  3.88363342e+00
  8.10031684e+00  1.41724233e+01  1.41724233e+01  1.41724233e+01
  3.58975492e+01  5.24088971e+01  5.24088971e+01  5.24088971e+01
  1.38132856e+02  2.21455671e+02  2.21455671e+02  2.21455671e+02
  4.99836306e+02  1.86668862e+03  7.99656636e+03  4.77647659e+04]
E1 = -182.58984711450375  E_coul = 54.04895957623603
cycle= 1 E= -128.540887538268  delta_E=    0  |g|= 8.26e-07  |ddm|= 5.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58984711450375  E_coul = 54.04895957623603
  HOMO = -0.848776177270796  LUMO = 0.804292588682405
  mo_energy =
[-3.27705409e+01 -1.92909456e+00 -8.48776177e-01 -8.48776177e-01
 -8.48776177e-01  8.04292589e-01  8.04292589e-01  8.04292589e-01
  1.28738710e+00  3.88363379e+00  3.88363379e+00  3.88363379e+00
  8.10031739e+00  1.41724241e+01  1.41724241e+01  1.41724241e+01
  3.58975501e+01  5.24088982e+01  5.24088982e+01  5.24088982e+01
  1.38132858e+02  2.21455673e+02  2.21455673e+02  2.21455673e+02
  4.99836307e+02  1.86668862e+03  7.99656636e+03  4.77647659e+04]
E1 = -182.589844114128  E_coul = 54.04895657586008
Extra cycle  E= -128.540887538268  delta_E= -1.99e-13  |g|= 4.07e-07  |ddm|= 2.99e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145469e+03 8.33265059e+02 2.35839300e+02
 7.56871939e+01 9.84101818e+00 2.64156510e+01 3.97104620e-01
 1.19583196e+00 3.28856668e+00 7.08489790e+00 2.29668647e+01
 8.87365397e+01 2.65650081e-01 2.43770401e+00 8.32546274e-01]
grad_E = [-5.95286702e-10  2.95839282e-08 -4.32747880e-07  3.27200675e-07
  3.83463296e-05 -2.59627278e-04 -8.14511503e-05 -5.84503279e-05
  2.92214434e-04  2.93151399e-04 -1.16302560e-03  4.10496944e-04
 -6.21993177e-05  1.23459429e-03  2.17203976e-03 -2.56898363e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45470382        1
[INPUT] 0    0    [1    /1   ]  833.264615363        1
[INPUT] 0    0    [1    /1   ]  235.847039999        1
[INPUT] 0    0    [1    /1   ]  75.6315869169        1
[INPUT] 0    0    [1    /1   ]  9.8168027975         1
[INPUT] 0    0    [1    /1   ]  26.3750403047        1
[INPUT] 0    0    [1    /1   ]  0.397305480103       1
[INPUT] 0    0    [1    /1   ]  1.19796590144        1
[INPUT] 0    0    [1    /1   ]  3.32362830371        1
[INPUT] 1    0    [1    /1   ]  7.01659140882        1
[INPUT] 1    0    [1    /1   ]  22.9197144645        1
[INPUT] 1    0    [1    /1   ]  91.3828545334        1
[INPUT] 1    0    [1    /1   ]  0.264733205066       1
[INPUT] 1    0    [1    /1   ]  2.42303126927        1
[INPUT] 1    0    [1    /1   ]  0.829508615985       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412563616, 1.0]], [0, [3661.454703819707, 1.0]], [0, [833.2646153629757, 1.0]], [0, [235.84703999943153, 1.0]], [0, [75.63158691692047, 1.0]], [0, [9.816802797497537, 1.0]], [0, [26.375040304720287, 1.0]], [0, [0.3973054801027957, 1.0]], [0, [1.1979659014417003, 1.0]], [0, [3.3236283037072853, 1.0]], [1, [7.01659140881923, 1.0]], [1, [22.91971446454514, 1.0]], [1, [91.38285453341608, 1.0]], [1, [0.2647332050659686, 1.0]], [1, [2.423031269265525, 1.0]], [1, [0.829508615985415, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412564]
bas 1, expnt(s) = [3661.45470382]
bas 2, expnt(s) = [833.26461536]
bas 3, expnt(s) = [235.84704]
bas 4, expnt(s) = [75.63158692]
bas 5, expnt(s) = [9.8168028]
bas 6, expnt(s) = [26.3750403]
bas 7, expnt(s) = [0.39730548]
bas 8, expnt(s) = [1.1979659]
bas 9, expnt(s) = [3.3236283]
bas 10, expnt(s) = [7.01659141]
bas 11, expnt(s) = [22.91971446]
bas 12, expnt(s) = [91.38285453]
bas 13, expnt(s) = [0.26473321]
bas 14, expnt(s) = [2.42303127]
bas 15, expnt(s) = [0.82950862]
CPU time:       200.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264615e+02 3.91834101e+02 2.35847040e+02 1.52050498e+02
 7.56315869e+01 6.47951402e+01 9.81680280e+00 1.40117563e+01
 2.63750403e+01 2.94042342e+01 3.97305480e-01 1.26432417e+00
 1.19796590e+00 2.89299955e+00 3.32362830e+00 6.21905447e+00
 7.01659141e+00 3.33151771e+01 2.29197145e+01 1.46300529e+02
 9.13828545e+01 8.24262027e+02 2.64733205e-01 5.53981057e-01
 2.42303127e+00 8.81928071e+00 8.29508616e-01 2.30946040e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999568080257825
cond(S) = 387.4647259894568
E1 = -183.5892665165966  E_coul = 55.08023589193534
init E= -128.509030624661
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77536890937456  LUMO = 0.818566054227462
  mo_energy =
[-3.25550424e+01 -1.85251259e+00 -7.75368909e-01 -7.75368909e-01
 -7.75368909e-01  8.18566054e-01  8.18566054e-01  8.18566054e-01
  1.32390286e+00  3.93049972e+00  3.93049972e+00  3.93049972e+00
  8.24236118e+00  1.41948092e+01  1.41948092e+01  1.41948092e+01
  3.61363828e+01  5.22955669e+01  5.22955669e+01  5.22955669e+01
  1.38282333e+02  2.25651382e+02  2.25651382e+02  2.25651382e+02
  4.99849815e+02  1.86668002e+03  7.99660323e+03  4.77648638e+04]
E1 = -182.0860744051823  E_coul = 53.548606393095795
cycle= 1 E= -128.537468012086  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.511691
diis-c [-0.26182734  1.        ]
  HOMO = -0.884166052149547  LUMO = 0.792133636091891
  mo_energy =
[-3.28781512e+01 -1.96643548e+00 -8.84166052e-01 -8.84166052e-01
 -8.84166052e-01  7.92133636e-01  7.92133636e-01  7.92133636e-01
  1.27433086e+00  3.83367653e+00  3.83367653e+00  3.83367653e+00
  8.10207029e+00  1.40054926e+01  1.40054926e+01  1.40054926e+01
  3.58900699e+01  5.20157470e+01  5.20157470e+01  5.20157470e+01
  1.37965523e+02  2.25308025e+02  2.25308025e+02  2.25308025e+02
  4.99488441e+02  1.86628255e+03  7.99617677e+03  4.77644185e+04]
E1 = -182.8472765200317  E_coul = 54.30722265050158
cycle= 2 E= -128.54005386953  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259796
diis-c [-6.56692417e-04  3.35936255e-01  6.64063745e-01]
  HOMO = -0.848543927478277  LUMO = 0.80078897756228
  mo_energy =
[-3.27700604e+01 -1.92890977e+00 -8.48543927e-01 -8.48543927e-01
 -8.48543927e-01  8.00788978e-01  8.00788978e-01  8.00788978e-01
  1.29029414e+00  3.86510149e+00  3.86510149e+00  3.86510149e+00
  8.14814640e+00  1.40682398e+01  1.40682398e+01  1.40682398e+01
  3.59726155e+01  5.21094125e+01  5.21094125e+01  5.21094125e+01
  1.38071272e+02  2.25420974e+02  2.25420974e+02  2.25420974e+02
  4.99605235e+02  1.86640463e+03  7.99630129e+03  4.77645439e+04]
E1 = -182.58892526882806  E_coul = 54.047952512949465
cycle= 3 E= -128.540972755879  delta_E= -0.000919  |g|= 0.00048  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114142
diis-c [-1.16006166e-07 -2.23534890e-03 -2.01481101e-04  1.00243683e+00]
  HOMO = -0.848788552151879  LUMO = 0.800756867610271
  mo_energy =
[-3.27705123e+01 -1.92909882e+00 -8.48788552e-01 -8.48788552e-01
 -8.48788552e-01  8.00756868e-01  8.00756868e-01  8.00756868e-01
  1.29021967e+00  3.86493489e+00  3.86493489e+00  3.86493489e+00
  8.14792939e+00  1.40679485e+01  1.40679485e+01  1.40679485e+01
  3.59722683e+01  5.21090164e+01  5.21090164e+01  5.21090164e+01
  1.38070819e+02  2.25420460e+02  2.25420460e+02  2.25420460e+02
  4.99604657e+02  1.86640392e+03  7.99630048e+03  4.77645431e+04]
E1 = -182.58945126401102  E_coul = 54.048478489146675
cycle= 4 E= -128.540972774864  delta_E= -1.9e-08  |g|= 7.27e-05  |ddm|= 0.000189
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181889
diis-c [-7.63637700e-10  1.85093733e-04  4.86748114e-04 -1.55837923e-01
  1.15516608e+00]
  HOMO = -0.848826390683929  LUMO = 0.800745735095744
  mo_energy =
[-3.27705814e+01 -1.92912902e+00 -8.48826391e-01 -8.48826391e-01
 -8.48826391e-01  8.00745735e-01  8.00745735e-01  8.00745735e-01
  1.29020222e+00  3.86489951e+00  3.86489951e+00  3.86489951e+00
  8.14788737e+00  1.40678949e+01  1.40678949e+01  1.40678949e+01
  3.59722080e+01  5.21089518e+01  5.21089518e+01  5.21089518e+01
  1.38070750e+02  2.25420387e+02  2.25420387e+02  2.25420387e+02
  4.99604580e+02  1.86640383e+03  7.99630039e+03  4.77645430e+04]
E1 = -182.58959389437936  E_coul = 54.04862111901069
cycle= 5 E= -128.540972775369  delta_E= -5.04e-10  |g|= 4.34e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58959389437936  E_coul = 54.04862111901069
  HOMO = -0.848824271910922  LUMO = 0.800746353644489
  mo_energy =
[-3.27705768e+01 -1.92912622e+00 -8.48824272e-01 -8.48824272e-01
 -8.48824272e-01  8.00746354e-01  8.00746354e-01  8.00746354e-01
  1.29020371e+00  3.86490154e+00  3.86490154e+00  3.86490154e+00
  8.14789044e+00  1.40678984e+01  1.40678984e+01  1.40678984e+01
  3.59722122e+01  5.21089562e+01  5.21089562e+01  5.21089562e+01
  1.38070754e+02  2.25420391e+02  2.25420391e+02  2.25420391e+02
  4.99604584e+02  1.86640383e+03  7.99630040e+03  4.77645430e+04]
E1 = -182.58958318491528  E_coul = 54.04861040954534
Extra cycle  E= -128.54097277537  delta_E= -1.25e-12  |g|= 1.52e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264615e+02 2.35847040e+02
 7.56315869e+01 9.81680280e+00 2.63750403e+01 3.97305480e-01
 1.19796590e+00 3.32362830e+00 7.01659141e+00 2.29197145e+01
 9.13828545e+01 2.64733205e-01 2.42303127e+00 8.29508616e-01]
E = -128.54097277536994
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45470382        1
[INPUT] 0    0    [1    /1   ]  833.264615363        1
[INPUT] 0    0    [1    /1   ]  235.847039999        1
[INPUT] 0    0    [1    /1   ]  75.6315869169        1
[INPUT] 0    0    [1    /1   ]  9.8168027975         1
[INPUT] 0    0    [1    /1   ]  26.3750403047        1
[INPUT] 0    0    [1    /1   ]  0.397305480103       1
[INPUT] 0    0    [1    /1   ]  1.19796590144        1
[INPUT] 0    0    [1    /1   ]  3.32362830371        1
[INPUT] 1    0    [1    /1   ]  7.01659140882        1
[INPUT] 1    0    [1    /1   ]  22.9197144645        1
[INPUT] 1    0    [1    /1   ]  91.3828545334        1
[INPUT] 1    0    [1    /1   ]  0.264733205066       1
[INPUT] 1    0    [1    /1   ]  2.42303126927        1
[INPUT] 1    0    [1    /1   ]  0.829508615985       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412563616, 1.0]], [0, [3661.454703819707, 1.0]], [0, [833.2646153629757, 1.0]], [0, [235.84703999943153, 1.0]], [0, [75.63158691692047, 1.0]], [0, [9.816802797497537, 1.0]], [0, [26.375040304720287, 1.0]], [0, [0.3973054801027957, 1.0]], [0, [1.1979659014417003, 1.0]], [0, [3.3236283037072853, 1.0]], [1, [7.01659140881923, 1.0]], [1, [22.91971446454514, 1.0]], [1, [91.38285453341608, 1.0]], [1, [0.2647332050659686, 1.0]], [1, [2.423031269265525, 1.0]], [1, [0.829508615985415, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412564]
bas 1, expnt(s) = [3661.45470382]
bas 2, expnt(s) = [833.26461536]
bas 3, expnt(s) = [235.84704]
bas 4, expnt(s) = [75.63158692]
bas 5, expnt(s) = [9.8168028]
bas 6, expnt(s) = [26.3750403]
bas 7, expnt(s) = [0.39730548]
bas 8, expnt(s) = [1.1979659]
bas 9, expnt(s) = [3.3236283]
bas 10, expnt(s) = [7.01659141]
bas 11, expnt(s) = [22.91971446]
bas 12, expnt(s) = [91.38285453]
bas 13, expnt(s) = [0.26473321]
bas 14, expnt(s) = [2.42303127]
bas 15, expnt(s) = [0.82950862]
CPU time:       201.54
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264615e+02 3.91834101e+02 2.35847040e+02 1.52050498e+02
 7.56315869e+01 6.47951402e+01 9.81680280e+00 1.40117563e+01
 2.63750403e+01 2.94042342e+01 3.97305480e-01 1.26432417e+00
 1.19796590e+00 2.89299955e+00 3.32362830e+00 6.21905447e+00
 7.01659141e+00 3.33151771e+01 2.29197145e+01 1.46300529e+02
 9.13828545e+01 8.24262027e+02 2.64733205e-01 5.53981057e-01
 2.42303127e+00 8.81928071e+00 8.29508616e-01 2.30946040e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999568080257825
cond(S) = 387.4647259894568
E1 = -183.5892665165966  E_coul = 55.08023589193534
init E= -128.509030624661
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77536890937456  LUMO = 0.818566054227462
  mo_energy =
[-3.25550424e+01 -1.85251259e+00 -7.75368909e-01 -7.75368909e-01
 -7.75368909e-01  8.18566054e-01  8.18566054e-01  8.18566054e-01
  1.32390286e+00  3.93049972e+00  3.93049972e+00  3.93049972e+00
  8.24236118e+00  1.41948092e+01  1.41948092e+01  1.41948092e+01
  3.61363828e+01  5.22955669e+01  5.22955669e+01  5.22955669e+01
  1.38282333e+02  2.25651382e+02  2.25651382e+02  2.25651382e+02
  4.99849815e+02  1.86668002e+03  7.99660323e+03  4.77648638e+04]
E1 = -182.0860744051823  E_coul = 53.548606393095795
cycle= 1 E= -128.537468012086  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.511691
diis-c [-0.26182734  1.        ]
  HOMO = -0.884166052149547  LUMO = 0.792133636091891
  mo_energy =
[-3.28781512e+01 -1.96643548e+00 -8.84166052e-01 -8.84166052e-01
 -8.84166052e-01  7.92133636e-01  7.92133636e-01  7.92133636e-01
  1.27433086e+00  3.83367653e+00  3.83367653e+00  3.83367653e+00
  8.10207029e+00  1.40054926e+01  1.40054926e+01  1.40054926e+01
  3.58900699e+01  5.20157470e+01  5.20157470e+01  5.20157470e+01
  1.37965523e+02  2.25308025e+02  2.25308025e+02  2.25308025e+02
  4.99488441e+02  1.86628255e+03  7.99617677e+03  4.77644185e+04]
E1 = -182.8472765200317  E_coul = 54.30722265050158
cycle= 2 E= -128.54005386953  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259796
diis-c [-6.56692417e-04  3.35936255e-01  6.64063745e-01]
  HOMO = -0.848543927478277  LUMO = 0.80078897756228
  mo_energy =
[-3.27700604e+01 -1.92890977e+00 -8.48543927e-01 -8.48543927e-01
 -8.48543927e-01  8.00788978e-01  8.00788978e-01  8.00788978e-01
  1.29029414e+00  3.86510149e+00  3.86510149e+00  3.86510149e+00
  8.14814640e+00  1.40682398e+01  1.40682398e+01  1.40682398e+01
  3.59726155e+01  5.21094125e+01  5.21094125e+01  5.21094125e+01
  1.38071272e+02  2.25420974e+02  2.25420974e+02  2.25420974e+02
  4.99605235e+02  1.86640463e+03  7.99630129e+03  4.77645439e+04]
E1 = -182.58892526882806  E_coul = 54.047952512949465
cycle= 3 E= -128.540972755879  delta_E= -0.000919  |g|= 0.00048  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114142
diis-c [-1.16006166e-07 -2.23534890e-03 -2.01481101e-04  1.00243683e+00]
  HOMO = -0.848788552151879  LUMO = 0.800756867610271
  mo_energy =
[-3.27705123e+01 -1.92909882e+00 -8.48788552e-01 -8.48788552e-01
 -8.48788552e-01  8.00756868e-01  8.00756868e-01  8.00756868e-01
  1.29021967e+00  3.86493489e+00  3.86493489e+00  3.86493489e+00
  8.14792939e+00  1.40679485e+01  1.40679485e+01  1.40679485e+01
  3.59722683e+01  5.21090164e+01  5.21090164e+01  5.21090164e+01
  1.38070819e+02  2.25420460e+02  2.25420460e+02  2.25420460e+02
  4.99604657e+02  1.86640392e+03  7.99630048e+03  4.77645431e+04]
E1 = -182.58945126401102  E_coul = 54.048478489146675
cycle= 4 E= -128.540972774864  delta_E= -1.9e-08  |g|= 7.27e-05  |ddm|= 0.000189
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181889
diis-c [-7.63637700e-10  1.85093733e-04  4.86748114e-04 -1.55837923e-01
  1.15516608e+00]
  HOMO = -0.848826390683929  LUMO = 0.800745735095744
  mo_energy =
[-3.27705814e+01 -1.92912902e+00 -8.48826391e-01 -8.48826391e-01
 -8.48826391e-01  8.00745735e-01  8.00745735e-01  8.00745735e-01
  1.29020222e+00  3.86489951e+00  3.86489951e+00  3.86489951e+00
  8.14788737e+00  1.40678949e+01  1.40678949e+01  1.40678949e+01
  3.59722080e+01  5.21089518e+01  5.21089518e+01  5.21089518e+01
  1.38070750e+02  2.25420387e+02  2.25420387e+02  2.25420387e+02
  4.99604580e+02  1.86640383e+03  7.99630039e+03  4.77645430e+04]
E1 = -182.58959389437936  E_coul = 54.04862111901069
cycle= 5 E= -128.540972775369  delta_E= -5.04e-10  |g|= 4.34e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58959389437936  E_coul = 54.04862111901069
  HOMO = -0.848824271910922  LUMO = 0.800746353644489
  mo_energy =
[-3.27705768e+01 -1.92912622e+00 -8.48824272e-01 -8.48824272e-01
 -8.48824272e-01  8.00746354e-01  8.00746354e-01  8.00746354e-01
  1.29020371e+00  3.86490154e+00  3.86490154e+00  3.86490154e+00
  8.14789044e+00  1.40678984e+01  1.40678984e+01  1.40678984e+01
  3.59722122e+01  5.21089562e+01  5.21089562e+01  5.21089562e+01
  1.38070754e+02  2.25420391e+02  2.25420391e+02  2.25420391e+02
  4.99604584e+02  1.86640383e+03  7.99630040e+03  4.77645430e+04]
E1 = -182.58958318491528  E_coul = 54.04861040954534
Extra cycle  E= -128.54097277537  delta_E= -1.25e-12  |g|= 1.52e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 387.4647259894568
E1 = -182.58958318491528  E_coul = 54.04861040954534
init E= -128.54097277537
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.848825035446521  LUMO = 0.800746180939337
  mo_energy =
[-3.27705792e+01 -1.92912690e+00 -8.48825035e-01 -8.48825035e-01
 -8.48825035e-01  8.00746181e-01  8.00746181e-01  8.00746181e-01
  1.29020346e+00  3.86490089e+00  3.86490089e+00  3.86490089e+00
  8.14788952e+00  1.40678970e+01  1.40678970e+01  1.40678970e+01
  3.59722104e+01  5.21089542e+01  5.21089542e+01  5.21089542e+01
  1.38070752e+02  2.25420389e+02  2.25420389e+02  2.25420389e+02
  4.99604581e+02  1.86640383e+03  7.99630039e+03  4.77645430e+04]
E1 = -182.58958915231833  E_coul = 54.04861637694832
cycle= 1 E= -128.54097277537  delta_E= -5.68e-14  |g|= 8.22e-07  |ddm|= 5.5e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58958915231833  E_coul = 54.04861637694832
  HOMO = -0.848824616629104  LUMO = 0.800746285228633
  mo_energy =
[-3.27705779e+01 -1.92912643e+00 -8.48824617e-01 -8.48824617e-01
 -8.48824617e-01  8.00746285e-01  8.00746285e-01  8.00746285e-01
  1.29020366e+00  3.86490126e+00  3.86490126e+00  3.86490126e+00
  8.14789007e+00  1.40678978e+01  1.40678978e+01  1.40678978e+01
  3.59722114e+01  5.21089553e+01  5.21089553e+01  5.21089553e+01
  1.38070753e+02  2.25420390e+02  2.25420390e+02  2.25420390e+02
  4.99604582e+02  1.86640383e+03  7.99630039e+03  4.77645430e+04]
E1 = -182.58958616277963  E_coul = 54.048613387409354
Extra cycle  E= -128.54097277537  delta_E= -2.84e-13  |g|= 4.06e-07  |ddm|= 2.98e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264615e+02 2.35847040e+02
 7.56315869e+01 9.81680280e+00 2.63750403e+01 3.97305480e-01
 1.19796590e+00 3.32362830e+00 7.01659141e+00 2.29197145e+01
 9.13828545e+01 2.64733205e-01 2.42303127e+00 8.29508616e-01]
grad_E = [-7.42345241e-10  3.71980624e-08 -5.73157098e-07  1.63701413e-06
  3.17616489e-05 -3.26654325e-04 -5.12251830e-05  9.16174769e-05
  1.53333885e-04  3.39655053e-04 -1.42670970e-03  3.97042295e-04
 -4.77721154e-05  5.10733613e-04  2.70222195e-03 -2.64760902e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941253        1
[INPUT] 0    0    [1    /1   ]  3661.45472046        1
[INPUT] 0    0    [1    /1   ]  833.264154069        1
[INPUT] 0    0    [1    /1   ]  235.855147103        1
[INPUT] 0    0    [1    /1   ]  75.5731682631        1
[INPUT] 0    0    [1    /1   ]  9.79504982715        1
[INPUT] 0    0    [1    /1   ]  26.3305872775        1
[INPUT] 0    0    [1    /1   ]  0.39746484807        1
[INPUT] 0    0    [1    /1   ]  1.19996050209        1
[INPUT] 0    0    [1    /1   ]  3.35993901147        1
[INPUT] 1    0    [1    /1   ]  6.93978564663        1
[INPUT] 1    0    [1    /1   ]  22.6324039452        1
[INPUT] 1    0    [1    /1   ]  94.2226502371        1
[INPUT] 1    0    [1    /1   ]  0.264080208404       1
[INPUT] 1    0    [1    /1   ]  2.40699684331        1
[INPUT] 1    0    [1    /1   ]  0.826136196568       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125326825, 1.0]], [0, [3661.4547204554055, 1.0]], [0, [833.2641540686844, 1.0]], [0, [235.85514710284224, 1.0]], [0, [75.57316826307643, 1.0]], [0, [9.795049827153916, 1.0]], [0, [26.33058727754767, 1.0]], [0, [0.39746484807039273, 1.0]], [0, [1.19996050208644, 1.0]], [0, [3.35993901146789, 1.0]], [1, [6.939785646627782, 1.0]], [1, [22.63240394523421, 1.0]], [1, [94.22265023709589, 1.0]], [1, [0.26408020840438207, 1.0]], [1, [2.4069968433123603, 1.0]], [1, [0.8261361965677678, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412533]
bas 1, expnt(s) = [3661.45472046]
bas 2, expnt(s) = [833.26415407]
bas 3, expnt(s) = [235.8551471]
bas 4, expnt(s) = [75.57316826]
bas 5, expnt(s) = [9.79504983]
bas 6, expnt(s) = [26.33058728]
bas 7, expnt(s) = [0.39746485]
bas 8, expnt(s) = [1.1999605]
bas 9, expnt(s) = [3.35993901]
bas 10, expnt(s) = [6.93978565]
bas 11, expnt(s) = [22.63240395]
bas 12, expnt(s) = [94.22265024]
bas 13, expnt(s) = [0.26408021]
bas 14, expnt(s) = [2.40699684]
bas 15, expnt(s) = [0.8261362]
CPU time:       204.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264154e+02 3.91833938e+02 2.35855147e+02 1.52054418e+02
 7.55731683e+01 6.47576002e+01 9.79504983e+00 1.39884634e+01
 2.63305873e+01 2.93670575e+01 3.97464848e-01 1.26470451e+00
 1.19996050e+00 2.89661141e+00 3.35993901e+00 6.26994267e+00
 6.93978565e+00 3.28599549e+01 2.26324039e+01 1.44011691e+02
 9.42226502e+01 8.56403704e+02 2.64080208e-01 5.52273507e-01
 2.40699684e+00 8.74638909e+00 8.26136197e-01 2.29772980e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999574450274434
cond(S) = 390.61266623192887
E1 = -183.5894204498078  E_coul = 55.08024808767066
init E= -128.509172362137
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775387835242557  LUMO = 0.81555602295736
  mo_energy =
[-3.25550383e+01 -1.85250696e+00 -7.75387835e-01 -7.75387835e-01
 -7.75387835e-01  8.15556023e-01  8.15556023e-01  8.15556023e-01
  1.32667046e+00  3.90994274e+00  3.90994274e+00  3.90994274e+00
  8.29123750e+00  1.40798203e+01  1.40798203e+01  1.40798203e+01
  3.62169400e+01  5.16723145e+01  5.16723145e+01  5.16723145e+01
  1.38222748e+02  2.29180935e+02  2.29180935e+02  2.29180935e+02
  4.99611069e+02  1.86638477e+03  7.99632725e+03  4.77646325e+04]
E1 = -182.08616313676217  E_coul = 53.548589407821474
cycle= 1 E= -128.537573728941  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.511721
diis-c [-0.2618586  1.       ]
  HOMO = -0.88419521955838  LUMO = 0.789257380357052
  mo_energy =
[-3.28781222e+01 -1.96643872e+00 -8.84195220e-01 -8.84195220e-01
 -8.84195220e-01  7.89257380e-01  7.89257380e-01  7.89257380e-01
  1.27693722e+00  3.81362431e+00  3.81362431e+00  3.81362431e+00
  8.15041851e+00  1.38913436e+01  1.38913436e+01  1.38913436e+01
  3.59706460e+01  5.13931292e+01  5.13931292e+01  5.13931292e+01
  1.37906017e+02  2.28836582e+02  2.28836582e+02  2.28836582e+02
  4.99249701e+02  1.86598726e+03  7.99590074e+03  4.77641871e+04]
E1 = -182.84751217045698  E_coul = 54.307352552588156
cycle= 2 E= -128.540159617869  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259858
diis-c [-6.5576316e-04  3.3597802e-01  6.6402198e-01]
  HOMO = -0.848567457519424  LUMO = 0.797868462956324
  mo_energy =
[-3.27700215e+01 -1.92890685e+00 -8.48567458e-01 -8.48567458e-01
 -8.48567458e-01  7.97868463e-01  7.97868463e-01  7.97868463e-01
  1.29295394e+00  3.84488407e+00  3.84488407e+00  3.84488407e+00
  8.19667816e+00  1.39538073e+01  1.39538073e+01  1.39538073e+01
  3.60531874e+01  5.14865915e+01  5.14865915e+01  5.14865915e+01
  1.38011752e+02  2.28949787e+02  2.28949787e+02  2.28949787e+02
  4.99366500e+02  1.86610935e+03  7.99602527e+03  4.77643125e+04]
E1 = -182.58909753574818  E_coul = 54.048018708690925
cycle= 3 E= -128.541078827057  delta_E= -0.000919  |g|= 0.000478  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113729
diis-c [-1.17546231e-07 -2.23299010e-03 -2.16609885e-04  1.00244960e+00]
  HOMO = -0.848811116330378  LUMO = 0.797836686458342
  mo_energy =
[-3.27704710e+01 -1.92909479e+00 -8.48811116e-01 -8.48811116e-01
 -8.48811116e-01  7.97836686e-01  7.97836686e-01  7.97836686e-01
  1.29287968e+00  3.84471902e+00  3.84471902e+00  3.84471902e+00
  8.19646199e+00  1.39535185e+01  1.39535185e+01  1.39535185e+01
  3.60528420e+01  5.14861981e+01  5.14861981e+01  5.14861981e+01
  1.38011301e+02  2.28949272e+02  2.28949272e+02  2.28949272e+02
  4.99365924e+02  1.86610864e+03  7.99602446e+03  4.77643117e+04]
E1 = -182.58961699671642  E_coul = 54.04853815076143
cycle= 4 E= -128.541078845955  delta_E= -1.89e-08  |g|= 7.29e-05  |ddm|= 0.000187
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182473
diis-c [-7.62244148e-10  1.83666180e-04  4.89404042e-04 -1.55804188e-01
  1.15513112e+00]
  HOMO = -0.848849046892154  LUMO = 0.797825563694495
  mo_energy =
[-3.27705404e+01 -1.92912510e+00 -8.48849047e-01 -8.48849047e-01
 -8.48849047e-01  7.97825564e-01  7.97825564e-01  7.97825564e-01
  1.29286212e+00  3.84468368e+00  3.84468368e+00  3.84468368e+00
  8.19641976e+00  1.39534648e+01  1.39534648e+01  1.39534648e+01
  3.60527815e+01  5.14861333e+01  5.14861333e+01  5.14861333e+01
  1.38011232e+02  2.28949198e+02  2.28949198e+02  2.28949198e+02
  4.99365846e+02  1.86610856e+03  7.99602437e+03  4.77643116e+04]
E1 = -182.5897599185394  E_coul = 54.04868107207794
cycle= 5 E= -128.541078846461  delta_E= -5.06e-10  |g|= 4.32e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5897599185394  E_coul = 54.04868107207794
  HOMO = -0.848846935583176  LUMO = 0.797826176794869
  mo_energy =
[-3.27705358e+01 -1.92912231e+00 -8.48846936e-01 -8.48846936e-01
 -8.48846936e-01  7.97826177e-01  7.97826177e-01  7.97826177e-01
  1.29286361e+00  3.84468569e+00  3.84468569e+00  3.84468569e+00
  8.19642283e+00  1.39534683e+01  1.39534683e+01  1.39534683e+01
  3.60527858e+01  5.14861377e+01  5.14861377e+01  5.14861377e+01
  1.38011236e+02  2.28949203e+02  2.28949203e+02  2.28949203e+02
  4.99365850e+02  1.86610856e+03  7.99602437e+03  4.77643116e+04]
E1 = -182.5897492286071  E_coul = 54.048670382144266
Extra cycle  E= -128.541078846463  delta_E= -1.36e-12  |g|= 1.52e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264154e+02 2.35855147e+02
 7.55731683e+01 9.79504983e+00 2.63305873e+01 3.97464848e-01
 1.19996050e+00 3.35993901e+00 6.93978565e+00 2.26324039e+01
 9.42226502e+01 2.64080208e-01 2.40699684e+00 8.26136197e-01]
E = -128.54107884646282
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941253        1
[INPUT] 0    0    [1    /1   ]  3661.45472046        1
[INPUT] 0    0    [1    /1   ]  833.264154069        1
[INPUT] 0    0    [1    /1   ]  235.855147103        1
[INPUT] 0    0    [1    /1   ]  75.5731682631        1
[INPUT] 0    0    [1    /1   ]  9.79504982715        1
[INPUT] 0    0    [1    /1   ]  26.3305872775        1
[INPUT] 0    0    [1    /1   ]  0.39746484807        1
[INPUT] 0    0    [1    /1   ]  1.19996050209        1
[INPUT] 0    0    [1    /1   ]  3.35993901147        1
[INPUT] 1    0    [1    /1   ]  6.93978564663        1
[INPUT] 1    0    [1    /1   ]  22.6324039452        1
[INPUT] 1    0    [1    /1   ]  94.2226502371        1
[INPUT] 1    0    [1    /1   ]  0.264080208404       1
[INPUT] 1    0    [1    /1   ]  2.40699684331        1
[INPUT] 1    0    [1    /1   ]  0.826136196568       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125326825, 1.0]], [0, [3661.4547204554055, 1.0]], [0, [833.2641540686844, 1.0]], [0, [235.85514710284224, 1.0]], [0, [75.57316826307643, 1.0]], [0, [9.795049827153916, 1.0]], [0, [26.33058727754767, 1.0]], [0, [0.39746484807039273, 1.0]], [0, [1.19996050208644, 1.0]], [0, [3.35993901146789, 1.0]], [1, [6.939785646627782, 1.0]], [1, [22.63240394523421, 1.0]], [1, [94.22265023709589, 1.0]], [1, [0.26408020840438207, 1.0]], [1, [2.4069968433123603, 1.0]], [1, [0.8261361965677678, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412533]
bas 1, expnt(s) = [3661.45472046]
bas 2, expnt(s) = [833.26415407]
bas 3, expnt(s) = [235.8551471]
bas 4, expnt(s) = [75.57316826]
bas 5, expnt(s) = [9.79504983]
bas 6, expnt(s) = [26.33058728]
bas 7, expnt(s) = [0.39746485]
bas 8, expnt(s) = [1.1999605]
bas 9, expnt(s) = [3.35993901]
bas 10, expnt(s) = [6.93978565]
bas 11, expnt(s) = [22.63240395]
bas 12, expnt(s) = [94.22265024]
bas 13, expnt(s) = [0.26408021]
bas 14, expnt(s) = [2.40699684]
bas 15, expnt(s) = [0.8261362]
CPU time:       205.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264154e+02 3.91833938e+02 2.35855147e+02 1.52054418e+02
 7.55731683e+01 6.47576002e+01 9.79504983e+00 1.39884634e+01
 2.63305873e+01 2.93670575e+01 3.97464848e-01 1.26470451e+00
 1.19996050e+00 2.89661141e+00 3.35993901e+00 6.26994267e+00
 6.93978565e+00 3.28599549e+01 2.26324039e+01 1.44011691e+02
 9.42226502e+01 8.56403704e+02 2.64080208e-01 5.52273507e-01
 2.40699684e+00 8.74638909e+00 8.26136197e-01 2.29772980e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999574450274434
cond(S) = 390.61266623192887
E1 = -183.5894204498078  E_coul = 55.08024808767066
init E= -128.509172362137
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775387835242557  LUMO = 0.81555602295736
  mo_energy =
[-3.25550383e+01 -1.85250696e+00 -7.75387835e-01 -7.75387835e-01
 -7.75387835e-01  8.15556023e-01  8.15556023e-01  8.15556023e-01
  1.32667046e+00  3.90994274e+00  3.90994274e+00  3.90994274e+00
  8.29123750e+00  1.40798203e+01  1.40798203e+01  1.40798203e+01
  3.62169400e+01  5.16723145e+01  5.16723145e+01  5.16723145e+01
  1.38222748e+02  2.29180935e+02  2.29180935e+02  2.29180935e+02
  4.99611069e+02  1.86638477e+03  7.99632725e+03  4.77646325e+04]
E1 = -182.08616313676217  E_coul = 53.548589407821474
cycle= 1 E= -128.537573728941  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.511721
diis-c [-0.2618586  1.       ]
  HOMO = -0.88419521955838  LUMO = 0.789257380357052
  mo_energy =
[-3.28781222e+01 -1.96643872e+00 -8.84195220e-01 -8.84195220e-01
 -8.84195220e-01  7.89257380e-01  7.89257380e-01  7.89257380e-01
  1.27693722e+00  3.81362431e+00  3.81362431e+00  3.81362431e+00
  8.15041851e+00  1.38913436e+01  1.38913436e+01  1.38913436e+01
  3.59706460e+01  5.13931292e+01  5.13931292e+01  5.13931292e+01
  1.37906017e+02  2.28836582e+02  2.28836582e+02  2.28836582e+02
  4.99249701e+02  1.86598726e+03  7.99590074e+03  4.77641871e+04]
E1 = -182.84751217045698  E_coul = 54.307352552588156
cycle= 2 E= -128.540159617869  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259858
diis-c [-6.5576316e-04  3.3597802e-01  6.6402198e-01]
  HOMO = -0.848567457519424  LUMO = 0.797868462956324
  mo_energy =
[-3.27700215e+01 -1.92890685e+00 -8.48567458e-01 -8.48567458e-01
 -8.48567458e-01  7.97868463e-01  7.97868463e-01  7.97868463e-01
  1.29295394e+00  3.84488407e+00  3.84488407e+00  3.84488407e+00
  8.19667816e+00  1.39538073e+01  1.39538073e+01  1.39538073e+01
  3.60531874e+01  5.14865915e+01  5.14865915e+01  5.14865915e+01
  1.38011752e+02  2.28949787e+02  2.28949787e+02  2.28949787e+02
  4.99366500e+02  1.86610935e+03  7.99602527e+03  4.77643125e+04]
E1 = -182.58909753574818  E_coul = 54.048018708690925
cycle= 3 E= -128.541078827057  delta_E= -0.000919  |g|= 0.000478  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113729
diis-c [-1.17546231e-07 -2.23299010e-03 -2.16609885e-04  1.00244960e+00]
  HOMO = -0.848811116330378  LUMO = 0.797836686458342
  mo_energy =
[-3.27704710e+01 -1.92909479e+00 -8.48811116e-01 -8.48811116e-01
 -8.48811116e-01  7.97836686e-01  7.97836686e-01  7.97836686e-01
  1.29287968e+00  3.84471902e+00  3.84471902e+00  3.84471902e+00
  8.19646199e+00  1.39535185e+01  1.39535185e+01  1.39535185e+01
  3.60528420e+01  5.14861981e+01  5.14861981e+01  5.14861981e+01
  1.38011301e+02  2.28949272e+02  2.28949272e+02  2.28949272e+02
  4.99365924e+02  1.86610864e+03  7.99602446e+03  4.77643117e+04]
E1 = -182.58961699671642  E_coul = 54.04853815076143
cycle= 4 E= -128.541078845955  delta_E= -1.89e-08  |g|= 7.29e-05  |ddm|= 0.000187
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182473
diis-c [-7.62244148e-10  1.83666180e-04  4.89404042e-04 -1.55804188e-01
  1.15513112e+00]
  HOMO = -0.848849046892154  LUMO = 0.797825563694495
  mo_energy =
[-3.27705404e+01 -1.92912510e+00 -8.48849047e-01 -8.48849047e-01
 -8.48849047e-01  7.97825564e-01  7.97825564e-01  7.97825564e-01
  1.29286212e+00  3.84468368e+00  3.84468368e+00  3.84468368e+00
  8.19641976e+00  1.39534648e+01  1.39534648e+01  1.39534648e+01
  3.60527815e+01  5.14861333e+01  5.14861333e+01  5.14861333e+01
  1.38011232e+02  2.28949198e+02  2.28949198e+02  2.28949198e+02
  4.99365846e+02  1.86610856e+03  7.99602437e+03  4.77643116e+04]
E1 = -182.5897599185394  E_coul = 54.04868107207794
cycle= 5 E= -128.541078846461  delta_E= -5.06e-10  |g|= 4.32e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5897599185394  E_coul = 54.04868107207794
  HOMO = -0.848846935583176  LUMO = 0.797826176794869
  mo_energy =
[-3.27705358e+01 -1.92912231e+00 -8.48846936e-01 -8.48846936e-01
 -8.48846936e-01  7.97826177e-01  7.97826177e-01  7.97826177e-01
  1.29286361e+00  3.84468569e+00  3.84468569e+00  3.84468569e+00
  8.19642283e+00  1.39534683e+01  1.39534683e+01  1.39534683e+01
  3.60527858e+01  5.14861377e+01  5.14861377e+01  5.14861377e+01
  1.38011236e+02  2.28949203e+02  2.28949203e+02  2.28949203e+02
  4.99365850e+02  1.86610856e+03  7.99602437e+03  4.77643116e+04]
E1 = -182.5897492286071  E_coul = 54.048670382144266
Extra cycle  E= -128.541078846463  delta_E= -1.36e-12  |g|= 1.52e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 390.61266623192887
E1 = -182.5897492286071  E_coul = 54.048670382144266
init E= -128.541078846463
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.848847697738568  LUMO = 0.797826005309971
  mo_energy =
[-3.27705382e+01 -1.92912299e+00 -8.48847698e-01 -8.48847698e-01
 -8.48847698e-01  7.97826005e-01  7.97826005e-01  7.97826005e-01
  1.29286335e+00  3.84468505e+00  3.84468505e+00  3.84468505e+00
  8.19642191e+00  1.39534669e+01  1.39534669e+01  1.39534669e+01
  3.60527840e+01  5.14861357e+01  5.14861357e+01  5.14861357e+01
  1.38011234e+02  2.28949200e+02  2.28949200e+02  2.28949200e+02
  4.99365848e+02  1.86610856e+03  7.99602437e+03  4.77643116e+04]
E1 = -182.58975518398964  E_coul = 54.04867633752662
cycle= 1 E= -128.541078846463  delta_E= -1.99e-13  |g|= 8.21e-07  |ddm|= 5.47e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58975518398964  E_coul = 54.04867633752662
  HOMO = -0.84884727973712  LUMO = 0.79782610885503
  mo_energy =
[-3.27705369e+01 -1.92912252e+00 -8.48847280e-01 -8.48847280e-01
 -8.48847280e-01  7.97826109e-01  7.97826109e-01  7.97826109e-01
  1.29286356e+00  3.84468542e+00  3.84468542e+00  3.84468542e+00
  8.19642246e+00  1.39534677e+01  1.39534677e+01  1.39534677e+01
  3.60527850e+01  5.14861368e+01  5.14861368e+01  5.14861368e+01
  1.38011235e+02  2.28949202e+02  2.28949202e+02  2.28949202e+02
  4.99365849e+02  1.86610856e+03  7.99602437e+03  4.77643116e+04]
E1 = -182.5897521999969  E_coul = 54.048673353533715
Extra cycle  E= -128.541078846463  delta_E= -1.42e-13  |g|= 4.05e-07  |ddm|= 2.97e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264154e+02 2.35855147e+02
 7.55731683e+01 9.79504983e+00 2.63305873e+01 3.97464848e-01
 1.19996050e+00 3.35993901e+00 6.93978565e+00 2.26324039e+01
 9.42226502e+01 2.64080208e-01 2.40699684e+00 8.26136197e-01]
grad_E = [-8.58443542e-10  4.31795148e-08 -6.80192298e-07  2.53019617e-06
  2.86526827e-05 -3.67325647e-04 -3.60121764e-05  2.96726377e-04
 -3.32285137e-05  3.85216331e-04 -1.14389503e-03  2.41715672e-04
 -2.32355230e-05  2.08462662e-04  2.39222790e-03 -2.17175573e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941253        1
[INPUT] 0    0    [1    /1   ]  3661.45472459        1
[INPUT] 0    0    [1    /1   ]  833.264028836        1
[INPUT] 0    0    [1    /1   ]  235.857508182        1
[INPUT] 0    0    [1    /1   ]  75.5559744077        1
[INPUT] 0    0    [1    /1   ]  9.80392792295        1
[INPUT] 0    0    [1    /1   ]  26.3083746549        1
[INPUT] 0    0    [1    /1   ]  0.397807605084       1
[INPUT] 0    0    [1    /1   ]  1.20203714195        1
[INPUT] 0    0    [1    /1   ]  3.36769391455        1
[INPUT] 1    0    [1    /1   ]  6.91091833578        1
[INPUT] 1    0    [1    /1   ]  22.3746669883        1
[INPUT] 1    0    [1    /1   ]  95.1710426475        1
[INPUT] 1    0    [1    /1   ]  0.263075081643       1
[INPUT] 1    0    [1    /1   ]  2.39325743263        1
[INPUT] 1    0    [1    /1   ]  0.821390655875       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125250595, 1.0]], [0, [3661.454724586947, 1.0]], [0, [833.2640288355759, 1.0]], [0, [235.85750818181242, 1.0]], [0, [75.5559744076795, 1.0]], [0, [9.803927922950795, 1.0]], [0, [26.308374654933946, 1.0]], [0, [0.3978076050844357, 1.0]], [0, [1.202037141950179, 1.0]], [0, [3.367693914554798, 1.0]], [1, [6.910918335781639, 1.0]], [1, [22.374666988347823, 1.0]], [1, [95.17104264751359, 1.0]], [1, [0.26307508164264753, 1.0]], [1, [2.3932574326268017, 1.0]], [1, [0.8213906558751668, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412525]
bas 1, expnt(s) = [3661.45472459]
bas 2, expnt(s) = [833.26402884]
bas 3, expnt(s) = [235.85750818]
bas 4, expnt(s) = [75.55597441]
bas 5, expnt(s) = [9.80392792]
bas 6, expnt(s) = [26.30837465]
bas 7, expnt(s) = [0.39780761]
bas 8, expnt(s) = [1.20203714]
bas 9, expnt(s) = [3.36769391]
bas 10, expnt(s) = [6.91091834]
bas 11, expnt(s) = [22.37466699]
bas 12, expnt(s) = [95.17104265]
bas 13, expnt(s) = [0.26307508]
bas 14, expnt(s) = [2.39325743]
bas 15, expnt(s) = [0.82139066]
CPU time:       208.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264029e+02 3.91833894e+02 2.35857508e+02 1.52055560e+02
 7.55559744e+01 6.47465500e+01 9.80392792e+00 1.39979716e+01
 2.63083747e+01 2.93484749e+01 3.97807605e-01 1.26552240e+00
 1.20203714e+00 2.90037024e+00 3.36769391e+00 6.28079304e+00
 6.91091834e+00 3.26891851e+01 2.23746670e+01 1.41964618e+02
 9.51710426e+01 8.67192327e+02 2.63075082e-01 5.49647219e-01
 2.39325743e+00 8.68402696e+00 8.21390656e-01 2.28124321e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999582976318646
cond(S) = 392.00998263499247
E1 = -183.58942022023436  E_coul = 55.08024208072919
init E= -128.509178139505
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775396392530102  LUMO = 0.811343848366003
  mo_energy =
[-3.25550414e+01 -1.85250582e+00 -7.75396393e-01 -7.75396393e-01
 -7.75396393e-01  8.11343848e-01  8.11343848e-01  8.11343848e-01
  1.32909415e+00  3.88549060e+00  3.88549060e+00  3.88549060e+00
  8.31020100e+00  1.40019188e+01  1.40019188e+01  1.40019188e+01
  3.62613077e+01  5.12155997e+01  5.12155997e+01  5.12155997e+01
  1.38233957e+02  2.29816572e+02  2.29816572e+02  2.29816572e+02
  4.99561760e+02  1.86631434e+03  7.99626005e+03  4.77645759e+04]
E1 = -182.0856786208871  E_coul = 53.548062092184885
cycle= 1 E= -128.537616528702  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512241
diis-c [-0.2623912  1.       ]
  HOMO = -0.884250367237657  LUMO = 0.785209596401787
  mo_energy =
[-3.28781931e+01 -1.96648960e+00 -8.84250367e-01 -8.84250367e-01
 -8.84250367e-01  7.85209596e-01  7.85209596e-01  7.85209596e-01
  1.27923301e+00  3.78960861e+00  3.78960861e+00  3.78960861e+00
  8.16915279e+00  1.38137823e+01  1.38137823e+01  1.38137823e+01
  3.60148913e+01  5.09369019e+01  5.09369019e+01  5.09369019e+01
  1.37917166e+02  2.29471846e+02  2.29471846e+02  2.29471846e+02
  4.99200314e+02  1.86591673e+03  7.99583342e+03  4.77641304e+04]
E1 = -182.84745323133268  E_coul = 54.307249110198406
cycle= 2 E= -128.540204121134  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260178
diis-c [-6.55299320e-04  3.36028416e-01  6.63971584e-01]
  HOMO = -0.84860413519219  LUMO = 0.7937638739568
  mo_energy =
[-3.27700459e+01 -1.92893758e+00 -8.48604135e-01 -8.48604135e-01
 -8.48604135e-01  7.93763874e-01  7.93763874e-01  7.93763874e-01
  1.29528910e+00  3.82072626e+00  3.82072626e+00  3.82072626e+00
  8.21549653e+00  1.38761347e+01  1.38761347e+01  1.38761347e+01
  3.60974788e+01  5.10302138e+01  5.10302138e+01  5.10302138e+01
  1.38022939e+02  2.29585175e+02  2.29585175e+02  2.29585175e+02
  4.99317160e+02  1.86603886e+03  7.99595799e+03  4.77642559e+04]
E1 = -182.58885930276628  E_coul = 54.04773494919965
cycle= 3 E= -128.541124353567  delta_E= -0.00092  |g|= 0.000478  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113527
diis-c [-1.18615554e-07 -2.23498986e-03 -2.34918507e-04  1.00246991e+00]
  HOMO = -0.848847999583124  LUMO = 0.793731911530189
  mo_energy =
[-3.27704954e+01 -1.92912605e+00 -8.48848000e-01 -8.48848000e-01
 -8.48848000e-01  7.93731912e-01  7.93731912e-01  7.93731912e-01
  1.29521386e+00  3.82056150e+00  3.82056150e+00  3.82056150e+00
  8.21528008e+00  1.38758462e+01  1.38758462e+01  1.38758462e+01
  3.60971335e+01  5.10298211e+01  5.10298211e+01  5.10298211e+01
  1.38022488e+02  2.29584658e+02  2.29584658e+02  2.29584658e+02
  4.99316582e+02  1.86603815e+03  7.99595718e+03  4.77642551e+04]
E1 = -182.5893716194402  E_coul = 54.04824724688125
cycle= 4 E= -128.541124372559  delta_E= -1.9e-08  |g|= 7.33e-05  |ddm|= 0.000188
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183089
diis-c [-7.53506778e-10  1.80021671e-04  4.91270077e-04 -1.54493574e-01
  1.15382228e+00]
  HOMO = -0.84888620549766  LUMO = 0.793720727260804
  mo_energy =
[-3.27705652e+01 -1.92915679e+00 -8.48886205e-01 -8.48886205e-01
 -8.48886205e-01  7.93720727e-01  7.93720727e-01  7.93720727e-01
  1.29519594e+00  3.82052597e+00  3.82052597e+00  3.82052597e+00
  8.21523743e+00  1.38757922e+01  1.38757922e+01  1.38757922e+01
  3.60970726e+01  5.10297560e+01  5.10297560e+01  5.10297560e+01
  1.38022418e+02  2.29584585e+02  2.29584585e+02  2.29584585e+02
  4.99316505e+02  1.86603807e+03  7.99595709e+03  4.77642550e+04]
E1 = -182.58951453004306  E_coul = 54.0483901569761
cycle= 5 E= -128.541124373067  delta_E= -5.08e-10  |g|= 4.24e-06  |ddm|= 2.7e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58951453004306  E_coul = 54.0483901569761
  HOMO = -0.848884142215846  LUMO = 0.793721322049772
  mo_energy =
[-3.27705606e+01 -1.92915406e+00 -8.48884142e-01 -8.48884142e-01
 -8.48884142e-01  7.93721322e-01  7.93721322e-01  7.93721322e-01
  1.29519740e+00  3.82052793e+00  3.82052793e+00  3.82052793e+00
  8.21524043e+00  1.38757956e+01  1.38757956e+01  1.38757956e+01
  3.60970768e+01  5.10297603e+01  5.10297603e+01  5.10297603e+01
  1.38022423e+02  2.29584589e+02  2.29584589e+02  2.29584589e+02
  4.99316509e+02  1.86603807e+03  7.99595710e+03  4.77642550e+04]
E1 = -182.58950401663375  E_coul = 54.04837964356495
Extra cycle  E= -128.541124373069  delta_E= -1.85e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264029e+02 2.35857508e+02
 7.55559744e+01 9.80392792e+00 2.63083747e+01 3.97807605e-01
 1.20203714e+00 3.36769391e+00 6.91091834e+00 2.23746670e+01
 9.51710426e+01 2.63075082e-01 2.39325743e+00 8.21390656e-01]
E = -128.5411243730688
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941253        1
[INPUT] 0    0    [1    /1   ]  3661.45472459        1
[INPUT] 0    0    [1    /1   ]  833.264028836        1
[INPUT] 0    0    [1    /1   ]  235.857508182        1
[INPUT] 0    0    [1    /1   ]  75.5559744077        1
[INPUT] 0    0    [1    /1   ]  9.80392792295        1
[INPUT] 0    0    [1    /1   ]  26.3083746549        1
[INPUT] 0    0    [1    /1   ]  0.397807605084       1
[INPUT] 0    0    [1    /1   ]  1.20203714195        1
[INPUT] 0    0    [1    /1   ]  3.36769391455        1
[INPUT] 1    0    [1    /1   ]  6.91091833578        1
[INPUT] 1    0    [1    /1   ]  22.3746669883        1
[INPUT] 1    0    [1    /1   ]  95.1710426475        1
[INPUT] 1    0    [1    /1   ]  0.263075081643       1
[INPUT] 1    0    [1    /1   ]  2.39325743263        1
[INPUT] 1    0    [1    /1   ]  0.821390655875       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125250595, 1.0]], [0, [3661.454724586947, 1.0]], [0, [833.2640288355759, 1.0]], [0, [235.85750818181242, 1.0]], [0, [75.5559744076795, 1.0]], [0, [9.803927922950795, 1.0]], [0, [26.308374654933946, 1.0]], [0, [0.3978076050844357, 1.0]], [0, [1.202037141950179, 1.0]], [0, [3.367693914554798, 1.0]], [1, [6.910918335781639, 1.0]], [1, [22.374666988347823, 1.0]], [1, [95.17104264751359, 1.0]], [1, [0.26307508164264753, 1.0]], [1, [2.3932574326268017, 1.0]], [1, [0.8213906558751668, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412525]
bas 1, expnt(s) = [3661.45472459]
bas 2, expnt(s) = [833.26402884]
bas 3, expnt(s) = [235.85750818]
bas 4, expnt(s) = [75.55597441]
bas 5, expnt(s) = [9.80392792]
bas 6, expnt(s) = [26.30837465]
bas 7, expnt(s) = [0.39780761]
bas 8, expnt(s) = [1.20203714]
bas 9, expnt(s) = [3.36769391]
bas 10, expnt(s) = [6.91091834]
bas 11, expnt(s) = [22.37466699]
bas 12, expnt(s) = [95.17104265]
bas 13, expnt(s) = [0.26307508]
bas 14, expnt(s) = [2.39325743]
bas 15, expnt(s) = [0.82139066]
CPU time:       209.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264029e+02 3.91833894e+02 2.35857508e+02 1.52055560e+02
 7.55559744e+01 6.47465500e+01 9.80392792e+00 1.39979716e+01
 2.63083747e+01 2.93484749e+01 3.97807605e-01 1.26552240e+00
 1.20203714e+00 2.90037024e+00 3.36769391e+00 6.28079304e+00
 6.91091834e+00 3.26891851e+01 2.23746670e+01 1.41964618e+02
 9.51710426e+01 8.67192327e+02 2.63075082e-01 5.49647219e-01
 2.39325743e+00 8.68402696e+00 8.21390656e-01 2.28124321e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999582976318646
cond(S) = 392.00998263499247
E1 = -183.58942022023436  E_coul = 55.08024208072919
init E= -128.509178139505
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775396392530102  LUMO = 0.811343848366003
  mo_energy =
[-3.25550414e+01 -1.85250582e+00 -7.75396393e-01 -7.75396393e-01
 -7.75396393e-01  8.11343848e-01  8.11343848e-01  8.11343848e-01
  1.32909415e+00  3.88549060e+00  3.88549060e+00  3.88549060e+00
  8.31020100e+00  1.40019188e+01  1.40019188e+01  1.40019188e+01
  3.62613077e+01  5.12155997e+01  5.12155997e+01  5.12155997e+01
  1.38233957e+02  2.29816572e+02  2.29816572e+02  2.29816572e+02
  4.99561760e+02  1.86631434e+03  7.99626005e+03  4.77645759e+04]
E1 = -182.0856786208871  E_coul = 53.548062092184885
cycle= 1 E= -128.537616528702  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512241
diis-c [-0.2623912  1.       ]
  HOMO = -0.884250367237657  LUMO = 0.785209596401787
  mo_energy =
[-3.28781931e+01 -1.96648960e+00 -8.84250367e-01 -8.84250367e-01
 -8.84250367e-01  7.85209596e-01  7.85209596e-01  7.85209596e-01
  1.27923301e+00  3.78960861e+00  3.78960861e+00  3.78960861e+00
  8.16915279e+00  1.38137823e+01  1.38137823e+01  1.38137823e+01
  3.60148913e+01  5.09369019e+01  5.09369019e+01  5.09369019e+01
  1.37917166e+02  2.29471846e+02  2.29471846e+02  2.29471846e+02
  4.99200314e+02  1.86591673e+03  7.99583342e+03  4.77641304e+04]
E1 = -182.84745323133268  E_coul = 54.307249110198406
cycle= 2 E= -128.540204121134  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260178
diis-c [-6.55299320e-04  3.36028416e-01  6.63971584e-01]
  HOMO = -0.84860413519219  LUMO = 0.7937638739568
  mo_energy =
[-3.27700459e+01 -1.92893758e+00 -8.48604135e-01 -8.48604135e-01
 -8.48604135e-01  7.93763874e-01  7.93763874e-01  7.93763874e-01
  1.29528910e+00  3.82072626e+00  3.82072626e+00  3.82072626e+00
  8.21549653e+00  1.38761347e+01  1.38761347e+01  1.38761347e+01
  3.60974788e+01  5.10302138e+01  5.10302138e+01  5.10302138e+01
  1.38022939e+02  2.29585175e+02  2.29585175e+02  2.29585175e+02
  4.99317160e+02  1.86603886e+03  7.99595799e+03  4.77642559e+04]
E1 = -182.58885930276628  E_coul = 54.04773494919965
cycle= 3 E= -128.541124353567  delta_E= -0.00092  |g|= 0.000478  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113527
diis-c [-1.18615554e-07 -2.23498986e-03 -2.34918507e-04  1.00246991e+00]
  HOMO = -0.848847999583124  LUMO = 0.793731911530189
  mo_energy =
[-3.27704954e+01 -1.92912605e+00 -8.48848000e-01 -8.48848000e-01
 -8.48848000e-01  7.93731912e-01  7.93731912e-01  7.93731912e-01
  1.29521386e+00  3.82056150e+00  3.82056150e+00  3.82056150e+00
  8.21528008e+00  1.38758462e+01  1.38758462e+01  1.38758462e+01
  3.60971335e+01  5.10298211e+01  5.10298211e+01  5.10298211e+01
  1.38022488e+02  2.29584658e+02  2.29584658e+02  2.29584658e+02
  4.99316582e+02  1.86603815e+03  7.99595718e+03  4.77642551e+04]
E1 = -182.5893716194402  E_coul = 54.04824724688125
cycle= 4 E= -128.541124372559  delta_E= -1.9e-08  |g|= 7.33e-05  |ddm|= 0.000188
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183089
diis-c [-7.53506778e-10  1.80021671e-04  4.91270077e-04 -1.54493574e-01
  1.15382228e+00]
  HOMO = -0.84888620549766  LUMO = 0.793720727260804
  mo_energy =
[-3.27705652e+01 -1.92915679e+00 -8.48886205e-01 -8.48886205e-01
 -8.48886205e-01  7.93720727e-01  7.93720727e-01  7.93720727e-01
  1.29519594e+00  3.82052597e+00  3.82052597e+00  3.82052597e+00
  8.21523743e+00  1.38757922e+01  1.38757922e+01  1.38757922e+01
  3.60970726e+01  5.10297560e+01  5.10297560e+01  5.10297560e+01
  1.38022418e+02  2.29584585e+02  2.29584585e+02  2.29584585e+02
  4.99316505e+02  1.86603807e+03  7.99595709e+03  4.77642550e+04]
E1 = -182.58951453004306  E_coul = 54.0483901569761
cycle= 5 E= -128.541124373067  delta_E= -5.08e-10  |g|= 4.24e-06  |ddm|= 2.7e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58951453004306  E_coul = 54.0483901569761
  HOMO = -0.848884142215846  LUMO = 0.793721322049772
  mo_energy =
[-3.27705606e+01 -1.92915406e+00 -8.48884142e-01 -8.48884142e-01
 -8.48884142e-01  7.93721322e-01  7.93721322e-01  7.93721322e-01
  1.29519740e+00  3.82052793e+00  3.82052793e+00  3.82052793e+00
  8.21524043e+00  1.38757956e+01  1.38757956e+01  1.38757956e+01
  3.60970768e+01  5.10297603e+01  5.10297603e+01  5.10297603e+01
  1.38022423e+02  2.29584589e+02  2.29584589e+02  2.29584589e+02
  4.99316509e+02  1.86603807e+03  7.99595710e+03  4.77642550e+04]
E1 = -182.58950401663375  E_coul = 54.04837964356495
Extra cycle  E= -128.541124373069  delta_E= -1.85e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 392.00998263499247
E1 = -182.58950401663375  E_coul = 54.04837964356495
init E= -128.541124373069
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848884892257166  LUMO = 0.793721154397551
  mo_energy =
[-3.27705630e+01 -1.92915472e+00 -8.48884892e-01 -8.48884892e-01
 -8.48884892e-01  7.93721154e-01  7.93721154e-01  7.93721154e-01
  1.29519715e+00  3.82052729e+00  3.82052729e+00  3.82052729e+00
  8.21523952e+00  1.38757943e+01  1.38757943e+01  1.38757943e+01
  3.60970750e+01  5.10297583e+01  5.10297583e+01  5.10297583e+01
  1.38022421e+02  2.29584586e+02  2.29584586e+02  2.29584586e+02
  4.99316506e+02  1.86603807e+03  7.99595709e+03  4.77642550e+04]
E1 = -182.58950986921576  E_coul = 54.04838549614706
cycle= 1 E= -128.541124373069  delta_E= 1.14e-13  |g|= 8.07e-07  |ddm|= 5.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58950986921576  E_coul = 54.04838549614706
  HOMO = -0.84888448149674  LUMO = 0.793721255439063
  mo_energy =
[-3.27705617e+01 -1.92915427e+00 -8.48884481e-01 -8.48884481e-01
 -8.48884481e-01  7.93721255e-01  7.93721255e-01  7.93721255e-01
  1.29519735e+00  3.82052766e+00  3.82052766e+00  3.82052766e+00
  8.21524007e+00  1.38757950e+01  1.38757950e+01  1.38757950e+01
  3.60970760e+01  5.10297594e+01  5.10297594e+01  5.10297594e+01
  1.38022422e+02  2.29584588e+02  2.29584588e+02  2.29584588e+02
  4.99316507e+02  1.86603807e+03  7.99595710e+03  4.77642550e+04]
E1 = -182.58950693590214  E_coul = 54.04838256283329
Extra cycle  E= -128.541124373069  delta_E= -1.42e-13  |g|= 3.98e-07  |ddm|= 2.92e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264029e+02 2.35857508e+02
 7.55559744e+01 9.80392792e+00 2.63083747e+01 3.97807605e-01
 1.20203714e+00 3.36769391e+00 6.91091834e+00 2.23746670e+01
 9.51710426e+01 2.63075082e-01 2.39325743e+00 8.21390656e-01]
grad_E = [-7.34098044e-10  3.65900925e-08 -5.44944950e-07  8.00105029e-07
  4.32616693e-05 -2.77736738e-04 -9.63729286e-05  2.48508616e-04
 -3.30559708e-05  3.73002542e-04 -4.05842060e-04  5.54935052e-05
 -6.86789878e-06 -5.83306368e-04  9.83752852e-04 -7.98468428e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941253        1
[INPUT] 0    0    [1    /1   ]  3661.45472202        1
[INPUT] 0    0    [1    /1   ]  833.264088636        1
[INPUT] 0    0    [1    /1   ]  235.856626452        1
[INPUT] 0    0    [1    /1   ]  75.5621976949        1
[INPUT] 0    0    [1    /1   ]  9.82395117701        1
[INPUT] 0    0    [1    /1   ]  26.3023948255        1
[INPUT] 0    0    [1    /1   ]  0.398089159327       1
[INPUT] 0    0    [1    /1   ]  1.20339521646        1
[INPUT] 0    0    [1    /1   ]  3.36022852352        1
[INPUT] 1    0    [1    /1   ]  6.93049601439        1
[INPUT] 1    0    [1    /1   ]  22.3518286366        1
[INPUT] 1    0    [1    /1   ]  94.9714726342        1
[INPUT] 1    0    [1    /1   ]  0.263731496903       1
[INPUT] 1    0    [1    /1   ]  2.39416793901        1
[INPUT] 1    0    [1    /1   ]  0.821711303999       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412529897, 1.0]], [0, [3661.4547220176564, 1.0]], [0, [833.2640886358215, 1.0]], [0, [235.85662645219978, 1.0]], [0, [75.5621976948878, 1.0]], [0, [9.823951177006055, 1.0]], [0, [26.302394825465356, 1.0]], [0, [0.3980891593269647, 1.0]], [0, [1.2033952164579276, 1.0]], [0, [3.360228523520474, 1.0]], [1, [6.930496014386018, 1.0]], [1, [22.351828636588728, 1.0]], [1, [94.97147263419905, 1.0]], [1, [0.2637314969033601, 1.0]], [1, [2.394167939014001, 1.0]], [1, [0.8217113039993902, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941253]
bas 1, expnt(s) = [3661.45472202]
bas 2, expnt(s) = [833.26408864]
bas 3, expnt(s) = [235.85662645]
bas 4, expnt(s) = [75.56219769]
bas 5, expnt(s) = [9.82395118]
bas 6, expnt(s) = [26.30239483]
bas 7, expnt(s) = [0.39808916]
bas 8, expnt(s) = [1.20339522]
bas 9, expnt(s) = [3.36022852]
bas 10, expnt(s) = [6.93049601]
bas 11, expnt(s) = [22.35182864]
bas 12, expnt(s) = [94.97147263]
bas 13, expnt(s) = [0.2637315]
bas 14, expnt(s) = [2.39416794]
bas 15, expnt(s) = [0.8217113]
CPU time:       212.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264089e+02 3.91833915e+02 2.35856626e+02 1.52055133e+02
 7.55621977e+01 6.47505497e+01 9.82395118e+00 1.40194079e+01
 2.63023948e+01 2.93434716e+01 3.98089159e-01 1.26619411e+00
 1.20339522e+00 2.90282754e+00 3.36022852e+00 6.27034786e+00
 6.93049601e+00 3.28049810e+01 2.23518286e+01 1.41783508e+02
 9.49714726e+01 8.64919837e+02 2.63731497e-01 5.51362078e-01
 2.39416794e+00 8.68815691e+00 8.21711304e-01 2.28235644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958013013985
cond(S) = 392.1280882780942
E1 = -183.5893766400241  E_coul = 55.080245010569456
init E= -128.509131629455
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77539649739578  LUMO = 0.813310594688816
  mo_energy =
[-3.25550438e+01 -1.85250482e+00 -7.75396497e-01 -7.75396497e-01
 -7.75396497e-01  8.13310595e-01  8.13310595e-01  8.13310595e-01
  1.33044390e+00  3.88894219e+00  3.88894219e+00  3.88894219e+00
  8.30942681e+00  1.40238523e+01  1.40238523e+01  1.40238523e+01
  3.62751603e+01  5.12503038e+01  5.12503038e+01  5.12503038e+01
  1.38271693e+02  2.29475495e+02  2.29475495e+02  2.29475495e+02
  4.99609552e+02  1.86636308e+03  7.99630411e+03  4.77646126e+04]
E1 = -182.08653731864985  E_coul = 53.54890858070742
cycle= 1 E= -128.537628737942  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512299
diis-c [-0.26244993  1.        ]
  HOMO = -0.884183364724953  LUMO = 0.787138789890491
  mo_energy =
[-3.28780522e+01 -1.96641200e+00 -8.84183365e-01 -8.84183365e-01
 -8.84183365e-01  7.87138790e-01  7.87138790e-01  7.87138790e-01
  1.28060010e+00  3.79309810e+00  3.79309810e+00  3.79309810e+00
  8.16850013e+00  1.38356478e+01  1.38356478e+01  1.38356478e+01
  3.60288125e+01  5.09717551e+01  5.09717551e+01  5.09717551e+01
  1.37955035e+02  2.29131013e+02  2.29131013e+02  2.29131013e+02
  4.99248259e+02  1.86596562e+03  7.99587762e+03  4.77641672e+04]
E1 = -182.84786404348432  E_coul = 54.307649417407255
cycle= 2 E= -128.540214626077  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260149
diis-c [-6.55188416e-04  3.35978281e-01  6.64021719e-01]
  HOMO = -0.848556263925968  LUMO = 0.795706377102211
  mo_energy =
[-3.27699568e+01 -1.92888041e+00 -8.48556264e-01 -8.48556264e-01
 -8.48556264e-01  7.95706377e-01  7.95706377e-01  7.95706377e-01
  1.29665621e+00  3.82420897e+00  3.82420897e+00  3.82420897e+00
  8.21480788e+00  1.38980263e+01  1.38980263e+01  1.38980263e+01
  3.61113749e+01  5.10650124e+01  5.10650124e+01  5.10650124e+01
  1.38060759e+02  2.29244268e+02  2.29244268e+02  2.29244268e+02
  4.99365049e+02  1.86608770e+03  7.99600214e+03  4.77642927e+04]
E1 = -182.58947600868325  E_coul = 54.04834236950365
cycle= 3 E= -128.54113363918  delta_E= -0.000919  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113342
diis-c [-1.18975978e-07 -2.23272026e-03 -2.39133174e-04  1.00247185e+00]
  HOMO = -0.848798719375864  LUMO = 0.795674752927794
  mo_energy =
[-3.27704047e+01 -1.92906692e+00 -8.48798719e-01 -8.48798719e-01
 -8.48798719e-01  7.95674753e-01  7.95674753e-01  7.95674753e-01
  1.29658216e+00  3.82404556e+00  3.82404556e+00  3.82404556e+00
  8.21459336e+00  1.38977396e+01  1.38977396e+01  1.38977396e+01
  3.61110315e+01  5.10646215e+01  5.10646215e+01  5.10646215e+01
  1.38060310e+02  2.29243753e+02  2.29243753e+02  2.29243753e+02
  4.99364473e+02  1.86608699e+03  7.99600133e+03  4.77642918e+04]
E1 = -182.5899869971748  E_coul = 54.04885333907415
cycle= 4 E= -128.541133658101  delta_E= -1.89e-08  |g|= 7.32e-05  |ddm|= 0.000189
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183354
diis-c [-7.64274103e-10  1.82241598e-04  4.94193746e-04 -1.55505283e-01
  1.15482885e+00]
  HOMO = -0.848836822228335  LUMO = 0.795663595705345
  mo_energy =
[-3.27704743e+01 -1.92909741e+00 -8.48836822e-01 -8.48836822e-01
 -8.48836822e-01  7.95663596e-01  7.95663596e-01  7.95663596e-01
  1.29656441e+00  3.82401016e+00  3.82401016e+00  3.82401016e+00
  8.21455092e+00  1.38976857e+01  1.38976857e+01  1.38976857e+01
  3.61109707e+01  5.10645565e+01  5.10645565e+01  5.10645565e+01
  1.38060240e+02  2.29243679e+02  2.29243679e+02  2.29243679e+02
  4.99364396e+02  1.86608690e+03  7.99600124e+03  4.77642917e+04]
E1 = -182.59013009316885  E_coul = 54.04899643455787
cycle= 5 E= -128.541133658611  delta_E= -5.1e-10  |g|= 4.29e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59013009316885  E_coul = 54.04899643455787
  HOMO = -0.84883473571277  LUMO = 0.795664199599328
  mo_energy =
[-3.27704698e+01 -1.92909464e+00 -8.48834736e-01 -8.48834736e-01
 -8.48834736e-01  7.95664200e-01  7.95664200e-01  7.95664200e-01
  1.29656588e+00  3.82401214e+00  3.82401214e+00  3.82401214e+00
  8.21455395e+00  1.38976891e+01  1.38976891e+01  1.38976891e+01
  3.61109749e+01  5.10645609e+01  5.10645609e+01  5.10645609e+01
  1.38060245e+02  2.29243684e+02  2.29243684e+02  2.29243684e+02
  4.99364400e+02  1.86608691e+03  7.99600125e+03  4.77642917e+04]
E1 = -182.59011950866977  E_coul = 54.048985850057065
Extra cycle  E= -128.541133658613  delta_E= -1.71e-12  |g|= 1.51e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264089e+02 2.35856626e+02
 7.55621977e+01 9.82395118e+00 2.63023948e+01 3.98089159e-01
 1.20339522e+00 3.36022852e+00 6.93049601e+00 2.23518286e+01
 9.49714726e+01 2.63731497e-01 2.39416794e+00 8.21711304e-01]
E = -128.5411336586127
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:17:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941253        1
[INPUT] 0    0    [1    /1   ]  3661.45472202        1
[INPUT] 0    0    [1    /1   ]  833.264088636        1
[INPUT] 0    0    [1    /1   ]  235.856626452        1
[INPUT] 0    0    [1    /1   ]  75.5621976949        1
[INPUT] 0    0    [1    /1   ]  9.82395117701        1
[INPUT] 0    0    [1    /1   ]  26.3023948255        1
[INPUT] 0    0    [1    /1   ]  0.398089159327       1
[INPUT] 0    0    [1    /1   ]  1.20339521646        1
[INPUT] 0    0    [1    /1   ]  3.36022852352        1
[INPUT] 1    0    [1    /1   ]  6.93049601439        1
[INPUT] 1    0    [1    /1   ]  22.3518286366        1
[INPUT] 1    0    [1    /1   ]  94.9714726342        1
[INPUT] 1    0    [1    /1   ]  0.263731496903       1
[INPUT] 1    0    [1    /1   ]  2.39416793901        1
[INPUT] 1    0    [1    /1   ]  0.821711303999       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412529897, 1.0]], [0, [3661.4547220176564, 1.0]], [0, [833.2640886358215, 1.0]], [0, [235.85662645219978, 1.0]], [0, [75.5621976948878, 1.0]], [0, [9.823951177006055, 1.0]], [0, [26.302394825465356, 1.0]], [0, [0.3980891593269647, 1.0]], [0, [1.2033952164579276, 1.0]], [0, [3.360228523520474, 1.0]], [1, [6.930496014386018, 1.0]], [1, [22.351828636588728, 1.0]], [1, [94.97147263419905, 1.0]], [1, [0.2637314969033601, 1.0]], [1, [2.394167939014001, 1.0]], [1, [0.8217113039993902, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941253]
bas 1, expnt(s) = [3661.45472202]
bas 2, expnt(s) = [833.26408864]
bas 3, expnt(s) = [235.85662645]
bas 4, expnt(s) = [75.56219769]
bas 5, expnt(s) = [9.82395118]
bas 6, expnt(s) = [26.30239483]
bas 7, expnt(s) = [0.39808916]
bas 8, expnt(s) = [1.20339522]
bas 9, expnt(s) = [3.36022852]
bas 10, expnt(s) = [6.93049601]
bas 11, expnt(s) = [22.35182864]
bas 12, expnt(s) = [94.97147263]
bas 13, expnt(s) = [0.2637315]
bas 14, expnt(s) = [2.39416794]
bas 15, expnt(s) = [0.8217113]
CPU time:       213.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264089e+02 3.91833915e+02 2.35856626e+02 1.52055133e+02
 7.55621977e+01 6.47505497e+01 9.82395118e+00 1.40194079e+01
 2.63023948e+01 2.93434716e+01 3.98089159e-01 1.26619411e+00
 1.20339522e+00 2.90282754e+00 3.36022852e+00 6.27034786e+00
 6.93049601e+00 3.28049810e+01 2.23518286e+01 1.41783508e+02
 9.49714726e+01 8.64919837e+02 2.63731497e-01 5.51362078e-01
 2.39416794e+00 8.68815691e+00 8.21711304e-01 2.28235644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958013013985
cond(S) = 392.1280882780942
E1 = -183.5893766400241  E_coul = 55.080245010569456
init E= -128.509131629455
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77539649739578  LUMO = 0.813310594688816
  mo_energy =
[-3.25550438e+01 -1.85250482e+00 -7.75396497e-01 -7.75396497e-01
 -7.75396497e-01  8.13310595e-01  8.13310595e-01  8.13310595e-01
  1.33044390e+00  3.88894219e+00  3.88894219e+00  3.88894219e+00
  8.30942681e+00  1.40238523e+01  1.40238523e+01  1.40238523e+01
  3.62751603e+01  5.12503038e+01  5.12503038e+01  5.12503038e+01
  1.38271693e+02  2.29475495e+02  2.29475495e+02  2.29475495e+02
  4.99609552e+02  1.86636308e+03  7.99630411e+03  4.77646126e+04]
E1 = -182.08653731864985  E_coul = 53.54890858070742
cycle= 1 E= -128.537628737942  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512299
diis-c [-0.26244993  1.        ]
  HOMO = -0.884183364724953  LUMO = 0.787138789890491
  mo_energy =
[-3.28780522e+01 -1.96641200e+00 -8.84183365e-01 -8.84183365e-01
 -8.84183365e-01  7.87138790e-01  7.87138790e-01  7.87138790e-01
  1.28060010e+00  3.79309810e+00  3.79309810e+00  3.79309810e+00
  8.16850013e+00  1.38356478e+01  1.38356478e+01  1.38356478e+01
  3.60288125e+01  5.09717551e+01  5.09717551e+01  5.09717551e+01
  1.37955035e+02  2.29131013e+02  2.29131013e+02  2.29131013e+02
  4.99248259e+02  1.86596562e+03  7.99587762e+03  4.77641672e+04]
E1 = -182.84786404348432  E_coul = 54.307649417407255
cycle= 2 E= -128.540214626077  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260149
diis-c [-6.55188416e-04  3.35978281e-01  6.64021719e-01]
  HOMO = -0.848556263925968  LUMO = 0.795706377102211
  mo_energy =
[-3.27699568e+01 -1.92888041e+00 -8.48556264e-01 -8.48556264e-01
 -8.48556264e-01  7.95706377e-01  7.95706377e-01  7.95706377e-01
  1.29665621e+00  3.82420897e+00  3.82420897e+00  3.82420897e+00
  8.21480788e+00  1.38980263e+01  1.38980263e+01  1.38980263e+01
  3.61113749e+01  5.10650124e+01  5.10650124e+01  5.10650124e+01
  1.38060759e+02  2.29244268e+02  2.29244268e+02  2.29244268e+02
  4.99365049e+02  1.86608770e+03  7.99600214e+03  4.77642927e+04]
E1 = -182.58947600868325  E_coul = 54.04834236950365
cycle= 3 E= -128.54113363918  delta_E= -0.000919  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113342
diis-c [-1.18975978e-07 -2.23272026e-03 -2.39133174e-04  1.00247185e+00]
  HOMO = -0.848798719375864  LUMO = 0.795674752927794
  mo_energy =
[-3.27704047e+01 -1.92906692e+00 -8.48798719e-01 -8.48798719e-01
 -8.48798719e-01  7.95674753e-01  7.95674753e-01  7.95674753e-01
  1.29658216e+00  3.82404556e+00  3.82404556e+00  3.82404556e+00
  8.21459336e+00  1.38977396e+01  1.38977396e+01  1.38977396e+01
  3.61110315e+01  5.10646215e+01  5.10646215e+01  5.10646215e+01
  1.38060310e+02  2.29243753e+02  2.29243753e+02  2.29243753e+02
  4.99364473e+02  1.86608699e+03  7.99600133e+03  4.77642918e+04]
E1 = -182.5899869971748  E_coul = 54.04885333907415
cycle= 4 E= -128.541133658101  delta_E= -1.89e-08  |g|= 7.32e-05  |ddm|= 0.000189
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183354
diis-c [-7.64274103e-10  1.82241598e-04  4.94193746e-04 -1.55505283e-01
  1.15482885e+00]
  HOMO = -0.848836822228335  LUMO = 0.795663595705345
  mo_energy =
[-3.27704743e+01 -1.92909741e+00 -8.48836822e-01 -8.48836822e-01
 -8.48836822e-01  7.95663596e-01  7.95663596e-01  7.95663596e-01
  1.29656441e+00  3.82401016e+00  3.82401016e+00  3.82401016e+00
  8.21455092e+00  1.38976857e+01  1.38976857e+01  1.38976857e+01
  3.61109707e+01  5.10645565e+01  5.10645565e+01  5.10645565e+01
  1.38060240e+02  2.29243679e+02  2.29243679e+02  2.29243679e+02
  4.99364396e+02  1.86608690e+03  7.99600124e+03  4.77642917e+04]
E1 = -182.59013009316885  E_coul = 54.04899643455787
cycle= 5 E= -128.541133658611  delta_E= -5.1e-10  |g|= 4.29e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59013009316885  E_coul = 54.04899643455787
  HOMO = -0.84883473571277  LUMO = 0.795664199599328
  mo_energy =
[-3.27704698e+01 -1.92909464e+00 -8.48834736e-01 -8.48834736e-01
 -8.48834736e-01  7.95664200e-01  7.95664200e-01  7.95664200e-01
  1.29656588e+00  3.82401214e+00  3.82401214e+00  3.82401214e+00
  8.21455395e+00  1.38976891e+01  1.38976891e+01  1.38976891e+01
  3.61109749e+01  5.10645609e+01  5.10645609e+01  5.10645609e+01
  1.38060245e+02  2.29243684e+02  2.29243684e+02  2.29243684e+02
  4.99364400e+02  1.86608691e+03  7.99600125e+03  4.77642917e+04]
E1 = -182.59011950866977  E_coul = 54.048985850057065
Extra cycle  E= -128.541133658613  delta_E= -1.71e-12  |g|= 1.51e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 392.1280882780942
E1 = -182.59011950866977  E_coul = 54.048985850057065
init E= -128.541133658613
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848835490538041  LUMO = 0.795664030720078
  mo_energy =
[-3.27704721e+01 -1.92909532e+00 -8.48835491e-01 -8.48835491e-01
 -8.48835491e-01  7.95664031e-01  7.95664031e-01  7.95664031e-01
  1.29656563e+00  3.82401150e+00  3.82401150e+00  3.82401150e+00
  8.21455304e+00  1.38976878e+01  1.38976878e+01  1.38976878e+01
  3.61109732e+01  5.10645589e+01  5.10645589e+01  5.10645589e+01
  1.38060242e+02  2.29243681e+02  2.29243681e+02  2.29243681e+02
  4.99364397e+02  1.86608690e+03  7.99600124e+03  4.77642917e+04]
E1 = -182.59012540602276  E_coul = 54.04899174740968
cycle= 1 E= -128.541133658613  delta_E= -3.98e-13  |g|= 8.13e-07  |ddm|= 5.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59012540602276  E_coul = 54.04899174740968
  HOMO = -0.84883507662499  LUMO = 0.795664132767023
  mo_energy =
[-3.27704709e+01 -1.92909486e+00 -8.48835077e-01 -8.48835077e-01
 -8.48835077e-01  7.95664133e-01  7.95664133e-01  7.95664133e-01
  1.29656584e+00  3.82401187e+00  3.82401187e+00  3.82401187e+00
  8.21455359e+00  1.38976886e+01  1.38976886e+01  1.38976886e+01
  3.61109741e+01  5.10645599e+01  5.10645599e+01  5.10645599e+01
  1.38060244e+02  2.29243682e+02  2.29243682e+02  2.29243682e+02
  4.99364398e+02  1.86608690e+03  7.99600124e+03  4.77642917e+04]
E1 = -182.59012245182032  E_coul = 54.048988793207705
Extra cycle  E= -128.541133658613  delta_E= 4.83e-13  |g|= 4.01e-07  |ddm|= 2.94e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264089e+02 2.35856626e+02
 7.55621977e+01 9.82395118e+00 2.63023948e+01 3.98089159e-01
 1.20339522e+00 3.36022852e+00 6.93049601e+00 2.23518286e+01
 9.49714726e+01 2.63731497e-01 2.39416794e+00 8.21711304e-01]
grad_E = [-5.37268709e-10  2.62435110e-08 -3.39431818e-07 -1.61107670e-06
  6.16624967e-05 -1.55719975e-04 -1.73099273e-04  9.82103352e-05
  4.40942443e-05  3.38902194e-04 -3.73893107e-05 -2.68229291e-06
 -4.81350505e-06  4.16603704e-04  1.70719029e-04 -3.46737330e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941254        1
[INPUT] 0    0    [1    /1   ]  3661.45471883        1
[INPUT] 0    0    [1    /1   ]  833.26417007         1
[INPUT] 0    0    [1    /1   ]  235.855298384        1
[INPUT] 0    0    [1    /1   ]  75.5716404094        1
[INPUT] 0    0    [1    /1   ]  9.83744303102        1
[INPUT] 0    0    [1    /1   ]  26.3038238788        1
[INPUT] 0    0    [1    /1   ]  0.398031684583       1
[INPUT] 0    0    [1    /1   ]  1.2032666521         1
[INPUT] 0    0    [1    /1   ]  3.35238095255        1
[INPUT] 1    0    [1    /1   ]  6.93132989633        1
[INPUT] 1    0    [1    /1   ]  22.3291107849        1
[INPUT] 1    0    [1    /1   ]  94.5755546552        1
[INPUT] 1    0    [1    /1   ]  0.263378945605       1
[INPUT] 1    0    [1    /1   ]  2.39238139475        1
[INPUT] 1    0    [1    /1   ]  0.820908320024       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125358556, 1.0]], [0, [3661.4547188340584, 1.0]], [0, [833.2641700703069, 1.0]], [0, [235.85529838372068, 1.0]], [0, [75.57164040943448, 1.0]], [0, [9.837443031017745, 1.0]], [0, [26.303823878759623, 1.0]], [0, [0.3980316845825272, 1.0]], [0, [1.2032666521048407, 1.0]], [0, [3.352380952548669, 1.0]], [1, [6.931329896333799, 1.0]], [1, [22.329110784911997, 1.0]], [1, [94.57555465524081, 1.0]], [1, [0.2633789456047661, 1.0]], [1, [2.392381394753751, 1.0]], [1, [0.8209083200244054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412536]
bas 1, expnt(s) = [3661.45471883]
bas 2, expnt(s) = [833.26417007]
bas 3, expnt(s) = [235.85529838]
bas 4, expnt(s) = [75.57164041]
bas 5, expnt(s) = [9.83744303]
bas 6, expnt(s) = [26.30382388]
bas 7, expnt(s) = [0.39803168]
bas 8, expnt(s) = [1.20326665]
bas 9, expnt(s) = [3.35238095]
bas 10, expnt(s) = [6.9313299]
bas 11, expnt(s) = [22.32911078]
bas 12, expnt(s) = [94.57555466]
bas 13, expnt(s) = [0.26337895]
bas 14, expnt(s) = [2.39238139]
bas 15, expnt(s) = [0.82090832]
CPU time:       216.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264170e+02 3.91833944e+02 2.35855298e+02 1.52054491e+02
 7.55716404e+01 6.47566183e+01 9.83744303e+00 1.40338457e+01
 2.63038239e+01 2.93446673e+01 3.98031685e-01 1.26605700e+00
 1.20326665e+00 2.90259495e+00 3.35238095e+00 6.25936169e+00
 6.93132990e+00 3.28099149e+01 2.23291108e+01 1.41603399e+02
 9.45755547e+01 8.60415081e+02 2.63378946e-01 5.50440919e-01
 2.39238139e+00 8.68005372e+00 8.20908320e-01 2.27956885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999582070551897
cond(S) = 391.6797522357169
E1 = -183.58933087317754  E_coul = 55.08024014018315
init E= -128.509090732994
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775396961543673  LUMO = 0.812118076260347
  mo_energy =
[-3.25550456e+01 -1.85250544e+00 -7.75396962e-01 -7.75396962e-01
 -7.75396962e-01  8.12118076e-01  8.12118076e-01  8.12118076e-01
  1.32995859e+00  3.88447740e+00  3.88447740e+00  3.88447740e+00
  8.30095680e+00  1.40152575e+01  1.40152575e+01  1.40152575e+01
  3.62712242e+01  5.12142972e+01  5.12142972e+01  5.12142972e+01
  1.38296294e+02  2.28738854e+02  2.28738854e+02  2.28738854e+02
  4.99658775e+02  1.86641891e+03  7.99635556e+03  4.77646556e+04]
E1 = -182.08611281512339  E_coul = 53.54848402346719
cycle= 1 E= -128.537628791656  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512458
diis-c [-0.26261344  1.        ]
  HOMO = -0.884218775578513  LUMO = 0.78597547051576
  mo_energy =
[-3.28781194e+01 -1.96645208e+00 -8.84218776e-01 -8.84218776e-01
 -8.84218776e-01  7.85975471e-01  7.85975471e-01  7.85975471e-01
  1.28011333e+00  3.78865972e+00  3.78865972e+00  3.78865972e+00
  8.16006995e+00  1.38270201e+01  1.38270201e+01  1.38270201e+01
  3.60247865e+01  5.09357423e+01  5.09357423e+01  5.09357423e+01
  1.37979559e+02  2.28394460e+02  2.28394460e+02  2.28394460e+02
  4.99297420e+02  1.86602139e+03  7.99592902e+03  4.77642102e+04]
E1 = -182.84765765727286  E_coul = 54.30744205564748
cycle= 2 E= -128.540215601625  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260256
diis-c [-6.5544659e-04  3.3600128e-01  6.6399872e-01]
  HOMO = -0.848582333515612  LUMO = 0.794531250400787
  mo_energy =
[-3.27699984e+01 -1.92891044e+00 -8.48582334e-01 -8.48582334e-01
 -8.48582334e-01  7.94531250e-01  7.94531250e-01  7.94531250e-01
  1.29616541e+00  3.81975844e+00  3.81975844e+00  3.81975844e+00
  8.20636196e+00  1.38894090e+01  1.38894090e+01  1.38894090e+01
  3.61073804e+01  5.10290025e+01  5.10290025e+01  5.10290025e+01
  1.38085313e+02  2.28507706e+02  2.28507706e+02  2.28507706e+02
  4.99414237e+02  1.86614350e+03  7.99605356e+03  4.77643357e+04]
E1 = -182.5891636490905  E_coul = 54.048028435175446
cycle= 3 E= -128.541135213915  delta_E= -0.00092  |g|= 0.000479  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113541
diis-c [-1.19039936e-07 -2.23695448e-03 -2.40817143e-04  1.00247777e+00]
  HOMO = -0.848826008196162  LUMO = 0.794499158061199
  mo_energy =
[-3.27704480e+01 -1.92909851e+00 -8.48826008e-01 -8.48826008e-01
 -8.48826008e-01  7.94499158e-01  7.94499158e-01  7.94499158e-01
  1.29609021e+00  3.81959385e+00  3.81959385e+00  3.81959385e+00
  8.20614601e+00  1.38891207e+01  1.38891207e+01  1.38891207e+01
  3.61070353e+01  5.10286099e+01  5.10286099e+01  5.10286099e+01
  1.38084863e+02  2.28507190e+02  2.28507190e+02  2.28507190e+02
  4.99413660e+02  1.86614279e+03  7.99605275e+03  4.77643348e+04]
E1 = -182.58967440233485  E_coul = 54.048539169344274
cycle= 4 E= -128.541135232991  delta_E= -1.91e-08  |g|= 7.34e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183472
diis-c [-7.57432938e-10  1.80628910e-04  4.93437239e-04 -1.54680560e-01
  1.15400649e+00]
  HOMO = -0.8488642817701  LUMO = 0.794487939681039
  mo_energy =
[-3.27705179e+01 -1.92912928e+00 -8.48864282e-01 -8.48864282e-01
 -8.48864282e-01  7.94487940e-01  7.94487940e-01  7.94487940e-01
  1.29607226e+00  3.81955827e+00  3.81955827e+00  3.81955827e+00
  8.20610333e+00  1.38890666e+01  1.38890666e+01  1.38890666e+01
  3.61069743e+01  5.10285447e+01  5.10285447e+01  5.10285447e+01
  1.38084793e+02  2.28507116e+02  2.28507116e+02  2.28507116e+02
  4.99413582e+02  1.86614270e+03  7.99605266e+03  4.77643347e+04]
E1 = -182.58981737150737  E_coul = 54.04868213800593
cycle= 5 E= -128.541135233501  delta_E= -5.11e-10  |g|= 4.24e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58981737150737  E_coul = 54.04868213800593
  HOMO = -0.848862220572957  LUMO = 0.794488535079918
  mo_energy =
[-3.27705133e+01 -1.92912654e+00 -8.48862221e-01 -8.48862221e-01
 -8.48862221e-01  7.94488535e-01  7.94488535e-01  7.94488535e-01
  1.29607372e+00  3.81956022e+00  3.81956022e+00  3.81956022e+00
  8.20610633e+00  1.38890700e+01  1.38890700e+01  1.38890700e+01
  3.61069785e+01  5.10285490e+01  5.10285490e+01  5.10285490e+01
  1.38084797e+02  2.28507121e+02  2.28507121e+02  2.28507121e+02
  4.99413586e+02  1.86614270e+03  7.99605267e+03  4.77643347e+04]
E1 = -182.58980688692478  E_coul = 54.04867165342213
Extra cycle  E= -128.541135233503  delta_E= -1.19e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264170e+02 2.35855298e+02
 7.55716404e+01 9.83744303e+00 2.63038239e+01 3.98031685e-01
 1.20326665e+00 3.35238095e+00 6.93132990e+00 2.23291108e+01
 9.45755547e+01 2.63378946e-01 2.39238139e+00 8.20908320e-01]
E = -128.54113523350264
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941254        1
[INPUT] 0    0    [1    /1   ]  3661.45471883        1
[INPUT] 0    0    [1    /1   ]  833.26417007         1
[INPUT] 0    0    [1    /1   ]  235.855298384        1
[INPUT] 0    0    [1    /1   ]  75.5716404094        1
[INPUT] 0    0    [1    /1   ]  9.83744303102        1
[INPUT] 0    0    [1    /1   ]  26.3038238788        1
[INPUT] 0    0    [1    /1   ]  0.398031684583       1
[INPUT] 0    0    [1    /1   ]  1.2032666521         1
[INPUT] 0    0    [1    /1   ]  3.35238095255        1
[INPUT] 1    0    [1    /1   ]  6.93132989633        1
[INPUT] 1    0    [1    /1   ]  22.3291107849        1
[INPUT] 1    0    [1    /1   ]  94.5755546552        1
[INPUT] 1    0    [1    /1   ]  0.263378945605       1
[INPUT] 1    0    [1    /1   ]  2.39238139475        1
[INPUT] 1    0    [1    /1   ]  0.820908320024       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125358556, 1.0]], [0, [3661.4547188340584, 1.0]], [0, [833.2641700703069, 1.0]], [0, [235.85529838372068, 1.0]], [0, [75.57164040943448, 1.0]], [0, [9.837443031017745, 1.0]], [0, [26.303823878759623, 1.0]], [0, [0.3980316845825272, 1.0]], [0, [1.2032666521048407, 1.0]], [0, [3.352380952548669, 1.0]], [1, [6.931329896333799, 1.0]], [1, [22.329110784911997, 1.0]], [1, [94.57555465524081, 1.0]], [1, [0.2633789456047661, 1.0]], [1, [2.392381394753751, 1.0]], [1, [0.8209083200244054, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412536]
bas 1, expnt(s) = [3661.45471883]
bas 2, expnt(s) = [833.26417007]
bas 3, expnt(s) = [235.85529838]
bas 4, expnt(s) = [75.57164041]
bas 5, expnt(s) = [9.83744303]
bas 6, expnt(s) = [26.30382388]
bas 7, expnt(s) = [0.39803168]
bas 8, expnt(s) = [1.20326665]
bas 9, expnt(s) = [3.35238095]
bas 10, expnt(s) = [6.9313299]
bas 11, expnt(s) = [22.32911078]
bas 12, expnt(s) = [94.57555466]
bas 13, expnt(s) = [0.26337895]
bas 14, expnt(s) = [2.39238139]
bas 15, expnt(s) = [0.82090832]
CPU time:       217.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920103e+03
 8.33264170e+02 3.91833944e+02 2.35855298e+02 1.52054491e+02
 7.55716404e+01 6.47566183e+01 9.83744303e+00 1.40338457e+01
 2.63038239e+01 2.93446673e+01 3.98031685e-01 1.26605700e+00
 1.20326665e+00 2.90259495e+00 3.35238095e+00 6.25936169e+00
 6.93132990e+00 3.28099149e+01 2.23291108e+01 1.41603399e+02
 9.45755547e+01 8.60415081e+02 2.63378946e-01 5.50440919e-01
 2.39238139e+00 8.68005372e+00 8.20908320e-01 2.27956885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999582070551897
cond(S) = 391.6797522357169
E1 = -183.58933087317754  E_coul = 55.08024014018315
init E= -128.509090732994
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775396961543673  LUMO = 0.812118076260347
  mo_energy =
[-3.25550456e+01 -1.85250544e+00 -7.75396962e-01 -7.75396962e-01
 -7.75396962e-01  8.12118076e-01  8.12118076e-01  8.12118076e-01
  1.32995859e+00  3.88447740e+00  3.88447740e+00  3.88447740e+00
  8.30095680e+00  1.40152575e+01  1.40152575e+01  1.40152575e+01
  3.62712242e+01  5.12142972e+01  5.12142972e+01  5.12142972e+01
  1.38296294e+02  2.28738854e+02  2.28738854e+02  2.28738854e+02
  4.99658775e+02  1.86641891e+03  7.99635556e+03  4.77646556e+04]
E1 = -182.08611281512339  E_coul = 53.54848402346719
cycle= 1 E= -128.537628791656  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512458
diis-c [-0.26261344  1.        ]
  HOMO = -0.884218775578513  LUMO = 0.78597547051576
  mo_energy =
[-3.28781194e+01 -1.96645208e+00 -8.84218776e-01 -8.84218776e-01
 -8.84218776e-01  7.85975471e-01  7.85975471e-01  7.85975471e-01
  1.28011333e+00  3.78865972e+00  3.78865972e+00  3.78865972e+00
  8.16006995e+00  1.38270201e+01  1.38270201e+01  1.38270201e+01
  3.60247865e+01  5.09357423e+01  5.09357423e+01  5.09357423e+01
  1.37979559e+02  2.28394460e+02  2.28394460e+02  2.28394460e+02
  4.99297420e+02  1.86602139e+03  7.99592902e+03  4.77642102e+04]
E1 = -182.84765765727286  E_coul = 54.30744205564748
cycle= 2 E= -128.540215601625  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260256
diis-c [-6.5544659e-04  3.3600128e-01  6.6399872e-01]
  HOMO = -0.848582333515612  LUMO = 0.794531250400787
  mo_energy =
[-3.27699984e+01 -1.92891044e+00 -8.48582334e-01 -8.48582334e-01
 -8.48582334e-01  7.94531250e-01  7.94531250e-01  7.94531250e-01
  1.29616541e+00  3.81975844e+00  3.81975844e+00  3.81975844e+00
  8.20636196e+00  1.38894090e+01  1.38894090e+01  1.38894090e+01
  3.61073804e+01  5.10290025e+01  5.10290025e+01  5.10290025e+01
  1.38085313e+02  2.28507706e+02  2.28507706e+02  2.28507706e+02
  4.99414237e+02  1.86614350e+03  7.99605356e+03  4.77643357e+04]
E1 = -182.5891636490905  E_coul = 54.048028435175446
cycle= 3 E= -128.541135213915  delta_E= -0.00092  |g|= 0.000479  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113541
diis-c [-1.19039936e-07 -2.23695448e-03 -2.40817143e-04  1.00247777e+00]
  HOMO = -0.848826008196162  LUMO = 0.794499158061199
  mo_energy =
[-3.27704480e+01 -1.92909851e+00 -8.48826008e-01 -8.48826008e-01
 -8.48826008e-01  7.94499158e-01  7.94499158e-01  7.94499158e-01
  1.29609021e+00  3.81959385e+00  3.81959385e+00  3.81959385e+00
  8.20614601e+00  1.38891207e+01  1.38891207e+01  1.38891207e+01
  3.61070353e+01  5.10286099e+01  5.10286099e+01  5.10286099e+01
  1.38084863e+02  2.28507190e+02  2.28507190e+02  2.28507190e+02
  4.99413660e+02  1.86614279e+03  7.99605275e+03  4.77643348e+04]
E1 = -182.58967440233485  E_coul = 54.048539169344274
cycle= 4 E= -128.541135232991  delta_E= -1.91e-08  |g|= 7.34e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183472
diis-c [-7.57432938e-10  1.80628910e-04  4.93437239e-04 -1.54680560e-01
  1.15400649e+00]
  HOMO = -0.8488642817701  LUMO = 0.794487939681039
  mo_energy =
[-3.27705179e+01 -1.92912928e+00 -8.48864282e-01 -8.48864282e-01
 -8.48864282e-01  7.94487940e-01  7.94487940e-01  7.94487940e-01
  1.29607226e+00  3.81955827e+00  3.81955827e+00  3.81955827e+00
  8.20610333e+00  1.38890666e+01  1.38890666e+01  1.38890666e+01
  3.61069743e+01  5.10285447e+01  5.10285447e+01  5.10285447e+01
  1.38084793e+02  2.28507116e+02  2.28507116e+02  2.28507116e+02
  4.99413582e+02  1.86614270e+03  7.99605266e+03  4.77643347e+04]
E1 = -182.58981737150737  E_coul = 54.04868213800593
cycle= 5 E= -128.541135233501  delta_E= -5.11e-10  |g|= 4.24e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58981737150737  E_coul = 54.04868213800593
  HOMO = -0.848862220572957  LUMO = 0.794488535079918
  mo_energy =
[-3.27705133e+01 -1.92912654e+00 -8.48862221e-01 -8.48862221e-01
 -8.48862221e-01  7.94488535e-01  7.94488535e-01  7.94488535e-01
  1.29607372e+00  3.81956022e+00  3.81956022e+00  3.81956022e+00
  8.20610633e+00  1.38890700e+01  1.38890700e+01  1.38890700e+01
  3.61069785e+01  5.10285490e+01  5.10285490e+01  5.10285490e+01
  1.38084797e+02  2.28507121e+02  2.28507121e+02  2.28507121e+02
  4.99413586e+02  1.86614270e+03  7.99605267e+03  4.77643347e+04]
E1 = -182.58980688692478  E_coul = 54.04867165342213
Extra cycle  E= -128.541135233503  delta_E= -1.19e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 391.6797522357169
E1 = -182.58980688692478  E_coul = 54.04867165342213
init E= -128.541135233503
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848862968511008  LUMO = 0.794488367942286
  mo_energy =
[-3.27705157e+01 -1.92912721e+00 -8.48862969e-01 -8.48862969e-01
 -8.48862969e-01  7.94488368e-01  7.94488368e-01  7.94488368e-01
  1.29607347e+00  3.81955959e+00  3.81955959e+00  3.81955959e+00
  8.20610542e+00  1.38890687e+01  1.38890687e+01  1.38890687e+01
  3.61069767e+01  5.10285470e+01  5.10285470e+01  5.10285470e+01
  1.38084795e+02  2.28507118e+02  2.28507118e+02  2.28507118e+02
  4.99413583e+02  1.86614270e+03  7.99605266e+03  4.77643347e+04]
E1 = -182.5898127265245  E_coul = 54.0486774930219
cycle= 1 E= -128.541135233503  delta_E= 2.84e-14  |g|= 8.05e-07  |ddm|= 5.36e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5898127265245  E_coul = 54.0486774930219
  HOMO = -0.848862558668648  LUMO = 0.794488468822187
  mo_energy =
[-3.27705144e+01 -1.92912675e+00 -8.48862559e-01 -8.48862559e-01
 -8.48862559e-01  7.94488469e-01  7.94488469e-01  7.94488469e-01
  1.29607367e+00  3.81955995e+00  3.81955995e+00  3.81955995e+00
  8.20610597e+00  1.38890694e+01  1.38890694e+01  1.38890694e+01
  3.61069777e+01  5.10285481e+01  5.10285481e+01  5.10285481e+01
  1.38084796e+02  2.28507119e+02  2.28507119e+02  2.28507119e+02
  4.99413585e+02  1.86614270e+03  7.99605266e+03  4.77643347e+04]
E1 = -182.58980980066028  E_coul = 54.04867456715756
Extra cycle  E= -128.541135233503  delta_E= -8.53e-14  |g|= 3.97e-07  |ddm|= 2.92e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264170e+02 2.35855298e+02
 7.55716404e+01 9.83744303e+00 2.63038239e+01 3.98031685e-01
 1.20326665e+00 3.35238095e+00 6.93132990e+00 2.23291108e+01
 9.45755547e+01 2.63378946e-01 2.39238139e+00 8.20908320e-01]
grad_E = [-4.15421504e-10  1.98557677e-08 -2.13591947e-07 -3.04866980e-06
  7.22942971e-05 -8.08930881e-05 -2.17872743e-04  2.27197547e-05
  6.90472936e-05  3.19471292e-04  5.46125282e-05 -8.27873531e-06
 -5.85270961e-06 -3.42607682e-04 -1.14505408e-04  1.46111933e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941254        1
[INPUT] 0    0    [1    /1   ]  3661.45471665        1
[INPUT] 0    0    [1    /1   ]  833.264227549        1
[INPUT] 0    0    [1    /1   ]  235.854337214        1
[INPUT] 0    0    [1    /1   ]  75.5784406464        1
[INPUT] 0    0    [1    /1   ]  9.84358628038        1
[INPUT] 0    0    [1    /1   ]  26.3073229882        1
[INPUT] 0    0    [1    /1   ]  0.397966700774       1
[INPUT] 0    0    [1    /1   ]  1.20289797546        1
[INPUT] 0    0    [1    /1   ]  3.34721917212        1
[INPUT] 1    0    [1    /1   ]  6.92198879125        1
[INPUT] 1    0    [1    /1   ]  22.2862432118        1
[INPUT] 1    0    [1    /1   ]  94.2734830606        1
[INPUT] 1    0    [1    /1   ]  0.263650167031       1
[INPUT] 1    0    [1    /1   ]  2.39077787768        1
[INPUT] 1    0    [1    /1   ]  0.821021757484       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125399378, 1.0]], [0, [3661.454716650323, 1.0]], [0, [833.2642275490351, 1.0]], [0, [235.85433721431755, 1.0]], [0, [75.57844064644294, 1.0]], [0, [9.84358628038495, 1.0]], [0, [26.307322988171002, 1.0]], [0, [0.39796670077389557, 1.0]], [0, [1.2028979754598934, 1.0]], [0, [3.347219172115044, 1.0]], [1, [6.921988791246353, 1.0]], [1, [22.286243211833195, 1.0]], [1, [94.27348306063035, 1.0]], [1, [0.2636501670305741, 1.0]], [1, [2.390777877682989, 1.0]], [1, [0.8210217574843183, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941254]
bas 1, expnt(s) = [3661.45471665]
bas 2, expnt(s) = [833.26422755]
bas 3, expnt(s) = [235.85433721]
bas 4, expnt(s) = [75.57844065]
bas 5, expnt(s) = [9.84358628]
bas 6, expnt(s) = [26.30732299]
bas 7, expnt(s) = [0.3979667]
bas 8, expnt(s) = [1.20289798]
bas 9, expnt(s) = [3.34721917]
bas 10, expnt(s) = [6.92198879]
bas 11, expnt(s) = [22.28624321]
bas 12, expnt(s) = [94.27348306]
bas 13, expnt(s) = [0.26365017]
bas 14, expnt(s) = [2.39077788]
bas 15, expnt(s) = [0.82102176]
CPU time:       220.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920102e+03
 8.33264228e+02 3.91833964e+02 2.35854337e+02 1.52054026e+02
 7.55784406e+01 6.47609886e+01 9.84358628e+00 1.40404180e+01
 2.63073230e+01 2.93475950e+01 3.97966701e-01 1.26590197e+00
 1.20289798e+00 2.90192791e+00 3.34721917e+00 6.25213198e+00
 6.92198879e+00 3.27546533e+01 2.22862432e+01 1.41263667e+02
 9.42734831e+01 8.56981277e+02 2.63650167e-01 5.51149549e-01
 2.39077788e+00 8.67278196e+00 8.21021757e-01 2.27996261e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999581342150499
cond(S) = 391.26673459941424
E1 = -183.58932807010507  E_coul = 55.080247092987236
init E= -128.509080977118
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775395686435932  LUMO = 0.812859482512828
  mo_energy =
[-3.25550462e+01 -1.85250485e+00 -7.75395686e-01 -7.75395686e-01
 -7.75395686e-01  8.12859483e-01  8.12859483e-01  8.12859483e-01
  1.32939412e+00  3.88483648e+00  3.88483648e+00  3.88483648e+00
  8.29396507e+00  1.40042363e+01  1.40042363e+01  1.40042363e+01
  3.62634832e+01  5.11296294e+01  5.11296294e+01  5.11296294e+01
  1.38307726e+02  2.28068274e+02  2.28068274e+02  2.28068274e+02
  4.99690190e+02  1.86645618e+03  7.99639016e+03  4.77646845e+04]
E1 = -182.08646749388134  E_coul = 53.54883694616804
cycle= 1 E= -128.537630547713  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512561
diis-c [-0.26271926  1.        ]
  HOMO = -0.884189142715823  LUMO = 0.786708092586348
  mo_energy =
[-3.28780644e+01 -1.96641931e+00 -8.84189143e-01 -8.84189143e-01
 -8.84189143e-01  7.86708093e-01  7.86708093e-01  7.86708093e-01
  1.27959612e+00  3.78909011e+00  3.78909011e+00  3.78909011e+00
  8.15318091e+00  1.38161701e+01  1.38161701e+01  1.38161701e+01
  3.60170826e+01  5.08512548e+01  5.08512548e+01  5.08512548e+01
  1.37991038e+02  2.27724049e+02  2.27724049e+02  2.27724049e+02
  4.99328890e+02  1.86605872e+03  7.99596368e+03  4.77642392e+04]
E1 = -182.8478236514577  E_coul = 54.307607071628276
cycle= 2 E= -128.540216579829  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260287
diis-c [-6.55238619e-04  3.35983433e-01  6.64016567e-01]
  HOMO = -0.848560902194453  LUMO = 0.795267969878379
  mo_energy =
[-3.27699658e+01 -1.92888653e+00 -8.48560902e-01 -8.48560902e-01
 -8.48560902e-01  7.95267970e-01  7.95267970e-01  7.95267970e-01
  1.29563559e+00  3.82016740e+00  3.82016740e+00  3.82016740e+00
  8.19943941e+00  1.38785016e+01  1.38785016e+01  1.38785016e+01
  3.60996638e+01  5.09444518e+01  5.09444518e+01  5.09444518e+01
  1.38096773e+02  2.27837245e+02  2.27837245e+02  2.27837245e+02
  4.99445685e+02  1.86618080e+03  7.99608820e+03  4.77643647e+04]
E1 = -182.5894177781334  E_coul = 54.04828209297966
cycle= 3 E= -128.541135685154  delta_E= -0.000919  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113392
diis-c [-1.18960191e-07 -2.23390852e-03 -2.41582029e-04  1.00247549e+00]
  HOMO = -0.848803747874724  LUMO = 0.795236171370858
  mo_energy =
[-3.27704142e+01 -1.92907350e+00 -8.48803748e-01 -8.48803748e-01
 -8.48803748e-01  7.95236171e-01  7.95236171e-01  7.95236171e-01
  1.29556120e+00  3.82000373e+00  3.82000373e+00  3.82000373e+00
  8.19922461e+00  1.38782146e+01  1.38782146e+01  1.38782146e+01
  3.60993199e+01  5.09440607e+01  5.09440607e+01  5.09440607e+01
  1.38096324e+02  2.27836731e+02  2.27836731e+02  2.27836731e+02
  4.99445109e+02  1.86618009e+03  7.99608739e+03  4.77643638e+04]
E1 = -182.58992787859535  E_coul = 54.04879217444963
cycle= 4 E= -128.541135704146  delta_E= -1.9e-08  |g|= 7.33e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183512
diis-c [-7.63188716e-10  1.81954018e-04  4.94654199e-04 -1.55328607e-01
  1.15465200e+00]
  HOMO = -0.848841929238835  LUMO = 0.795224988293289
  mo_energy =
[-3.27704839e+01 -1.92910409e+00 -8.48841929e-01 -8.48841929e-01
 -8.48841929e-01  7.95224988e-01  7.95224988e-01  7.95224988e-01
  1.29554338e+00  3.81996827e+00  3.81996827e+00  3.81996827e+00
  8.19918209e+00  1.38781607e+01  1.38781607e+01  1.38781607e+01
  3.60992590e+01  5.09439956e+01  5.09439956e+01  5.09439956e+01
  1.38096254e+02  2.27836657e+02  2.27836657e+02  2.27836657e+02
  4.99445031e+02  1.86618000e+03  7.99608730e+03  4.77643637e+04]
E1 = -182.5900708907759  E_coul = 54.04893518611864
cycle= 5 E= -128.541135704657  delta_E= -5.12e-10  |g|= 4.27e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5900708907759  E_coul = 54.04893518611864
  HOMO = -0.848839852525942  LUMO = 0.795225589002483
  mo_energy =
[-3.27704794e+01 -1.92910134e+00 -8.48839853e-01 -8.48839853e-01
 -8.48839853e-01  7.95225589e-01  7.95225589e-01  7.95225589e-01
  1.29554485e+00  3.81997024e+00  3.81997024e+00  3.81997024e+00
  8.19918511e+00  1.38781641e+01  1.38781641e+01  1.38781641e+01
  3.60992632e+01  5.09439999e+01  5.09439999e+01  5.09439999e+01
  1.38096258e+02  2.27836661e+02  2.27836661e+02  2.27836661e+02
  4.99445035e+02  1.86618001e+03  7.99608730e+03  4.77643637e+04]
E1 = -182.59006035572796  E_coul = 54.0489246510696
Extra cycle  E= -128.541135704658  delta_E= -1.08e-12  |g|= 1.5e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264228e+02 2.35854337e+02
 7.55784406e+01 9.84358628e+00 2.63073230e+01 3.97966701e-01
 1.20289798e+00 3.34721917e+00 6.92198879e+00 2.22862432e+01
 9.42734831e+01 2.63650167e-01 2.39077788e+00 8.21021757e-01]
E = -128.54113570465836
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941254        1
[INPUT] 0    0    [1    /1   ]  3661.45471665        1
[INPUT] 0    0    [1    /1   ]  833.264227549        1
[INPUT] 0    0    [1    /1   ]  235.854337214        1
[INPUT] 0    0    [1    /1   ]  75.5784406464        1
[INPUT] 0    0    [1    /1   ]  9.84358628038        1
[INPUT] 0    0    [1    /1   ]  26.3073229882        1
[INPUT] 0    0    [1    /1   ]  0.397966700774       1
[INPUT] 0    0    [1    /1   ]  1.20289797546        1
[INPUT] 0    0    [1    /1   ]  3.34721917212        1
[INPUT] 1    0    [1    /1   ]  6.92198879125        1
[INPUT] 1    0    [1    /1   ]  22.2862432118        1
[INPUT] 1    0    [1    /1   ]  94.2734830606        1
[INPUT] 1    0    [1    /1   ]  0.263650167031       1
[INPUT] 1    0    [1    /1   ]  2.39077787768        1
[INPUT] 1    0    [1    /1   ]  0.821021757484       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125399378, 1.0]], [0, [3661.454716650323, 1.0]], [0, [833.2642275490351, 1.0]], [0, [235.85433721431755, 1.0]], [0, [75.57844064644294, 1.0]], [0, [9.84358628038495, 1.0]], [0, [26.307322988171002, 1.0]], [0, [0.39796670077389557, 1.0]], [0, [1.2028979754598934, 1.0]], [0, [3.347219172115044, 1.0]], [1, [6.921988791246353, 1.0]], [1, [22.286243211833195, 1.0]], [1, [94.27348306063035, 1.0]], [1, [0.2636501670305741, 1.0]], [1, [2.390777877682989, 1.0]], [1, [0.8210217574843183, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941254]
bas 1, expnt(s) = [3661.45471665]
bas 2, expnt(s) = [833.26422755]
bas 3, expnt(s) = [235.85433721]
bas 4, expnt(s) = [75.57844065]
bas 5, expnt(s) = [9.84358628]
bas 6, expnt(s) = [26.30732299]
bas 7, expnt(s) = [0.3979667]
bas 8, expnt(s) = [1.20289798]
bas 9, expnt(s) = [3.34721917]
bas 10, expnt(s) = [6.92198879]
bas 11, expnt(s) = [22.28624321]
bas 12, expnt(s) = [94.27348306]
bas 13, expnt(s) = [0.26365017]
bas 14, expnt(s) = [2.39077788]
bas 15, expnt(s) = [0.82102176]
CPU time:       221.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145472e+03 1.18920102e+03
 8.33264228e+02 3.91833964e+02 2.35854337e+02 1.52054026e+02
 7.55784406e+01 6.47609886e+01 9.84358628e+00 1.40404180e+01
 2.63073230e+01 2.93475950e+01 3.97966701e-01 1.26590197e+00
 1.20289798e+00 2.90192791e+00 3.34721917e+00 6.25213198e+00
 6.92198879e+00 3.27546533e+01 2.22862432e+01 1.41263667e+02
 9.42734831e+01 8.56981277e+02 2.63650167e-01 5.51149549e-01
 2.39077788e+00 8.67278196e+00 8.21021757e-01 2.27996261e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999581342150499
cond(S) = 391.26673459941424
E1 = -183.58932807010507  E_coul = 55.080247092987236
init E= -128.509080977118
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775395686435932  LUMO = 0.812859482512828
  mo_energy =
[-3.25550462e+01 -1.85250485e+00 -7.75395686e-01 -7.75395686e-01
 -7.75395686e-01  8.12859483e-01  8.12859483e-01  8.12859483e-01
  1.32939412e+00  3.88483648e+00  3.88483648e+00  3.88483648e+00
  8.29396507e+00  1.40042363e+01  1.40042363e+01  1.40042363e+01
  3.62634832e+01  5.11296294e+01  5.11296294e+01  5.11296294e+01
  1.38307726e+02  2.28068274e+02  2.28068274e+02  2.28068274e+02
  4.99690190e+02  1.86645618e+03  7.99639016e+03  4.77646845e+04]
E1 = -182.08646749388134  E_coul = 53.54883694616804
cycle= 1 E= -128.537630547713  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512561
diis-c [-0.26271926  1.        ]
  HOMO = -0.884189142715823  LUMO = 0.786708092586348
  mo_energy =
[-3.28780644e+01 -1.96641931e+00 -8.84189143e-01 -8.84189143e-01
 -8.84189143e-01  7.86708093e-01  7.86708093e-01  7.86708093e-01
  1.27959612e+00  3.78909011e+00  3.78909011e+00  3.78909011e+00
  8.15318091e+00  1.38161701e+01  1.38161701e+01  1.38161701e+01
  3.60170826e+01  5.08512548e+01  5.08512548e+01  5.08512548e+01
  1.37991038e+02  2.27724049e+02  2.27724049e+02  2.27724049e+02
  4.99328890e+02  1.86605872e+03  7.99596368e+03  4.77642392e+04]
E1 = -182.8478236514577  E_coul = 54.307607071628276
cycle= 2 E= -128.540216579829  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260287
diis-c [-6.55238619e-04  3.35983433e-01  6.64016567e-01]
  HOMO = -0.848560902194453  LUMO = 0.795267969878379
  mo_energy =
[-3.27699658e+01 -1.92888653e+00 -8.48560902e-01 -8.48560902e-01
 -8.48560902e-01  7.95267970e-01  7.95267970e-01  7.95267970e-01
  1.29563559e+00  3.82016740e+00  3.82016740e+00  3.82016740e+00
  8.19943941e+00  1.38785016e+01  1.38785016e+01  1.38785016e+01
  3.60996638e+01  5.09444518e+01  5.09444518e+01  5.09444518e+01
  1.38096773e+02  2.27837245e+02  2.27837245e+02  2.27837245e+02
  4.99445685e+02  1.86618080e+03  7.99608820e+03  4.77643647e+04]
E1 = -182.5894177781334  E_coul = 54.04828209297966
cycle= 3 E= -128.541135685154  delta_E= -0.000919  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113392
diis-c [-1.18960191e-07 -2.23390852e-03 -2.41582029e-04  1.00247549e+00]
  HOMO = -0.848803747874724  LUMO = 0.795236171370858
  mo_energy =
[-3.27704142e+01 -1.92907350e+00 -8.48803748e-01 -8.48803748e-01
 -8.48803748e-01  7.95236171e-01  7.95236171e-01  7.95236171e-01
  1.29556120e+00  3.82000373e+00  3.82000373e+00  3.82000373e+00
  8.19922461e+00  1.38782146e+01  1.38782146e+01  1.38782146e+01
  3.60993199e+01  5.09440607e+01  5.09440607e+01  5.09440607e+01
  1.38096324e+02  2.27836731e+02  2.27836731e+02  2.27836731e+02
  4.99445109e+02  1.86618009e+03  7.99608739e+03  4.77643638e+04]
E1 = -182.58992787859535  E_coul = 54.04879217444963
cycle= 4 E= -128.541135704146  delta_E= -1.9e-08  |g|= 7.33e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183512
diis-c [-7.63188716e-10  1.81954018e-04  4.94654199e-04 -1.55328607e-01
  1.15465200e+00]
  HOMO = -0.848841929238835  LUMO = 0.795224988293289
  mo_energy =
[-3.27704839e+01 -1.92910409e+00 -8.48841929e-01 -8.48841929e-01
 -8.48841929e-01  7.95224988e-01  7.95224988e-01  7.95224988e-01
  1.29554338e+00  3.81996827e+00  3.81996827e+00  3.81996827e+00
  8.19918209e+00  1.38781607e+01  1.38781607e+01  1.38781607e+01
  3.60992590e+01  5.09439956e+01  5.09439956e+01  5.09439956e+01
  1.38096254e+02  2.27836657e+02  2.27836657e+02  2.27836657e+02
  4.99445031e+02  1.86618000e+03  7.99608730e+03  4.77643637e+04]
E1 = -182.5900708907759  E_coul = 54.04893518611864
cycle= 5 E= -128.541135704657  delta_E= -5.12e-10  |g|= 4.27e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5900708907759  E_coul = 54.04893518611864
  HOMO = -0.848839852525942  LUMO = 0.795225589002483
  mo_energy =
[-3.27704794e+01 -1.92910134e+00 -8.48839853e-01 -8.48839853e-01
 -8.48839853e-01  7.95225589e-01  7.95225589e-01  7.95225589e-01
  1.29554485e+00  3.81997024e+00  3.81997024e+00  3.81997024e+00
  8.19918511e+00  1.38781641e+01  1.38781641e+01  1.38781641e+01
  3.60992632e+01  5.09439999e+01  5.09439999e+01  5.09439999e+01
  1.38096258e+02  2.27836661e+02  2.27836661e+02  2.27836661e+02
  4.99445035e+02  1.86618001e+03  7.99608730e+03  4.77643637e+04]
E1 = -182.59006035572796  E_coul = 54.0489246510696
Extra cycle  E= -128.541135704658  delta_E= -1.08e-12  |g|= 1.5e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 391.26673459941424
E1 = -182.59006035572796  E_coul = 54.0489246510696
init E= -128.541135704658
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848840603893093  LUMO = 0.795225421073649
  mo_energy =
[-3.27704817e+01 -1.92910201e+00 -8.48840604e-01 -8.48840604e-01
 -8.48840604e-01  7.95225421e-01  7.95225421e-01  7.95225421e-01
  1.29554460e+00  3.81996960e+00  3.81996960e+00  3.81996960e+00
  8.19918420e+00  1.38781627e+01  1.38781627e+01  1.38781627e+01
  3.60992614e+01  5.09439979e+01  5.09439979e+01  5.09439979e+01
  1.38096256e+02  2.27836659e+02  2.27836659e+02  2.27836659e+02
  4.99445032e+02  1.86618000e+03  7.99608730e+03  4.77643637e+04]
E1 = -182.59006622620007  E_coul = 54.04893052154112
cycle= 1 E= -128.541135704659  delta_E= -5.68e-13  |g|= 8.09e-07  |ddm|= 5.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59006622620007  E_coul = 54.04893052154112
  HOMO = -0.848840191875049  LUMO = 0.795225522566818
  mo_energy =
[-3.27704805e+01 -1.92910155e+00 -8.48840192e-01 -8.48840192e-01
 -8.48840192e-01  7.95225523e-01  7.95225523e-01  7.95225523e-01
  1.29554480e+00  3.81996997e+00  3.81996997e+00  3.81996997e+00
  8.19918475e+00  1.38781635e+01  1.38781635e+01  1.38781635e+01
  3.60992624e+01  5.09439990e+01  5.09439990e+01  5.09439990e+01
  1.38096257e+02  2.27836660e+02  2.27836660e+02  2.27836660e+02
  4.99445034e+02  1.86618001e+03  7.99608730e+03  4.77643637e+04]
E1 = -182.59006328553076  E_coul = 54.048927580871975
Extra cycle  E= -128.541135704659  delta_E= 1.42e-13  |g|= 3.99e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145472e+03 8.33264228e+02 2.35854337e+02
 7.55784406e+01 9.84358628e+00 2.63073230e+01 3.97966701e-01
 1.20289798e+00 3.34721917e+00 6.92198879e+00 2.22862432e+01
 9.42734831e+01 2.63650167e-01 2.39077788e+00 8.21021757e-01]
grad_E = [-3.66825009e-10  1.73159575e-08 -1.64160360e-07 -3.59320995e-06
  7.61311236e-05 -5.12509506e-05 -2.34424025e-04  1.02889245e-05
  7.20058630e-05  3.11339783e-04  3.60198281e-05 -4.62253361e-06
 -6.53497834e-06  2.34580494e-04 -7.84770063e-05  1.86746842e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941254        1
[INPUT] 0    0    [1    /1   ]  3661.45471445        1
[INPUT] 0    0    [1    /1   ]  833.264286227        1
[INPUT] 0    0    [1    /1   ]  235.853347137        1
[INPUT] 0    0    [1    /1   ]  75.5853918207        1
[INPUT] 0    0    [1    /1   ]  9.84796899612        1
[INPUT] 0    0    [1    /1   ]  26.3124451817        1
[INPUT] 0    0    [1    /1   ]  0.397827458869       1
[INPUT] 0    0    [1    /1   ]  1.20224090775        1
[INPUT] 0    0    [1    /1   ]  3.34201520671        1
[INPUT] 1    0    [1    /1   ]  6.90414444117        1
[INPUT] 1    0    [1    /1   ]  22.2226586612        1
[INPUT] 1    0    [1    /1   ]  93.9542361251        1
[INPUT] 1    0    [1    /1   ]  0.263301937095       1
[INPUT] 1    0    [1    /1   ]  2.38613247696        1
[INPUT] 1    0    [1    /1   ]  0.819783894652       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125440534, 1.0]], [0, [3661.4547144486664, 1.0]], [0, [833.2642862267535, 1.0]], [0, [235.85334713727553, 1.0]], [0, [75.5853918206823, 1.0]], [0, [9.84796899611523, 1.0]], [0, [26.31244518174144, 1.0]], [0, [0.39782745886867615, 1.0]], [0, [1.2022409077524243, 1.0]], [0, [3.342015206710335, 1.0]], [1, [6.904144441172841, 1.0]], [1, [22.222658661208982, 1.0]], [1, [93.95423612514259, 1.0]], [1, [0.2633019370947343, 1.0]], [1, [2.38613247696309, 1.0]], [1, [0.8197838946524806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412544]
bas 1, expnt(s) = [3661.45471445]
bas 2, expnt(s) = [833.26428623]
bas 3, expnt(s) = [235.85334714]
bas 4, expnt(s) = [75.58539182]
bas 5, expnt(s) = [9.847969]
bas 6, expnt(s) = [26.31244518]
bas 7, expnt(s) = [0.39782746]
bas 8, expnt(s) = [1.20224091]
bas 9, expnt(s) = [3.34201521]
bas 10, expnt(s) = [6.90414444]
bas 11, expnt(s) = [22.22265866]
bas 12, expnt(s) = [93.95423613]
bas 13, expnt(s) = [0.26330194]
bas 14, expnt(s) = [2.38613248]
bas 15, expnt(s) = [0.81978389]
CPU time:       224.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33264286e+02 3.91833985e+02 2.35853347e+02 1.52053548e+02
 7.55853918e+01 6.47654557e+01 9.84796900e+00 1.40451062e+01
 2.63124452e+01 2.93518805e+01 3.97827459e-01 1.26556977e+00
 1.20224091e+00 2.90073897e+00 3.34201521e+00 6.24484036e+00
 6.90414444e+00 3.26491387e+01 2.22226587e+01 1.40760050e+02
 9.39542361e+01 8.53355221e+02 2.63301937e-01 5.50239749e-01
 2.38613248e+00 8.65172252e+00 8.19783895e-01 2.27566652e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584197530893
cond(S) = 390.73792301148717
E1 = -183.58932049343434  E_coul = 55.080247470499515
init E= -128.509073022935
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775395391932765  LUMO = 0.811479310998657
  mo_energy =
[-3.25550474e+01 -1.85250521e+00 -7.75395392e-01 -7.75395392e-01
 -7.75395392e-01  8.11479311e-01  8.11479311e-01  8.11479311e-01
  1.32845226e+00  3.87773381e+00  3.87773381e+00  3.87773381e+00
  8.28541077e+00  1.39712752e+01  1.39712752e+01  1.39712752e+01
  3.62515675e+01  5.09788486e+01  5.09788486e+01  5.09788486e+01
  1.38315087e+02  2.27266129e+02  2.27266129e+02  2.27266129e+02
  4.99719607e+02  1.86649231e+03  7.99642390e+03  4.77647128e+04]
E1 = -182.08616954318222  E_coul = 53.54853975715381
cycle= 1 E= -128.537629786028  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512772
diis-c [-0.26293487  1.        ]
  HOMO = -0.884212566238412  LUMO = 0.785377850061113
  mo_energy =
[-3.28781160e+01 -1.96644668e+00 -8.84212566e-01 -8.84212566e-01
 -8.84212566e-01  7.85377850e-01  7.85377850e-01  7.85377850e-01
  1.27867463e+00  3.78211511e+00  3.78211511e+00  3.78211511e+00
  8.14467335e+00  1.37834015e+01  1.37834015e+01  1.37834015e+01
  3.60051161e+01  5.07006109e+01  5.07006109e+01  5.07006109e+01
  1.37998340e+02  2.26921970e+02  2.26921970e+02  2.26921970e+02
  4.99358255e+02  1.86609480e+03  7.99599736e+03  4.77642674e+04]
E1 = -182.84770498884572  E_coul = 54.307488459725406
cycle= 2 E= -128.54021652912  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260418
diis-c [-6.55183159e-04  3.36004449e-01  6.63995551e-01]
  HOMO = -0.848576643580419  LUMO = 0.793920965676272
  mo_energy =
[-3.27699971e+01 -1.92890567e+00 -8.48576644e-01 -8.48576644e-01
 -8.48576644e-01  7.93920966e-01  7.93920966e-01  7.93920966e-01
  1.29470594e+00  3.81314924e+00  3.81314924e+00  3.81314924e+00
  8.19091549e+00  1.38456679e+01  1.38456679e+01  1.38456679e+01
  3.60877168e+01  5.07937642e+01  5.07937642e+01  5.07937642e+01
  1.38104099e+02  2.27035158e+02  2.27035158e+02  2.27035158e+02
  4.99475071e+02  1.86621690e+03  7.99612190e+03  4.77643929e+04]
E1 = -182.5892209863073  E_coul = 54.048084886065915
cycle= 3 E= -128.541136100241  delta_E= -0.00092  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113365
diis-c [-1.18847129e-07 -2.23371446e-03 -2.43790455e-04  1.00247750e+00]
  HOMO = -0.848819768414111  LUMO = 0.793889126817031
  mo_energy =
[-3.27704456e+01 -1.92909306e+00 -8.48819768e-01 -8.48819768e-01
 -8.48819768e-01  7.93889127e-01  7.93889127e-01  7.93889127e-01
  1.29463126e+00  3.81298551e+00  3.81298551e+00  3.81298551e+00
  8.19070042e+00  1.38453809e+01  1.38453809e+01  1.38453809e+01
  3.60873726e+01  5.07933731e+01  5.07933731e+01  5.07933731e+01
  1.38103649e+02  2.27034644e+02  2.27034644e+02  2.27034644e+02
  4.99474495e+02  1.86621619e+03  7.99612110e+03  4.77643920e+04]
E1 = -182.5897299496088  E_coul = 54.04859383035175
cycle= 4 E= -128.541136119257  delta_E= -1.9e-08  |g|= 7.34e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018354
diis-c [-7.60727838e-10  1.81180214e-04  4.94498202e-04 -1.55025395e-01
  1.15434972e+00]
  HOMO = -0.848858006147433  LUMO = 0.793877938588388
  mo_energy =
[-3.27705154e+01 -1.92912375e+00 -8.48858006e-01 -8.48858006e-01
 -8.48858006e-01  7.93877939e-01  7.93877939e-01  7.93877939e-01
  1.29461338e+00  3.81295003e+00  3.81295003e+00  3.81295003e+00
  8.19065783e+00  1.38453269e+01  1.38453269e+01  1.38453269e+01
  3.60873117e+01  5.07933080e+01  5.07933080e+01  5.07933080e+01
  1.38103579e+02  2.27034570e+02  2.27034570e+02  2.27034570e+02
  4.99474417e+02  1.86621611e+03  7.99612101e+03  4.77643920e+04]
E1 = -182.5898728567387  E_coul = 54.04873673697043
cycle= 5 E= -128.541136119768  delta_E= -5.11e-10  |g|= 4.25e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5898728567387  E_coul = 54.04873673697043
  HOMO = -0.848855940825349  LUMO = 0.793878534505925
  mo_energy =
[-3.27705109e+01 -1.92912101e+00 -8.48855941e-01 -8.48855941e-01
 -8.48855941e-01  7.93878535e-01  7.93878535e-01  7.93878535e-01
  1.29461484e+00  3.81295199e+00  3.81295199e+00  3.81295199e+00
  8.19066084e+00  1.38453303e+01  1.38453303e+01  1.38453303e+01
  3.60873159e+01  5.07933123e+01  5.07933123e+01  5.07933123e+01
  1.38103584e+02  2.27034575e+02  2.27034575e+02  2.27034575e+02
  4.99474421e+02  1.86621611e+03  7.99612101e+03  4.77643920e+04]
E1 = -182.58986236513198  E_coul = 54.04872624536223
Extra cycle  E= -128.54113611977  delta_E= -1.48e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145471e+03 8.33264286e+02 2.35853347e+02
 7.55853918e+01 9.84796900e+00 2.63124452e+01 3.97827459e-01
 1.20224091e+00 3.34201521e+00 6.90414444e+00 2.22226587e+01
 9.39542361e+01 2.63301937e-01 2.38613248e+00 8.19783895e-01]
E = -128.54113611976976
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941254        1
[INPUT] 0    0    [1    /1   ]  3661.45471445        1
[INPUT] 0    0    [1    /1   ]  833.264286227        1
[INPUT] 0    0    [1    /1   ]  235.853347137        1
[INPUT] 0    0    [1    /1   ]  75.5853918207        1
[INPUT] 0    0    [1    /1   ]  9.84796899612        1
[INPUT] 0    0    [1    /1   ]  26.3124451817        1
[INPUT] 0    0    [1    /1   ]  0.397827458869       1
[INPUT] 0    0    [1    /1   ]  1.20224090775        1
[INPUT] 0    0    [1    /1   ]  3.34201520671        1
[INPUT] 1    0    [1    /1   ]  6.90414444117        1
[INPUT] 1    0    [1    /1   ]  22.2226586612        1
[INPUT] 1    0    [1    /1   ]  93.9542361251        1
[INPUT] 1    0    [1    /1   ]  0.263301937095       1
[INPUT] 1    0    [1    /1   ]  2.38613247696        1
[INPUT] 1    0    [1    /1   ]  0.819783894652       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125440534, 1.0]], [0, [3661.4547144486664, 1.0]], [0, [833.2642862267535, 1.0]], [0, [235.85334713727553, 1.0]], [0, [75.5853918206823, 1.0]], [0, [9.84796899611523, 1.0]], [0, [26.31244518174144, 1.0]], [0, [0.39782745886867615, 1.0]], [0, [1.2022409077524243, 1.0]], [0, [3.342015206710335, 1.0]], [1, [6.904144441172841, 1.0]], [1, [22.222658661208982, 1.0]], [1, [93.95423612514259, 1.0]], [1, [0.2633019370947343, 1.0]], [1, [2.38613247696309, 1.0]], [1, [0.8197838946524806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412544]
bas 1, expnt(s) = [3661.45471445]
bas 2, expnt(s) = [833.26428623]
bas 3, expnt(s) = [235.85334714]
bas 4, expnt(s) = [75.58539182]
bas 5, expnt(s) = [9.847969]
bas 6, expnt(s) = [26.31244518]
bas 7, expnt(s) = [0.39782746]
bas 8, expnt(s) = [1.20224091]
bas 9, expnt(s) = [3.34201521]
bas 10, expnt(s) = [6.90414444]
bas 11, expnt(s) = [22.22265866]
bas 12, expnt(s) = [93.95423613]
bas 13, expnt(s) = [0.26330194]
bas 14, expnt(s) = [2.38613248]
bas 15, expnt(s) = [0.81978389]
CPU time:       225.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33264286e+02 3.91833985e+02 2.35853347e+02 1.52053548e+02
 7.55853918e+01 6.47654557e+01 9.84796900e+00 1.40451062e+01
 2.63124452e+01 2.93518805e+01 3.97827459e-01 1.26556977e+00
 1.20224091e+00 2.90073897e+00 3.34201521e+00 6.24484036e+00
 6.90414444e+00 3.26491387e+01 2.22226587e+01 1.40760050e+02
 9.39542361e+01 8.53355221e+02 2.63301937e-01 5.50239749e-01
 2.38613248e+00 8.65172252e+00 8.19783895e-01 2.27566652e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584197530893
cond(S) = 390.73792301148717
E1 = -183.58932049343434  E_coul = 55.080247470499515
init E= -128.509073022935
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775395391932765  LUMO = 0.811479310998657
  mo_energy =
[-3.25550474e+01 -1.85250521e+00 -7.75395392e-01 -7.75395392e-01
 -7.75395392e-01  8.11479311e-01  8.11479311e-01  8.11479311e-01
  1.32845226e+00  3.87773381e+00  3.87773381e+00  3.87773381e+00
  8.28541077e+00  1.39712752e+01  1.39712752e+01  1.39712752e+01
  3.62515675e+01  5.09788486e+01  5.09788486e+01  5.09788486e+01
  1.38315087e+02  2.27266129e+02  2.27266129e+02  2.27266129e+02
  4.99719607e+02  1.86649231e+03  7.99642390e+03  4.77647128e+04]
E1 = -182.08616954318222  E_coul = 53.54853975715381
cycle= 1 E= -128.537629786028  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512772
diis-c [-0.26293487  1.        ]
  HOMO = -0.884212566238412  LUMO = 0.785377850061113
  mo_energy =
[-3.28781160e+01 -1.96644668e+00 -8.84212566e-01 -8.84212566e-01
 -8.84212566e-01  7.85377850e-01  7.85377850e-01  7.85377850e-01
  1.27867463e+00  3.78211511e+00  3.78211511e+00  3.78211511e+00
  8.14467335e+00  1.37834015e+01  1.37834015e+01  1.37834015e+01
  3.60051161e+01  5.07006109e+01  5.07006109e+01  5.07006109e+01
  1.37998340e+02  2.26921970e+02  2.26921970e+02  2.26921970e+02
  4.99358255e+02  1.86609480e+03  7.99599736e+03  4.77642674e+04]
E1 = -182.84770498884572  E_coul = 54.307488459725406
cycle= 2 E= -128.54021652912  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260418
diis-c [-6.55183159e-04  3.36004449e-01  6.63995551e-01]
  HOMO = -0.848576643580419  LUMO = 0.793920965676272
  mo_energy =
[-3.27699971e+01 -1.92890567e+00 -8.48576644e-01 -8.48576644e-01
 -8.48576644e-01  7.93920966e-01  7.93920966e-01  7.93920966e-01
  1.29470594e+00  3.81314924e+00  3.81314924e+00  3.81314924e+00
  8.19091549e+00  1.38456679e+01  1.38456679e+01  1.38456679e+01
  3.60877168e+01  5.07937642e+01  5.07937642e+01  5.07937642e+01
  1.38104099e+02  2.27035158e+02  2.27035158e+02  2.27035158e+02
  4.99475071e+02  1.86621690e+03  7.99612190e+03  4.77643929e+04]
E1 = -182.5892209863073  E_coul = 54.048084886065915
cycle= 3 E= -128.541136100241  delta_E= -0.00092  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113365
diis-c [-1.18847129e-07 -2.23371446e-03 -2.43790455e-04  1.00247750e+00]
  HOMO = -0.848819768414111  LUMO = 0.793889126817031
  mo_energy =
[-3.27704456e+01 -1.92909306e+00 -8.48819768e-01 -8.48819768e-01
 -8.48819768e-01  7.93889127e-01  7.93889127e-01  7.93889127e-01
  1.29463126e+00  3.81298551e+00  3.81298551e+00  3.81298551e+00
  8.19070042e+00  1.38453809e+01  1.38453809e+01  1.38453809e+01
  3.60873726e+01  5.07933731e+01  5.07933731e+01  5.07933731e+01
  1.38103649e+02  2.27034644e+02  2.27034644e+02  2.27034644e+02
  4.99474495e+02  1.86621619e+03  7.99612110e+03  4.77643920e+04]
E1 = -182.5897299496088  E_coul = 54.04859383035175
cycle= 4 E= -128.541136119257  delta_E= -1.9e-08  |g|= 7.34e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018354
diis-c [-7.60727838e-10  1.81180214e-04  4.94498202e-04 -1.55025395e-01
  1.15434972e+00]
  HOMO = -0.848858006147433  LUMO = 0.793877938588388
  mo_energy =
[-3.27705154e+01 -1.92912375e+00 -8.48858006e-01 -8.48858006e-01
 -8.48858006e-01  7.93877939e-01  7.93877939e-01  7.93877939e-01
  1.29461338e+00  3.81295003e+00  3.81295003e+00  3.81295003e+00
  8.19065783e+00  1.38453269e+01  1.38453269e+01  1.38453269e+01
  3.60873117e+01  5.07933080e+01  5.07933080e+01  5.07933080e+01
  1.38103579e+02  2.27034570e+02  2.27034570e+02  2.27034570e+02
  4.99474417e+02  1.86621611e+03  7.99612101e+03  4.77643920e+04]
E1 = -182.5898728567387  E_coul = 54.04873673697043
cycle= 5 E= -128.541136119768  delta_E= -5.11e-10  |g|= 4.25e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5898728567387  E_coul = 54.04873673697043
  HOMO = -0.848855940825349  LUMO = 0.793878534505925
  mo_energy =
[-3.27705109e+01 -1.92912101e+00 -8.48855941e-01 -8.48855941e-01
 -8.48855941e-01  7.93878535e-01  7.93878535e-01  7.93878535e-01
  1.29461484e+00  3.81295199e+00  3.81295199e+00  3.81295199e+00
  8.19066084e+00  1.38453303e+01  1.38453303e+01  1.38453303e+01
  3.60873159e+01  5.07933123e+01  5.07933123e+01  5.07933123e+01
  1.38103584e+02  2.27034575e+02  2.27034575e+02  2.27034575e+02
  4.99474421e+02  1.86621611e+03  7.99612101e+03  4.77643920e+04]
E1 = -182.58986236513198  E_coul = 54.04872624536223
Extra cycle  E= -128.54113611977  delta_E= -1.48e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 390.73792301148717
E1 = -182.58986236513198  E_coul = 54.04872624536223
init E= -128.54113611977
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848856689220602  LUMO = 0.793878367570229
  mo_energy =
[-3.27705132e+01 -1.92912168e+00 -8.48856689e-01 -8.48856689e-01
 -8.48856689e-01  7.93878368e-01  7.93878368e-01  7.93878368e-01
  1.29461459e+00  3.81295135e+00  3.81295135e+00  3.81295135e+00
  8.19065993e+00  1.38453290e+01  1.38453290e+01  1.38453290e+01
  3.60873141e+01  5.07933103e+01  5.07933103e+01  5.07933103e+01
  1.38103581e+02  2.27034572e+02  2.27034572e+02  2.27034572e+02
  4.99474419e+02  1.86621611e+03  7.99612101e+03  4.77643920e+04]
E1 = -182.58986821036984  E_coul = 54.04873209059986
cycle= 1 E= -128.54113611977  delta_E= -2.27e-13  |g|= 8.06e-07  |ddm|= 5.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58986821036984  E_coul = 54.04873209059986
  HOMO = -0.848856278980039  LUMO = 0.793878468407575
  mo_energy =
[-3.27705120e+01 -1.92912122e+00 -8.48856279e-01 -8.48856279e-01
 -8.48856279e-01  7.93878468e-01  7.93878468e-01  7.93878468e-01
  1.29461479e+00  3.81295171e+00  3.81295171e+00  3.81295171e+00
  8.19066048e+00  1.38453297e+01  1.38453297e+01  1.38453297e+01
  3.60873151e+01  5.07933114e+01  5.07933114e+01  5.07933114e+01
  1.38103583e+02  2.27034573e+02  2.27034573e+02  2.27034573e+02
  4.99474420e+02  1.86621611e+03  7.99612101e+03  4.77643920e+04]
E1 = -182.58986528197102  E_coul = 54.048729162200765
Extra cycle  E= -128.54113611977  delta_E= -2.56e-13  |g|= 3.98e-07  |ddm|= 2.92e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145471e+03 8.33264286e+02 2.35853347e+02
 7.55853918e+01 9.84796900e+00 2.63124452e+01 3.97827459e-01
 1.20224091e+00 3.34201521e+00 6.90414444e+00 2.22226587e+01
 9.39542361e+01 2.63301937e-01 2.38613248e+00 8.19783895e-01]
grad_E = [-3.39388322e-10  1.58892057e-08 -1.37021512e-07 -3.87215198e-06
  7.79025941e-05 -3.41482403e-05 -2.42653415e-04  6.65884063e-07
  7.11141804e-05  3.06337119e-04  8.29447325e-06 -8.64582477e-07
 -6.97042332e-06  1.68721615e-05 -3.71375727e-05  6.13852408e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45471231        1
[INPUT] 0    0    [1    /1   ]  833.264343417        1
[INPUT] 0    0    [1    /1   ]  235.852382631        1
[INPUT] 0    0    [1    /1   ]  75.5920460331        1
[INPUT] 0    0    [1    /1   ]  9.85059641911        1
[INPUT] 0    0    [1    /1   ]  26.3191510692        1
[INPUT] 0    0    [1    /1   ]  0.397670371868       1
[INPUT] 0    0    [1    /1   ]  1.20143274208        1
[INPUT] 0    0    [1    /1   ]  3.33648382558        1
[INPUT] 1    0    [1    /1   ]  6.88433906785        1
[INPUT] 1    0    [1    /1   ]  22.1517996541        1
[INPUT] 1    0    [1    /1   ]  93.6322870764        1
[INPUT] 1    0    [1    /1   ]  0.263005759789       1
[INPUT] 1    0    [1    /1   ]  2.38127028044        1
[INPUT] 1    0    [1    /1   ]  0.818545532926       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125480516, 1.0]], [0, [3661.45471231309, 1.0]], [0, [833.2643434173806, 1.0]], [0, [235.85238263133428, 1.0]], [0, [75.59204603305596, 1.0]], [0, [9.85059641911277, 1.0]], [0, [26.319151069198853, 1.0]], [0, [0.39767037186837617, 1.0]], [0, [1.2014327420762319, 1.0]], [0, [3.3364838255766167, 1.0]], [1, [6.884339067852401, 1.0]], [1, [22.151799654140888, 1.0]], [1, [93.63228707636272, 1.0]], [1, [0.2630057597888824, 1.0]], [1, [2.3812702804447783, 1.0]], [1, [0.8185455329262004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412548]
bas 1, expnt(s) = [3661.45471231]
bas 2, expnt(s) = [833.26434342]
bas 3, expnt(s) = [235.85238263]
bas 4, expnt(s) = [75.59204603]
bas 5, expnt(s) = [9.85059642]
bas 6, expnt(s) = [26.31915107]
bas 7, expnt(s) = [0.39767037]
bas 8, expnt(s) = [1.20143274]
bas 9, expnt(s) = [3.33648383]
bas 10, expnt(s) = [6.88433907]
bas 11, expnt(s) = [22.15179965]
bas 12, expnt(s) = [93.63228708]
bas 13, expnt(s) = [0.26300576]
bas 14, expnt(s) = [2.38127028]
bas 15, expnt(s) = [0.81854553]
CPU time:       228.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33264343e+02 3.91834005e+02 2.35852383e+02 1.52053081e+02
 7.55920460e+01 6.47697319e+01 9.85059642e+00 1.40479166e+01
 2.63191511e+01 2.93574907e+01 3.97670372e-01 1.26519495e+00
 1.20143274e+00 2.89927641e+00 3.33648383e+00 6.23708686e+00
 6.88433907e+00 3.25321082e+01 2.21517997e+01 1.40199241e+02
 9.36322871e+01 8.49701592e+02 2.63005760e-01 5.49466181e-01
 2.38127028e+00 8.62969124e+00 8.18545533e-01 2.27137032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958696828913
cond(S) = 390.11977623332336
E1 = -183.5893226772065  E_coul = 55.08024899546395
init E= -128.509073681743
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775394881257426  LUMO = 0.81023329051232
  mo_energy =
[-3.25550485e+01 -1.85250568e+00 -7.75394881e-01 -7.75394881e-01
 -7.75394881e-01  8.10233291e-01  8.10233291e-01  8.10233291e-01
  1.32736070e+00  3.87069909e+00  3.87069909e+00  3.87069909e+00
  8.27563541e+00  1.39363242e+01  1.39363242e+01  1.39363242e+01
  3.62352950e+01  5.08130124e+01  5.08130124e+01  5.08130124e+01
  1.38317642e+02  2.26430397e+02  2.26430397e+02  2.26430397e+02
  4.99745437e+02  1.86652540e+03  7.99645498e+03  4.77647389e+04]
E1 = -182.08595834308932  E_coul = 53.5483288901047
cycle= 1 E= -128.537629452985  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512992
diis-c [-0.2631611  1.       ]
  HOMO = -0.884228642784556  LUMO = 0.784181548159627
  mo_energy =
[-3.28781544e+01 -1.96646605e+00 -8.84228643e-01 -8.84228643e-01
 -8.84228643e-01  7.84181548e-01  7.84181548e-01  7.84181548e-01
  1.27761493e+00  3.77522286e+00  3.77522286e+00  3.77522286e+00
  8.13496609e+00  1.37486769e+01  1.37486769e+01  1.37486769e+01
  3.59888102e+01  5.05349464e+01  5.05349464e+01  5.05349464e+01
  1.38000849e+02  2.26086318e+02  2.26086318e+02  2.26086318e+02
  4.99384044e+02  1.86612785e+03  7.99602840e+03  4.77642935e+04]
E1 = -182.84763272611596  E_coul = 54.307415987568675
cycle= 2 E= -128.540216738547  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260548
diis-c [-6.55039339e-04  3.36020994e-01  6.63979006e-01]
  HOMO = -0.848586742329701  LUMO = 0.792708490328486
  mo_energy =
[-3.27700200e+01 -1.92891863e+00 -8.48586742e-01 -8.48586742e-01
 -8.48586742e-01  7.92708490e-01  7.92708490e-01  7.92708490e-01
  1.29363539e+00  3.80620988e+00  3.80620988e+00  3.80620988e+00
  8.18118535e+00  1.38108670e+01  1.38108670e+01  1.38108670e+01
  3.60714247e+01  5.06280445e+01  5.06280445e+01  5.06280445e+01
  1.38106627e+02  2.26199493e+02  2.26199493e+02  2.26199493e+02
  4.99500877e+02  1.86624997e+03  7.99615296e+03  4.77644190e+04]
E1 = -182.5890910828366  E_coul = 54.047954422011514
cycle= 3 E= -128.541136660825  delta_E= -0.00092  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113297
diis-c [-1.18721886e-07 -2.23246397e-03 -2.45646032e-04  1.00247811e+00]
  HOMO = -0.848829868335766  LUMO = 0.792676725475286
  mo_energy =
[-3.27704682e+01 -1.92910608e+00 -8.48829868e-01 -8.48829868e-01
 -8.48829868e-01  7.92676725e-01  7.92676725e-01  7.92676725e-01
  1.29356071e+00  3.80604639e+00  3.80604639e+00  3.80604639e+00
  8.18097038e+00  1.38105804e+01  1.38105804e+01  1.38105804e+01
  3.60710807e+01  5.06276538e+01  5.06276538e+01  5.06276538e+01
  1.38106177e+02  2.26198980e+02  2.26198980e+02  2.26198980e+02
  4.99500301e+02  1.86624926e+03  7.99615215e+03  4.77644181e+04]
E1 = -182.58959886919175  E_coul = 54.048462189357515
cycle= 4 E= -128.541136679834  delta_E= -1.9e-08  |g|= 7.34e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183567
diis-c [-7.60079459e-10  1.80777857e-04  4.94576943e-04 -1.54916180e-01
  1.15424082e+00]
  HOMO = -0.848868128507328  LUMO = 0.79266554672797
  mo_energy =
[-3.27705381e+01 -1.92913681e+00 -8.48868129e-01 -8.48868129e-01
 -8.48868129e-01  7.92665547e-01  7.92665547e-01  7.92665547e-01
  1.29354281e+00  3.80601092e+00  3.80601092e+00  3.80601092e+00
  8.18092778e+00  1.38105264e+01  1.38105264e+01  1.38105264e+01
  3.60710197e+01  5.06275887e+01  5.06275887e+01  5.06275887e+01
  1.38106107e+02  2.26198906e+02  2.26198906e+02  2.26198906e+02
  4.99500224e+02  1.86624917e+03  7.99615206e+03  4.77644180e+04]
E1 = -182.58974169792285  E_coul = 54.048605017577934
cycle= 5 E= -128.541136680345  delta_E= -5.11e-10  |g|= 4.24e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58974169792285  E_coul = 54.048605017577934
  HOMO = -0.848866069290576  LUMO = 0.792666139520168
  mo_energy =
[-3.27705335e+01 -1.92913408e+00 -8.48866069e-01 -8.48866069e-01
 -8.48866069e-01  7.92666140e-01  7.92666140e-01  7.92666140e-01
  1.29354427e+00  3.80601287e+00  3.80601287e+00  3.80601287e+00
  8.18093077e+00  1.38105298e+01  1.38105298e+01  1.38105298e+01
  3.60710239e+01  5.06275930e+01  5.06275930e+01  5.06275930e+01
  1.38106112e+02  2.26198910e+02  2.26198910e+02  2.26198910e+02
  4.99500228e+02  1.86624918e+03  7.99615207e+03  4.77644180e+04]
E1 = -182.58973122945747  E_coul = 54.04859454911111
Extra cycle  E= -128.541136680346  delta_E= -1.45e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145471e+03 8.33264343e+02 2.35852383e+02
 7.55920460e+01 9.85059642e+00 2.63191511e+01 3.97670372e-01
 1.20143274e+00 3.33648383e+00 6.88433907e+00 2.21517997e+01
 9.36322871e+01 2.63005760e-01 2.38127028e+00 8.18545533e-01]
E = -128.54113668034637
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45471231        1
[INPUT] 0    0    [1    /1   ]  833.264343417        1
[INPUT] 0    0    [1    /1   ]  235.852382631        1
[INPUT] 0    0    [1    /1   ]  75.5920460331        1
[INPUT] 0    0    [1    /1   ]  9.85059641911        1
[INPUT] 0    0    [1    /1   ]  26.3191510692        1
[INPUT] 0    0    [1    /1   ]  0.397670371868       1
[INPUT] 0    0    [1    /1   ]  1.20143274208        1
[INPUT] 0    0    [1    /1   ]  3.33648382558        1
[INPUT] 1    0    [1    /1   ]  6.88433906785        1
[INPUT] 1    0    [1    /1   ]  22.1517996541        1
[INPUT] 1    0    [1    /1   ]  93.6322870764        1
[INPUT] 1    0    [1    /1   ]  0.263005759789       1
[INPUT] 1    0    [1    /1   ]  2.38127028044        1
[INPUT] 1    0    [1    /1   ]  0.818545532926       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125480516, 1.0]], [0, [3661.45471231309, 1.0]], [0, [833.2643434173806, 1.0]], [0, [235.85238263133428, 1.0]], [0, [75.59204603305596, 1.0]], [0, [9.85059641911277, 1.0]], [0, [26.319151069198853, 1.0]], [0, [0.39767037186837617, 1.0]], [0, [1.2014327420762319, 1.0]], [0, [3.3364838255766167, 1.0]], [1, [6.884339067852401, 1.0]], [1, [22.151799654140888, 1.0]], [1, [93.63228707636272, 1.0]], [1, [0.2630057597888824, 1.0]], [1, [2.3812702804447783, 1.0]], [1, [0.8185455329262004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412548]
bas 1, expnt(s) = [3661.45471231]
bas 2, expnt(s) = [833.26434342]
bas 3, expnt(s) = [235.85238263]
bas 4, expnt(s) = [75.59204603]
bas 5, expnt(s) = [9.85059642]
bas 6, expnt(s) = [26.31915107]
bas 7, expnt(s) = [0.39767037]
bas 8, expnt(s) = [1.20143274]
bas 9, expnt(s) = [3.33648383]
bas 10, expnt(s) = [6.88433907]
bas 11, expnt(s) = [22.15179965]
bas 12, expnt(s) = [93.63228708]
bas 13, expnt(s) = [0.26300576]
bas 14, expnt(s) = [2.38127028]
bas 15, expnt(s) = [0.81854553]
CPU time:       229.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33264343e+02 3.91834005e+02 2.35852383e+02 1.52053081e+02
 7.55920460e+01 6.47697319e+01 9.85059642e+00 1.40479166e+01
 2.63191511e+01 2.93574907e+01 3.97670372e-01 1.26519495e+00
 1.20143274e+00 2.89927641e+00 3.33648383e+00 6.23708686e+00
 6.88433907e+00 3.25321082e+01 2.21517997e+01 1.40199241e+02
 9.36322871e+01 8.49701592e+02 2.63005760e-01 5.49466181e-01
 2.38127028e+00 8.62969124e+00 8.18545533e-01 2.27137032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958696828913
cond(S) = 390.11977623332336
E1 = -183.5893226772065  E_coul = 55.08024899546395
init E= -128.509073681743
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775394881257426  LUMO = 0.81023329051232
  mo_energy =
[-3.25550485e+01 -1.85250568e+00 -7.75394881e-01 -7.75394881e-01
 -7.75394881e-01  8.10233291e-01  8.10233291e-01  8.10233291e-01
  1.32736070e+00  3.87069909e+00  3.87069909e+00  3.87069909e+00
  8.27563541e+00  1.39363242e+01  1.39363242e+01  1.39363242e+01
  3.62352950e+01  5.08130124e+01  5.08130124e+01  5.08130124e+01
  1.38317642e+02  2.26430397e+02  2.26430397e+02  2.26430397e+02
  4.99745437e+02  1.86652540e+03  7.99645498e+03  4.77647389e+04]
E1 = -182.08595834308932  E_coul = 53.5483288901047
cycle= 1 E= -128.537629452985  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.512992
diis-c [-0.2631611  1.       ]
  HOMO = -0.884228642784556  LUMO = 0.784181548159627
  mo_energy =
[-3.28781544e+01 -1.96646605e+00 -8.84228643e-01 -8.84228643e-01
 -8.84228643e-01  7.84181548e-01  7.84181548e-01  7.84181548e-01
  1.27761493e+00  3.77522286e+00  3.77522286e+00  3.77522286e+00
  8.13496609e+00  1.37486769e+01  1.37486769e+01  1.37486769e+01
  3.59888102e+01  5.05349464e+01  5.05349464e+01  5.05349464e+01
  1.38000849e+02  2.26086318e+02  2.26086318e+02  2.26086318e+02
  4.99384044e+02  1.86612785e+03  7.99602840e+03  4.77642935e+04]
E1 = -182.84763272611596  E_coul = 54.307415987568675
cycle= 2 E= -128.540216738547  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260548
diis-c [-6.55039339e-04  3.36020994e-01  6.63979006e-01]
  HOMO = -0.848586742329701  LUMO = 0.792708490328486
  mo_energy =
[-3.27700200e+01 -1.92891863e+00 -8.48586742e-01 -8.48586742e-01
 -8.48586742e-01  7.92708490e-01  7.92708490e-01  7.92708490e-01
  1.29363539e+00  3.80620988e+00  3.80620988e+00  3.80620988e+00
  8.18118535e+00  1.38108670e+01  1.38108670e+01  1.38108670e+01
  3.60714247e+01  5.06280445e+01  5.06280445e+01  5.06280445e+01
  1.38106627e+02  2.26199493e+02  2.26199493e+02  2.26199493e+02
  4.99500877e+02  1.86624997e+03  7.99615296e+03  4.77644190e+04]
E1 = -182.5890910828366  E_coul = 54.047954422011514
cycle= 3 E= -128.541136660825  delta_E= -0.00092  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113297
diis-c [-1.18721886e-07 -2.23246397e-03 -2.45646032e-04  1.00247811e+00]
  HOMO = -0.848829868335766  LUMO = 0.792676725475286
  mo_energy =
[-3.27704682e+01 -1.92910608e+00 -8.48829868e-01 -8.48829868e-01
 -8.48829868e-01  7.92676725e-01  7.92676725e-01  7.92676725e-01
  1.29356071e+00  3.80604639e+00  3.80604639e+00  3.80604639e+00
  8.18097038e+00  1.38105804e+01  1.38105804e+01  1.38105804e+01
  3.60710807e+01  5.06276538e+01  5.06276538e+01  5.06276538e+01
  1.38106177e+02  2.26198980e+02  2.26198980e+02  2.26198980e+02
  4.99500301e+02  1.86624926e+03  7.99615215e+03  4.77644181e+04]
E1 = -182.58959886919175  E_coul = 54.048462189357515
cycle= 4 E= -128.541136679834  delta_E= -1.9e-08  |g|= 7.34e-05  |ddm|= 0.00019
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183567
diis-c [-7.60079459e-10  1.80777857e-04  4.94576943e-04 -1.54916180e-01
  1.15424082e+00]
  HOMO = -0.848868128507328  LUMO = 0.79266554672797
  mo_energy =
[-3.27705381e+01 -1.92913681e+00 -8.48868129e-01 -8.48868129e-01
 -8.48868129e-01  7.92665547e-01  7.92665547e-01  7.92665547e-01
  1.29354281e+00  3.80601092e+00  3.80601092e+00  3.80601092e+00
  8.18092778e+00  1.38105264e+01  1.38105264e+01  1.38105264e+01
  3.60710197e+01  5.06275887e+01  5.06275887e+01  5.06275887e+01
  1.38106107e+02  2.26198906e+02  2.26198906e+02  2.26198906e+02
  4.99500224e+02  1.86624917e+03  7.99615206e+03  4.77644180e+04]
E1 = -182.58974169792285  E_coul = 54.048605017577934
cycle= 5 E= -128.541136680345  delta_E= -5.11e-10  |g|= 4.24e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58974169792285  E_coul = 54.048605017577934
  HOMO = -0.848866069290576  LUMO = 0.792666139520168
  mo_energy =
[-3.27705335e+01 -1.92913408e+00 -8.48866069e-01 -8.48866069e-01
 -8.48866069e-01  7.92666140e-01  7.92666140e-01  7.92666140e-01
  1.29354427e+00  3.80601287e+00  3.80601287e+00  3.80601287e+00
  8.18093077e+00  1.38105298e+01  1.38105298e+01  1.38105298e+01
  3.60710239e+01  5.06275930e+01  5.06275930e+01  5.06275930e+01
  1.38106112e+02  2.26198910e+02  2.26198910e+02  2.26198910e+02
  4.99500228e+02  1.86624918e+03  7.99615207e+03  4.77644180e+04]
E1 = -182.58973122945747  E_coul = 54.04859454911111
Extra cycle  E= -128.541136680346  delta_E= -1.45e-12  |g|= 1.49e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 390.11977623332336
E1 = -182.58973122945747  E_coul = 54.04859454911111
init E= -128.541136680346
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.848866816115916  LUMO = 0.792665973263509
  mo_energy =
[-3.27705359e+01 -1.92913474e+00 -8.48866816e-01 -8.48866816e-01
 -8.48866816e-01  7.92665973e-01  7.92665973e-01  7.92665973e-01
  1.29354402e+00  3.80601224e+00  3.80601224e+00  3.80601224e+00
  8.18092987e+00  1.38105285e+01  1.38105285e+01  1.38105285e+01
  3.60710221e+01  5.06275910e+01  5.06275910e+01  5.06275910e+01
  1.38106109e+02  2.26198908e+02  2.26198908e+02  2.26198908e+02
  4.99500225e+02  1.86624917e+03  7.99615206e+03  4.77644180e+04]
E1 = -182.58973706134518  E_coul = 54.04860038099872
cycle= 1 E= -128.541136680346  delta_E= -8.53e-14  |g|= 8.04e-07  |ddm|= 5.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58973706134518  E_coul = 54.04860038099872
  HOMO = -0.848866406816078  LUMO = 0.792666073664522
  mo_energy =
[-3.27705346e+01 -1.92913429e+00 -8.48866407e-01 -8.48866407e-01
 -8.48866407e-01  7.92666074e-01  7.92666074e-01  7.92666074e-01
  1.29354422e+00  3.80601260e+00  3.80601260e+00  3.80601260e+00
  8.18093042e+00  1.38105292e+01  1.38105292e+01  1.38105292e+01
  3.60710231e+01  5.06275920e+01  5.06275920e+01  5.06275920e+01
  1.38106111e+02  2.26198909e+02  2.26198909e+02  2.26198909e+02
  4.99500226e+02  1.86624918e+03  7.99615207e+03  4.77644180e+04]
E1 = -182.58973413941283  E_coul = 54.04859745906627
Extra cycle  E= -128.541136680347  delta_E= -8.53e-14  |g|= 3.97e-07  |ddm|= 2.91e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145471e+03 8.33264343e+02 2.35852383e+02
 7.55920460e+01 9.85059642e+00 2.63191511e+01 3.97670372e-01
 1.20143274e+00 3.33648383e+00 6.88433907e+00 2.21517997e+01
 9.36322871e+01 2.63005760e-01 2.38127028e+00 8.18545533e-01]
grad_E = [-3.34969881e-10  1.56715435e-08 -1.33996840e-07 -3.86800236e-06
  7.75223775e-05 -3.00270790e-05 -2.42351715e-04 -2.03031924e-06
  7.13159445e-05  3.03430805e-04 -2.91775065e-05  2.75381690e-06
 -7.28263521e-06 -5.33818147e-06  4.50116339e-05  3.47613880e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45470916        1
[INPUT] 0    0    [1    /1   ]  833.264426692        1
[INPUT] 0    0    [1    /1   ]  235.851004517        1
[INPUT] 0    0    [1    /1   ]  75.6012725121        1
[INPUT] 0    0    [1    /1   ]  9.85359289437        1
[INPUT] 0    0    [1    /1   ]  26.3308429291        1
[INPUT] 0    0    [1    /1   ]  0.397391186785       1
[INPUT] 0    0    [1    /1   ]  1.19996482682        1
[INPUT] 0    0    [1    /1   ]  3.32689339881        1
[INPUT] 1    0    [1    /1   ]  6.85596959814        1
[INPUT] 1    0    [1    /1   ]  22.047819471         1
[INPUT] 1    0    [1    /1   ]  93.1598951913        1
[INPUT] 1    0    [1    /1   ]  0.262523397608       1
[INPUT] 1    0    [1    /1   ]  2.37419551303        1
[INPUT] 1    0    [1    /1   ]  0.816647896124       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412553968, 1.0]], [0, [3661.454709164152, 1.0]], [0, [833.2644266916419, 1.0]], [0, [235.851004516758, 1.0]], [0, [75.60127251207477, 1.0]], [0, [9.85359289436639, 1.0]], [0, [26.33084292912905, 1.0]], [0, [0.39739118678507246, 1.0]], [0, [1.1999648268154772, 1.0]], [0, [3.3268933988106277, 1.0]], [1, [6.855969598137369, 1.0]], [1, [22.047819470981146, 1.0]], [1, [93.1598951912533, 1.0]], [1, [0.2625233976075371, 1.0]], [1, [2.374195513031796, 1.0]], [1, [0.816647896124064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412554]
bas 1, expnt(s) = [3661.45470916]
bas 2, expnt(s) = [833.26442669]
bas 3, expnt(s) = [235.85100452]
bas 4, expnt(s) = [75.60127251]
bas 5, expnt(s) = [9.85359289]
bas 6, expnt(s) = [26.33084293]
bas 7, expnt(s) = [0.39739119]
bas 8, expnt(s) = [1.19996483]
bas 9, expnt(s) = [3.3268934]
bas 10, expnt(s) = [6.8559696]
bas 11, expnt(s) = [22.04781947]
bas 12, expnt(s) = [93.15989519]
bas 13, expnt(s) = [0.2625234]
bas 14, expnt(s) = [2.37419551]
bas 15, expnt(s) = [0.8166479]
CPU time:       232.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33264427e+02 3.91834034e+02 2.35851005e+02 1.52052415e+02
 7.56012725e+01 6.47756610e+01 9.85359289e+00 1.40511214e+01
 2.63308429e+01 2.93672713e+01 3.97391187e-01 1.26452872e+00
 1.19996483e+00 2.89661924e+00 3.32689340e+00 6.22363606e+00
 6.85596960e+00 3.23646188e+01 2.20478195e+01 1.39377108e+02
 9.31598952e+01 8.44346353e+02 2.62523398e-01 5.48206793e-01
 2.37419551e+00 8.59765457e+00 8.16647896e-01 2.26479007e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999591339970042
cond(S) = 389.02628509358874
E1 = -183.58932991630215  E_coul = 55.08025007400397
init E= -128.509079842298
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775394216349402  LUMO = 0.808253680631811
  mo_energy =
[-3.25550504e+01 -1.85250690e+00 -7.75394216e-01 -7.75394216e-01
 -7.75394216e-01  8.08253681e-01  8.08253681e-01  8.08253681e-01
  1.32540915e+00  3.86001924e+00  3.86001924e+00  3.86001924e+00
  8.25820594e+00  1.38853594e+01  1.38853594e+01  1.38853594e+01
  3.62039979e+01  5.05716713e+01  5.05716713e+01  5.05716713e+01
  1.38314956e+02  2.25206605e+02  2.25206605e+02  2.25206605e+02
  4.99778668e+02  1.86656986e+03  7.99649700e+03  4.77647742e+04]
E1 = -182.08559923803261  E_coul = 53.54797004358916
cycle= 1 E= -128.537629194443  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.513324
diis-c [-0.26350199  1.        ]
  HOMO = -0.884256286649077  LUMO = 0.782278503333577
  mo_energy =
[-3.28782187e+01 -1.96649935e+00 -8.84256287e-01 -8.84256287e-01
 -8.84256287e-01  7.82278503e-01  7.82278503e-01  7.82278503e-01
  1.27572099e+00  3.76474929e+00  3.76474929e+00  3.76474929e+00
  8.11766182e+00  1.36980309e+01  1.36980309e+01  1.36980309e+01
  3.59574620e+01  5.02938506e+01  5.02938506e+01  5.02938506e+01
  1.37998084e+02  2.24862635e+02  2.24862635e+02  2.24862635e+02
  4.99417206e+02  1.86617225e+03  7.99607036e+03  4.77643287e+04]
E1 = -182.84750626696726  E_coul = 54.30728887108159
cycle= 2 E= -128.540217395886  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0673
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260746
diis-c [-6.54801512e-04  3.36047527e-01  6.63952473e-01]
  HOMO = -0.848604332761663  LUMO = 0.790780401429099
  mo_energy =
[-3.27700581e+01 -1.92894117e+00 -8.48604333e-01 -8.48604333e-01
 -8.48604333e-01  7.90780401e-01  7.90780401e-01  7.90780401e-01
  1.29172168e+00  3.79566795e+00  3.79566795e+00  3.79566795e+00
  8.16383897e+00  1.37601136e+01  1.37601136e+01  1.37601136e+01
  3.60400976e+01  5.03868706e+01  5.03868706e+01  5.03868706e+01
  1.38103893e+02  2.24975794e+02  2.24975794e+02  2.24975794e+02
  4.99534069e+02  1.86629440e+03  7.99619495e+03  4.77644542e+04]
E1 = -182.58886681751497  E_coul = 54.047728908151676
cycle= 3 E= -128.541137909363  delta_E= -0.000921  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113234
diis-c [-1.18564088e-07 -2.23099579e-03 -2.47680959e-04  1.00247868e+00]
  HOMO = -0.84884758692416  LUMO = 0.790748708345874
  mo_energy =
[-3.27705062e+01 -1.92912886e+00 -8.48847587e-01 -8.48847587e-01
 -8.48847587e-01  7.90748708e-01  7.90748708e-01  7.90748708e-01
  1.29164691e+00  3.79550471e+00  3.79550471e+00  3.79550471e+00
  8.16362403e+00  1.37598274e+01  1.37598274e+01  1.37598274e+01
  3.60397535e+01  5.03864803e+01  5.03864803e+01  5.03864803e+01
  1.38103444e+02  2.24975281e+02  2.24975281e+02  2.24975281e+02
  4.99533494e+02  1.86629369e+03  7.99619414e+03  4.77644534e+04]
E1 = -182.58937307079242  E_coul = 54.048235142415386
cycle= 4 E= -128.541137928377  delta_E= -1.9e-08  |g|= 7.34e-05  |ddm|= 0.000191
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183621
diis-c [-7.58639159e-10  1.80044331e-04  4.94507075e-04 -1.54685229e-01
  1.15401068e+00]
  HOMO = -0.848885895318343  LUMO = 0.790737539200791
  mo_energy =
[-3.27705761e+01 -1.92915967e+00 -8.48885895e-01 -8.48885895e-01
 -8.48885895e-01  7.90737539e-01  7.90737539e-01  7.90737539e-01
  1.29162896e+00  3.79546925e+00  3.79546925e+00  3.79546925e+00
  8.16358139e+00  1.37597734e+01  1.37597734e+01  1.37597734e+01
  3.60396925e+01  5.03864152e+01  5.03864152e+01  5.03864152e+01
  1.38103374e+02  2.24975208e+02  2.24975208e+02  2.24975208e+02
  4.99533416e+02  1.86629360e+03  7.99619405e+03  4.77644533e+04]
E1 = -182.58951578387664  E_coul = 54.048377854988594
cycle= 5 E= -128.541137928888  delta_E= -5.11e-10  |g|= 4.22e-06  |ddm|= 2.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58951578387664  E_coul = 54.048377854988594
  HOMO = -0.848883846989726  LUMO = 0.790738126705207
  mo_energy =
[-3.27705715e+01 -1.92915695e+00 -8.48883847e-01 -8.48883847e-01
 -8.48883847e-01  7.90738127e-01  7.90738127e-01  7.90738127e-01
  1.29163041e+00  3.79547118e+00  3.79547118e+00  3.79547118e+00
  8.16358436e+00  1.37597767e+01  1.37597767e+01  1.37597767e+01
  3.60396966e+01  5.03864194e+01  5.03864194e+01  5.03864194e+01
  1.38103378e+02  2.24975212e+02  2.24975212e+02  2.24975212e+02
  4.99533420e+02  1.86629361e+03  7.99619406e+03  4.77644533e+04]
E1 = -182.5895053554031  E_coul = 54.04836742651334
Extra cycle  E= -128.54113792889  delta_E= -1.73e-12  |g|= 1.48e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145471e+03 8.33264427e+02 2.35851005e+02
 7.56012725e+01 9.85359289e+00 2.63308429e+01 3.97391187e-01
 1.19996483e+00 3.32689340e+00 6.85596960e+00 2.20478195e+01
 9.31598952e+01 2.62523398e-01 2.37419551e+00 8.16647896e-01]
E = -128.54113792888978
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45470916        1
[INPUT] 0    0    [1    /1   ]  833.264426692        1
[INPUT] 0    0    [1    /1   ]  235.851004517        1
[INPUT] 0    0    [1    /1   ]  75.6012725121        1
[INPUT] 0    0    [1    /1   ]  9.85359289437        1
[INPUT] 0    0    [1    /1   ]  26.3308429291        1
[INPUT] 0    0    [1    /1   ]  0.397391186785       1
[INPUT] 0    0    [1    /1   ]  1.19996482682        1
[INPUT] 0    0    [1    /1   ]  3.32689339881        1
[INPUT] 1    0    [1    /1   ]  6.85596959814        1
[INPUT] 1    0    [1    /1   ]  22.047819471         1
[INPUT] 1    0    [1    /1   ]  93.1598951913        1
[INPUT] 1    0    [1    /1   ]  0.262523397608       1
[INPUT] 1    0    [1    /1   ]  2.37419551303        1
[INPUT] 1    0    [1    /1   ]  0.816647896124       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412553968, 1.0]], [0, [3661.454709164152, 1.0]], [0, [833.2644266916419, 1.0]], [0, [235.851004516758, 1.0]], [0, [75.60127251207477, 1.0]], [0, [9.85359289436639, 1.0]], [0, [26.33084292912905, 1.0]], [0, [0.39739118678507246, 1.0]], [0, [1.1999648268154772, 1.0]], [0, [3.3268933988106277, 1.0]], [1, [6.855969598137369, 1.0]], [1, [22.047819470981146, 1.0]], [1, [93.1598951912533, 1.0]], [1, [0.2625233976075371, 1.0]], [1, [2.374195513031796, 1.0]], [1, [0.816647896124064, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412554]
bas 1, expnt(s) = [3661.45470916]
bas 2, expnt(s) = [833.26442669]
bas 3, expnt(s) = [235.85100452]
bas 4, expnt(s) = [75.60127251]
bas 5, expnt(s) = [9.85359289]
bas 6, expnt(s) = [26.33084293]
bas 7, expnt(s) = [0.39739119]
bas 8, expnt(s) = [1.19996483]
bas 9, expnt(s) = [3.3268934]
bas 10, expnt(s) = [6.8559696]
bas 11, expnt(s) = [22.04781947]
bas 12, expnt(s) = [93.15989519]
bas 13, expnt(s) = [0.2625234]
bas 14, expnt(s) = [2.37419551]
bas 15, expnt(s) = [0.8166479]
CPU time:       233.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33264427e+02 3.91834034e+02 2.35851005e+02 1.52052415e+02
 7.56012725e+01 6.47756610e+01 9.85359289e+00 1.40511214e+01
 2.63308429e+01 2.93672713e+01 3.97391187e-01 1.26452872e+00
 1.19996483e+00 2.89661924e+00 3.32689340e+00 6.22363606e+00
 6.85596960e+00 3.23646188e+01 2.20478195e+01 1.39377108e+02
 9.31598952e+01 8.44346353e+02 2.62523398e-01 5.48206793e-01
 2.37419551e+00 8.59765457e+00 8.16647896e-01 2.26479007e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999591339970042
cond(S) = 389.02628509358874
E1 = -183.58932991630215  E_coul = 55.08025007400397
init E= -128.509079842298
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775394216349402  LUMO = 0.808253680631811
  mo_energy =
[-3.25550504e+01 -1.85250690e+00 -7.75394216e-01 -7.75394216e-01
 -7.75394216e-01  8.08253681e-01  8.08253681e-01  8.08253681e-01
  1.32540915e+00  3.86001924e+00  3.86001924e+00  3.86001924e+00
  8.25820594e+00  1.38853594e+01  1.38853594e+01  1.38853594e+01
  3.62039979e+01  5.05716713e+01  5.05716713e+01  5.05716713e+01
  1.38314956e+02  2.25206605e+02  2.25206605e+02  2.25206605e+02
  4.99778668e+02  1.86656986e+03  7.99649700e+03  4.77647742e+04]
E1 = -182.08559923803261  E_coul = 53.54797004358916
cycle= 1 E= -128.537629194443  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.513324
diis-c [-0.26350199  1.        ]
  HOMO = -0.884256286649077  LUMO = 0.782278503333577
  mo_energy =
[-3.28782187e+01 -1.96649935e+00 -8.84256287e-01 -8.84256287e-01
 -8.84256287e-01  7.82278503e-01  7.82278503e-01  7.82278503e-01
  1.27572099e+00  3.76474929e+00  3.76474929e+00  3.76474929e+00
  8.11766182e+00  1.36980309e+01  1.36980309e+01  1.36980309e+01
  3.59574620e+01  5.02938506e+01  5.02938506e+01  5.02938506e+01
  1.37998084e+02  2.24862635e+02  2.24862635e+02  2.24862635e+02
  4.99417206e+02  1.86617225e+03  7.99607036e+03  4.77643287e+04]
E1 = -182.84750626696726  E_coul = 54.30728887108159
cycle= 2 E= -128.540217395886  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0673
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260746
diis-c [-6.54801512e-04  3.36047527e-01  6.63952473e-01]
  HOMO = -0.848604332761663  LUMO = 0.790780401429099
  mo_energy =
[-3.27700581e+01 -1.92894117e+00 -8.48604333e-01 -8.48604333e-01
 -8.48604333e-01  7.90780401e-01  7.90780401e-01  7.90780401e-01
  1.29172168e+00  3.79566795e+00  3.79566795e+00  3.79566795e+00
  8.16383897e+00  1.37601136e+01  1.37601136e+01  1.37601136e+01
  3.60400976e+01  5.03868706e+01  5.03868706e+01  5.03868706e+01
  1.38103893e+02  2.24975794e+02  2.24975794e+02  2.24975794e+02
  4.99534069e+02  1.86629440e+03  7.99619495e+03  4.77644542e+04]
E1 = -182.58886681751497  E_coul = 54.047728908151676
cycle= 3 E= -128.541137909363  delta_E= -0.000921  |g|= 0.000477  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113234
diis-c [-1.18564088e-07 -2.23099579e-03 -2.47680959e-04  1.00247868e+00]
  HOMO = -0.84884758692416  LUMO = 0.790748708345874
  mo_energy =
[-3.27705062e+01 -1.92912886e+00 -8.48847587e-01 -8.48847587e-01
 -8.48847587e-01  7.90748708e-01  7.90748708e-01  7.90748708e-01
  1.29164691e+00  3.79550471e+00  3.79550471e+00  3.79550471e+00
  8.16362403e+00  1.37598274e+01  1.37598274e+01  1.37598274e+01
  3.60397535e+01  5.03864803e+01  5.03864803e+01  5.03864803e+01
  1.38103444e+02  2.24975281e+02  2.24975281e+02  2.24975281e+02
  4.99533494e+02  1.86629369e+03  7.99619414e+03  4.77644534e+04]
E1 = -182.58937307079242  E_coul = 54.048235142415386
cycle= 4 E= -128.541137928377  delta_E= -1.9e-08  |g|= 7.34e-05  |ddm|= 0.000191
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183621
diis-c [-7.58639159e-10  1.80044331e-04  4.94507075e-04 -1.54685229e-01
  1.15401068e+00]
  HOMO = -0.848885895318343  LUMO = 0.790737539200791
  mo_energy =
[-3.27705761e+01 -1.92915967e+00 -8.48885895e-01 -8.48885895e-01
 -8.48885895e-01  7.90737539e-01  7.90737539e-01  7.90737539e-01
  1.29162896e+00  3.79546925e+00  3.79546925e+00  3.79546925e+00
  8.16358139e+00  1.37597734e+01  1.37597734e+01  1.37597734e+01
  3.60396925e+01  5.03864152e+01  5.03864152e+01  5.03864152e+01
  1.38103374e+02  2.24975208e+02  2.24975208e+02  2.24975208e+02
  4.99533416e+02  1.86629360e+03  7.99619405e+03  4.77644533e+04]
E1 = -182.58951578387664  E_coul = 54.048377854988594
cycle= 5 E= -128.541137928888  delta_E= -5.11e-10  |g|= 4.22e-06  |ddm|= 2.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58951578387664  E_coul = 54.048377854988594
  HOMO = -0.848883846989726  LUMO = 0.790738126705207
  mo_energy =
[-3.27705715e+01 -1.92915695e+00 -8.48883847e-01 -8.48883847e-01
 -8.48883847e-01  7.90738127e-01  7.90738127e-01  7.90738127e-01
  1.29163041e+00  3.79547118e+00  3.79547118e+00  3.79547118e+00
  8.16358436e+00  1.37597767e+01  1.37597767e+01  1.37597767e+01
  3.60396966e+01  5.03864194e+01  5.03864194e+01  5.03864194e+01
  1.38103378e+02  2.24975212e+02  2.24975212e+02  2.24975212e+02
  4.99533420e+02  1.86629361e+03  7.99619406e+03  4.77644533e+04]
E1 = -182.5895053554031  E_coul = 54.04836742651334
Extra cycle  E= -128.54113792889  delta_E= -1.73e-12  |g|= 1.48e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 389.02628509358874
E1 = -182.5895053554031  E_coul = 54.04836742651334
init E= -128.54113792889
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.848884591110993  LUMO = 0.790737961551478
  mo_energy =
[-3.27705739e+01 -1.92915761e+00 -8.48884591e-01 -8.48884591e-01
 -8.48884591e-01  7.90737962e-01  7.90737962e-01  7.90737962e-01
  1.29163016e+00  3.79547056e+00  3.79547056e+00  3.79547056e+00
  8.16358347e+00  1.37597754e+01  1.37597754e+01  1.37597754e+01
  3.60396949e+01  5.03864175e+01  5.03864175e+01  5.03864175e+01
  1.38103376e+02  2.24975210e+02  2.24975210e+02  2.24975210e+02
  4.99533417e+02  1.86629361e+03  7.99619405e+03  4.77644533e+04]
E1 = -182.5895111640167  E_coul = 54.048373235126945
cycle= 1 E= -128.54113792889  delta_E= 2.84e-14  |g|= 8.01e-07  |ddm|= 5.32e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5895111640167  E_coul = 54.048373235126945
  HOMO = -0.84888418345264  LUMO = 0.79073806123075
  mo_energy =
[-3.27705726e+01 -1.92915716e+00 -8.48884183e-01 -8.48884183e-01
 -8.48884183e-01  7.90738061e-01  7.90738061e-01  7.90738061e-01
  1.29163036e+00  3.79547092e+00  3.79547092e+00  3.79547092e+00
  8.16358401e+00  1.37597761e+01  1.37597761e+01  1.37597761e+01
  3.60396959e+01  5.03864185e+01  5.03864185e+01  5.03864185e+01
  1.38103377e+02  2.24975211e+02  2.24975211e+02  2.24975211e+02
  4.99533419e+02  1.86629361e+03  7.99619405e+03  4.77644533e+04]
E1 = -182.58950825333866  E_coul = 54.04837032444866
Extra cycle  E= -128.54113792889  delta_E= -2.56e-13  |g|= 3.95e-07  |ddm|= 2.89e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145471e+03 8.33264427e+02 2.35851005e+02
 7.56012725e+01 9.85359289e+00 2.63308429e+01 3.97391187e-01
 1.19996483e+00 3.32689340e+00 6.85596960e+00 2.20478195e+01
 9.31598952e+01 2.62523398e-01 2.37419551e+00 8.16647896e-01]
grad_E = [-3.48256723e-10  1.63893205e-08 -1.50125181e-07 -3.62543930e-06
  7.52580194e-05 -3.23029934e-05 -2.35745755e-04 -5.17105080e-06
  7.44767604e-05  2.99782180e-04 -7.71789615e-05  6.68605637e-06
 -7.68463791e-06 -9.12995707e-05  1.57459983e-04 -7.61474604e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45470429        1
[INPUT] 0    0    [1    /1   ]  833.264551862        1
[INPUT] 0    0    [1    /1   ]  235.84901771         1
[INPUT] 0    0    [1    /1   ]  75.6138296103        1
[INPUT] 0    0    [1    /1   ]  9.85795918731        1
[INPUT] 0    0    [1    /1   ]  26.351967273         1
[INPUT] 0    0    [1    /1   ]  0.396842402787       1
[INPUT] 0    0    [1    /1   ]  1.19705593611        1
[INPUT] 0    0    [1    /1   ]  3.30828774042        1
[INPUT] 1    0    [1    /1   ]  6.81507624276        1
[INPUT] 1    0    [1    /1   ]  21.894469883         1
[INPUT] 1    0    [1    /1   ]  92.4570803107        1
[INPUT] 1    0    [1    /1   ]  0.261813826611       1
[INPUT] 1    0    [1    /1   ]  2.36397922364        1
[INPUT] 1    0    [1    /1   ]  0.813861128261       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125631903, 1.0]], [0, [3661.454704286715, 1.0]], [0, [833.2645518619354, 1.0]], [0, [235.849017709857, 1.0]], [0, [75.61382961026717, 1.0]], [0, [9.857959187305307, 1.0]], [0, [26.351967272974072, 1.0]], [0, [0.39684240278686095, 1.0]], [0, [1.1970559361111137, 1.0]], [0, [3.308287740417908, 1.0]], [1, [6.815076242757542, 1.0]], [1, [21.894469883003215, 1.0]], [1, [92.45708031074786, 1.0]], [1, [0.26181382661094893, 1.0]], [1, [2.3639792236380144, 1.0]], [1, [0.8138611282605624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412563]
bas 1, expnt(s) = [3661.45470429]
bas 2, expnt(s) = [833.26455186]
bas 3, expnt(s) = [235.84901771]
bas 4, expnt(s) = [75.61382961]
bas 5, expnt(s) = [9.85795919]
bas 6, expnt(s) = [26.35196727]
bas 7, expnt(s) = [0.3968424]
bas 8, expnt(s) = [1.19705594]
bas 9, expnt(s) = [3.30828774]
bas 10, expnt(s) = [6.81507624]
bas 11, expnt(s) = [21.89446988]
bas 12, expnt(s) = [92.45708031]
bas 13, expnt(s) = [0.26181383]
bas 14, expnt(s) = [2.36397922]
bas 15, expnt(s) = [0.81386113]
CPU time:       236.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264552e+02 3.91834078e+02 2.35849018e+02 1.52051454e+02
 7.56138296e+01 6.47837301e+01 9.85795919e+00 1.40557908e+01
 2.63519673e+01 2.93849399e+01 3.96842403e-01 1.26321879e+00
 1.19705594e+00 2.89135127e+00 3.30828774e+00 6.19751349e+00
 6.81507624e+00 3.21234951e+01 2.18944699e+01 1.38166398e+02
 9.24570803e+01 8.36391501e+02 2.61813827e-01 5.46355243e-01
 2.36397922e+00 8.55143427e+00 8.13861128e-01 2.25513360e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99959796532877
cond(S) = 386.92735213221613
E1 = -183.5893469689813  E_coul = 55.08025076334799
init E= -128.509096205633
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775393153300853  LUMO = 0.805347213266774
  mo_energy =
[-3.25550534e+01 -1.85250961e+00 -7.75393153e-01 -7.75393153e-01
 -7.75393153e-01  8.05347213e-01  8.05347213e-01  8.05347213e-01
  1.32156592e+00  3.84442151e+00  3.84442151e+00  3.84442151e+00
  8.22390714e+00  1.38116650e+01  1.38116650e+01  1.38116650e+01
  3.61396760e+01  5.02196060e+01  5.02196060e+01  5.02196060e+01
  1.38297454e+02  2.23396135e+02  2.23396135e+02  2.23396135e+02
  4.99818921e+02  1.86662806e+03  7.99655254e+03  4.77648210e+04]
E1 = -182.08507419881036  E_coul = 53.547444197043404
cycle= 1 E= -128.537630001767  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.513817
diis-c [-0.26400824  1.        ]
  HOMO = -0.884296783238139  LUMO = 0.779484327351751
  mo_energy =
[-3.28783129e+01 -1.96654878e+00 -8.84296783e-01 -8.84296783e-01
 -8.84296783e-01  7.79484327e-01  7.79484327e-01  7.79484327e-01
  1.27200119e+00  3.74945188e+00  3.74945188e+00  3.74945188e+00
  8.08363121e+00  1.36247983e+01  1.36247983e+01  1.36247983e+01
  3.58930730e+01  4.99421509e+01  4.99421509e+01  4.99421509e+01
  1.37980462e+02  2.23052331e+02  2.23052331e+02  2.23052331e+02
  4.99457360e+02  1.86623035e+03  7.99612580e+03  4.77643754e+04]
E1 = -182.84732273689283  E_coul = 54.30710318684076
cycle= 2 E= -128.540219550052  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0672
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261037
diis-c [-6.54337588e-04  3.36085521e-01  6.63914479e-01]
  HOMO = -0.848630019353717  LUMO = 0.787949483628892
  mo_energy =
[-3.27701136e+01 -1.92897478e+00 -8.48630019e-01 -8.48630019e-01
 -8.48630019e-01  7.87949484e-01  7.87949484e-01  7.87949484e-01
  1.28796018e+00  3.78027111e+00  3.78027111e+00  3.78027111e+00
  8.12971815e+00  1.36867254e+01  1.36867254e+01  1.36867254e+01
  3.59757370e+01  5.00350548e+01  5.00350548e+01  5.00350548e+01
  1.38086320e+02  2.23165465e+02  2.23165465e+02  2.23165465e+02
  4.99574266e+02  1.86635254e+03  7.99625044e+03  4.77645009e+04]
E1 = -182.5885390793226  E_coul = 54.04739814677634
cycle= 3 E= -128.541140932546  delta_E= -0.000921  |g|= 0.000477  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113185
diis-c [-1.18381828e-07 -2.22896310e-03 -2.49292663e-04  1.00247826e+00]
  HOMO = -0.848873538502227  LUMO = 0.787917878138078
  mo_energy =
[-3.27705617e+01 -1.92916288e+00 -8.48873539e-01 -8.48873539e-01
 -8.48873539e-01  7.87917878e-01  7.87917878e-01  7.87917878e-01
  1.28788529e+00  3.78010815e+00  3.78010815e+00  3.78010815e+00
  8.12950326e+00  1.36864395e+01  1.36864395e+01  1.36864395e+01
  3.59753928e+01  5.00346649e+01  5.00346649e+01  5.00346649e+01
  1.38085870e+02  2.23164954e+02  2.23164954e+02  2.23164954e+02
  4.99573691e+02  1.86635183e+03  7.99624963e+03  4.77645001e+04]
E1 = -182.5890434140567  E_coul = 54.0479024624713
cycle= 4 E= -128.541140951585  delta_E= -1.9e-08  |g|= 7.35e-05  |ddm|= 0.000192
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183732
diis-c [-7.57039849e-10  1.79066300e-04  4.94321970e-04 -1.54385759e-01
  1.15371237e+00]
  HOMO = -0.848911926840545  LUMO = 0.78790672098587
  mo_energy =
[-3.27706316e+01 -1.92919382e+00 -8.48911927e-01 -8.48911927e-01
 -8.48911927e-01  7.87906721e-01  7.87906721e-01  7.87906721e-01
  1.28786730e+00  3.78007270e+00  3.78007270e+00  3.78007270e+00
  8.12946058e+00  1.36863856e+01  1.36863856e+01  1.36863856e+01
  3.59753318e+01  5.00345998e+01  5.00345998e+01  5.00345998e+01
  1.38085800e+02  2.23164880e+02  2.23164880e+02  2.23164880e+02
  4.99573613e+02  1.86635175e+03  7.99624954e+03  4.77645000e+04]
E1 = -182.58918596943514  E_coul = 54.0480450173381
cycle= 5 E= -128.541140952097  delta_E= -5.12e-10  |g|= 4.2e-06  |ddm|= 2.74e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58918596943514  E_coul = 54.0480450173381
  HOMO = -0.848909893752787  LUMO = 0.787907301004476
  mo_energy =
[-3.27706272e+01 -1.92919112e+00 -8.48909894e-01 -8.48909894e-01
 -8.48909894e-01  7.87907301e-01  7.87907301e-01  7.87907301e-01
  1.28786873e+00  3.78007461e+00  3.78007461e+00  3.78007461e+00
  8.12946353e+00  1.36863889e+01  1.36863889e+01  1.36863889e+01
  3.59753358e+01  5.00346040e+01  5.00346040e+01  5.00346040e+01
  1.38085805e+02  2.23164884e+02  2.23164884e+02  2.23164884e+02
  4.99573617e+02  1.86635175e+03  7.99624955e+03  4.77645000e+04]
E1 = -182.5891755969148  E_coul = 54.048034644816205
Extra cycle  E= -128.541140952099  delta_E= -1.56e-12  |g|= 1.47e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264552e+02 2.35849018e+02
 7.56138296e+01 9.85795919e+00 2.63519673e+01 3.96842403e-01
 1.19705594e+00 3.30828774e+00 6.81507624e+00 2.18944699e+01
 9.24570803e+01 2.61813827e-01 2.36397922e+00 8.13861128e-01]
E = -128.5411409520986
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45470429        1
[INPUT] 0    0    [1    /1   ]  833.264551862        1
[INPUT] 0    0    [1    /1   ]  235.84901771         1
[INPUT] 0    0    [1    /1   ]  75.6138296103        1
[INPUT] 0    0    [1    /1   ]  9.85795918731        1
[INPUT] 0    0    [1    /1   ]  26.351967273         1
[INPUT] 0    0    [1    /1   ]  0.396842402787       1
[INPUT] 0    0    [1    /1   ]  1.19705593611        1
[INPUT] 0    0    [1    /1   ]  3.30828774042        1
[INPUT] 1    0    [1    /1   ]  6.81507624276        1
[INPUT] 1    0    [1    /1   ]  21.894469883         1
[INPUT] 1    0    [1    /1   ]  92.4570803107        1
[INPUT] 1    0    [1    /1   ]  0.261813826611       1
[INPUT] 1    0    [1    /1   ]  2.36397922364        1
[INPUT] 1    0    [1    /1   ]  0.813861128261       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125631903, 1.0]], [0, [3661.454704286715, 1.0]], [0, [833.2645518619354, 1.0]], [0, [235.849017709857, 1.0]], [0, [75.61382961026717, 1.0]], [0, [9.857959187305307, 1.0]], [0, [26.351967272974072, 1.0]], [0, [0.39684240278686095, 1.0]], [0, [1.1970559361111137, 1.0]], [0, [3.308287740417908, 1.0]], [1, [6.815076242757542, 1.0]], [1, [21.894469883003215, 1.0]], [1, [92.45708031074786, 1.0]], [1, [0.26181382661094893, 1.0]], [1, [2.3639792236380144, 1.0]], [1, [0.8138611282605624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412563]
bas 1, expnt(s) = [3661.45470429]
bas 2, expnt(s) = [833.26455186]
bas 3, expnt(s) = [235.84901771]
bas 4, expnt(s) = [75.61382961]
bas 5, expnt(s) = [9.85795919]
bas 6, expnt(s) = [26.35196727]
bas 7, expnt(s) = [0.3968424]
bas 8, expnt(s) = [1.19705594]
bas 9, expnt(s) = [3.30828774]
bas 10, expnt(s) = [6.81507624]
bas 11, expnt(s) = [21.89446988]
bas 12, expnt(s) = [92.45708031]
bas 13, expnt(s) = [0.26181383]
bas 14, expnt(s) = [2.36397922]
bas 15, expnt(s) = [0.81386113]
CPU time:       237.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264552e+02 3.91834078e+02 2.35849018e+02 1.52051454e+02
 7.56138296e+01 6.47837301e+01 9.85795919e+00 1.40557908e+01
 2.63519673e+01 2.93849399e+01 3.96842403e-01 1.26321879e+00
 1.19705594e+00 2.89135127e+00 3.30828774e+00 6.19751349e+00
 6.81507624e+00 3.21234951e+01 2.18944699e+01 1.38166398e+02
 9.24570803e+01 8.36391501e+02 2.61813827e-01 5.46355243e-01
 2.36397922e+00 8.55143427e+00 8.13861128e-01 2.25513360e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99959796532877
cond(S) = 386.92735213221613
E1 = -183.5893469689813  E_coul = 55.08025076334799
init E= -128.509096205633
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775393153300853  LUMO = 0.805347213266774
  mo_energy =
[-3.25550534e+01 -1.85250961e+00 -7.75393153e-01 -7.75393153e-01
 -7.75393153e-01  8.05347213e-01  8.05347213e-01  8.05347213e-01
  1.32156592e+00  3.84442151e+00  3.84442151e+00  3.84442151e+00
  8.22390714e+00  1.38116650e+01  1.38116650e+01  1.38116650e+01
  3.61396760e+01  5.02196060e+01  5.02196060e+01  5.02196060e+01
  1.38297454e+02  2.23396135e+02  2.23396135e+02  2.23396135e+02
  4.99818921e+02  1.86662806e+03  7.99655254e+03  4.77648210e+04]
E1 = -182.08507419881036  E_coul = 53.547444197043404
cycle= 1 E= -128.537630001767  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.513817
diis-c [-0.26400824  1.        ]
  HOMO = -0.884296783238139  LUMO = 0.779484327351751
  mo_energy =
[-3.28783129e+01 -1.96654878e+00 -8.84296783e-01 -8.84296783e-01
 -8.84296783e-01  7.79484327e-01  7.79484327e-01  7.79484327e-01
  1.27200119e+00  3.74945188e+00  3.74945188e+00  3.74945188e+00
  8.08363121e+00  1.36247983e+01  1.36247983e+01  1.36247983e+01
  3.58930730e+01  4.99421509e+01  4.99421509e+01  4.99421509e+01
  1.37980462e+02  2.23052331e+02  2.23052331e+02  2.23052331e+02
  4.99457360e+02  1.86623035e+03  7.99612580e+03  4.77643754e+04]
E1 = -182.84732273689283  E_coul = 54.30710318684076
cycle= 2 E= -128.540219550052  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0672
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261037
diis-c [-6.54337588e-04  3.36085521e-01  6.63914479e-01]
  HOMO = -0.848630019353717  LUMO = 0.787949483628892
  mo_energy =
[-3.27701136e+01 -1.92897478e+00 -8.48630019e-01 -8.48630019e-01
 -8.48630019e-01  7.87949484e-01  7.87949484e-01  7.87949484e-01
  1.28796018e+00  3.78027111e+00  3.78027111e+00  3.78027111e+00
  8.12971815e+00  1.36867254e+01  1.36867254e+01  1.36867254e+01
  3.59757370e+01  5.00350548e+01  5.00350548e+01  5.00350548e+01
  1.38086320e+02  2.23165465e+02  2.23165465e+02  2.23165465e+02
  4.99574266e+02  1.86635254e+03  7.99625044e+03  4.77645009e+04]
E1 = -182.5885390793226  E_coul = 54.04739814677634
cycle= 3 E= -128.541140932546  delta_E= -0.000921  |g|= 0.000477  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113185
diis-c [-1.18381828e-07 -2.22896310e-03 -2.49292663e-04  1.00247826e+00]
  HOMO = -0.848873538502227  LUMO = 0.787917878138078
  mo_energy =
[-3.27705617e+01 -1.92916288e+00 -8.48873539e-01 -8.48873539e-01
 -8.48873539e-01  7.87917878e-01  7.87917878e-01  7.87917878e-01
  1.28788529e+00  3.78010815e+00  3.78010815e+00  3.78010815e+00
  8.12950326e+00  1.36864395e+01  1.36864395e+01  1.36864395e+01
  3.59753928e+01  5.00346649e+01  5.00346649e+01  5.00346649e+01
  1.38085870e+02  2.23164954e+02  2.23164954e+02  2.23164954e+02
  4.99573691e+02  1.86635183e+03  7.99624963e+03  4.77645001e+04]
E1 = -182.5890434140567  E_coul = 54.0479024624713
cycle= 4 E= -128.541140951585  delta_E= -1.9e-08  |g|= 7.35e-05  |ddm|= 0.000192
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183732
diis-c [-7.57039849e-10  1.79066300e-04  4.94321970e-04 -1.54385759e-01
  1.15371237e+00]
  HOMO = -0.848911926840545  LUMO = 0.78790672098587
  mo_energy =
[-3.27706316e+01 -1.92919382e+00 -8.48911927e-01 -8.48911927e-01
 -8.48911927e-01  7.87906721e-01  7.87906721e-01  7.87906721e-01
  1.28786730e+00  3.78007270e+00  3.78007270e+00  3.78007270e+00
  8.12946058e+00  1.36863856e+01  1.36863856e+01  1.36863856e+01
  3.59753318e+01  5.00345998e+01  5.00345998e+01  5.00345998e+01
  1.38085800e+02  2.23164880e+02  2.23164880e+02  2.23164880e+02
  4.99573613e+02  1.86635175e+03  7.99624954e+03  4.77645000e+04]
E1 = -182.58918596943514  E_coul = 54.0480450173381
cycle= 5 E= -128.541140952097  delta_E= -5.12e-10  |g|= 4.2e-06  |ddm|= 2.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58918596943514  E_coul = 54.0480450173381
  HOMO = -0.848909893752787  LUMO = 0.787907301004476
  mo_energy =
[-3.27706272e+01 -1.92919112e+00 -8.48909894e-01 -8.48909894e-01
 -8.48909894e-01  7.87907301e-01  7.87907301e-01  7.87907301e-01
  1.28786873e+00  3.78007461e+00  3.78007461e+00  3.78007461e+00
  8.12946353e+00  1.36863889e+01  1.36863889e+01  1.36863889e+01
  3.59753358e+01  5.00346040e+01  5.00346040e+01  5.00346040e+01
  1.38085805e+02  2.23164884e+02  2.23164884e+02  2.23164884e+02
  4.99573617e+02  1.86635175e+03  7.99624955e+03  4.77645000e+04]
E1 = -182.5891755969148  E_coul = 54.048034644816205
Extra cycle  E= -128.541140952099  delta_E= -1.56e-12  |g|= 1.47e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 386.92735213221613
E1 = -182.5891755969148  E_coul = 54.048034644816205
init E= -128.541140952099
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.848910634107727  LUMO = 0.787907137421699
  mo_energy =
[-3.27706295e+01 -1.92919178e+00 -8.48910634e-01 -8.48910634e-01
 -8.48910634e-01  7.87907137e-01  7.87907137e-01  7.87907137e-01
  1.28786848e+00  3.78007399e+00  3.78007399e+00  3.78007399e+00
  8.12946264e+00  1.36863876e+01  1.36863876e+01  1.36863876e+01
  3.59753341e+01  5.00346021e+01  5.00346021e+01  5.00346021e+01
  1.38085802e+02  2.23164882e+02  2.23164882e+02  2.23164882e+02
  4.99573614e+02  1.86635175e+03  7.99624954e+03  4.77645000e+04]
E1 = -182.58918137307919  E_coul = 54.048040420980406
cycle= 1 E= -128.541140952099  delta_E= -1.71e-13  |g|= 7.96e-07  |ddm|= 5.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58918137307919  E_coul = 54.048040420980406
  HOMO = -0.848910228741198  LUMO = 0.78790723607602
  mo_energy =
[-3.27706283e+01 -1.92919132e+00 -8.48910229e-01 -8.48910229e-01
 -8.48910229e-01  7.87907236e-01  7.87907236e-01  7.87907236e-01
  1.28786868e+00  3.78007435e+00  3.78007435e+00  3.78007435e+00
  8.12946318e+00  1.36863883e+01  1.36863883e+01  1.36863883e+01
  3.59753351e+01  5.00346031e+01  5.00346031e+01  5.00346031e+01
  1.38085804e+02  2.23164883e+02  2.23164883e+02  2.23164883e+02
  4.99573615e+02  1.86635175e+03  7.99624954e+03  4.77645000e+04]
E1 = -182.58917847808652  E_coul = 54.048037525988
Extra cycle  E= -128.541140952099  delta_E= 2.56e-13  |g|= 3.93e-07  |ddm|= 2.87e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.41 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264552e+02 2.35849018e+02
 7.56138296e+01 9.85795919e+00 2.63519673e+01 3.96842403e-01
 1.19705594e+00 3.30828774e+00 6.81507624e+00 2.18944699e+01
 9.24570803e+01 2.61813827e-01 2.36397922e+00 8.13861128e-01]
grad_E = [-3.97194596e-10  1.89859421e-08 -2.04232998e-07 -2.92622785e-06
  6.96105961e-05 -4.28625012e-05 -2.18853681e-04 -1.15640882e-05
  8.34521798e-05  2.93323654e-04 -1.41613509e-04  1.11942948e-05
 -8.25935526e-06 -1.92394916e-04  3.18765951e-04 -2.09671790e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941258        1
[INPUT] 0    0    [1    /1   ]  3661.45469679        1
[INPUT] 0    0    [1    /1   ]  833.264733255        1
[INPUT] 0    0    [1    /1   ]  235.846380543        1
[INPUT] 0    0    [1    /1   ]  75.6284010345        1
[INPUT] 0    0    [1    /1   ]  9.86560596807        1
[INPUT] 0    0    [1    /1   ]  26.3908962489        1
[INPUT] 0    0    [1    /1   ]  0.395686672616       1
[INPUT] 0    0    [1    /1   ]  1.19093736501        1
[INPUT] 0    0    [1    /1   ]  3.26993136982        1
[INPUT] 1    0    [1    /1   ]  6.75844647123        1
[INPUT] 1    0    [1    /1   ]  21.6793569834        1
[INPUT] 1    0    [1    /1   ]  91.4735126663        1
[INPUT] 1    0    [1    /1   ]  0.260796364867       1
[INPUT] 1    0    [1    /1   ]  2.34981592692        1
[INPUT] 1    0    [1    /1   ]  0.809926914882       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125775126, 1.0]], [0, [3661.4546967938873, 1.0]], [0, [833.2647332553217, 1.0]], [0, [235.8463805432428, 1.0]], [0, [75.62840103451963, 1.0]], [0, [9.8656059680714, 1.0]], [0, [26.390896248900326, 1.0]], [0, [0.3956866726158262, 1.0]], [0, [1.1909373650072772, 1.0]], [0, [3.269931369815899, 1.0]], [1, [6.758446471232899, 1.0]], [1, [21.679356983385638, 1.0]], [1, [91.4735126662676, 1.0]], [1, [0.2607963648672295, 1.0]], [1, [2.3498159269179006, 1.0]], [1, [0.80992691488155, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412578]
bas 1, expnt(s) = [3661.45469679]
bas 2, expnt(s) = [833.26473326]
bas 3, expnt(s) = [235.84638054]
bas 4, expnt(s) = [75.62840103]
bas 5, expnt(s) = [9.86560597]
bas 6, expnt(s) = [26.39089625]
bas 7, expnt(s) = [0.39568667]
bas 8, expnt(s) = [1.19093737]
bas 9, expnt(s) = [3.26993137]
bas 10, expnt(s) = [6.75844647]
bas 11, expnt(s) = [21.67935698]
bas 12, expnt(s) = [91.47351267]
bas 13, expnt(s) = [0.26079636]
bas 14, expnt(s) = [2.34981593]
bas 15, expnt(s) = [0.80992691]
CPU time:       241.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264733e+02 3.91834142e+02 2.35846381e+02 1.52050179e+02
 7.56284010e+01 6.47930931e+01 9.86560597e+00 1.40639673e+01
 2.63908962e+01 2.94174910e+01 3.95686673e-01 1.26045862e+00
 1.19093737e+00 2.88026015e+00 3.26993137e+00 6.14354442e+00
 6.75844647e+00 3.17901803e+01 2.16793570e+01 1.36471633e+02
 9.14735127e+01 8.25284310e+02 2.60796365e-01 5.43702475e-01
 2.34981593e+00 8.48743959e+00 8.09926915e-01 2.24151517e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999607916448348
cond(S) = 382.73123666861323
E1 = -183.5893813886054  E_coul = 55.08024948825224
init E= -128.509131900353
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775391513299789  LUMO = 0.80120806628177
  mo_energy =
[-3.25550586e+01 -1.85251571e+00 -7.75391513e-01 -7.75391513e-01
 -7.75391513e-01  8.01208066e-01  8.01208066e-01  8.01208066e-01
  1.31350487e+00  3.82249014e+00  3.82249014e+00  3.82249014e+00
  8.15231963e+00  1.37093159e+01  1.37093159e+01  1.37093159e+01
  3.60017162e+01  4.97290140e+01  4.97290140e+01  4.97290140e+01
  1.38238379e+02  2.20865132e+02  2.20865132e+02  2.20865132e+02
  4.99852458e+02  1.86668987e+03  7.99661305e+03  4.77648722e+04]
E1 = -182.08431193584664  E_coul = 53.546677664136425
cycle= 1 E= -128.53763427171  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.514506
diis-c [-0.26471622  1.        ]
  HOMO = -0.884356086685043  LUMO = 0.775503514475883
  mo_energy =
[-3.28784495e+01 -1.96662232e+00 -8.84356087e-01 -8.84356087e-01
 -8.84356087e-01  7.75503514e-01  7.75503514e-01  7.75503514e-01
  1.26421719e+00  3.72793832e+00  3.72793832e+00  3.72793832e+00
  8.01264438e+00  1.35230897e+01  1.35230897e+01  1.35230897e+01
  3.57550319e+01  4.94520755e+01  4.94520755e+01  4.94520755e+01
  1.37921203e+02  2.20521563e+02  2.20521563e+02  2.20521563e+02
  4.99490752e+02  1.86629202e+03  7.99618619e+03  4.77644265e+04]
E1 = -182.84705234940117  E_coul = 54.30682658904925
cycle= 2 E= -128.540225760352  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0671
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261445
diis-c [-6.53391595e-04  3.36138741e-01  6.63861259e-01]
  HOMO = -0.848667918761576  LUMO = 0.783916651298401
  mo_energy =
[-3.27701941e+01 -1.92902557e+00 -8.48667919e-01 -8.48667919e-01
 -8.48667919e-01  7.83916651e-01  7.83916651e-01  7.83916651e-01
  1.28008333e+00  3.75861897e+00  3.75861897e+00  3.75861897e+00
  8.05852876e+00  1.35848007e+01  1.35848007e+01  1.35848007e+01
  3.58377316e+01  4.95448158e+01  4.95448158e+01  4.95448158e+01
  1.38027135e+02  2.20634662e+02  2.20634662e+02  2.20634662e+02
  4.99607721e+02  1.86641428e+03  7.99631089e+03  4.77645521e+04]
E1 = -182.58805785957728  E_coul = 54.046909455640844
cycle= 3 E= -128.541148403936  delta_E= -0.000923  |g|= 0.000478  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113218
diis-c [-1.18239824e-07 -2.22660888e-03 -2.48538908e-04  1.00247515e+00]
  HOMO = -0.848912095113002  LUMO = 0.783885089015512
  mo_energy =
[-3.27706427e+01 -1.92921452e+00 -8.48912095e-01 -8.48912095e-01
 -8.48912095e-01  7.83885089e-01  7.83885089e-01  7.83885089e-01
  1.28000826e+00  3.75845616e+00  3.75845616e+00  3.75845616e+00
  8.05831392e+00  1.35845150e+01  1.35845150e+01  1.35845150e+01
  3.58373868e+01  4.95444261e+01  4.95444261e+01  4.95444261e+01
  1.38026685e+02  2.20634151e+02  2.20634151e+02  2.20634151e+02
  4.99607146e+02  1.86641357e+03  7.99631008e+03  4.77645513e+04]
E1 = -182.58856020844348  E_coul = 54.047411785379744
cycle= 4 E= -128.541148423064  delta_E= -1.91e-08  |g|= 7.36e-05  |ddm|= 0.000194
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183958
diis-c [-7.55588227e-10  1.77864612e-04  4.93831092e-04 -1.54029030e-01
  1.15335733e+00]
  HOMO = -0.848950630808156  LUMO = 0.783873938707585
  mo_energy =
[-3.27707127e+01 -1.92924566e+00 -8.48950631e-01 -8.48950631e-01
 -8.48950631e-01  7.83873939e-01  7.83873939e-01  7.83873939e-01
  1.27999020e+00  3.75842069e+00  3.75842069e+00  3.75842069e+00
  8.05827119e+00  1.35844610e+01  1.35844610e+01  1.35844610e+01
  3.58373256e+01  4.95443608e+01  4.95443608e+01  4.95443608e+01
  1.38026615e+02  2.20634077e+02  2.20634077e+02  2.20634077e+02
  4.99607068e+02  1.86641349e+03  7.99630999e+03  4.77645512e+04]
E1 = -182.5887025502045  E_coul = 54.047554126627794
cycle= 5 E= -128.541148423577  delta_E= -5.13e-10  |g|= 4.17e-06  |ddm|= 2.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5887025502045  E_coul = 54.047554126627794
  HOMO = -0.848948618605586  LUMO = 0.783874508466695
  mo_energy =
[-3.27707083e+01 -1.92924298e+00 -8.48948619e-01 -8.48948619e-01
 -8.48948619e-01  7.83874508e-01  7.83874508e-01  7.83874508e-01
  1.27999161e+00  3.75842257e+00  3.75842257e+00  3.75842257e+00
  8.05827410e+00  1.35844642e+01  1.35844642e+01  1.35844642e+01
  3.58373296e+01  4.95443650e+01  4.95443650e+01  4.95443650e+01
  1.38026619e+02  2.20634082e+02  2.20634082e+02  2.20634082e+02
  4.99607072e+02  1.86641349e+03  7.99631000e+03  4.77645512e+04]
E1 = -182.5886922559024  E_coul = 54.04754383232415
Extra cycle  E= -128.541148423578  delta_E= -1.56e-12  |g|= 1.46e-06  |ddm|= 1.77e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264733e+02 2.35846381e+02
 7.56284010e+01 9.86560597e+00 2.63908962e+01 3.95686673e-01
 1.19093737e+00 3.26993137e+00 6.75844647e+00 2.16793570e+01
 9.14735127e+01 2.60796365e-01 2.34981593e+00 8.09926915e-01]
E = -128.54114842357825
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941258        1
[INPUT] 0    0    [1    /1   ]  3661.45469679        1
[INPUT] 0    0    [1    /1   ]  833.264733255        1
[INPUT] 0    0    [1    /1   ]  235.846380543        1
[INPUT] 0    0    [1    /1   ]  75.6284010345        1
[INPUT] 0    0    [1    /1   ]  9.86560596807        1
[INPUT] 0    0    [1    /1   ]  26.3908962489        1
[INPUT] 0    0    [1    /1   ]  0.395686672616       1
[INPUT] 0    0    [1    /1   ]  1.19093736501        1
[INPUT] 0    0    [1    /1   ]  3.26993136982        1
[INPUT] 1    0    [1    /1   ]  6.75844647123        1
[INPUT] 1    0    [1    /1   ]  21.6793569834        1
[INPUT] 1    0    [1    /1   ]  91.4735126663        1
[INPUT] 1    0    [1    /1   ]  0.260796364867       1
[INPUT] 1    0    [1    /1   ]  2.34981592692        1
[INPUT] 1    0    [1    /1   ]  0.809926914882       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125775126, 1.0]], [0, [3661.4546967938873, 1.0]], [0, [833.2647332553217, 1.0]], [0, [235.8463805432428, 1.0]], [0, [75.62840103451963, 1.0]], [0, [9.8656059680714, 1.0]], [0, [26.390896248900326, 1.0]], [0, [0.3956866726158262, 1.0]], [0, [1.1909373650072772, 1.0]], [0, [3.269931369815899, 1.0]], [1, [6.758446471232899, 1.0]], [1, [21.679356983385638, 1.0]], [1, [91.4735126662676, 1.0]], [1, [0.2607963648672295, 1.0]], [1, [2.3498159269179006, 1.0]], [1, [0.80992691488155, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412578]
bas 1, expnt(s) = [3661.45469679]
bas 2, expnt(s) = [833.26473326]
bas 3, expnt(s) = [235.84638054]
bas 4, expnt(s) = [75.62840103]
bas 5, expnt(s) = [9.86560597]
bas 6, expnt(s) = [26.39089625]
bas 7, expnt(s) = [0.39568667]
bas 8, expnt(s) = [1.19093737]
bas 9, expnt(s) = [3.26993137]
bas 10, expnt(s) = [6.75844647]
bas 11, expnt(s) = [21.67935698]
bas 12, expnt(s) = [91.47351267]
bas 13, expnt(s) = [0.26079636]
bas 14, expnt(s) = [2.34981593]
bas 15, expnt(s) = [0.80992691]
CPU time:       242.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264733e+02 3.91834142e+02 2.35846381e+02 1.52050179e+02
 7.56284010e+01 6.47930931e+01 9.86560597e+00 1.40639673e+01
 2.63908962e+01 2.94174910e+01 3.95686673e-01 1.26045862e+00
 1.19093737e+00 2.88026015e+00 3.26993137e+00 6.14354442e+00
 6.75844647e+00 3.17901803e+01 2.16793570e+01 1.36471633e+02
 9.14735127e+01 8.25284310e+02 2.60796365e-01 5.43702475e-01
 2.34981593e+00 8.48743959e+00 8.09926915e-01 2.24151517e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999607916448348
cond(S) = 382.73123666861323
E1 = -183.5893813886054  E_coul = 55.08024948825224
init E= -128.509131900353
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775391513299789  LUMO = 0.80120806628177
  mo_energy =
[-3.25550586e+01 -1.85251571e+00 -7.75391513e-01 -7.75391513e-01
 -7.75391513e-01  8.01208066e-01  8.01208066e-01  8.01208066e-01
  1.31350487e+00  3.82249014e+00  3.82249014e+00  3.82249014e+00
  8.15231963e+00  1.37093159e+01  1.37093159e+01  1.37093159e+01
  3.60017162e+01  4.97290140e+01  4.97290140e+01  4.97290140e+01
  1.38238379e+02  2.20865132e+02  2.20865132e+02  2.20865132e+02
  4.99852458e+02  1.86668987e+03  7.99661305e+03  4.77648722e+04]
E1 = -182.08431193584664  E_coul = 53.546677664136425
cycle= 1 E= -128.53763427171  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.514506
diis-c [-0.26471622  1.        ]
  HOMO = -0.884356086685043  LUMO = 0.775503514475883
  mo_energy =
[-3.28784495e+01 -1.96662232e+00 -8.84356087e-01 -8.84356087e-01
 -8.84356087e-01  7.75503514e-01  7.75503514e-01  7.75503514e-01
  1.26421719e+00  3.72793832e+00  3.72793832e+00  3.72793832e+00
  8.01264438e+00  1.35230897e+01  1.35230897e+01  1.35230897e+01
  3.57550319e+01  4.94520755e+01  4.94520755e+01  4.94520755e+01
  1.37921203e+02  2.20521563e+02  2.20521563e+02  2.20521563e+02
  4.99490752e+02  1.86629202e+03  7.99618619e+03  4.77644265e+04]
E1 = -182.84705234940117  E_coul = 54.30682658904925
cycle= 2 E= -128.540225760352  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0671
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261445
diis-c [-6.53391595e-04  3.36138741e-01  6.63861259e-01]
  HOMO = -0.848667918761576  LUMO = 0.783916651298401
  mo_energy =
[-3.27701941e+01 -1.92902557e+00 -8.48667919e-01 -8.48667919e-01
 -8.48667919e-01  7.83916651e-01  7.83916651e-01  7.83916651e-01
  1.28008333e+00  3.75861897e+00  3.75861897e+00  3.75861897e+00
  8.05852876e+00  1.35848007e+01  1.35848007e+01  1.35848007e+01
  3.58377316e+01  4.95448158e+01  4.95448158e+01  4.95448158e+01
  1.38027135e+02  2.20634662e+02  2.20634662e+02  2.20634662e+02
  4.99607721e+02  1.86641428e+03  7.99631089e+03  4.77645521e+04]
E1 = -182.58805785957728  E_coul = 54.046909455640844
cycle= 3 E= -128.541148403936  delta_E= -0.000923  |g|= 0.000478  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113218
diis-c [-1.18239824e-07 -2.22660888e-03 -2.48538908e-04  1.00247515e+00]
  HOMO = -0.848912095113002  LUMO = 0.783885089015512
  mo_energy =
[-3.27706427e+01 -1.92921452e+00 -8.48912095e-01 -8.48912095e-01
 -8.48912095e-01  7.83885089e-01  7.83885089e-01  7.83885089e-01
  1.28000826e+00  3.75845616e+00  3.75845616e+00  3.75845616e+00
  8.05831392e+00  1.35845150e+01  1.35845150e+01  1.35845150e+01
  3.58373868e+01  4.95444261e+01  4.95444261e+01  4.95444261e+01
  1.38026685e+02  2.20634151e+02  2.20634151e+02  2.20634151e+02
  4.99607146e+02  1.86641357e+03  7.99631008e+03  4.77645513e+04]
E1 = -182.58856020844348  E_coul = 54.047411785379744
cycle= 4 E= -128.541148423064  delta_E= -1.91e-08  |g|= 7.36e-05  |ddm|= 0.000194
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183958
diis-c [-7.55588227e-10  1.77864612e-04  4.93831092e-04 -1.54029030e-01
  1.15335733e+00]
  HOMO = -0.848950630808156  LUMO = 0.783873938707585
  mo_energy =
[-3.27707127e+01 -1.92924566e+00 -8.48950631e-01 -8.48950631e-01
 -8.48950631e-01  7.83873939e-01  7.83873939e-01  7.83873939e-01
  1.27999020e+00  3.75842069e+00  3.75842069e+00  3.75842069e+00
  8.05827119e+00  1.35844610e+01  1.35844610e+01  1.35844610e+01
  3.58373256e+01  4.95443608e+01  4.95443608e+01  4.95443608e+01
  1.38026615e+02  2.20634077e+02  2.20634077e+02  2.20634077e+02
  4.99607068e+02  1.86641349e+03  7.99630999e+03  4.77645512e+04]
E1 = -182.5887025502045  E_coul = 54.047554126627794
cycle= 5 E= -128.541148423577  delta_E= -5.13e-10  |g|= 4.17e-06  |ddm|= 2.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5887025502045  E_coul = 54.047554126627794
  HOMO = -0.848948618605586  LUMO = 0.783874508466695
  mo_energy =
[-3.27707083e+01 -1.92924298e+00 -8.48948619e-01 -8.48948619e-01
 -8.48948619e-01  7.83874508e-01  7.83874508e-01  7.83874508e-01
  1.27999161e+00  3.75842257e+00  3.75842257e+00  3.75842257e+00
  8.05827410e+00  1.35844642e+01  1.35844642e+01  1.35844642e+01
  3.58373296e+01  4.95443650e+01  4.95443650e+01  4.95443650e+01
  1.38026619e+02  2.20634082e+02  2.20634082e+02  2.20634082e+02
  4.99607072e+02  1.86641349e+03  7.99631000e+03  4.77645512e+04]
E1 = -182.5886922559024  E_coul = 54.04754383232415
Extra cycle  E= -128.541148423578  delta_E= -1.56e-12  |g|= 1.46e-06  |ddm|= 1.77e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 382.73123666861323
E1 = -182.5886922559024  E_coul = 54.04754383232415
init E= -128.541148423578
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.848949353722475  LUMO = 0.783874347086899
  mo_energy =
[-3.27707106e+01 -1.92924363e+00 -8.48949354e-01 -8.48949354e-01
 -8.48949354e-01  7.83874347e-01  7.83874347e-01  7.83874347e-01
  1.27999137e+00  3.75842196e+00  3.75842196e+00  3.75842196e+00
  8.05827322e+00  1.35844630e+01  1.35844630e+01  1.35844630e+01
  3.58373279e+01  4.95443631e+01  4.95443631e+01  4.95443631e+01
  1.38026617e+02  2.20634079e+02  2.20634079e+02  2.20634079e+02
  4.99607070e+02  1.86641349e+03  7.99630999e+03  4.77645512e+04]
E1 = -182.58869798720562  E_coul = 54.04754956362715
cycle= 1 E= -128.541148423578  delta_E= -2.27e-13  |g|= 7.9e-07  |ddm|= 5.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58869798720562  E_coul = 54.04754956362715
  HOMO = -0.848948951530543  LUMO = 0.783874444317541
  mo_energy =
[-3.27707094e+01 -1.92924318e+00 -8.48948952e-01 -8.48948952e-01
 -8.48948952e-01  7.83874444e-01  7.83874444e-01  7.83874444e-01
  1.27999156e+00  3.75842231e+00  3.75842231e+00  3.75842231e+00
  8.05827376e+00  1.35844636e+01  1.35844636e+01  1.35844636e+01
  3.58373289e+01  4.95443641e+01  4.95443641e+01  4.95443641e+01
  1.38026618e+02  2.20634080e+02  2.20634080e+02  2.20634080e+02
  4.99607071e+02  1.86641349e+03  7.99630999e+03  4.77645512e+04]
E1 = -182.58869511392  E_coul = 54.04754669034167
Extra cycle  E= -128.541148423578  delta_E= 1.42e-13  |g|= 3.9e-07  |ddm|= 2.84e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264733e+02 2.35846381e+02
 7.56284010e+01 9.86560597e+00 2.63908962e+01 3.95686673e-01
 1.19093737e+00 3.26993137e+00 6.75844647e+00 2.16793570e+01
 9.14735127e+01 2.60796365e-01 2.34981593e+00 8.09926915e-01]
grad_E = [-5.27064194e-10  2.58363506e-08 -3.42956875e-07 -1.25079719e-06
  5.72772251e-05 -6.50510612e-05 -1.83391732e-04 -3.07906540e-05
  1.05678385e-04  2.78758011e-04 -2.27827196e-04  1.62692528e-05
 -9.02960333e-06 -3.33978220e-04  5.46534807e-04 -4.14328321e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794126         1
[INPUT] 0    0    [1    /1   ]  3661.45468639        1
[INPUT] 0    0    [1    /1   ]  833.264956107        1
[INPUT] 0    0    [1    /1   ]  235.843817307        1
[INPUT] 0    0    [1    /1   ]  75.6362645748        1
[INPUT] 0    0    [1    /1   ]  9.87999472085        1
[INPUT] 0    0    [1    /1   ]  26.460524617         1
[INPUT] 0    0    [1    /1   ]  0.393246539952       1
[INPUT] 0    0    [1    /1   ]  1.17806652783        1
[INPUT] 0    0    [1    /1   ]  3.19149577532        1
[INPUT] 1    0    [1    /1   ]  6.69321509417        1
[INPUT] 1    0    [1    /1   ]  21.4315821824        1
[INPUT] 1    0    [1    /1   ]  90.3746294049        1
[INPUT] 1    0    [1    /1   ]  0.259561343597       1
[INPUT] 1    0    [1    /1   ]  2.33359273245        1
[INPUT] 1    0    [1    /1   ]  0.805308699466       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125977987, 1.0]], [0, [3661.4546863920586, 1.0]], [0, [833.2649561071185, 1.0]], [0, [235.8438173072475, 1.0]], [0, [75.63626457481591, 1.0]], [0, [9.879994720847435, 1.0]], [0, [26.460524617047234, 1.0]], [0, [0.3932465399520067, 1.0]], [0, [1.1780665278312257, 1.0]], [0, [3.1914957753160396, 1.0]], [1, [6.693215094169039, 1.0]], [1, [21.43158218240788, 1.0]], [1, [90.37462940490352, 1.0]], [1, [0.25956134359692173, 1.0]], [1, [2.333592732449754, 1.0]], [1, [0.8053086994658443, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412598]
bas 1, expnt(s) = [3661.45468639]
bas 2, expnt(s) = [833.26495611]
bas 3, expnt(s) = [235.84381731]
bas 4, expnt(s) = [75.63626457]
bas 5, expnt(s) = [9.87999472]
bas 6, expnt(s) = [26.46052462]
bas 7, expnt(s) = [0.39324654]
bas 8, expnt(s) = [1.17806653]
bas 9, expnt(s) = [3.19149578]
bas 10, expnt(s) = [6.69321509]
bas 11, expnt(s) = [21.43158218]
bas 12, expnt(s) = [90.3746294]
bas 13, expnt(s) = [0.25956134]
bas 14, expnt(s) = [2.33359273]
bas 15, expnt(s) = [0.8053087]
CPU time:       245.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145469e+03 1.18920102e+03
 8.33264956e+02 3.91834221e+02 2.35843817e+02 1.52048940e+02
 7.56362646e+01 6.47981458e+01 9.87999472e+00 1.40793485e+01
 2.64605246e+01 2.94756820e+01 3.93246540e-01 1.25462433e+00
 1.17806653e+00 2.85688255e+00 3.19149578e+00 6.03268612e+00
 6.69321509e+00 3.14071023e+01 2.14315822e+01 1.34524747e+02
 9.03746294e+01 8.12910165e+02 2.59561344e-01 5.40485951e-01
 2.33359273e+00 8.41425602e+00 8.05308699e-01 2.22555013e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999621345510647
cond(S) = 374.6203384854913
E1 = -183.58944291193566  E_coul = 55.080242168598495
init E= -128.509200743337
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775389512373141  LUMO = 0.796248034455075
  mo_energy =
[-3.25550663e+01 -1.85252872e+00 -7.75389512e-01 -7.75389512e-01
 -7.75389512e-01  7.96248034e-01  7.96248034e-01  7.96248034e-01
  1.29662103e+00  3.79683537e+00  3.79683537e+00  3.79683537e+00
  8.00356598e+00  1.35913912e+01  1.35913912e+01  1.35913912e+01
  3.57096402e+01  4.91649063e+01  4.91649063e+01  4.91649063e+01
  1.38074869e+02  2.18009353e+02  2.18009353e+02  2.18009353e+02
  4.99826420e+02  1.86670439e+03  7.99663291e+03  4.77648900e+04]
E1 = -182.083348473124  E_coul = 53.545700663235806
cycle= 1 E= -128.537647809888  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.515268
diis-c [-0.26550081  1.        ]
  HOMO = -0.884432911549454  LUMO = 0.770728596569618
  mo_energy =
[-3.28786202e+01 -1.96671970e+00 -8.84432912e-01 -8.84432912e-01
 -8.84432912e-01  7.70728597e-01  7.70728597e-01  7.70728597e-01
  1.24794834e+00  3.70276059e+00  3.70276059e+00  3.70276059e+00
  7.86522404e+00  1.34058961e+01  1.34058961e+01  1.34058961e+01
  3.54628929e+01  4.88885631e+01  4.88885631e+01  4.88885631e+01
  1.37757432e+02  2.17666038e+02  2.17666038e+02  2.17666038e+02
  4.99464532e+02  1.86630638e+03  7.99620589e+03  4.77644441e+04]
E1 = -182.8466931852411  E_coul = 54.30645151411995
cycle= 2 E= -128.540241671121  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0668
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2619
diis-c [-6.51468629e-04  3.36201493e-01  6.63798507e-01]
  HOMO = -0.848718323199972  LUMO = 0.779080205696514
  mo_energy =
[-3.27702951e+01 -1.92909518e+00 -8.48718323e-01 -8.48718323e-01
 -8.48718323e-01  7.79080206e-01  7.79080206e-01  7.79080206e-01
  1.26360945e+00  3.73328184e+00  3.73328184e+00  3.73328184e+00
  7.91065741e+00  1.34673594e+01  1.34673594e+01  1.34673594e+01
  3.55456238e+01  4.89811156e+01  4.89811156e+01  4.89811156e+01
  1.37863467e+02  2.17779104e+02  2.17779104e+02  2.17779104e+02
  4.99581583e+02  1.86642872e+03  7.99633067e+03  4.77645698e+04]
E1 = -182.5874298306577  E_coul = 54.046263935357615
cycle= 3 E= -128.5411658953  delta_E= -0.000924  |g|= 0.00048  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113529
diis-c [-1.18393829e-07 -2.22538700e-03 -2.39904922e-04  1.00246529e+00]
  HOMO = -0.848964109440993  LUMO = 0.779048452107431
  mo_energy =
[-3.27707457e+01 -1.92928588e+00 -8.48964109e-01 -8.48964109e-01
 -8.48964109e-01  7.79048452e-01  7.79048452e-01  7.79048452e-01
  1.26353406e+00  3.73311845e+00  3.73311845e+00  3.73311845e+00
  7.91044249e+00  1.34670728e+01  1.34670728e+01  1.34670728e+01
  3.55452771e+01  4.89807247e+01  4.89807247e+01  4.89807247e+01
  1.37863015e+02  2.17778592e+02  2.17778592e+02  2.17778592e+02
  4.99581006e+02  1.86642801e+03  7.99632986e+03  4.77645690e+04]
E1 = -182.587931676972  E_coul = 54.046765762286704
cycle= 4 E= -128.541165914685  delta_E= -1.94e-08  |g|= 7.39e-05  |ddm|= 0.000198
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184413
diis-c [-7.56127295e-10  1.76978557e-04  4.92705050e-04 -1.53814831e-01
  1.15314515e+00]
  HOMO = -0.849002922797784  LUMO = 0.779037278455385
  mo_energy =
[-3.27708159e+01 -1.92931732e+00 -8.49002923e-01 -8.49002923e-01
 -8.49002923e-01  7.79037278e-01  7.79037278e-01  7.79037278e-01
  1.26351596e+00  3.73308285e+00  3.73308285e+00  3.73308285e+00
  7.91039974e+00  1.34670186e+01  1.34670186e+01  1.34670186e+01
  3.55452156e+01  4.89806592e+01  4.89806592e+01  4.89806592e+01
  1.37862945e+02  2.17778518e+02  2.17778518e+02  2.17778518e+02
  4.99580928e+02  1.86642792e+03  7.99632977e+03  4.77645689e+04]
E1 = -182.58807378327205  E_coul = 54.04690786806919
cycle= 5 E= -128.541165915203  delta_E= -5.18e-10  |g|= 4.14e-06  |ddm|= 2.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58807378327205  E_coul = 54.04690786806919
  HOMO = -0.849000933017846  LUMO = 0.779037837101032
  mo_energy =
[-3.27708116e+01 -1.92931466e+00 -8.49000933e-01 -8.49000933e-01
 -8.49000933e-01  7.79037837e-01  7.79037837e-01  7.79037837e-01
  1.26351734e+00  3.73308471e+00  3.73308471e+00  3.73308471e+00
  7.91040261e+00  1.34670218e+01  1.34670218e+01  1.34670218e+01
  3.55452196e+01  4.89806633e+01  4.89806633e+01  4.89806633e+01
  1.37862949e+02  2.17778523e+02  2.17778523e+02  2.17778523e+02
  4.99580932e+02  1.86642793e+03  7.99632977e+03  4.77645689e+04]
E1 = -182.58806358025942  E_coul = 54.04689766505482
Extra cycle  E= -128.541165915205  delta_E= -1.73e-12  |g|= 1.45e-06  |ddm|= 1.74e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145469e+03 8.33264956e+02 2.35843817e+02
 7.56362646e+01 9.87999472e+00 2.64605246e+01 3.93246540e-01
 1.17806653e+00 3.19149578e+00 6.69321509e+00 2.14315822e+01
 9.03746294e+01 2.59561344e-01 2.33359273e+00 8.05308699e-01]
E = -128.5411659152046
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794126         1
[INPUT] 0    0    [1    /1   ]  3661.45468639        1
[INPUT] 0    0    [1    /1   ]  833.264956107        1
[INPUT] 0    0    [1    /1   ]  235.843817307        1
[INPUT] 0    0    [1    /1   ]  75.6362645748        1
[INPUT] 0    0    [1    /1   ]  9.87999472085        1
[INPUT] 0    0    [1    /1   ]  26.460524617         1
[INPUT] 0    0    [1    /1   ]  0.393246539952       1
[INPUT] 0    0    [1    /1   ]  1.17806652783        1
[INPUT] 0    0    [1    /1   ]  3.19149577532        1
[INPUT] 1    0    [1    /1   ]  6.69321509417        1
[INPUT] 1    0    [1    /1   ]  21.4315821824        1
[INPUT] 1    0    [1    /1   ]  90.3746294049        1
[INPUT] 1    0    [1    /1   ]  0.259561343597       1
[INPUT] 1    0    [1    /1   ]  2.33359273245        1
[INPUT] 1    0    [1    /1   ]  0.805308699466       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125977987, 1.0]], [0, [3661.4546863920586, 1.0]], [0, [833.2649561071185, 1.0]], [0, [235.8438173072475, 1.0]], [0, [75.63626457481591, 1.0]], [0, [9.879994720847435, 1.0]], [0, [26.460524617047234, 1.0]], [0, [0.3932465399520067, 1.0]], [0, [1.1780665278312257, 1.0]], [0, [3.1914957753160396, 1.0]], [1, [6.693215094169039, 1.0]], [1, [21.43158218240788, 1.0]], [1, [90.37462940490352, 1.0]], [1, [0.25956134359692173, 1.0]], [1, [2.333592732449754, 1.0]], [1, [0.8053086994658443, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412598]
bas 1, expnt(s) = [3661.45468639]
bas 2, expnt(s) = [833.26495611]
bas 3, expnt(s) = [235.84381731]
bas 4, expnt(s) = [75.63626457]
bas 5, expnt(s) = [9.87999472]
bas 6, expnt(s) = [26.46052462]
bas 7, expnt(s) = [0.39324654]
bas 8, expnt(s) = [1.17806653]
bas 9, expnt(s) = [3.19149578]
bas 10, expnt(s) = [6.69321509]
bas 11, expnt(s) = [21.43158218]
bas 12, expnt(s) = [90.3746294]
bas 13, expnt(s) = [0.25956134]
bas 14, expnt(s) = [2.33359273]
bas 15, expnt(s) = [0.8053087]
CPU time:       246.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145469e+03 1.18920102e+03
 8.33264956e+02 3.91834221e+02 2.35843817e+02 1.52048940e+02
 7.56362646e+01 6.47981458e+01 9.87999472e+00 1.40793485e+01
 2.64605246e+01 2.94756820e+01 3.93246540e-01 1.25462433e+00
 1.17806653e+00 2.85688255e+00 3.19149578e+00 6.03268612e+00
 6.69321509e+00 3.14071023e+01 2.14315822e+01 1.34524747e+02
 9.03746294e+01 8.12910165e+02 2.59561344e-01 5.40485951e-01
 2.33359273e+00 8.41425602e+00 8.05308699e-01 2.22555013e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999621345510647
cond(S) = 374.6203384854913
E1 = -183.58944291193566  E_coul = 55.080242168598495
init E= -128.509200743337
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775389512373141  LUMO = 0.796248034455075
  mo_energy =
[-3.25550663e+01 -1.85252872e+00 -7.75389512e-01 -7.75389512e-01
 -7.75389512e-01  7.96248034e-01  7.96248034e-01  7.96248034e-01
  1.29662103e+00  3.79683537e+00  3.79683537e+00  3.79683537e+00
  8.00356598e+00  1.35913912e+01  1.35913912e+01  1.35913912e+01
  3.57096402e+01  4.91649063e+01  4.91649063e+01  4.91649063e+01
  1.38074869e+02  2.18009353e+02  2.18009353e+02  2.18009353e+02
  4.99826420e+02  1.86670439e+03  7.99663291e+03  4.77648900e+04]
E1 = -182.083348473124  E_coul = 53.545700663235806
cycle= 1 E= -128.537647809888  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.515268
diis-c [-0.26550081  1.        ]
  HOMO = -0.884432911549454  LUMO = 0.770728596569618
  mo_energy =
[-3.28786202e+01 -1.96671970e+00 -8.84432912e-01 -8.84432912e-01
 -8.84432912e-01  7.70728597e-01  7.70728597e-01  7.70728597e-01
  1.24794834e+00  3.70276059e+00  3.70276059e+00  3.70276059e+00
  7.86522404e+00  1.34058961e+01  1.34058961e+01  1.34058961e+01
  3.54628929e+01  4.88885631e+01  4.88885631e+01  4.88885631e+01
  1.37757432e+02  2.17666038e+02  2.17666038e+02  2.17666038e+02
  4.99464532e+02  1.86630638e+03  7.99620589e+03  4.77644441e+04]
E1 = -182.8466931852411  E_coul = 54.30645151411995
cycle= 2 E= -128.540241671121  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0668
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2619
diis-c [-6.51468629e-04  3.36201493e-01  6.63798507e-01]
  HOMO = -0.848718323199972  LUMO = 0.779080205696514
  mo_energy =
[-3.27702951e+01 -1.92909518e+00 -8.48718323e-01 -8.48718323e-01
 -8.48718323e-01  7.79080206e-01  7.79080206e-01  7.79080206e-01
  1.26360945e+00  3.73328184e+00  3.73328184e+00  3.73328184e+00
  7.91065741e+00  1.34673594e+01  1.34673594e+01  1.34673594e+01
  3.55456238e+01  4.89811156e+01  4.89811156e+01  4.89811156e+01
  1.37863467e+02  2.17779104e+02  2.17779104e+02  2.17779104e+02
  4.99581583e+02  1.86642872e+03  7.99633067e+03  4.77645698e+04]
E1 = -182.5874298306577  E_coul = 54.046263935357615
cycle= 3 E= -128.5411658953  delta_E= -0.000924  |g|= 0.00048  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113529
diis-c [-1.18393829e-07 -2.22538700e-03 -2.39904922e-04  1.00246529e+00]
  HOMO = -0.848964109440993  LUMO = 0.779048452107431
  mo_energy =
[-3.27707457e+01 -1.92928588e+00 -8.48964109e-01 -8.48964109e-01
 -8.48964109e-01  7.79048452e-01  7.79048452e-01  7.79048452e-01
  1.26353406e+00  3.73311845e+00  3.73311845e+00  3.73311845e+00
  7.91044249e+00  1.34670728e+01  1.34670728e+01  1.34670728e+01
  3.55452771e+01  4.89807247e+01  4.89807247e+01  4.89807247e+01
  1.37863015e+02  2.17778592e+02  2.17778592e+02  2.17778592e+02
  4.99581006e+02  1.86642801e+03  7.99632986e+03  4.77645690e+04]
E1 = -182.587931676972  E_coul = 54.046765762286704
cycle= 4 E= -128.541165914685  delta_E= -1.94e-08  |g|= 7.39e-05  |ddm|= 0.000198
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184413
diis-c [-7.56127295e-10  1.76978557e-04  4.92705050e-04 -1.53814831e-01
  1.15314515e+00]
  HOMO = -0.849002922797784  LUMO = 0.779037278455385
  mo_energy =
[-3.27708159e+01 -1.92931732e+00 -8.49002923e-01 -8.49002923e-01
 -8.49002923e-01  7.79037278e-01  7.79037278e-01  7.79037278e-01
  1.26351596e+00  3.73308285e+00  3.73308285e+00  3.73308285e+00
  7.91039974e+00  1.34670186e+01  1.34670186e+01  1.34670186e+01
  3.55452156e+01  4.89806592e+01  4.89806592e+01  4.89806592e+01
  1.37862945e+02  2.17778518e+02  2.17778518e+02  2.17778518e+02
  4.99580928e+02  1.86642792e+03  7.99632977e+03  4.77645689e+04]
E1 = -182.58807378327205  E_coul = 54.04690786806919
cycle= 5 E= -128.541165915203  delta_E= -5.18e-10  |g|= 4.14e-06  |ddm|= 2.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58807378327205  E_coul = 54.04690786806919
  HOMO = -0.849000933017846  LUMO = 0.779037837101032
  mo_energy =
[-3.27708116e+01 -1.92931466e+00 -8.49000933e-01 -8.49000933e-01
 -8.49000933e-01  7.79037837e-01  7.79037837e-01  7.79037837e-01
  1.26351734e+00  3.73308471e+00  3.73308471e+00  3.73308471e+00
  7.91040261e+00  1.34670218e+01  1.34670218e+01  1.34670218e+01
  3.55452196e+01  4.89806633e+01  4.89806633e+01  4.89806633e+01
  1.37862949e+02  2.17778523e+02  2.17778523e+02  2.17778523e+02
  4.99580932e+02  1.86642793e+03  7.99632977e+03  4.77645689e+04]
E1 = -182.58806358025942  E_coul = 54.04689766505482
Extra cycle  E= -128.541165915205  delta_E= -1.73e-12  |g|= 1.45e-06  |ddm|= 1.74e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 374.6203384854913
E1 = -182.58806358025942  E_coul = 54.04689766505482
init E= -128.541165915205
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.849001662075626  LUMO = 0.77903767833009
  mo_energy =
[-3.27708138e+01 -1.92931531e+00 -8.49001662e-01 -8.49001662e-01
 -8.49001662e-01  7.79037678e-01  7.79037678e-01  7.79037678e-01
  1.26351711e+00  3.73308410e+00  3.73308410e+00  3.73308410e+00
  7.91040175e+00  1.34670205e+01  1.34670205e+01  1.34670205e+01
  3.55452179e+01  4.89806614e+01  4.89806614e+01  4.89806614e+01
  1.37862947e+02  2.17778520e+02  2.17778520e+02  2.17778520e+02
  4.99580929e+02  1.86642792e+03  7.99632977e+03  4.77645689e+04]
E1 = -182.58806926124294  E_coul = 54.04690334603815
cycle= 1 E= -128.541165915205  delta_E= -1.71e-13  |g|= 7.83e-07  |ddm|= 5.18e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58806926124294  E_coul = 54.04690334603815
  HOMO = -0.849001263460494  LUMO = 0.77903777393946
  mo_energy =
[-3.27708126e+01 -1.92931486e+00 -8.49001263e-01 -8.49001263e-01
 -8.49001263e-01  7.79037774e-01  7.79037774e-01  7.79037774e-01
  1.26351730e+00  3.73308445e+00  3.73308445e+00  3.73308445e+00
  7.91040227e+00  1.34670212e+01  1.34670212e+01  1.34670212e+01
  3.55452188e+01  4.89806625e+01  4.89806625e+01  4.89806625e+01
  1.37862948e+02  2.17778521e+02  2.17778521e+02  2.17778521e+02
  4.99580930e+02  1.86642792e+03  7.99632977e+03  4.77645689e+04]
E1 = -182.58806641242654  E_coul = 54.04690049722179
Extra cycle  E= -128.541165915205  delta_E= 2.84e-14  |g|= 3.87e-07  |ddm|= 2.8e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145469e+03 8.33264956e+02 2.35843817e+02
 7.56362646e+01 9.87999472e+00 2.64605246e+01 3.93246540e-01
 1.17806653e+00 3.19149578e+00 6.69321509e+00 2.14315822e+01
 9.03746294e+01 2.59561344e-01 2.33359273e+00 8.05308699e-01]
grad_E = [-8.31730889e-10  4.18603262e-08 -6.61216086e-07  2.41886754e-06
  3.24247592e-05 -1.00110492e-04 -1.16571837e-04 -1.04589713e-04
  1.67511920e-04  2.40558540e-04 -3.31986867e-04  2.11358038e-05
 -9.74834510e-06 -5.18857532e-04  8.37594000e-04 -6.94965556e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941262        1
[INPUT] 0    0    [1    /1   ]  3661.45467632        1
[INPUT] 0    0    [1    /1   ]  833.265098079        1
[INPUT] 0    0    [1    /1   ]  235.84413231         1
[INPUT] 0    0    [1    /1   ]  75.6124374596        1
[INPUT] 0    0    [1    /1   ]  9.90426250365        1
[INPUT] 0    0    [1    /1   ]  26.5667620017        1
[INPUT] 0    0    [1    /1   ]  0.388653666261       1
[INPUT] 0    0    [1    /1   ]  1.15387804512        1
[INPUT] 0    0    [1    /1   ]  3.05193490096        1
[INPUT] 1    0    [1    /1   ]  6.66126683913        1
[INPUT] 1    0    [1    /1   ]  21.3177033217        1
[INPUT] 1    0    [1    /1   ]  89.9975745247        1
[INPUT] 1    0    [1    /1   ]  0.258805523943       1
[INPUT] 1    0    [1    /1   ]  2.32608171471        1
[INPUT] 1    0    [1    /1   ]  0.802918652051       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794126184748, 1.0]], [0, [3661.454676315024, 1.0]], [0, [833.2650980793569, 1.0]], [0, [235.84413231017365, 1.0]], [0, [75.61243745963313, 1.0]], [0, [9.904262503646235, 1.0]], [0, [26.56676200171163, 1.0]], [0, [0.3886536662605788, 1.0]], [0, [1.153878045118479, 1.0]], [0, [3.05193490095533, 1.0]], [1, [6.6612668391346155, 1.0]], [1, [21.317703321738183, 1.0]], [1, [89.99757452474162, 1.0]], [1, [0.2588055239432954, 1.0]], [1, [2.326081714708354, 1.0]], [1, [0.8029186520510571, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412618]
bas 1, expnt(s) = [3661.45467632]
bas 2, expnt(s) = [833.26509808]
bas 3, expnt(s) = [235.84413231]
bas 4, expnt(s) = [75.61243746]
bas 5, expnt(s) = [9.9042625]
bas 6, expnt(s) = [26.566762]
bas 7, expnt(s) = [0.38865367]
bas 8, expnt(s) = [1.15387805]
bas 9, expnt(s) = [3.0519349]
bas 10, expnt(s) = [6.66126684]
bas 11, expnt(s) = [21.31770332]
bas 12, expnt(s) = [89.99757452]
bas 13, expnt(s) = [0.25880552]
bas 14, expnt(s) = [2.32608171]
bas 15, expnt(s) = [0.80291865]
CPU time:       249.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145468e+03 1.18920101e+03
 8.33265098e+02 3.91834271e+02 2.35844132e+02 1.52049092e+02
 7.56124375e+01 6.47828355e+01 9.90426250e+00 1.41052774e+01
 2.65667620e+01 2.95643948e+01 3.88653666e-01 1.24361829e+00
 1.15387805e+00 2.81277476e+00 3.05193490e+00 5.83373200e+00
 6.66126684e+00 3.12198226e+01 2.13177033e+01 1.33631828e+02
 8.99975745e+01 8.08672918e+02 2.58805524e-01 5.38519358e-01
 2.32608171e+00 8.38041647e+00 8.02918652e-01 2.21729678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963385824426
cond(S) = 361.444631207107
E1 = -183.58952287466235  E_coul = 55.08021989373764
init E= -128.509302980925
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775389418375713  LUMO = 0.793373550197268
  mo_energy =
[-3.25550719e+01 -1.85255229e+00 -7.75389418e-01 -7.75389418e-01
 -7.75389418e-01  7.93373550e-01  7.93373550e-01  7.93373550e-01
  1.26525768e+00  3.78364790e+00  3.78364790e+00  3.78364790e+00
  7.73138669e+00  1.35341182e+01  1.35341182e+01  1.35341182e+01
  3.51678730e+01  4.88991445e+01  4.88991445e+01  4.88991445e+01
  1.37708849e+02  2.16902645e+02  2.16902645e+02  2.16902645e+02
  4.99616226e+02  1.86653678e+03  7.99648861e+03  4.77647713e+04]
E1 = -182.08262051284402  E_coul = 53.5449415385156
cycle= 1 E= -128.537678974328  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.515486
diis-c [-0.26572619  1.        ]
  HOMO = -0.884497400191386  LUMO = 0.767946499715839
  mo_energy =
[-3.28787392e+01 -1.96680457e+00 -8.84497400e-01 -8.84497400e-01
 -8.84497400e-01  7.67946500e-01  7.67946500e-01  7.67946500e-01
  1.21778728e+00  3.68977789e+00  3.68977789e+00  3.68977789e+00
  7.59565687e+00  1.33489377e+01  1.33489377e+01  1.33489377e+01
  3.49211806e+01  4.86230428e+01  4.86230428e+01  4.86230428e+01
  1.37391141e+02  2.16559368e+02  2.16559368e+02  2.16559368e+02
  4.99254208e+02  1.86613868e+03  7.99606151e+03  4.77643253e+04]
E1 = -182.84636137328275  E_coul = 54.30608703285467
cycle= 2 E= -128.540274340428  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262046
diis-c [-6.48047618e-04  3.36236906e-01  6.63763094e-01]
  HOMO = -0.848765203666471  LUMO = 0.776264970488834
  mo_energy =
[-3.27703666e+01 -1.92916232e+00 -8.48765204e-01 -8.48765204e-01
 -8.48765204e-01  7.76264970e-01  7.76264970e-01  7.76264970e-01
  1.23304896e+00  3.72022640e+00  3.72022640e+00  3.72022640e+00
  7.64020432e+00  1.34102909e+01  1.34102909e+01  1.34102909e+01
  3.50038988e+01  4.87155221e+01  4.87155221e+01  4.87155221e+01
  1.37497280e+02  2.16672446e+02  2.16672446e+02  2.16672446e+02
  4.99371320e+02  1.86626107e+03  7.99618634e+03  4.77644511e+04]
E1 = -182.58689085618443  E_coul = 54.045691159476256
cycle= 3 E= -128.541199696708  delta_E= -0.000925  |g|= 0.000487  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114509
diis-c [-1.19500305e-07 -2.22997522e-03 -2.13034849e-04  1.00244301e+00]
  HOMO = -0.849014492071824  LUMO = 0.776232328070427
  mo_energy =
[-3.27708225e+01 -1.92935638e+00 -8.49014492e-01 -8.49014492e-01
 -8.49014492e-01  7.76232328e-01  7.76232328e-01  7.76232328e-01
  1.23297309e+00  3.72006031e+00  3.72006031e+00  3.72006031e+00
  7.63998889e+00  1.34100002e+01  1.34100002e+01  1.34100002e+01
  3.50035475e+01  4.87151264e+01  4.87151264e+01  4.87151264e+01
  1.37496823e+02  2.16671930e+02  2.16671930e+02  2.16671930e+02
  4.99370738e+02  1.86626035e+03  7.99618553e+03  4.77644502e+04]
E1 = -182.58739773973204  E_coul = 54.04619802300759
cycle= 4 E= -128.541199716724  delta_E= -2e-08  |g|= 7.46e-05  |ddm|= 0.000206
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185249
diis-c [-7.63107354e-10  1.78058586e-04  4.90509388e-04 -1.54321162e-01
  1.15365259e+00]
  HOMO = -0.849053791179983  LUMO = 0.77622103645459
  mo_energy =
[-3.27708932e+01 -1.92938822e+00 -8.49053791e-01 -8.49053791e-01
 -8.49053791e-01  7.76221036e-01  7.76221036e-01  7.76221036e-01
  1.23295504e+00  3.72002433e+00  3.72002433e+00  3.72002433e+00
  7.63994622e+00  1.34099455e+01  1.34099455e+01  1.34099455e+01
  3.50034855e+01  4.87150604e+01  4.87150604e+01  4.87150604e+01
  1.37496752e+02  2.16671855e+02  2.16671855e+02  2.16671855e+02
  4.99370660e+02  1.86626027e+03  7.99618544e+03  4.77644501e+04]
E1 = -182.58753976861988  E_coul = 54.04634005136646
cycle= 5 E= -128.541199717253  delta_E= -5.29e-10  |g|= 4.16e-06  |ddm|= 2.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58753976861988  E_coul = 54.04634005136646
  HOMO = -0.849051806587734  LUMO = 0.776221592067449
  mo_energy =
[-3.27708889e+01 -1.92938556e+00 -8.49051807e-01 -8.49051807e-01
 -8.49051807e-01  7.76221592e-01  7.76221592e-01  7.76221592e-01
  1.23295640e+00  3.72002618e+00  3.72002618e+00  3.72002618e+00
  7.63994904e+00  1.34099487e+01  1.34099487e+01  1.34099487e+01
  3.50034895e+01  4.87150645e+01  4.87150645e+01  4.87150645e+01
  1.37496756e+02  2.16671860e+02  2.16671860e+02  2.16671860e+02
  4.99370664e+02  1.86626027e+03  7.99618544e+03  4.77644501e+04]
E1 = -182.58752961545642  E_coul = 54.04632989820191
Extra cycle  E= -128.541199717255  delta_E= -1.08e-12  |g|= 1.45e-06  |ddm|= 1.72e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145468e+03 8.33265098e+02 2.35844132e+02
 7.56124375e+01 9.90426250e+00 2.65667620e+01 3.88653666e-01
 1.15387805e+00 3.05193490e+00 6.66126684e+00 2.13177033e+01
 8.99975745e+01 2.58805524e-01 2.32608171e+00 8.02918652e-01]
E = -128.5411997172545
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941262        1
[INPUT] 0    0    [1    /1   ]  3661.45467632        1
[INPUT] 0    0    [1    /1   ]  833.265098079        1
[INPUT] 0    0    [1    /1   ]  235.84413231         1
[INPUT] 0    0    [1    /1   ]  75.6124374596        1
[INPUT] 0    0    [1    /1   ]  9.90426250365        1
[INPUT] 0    0    [1    /1   ]  26.5667620017        1
[INPUT] 0    0    [1    /1   ]  0.388653666261       1
[INPUT] 0    0    [1    /1   ]  1.15387804512        1
[INPUT] 0    0    [1    /1   ]  3.05193490096        1
[INPUT] 1    0    [1    /1   ]  6.66126683913        1
[INPUT] 1    0    [1    /1   ]  21.3177033217        1
[INPUT] 1    0    [1    /1   ]  89.9975745247        1
[INPUT] 1    0    [1    /1   ]  0.258805523943       1
[INPUT] 1    0    [1    /1   ]  2.32608171471        1
[INPUT] 1    0    [1    /1   ]  0.802918652051       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794126184748, 1.0]], [0, [3661.454676315024, 1.0]], [0, [833.2650980793569, 1.0]], [0, [235.84413231017365, 1.0]], [0, [75.61243745963313, 1.0]], [0, [9.904262503646235, 1.0]], [0, [26.56676200171163, 1.0]], [0, [0.3886536662605788, 1.0]], [0, [1.153878045118479, 1.0]], [0, [3.05193490095533, 1.0]], [1, [6.6612668391346155, 1.0]], [1, [21.317703321738183, 1.0]], [1, [89.99757452474162, 1.0]], [1, [0.2588055239432954, 1.0]], [1, [2.326081714708354, 1.0]], [1, [0.8029186520510571, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412618]
bas 1, expnt(s) = [3661.45467632]
bas 2, expnt(s) = [833.26509808]
bas 3, expnt(s) = [235.84413231]
bas 4, expnt(s) = [75.61243746]
bas 5, expnt(s) = [9.9042625]
bas 6, expnt(s) = [26.566762]
bas 7, expnt(s) = [0.38865367]
bas 8, expnt(s) = [1.15387805]
bas 9, expnt(s) = [3.0519349]
bas 10, expnt(s) = [6.66126684]
bas 11, expnt(s) = [21.31770332]
bas 12, expnt(s) = [89.99757452]
bas 13, expnt(s) = [0.25880552]
bas 14, expnt(s) = [2.32608171]
bas 15, expnt(s) = [0.80291865]
CPU time:       250.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145468e+03 1.18920101e+03
 8.33265098e+02 3.91834271e+02 2.35844132e+02 1.52049092e+02
 7.56124375e+01 6.47828355e+01 9.90426250e+00 1.41052774e+01
 2.65667620e+01 2.95643948e+01 3.88653666e-01 1.24361829e+00
 1.15387805e+00 2.81277476e+00 3.05193490e+00 5.83373200e+00
 6.66126684e+00 3.12198226e+01 2.13177033e+01 1.33631828e+02
 8.99975745e+01 8.08672918e+02 2.58805524e-01 5.38519358e-01
 2.32608171e+00 8.38041647e+00 8.02918652e-01 2.21729678e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963385824426
cond(S) = 361.444631207107
E1 = -183.58952287466235  E_coul = 55.08021989373764
init E= -128.509302980925
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775389418375713  LUMO = 0.793373550197268
  mo_energy =
[-3.25550719e+01 -1.85255229e+00 -7.75389418e-01 -7.75389418e-01
 -7.75389418e-01  7.93373550e-01  7.93373550e-01  7.93373550e-01
  1.26525768e+00  3.78364790e+00  3.78364790e+00  3.78364790e+00
  7.73138669e+00  1.35341182e+01  1.35341182e+01  1.35341182e+01
  3.51678730e+01  4.88991445e+01  4.88991445e+01  4.88991445e+01
  1.37708849e+02  2.16902645e+02  2.16902645e+02  2.16902645e+02
  4.99616226e+02  1.86653678e+03  7.99648861e+03  4.77647713e+04]
E1 = -182.08262051284402  E_coul = 53.5449415385156
cycle= 1 E= -128.537678974328  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.515486
diis-c [-0.26572619  1.        ]
  HOMO = -0.884497400191386  LUMO = 0.767946499715839
  mo_energy =
[-3.28787392e+01 -1.96680457e+00 -8.84497400e-01 -8.84497400e-01
 -8.84497400e-01  7.67946500e-01  7.67946500e-01  7.67946500e-01
  1.21778728e+00  3.68977789e+00  3.68977789e+00  3.68977789e+00
  7.59565687e+00  1.33489377e+01  1.33489377e+01  1.33489377e+01
  3.49211806e+01  4.86230428e+01  4.86230428e+01  4.86230428e+01
  1.37391141e+02  2.16559368e+02  2.16559368e+02  2.16559368e+02
  4.99254208e+02  1.86613868e+03  7.99606151e+03  4.77643253e+04]
E1 = -182.84636137328275  E_coul = 54.30608703285467
cycle= 2 E= -128.540274340428  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.262046
diis-c [-6.48047618e-04  3.36236906e-01  6.63763094e-01]
  HOMO = -0.848765203666471  LUMO = 0.776264970488834
  mo_energy =
[-3.27703666e+01 -1.92916232e+00 -8.48765204e-01 -8.48765204e-01
 -8.48765204e-01  7.76264970e-01  7.76264970e-01  7.76264970e-01
  1.23304896e+00  3.72022640e+00  3.72022640e+00  3.72022640e+00
  7.64020432e+00  1.34102909e+01  1.34102909e+01  1.34102909e+01
  3.50038988e+01  4.87155221e+01  4.87155221e+01  4.87155221e+01
  1.37497280e+02  2.16672446e+02  2.16672446e+02  2.16672446e+02
  4.99371320e+02  1.86626107e+03  7.99618634e+03  4.77644511e+04]
E1 = -182.58689085618443  E_coul = 54.045691159476256
cycle= 3 E= -128.541199696708  delta_E= -0.000925  |g|= 0.000487  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114509
diis-c [-1.19500305e-07 -2.22997522e-03 -2.13034849e-04  1.00244301e+00]
  HOMO = -0.849014492071824  LUMO = 0.776232328070427
  mo_energy =
[-3.27708225e+01 -1.92935638e+00 -8.49014492e-01 -8.49014492e-01
 -8.49014492e-01  7.76232328e-01  7.76232328e-01  7.76232328e-01
  1.23297309e+00  3.72006031e+00  3.72006031e+00  3.72006031e+00
  7.63998889e+00  1.34100002e+01  1.34100002e+01  1.34100002e+01
  3.50035475e+01  4.87151264e+01  4.87151264e+01  4.87151264e+01
  1.37496823e+02  2.16671930e+02  2.16671930e+02  2.16671930e+02
  4.99370738e+02  1.86626035e+03  7.99618553e+03  4.77644502e+04]
E1 = -182.58739773973204  E_coul = 54.04619802300759
cycle= 4 E= -128.541199716724  delta_E= -2e-08  |g|= 7.46e-05  |ddm|= 0.000206
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185249
diis-c [-7.63107354e-10  1.78058586e-04  4.90509388e-04 -1.54321162e-01
  1.15365259e+00]
  HOMO = -0.849053791179983  LUMO = 0.77622103645459
  mo_energy =
[-3.27708932e+01 -1.92938822e+00 -8.49053791e-01 -8.49053791e-01
 -8.49053791e-01  7.76221036e-01  7.76221036e-01  7.76221036e-01
  1.23295504e+00  3.72002433e+00  3.72002433e+00  3.72002433e+00
  7.63994622e+00  1.34099455e+01  1.34099455e+01  1.34099455e+01
  3.50034855e+01  4.87150604e+01  4.87150604e+01  4.87150604e+01
  1.37496752e+02  2.16671855e+02  2.16671855e+02  2.16671855e+02
  4.99370660e+02  1.86626027e+03  7.99618544e+03  4.77644501e+04]
E1 = -182.58753976861988  E_coul = 54.04634005136646
cycle= 5 E= -128.541199717253  delta_E= -5.29e-10  |g|= 4.16e-06  |ddm|= 2.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58753976861988  E_coul = 54.04634005136646
  HOMO = -0.849051806587734  LUMO = 0.776221592067449
  mo_energy =
[-3.27708889e+01 -1.92938556e+00 -8.49051807e-01 -8.49051807e-01
 -8.49051807e-01  7.76221592e-01  7.76221592e-01  7.76221592e-01
  1.23295640e+00  3.72002618e+00  3.72002618e+00  3.72002618e+00
  7.63994904e+00  1.34099487e+01  1.34099487e+01  1.34099487e+01
  3.50034895e+01  4.87150645e+01  4.87150645e+01  4.87150645e+01
  1.37496756e+02  2.16671860e+02  2.16671860e+02  2.16671860e+02
  4.99370664e+02  1.86626027e+03  7.99618544e+03  4.77644501e+04]
E1 = -182.58752961545642  E_coul = 54.04632989820191
Extra cycle  E= -128.541199717255  delta_E= -1.08e-12  |g|= 1.45e-06  |ddm|= 1.72e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 361.444631207107
E1 = -182.58752961545642  E_coul = 54.04632989820191
init E= -128.541199717255
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.849052532467368  LUMO = 0.776221434870196
  mo_energy =
[-3.27708911e+01 -1.92938620e+00 -8.49052532e-01 -8.49052532e-01
 -8.49052532e-01  7.76221435e-01  7.76221435e-01  7.76221435e-01
  1.23295618e+00  3.72002558e+00  3.72002558e+00  3.72002558e+00
  7.63994821e+00  1.34099475e+01  1.34099475e+01  1.34099475e+01
  3.50034878e+01  4.87150626e+01  4.87150626e+01  4.87150626e+01
  1.37496754e+02  2.16671857e+02  2.16671857e+02  2.16671857e+02
  4.99370661e+02  1.86626027e+03  7.99618544e+03  4.77644501e+04]
E1 = -182.58753527632516  E_coul = 54.04633555906988
cycle= 1 E= -128.541199717255  delta_E= -7.67e-13  |g|= 7.81e-07  |ddm|= 5.18e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58753527632516  E_coul = 54.04633555906988
  HOMO = -0.84905213532671  LUMO = 0.776221529742953
  mo_energy =
[-3.27708899e+01 -1.92938576e+00 -8.49052135e-01 -8.49052135e-01
 -8.49052135e-01  7.76221530e-01  7.76221530e-01  7.76221530e-01
  1.23295636e+00  3.72002593e+00  3.72002593e+00  3.72002593e+00
  7.63994872e+00  1.34099482e+01  1.34099482e+01  1.34099482e+01
  3.50034887e+01  4.87150637e+01  4.87150637e+01  4.87150637e+01
  1.37496755e+02  2.16671858e+02  2.16671858e+02  2.16671858e+02
  4.99370663e+02  1.86626027e+03  7.99618544e+03  4.77644501e+04]
E1 = -182.58753243779677  E_coul = 54.046332720541635
Extra cycle  E= -128.541199717255  delta_E= 1.42e-13  |g|= 3.85e-07  |ddm|= 2.77e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145468e+03 8.33265098e+02 2.35844132e+02
 7.56124375e+01 9.90426250e+00 2.65667620e+01 3.88653666e-01
 1.15387805e+00 3.05193490e+00 6.66126684e+00 2.13177033e+01
 8.99975745e+01 2.58805524e-01 2.32608171e+00 8.02918652e-01]
grad_E = [-1.42786159e-09  7.31838477e-08 -1.27267249e-06  9.21649655e-06
 -9.79272330e-06 -1.32858832e-04 -1.33854419e-05 -3.43494972e-04
  3.32430046e-04  1.40518736e-04 -4.09821881e-04  2.30552123e-05
 -9.40849227e-06 -7.09886452e-04  1.08023069e-03 -9.50395614e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941262        1
[INPUT] 0    0    [1    /1   ]  3661.45467779        1
[INPUT] 0    0    [1    /1   ]  833.264879077        1
[INPUT] 0    0    [1    /1   ]  235.851591165        1
[INPUT] 0    0    [1    /1   ]  75.5315127905        1
[INPUT] 0    0    [1    /1   ]  9.92721187402        1
[INPUT] 0    0    [1    /1   ]  26.6563249821        1
[INPUT] 0    0    [1    /1   ]  0.382992742214       1
[INPUT] 0    0    [1    /1   ]  1.1239982528         1
[INPUT] 0    0    [1    /1   ]  2.90223482367        1
[INPUT] 1    0    [1    /1   ]  6.74567953259        1
[INPUT] 1    0    [1    /1   ]  21.6638128868        1
[INPUT] 1    0    [1    /1   ]  91.8912244935        1
[INPUT] 1    0    [1    /1   ]  0.260080547517       1
[INPUT] 1    0    [1    /1   ]  2.34834458024        1
[INPUT] 1    0    [1    /1   ]  0.80870887328        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794126181896, 1.0]], [0, [3661.4546777939695, 1.0]], [0, [833.2648790766692, 1.0]], [0, [235.8515911653996, 1.0]], [0, [75.5315127904692, 1.0]], [0, [9.927211874022381, 1.0]], [0, [26.656324982057857, 1.0]], [0, [0.3829927422139761, 1.0]], [0, [1.12399825280382, 1.0]], [0, [2.902234823668819, 1.0]], [1, [6.745679532589212, 1.0]], [1, [21.663812886792282, 1.0]], [1, [91.89122449345174, 1.0]], [1, [0.2600805475169093, 1.0]], [1, [2.348344580237937, 1.0]], [1, [0.8087088732803293, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412618]
bas 1, expnt(s) = [3661.45467779]
bas 2, expnt(s) = [833.26487908]
bas 3, expnt(s) = [235.85159117]
bas 4, expnt(s) = [75.53151279]
bas 5, expnt(s) = [9.92721187]
bas 6, expnt(s) = [26.65632498]
bas 7, expnt(s) = [0.38299274]
bas 8, expnt(s) = [1.12399825]
bas 9, expnt(s) = [2.90223482]
bas 10, expnt(s) = [6.74567953]
bas 11, expnt(s) = [21.66381289]
bas 12, expnt(s) = [91.89122449]
bas 13, expnt(s) = [0.26008055]
bas 14, expnt(s) = [2.34834458]
bas 15, expnt(s) = [0.80870887]
CPU time:       254.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145468e+03 1.18920102e+03
 8.33264879e+02 3.91834194e+02 2.35851591e+02 1.52052699e+02
 7.55315128e+01 6.47308279e+01 9.92721187e+00 1.41297830e+01
 2.66563250e+01 2.96391149e+01 3.82992742e-01 1.23000799e+00
 1.12399825e+00 2.75796818e+00 2.90223482e+00 5.61777623e+00
 6.74567953e+00 3.17151321e+01 2.16638129e+01 1.36349331e+02
 9.18912245e+01 8.29997799e+02 2.60080548e-01 5.41837715e-01
 2.34834458e+00 8.48079706e+00 8.08708873e-01 2.23730222e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963206644541
cond(S) = 348.3971064261852
E1 = -183.58957801888866  E_coul = 55.08018708663125
init E= -128.509390932257
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775394661240046  LUMO = 0.798855650816997
  mo_energy =
[-3.25550635e+01 -1.85257883e+00 -7.75394661e-01 -7.75394661e-01
 -7.75394661e-01  7.98855651e-01  7.98855651e-01  7.98855651e-01
  1.22760665e+00  3.81594160e+00  3.81594160e+00  3.81594160e+00
  7.42070696e+00  1.36888653e+01  1.36888653e+01  1.36888653e+01
  3.45429740e+01  4.96637507e+01  4.96637507e+01  4.96637507e+01
  1.37196223e+02  2.21462777e+02  2.21462777e+02  2.21462777e+02
  4.99143328e+02  1.86606753e+03  7.99606545e+03  4.77644194e+04]
E1 = -182.08328845976052  E_coul = 53.545564830215035
cycle= 1 E= -128.537723629545  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.514098
diis-c [-0.26429673  1.        ]
  HOMO = -0.884460263257448  LUMO = 0.773187324180465
  mo_energy =
[-3.28785959e+01 -1.96676715e+00 -8.84460263e-01 -8.84460263e-01
 -8.84460263e-01  7.73187324e-01  7.73187324e-01  7.73187324e-01
  1.18164976e+00  3.72137409e+00  3.72137409e+00  3.72137409e+00
  7.28818001e+00  1.35026200e+01  1.35026200e+01  1.35026200e+01
  3.42965789e+01  4.93867271e+01  4.93867271e+01  4.93867271e+01
  1.36878504e+02  2.21118934e+02  2.21118934e+02  2.21118934e+02
  4.98781451e+02  1.86566959e+03  7.99563854e+03  4.77639736e+04]
E1 = -182.84649903799945  E_coul = 54.306182244906914
cycle= 2 E= -128.540316793093  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0661
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261259
diis-c [-6.44350232e-04  3.36167098e-01  6.63832902e-01]
  HOMO = -0.848750339121447  LUMO = 0.781580317806146
  mo_energy =
[-3.27702803e+01 -1.92915052e+00 -8.48750339e-01 -8.48750339e-01
 -8.48750339e-01  7.81580318e-01  7.81580318e-01  7.81580318e-01
  1.19641237e+00  3.75204697e+00  3.75204697e+00  3.75204697e+00
  7.33164187e+00  1.35643273e+01  1.35643273e+01  1.35643273e+01
  3.43791882e+01  4.94795079e+01  4.94795079e+01  4.94795079e+01
  1.36984642e+02  2.21232135e+02  2.21232135e+02  2.21232135e+02
  4.98898514e+02  1.86579192e+03  7.99576331e+03  4.77640993e+04]
E1 = -182.5871945817249  E_coul = 54.04595361486826
cycle= 3 E= -128.541240966857  delta_E= -0.000924  |g|= 0.000497  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115998
diis-c [-1.21662695e-07 -2.24224334e-03 -1.69417437e-04  1.00241166e+00]
  HOMO = -0.849003810169781  LUMO = 0.781546032202545
  mo_energy =
[-3.27707438e+01 -1.92934815e+00 -8.49003810e-01 -8.49003810e-01
 -8.49003810e-01  7.81546032e-01  7.81546032e-01  7.81546032e-01
  1.19633642e+00  3.75187599e+00  3.75187599e+00  3.75187599e+00
  7.33142611e+00  1.35640296e+01  1.35640296e+01  1.35640296e+01
  3.43788308e+01  4.94791038e+01  4.94791038e+01  4.94791038e+01
  1.36984177e+02  2.21231609e+02  2.21231609e+02  2.21231609e+02
  4.98897925e+02  1.86579120e+03  7.99576249e+03  4.77640984e+04]
E1 = -182.58771425118536  E_coul = 54.046473263463255
cycle= 4 E= -128.541240987722  delta_E= -2.09e-08  |g|= 7.54e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185983
diis-c [-7.77100415e-10  1.82493541e-04  4.87582267e-04 -1.55931836e-01
  1.15526176e+00]
  HOMO = -0.849043571458732  LUMO = 0.781534510661554
  mo_energy =
[-3.27708150e+01 -1.92938020e+00 -8.49043571e-01 -8.49043571e-01
 -8.49043571e-01  7.81534511e-01  7.81534511e-01  7.81534511e-01
  1.19631866e+00  3.75183942e+00  3.75183942e+00  3.75183942e+00
  7.33138377e+00  1.35639742e+01  1.35639742e+01  1.35639742e+01
  3.43787684e+01  4.94790373e+01  4.94790373e+01  4.94790373e+01
  1.36984106e+02  2.21231534e+02  2.21231534e+02  2.21231534e+02
  4.98897846e+02  1.86579111e+03  7.99576240e+03  4.77640983e+04]
E1 = -182.5878565585379  E_coul = 54.04661557027206
cycle= 5 E= -128.541240988266  delta_E= -5.44e-10  |g|= 4.25e-06  |ddm|= 3.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5878565585379  E_coul = 54.04661557027206
  HOMO = -0.849041549106064  LUMO = 0.781535084936797
  mo_energy =
[-3.27708106e+01 -1.92937748e+00 -8.49041549e-01 -8.49041549e-01
 -8.49041549e-01  7.81535085e-01  7.81535085e-01  7.81535085e-01
  1.19632002e+00  3.75184131e+00  3.75184131e+00  3.75184131e+00
  7.33138661e+00  1.35639775e+01  1.35639775e+01  1.35639775e+01
  3.43787724e+01  4.94790415e+01  4.94790415e+01  4.94790415e+01
  1.36984110e+02  2.21231539e+02  2.21231539e+02  2.21231539e+02
  4.98897850e+02  1.86579112e+03  7.99576240e+03  4.77640983e+04]
E1 = -182.58784631157113  E_coul = 54.04660532330332
Extra cycle  E= -128.541240988268  delta_E= -1.96e-12  |g|= 1.46e-06  |ddm|= 1.74e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145468e+03 8.33264879e+02 2.35851591e+02
 7.55315128e+01 9.92721187e+00 2.66563250e+01 3.82992742e-01
 1.12399825e+00 2.90223482e+00 6.74567953e+00 2.16638129e+01
 9.18912245e+01 2.60080548e-01 2.34834458e+00 8.08708873e-01]
E = -128.54124098826782
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941262        1
[INPUT] 0    0    [1    /1   ]  3661.45467779        1
[INPUT] 0    0    [1    /1   ]  833.264879077        1
[INPUT] 0    0    [1    /1   ]  235.851591165        1
[INPUT] 0    0    [1    /1   ]  75.5315127905        1
[INPUT] 0    0    [1    /1   ]  9.92721187402        1
[INPUT] 0    0    [1    /1   ]  26.6563249821        1
[INPUT] 0    0    [1    /1   ]  0.382992742214       1
[INPUT] 0    0    [1    /1   ]  1.1239982528         1
[INPUT] 0    0    [1    /1   ]  2.90223482367        1
[INPUT] 1    0    [1    /1   ]  6.74567953259        1
[INPUT] 1    0    [1    /1   ]  21.6638128868        1
[INPUT] 1    0    [1    /1   ]  91.8912244935        1
[INPUT] 1    0    [1    /1   ]  0.260080547517       1
[INPUT] 1    0    [1    /1   ]  2.34834458024        1
[INPUT] 1    0    [1    /1   ]  0.80870887328        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794126181896, 1.0]], [0, [3661.4546777939695, 1.0]], [0, [833.2648790766692, 1.0]], [0, [235.8515911653996, 1.0]], [0, [75.5315127904692, 1.0]], [0, [9.927211874022381, 1.0]], [0, [26.656324982057857, 1.0]], [0, [0.3829927422139761, 1.0]], [0, [1.12399825280382, 1.0]], [0, [2.902234823668819, 1.0]], [1, [6.745679532589212, 1.0]], [1, [21.663812886792282, 1.0]], [1, [91.89122449345174, 1.0]], [1, [0.2600805475169093, 1.0]], [1, [2.348344580237937, 1.0]], [1, [0.8087088732803293, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412618]
bas 1, expnt(s) = [3661.45467779]
bas 2, expnt(s) = [833.26487908]
bas 3, expnt(s) = [235.85159117]
bas 4, expnt(s) = [75.53151279]
bas 5, expnt(s) = [9.92721187]
bas 6, expnt(s) = [26.65632498]
bas 7, expnt(s) = [0.38299274]
bas 8, expnt(s) = [1.12399825]
bas 9, expnt(s) = [2.90223482]
bas 10, expnt(s) = [6.74567953]
bas 11, expnt(s) = [21.66381289]
bas 12, expnt(s) = [91.89122449]
bas 13, expnt(s) = [0.26008055]
bas 14, expnt(s) = [2.34834458]
bas 15, expnt(s) = [0.80870887]
CPU time:       255.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145468e+03 1.18920102e+03
 8.33264879e+02 3.91834194e+02 2.35851591e+02 1.52052699e+02
 7.55315128e+01 6.47308279e+01 9.92721187e+00 1.41297830e+01
 2.66563250e+01 2.96391149e+01 3.82992742e-01 1.23000799e+00
 1.12399825e+00 2.75796818e+00 2.90223482e+00 5.61777623e+00
 6.74567953e+00 3.17151321e+01 2.16638129e+01 1.36349331e+02
 9.18912245e+01 8.29997799e+02 2.60080548e-01 5.41837715e-01
 2.34834458e+00 8.48079706e+00 8.08708873e-01 2.23730222e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963206644541
cond(S) = 348.3971064261852
E1 = -183.58957801888866  E_coul = 55.08018708663125
init E= -128.509390932257
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775394661240046  LUMO = 0.798855650816997
  mo_energy =
[-3.25550635e+01 -1.85257883e+00 -7.75394661e-01 -7.75394661e-01
 -7.75394661e-01  7.98855651e-01  7.98855651e-01  7.98855651e-01
  1.22760665e+00  3.81594160e+00  3.81594160e+00  3.81594160e+00
  7.42070696e+00  1.36888653e+01  1.36888653e+01  1.36888653e+01
  3.45429740e+01  4.96637507e+01  4.96637507e+01  4.96637507e+01
  1.37196223e+02  2.21462777e+02  2.21462777e+02  2.21462777e+02
  4.99143328e+02  1.86606753e+03  7.99606545e+03  4.77644194e+04]
E1 = -182.08328845976052  E_coul = 53.545564830215035
cycle= 1 E= -128.537723629545  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.514098
diis-c [-0.26429673  1.        ]
  HOMO = -0.884460263257448  LUMO = 0.773187324180465
  mo_energy =
[-3.28785959e+01 -1.96676715e+00 -8.84460263e-01 -8.84460263e-01
 -8.84460263e-01  7.73187324e-01  7.73187324e-01  7.73187324e-01
  1.18164976e+00  3.72137409e+00  3.72137409e+00  3.72137409e+00
  7.28818001e+00  1.35026200e+01  1.35026200e+01  1.35026200e+01
  3.42965789e+01  4.93867271e+01  4.93867271e+01  4.93867271e+01
  1.36878504e+02  2.21118934e+02  2.21118934e+02  2.21118934e+02
  4.98781451e+02  1.86566959e+03  7.99563854e+03  4.77639736e+04]
E1 = -182.84649903799945  E_coul = 54.306182244906914
cycle= 2 E= -128.540316793093  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0661
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261259
diis-c [-6.44350232e-04  3.36167098e-01  6.63832902e-01]
  HOMO = -0.848750339121447  LUMO = 0.781580317806146
  mo_energy =
[-3.27702803e+01 -1.92915052e+00 -8.48750339e-01 -8.48750339e-01
 -8.48750339e-01  7.81580318e-01  7.81580318e-01  7.81580318e-01
  1.19641237e+00  3.75204697e+00  3.75204697e+00  3.75204697e+00
  7.33164187e+00  1.35643273e+01  1.35643273e+01  1.35643273e+01
  3.43791882e+01  4.94795079e+01  4.94795079e+01  4.94795079e+01
  1.36984642e+02  2.21232135e+02  2.21232135e+02  2.21232135e+02
  4.98898514e+02  1.86579192e+03  7.99576331e+03  4.77640993e+04]
E1 = -182.5871945817249  E_coul = 54.04595361486826
cycle= 3 E= -128.541240966857  delta_E= -0.000924  |g|= 0.000497  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115998
diis-c [-1.21662695e-07 -2.24224334e-03 -1.69417437e-04  1.00241166e+00]
  HOMO = -0.849003810169781  LUMO = 0.781546032202545
  mo_energy =
[-3.27707438e+01 -1.92934815e+00 -8.49003810e-01 -8.49003810e-01
 -8.49003810e-01  7.81546032e-01  7.81546032e-01  7.81546032e-01
  1.19633642e+00  3.75187599e+00  3.75187599e+00  3.75187599e+00
  7.33142611e+00  1.35640296e+01  1.35640296e+01  1.35640296e+01
  3.43788308e+01  4.94791038e+01  4.94791038e+01  4.94791038e+01
  1.36984177e+02  2.21231609e+02  2.21231609e+02  2.21231609e+02
  4.98897925e+02  1.86579120e+03  7.99576249e+03  4.77640984e+04]
E1 = -182.58771425118536  E_coul = 54.046473263463255
cycle= 4 E= -128.541240987722  delta_E= -2.09e-08  |g|= 7.54e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185983
diis-c [-7.77100415e-10  1.82493541e-04  4.87582267e-04 -1.55931836e-01
  1.15526176e+00]
  HOMO = -0.849043571458732  LUMO = 0.781534510661554
  mo_energy =
[-3.27708150e+01 -1.92938020e+00 -8.49043571e-01 -8.49043571e-01
 -8.49043571e-01  7.81534511e-01  7.81534511e-01  7.81534511e-01
  1.19631866e+00  3.75183942e+00  3.75183942e+00  3.75183942e+00
  7.33138377e+00  1.35639742e+01  1.35639742e+01  1.35639742e+01
  3.43787684e+01  4.94790373e+01  4.94790373e+01  4.94790373e+01
  1.36984106e+02  2.21231534e+02  2.21231534e+02  2.21231534e+02
  4.98897846e+02  1.86579111e+03  7.99576240e+03  4.77640983e+04]
E1 = -182.5878565585379  E_coul = 54.04661557027206
cycle= 5 E= -128.541240988266  delta_E= -5.44e-10  |g|= 4.25e-06  |ddm|= 3.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5878565585379  E_coul = 54.04661557027206
  HOMO = -0.849041549106064  LUMO = 0.781535084936797
  mo_energy =
[-3.27708106e+01 -1.92937748e+00 -8.49041549e-01 -8.49041549e-01
 -8.49041549e-01  7.81535085e-01  7.81535085e-01  7.81535085e-01
  1.19632002e+00  3.75184131e+00  3.75184131e+00  3.75184131e+00
  7.33138661e+00  1.35639775e+01  1.35639775e+01  1.35639775e+01
  3.43787724e+01  4.94790415e+01  4.94790415e+01  4.94790415e+01
  1.36984110e+02  2.21231539e+02  2.21231539e+02  2.21231539e+02
  4.98897850e+02  1.86579112e+03  7.99576240e+03  4.77640983e+04]
E1 = -182.58784631157113  E_coul = 54.04660532330332
Extra cycle  E= -128.541240988268  delta_E= -1.96e-12  |g|= 1.46e-06  |ddm|= 1.74e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 348.3971064261852
E1 = -182.58784631157113  E_coul = 54.04660532330332
init E= -128.541240988268
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.849042281583163  LUMO = 0.781534925206479
  mo_energy =
[-3.27708129e+01 -1.92937812e+00 -8.49042282e-01 -8.49042282e-01
 -8.49042282e-01  7.81534925e-01  7.81534925e-01  7.81534925e-01
  1.19631980e+00  3.75184070e+00  3.75184070e+00  3.75184070e+00
  7.33138579e+00  1.35639762e+01  1.35639762e+01  1.35639762e+01
  3.43787708e+01  4.94790396e+01  4.94790396e+01  4.94790396e+01
  1.36984108e+02  2.21231536e+02  2.21231536e+02  2.21231536e+02
  4.98897848e+02  1.86579111e+03  7.99576240e+03  4.77640983e+04]
E1 = -182.58785204034777  E_coul = 54.04661105207992
cycle= 1 E= -128.541240988268  delta_E= -2.84e-14  |g|= 7.91e-07  |ddm|= 5.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58785204034777  E_coul = 54.04661105207992
  HOMO = -0.849041879732236  LUMO = 0.781535022173396
  mo_energy =
[-3.27708117e+01 -1.92937767e+00 -8.49041880e-01 -8.49041880e-01
 -8.49041880e-01  7.81535022e-01  7.81535022e-01  7.81535022e-01
  1.19631999e+00  3.75184105e+00  3.75184105e+00  3.75184105e+00
  7.33138629e+00  1.35639769e+01  1.35639769e+01  1.35639769e+01
  3.43787717e+01  4.94790406e+01  4.94790406e+01  4.94790406e+01
  1.36984109e+02  2.21231537e+02  2.21231537e+02  2.21231537e+02
  4.98897849e+02  1.86579112e+03  7.99576240e+03  4.77640983e+04]
E1 = -182.58784916993744  E_coul = 54.04660818166961
Extra cycle  E= -128.541240988268  delta_E= 2.84e-14  |g|= 3.9e-07  |ddm|= 2.78e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145468e+03 8.33264879e+02 2.35851591e+02
 7.55315128e+01 9.92721187e+00 2.66563250e+01 3.82992742e-01
 1.12399825e+00 2.90223482e+00 6.74567953e+00 2.16638129e+01
 9.18912245e+01 2.60080548e-01 2.34834458e+00 8.08708873e-01]
grad_E = [-2.15936028e-09  1.11614960e-07 -2.00817910e-06  1.70831997e-05
 -5.36167154e-05 -1.21213076e-04  7.82594569e-05 -5.03521233e-04
  4.42926107e-04 -2.05646525e-06 -3.54756334e-04  1.81686891e-05
 -6.78135770e-06 -6.92321015e-04  9.76331194e-04 -8.97498926e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941259        1
[INPUT] 0    0    [1    /1   ]  3661.45469521        1
[INPUT] 0    0    [1    /1   ]  833.264296157        1
[INPUT] 0    0    [1    /1   ]  235.863834132        1
[INPUT] 0    0    [1    /1   ]  75.4287774282        1
[INPUT] 0    0    [1    /1   ]  9.92907162366        1
[INPUT] 0    0    [1    /1   ]  26.6529540548        1
[INPUT] 0    0    [1    /1   ]  0.379746863662       1
[INPUT] 0    0    [1    /1   ]  1.10752901059        1
[INPUT] 0    0    [1    /1   ]  2.85386367293        1
[INPUT] 1    0    [1    /1   ]  6.93079640087        1
[INPUT] 1    0    [1    /1   ]  22.4057227664        1
[INPUT] 1    0    [1    /1   ]  95.6718422301        1
[INPUT] 1    0    [1    /1   ]  0.263286947521       1
[INPUT] 1    0    [1    /1   ]  2.39576232224        1
[INPUT] 1    0    [1    /1   ]  0.821692559102       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412587144, 1.0]], [0, [3661.454695209579, 1.0]], [0, [833.2642961572818, 1.0]], [0, [235.86383413196592, 1.0]], [0, [75.42877742822229, 1.0]], [0, [9.929071623661757, 1.0]], [0, [26.652954054760205, 1.0]], [0, [0.3797468636624248, 1.0]], [0, [1.107529010591072, 1.0]], [0, [2.8538636729276665, 1.0]], [1, [6.930796400874824, 1.0]], [1, [22.405722766431392, 1.0]], [1, [95.67184223005866, 1.0]], [1, [0.2632869475208876, 1.0]], [1, [2.3957623222392184, 1.0]], [1, [0.8216925591021365, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412587]
bas 1, expnt(s) = [3661.45469521]
bas 2, expnt(s) = [833.26429616]
bas 3, expnt(s) = [235.86383413]
bas 4, expnt(s) = [75.42877743]
bas 5, expnt(s) = [9.92907162]
bas 6, expnt(s) = [26.65295405]
bas 7, expnt(s) = [0.37974686]
bas 8, expnt(s) = [1.10752901]
bas 9, expnt(s) = [2.85386367]
bas 10, expnt(s) = [6.9307964]
bas 11, expnt(s) = [22.40572277]
bas 12, expnt(s) = [95.67184223]
bas 13, expnt(s) = [0.26328695]
bas 14, expnt(s) = [2.39576232]
bas 15, expnt(s) = [0.82169256]
CPU time:       258.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264296e+02 3.91833988e+02 2.35863834e+02 1.52058618e+02
 7.54287774e+01 6.46647832e+01 9.92907162e+00 1.41317683e+01
 2.66529541e+01 2.96363037e+01 3.79746864e-01 1.22218140e+00
 1.10752901e+00 2.72760424e+00 2.85386367e+00 5.54740587e+00
 6.93079640e+00 3.28067583e+01 2.24057228e+01 1.42210967e+02
 9.56718422e+01 8.72900141e+02 2.63286948e-01 5.50200593e-01
 2.39576232e+00 8.69538981e+00 8.21692559e-01 2.28229136e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99961187977149
cond(S) = 343.1130993442778
E1 = -183.58964208971878  E_coul = 55.08019197330084
init E= -128.509450116418
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775399029541591  LUMO = 0.812102002854123
  mo_energy =
[-3.25550449e+01 -1.85259150e+00 -7.75399030e-01 -7.75399030e-01
 -7.75399030e-01  8.12102003e-01  8.12102003e-01  8.12102003e-01
  1.20788413e+00  3.88830119e+00  3.88830119e+00  3.88830119e+00
  7.29155276e+00  1.40276228e+01  1.40276228e+01  1.40276228e+01
  3.42810464e+01  5.13231466e+01  5.13231466e+01  5.13231466e+01
  1.36856962e+02  2.30819241e+02  2.30819241e+02  2.30819241e+02
  4.98640356e+02  1.86550825e+03  7.99555109e+03  4.77639897e+04]
E1 = -182.08556750028598  E_coul = 53.54780424653517
cycle= 1 E= -128.537763253751  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.511579
diis-c [-0.26171355  1.        ]
  HOMO = -0.884292792514239  LUMO = 0.785906563982995
  mo_energy =
[-3.28781799e+01 -1.96657817e+00 -8.84292793e-01 -8.84292793e-01
 -8.84292793e-01  7.85906564e-01  7.85906564e-01  7.85906564e-01
  1.16276532e+00  3.79231883e+00  3.79231883e+00  3.79231883e+00
  7.16046786e+00  1.38392323e+01  1.38392323e+01  1.38392323e+01
  3.40350807e+01  5.10443298e+01  5.10443298e+01  5.10443298e+01
  1.36539629e+02  2.30474439e+02  2.30474439e+02  2.30474439e+02
  4.98278908e+02  1.86511076e+03  7.99512463e+03  4.77635444e+04]
E1 = -182.84737777185924  E_coul = 54.30702692005176
cycle= 2 E= -128.540350851807  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259796
diis-c [-6.43141413e-04  3.36001827e-01  6.63998173e-01]
  HOMO = -0.8486426706716  LUMO = 0.794470908203347
  mo_energy =
[-3.27700210e+01 -1.92902748e+00 -8.48642671e-01 -8.48642671e-01
 -8.48642671e-01  7.94470908e-01  7.94470908e-01  7.94470908e-01
  1.17725985e+00  3.82346196e+00  3.82346196e+00  3.82346196e+00
  7.20344758e+00  1.39016669e+01  1.39016669e+01  1.39016669e+01
  3.41175271e+01  5.11376949e+01  5.11376949e+01  5.11376949e+01
  1.36645619e+02  2.30587822e+02  2.30587822e+02  2.30587822e+02
  4.98395808e+02  1.86523292e+03  7.99524922e+03  4.77636699e+04]
E1 = -182.58865093935077  E_coul = 54.047379458205434
cycle= 3 E= -128.541271481145  delta_E= -0.000921  |g|= 0.000499  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116607
diis-c [-1.22988094e-07 -2.24859380e-03 -1.38555187e-04  1.00238715e+00]
  HOMO = -0.848896359952727  LUMO = 0.794435704775964
  mo_energy =
[-3.27704872e+01 -1.92922468e+00 -8.48896360e-01 -8.48896360e-01
 -8.48896360e-01  7.94435705e-01  7.94435705e-01  7.94435705e-01
  1.17718546e+00  3.82328832e+00  3.82328832e+00  3.82328832e+00
  7.20323378e+00  1.39013652e+01  1.39013652e+01  1.39013652e+01
  3.41171684e+01  5.11372861e+01  5.11372861e+01  5.11372861e+01
  1.36645151e+02  2.30587289e+02  2.30587289e+02  2.30587289e+02
  4.98395215e+02  1.86523219e+03  7.99524840e+03  4.77636691e+04]
E1 = -182.58918229630603  E_coul = 54.047910794110635
cycle= 4 E= -128.541271502195  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018554
diis-c [-7.87678490e-10  1.87862008e-04  4.86151046e-04 -1.57715912e-01
  1.15704190e+00]
  HOMO = -0.848935985838281  LUMO = 0.79442403797212
  mo_energy =
[-3.27705583e+01 -1.92925633e+00 -8.48935986e-01 -8.48935986e-01
 -8.48935986e-01  7.94424038e-01  7.94424038e-01  7.94424038e-01
  1.17716820e+00  3.82325151e+00  3.82325151e+00  3.82325151e+00
  7.20319205e+00  1.39013096e+01  1.39013096e+01  1.39013096e+01
  3.41171063e+01  5.11372195e+01  5.11372195e+01  5.11372195e+01
  1.36645080e+02  2.30587214e+02  2.30587214e+02  2.30587214e+02
  4.98395136e+02  1.86523210e+03  7.99524831e+03  4.77636690e+04]
E1 = -182.58932498913583  E_coul = 54.04805348639263
cycle= 5 E= -128.541271502743  delta_E= -5.48e-10  |g|= 4.37e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58932498913583  E_coul = 54.04805348639263
  HOMO = -0.848933899884387  LUMO = 0.79442464551237
  mo_energy =
[-3.27705538e+01 -1.92925353e+00 -8.48933900e-01 -8.48933900e-01
 -8.48933900e-01  7.94424646e-01  7.94424646e-01  7.94424646e-01
  1.17716959e+00  3.82325350e+00  3.82325350e+00  3.82325350e+00
  7.20319494e+00  1.39013130e+01  1.39013130e+01  1.39013130e+01
  3.41171104e+01  5.11372238e+01  5.11372238e+01  5.11372238e+01
  1.36645084e+02  2.30587218e+02  2.30587218e+02  2.30587218e+02
  4.98395140e+02  1.86523211e+03  7.99524831e+03  4.77636690e+04]
E1 = -182.58931450514243  E_coul = 54.04804300239778
Extra cycle  E= -128.541271502745  delta_E= -1.45e-12  |g|= 1.5e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264296e+02 2.35863834e+02
 7.54287774e+01 9.92907162e+00 2.66529541e+01 3.79746864e-01
 1.10752901e+00 2.85386367e+00 6.93079640e+00 2.24057228e+01
 9.56718422e+01 2.63286948e-01 2.39576232e+00 8.21692559e-01]
E = -128.54127150274465
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941259        1
[INPUT] 0    0    [1    /1   ]  3661.45469521        1
[INPUT] 0    0    [1    /1   ]  833.264296157        1
[INPUT] 0    0    [1    /1   ]  235.863834132        1
[INPUT] 0    0    [1    /1   ]  75.4287774282        1
[INPUT] 0    0    [1    /1   ]  9.92907162366        1
[INPUT] 0    0    [1    /1   ]  26.6529540548        1
[INPUT] 0    0    [1    /1   ]  0.379746863662       1
[INPUT] 0    0    [1    /1   ]  1.10752901059        1
[INPUT] 0    0    [1    /1   ]  2.85386367293        1
[INPUT] 1    0    [1    /1   ]  6.93079640087        1
[INPUT] 1    0    [1    /1   ]  22.4057227664        1
[INPUT] 1    0    [1    /1   ]  95.6718422301        1
[INPUT] 1    0    [1    /1   ]  0.263286947521       1
[INPUT] 1    0    [1    /1   ]  2.39576232224        1
[INPUT] 1    0    [1    /1   ]  0.821692559102       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412587144, 1.0]], [0, [3661.454695209579, 1.0]], [0, [833.2642961572818, 1.0]], [0, [235.86383413196592, 1.0]], [0, [75.42877742822229, 1.0]], [0, [9.929071623661757, 1.0]], [0, [26.652954054760205, 1.0]], [0, [0.3797468636624248, 1.0]], [0, [1.107529010591072, 1.0]], [0, [2.8538636729276665, 1.0]], [1, [6.930796400874824, 1.0]], [1, [22.405722766431392, 1.0]], [1, [95.67184223005866, 1.0]], [1, [0.2632869475208876, 1.0]], [1, [2.3957623222392184, 1.0]], [1, [0.8216925591021365, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412587]
bas 1, expnt(s) = [3661.45469521]
bas 2, expnt(s) = [833.26429616]
bas 3, expnt(s) = [235.86383413]
bas 4, expnt(s) = [75.42877743]
bas 5, expnt(s) = [9.92907162]
bas 6, expnt(s) = [26.65295405]
bas 7, expnt(s) = [0.37974686]
bas 8, expnt(s) = [1.10752901]
bas 9, expnt(s) = [2.85386367]
bas 10, expnt(s) = [6.9307964]
bas 11, expnt(s) = [22.40572277]
bas 12, expnt(s) = [95.67184223]
bas 13, expnt(s) = [0.26328695]
bas 14, expnt(s) = [2.39576232]
bas 15, expnt(s) = [0.82169256]
CPU time:       259.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264296e+02 3.91833988e+02 2.35863834e+02 1.52058618e+02
 7.54287774e+01 6.46647832e+01 9.92907162e+00 1.41317683e+01
 2.66529541e+01 2.96363037e+01 3.79746864e-01 1.22218140e+00
 1.10752901e+00 2.72760424e+00 2.85386367e+00 5.54740587e+00
 6.93079640e+00 3.28067583e+01 2.24057228e+01 1.42210967e+02
 9.56718422e+01 8.72900141e+02 2.63286948e-01 5.50200593e-01
 2.39576232e+00 8.69538981e+00 8.21692559e-01 2.28229136e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99961187977149
cond(S) = 343.1130993442778
E1 = -183.58964208971878  E_coul = 55.08019197330084
init E= -128.509450116418
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775399029541591  LUMO = 0.812102002854123
  mo_energy =
[-3.25550449e+01 -1.85259150e+00 -7.75399030e-01 -7.75399030e-01
 -7.75399030e-01  8.12102003e-01  8.12102003e-01  8.12102003e-01
  1.20788413e+00  3.88830119e+00  3.88830119e+00  3.88830119e+00
  7.29155276e+00  1.40276228e+01  1.40276228e+01  1.40276228e+01
  3.42810464e+01  5.13231466e+01  5.13231466e+01  5.13231466e+01
  1.36856962e+02  2.30819241e+02  2.30819241e+02  2.30819241e+02
  4.98640356e+02  1.86550825e+03  7.99555109e+03  4.77639897e+04]
E1 = -182.08556750028598  E_coul = 53.54780424653517
cycle= 1 E= -128.537763253751  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.511579
diis-c [-0.26171355  1.        ]
  HOMO = -0.884292792514239  LUMO = 0.785906563982995
  mo_energy =
[-3.28781799e+01 -1.96657817e+00 -8.84292793e-01 -8.84292793e-01
 -8.84292793e-01  7.85906564e-01  7.85906564e-01  7.85906564e-01
  1.16276532e+00  3.79231883e+00  3.79231883e+00  3.79231883e+00
  7.16046786e+00  1.38392323e+01  1.38392323e+01  1.38392323e+01
  3.40350807e+01  5.10443298e+01  5.10443298e+01  5.10443298e+01
  1.36539629e+02  2.30474439e+02  2.30474439e+02  2.30474439e+02
  4.98278908e+02  1.86511076e+03  7.99512463e+03  4.77635444e+04]
E1 = -182.84737777185924  E_coul = 54.30702692005176
cycle= 2 E= -128.540350851807  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259796
diis-c [-6.43141413e-04  3.36001827e-01  6.63998173e-01]
  HOMO = -0.8486426706716  LUMO = 0.794470908203347
  mo_energy =
[-3.27700210e+01 -1.92902748e+00 -8.48642671e-01 -8.48642671e-01
 -8.48642671e-01  7.94470908e-01  7.94470908e-01  7.94470908e-01
  1.17725985e+00  3.82346196e+00  3.82346196e+00  3.82346196e+00
  7.20344758e+00  1.39016669e+01  1.39016669e+01  1.39016669e+01
  3.41175271e+01  5.11376949e+01  5.11376949e+01  5.11376949e+01
  1.36645619e+02  2.30587822e+02  2.30587822e+02  2.30587822e+02
  4.98395808e+02  1.86523292e+03  7.99524922e+03  4.77636699e+04]
E1 = -182.58865093935077  E_coul = 54.047379458205434
cycle= 3 E= -128.541271481145  delta_E= -0.000921  |g|= 0.000499  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116607
diis-c [-1.22988094e-07 -2.24859380e-03 -1.38555187e-04  1.00238715e+00]
  HOMO = -0.848896359952727  LUMO = 0.794435704775964
  mo_energy =
[-3.27704872e+01 -1.92922468e+00 -8.48896360e-01 -8.48896360e-01
 -8.48896360e-01  7.94435705e-01  7.94435705e-01  7.94435705e-01
  1.17718546e+00  3.82328832e+00  3.82328832e+00  3.82328832e+00
  7.20323378e+00  1.39013652e+01  1.39013652e+01  1.39013652e+01
  3.41171684e+01  5.11372861e+01  5.11372861e+01  5.11372861e+01
  1.36645151e+02  2.30587289e+02  2.30587289e+02  2.30587289e+02
  4.98395215e+02  1.86523219e+03  7.99524840e+03  4.77636691e+04]
E1 = -182.58918229630603  E_coul = 54.047910794110635
cycle= 4 E= -128.541271502195  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018554
diis-c [-7.87678490e-10  1.87862008e-04  4.86151046e-04 -1.57715912e-01
  1.15704190e+00]
  HOMO = -0.848935985838281  LUMO = 0.79442403797212
  mo_energy =
[-3.27705583e+01 -1.92925633e+00 -8.48935986e-01 -8.48935986e-01
 -8.48935986e-01  7.94424038e-01  7.94424038e-01  7.94424038e-01
  1.17716820e+00  3.82325151e+00  3.82325151e+00  3.82325151e+00
  7.20319205e+00  1.39013096e+01  1.39013096e+01  1.39013096e+01
  3.41171063e+01  5.11372195e+01  5.11372195e+01  5.11372195e+01
  1.36645080e+02  2.30587214e+02  2.30587214e+02  2.30587214e+02
  4.98395136e+02  1.86523210e+03  7.99524831e+03  4.77636690e+04]
E1 = -182.58932498913583  E_coul = 54.04805348639263
cycle= 5 E= -128.541271502743  delta_E= -5.48e-10  |g|= 4.37e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58932498913583  E_coul = 54.04805348639263
  HOMO = -0.848933899884387  LUMO = 0.79442464551237
  mo_energy =
[-3.27705538e+01 -1.92925353e+00 -8.48933900e-01 -8.48933900e-01
 -8.48933900e-01  7.94424646e-01  7.94424646e-01  7.94424646e-01
  1.17716959e+00  3.82325350e+00  3.82325350e+00  3.82325350e+00
  7.20319494e+00  1.39013130e+01  1.39013130e+01  1.39013130e+01
  3.41171104e+01  5.11372238e+01  5.11372238e+01  5.11372238e+01
  1.36645084e+02  2.30587218e+02  2.30587218e+02  2.30587218e+02
  4.98395140e+02  1.86523211e+03  7.99524831e+03  4.77636690e+04]
E1 = -182.58931450514243  E_coul = 54.04804300239778
Extra cycle  E= -128.541271502745  delta_E= -1.45e-12  |g|= 1.5e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.1130993442778
E1 = -182.58931450514243  E_coul = 54.04804300239778
init E= -128.541271502745
    CPU time for initialize scf      0.31 sec, wall time      0.31 sec
  HOMO = -0.848934648739716  LUMO = 0.794424478826597
  mo_energy =
[-3.27705561e+01 -1.92925419e+00 -8.48934649e-01 -8.48934649e-01
 -8.48934649e-01  7.94424479e-01  7.94424479e-01  7.94424479e-01
  1.17716937e+00  3.82325286e+00  3.82325286e+00  3.82325286e+00
  7.20319412e+00  1.39013117e+01  1.39013117e+01  1.39013117e+01
  3.41171087e+01  5.11372218e+01  5.11372218e+01  5.11372218e+01
  1.36645082e+02  2.30587216e+02  2.30587216e+02  2.30587216e+02
  4.98395138e+02  1.86523211e+03  7.99524831e+03  4.77636690e+04]
E1 = -182.58932037341387  E_coul = 54.048048870668985
cycle= 1 E= -128.541271502745  delta_E= -2.27e-13  |g|= 8.1e-07  |ddm|= 5.47e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58932037341387  E_coul = 54.048048870668985
  HOMO = -0.848934237126916  LUMO = 0.794424580332274
  mo_energy =
[-3.27705549e+01 -1.92925373e+00 -8.48934237e-01 -8.48934237e-01
 -8.48934237e-01  7.94424580e-01  7.94424580e-01  7.94424580e-01
  1.17716956e+00  3.82325323e+00  3.82325323e+00  3.82325323e+00
  7.20319463e+00  1.39013124e+01  1.39013124e+01  1.39013124e+01
  3.41171097e+01  5.11372229e+01  5.11372229e+01  5.11372229e+01
  1.36645083e+02  2.30587217e+02  2.30587217e+02  2.30587217e+02
  4.98395139e+02  1.86523211e+03  7.99524831e+03  4.77636690e+04]
E1 = -182.5893174354993  E_coul = 54.04804593275457
Extra cycle  E= -128.541271502745  delta_E= 1.42e-13  |g|= 3.99e-07  |ddm|= 2.85e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.39 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264296e+02 2.35863834e+02
 7.54287774e+01 9.92907162e+00 2.66529541e+01 3.79746864e-01
 1.10752901e+00 2.85386367e+00 6.93079640e+00 2.24057228e+01
 9.56718422e+01 2.63286948e-01 2.39576232e+00 8.21692559e-01]
grad_E = [-2.55179199e-09  1.32144741e-07 -2.38721212e-06  2.07566923e-05
 -6.90143037e-05 -6.47124239e-05  9.23117197e-05  1.94783308e-04
 -9.48558628e-06  1.73695833e-05 -1.62547182e-04  7.58617408e-06
 -3.31180195e-06 -2.44152697e-04  4.81768127e-04 -5.02442343e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45470904        1
[INPUT] 0    0    [1    /1   ]  833.263896797        1
[INPUT] 0    0    [1    /1   ]  235.871123538        1
[INPUT] 0    0    [1    /1   ]  75.3750873137        1
[INPUT] 0    0    [1    /1   ]  9.92672238736        1
[INPUT] 0    0    [1    /1   ]  26.609435719         1
[INPUT] 0    0    [1    /1   ]  0.379528814742       1
[INPUT] 0    0    [1    /1   ]  1.10883202754        1
[INPUT] 0    0    [1    /1   ]  2.87308131267        1
[INPUT] 1    0    [1    /1   ]  7.0529794921         1
[INPUT] 1    0    [1    /1   ]  22.8952735255        1
[INPUT] 1    0    [1    /1   ]  98.129004631         1
[INPUT] 1    0    [1    /1   ]  0.265440996084       1
[INPUT] 1    0    [1    /1   ]  2.42615495212        1
[INPUT] 1    0    [1    /1   ]  0.830152519532       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125615626, 1.0]], [0, [3661.4547090428614, 1.0]], [0, [833.2638967968634, 1.0]], [0, [235.87112353789695, 1.0]], [0, [75.37508731367157, 1.0]], [0, [9.926722387363117, 1.0]], [0, [26.60943571896225, 1.0]], [0, [0.3795288147415865, 1.0]], [0, [1.1088320275355463, 1.0]], [0, [2.873081312673495, 1.0]], [1, [7.052979492099129, 1.0]], [1, [22.895273525545562, 1.0]], [1, [98.12900463097503, 1.0]], [1, [0.2654409960836099, 1.0]], [1, [2.426154952121264, 1.0]], [1, [0.8301525195315358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412562]
bas 1, expnt(s) = [3661.45470904]
bas 2, expnt(s) = [833.2638968]
bas 3, expnt(s) = [235.87112354]
bas 4, expnt(s) = [75.37508731]
bas 5, expnt(s) = [9.92672239]
bas 6, expnt(s) = [26.60943572]
bas 7, expnt(s) = [0.37952881]
bas 8, expnt(s) = [1.10883203]
bas 9, expnt(s) = [2.87308131]
bas 10, expnt(s) = [7.05297949]
bas 11, expnt(s) = [22.89527353]
bas 12, expnt(s) = [98.12900463]
bas 13, expnt(s) = [0.265441]
bas 14, expnt(s) = [2.42615495]
bas 15, expnt(s) = [0.83015252]
CPU time:       263.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263897e+02 3.91833847e+02 2.35871124e+02 1.52062143e+02
 7.53750873e+01 6.46302589e+01 9.92672239e+00 1.41292605e+01
 2.66094357e+01 2.96000042e+01 3.79528815e-01 1.22165504e+00
 1.10883203e+00 2.73001068e+00 2.87308131e+00 5.57539912e+00
 7.05297949e+00 3.35312828e+01 2.28952735e+01 1.46105541e+02
 9.81290046e+01 9.01013161e+02 2.65440996e-01 5.55833081e-01
 2.42615495e+00 8.83349486e+00 8.30152520e-01 2.31170150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594169358476
cond(S) = 344.19266718861996
E1 = -183.5896307485717  E_coul = 55.08019147775772
init E= -128.509439270814
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400268148589  LUMO = 0.820934005843811
  mo_energy =
[-3.25550423e+01 -1.85259073e+00 -7.75400268e-01 -7.75400268e-01
 -7.75400268e-01  8.20934006e-01  8.20934006e-01  8.20934006e-01
  1.20870431e+00  3.93549584e+00  3.93549584e+00  3.93549584e+00
  7.31946071e+00  1.42493987e+01  1.42493987e+01  1.42493987e+01
  3.43353123e+01  5.24199297e+01  5.24199297e+01  5.24199297e+01
  1.36798443e+02  2.36948224e+02  2.36948224e+02  2.36948224e+02
  4.98421772e+02  1.86523791e+03  7.99529834e+03  4.77637778e+04]
E1 = -182.08708808856912  E_coul = 53.54931028626812
cycle= 1 E= -128.537777802301  delta_E= -0.0283  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.510012
diis-c [-0.26011235  1.        ]
  HOMO = -0.884177722605404  LUMO = 0.794394456108095
  mo_energy =
[-3.28779118e+01 -1.96644059e+00 -8.84177723e-01 -8.84177723e-01
 -8.84177723e-01  7.94394456e-01  7.94394456e-01  7.94394456e-01
  1.16358796e+00  3.83861748e+00  3.83861748e+00  3.83861748e+00
  7.18816157e+00  1.40596494e+01  1.40596494e+01  1.40596494e+01
  3.40895732e+01  5.21399879e+01  5.21399879e+01  5.21399879e+01
  1.36481429e+02  2.36602841e+02  2.36602841e+02  2.36602841e+02
  4.98060614e+02  1.86484070e+03  7.99487216e+03  4.77633328e+04]
E1 = -182.84791649034335  E_coul = 54.307554941851784
cycle= 2 E= -128.540361548492  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258879
diis-c [-6.43714181e-04  3.35890446e-01  6.64109554e-01]
  HOMO = -0.848570059987415  LUMO = 0.803070893314307
  mo_energy =
[-3.27698630e+01 -1.92893607e+00 -8.48570060e-01 -8.48570060e-01
 -8.48570060e-01  8.03070893e-01  8.03070893e-01  8.03070893e-01
  1.17808569e+00  3.87005691e+00  3.87005691e+00  3.87005691e+00
  7.23121245e+00  1.41225427e+01  1.41225427e+01  1.41225427e+01
  3.41719271e+01  5.22337113e+01  5.22337113e+01  5.22337113e+01
  1.36587292e+02  2.36716321e+02  2.36716321e+02  2.36716321e+02
  4.98177394e+02  1.86496274e+03  7.99499663e+03  4.77634582e+04]
E1 = -182.58960268141638  E_coul = 54.048322995624446
cycle= 3 E= -128.541279685792  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116828
diis-c [-1.24214003e-07 -2.25424541e-03 -1.29638995e-04  1.00238388e+00]
  HOMO = -0.848823248503414  LUMO = 0.803035309261213
  mo_energy =
[-3.27703296e+01 -1.92913204e+00 -8.48823249e-01 -8.48823249e-01
 -8.48823249e-01  8.03035309e-01  8.03035309e-01  8.03035309e-01
  1.17801211e+00  3.86988218e+00  3.86988218e+00  3.86988218e+00
  7.23099908e+00  1.41222395e+01  1.41222395e+01  1.41222395e+01
  3.41715686e+01  5.22333008e+01  5.22333008e+01  5.22333008e+01
  1.36586824e+02  2.36715785e+02  2.36715785e+02  2.36715785e+02
  4.98176800e+02  1.86496201e+03  7.99499581e+03  4.77634573e+04]
E1 = -182.59014006007465  E_coul = 54.04886035320337
cycle= 4 E= -128.541279706871  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185491
diis-c [-7.99950441e-10  1.92553425e-04  4.87438188e-04 -1.59442813e-01
  1.15876282e+00]
  HOMO = -0.848862721654413  LUMO = 0.803023578259277
  mo_energy =
[-3.27704006e+01 -1.92916331e+00 -8.48862722e-01 -8.48862722e-01
 -8.48862722e-01  8.03023578e-01  8.03023578e-01  8.03023578e-01
  1.17799511e+00  3.86984528e+00  3.86984528e+00  3.86984528e+00
  7.23095758e+00  1.41221839e+01  1.41221839e+01  1.41221839e+01
  3.41715066e+01  5.22332342e+01  5.22332342e+01  5.22332342e+01
  1.36586753e+02  2.36715710e+02  2.36715710e+02  2.36715710e+02
  4.98176721e+02  1.86496193e+03  7.99499572e+03  4.77634572e+04]
E1 = -182.59028334024185  E_coul = 54.049003632819584
cycle= 5 E= -128.541279707422  delta_E= -5.51e-10  |g|= 4.47e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59028334024185  E_coul = 54.049003632819584
  HOMO = -0.848860568906839  LUMO = 0.803024215458265
  mo_energy =
[-3.27703959e+01 -1.92916044e+00 -8.48860569e-01 -8.48860569e-01
 -8.48860569e-01  8.03024215e-01  8.03024215e-01  8.03024215e-01
  1.17799654e+00  3.86984735e+00  3.86984735e+00  3.86984735e+00
  7.23096056e+00  1.41221874e+01  1.41221874e+01  1.41221874e+01
  3.41715109e+01  5.22332387e+01  5.22332387e+01  5.22332387e+01
  1.36586758e+02  2.36715714e+02  2.36715714e+02  2.36715714e+02
  4.98176725e+02  1.86496193e+03  7.99499572e+03  4.77634572e+04]
E1 = -182.59027261130694  E_coul = 54.048992903883054
Extra cycle  E= -128.541279707424  delta_E= -1.62e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263897e+02 2.35871124e+02
 7.53750873e+01 9.92672239e+00 2.66094357e+01 3.79528815e-01
 1.10883203e+00 2.87308131e+00 7.05297949e+00 2.28952735e+01
 9.81290046e+01 2.65440996e-01 2.42615495e+00 8.30152520e-01]
E = -128.54127970742388
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45470904        1
[INPUT] 0    0    [1    /1   ]  833.263896797        1
[INPUT] 0    0    [1    /1   ]  235.871123538        1
[INPUT] 0    0    [1    /1   ]  75.3750873137        1
[INPUT] 0    0    [1    /1   ]  9.92672238736        1
[INPUT] 0    0    [1    /1   ]  26.609435719         1
[INPUT] 0    0    [1    /1   ]  0.379528814742       1
[INPUT] 0    0    [1    /1   ]  1.10883202754        1
[INPUT] 0    0    [1    /1   ]  2.87308131267        1
[INPUT] 1    0    [1    /1   ]  7.0529794921         1
[INPUT] 1    0    [1    /1   ]  22.8952735255        1
[INPUT] 1    0    [1    /1   ]  98.129004631         1
[INPUT] 1    0    [1    /1   ]  0.265440996084       1
[INPUT] 1    0    [1    /1   ]  2.42615495212        1
[INPUT] 1    0    [1    /1   ]  0.830152519532       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125615626, 1.0]], [0, [3661.4547090428614, 1.0]], [0, [833.2638967968634, 1.0]], [0, [235.87112353789695, 1.0]], [0, [75.37508731367157, 1.0]], [0, [9.926722387363117, 1.0]], [0, [26.60943571896225, 1.0]], [0, [0.3795288147415865, 1.0]], [0, [1.1088320275355463, 1.0]], [0, [2.873081312673495, 1.0]], [1, [7.052979492099129, 1.0]], [1, [22.895273525545562, 1.0]], [1, [98.12900463097503, 1.0]], [1, [0.2654409960836099, 1.0]], [1, [2.426154952121264, 1.0]], [1, [0.8301525195315358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412562]
bas 1, expnt(s) = [3661.45470904]
bas 2, expnt(s) = [833.2638968]
bas 3, expnt(s) = [235.87112354]
bas 4, expnt(s) = [75.37508731]
bas 5, expnt(s) = [9.92672239]
bas 6, expnt(s) = [26.60943572]
bas 7, expnt(s) = [0.37952881]
bas 8, expnt(s) = [1.10883203]
bas 9, expnt(s) = [2.87308131]
bas 10, expnt(s) = [7.05297949]
bas 11, expnt(s) = [22.89527353]
bas 12, expnt(s) = [98.12900463]
bas 13, expnt(s) = [0.265441]
bas 14, expnt(s) = [2.42615495]
bas 15, expnt(s) = [0.83015252]
CPU time:       264.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263897e+02 3.91833847e+02 2.35871124e+02 1.52062143e+02
 7.53750873e+01 6.46302589e+01 9.92672239e+00 1.41292605e+01
 2.66094357e+01 2.96000042e+01 3.79528815e-01 1.22165504e+00
 1.10883203e+00 2.73001068e+00 2.87308131e+00 5.57539912e+00
 7.05297949e+00 3.35312828e+01 2.28952735e+01 1.46105541e+02
 9.81290046e+01 9.01013161e+02 2.65440996e-01 5.55833081e-01
 2.42615495e+00 8.83349486e+00 8.30152520e-01 2.31170150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594169358476
cond(S) = 344.19266718861996
E1 = -183.5896307485717  E_coul = 55.08019147775772
init E= -128.509439270814
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775400268148589  LUMO = 0.820934005843811
  mo_energy =
[-3.25550423e+01 -1.85259073e+00 -7.75400268e-01 -7.75400268e-01
 -7.75400268e-01  8.20934006e-01  8.20934006e-01  8.20934006e-01
  1.20870431e+00  3.93549584e+00  3.93549584e+00  3.93549584e+00
  7.31946071e+00  1.42493987e+01  1.42493987e+01  1.42493987e+01
  3.43353123e+01  5.24199297e+01  5.24199297e+01  5.24199297e+01
  1.36798443e+02  2.36948224e+02  2.36948224e+02  2.36948224e+02
  4.98421772e+02  1.86523791e+03  7.99529834e+03  4.77637778e+04]
E1 = -182.08708808856912  E_coul = 53.54931028626812
cycle= 1 E= -128.537777802301  delta_E= -0.0283  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.510012
diis-c [-0.26011235  1.        ]
  HOMO = -0.884177722605404  LUMO = 0.794394456108095
  mo_energy =
[-3.28779118e+01 -1.96644059e+00 -8.84177723e-01 -8.84177723e-01
 -8.84177723e-01  7.94394456e-01  7.94394456e-01  7.94394456e-01
  1.16358796e+00  3.83861748e+00  3.83861748e+00  3.83861748e+00
  7.18816157e+00  1.40596494e+01  1.40596494e+01  1.40596494e+01
  3.40895732e+01  5.21399879e+01  5.21399879e+01  5.21399879e+01
  1.36481429e+02  2.36602841e+02  2.36602841e+02  2.36602841e+02
  4.98060614e+02  1.86484070e+03  7.99487216e+03  4.77633328e+04]
E1 = -182.84791649034335  E_coul = 54.307554941851784
cycle= 2 E= -128.540361548492  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.258879
diis-c [-6.43714181e-04  3.35890446e-01  6.64109554e-01]
  HOMO = -0.848570059987415  LUMO = 0.803070893314307
  mo_energy =
[-3.27698630e+01 -1.92893607e+00 -8.48570060e-01 -8.48570060e-01
 -8.48570060e-01  8.03070893e-01  8.03070893e-01  8.03070893e-01
  1.17808569e+00  3.87005691e+00  3.87005691e+00  3.87005691e+00
  7.23121245e+00  1.41225427e+01  1.41225427e+01  1.41225427e+01
  3.41719271e+01  5.22337113e+01  5.22337113e+01  5.22337113e+01
  1.36587292e+02  2.36716321e+02  2.36716321e+02  2.36716321e+02
  4.98177394e+02  1.86496274e+03  7.99499663e+03  4.77634582e+04]
E1 = -182.58960268141638  E_coul = 54.048322995624446
cycle= 3 E= -128.541279685792  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116828
diis-c [-1.24214003e-07 -2.25424541e-03 -1.29638995e-04  1.00238388e+00]
  HOMO = -0.848823248503414  LUMO = 0.803035309261213
  mo_energy =
[-3.27703296e+01 -1.92913204e+00 -8.48823249e-01 -8.48823249e-01
 -8.48823249e-01  8.03035309e-01  8.03035309e-01  8.03035309e-01
  1.17801211e+00  3.86988218e+00  3.86988218e+00  3.86988218e+00
  7.23099908e+00  1.41222395e+01  1.41222395e+01  1.41222395e+01
  3.41715686e+01  5.22333008e+01  5.22333008e+01  5.22333008e+01
  1.36586824e+02  2.36715785e+02  2.36715785e+02  2.36715785e+02
  4.98176800e+02  1.86496201e+03  7.99499581e+03  4.77634573e+04]
E1 = -182.59014006007465  E_coul = 54.04886035320337
cycle= 4 E= -128.541279706871  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185491
diis-c [-7.99950441e-10  1.92553425e-04  4.87438188e-04 -1.59442813e-01
  1.15876282e+00]
  HOMO = -0.848862721654413  LUMO = 0.803023578259277
  mo_energy =
[-3.27704006e+01 -1.92916331e+00 -8.48862722e-01 -8.48862722e-01
 -8.48862722e-01  8.03023578e-01  8.03023578e-01  8.03023578e-01
  1.17799511e+00  3.86984528e+00  3.86984528e+00  3.86984528e+00
  7.23095758e+00  1.41221839e+01  1.41221839e+01  1.41221839e+01
  3.41715066e+01  5.22332342e+01  5.22332342e+01  5.22332342e+01
  1.36586753e+02  2.36715710e+02  2.36715710e+02  2.36715710e+02
  4.98176721e+02  1.86496193e+03  7.99499572e+03  4.77634572e+04]
E1 = -182.59028334024185  E_coul = 54.049003632819584
cycle= 5 E= -128.541279707422  delta_E= -5.51e-10  |g|= 4.47e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59028334024185  E_coul = 54.049003632819584
  HOMO = -0.848860568906839  LUMO = 0.803024215458265
  mo_energy =
[-3.27703959e+01 -1.92916044e+00 -8.48860569e-01 -8.48860569e-01
 -8.48860569e-01  8.03024215e-01  8.03024215e-01  8.03024215e-01
  1.17799654e+00  3.86984735e+00  3.86984735e+00  3.86984735e+00
  7.23096056e+00  1.41221874e+01  1.41221874e+01  1.41221874e+01
  3.41715109e+01  5.22332387e+01  5.22332387e+01  5.22332387e+01
  1.36586758e+02  2.36715714e+02  2.36715714e+02  2.36715714e+02
  4.98176725e+02  1.86496193e+03  7.99499572e+03  4.77634572e+04]
E1 = -182.59027261130694  E_coul = 54.048992903883054
Extra cycle  E= -128.541279707424  delta_E= -1.62e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.19266718861996
E1 = -182.59027261130694  E_coul = 54.048992903883054
init E= -128.541279707424
    CPU time for initialize scf      0.31 sec, wall time      0.31 sec
  HOMO = -0.848861334334728  LUMO = 0.803024042804679
  mo_energy =
[-3.27703983e+01 -1.92916111e+00 -8.48861334e-01 -8.48861334e-01
 -8.48861334e-01  8.03024043e-01  8.03024043e-01  8.03024043e-01
  1.17799632e+00  3.86984670e+00  3.86984670e+00  3.86984670e+00
  7.23095971e+00  1.41221861e+01  1.41221861e+01  1.41221861e+01
  3.41715092e+01  5.22332366e+01  5.22332366e+01  5.22332366e+01
  1.36586755e+02  2.36715712e+02  2.36715712e+02  2.36715712e+02
  4.98176723e+02  1.86496193e+03  7.99499572e+03  4.77634572e+04]
E1 = -182.5902786224261  E_coul = 54.04899891500177
cycle= 1 E= -128.541279707424  delta_E= -4.55e-13  |g|= 8.29e-07  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5902786224261  E_coul = 54.04899891500177
  HOMO = -0.848860912630845  LUMO = 0.803024148264477
  mo_energy =
[-3.27703970e+01 -1.92916064e+00 -8.48860913e-01 -8.48860913e-01
 -8.48860913e-01  8.03024148e-01  8.03024148e-01  8.03024148e-01
  1.17799651e+00  3.86984708e+00  3.86984708e+00  3.86984708e+00
  7.23096024e+00  1.41221868e+01  1.41221868e+01  1.41221868e+01
  3.41715101e+01  5.22332377e+01  5.22332377e+01  5.22332377e+01
  1.36586757e+02  2.36715713e+02  2.36715713e+02  2.36715713e+02
  4.98176724e+02  1.86496193e+03  7.99499572e+03  4.77634572e+04]
E1 = -182.59027561464842  E_coul = 54.048995907224246
Extra cycle  E= -128.541279707424  delta_E= 1.71e-13  |g|= 4.08e-07  |ddm|= 2.92e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.38 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263897e+02 2.35871124e+02
 7.53750873e+01 9.92672239e+00 2.66094357e+01 3.79528815e-01
 1.10883203e+00 2.87308131e+00 7.05297949e+00 2.28952735e+01
 9.81290046e+01 2.65440996e-01 2.42615495e+00 8.30152520e-01]
grad_E = [-2.52552781e-09  1.30621131e-07 -2.34556837e-06  1.98836331e-05
 -5.85309451e-05  8.71620725e-06  4.45725550e-05  2.82994148e-04
 -1.88549589e-04  6.03658194e-05 -8.34236421e-06 -9.26875093e-07
 -1.55464140e-06  7.42430308e-05  4.50160620e-05 -9.62865180e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45471228        1
[INPUT] 0    0    [1    /1   ]  833.263805075        1
[INPUT] 0    0    [1    /1   ]  235.872755703        1
[INPUT] 0    0    [1    /1   ]  75.3635607749        1
[INPUT] 0    0    [1    /1   ]  9.9269247592         1
[INPUT] 0    0    [1    /1   ]  26.595592008         1
[INPUT] 0    0    [1    /1   ]  0.380173401612       1
[INPUT] 0    0    [1    /1   ]  1.11234513074        1
[INPUT] 0    0    [1    /1   ]  2.88040761446        1
[INPUT] 1    0    [1    /1   ]  7.07859087728        1
[INPUT] 1    0    [1    /1   ]  23.0041202676        1
[INPUT] 1    0    [1    /1   ]  98.7093751218        1
[INPUT] 1    0    [1    /1   ]  0.265868184126       1
[INPUT] 1    0    [1    /1   ]  2.43259234134        1
[INPUT] 1    0    [1    /1   ]  0.831962941499       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125555447, 1.0]], [0, [3661.454712275633, 1.0]], [0, [833.2638050754592, 1.0]], [0, [235.8727557029594, 1.0]], [0, [75.36356077491519, 1.0]], [0, [9.926924759200032, 1.0]], [0, [26.595592008046346, 1.0]], [0, [0.38017340161244756, 1.0]], [0, [1.112345130735768, 1.0]], [0, [2.880407614461173, 1.0]], [1, [7.078590877282395, 1.0]], [1, [23.00412026756595, 1.0]], [1, [98.70937512181723, 1.0]], [1, [0.26586818412607555, 1.0]], [1, [2.4325923413382116, 1.0]], [1, [0.8319629414985905, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412556]
bas 1, expnt(s) = [3661.45471228]
bas 2, expnt(s) = [833.26380508]
bas 3, expnt(s) = [235.8727557]
bas 4, expnt(s) = [75.36356077]
bas 5, expnt(s) = [9.92692476]
bas 6, expnt(s) = [26.59559201]
bas 7, expnt(s) = [0.3801734]
bas 8, expnt(s) = [1.11234513]
bas 9, expnt(s) = [2.88040761]
bas 10, expnt(s) = [7.07859088]
bas 11, expnt(s) = [23.00412027]
bas 12, expnt(s) = [98.70937512]
bas 13, expnt(s) = [0.26586818]
bas 14, expnt(s) = [2.43259234]
bas 15, expnt(s) = [0.83196294]
CPU time:       267.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263805e+02 3.91833815e+02 2.35872756e+02 1.52062932e+02
 7.53635608e+01 6.46228462e+01 9.92692476e+00 1.41294765e+01
 2.65955920e+01 2.95884538e+01 3.80173402e-01 1.22321084e+00
 1.11234513e+00 2.73649521e+00 2.88040761e+00 5.58605860e+00
 7.07859088e+00 3.36835539e+01 2.30041203e+01 1.46974310e+02
 9.87093751e+01 9.07679226e+02 2.65868184e-01 5.56951470e-01
 2.43259234e+00 8.86280229e+00 8.31962941e-01 2.31800501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999589252235054
cond(S) = 345.3684274601164
E1 = -183.5896054582358  E_coul = 55.08018130791889
init E= -128.509424150317
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400822863752  LUMO = 0.82273085944615
  mo_energy =
[-3.25550460e+01 -1.85258939e+00 -7.75400823e-01 -7.75400823e-01
 -7.75400823e-01  8.22730859e-01  8.22730859e-01  8.22730859e-01
  1.21265415e+00  3.94546078e+00  3.94546078e+00  3.94546078e+00
  7.34289102e+00  1.42962699e+01  1.42962699e+01  1.42962699e+01
  3.43751122e+01  5.26584522e+01  5.26584522e+01  5.26584522e+01
  1.36806637e+02  2.38364401e+02  2.38364401e+02  2.38364401e+02
  4.98387182e+02  1.86518905e+03  7.99525178e+03  4.77637387e+04]
E1 = -182.08735020162126  E_coul = 53.549570314199144
cycle= 1 E= -128.537779887422  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509631
diis-c [-0.25972339  1.        ]
  HOMO = -0.884158132044893  LUMO = 0.796118583307886
  mo_energy =
[-3.28778655e+01 -1.96641546e+00 -8.84158132e-01 -8.84158132e-01
 -8.84158132e-01  7.96118583e-01  7.96118583e-01  7.96118583e-01
  1.16740778e+00  3.84838708e+00  3.84838708e+00  3.84838708e+00
  7.21141225e+00  1.41062320e+01  1.41062320e+01  1.41062320e+01
  3.41294205e+01  5.23782590e+01  5.23782590e+01  5.23782590e+01
  1.36489693e+02  2.38018870e+02  2.38018870e+02  2.38018870e+02
  4.98026081e+02  1.86479189e+03  7.99482566e+03  4.77632937e+04]
E1 = -182.84794718122626  E_coul = 54.307584496563194
cycle= 2 E= -128.540362684663  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258661
diis-c [-6.43926120e-04  3.35867939e-01  6.64132061e-01]
  HOMO = -0.848560838228275  LUMO = 0.804817828945899
  mo_energy =
[-3.27698430e+01 -1.92892186e+00 -8.48560838e-01 -8.48560838e-01
 -8.48560838e-01  8.04817829e-01  8.04817829e-01  8.04817829e-01
  1.18194654e+00  3.87988812e+00  3.87988812e+00  3.87988812e+00
  7.25451930e+00  1.41692193e+01  1.41692193e+01  1.41692193e+01
  3.42117519e+01  5.24720580e+01  5.24720580e+01  5.24720580e+01
  1.36595524e+02  2.38132372e+02  2.38132372e+02  2.38132372e+02
  4.98142831e+02  1.86491390e+03  7.99495010e+03  4.77634191e+04]
E1 = -182.589719679851  E_coul = 54.04843939841315
cycle= 3 E= -128.541280281438  delta_E= -0.000918  |g|= 0.000501  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117004
diis-c [-1.24460627e-07 -2.25804247e-03 -1.27165323e-04  1.00238521e+00]
  HOMO = -0.848814571475897  LUMO = 0.80478195587235
  mo_energy =
[-3.27703104e+01 -1.92911822e+00 -8.48814571e-01 -8.48814571e-01
 -8.48814571e-01  8.04781956e-01  8.04781956e-01  8.04781956e-01
  1.18187254e+00  3.87971252e+00  3.87971252e+00  3.87971252e+00
  7.25430498e+00  1.41689150e+01  1.41689150e+01  1.41689150e+01
  3.42113926e+01  5.24716462e+01  5.24716462e+01  5.24716462e+01
  1.36595055e+02  2.38131835e+02  2.38131835e+02  2.38131835e+02
  4.98142237e+02  1.86491317e+03  7.99494928e+03  4.77634182e+04]
E1 = -182.59025927428098  E_coul = 54.04897897166747
cycle= 4 E= -128.541280302614  delta_E= -2.12e-08  |g|= 7.54e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185519
diis-c [-8.02576603e-10  1.93623715e-04  4.87347986e-04 -1.59771945e-01
  1.15909097e+00]
  HOMO = -0.848854059914391  LUMO = 0.804770195429895
  mo_energy =
[-3.27703814e+01 -1.92914946e+00 -8.48854060e-01 -8.48854060e-01
 -8.48854060e-01  8.04770195e-01  8.04770195e-01  8.04770195e-01
  1.18185552e+00  3.87967556e+00  3.87967556e+00  3.87967556e+00
  7.25426342e+00  1.41688593e+01  1.41688593e+01  1.41688593e+01
  3.42113307e+01  5.24715796e+01  5.24715796e+01  5.24715796e+01
  1.36594984e+02  2.38131760e+02  2.38131760e+02  2.38131760e+02
  4.98142157e+02  1.86491308e+03  7.99494918e+03  4.77634181e+04]
E1 = -182.59040268654292  E_coul = 54.04912238337747
cycle= 5 E= -128.541280303165  delta_E= -5.52e-10  |g|= 4.49e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59040268654292  E_coul = 54.04912238337747
  HOMO = -0.848851892039474  LUMO = 0.804770839339671
  mo_energy =
[-3.27703767e+01 -1.92914656e+00 -8.48851892e-01 -8.48851892e-01
 -8.48851892e-01  8.04770839e-01  8.04770839e-01  8.04770839e-01
  1.18185696e+00  3.87967765e+00  3.87967765e+00  3.87967765e+00
  7.25426643e+00  1.41688629e+01  1.41688629e+01  1.41688629e+01
  3.42113350e+01  5.24715841e+01  5.24715841e+01  5.24715841e+01
  1.36594989e+02  2.38131764e+02  2.38131764e+02  2.38131764e+02
  4.98142162e+02  1.86491309e+03  7.99494919e+03  4.77634181e+04]
E1 = -182.59039191755795  E_coul = 54.04911161439049
Extra cycle  E= -128.541280303167  delta_E= -2.02e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263805e+02 2.35872756e+02
 7.53635608e+01 9.92692476e+00 2.65955920e+01 3.80173402e-01
 1.11234513e+00 2.88040761e+00 7.07859088e+00 2.30041203e+01
 9.87093751e+01 2.65868184e-01 2.43259234e+00 8.31962941e-01]
E = -128.54128030316747
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45471228        1
[INPUT] 0    0    [1    /1   ]  833.263805075        1
[INPUT] 0    0    [1    /1   ]  235.872755703        1
[INPUT] 0    0    [1    /1   ]  75.3635607749        1
[INPUT] 0    0    [1    /1   ]  9.9269247592         1
[INPUT] 0    0    [1    /1   ]  26.595592008         1
[INPUT] 0    0    [1    /1   ]  0.380173401612       1
[INPUT] 0    0    [1    /1   ]  1.11234513074        1
[INPUT] 0    0    [1    /1   ]  2.88040761446        1
[INPUT] 1    0    [1    /1   ]  7.07859087728        1
[INPUT] 1    0    [1    /1   ]  23.0041202676        1
[INPUT] 1    0    [1    /1   ]  98.7093751218        1
[INPUT] 1    0    [1    /1   ]  0.265868184126       1
[INPUT] 1    0    [1    /1   ]  2.43259234134        1
[INPUT] 1    0    [1    /1   ]  0.831962941499       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125555447, 1.0]], [0, [3661.454712275633, 1.0]], [0, [833.2638050754592, 1.0]], [0, [235.8727557029594, 1.0]], [0, [75.36356077491519, 1.0]], [0, [9.926924759200032, 1.0]], [0, [26.595592008046346, 1.0]], [0, [0.38017340161244756, 1.0]], [0, [1.112345130735768, 1.0]], [0, [2.880407614461173, 1.0]], [1, [7.078590877282395, 1.0]], [1, [23.00412026756595, 1.0]], [1, [98.70937512181723, 1.0]], [1, [0.26586818412607555, 1.0]], [1, [2.4325923413382116, 1.0]], [1, [0.8319629414985905, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412556]
bas 1, expnt(s) = [3661.45471228]
bas 2, expnt(s) = [833.26380508]
bas 3, expnt(s) = [235.8727557]
bas 4, expnt(s) = [75.36356077]
bas 5, expnt(s) = [9.92692476]
bas 6, expnt(s) = [26.59559201]
bas 7, expnt(s) = [0.3801734]
bas 8, expnt(s) = [1.11234513]
bas 9, expnt(s) = [2.88040761]
bas 10, expnt(s) = [7.07859088]
bas 11, expnt(s) = [23.00412027]
bas 12, expnt(s) = [98.70937512]
bas 13, expnt(s) = [0.26586818]
bas 14, expnt(s) = [2.43259234]
bas 15, expnt(s) = [0.83196294]
CPU time:       268.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263805e+02 3.91833815e+02 2.35872756e+02 1.52062932e+02
 7.53635608e+01 6.46228462e+01 9.92692476e+00 1.41294765e+01
 2.65955920e+01 2.95884538e+01 3.80173402e-01 1.22321084e+00
 1.11234513e+00 2.73649521e+00 2.88040761e+00 5.58605860e+00
 7.07859088e+00 3.36835539e+01 2.30041203e+01 1.46974310e+02
 9.87093751e+01 9.07679226e+02 2.65868184e-01 5.56951470e-01
 2.43259234e+00 8.86280229e+00 8.31962941e-01 2.31800501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999589252235054
cond(S) = 345.3684274601164
E1 = -183.5896054582358  E_coul = 55.08018130791889
init E= -128.509424150317
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400822863752  LUMO = 0.82273085944615
  mo_energy =
[-3.25550460e+01 -1.85258939e+00 -7.75400823e-01 -7.75400823e-01
 -7.75400823e-01  8.22730859e-01  8.22730859e-01  8.22730859e-01
  1.21265415e+00  3.94546078e+00  3.94546078e+00  3.94546078e+00
  7.34289102e+00  1.42962699e+01  1.42962699e+01  1.42962699e+01
  3.43751122e+01  5.26584522e+01  5.26584522e+01  5.26584522e+01
  1.36806637e+02  2.38364401e+02  2.38364401e+02  2.38364401e+02
  4.98387182e+02  1.86518905e+03  7.99525178e+03  4.77637387e+04]
E1 = -182.08735020162126  E_coul = 53.549570314199144
cycle= 1 E= -128.537779887422  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509631
diis-c [-0.25972339  1.        ]
  HOMO = -0.884158132044893  LUMO = 0.796118583307886
  mo_energy =
[-3.28778655e+01 -1.96641546e+00 -8.84158132e-01 -8.84158132e-01
 -8.84158132e-01  7.96118583e-01  7.96118583e-01  7.96118583e-01
  1.16740778e+00  3.84838708e+00  3.84838708e+00  3.84838708e+00
  7.21141225e+00  1.41062320e+01  1.41062320e+01  1.41062320e+01
  3.41294205e+01  5.23782590e+01  5.23782590e+01  5.23782590e+01
  1.36489693e+02  2.38018870e+02  2.38018870e+02  2.38018870e+02
  4.98026081e+02  1.86479189e+03  7.99482566e+03  4.77632937e+04]
E1 = -182.84794718122626  E_coul = 54.307584496563194
cycle= 2 E= -128.540362684663  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258661
diis-c [-6.43926120e-04  3.35867939e-01  6.64132061e-01]
  HOMO = -0.848560838228275  LUMO = 0.804817828945899
  mo_energy =
[-3.27698430e+01 -1.92892186e+00 -8.48560838e-01 -8.48560838e-01
 -8.48560838e-01  8.04817829e-01  8.04817829e-01  8.04817829e-01
  1.18194654e+00  3.87988812e+00  3.87988812e+00  3.87988812e+00
  7.25451930e+00  1.41692193e+01  1.41692193e+01  1.41692193e+01
  3.42117519e+01  5.24720580e+01  5.24720580e+01  5.24720580e+01
  1.36595524e+02  2.38132372e+02  2.38132372e+02  2.38132372e+02
  4.98142831e+02  1.86491390e+03  7.99495010e+03  4.77634191e+04]
E1 = -182.589719679851  E_coul = 54.04843939841315
cycle= 3 E= -128.541280281438  delta_E= -0.000918  |g|= 0.000501  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117004
diis-c [-1.24460627e-07 -2.25804247e-03 -1.27165323e-04  1.00238521e+00]
  HOMO = -0.848814571475897  LUMO = 0.80478195587235
  mo_energy =
[-3.27703104e+01 -1.92911822e+00 -8.48814571e-01 -8.48814571e-01
 -8.48814571e-01  8.04781956e-01  8.04781956e-01  8.04781956e-01
  1.18187254e+00  3.87971252e+00  3.87971252e+00  3.87971252e+00
  7.25430498e+00  1.41689150e+01  1.41689150e+01  1.41689150e+01
  3.42113926e+01  5.24716462e+01  5.24716462e+01  5.24716462e+01
  1.36595055e+02  2.38131835e+02  2.38131835e+02  2.38131835e+02
  4.98142237e+02  1.86491317e+03  7.99494928e+03  4.77634182e+04]
E1 = -182.59025927428098  E_coul = 54.04897897166747
cycle= 4 E= -128.541280302614  delta_E= -2.12e-08  |g|= 7.54e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185519
diis-c [-8.02576603e-10  1.93623715e-04  4.87347986e-04 -1.59771945e-01
  1.15909097e+00]
  HOMO = -0.848854059914391  LUMO = 0.804770195429895
  mo_energy =
[-3.27703814e+01 -1.92914946e+00 -8.48854060e-01 -8.48854060e-01
 -8.48854060e-01  8.04770195e-01  8.04770195e-01  8.04770195e-01
  1.18185552e+00  3.87967556e+00  3.87967556e+00  3.87967556e+00
  7.25426342e+00  1.41688593e+01  1.41688593e+01  1.41688593e+01
  3.42113307e+01  5.24715796e+01  5.24715796e+01  5.24715796e+01
  1.36594984e+02  2.38131760e+02  2.38131760e+02  2.38131760e+02
  4.98142157e+02  1.86491308e+03  7.99494918e+03  4.77634181e+04]
E1 = -182.59040268654292  E_coul = 54.04912238337747
cycle= 5 E= -128.541280303165  delta_E= -5.52e-10  |g|= 4.49e-06  |ddm|= 3.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59040268654292  E_coul = 54.04912238337747
  HOMO = -0.848851892039474  LUMO = 0.804770839339671
  mo_energy =
[-3.27703767e+01 -1.92914656e+00 -8.48851892e-01 -8.48851892e-01
 -8.48851892e-01  8.04770839e-01  8.04770839e-01  8.04770839e-01
  1.18185696e+00  3.87967765e+00  3.87967765e+00  3.87967765e+00
  7.25426643e+00  1.41688629e+01  1.41688629e+01  1.41688629e+01
  3.42113350e+01  5.24715841e+01  5.24715841e+01  5.24715841e+01
  1.36594989e+02  2.38131764e+02  2.38131764e+02  2.38131764e+02
  4.98142162e+02  1.86491309e+03  7.99494919e+03  4.77634181e+04]
E1 = -182.59039191755795  E_coul = 54.04911161439049
Extra cycle  E= -128.541280303167  delta_E= -2.02e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.3684274601164
E1 = -182.59039191755795  E_coul = 54.04911161439049
init E= -128.541280303167
    CPU time for initialize scf      0.30 sec, wall time      0.32 sec
  HOMO = -0.848852660026358  LUMO = 0.804770665669578
  mo_energy =
[-3.27703791e+01 -1.92914724e+00 -8.48852660e-01 -8.48852660e-01
 -8.48852660e-01  8.04770666e-01  8.04770666e-01  8.04770666e-01
  1.18185674e+00  3.87967699e+00  3.87967699e+00  3.87967699e+00
  7.25426557e+00  1.41688615e+01  1.41688615e+01  1.41688615e+01
  3.42113332e+01  5.24715821e+01  5.24715821e+01  5.24715821e+01
  1.36594986e+02  2.38131762e+02  2.38131762e+02  2.38131762e+02
  4.98142159e+02  1.86491308e+03  7.99494918e+03  4.77634181e+04]
E1 = -182.5903979542854  E_coul = 54.04911765111803
cycle= 1 E= -128.541280303167  delta_E= 8.53e-14  |g|= 8.33e-07  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5903979542854  E_coul = 54.04911765111803
  HOMO = -0.848852236495384  LUMO = 0.804770771896699
  mo_energy =
[-3.27703778e+01 -1.92914677e+00 -8.48852236e-01 -8.48852236e-01
 -8.48852236e-01  8.04770772e-01  8.04770772e-01  8.04770772e-01
  1.18185693e+00  3.87967737e+00  3.87967737e+00  3.87967737e+00
  7.25426610e+00  1.41688623e+01  1.41688623e+01  1.41688623e+01
  3.42113342e+01  5.24715832e+01  5.24715832e+01  5.24715832e+01
  1.36594987e+02  2.38131763e+02  2.38131763e+02  2.38131763e+02
  4.98142160e+02  1.86491309e+03  7.99494919e+03  4.77634181e+04]
E1 = -182.59039493420525  E_coul = 54.04911463103767
Extra cycle  E= -128.541280303168  delta_E= -1.99e-13  |g|= 4.1e-07  |ddm|= 2.94e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.38 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263805e+02 2.35872756e+02
 7.53635608e+01 9.92692476e+00 2.65955920e+01 3.80173402e-01
 1.11234513e+00 2.88040761e+00 7.07859088e+00 2.30041203e+01
 9.87093751e+01 2.65868184e-01 2.43259234e+00 8.31962941e-01]
grad_E = [-2.49057809e-09  1.28741511e-07 -2.30620865e-06  1.93398010e-05
 -5.38618899e-05  2.59951348e-05  2.72923459e-05  1.38526227e-05
 -3.44078002e-05  3.84592053e-05  1.35862348e-05 -1.34838252e-06
 -1.14362346e-06  2.48022436e-05 -3.42763835e-05  2.47518991e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45471294        1
[INPUT] 0    0    [1    /1   ]  833.263788055        1
[INPUT] 0    0    [1    /1   ]  235.873017126        1
[INPUT] 0    0    [1    /1   ]  75.3621047139        1
[INPUT] 0    0    [1    /1   ]  9.92613438967        1
[INPUT] 0    0    [1    /1   ]  26.590889504         1
[INPUT] 0    0    [1    /1   ]  0.38064976001        1
[INPUT] 0    0    [1    /1   ]  1.11417175697        1
[INPUT] 0    0    [1    /1   ]  2.88466347074        1
[INPUT] 1    0    [1    /1   ]  7.08119320929        1
[INPUT] 1    0    [1    /1   ]  23.019172937         1
[INPUT] 1    0    [1    /1   ]  98.8208256405        1
[INPUT] 1    0    [1    /1   ]  0.265908229762       1
[INPUT] 1    0    [1    /1   ]  2.43341522193        1
[INPUT] 1    0    [1    /1   ]  0.832192816262       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125542725, 1.0]], [0, [3661.454712941421, 1.0]], [0, [833.2637880554922, 1.0]], [0, [235.87301712579313, 1.0]], [0, [75.36210471394442, 1.0]], [0, [9.926134389670906, 1.0]], [0, [26.59088950396735, 1.0]], [0, [0.3806497600097878, 1.0]], [0, [1.1141717569692666, 1.0]], [0, [2.8846634707370886, 1.0]], [1, [7.081193209292961, 1.0]], [1, [23.01917293697584, 1.0]], [1, [98.82082564050118, 1.0]], [1, [0.26590822976216116, 1.0]], [1, [2.4334152219275222, 1.0]], [1, [0.8321928162618971, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412554]
bas 1, expnt(s) = [3661.45471294]
bas 2, expnt(s) = [833.26378806]
bas 3, expnt(s) = [235.87301713]
bas 4, expnt(s) = [75.36210471]
bas 5, expnt(s) = [9.92613439]
bas 6, expnt(s) = [26.5908895]
bas 7, expnt(s) = [0.38064976]
bas 8, expnt(s) = [1.11417176]
bas 9, expnt(s) = [2.88466347]
bas 10, expnt(s) = [7.08119321]
bas 11, expnt(s) = [23.01917294]
bas 12, expnt(s) = [98.82082564]
bas 13, expnt(s) = [0.26590823]
bas 14, expnt(s) = [2.43341522]
bas 15, expnt(s) = [0.83219282]
CPU time:       272.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263788e+02 3.91833809e+02 2.35873017e+02 1.52063058e+02
 7.53621047e+01 6.46219098e+01 9.92613439e+00 1.41286328e+01
 2.65908895e+01 2.95845299e+01 3.80649760e-01 1.22436017e+00
 1.11417176e+00 2.73986480e+00 2.88466347e+00 5.59224758e+00
 7.08119321e+00 3.36990337e+01 2.30191729e+01 1.47094535e+02
 9.88208256e+01 9.08960457e+02 2.65908230e-01 5.57056333e-01
 2.43341522e+00 8.86655001e+00 8.32192816e-01 2.31880563e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588272443695
cond(S) = 346.0018610255289
E1 = -183.58960152949177  E_coul = 55.08017967722385
init E= -128.509421852268
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400850474565  LUMO = 0.822917655451476
  mo_energy =
[-3.25550474e+01 -1.85258849e+00 -7.75400850e-01 -7.75400850e-01
 -7.75400850e-01  8.22917655e-01  8.22917655e-01  8.22917655e-01
  1.21510110e+00  3.94668787e+00  3.94668787e+00  3.94668787e+00
  7.35619841e+00  1.43016945e+01  1.43016945e+01  1.43016945e+01
  3.43974979e+01  5.26884698e+01  5.26884698e+01  5.26884698e+01
  1.36818576e+02  2.38609616e+02  2.38609616e+02  2.38609616e+02
  4.98387800e+02  1.86518599e+03  7.99524838e+03  4.77637357e+04]
E1 = -182.08739845537428  E_coul = 53.54961824913807
cycle= 1 E= -128.537780206236  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509562
diis-c [-0.25965297  1.        ]
  HOMO = -0.884153855382561  LUMO = 0.796298099220205
  mo_energy =
[-3.28778583e+01 -1.96641141e+00 -8.84153855e-01 -8.84153855e-01
 -8.84153855e-01  7.96298099e-01  7.96298099e-01  7.96298099e-01
  1.16977261e+00  3.84959043e+00  3.84959043e+00  3.84959043e+00
  7.22461201e+00  1.41116268e+01  1.41116268e+01  1.41116268e+01
  3.41518158e+01  5.24082443e+01  5.24082443e+01  5.24082443e+01
  1.36501648e+02  2.38264055e+02  2.38264055e+02  2.38264055e+02
  4.98026708e+02  1.86478883e+03  7.99482226e+03  4.77632908e+04]
E1 = -182.84795739275572  E_coul = 54.30759456826741
cycle= 2 E= -128.540362824488  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258624
diis-c [-6.44009589e-04  3.35866064e-01  6.64133936e-01]
  HOMO = -0.84855836493715  LUMO = 0.804999725414638
  mo_energy =
[-3.27698405e+01 -1.92891961e+00 -8.48558365e-01 -8.48558365e-01
 -8.48558365e-01  8.04999725e-01  8.04999725e-01  8.04999725e-01
  1.18433781e+00  3.88109892e+00  3.88109892e+00  3.88109892e+00
  7.26775453e+00  1.41746236e+01  1.41746236e+01  1.41746236e+01
  3.42341429e+01  5.25020526e+01  5.25020526e+01  5.25020526e+01
  1.36607472e+02  2.38377562e+02  2.38377562e+02  2.38377562e+02
  4.98143453e+02  1.86491084e+03  7.99494670e+03  4.77634161e+04]
E1 = -182.58974440443194  E_coul = 54.04846406995735
cycle= 3 E= -128.541280334475  delta_E= -0.000918  |g|= 0.000501  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116955
diis-c [-1.24147310e-07 -2.25786194e-03 -1.27671742e-04  1.00238553e+00]
  HOMO = -0.848812070380368  LUMO = 0.804963846488349
  mo_energy =
[-3.27703079e+01 -1.92911604e+00 -8.48812070e-01 -8.48812070e-01
 -8.48812070e-01  8.04963846e-01  8.04963846e-01  8.04963846e-01
  1.18426366e+00  3.88092328e+00  3.88092328e+00  3.88092328e+00
  7.26754000e+00  1.41743193e+01  1.41743193e+01  1.41743193e+01
  3.42337836e+01  5.25016408e+01  5.25016408e+01  5.25016408e+01
  1.36607003e+02  2.38377024e+02  2.38377024e+02  2.38377024e+02
  4.98142858e+02  1.86491011e+03  7.99494588e+03  4.77634152e+04]
E1 = -182.59028409882384  E_coul = 54.04900374320396
cycle= 4 E= -128.54128035562  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018533
diis-c [-8.00372270e-10  1.93273460e-04  4.86923558e-04 -1.59567503e-01
  1.15888731e+00]
  HOMO = -0.848851524208083  LUMO = 0.804952092673904
  mo_energy =
[-3.27703789e+01 -1.92914727e+00 -8.48851524e-01 -8.48851524e-01
 -8.48851524e-01  8.04952093e-01  8.04952093e-01  8.04952093e-01
  1.18424662e+00  3.88088634e+00  3.88088634e+00  3.88088634e+00
  7.26749844e+00  1.41742637e+01  1.41742637e+01  1.41742637e+01
  3.42337217e+01  5.25015743e+01  5.25015743e+01  5.25015743e+01
  1.36606932e+02  2.38376949e+02  2.38376949e+02  2.38376949e+02
  4.98142779e+02  1.86491002e+03  7.99494579e+03  4.77634151e+04]
E1 = -182.5904274130268  E_coul = 54.04914705685659
cycle= 5 E= -128.54128035617  delta_E= -5.5e-10  |g|= 4.49e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5904274130268  E_coul = 54.04914705685659
  HOMO = -0.848849361619358  LUMO = 0.804952735105957
  mo_energy =
[-3.27703742e+01 -1.92914438e+00 -8.48849362e-01 -8.48849362e-01
 -8.48849362e-01  8.04952735e-01  8.04952735e-01  8.04952735e-01
  1.18424806e+00  3.88088843e+00  3.88088843e+00  3.88088843e+00
  7.26750144e+00  1.41742672e+01  1.41742672e+01  1.41742672e+01
  3.42337260e+01  5.25015787e+01  5.25015787e+01  5.25015787e+01
  1.36606936e+02  2.38376953e+02  2.38376953e+02  2.38376953e+02
  4.98142784e+02  1.86491003e+03  7.99494579e+03  4.77634151e+04]
E1 = -182.59041666629068  E_coul = 54.04913631011919
Extra cycle  E= -128.541280356171  delta_E= -1.28e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263788e+02 2.35873017e+02
 7.53621047e+01 9.92613439e+00 2.65908895e+01 3.80649760e-01
 1.11417176e+00 2.88466347e+00 7.08119321e+00 2.30191729e+01
 9.88208256e+01 2.65908230e-01 2.43341522e+00 8.32192816e-01]
E = -128.54128035617148
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:18:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45471294        1
[INPUT] 0    0    [1    /1   ]  833.263788055        1
[INPUT] 0    0    [1    /1   ]  235.873017126        1
[INPUT] 0    0    [1    /1   ]  75.3621047139        1
[INPUT] 0    0    [1    /1   ]  9.92613438967        1
[INPUT] 0    0    [1    /1   ]  26.590889504         1
[INPUT] 0    0    [1    /1   ]  0.38064976001        1
[INPUT] 0    0    [1    /1   ]  1.11417175697        1
[INPUT] 0    0    [1    /1   ]  2.88466347074        1
[INPUT] 1    0    [1    /1   ]  7.08119320929        1
[INPUT] 1    0    [1    /1   ]  23.019172937         1
[INPUT] 1    0    [1    /1   ]  98.8208256405        1
[INPUT] 1    0    [1    /1   ]  0.265908229762       1
[INPUT] 1    0    [1    /1   ]  2.43341522193        1
[INPUT] 1    0    [1    /1   ]  0.832192816262       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125542725, 1.0]], [0, [3661.454712941421, 1.0]], [0, [833.2637880554922, 1.0]], [0, [235.87301712579313, 1.0]], [0, [75.36210471394442, 1.0]], [0, [9.926134389670906, 1.0]], [0, [26.59088950396735, 1.0]], [0, [0.3806497600097878, 1.0]], [0, [1.1141717569692666, 1.0]], [0, [2.8846634707370886, 1.0]], [1, [7.081193209292961, 1.0]], [1, [23.01917293697584, 1.0]], [1, [98.82082564050118, 1.0]], [1, [0.26590822976216116, 1.0]], [1, [2.4334152219275222, 1.0]], [1, [0.8321928162618971, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412554]
bas 1, expnt(s) = [3661.45471294]
bas 2, expnt(s) = [833.26378806]
bas 3, expnt(s) = [235.87301713]
bas 4, expnt(s) = [75.36210471]
bas 5, expnt(s) = [9.92613439]
bas 6, expnt(s) = [26.5908895]
bas 7, expnt(s) = [0.38064976]
bas 8, expnt(s) = [1.11417176]
bas 9, expnt(s) = [2.88466347]
bas 10, expnt(s) = [7.08119321]
bas 11, expnt(s) = [23.01917294]
bas 12, expnt(s) = [98.82082564]
bas 13, expnt(s) = [0.26590823]
bas 14, expnt(s) = [2.43341522]
bas 15, expnt(s) = [0.83219282]
CPU time:       273.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263788e+02 3.91833809e+02 2.35873017e+02 1.52063058e+02
 7.53621047e+01 6.46219098e+01 9.92613439e+00 1.41286328e+01
 2.65908895e+01 2.95845299e+01 3.80649760e-01 1.22436017e+00
 1.11417176e+00 2.73986480e+00 2.88466347e+00 5.59224758e+00
 7.08119321e+00 3.36990337e+01 2.30191729e+01 1.47094535e+02
 9.88208256e+01 9.08960457e+02 2.65908230e-01 5.57056333e-01
 2.43341522e+00 8.86655001e+00 8.32192816e-01 2.31880563e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588272443695
cond(S) = 346.0018610255289
E1 = -183.58960152949177  E_coul = 55.08017967722385
init E= -128.509421852268
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400850474565  LUMO = 0.822917655451476
  mo_energy =
[-3.25550474e+01 -1.85258849e+00 -7.75400850e-01 -7.75400850e-01
 -7.75400850e-01  8.22917655e-01  8.22917655e-01  8.22917655e-01
  1.21510110e+00  3.94668787e+00  3.94668787e+00  3.94668787e+00
  7.35619841e+00  1.43016945e+01  1.43016945e+01  1.43016945e+01
  3.43974979e+01  5.26884698e+01  5.26884698e+01  5.26884698e+01
  1.36818576e+02  2.38609616e+02  2.38609616e+02  2.38609616e+02
  4.98387800e+02  1.86518599e+03  7.99524838e+03  4.77637357e+04]
E1 = -182.08739845537428  E_coul = 53.54961824913807
cycle= 1 E= -128.537780206236  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509562
diis-c [-0.25965297  1.        ]
  HOMO = -0.884153855382561  LUMO = 0.796298099220205
  mo_energy =
[-3.28778583e+01 -1.96641141e+00 -8.84153855e-01 -8.84153855e-01
 -8.84153855e-01  7.96298099e-01  7.96298099e-01  7.96298099e-01
  1.16977261e+00  3.84959043e+00  3.84959043e+00  3.84959043e+00
  7.22461201e+00  1.41116268e+01  1.41116268e+01  1.41116268e+01
  3.41518158e+01  5.24082443e+01  5.24082443e+01  5.24082443e+01
  1.36501648e+02  2.38264055e+02  2.38264055e+02  2.38264055e+02
  4.98026708e+02  1.86478883e+03  7.99482226e+03  4.77632908e+04]
E1 = -182.84795739275572  E_coul = 54.30759456826741
cycle= 2 E= -128.540362824488  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258624
diis-c [-6.44009589e-04  3.35866064e-01  6.64133936e-01]
  HOMO = -0.84855836493715  LUMO = 0.804999725414638
  mo_energy =
[-3.27698405e+01 -1.92891961e+00 -8.48558365e-01 -8.48558365e-01
 -8.48558365e-01  8.04999725e-01  8.04999725e-01  8.04999725e-01
  1.18433781e+00  3.88109892e+00  3.88109892e+00  3.88109892e+00
  7.26775453e+00  1.41746236e+01  1.41746236e+01  1.41746236e+01
  3.42341429e+01  5.25020526e+01  5.25020526e+01  5.25020526e+01
  1.36607472e+02  2.38377562e+02  2.38377562e+02  2.38377562e+02
  4.98143453e+02  1.86491084e+03  7.99494670e+03  4.77634161e+04]
E1 = -182.58974440443194  E_coul = 54.04846406995735
cycle= 3 E= -128.541280334475  delta_E= -0.000918  |g|= 0.000501  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116955
diis-c [-1.24147310e-07 -2.25786194e-03 -1.27671742e-04  1.00238553e+00]
  HOMO = -0.848812070380368  LUMO = 0.804963846488349
  mo_energy =
[-3.27703079e+01 -1.92911604e+00 -8.48812070e-01 -8.48812070e-01
 -8.48812070e-01  8.04963846e-01  8.04963846e-01  8.04963846e-01
  1.18426366e+00  3.88092328e+00  3.88092328e+00  3.88092328e+00
  7.26754000e+00  1.41743193e+01  1.41743193e+01  1.41743193e+01
  3.42337836e+01  5.25016408e+01  5.25016408e+01  5.25016408e+01
  1.36607003e+02  2.38377024e+02  2.38377024e+02  2.38377024e+02
  4.98142858e+02  1.86491011e+03  7.99494588e+03  4.77634152e+04]
E1 = -182.59028409882384  E_coul = 54.04900374320396
cycle= 4 E= -128.54128035562  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018533
diis-c [-8.00372270e-10  1.93273460e-04  4.86923558e-04 -1.59567503e-01
  1.15888731e+00]
  HOMO = -0.848851524208083  LUMO = 0.804952092673904
  mo_energy =
[-3.27703789e+01 -1.92914727e+00 -8.48851524e-01 -8.48851524e-01
 -8.48851524e-01  8.04952093e-01  8.04952093e-01  8.04952093e-01
  1.18424662e+00  3.88088634e+00  3.88088634e+00  3.88088634e+00
  7.26749844e+00  1.41742637e+01  1.41742637e+01  1.41742637e+01
  3.42337217e+01  5.25015743e+01  5.25015743e+01  5.25015743e+01
  1.36606932e+02  2.38376949e+02  2.38376949e+02  2.38376949e+02
  4.98142779e+02  1.86491002e+03  7.99494579e+03  4.77634151e+04]
E1 = -182.5904274130268  E_coul = 54.04914705685659
cycle= 5 E= -128.54128035617  delta_E= -5.5e-10  |g|= 4.49e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5904274130268  E_coul = 54.04914705685659
  HOMO = -0.848849361619358  LUMO = 0.804952735105957
  mo_energy =
[-3.27703742e+01 -1.92914438e+00 -8.48849362e-01 -8.48849362e-01
 -8.48849362e-01  8.04952735e-01  8.04952735e-01  8.04952735e-01
  1.18424806e+00  3.88088843e+00  3.88088843e+00  3.88088843e+00
  7.26750144e+00  1.41742672e+01  1.41742672e+01  1.41742672e+01
  3.42337260e+01  5.25015787e+01  5.25015787e+01  5.25015787e+01
  1.36606936e+02  2.38376953e+02  2.38376953e+02  2.38376953e+02
  4.98142784e+02  1.86491003e+03  7.99494579e+03  4.77634151e+04]
E1 = -182.59041666629068  E_coul = 54.04913631011919
Extra cycle  E= -128.541280356171  delta_E= -1.28e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.0018610255289
E1 = -182.59041666629068  E_coul = 54.04913631011919
init E= -128.541280356171
    CPU time for initialize scf      0.34 sec, wall time      0.42 sec
  HOMO = -0.848850128056045  LUMO = 0.804952561710122
  mo_energy =
[-3.27703766e+01 -1.92914505e+00 -8.48850128e-01 -8.48850128e-01
 -8.48850128e-01  8.04952562e-01  8.04952562e-01  8.04952562e-01
  1.18424784e+00  3.88088777e+00  3.88088777e+00  3.88088777e+00
  7.26750059e+00  1.41742658e+01  1.41742658e+01  1.41742658e+01
  3.42337243e+01  5.25015767e+01  5.25015767e+01  5.25015767e+01
  1.36606934e+02  2.38376951e+02  2.38376951e+02  2.38376951e+02
  4.98142781e+02  1.86491002e+03  7.99494579e+03  4.77634151e+04]
E1 = -182.59042268992388  E_coul = 54.049142333752
cycle= 1 E= -128.541280356172  delta_E= -3.98e-13  |g|= 8.31e-07  |ddm|= 5.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59042268992388  E_coul = 54.049142333752
  HOMO = -0.848849705449781  LUMO = 0.804952667738074
  mo_energy =
[-3.27703753e+01 -1.92914458e+00 -8.48849705e-01 -8.48849705e-01
 -8.48849705e-01  8.04952668e-01  8.04952668e-01  8.04952668e-01
  1.18424803e+00  3.88088815e+00  3.88088815e+00  3.88088815e+00
  7.26750111e+00  1.41742666e+01  1.41742666e+01  1.41742666e+01
  3.42337252e+01  5.25015778e+01  5.25015778e+01  5.25015778e+01
  1.36606935e+02  2.38376952e+02  2.38376952e+02  2.38376952e+02
  4.98142782e+02  1.86491003e+03  7.99494579e+03  4.77634151e+04]
E1 = -182.5904196763807  E_coul = 54.04913932020885
Extra cycle  E= -128.541280356172  delta_E= 2.84e-14  |g|= 4.09e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.49 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263788e+02 2.35873017e+02
 7.53621047e+01 9.92613439e+00 2.65908895e+01 3.80649760e-01
 1.11417176e+00 2.88466347e+00 7.08119321e+00 2.30191729e+01
 9.88208256e+01 2.65908230e-01 2.43341522e+00 8.32192816e-01]
grad_E = [-2.47497827e-09  1.27912398e-07 -2.28975411e-06  1.91415029e-05
 -5.25164181e-05  2.46242378e-05  2.39843405e-05  3.07226519e-06
  1.70139385e-06  3.45418894e-05  5.25177858e-06 -4.73494225e-07
 -1.01416928e-06 -4.26151317e-07 -1.51314982e-05  1.72499498e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45471277        1
[INPUT] 0    0    [1    /1   ]  833.263791333        1
[INPUT] 0    0    [1    /1   ]  235.872984131        1
[INPUT] 0    0    [1    /1   ]  75.3622699225        1
[INPUT] 0    0    [1    /1   ]  9.92628075098        1
[INPUT] 0    0    [1    /1   ]  26.5905499624        1
[INPUT] 0    0    [1    /1   ]  0.380748715085       1
[INPUT] 0    0    [1    /1   ]  1.11449010302        1
[INPUT] 0    0    [1    /1   ]  2.88476298685        1
[INPUT] 1    0    [1    /1   ]  7.08029184298        1
[INPUT] 1    0    [1    /1   ]  23.0168370784        1
[INPUT] 1    0    [1    /1   ]  98.8209765105        1
[INPUT] 1    0    [1    /1   ]  0.265890530036       1
[INPUT] 1    0    [1    /1   ]  2.4332386008         1
[INPUT] 1    0    [1    /1   ]  0.832137936238       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125546054, 1.0]], [0, [3661.4547127675705, 1.0]], [0, [833.2637913331853, 1.0]], [0, [235.87298413106782, 1.0]], [0, [75.36226992253097, 1.0]], [0, [9.92628075097746, 1.0]], [0, [26.590549962436246, 1.0]], [0, [0.3807487150854281, 1.0]], [0, [1.1144901030208276, 1.0]], [0, [2.8847629868486067, 1.0]], [1, [7.080291842978261, 1.0]], [1, [23.01683707839538, 1.0]], [1, [98.82097651046863, 1.0]], [1, [0.2658905300364401, 1.0]], [1, [2.4332386008015807, 1.0]], [1, [0.8321379362384053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412555]
bas 1, expnt(s) = [3661.45471277]
bas 2, expnt(s) = [833.26379133]
bas 3, expnt(s) = [235.87298413]
bas 4, expnt(s) = [75.36226992]
bas 5, expnt(s) = [9.92628075]
bas 6, expnt(s) = [26.59054996]
bas 7, expnt(s) = [0.38074872]
bas 8, expnt(s) = [1.1144901]
bas 9, expnt(s) = [2.88476299]
bas 10, expnt(s) = [7.08029184]
bas 11, expnt(s) = [23.01683708]
bas 12, expnt(s) = [98.82097651]
bas 13, expnt(s) = [0.26589053]
bas 14, expnt(s) = [2.4332386]
bas 15, expnt(s) = [0.83213794]
CPU time:       276.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263791e+02 3.91833810e+02 2.35872984e+02 1.52063042e+02
 7.53622699e+01 6.46220160e+01 9.92628075e+00 1.41287890e+01
 2.65905500e+01 2.95842466e+01 3.80748715e-01 1.22459888e+00
 1.11449010e+00 2.74045192e+00 2.88476299e+00 5.59239227e+00
 7.08029184e+00 3.36936718e+01 2.30168371e+01 1.47075877e+02
 9.88209765e+01 9.08962191e+02 2.65890530e-01 5.57009984e-01
 2.43323860e+00 8.86574558e+00 8.32137936e-01 2.31861448e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588294098563
cond(S) = 346.0972052654996
E1 = -183.5895998807729  E_coul = 55.08017911281833
init E= -128.509420767955
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400859856368  LUMO = 0.82284946737053
  mo_energy =
[-3.25550478e+01 -1.85258838e+00 -7.75400860e-01 -7.75400860e-01
 -7.75400860e-01  8.22849467e-01  8.22849467e-01  8.22849467e-01
  1.21554696e+00  3.94638329e+00  3.94638329e+00  3.94638329e+00
  7.35778064e+00  1.43002233e+01  1.43002233e+01  1.43002233e+01
  3.43997867e+01  5.26821600e+01  5.26821600e+01  5.26821600e+01
  1.36820480e+02  2.38599176e+02  2.38599176e+02  2.38599176e+02
  4.98389368e+02  1.86518739e+03  7.99524962e+03  4.77637368e+04]
E1 = -182.08739203713068  E_coul = 53.54961183140451
cycle= 1 E= -128.537780205726  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509561
diis-c [-0.25965261  1.        ]
  HOMO = -0.88415424117164  LUMO = 0.796232620376482
  mo_energy =
[-3.28778596e+01 -1.96641219e+00 -8.84154241e-01 -8.84154241e-01
 -8.84154241e-01  7.96232620e-01  7.96232620e-01  7.96232620e-01
  1.17020436e+00  3.84929136e+00  3.84929136e+00  3.84929136e+00
  7.22618471e+00  1.41101651e+01  1.41101651e+01  1.41101651e+01
  3.41541047e+01  5.24019400e+01  5.24019400e+01  5.24019400e+01
  1.36503552e+02  2.38253614e+02  2.38253614e+02  2.38253614e+02
  4.98028275e+02  1.86479024e+03  7.99482350e+03  4.77632918e+04]
E1 = -182.84795343542538  E_coul = 54.307590610835675
cycle= 2 E= -128.54036282459  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258625
diis-c [-6.44005978e-04  3.35867114e-01  6.64132886e-01]
  HOMO = -0.848558689463797  LUMO = 0.804933368711272
  mo_energy =
[-3.27698417e+01 -1.92892028e+00 -8.48558689e-01 -8.48558689e-01
 -8.48558689e-01  8.04933369e-01  8.04933369e-01  8.04933369e-01
  1.18477403e+00  3.88079793e+00  3.88079793e+00  3.88079793e+00
  7.26933023e+00  1.41731585e+01  1.41731585e+01  1.41731585e+01
  3.42364318e+01  5.24957463e+01  5.24957463e+01  5.24957463e+01
  1.36609375e+02  2.38367121e+02  2.38367121e+02  2.38367121e+02
  4.98145020e+02  1.86491225e+03  7.99494794e+03  4.77634171e+04]
E1 = -182.58973903178745  E_coul = 54.04845868841366
cycle= 3 E= -128.541280343374  delta_E= -0.000918  |g|= 0.000501  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116935
diis-c [-1.24051068e-07 -2.25770284e-03 -1.28002879e-04  1.00238571e+00]
  HOMO = -0.848812390790773  LUMO = 0.804897495437737
  mo_energy =
[-3.27703090e+01 -1.92911673e+00 -8.48812391e-01 -8.48812391e-01
 -8.48812391e-01  8.04897495e-01  8.04897495e-01  8.04897495e-01
  1.18469984e+00  3.88062230e+00  3.88062230e+00  3.88062230e+00
  7.26911567e+00  1.41728542e+01  1.41728542e+01  1.41728542e+01
  3.42360725e+01  5.24953346e+01  5.24953346e+01  5.24953346e+01
  1.36608907e+02  2.38366583e+02  2.38366583e+02  2.38366583e+02
  4.98144425e+02  1.86491152e+03  7.99494711e+03  4.77634163e+04]
E1 = -182.5902786414316  E_coul = 54.04899827692024
cycle= 4 E= -128.541280364511  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018528
diis-c [-7.99790021e-10  1.93153338e-04  4.86820309e-04 -1.59507998e-01
  1.15882802e+00]
  HOMO = -0.84885183809545  LUMO = 0.80488574419554
  mo_energy =
[-3.27703800e+01 -1.92914796e+00 -8.48851838e-01 -8.48851838e-01
 -8.48851838e-01  8.04885744e-01  8.04885744e-01  8.04885744e-01
  1.18468280e+00  3.88058537e+00  3.88058537e+00  3.88058537e+00
  7.26907411e+00  1.41727986e+01  1.41727986e+01  1.41727986e+01
  3.42360106e+01  5.24952680e+01  5.24952680e+01  5.24952680e+01
  1.36608836e+02  2.38366508e+02  2.38366508e+02  2.38366508e+02
  4.98144346e+02  1.86491143e+03  7.99494702e+03  4.77634162e+04]
E1 = -182.59042191955146  E_coul = 54.04914155449011
cycle= 5 E= -128.541280365061  delta_E= -5.5e-10  |g|= 4.48e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59042191955146  E_coul = 54.04914155449011
  HOMO = -0.84884967744507  LUMO = 0.804886385955808
  mo_energy =
[-3.27703753e+01 -1.92914507e+00 -8.48849677e-01 -8.48849677e-01
 -8.48849677e-01  8.04886386e-01  8.04886386e-01  8.04886386e-01
  1.18468424e+00  3.88058745e+00  3.88058745e+00  3.88058745e+00
  7.26907711e+00  1.41728022e+01  1.41728022e+01  1.41728022e+01
  3.42360149e+01  5.24952725e+01  5.24952725e+01  5.24952725e+01
  1.36608840e+02  2.38366512e+02  2.38366512e+02  2.38366512e+02
  4.98144351e+02  1.86491143e+03  7.99494702e+03  4.77634162e+04]
E1 = -182.59041118104184  E_coul = 54.04913081597892
Extra cycle  E= -128.541280365063  delta_E= -1.59e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263791e+02 2.35872984e+02
 7.53622699e+01 9.92628075e+00 2.65905500e+01 3.80748715e-01
 1.11449010e+00 2.88476299e+00 7.08029184e+00 2.30168371e+01
 9.88209765e+01 2.65890530e-01 2.43323860e+00 8.32137936e-01]
E = -128.54128036506293
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941255        1
[INPUT] 0    0    [1    /1   ]  3661.45471277        1
[INPUT] 0    0    [1    /1   ]  833.263791333        1
[INPUT] 0    0    [1    /1   ]  235.872984131        1
[INPUT] 0    0    [1    /1   ]  75.3622699225        1
[INPUT] 0    0    [1    /1   ]  9.92628075098        1
[INPUT] 0    0    [1    /1   ]  26.5905499624        1
[INPUT] 0    0    [1    /1   ]  0.380748715085       1
[INPUT] 0    0    [1    /1   ]  1.11449010302        1
[INPUT] 0    0    [1    /1   ]  2.88476298685        1
[INPUT] 1    0    [1    /1   ]  7.08029184298        1
[INPUT] 1    0    [1    /1   ]  23.0168370784        1
[INPUT] 1    0    [1    /1   ]  98.8209765105        1
[INPUT] 1    0    [1    /1   ]  0.265890530036       1
[INPUT] 1    0    [1    /1   ]  2.4332386008         1
[INPUT] 1    0    [1    /1   ]  0.832137936238       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125546054, 1.0]], [0, [3661.4547127675705, 1.0]], [0, [833.2637913331853, 1.0]], [0, [235.87298413106782, 1.0]], [0, [75.36226992253097, 1.0]], [0, [9.92628075097746, 1.0]], [0, [26.590549962436246, 1.0]], [0, [0.3807487150854281, 1.0]], [0, [1.1144901030208276, 1.0]], [0, [2.8847629868486067, 1.0]], [1, [7.080291842978261, 1.0]], [1, [23.01683707839538, 1.0]], [1, [98.82097651046863, 1.0]], [1, [0.2658905300364401, 1.0]], [1, [2.4332386008015807, 1.0]], [1, [0.8321379362384053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412555]
bas 1, expnt(s) = [3661.45471277]
bas 2, expnt(s) = [833.26379133]
bas 3, expnt(s) = [235.87298413]
bas 4, expnt(s) = [75.36226992]
bas 5, expnt(s) = [9.92628075]
bas 6, expnt(s) = [26.59054996]
bas 7, expnt(s) = [0.38074872]
bas 8, expnt(s) = [1.1144901]
bas 9, expnt(s) = [2.88476299]
bas 10, expnt(s) = [7.08029184]
bas 11, expnt(s) = [23.01683708]
bas 12, expnt(s) = [98.82097651]
bas 13, expnt(s) = [0.26589053]
bas 14, expnt(s) = [2.4332386]
bas 15, expnt(s) = [0.83213794]
CPU time:       277.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263791e+02 3.91833810e+02 2.35872984e+02 1.52063042e+02
 7.53622699e+01 6.46220160e+01 9.92628075e+00 1.41287890e+01
 2.65905500e+01 2.95842466e+01 3.80748715e-01 1.22459888e+00
 1.11449010e+00 2.74045192e+00 2.88476299e+00 5.59239227e+00
 7.08029184e+00 3.36936718e+01 2.30168371e+01 1.47075877e+02
 9.88209765e+01 9.08962191e+02 2.65890530e-01 5.57009984e-01
 2.43323860e+00 8.86574558e+00 8.32137936e-01 2.31861448e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588294098563
cond(S) = 346.0972052654996
E1 = -183.5895998807729  E_coul = 55.08017911281833
init E= -128.509420767955
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400859856368  LUMO = 0.82284946737053
  mo_energy =
[-3.25550478e+01 -1.85258838e+00 -7.75400860e-01 -7.75400860e-01
 -7.75400860e-01  8.22849467e-01  8.22849467e-01  8.22849467e-01
  1.21554696e+00  3.94638329e+00  3.94638329e+00  3.94638329e+00
  7.35778064e+00  1.43002233e+01  1.43002233e+01  1.43002233e+01
  3.43997867e+01  5.26821600e+01  5.26821600e+01  5.26821600e+01
  1.36820480e+02  2.38599176e+02  2.38599176e+02  2.38599176e+02
  4.98389368e+02  1.86518739e+03  7.99524962e+03  4.77637368e+04]
E1 = -182.08739203713068  E_coul = 53.54961183140451
cycle= 1 E= -128.537780205726  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509561
diis-c [-0.25965261  1.        ]
  HOMO = -0.88415424117164  LUMO = 0.796232620376482
  mo_energy =
[-3.28778596e+01 -1.96641219e+00 -8.84154241e-01 -8.84154241e-01
 -8.84154241e-01  7.96232620e-01  7.96232620e-01  7.96232620e-01
  1.17020436e+00  3.84929136e+00  3.84929136e+00  3.84929136e+00
  7.22618471e+00  1.41101651e+01  1.41101651e+01  1.41101651e+01
  3.41541047e+01  5.24019400e+01  5.24019400e+01  5.24019400e+01
  1.36503552e+02  2.38253614e+02  2.38253614e+02  2.38253614e+02
  4.98028275e+02  1.86479024e+03  7.99482350e+03  4.77632918e+04]
E1 = -182.84795343542538  E_coul = 54.307590610835675
cycle= 2 E= -128.54036282459  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258625
diis-c [-6.44005978e-04  3.35867114e-01  6.64132886e-01]
  HOMO = -0.848558689463797  LUMO = 0.804933368711272
  mo_energy =
[-3.27698417e+01 -1.92892028e+00 -8.48558689e-01 -8.48558689e-01
 -8.48558689e-01  8.04933369e-01  8.04933369e-01  8.04933369e-01
  1.18477403e+00  3.88079793e+00  3.88079793e+00  3.88079793e+00
  7.26933023e+00  1.41731585e+01  1.41731585e+01  1.41731585e+01
  3.42364318e+01  5.24957463e+01  5.24957463e+01  5.24957463e+01
  1.36609375e+02  2.38367121e+02  2.38367121e+02  2.38367121e+02
  4.98145020e+02  1.86491225e+03  7.99494794e+03  4.77634171e+04]
E1 = -182.58973903178745  E_coul = 54.04845868841366
cycle= 3 E= -128.541280343374  delta_E= -0.000918  |g|= 0.000501  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116935
diis-c [-1.24051068e-07 -2.25770284e-03 -1.28002879e-04  1.00238571e+00]
  HOMO = -0.848812390790773  LUMO = 0.804897495437737
  mo_energy =
[-3.27703090e+01 -1.92911673e+00 -8.48812391e-01 -8.48812391e-01
 -8.48812391e-01  8.04897495e-01  8.04897495e-01  8.04897495e-01
  1.18469984e+00  3.88062230e+00  3.88062230e+00  3.88062230e+00
  7.26911567e+00  1.41728542e+01  1.41728542e+01  1.41728542e+01
  3.42360725e+01  5.24953346e+01  5.24953346e+01  5.24953346e+01
  1.36608907e+02  2.38366583e+02  2.38366583e+02  2.38366583e+02
  4.98144425e+02  1.86491152e+03  7.99494711e+03  4.77634163e+04]
E1 = -182.5902786414316  E_coul = 54.04899827692024
cycle= 4 E= -128.541280364511  delta_E= -2.11e-08  |g|= 7.53e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018528
diis-c [-7.99790021e-10  1.93153338e-04  4.86820309e-04 -1.59507998e-01
  1.15882802e+00]
  HOMO = -0.84885183809545  LUMO = 0.80488574419554
  mo_energy =
[-3.27703800e+01 -1.92914796e+00 -8.48851838e-01 -8.48851838e-01
 -8.48851838e-01  8.04885744e-01  8.04885744e-01  8.04885744e-01
  1.18468280e+00  3.88058537e+00  3.88058537e+00  3.88058537e+00
  7.26907411e+00  1.41727986e+01  1.41727986e+01  1.41727986e+01
  3.42360106e+01  5.24952680e+01  5.24952680e+01  5.24952680e+01
  1.36608836e+02  2.38366508e+02  2.38366508e+02  2.38366508e+02
  4.98144346e+02  1.86491143e+03  7.99494702e+03  4.77634162e+04]
E1 = -182.59042191955146  E_coul = 54.04914155449011
cycle= 5 E= -128.541280365061  delta_E= -5.5e-10  |g|= 4.48e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59042191955146  E_coul = 54.04914155449011
  HOMO = -0.84884967744507  LUMO = 0.804886385955808
  mo_energy =
[-3.27703753e+01 -1.92914507e+00 -8.48849677e-01 -8.48849677e-01
 -8.48849677e-01  8.04886386e-01  8.04886386e-01  8.04886386e-01
  1.18468424e+00  3.88058745e+00  3.88058745e+00  3.88058745e+00
  7.26907711e+00  1.41728022e+01  1.41728022e+01  1.41728022e+01
  3.42360149e+01  5.24952725e+01  5.24952725e+01  5.24952725e+01
  1.36608840e+02  2.38366512e+02  2.38366512e+02  2.38366512e+02
  4.98144351e+02  1.86491143e+03  7.99494702e+03  4.77634162e+04]
E1 = -182.59041118104184  E_coul = 54.04913081597892
Extra cycle  E= -128.541280365063  delta_E= -1.59e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.0972052654996
E1 = -182.59041118104184  E_coul = 54.04913081597892
init E= -128.541280365063
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.848850443313564  LUMO = 0.804886212702378
  mo_energy =
[-3.27703777e+01 -1.92914575e+00 -8.48850443e-01 -8.48850443e-01
 -8.48850443e-01  8.04886213e-01  8.04886213e-01  8.04886213e-01
  1.18468402e+00  3.88058680e+00  3.88058680e+00  3.88058680e+00
  7.26907625e+00  1.41728008e+01  1.41728008e+01  1.41728008e+01
  3.42360131e+01  5.24952705e+01  5.24952705e+01  5.24952705e+01
  1.36608838e+02  2.38366510e+02  2.38366510e+02  2.38366510e+02
  4.98144348e+02  1.86491143e+03  7.99494702e+03  4.77634162e+04]
E1 = -182.59041719994642  E_coul = 54.04913683488311
cycle= 1 E= -128.541280365063  delta_E= -3.69e-13  |g|= 8.3e-07  |ddm|= 5.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59041719994642  E_coul = 54.04913683488311
  HOMO = -0.848850021041432  LUMO = 0.804886318635839
  mo_energy =
[-3.27703764e+01 -1.92914528e+00 -8.48850021e-01 -8.48850021e-01
 -8.48850021e-01  8.04886319e-01  8.04886319e-01  8.04886319e-01
  1.18468421e+00  3.88058717e+00  3.88058717e+00  3.88058717e+00
  7.26907678e+00  1.41728016e+01  1.41728016e+01  1.41728016e+01
  3.42360141e+01  5.24952716e+01  5.24952716e+01  5.24952716e+01
  1.36608839e+02  2.38366511e+02  2.38366511e+02  2.38366511e+02
  4.98144349e+02  1.86491143e+03  7.99494702e+03  4.77634162e+04]
E1 = -182.59041418875705  E_coul = 54.0491338236938
Extra cycle  E= -128.541280365063  delta_E= 5.68e-14  |g|= 4.09e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263791e+02 2.35872984e+02
 7.53622699e+01 9.92628075e+00 2.65905500e+01 3.80748715e-01
 1.11449010e+00 2.88476299e+00 7.08029184e+00 2.30168371e+01
 9.88209765e+01 2.65890530e-01 2.43323860e+00 8.32137936e-01]
grad_E = [-2.47126447e-09  1.27716094e-07 -2.28594077e-06  1.90976757e-05
 -5.22222555e-05  2.54213765e-05  2.30353514e-05 -4.17742453e-06
  1.46109602e-05  3.16414241e-05  7.64025292e-07 -1.74892777e-07
 -9.89283474e-07 -1.99543344e-06 -2.10488036e-06  2.97489625e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45471228        1
[INPUT] 0    0    [1    /1   ]  833.263800564        1
[INPUT] 0    0    [1    /1   ]  235.872894476        1
[INPUT] 0    0    [1    /1   ]  75.3626510882        1
[INPUT] 0    0    [1    /1   ]  9.92634852069        1
[INPUT] 0    0    [1    /1   ]  26.5902134977        1
[INPUT] 0    0    [1    /1   ]  0.380849797573       1
[INPUT] 0    0    [1    /1   ]  1.11478239356        1
[INPUT] 0    0    [1    /1   ]  2.88479575638        1
[INPUT] 1    0    [1    /1   ]  7.07886905329        1
[INPUT] 1    0    [1    /1   ]  23.0129610333        1
[INPUT] 1    0    [1    /1   ]  98.8172420769        1
[INPUT] 1    0    [1    /1   ]  0.265864868862       1
[INPUT] 1    0    [1    /1   ]  2.43296079835        1
[INPUT] 1    0    [1    /1   ]  0.832055723343       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125555512, 1.0]], [0, [3661.454712275782, 1.0]], [0, [833.2638005637926, 1.0]], [0, [235.87289447559303, 1.0]], [0, [75.36265108824414, 1.0]], [0, [9.926348520685607, 1.0]], [0, [26.590213497668845, 1.0]], [0, [0.38084979757347537, 1.0]], [0, [1.1147823935610224, 1.0]], [0, [2.8847957563770166, 1.0]], [1, [7.078869053288513, 1.0]], [1, [23.012961033256264, 1.0]], [1, [98.81724207691789, 1.0]], [1, [0.26586486886201816, 1.0]], [1, [2.43296079834626, 1.0]], [1, [0.8320557233427731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412556]
bas 1, expnt(s) = [3661.45471228]
bas 2, expnt(s) = [833.26380056]
bas 3, expnt(s) = [235.87289448]
bas 4, expnt(s) = [75.36265109]
bas 5, expnt(s) = [9.92634852]
bas 6, expnt(s) = [26.5902135]
bas 7, expnt(s) = [0.3808498]
bas 8, expnt(s) = [1.11478239]
bas 9, expnt(s) = [2.88479576]
bas 10, expnt(s) = [7.07886905]
bas 11, expnt(s) = [23.01296103]
bas 12, expnt(s) = [98.81724208]
bas 13, expnt(s) = [0.26586487]
bas 14, expnt(s) = [2.4329608]
bas 15, expnt(s) = [0.83205572]
CPU time:       281.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263801e+02 3.91833813e+02 2.35872894e+02 1.52062999e+02
 7.53626511e+01 6.46222611e+01 9.92634852e+00 1.41288614e+01
 2.65902135e+01 2.95839659e+01 3.80849798e-01 1.22484271e+00
 1.11478239e+00 2.74099094e+00 2.88479576e+00 5.59243992e+00
 7.07886905e+00 3.36852086e+01 2.30129610e+01 1.47044918e+02
 9.88172421e+01 9.08919255e+02 2.65864869e-01 5.56942788e-01
 2.43296080e+00 8.86448035e+00 8.32055723e-01 2.31832815e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588388736923
cond(S) = 346.18412002098114
E1 = -183.58959857256554  E_coul = 55.0801787526385
init E= -128.509419819927
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400851103672  LUMO = 0.82274948180565
  mo_energy =
[-3.25550481e+01 -1.85258828e+00 -7.75400851e-01 -7.75400851e-01
 -7.75400851e-01  8.22749482e-01  8.22749482e-01  8.22749482e-01
  1.21598118e+00  3.94592229e+00  3.94592229e+00  3.94592229e+00
  7.35919586e+00  1.42979219e+01  1.42979219e+01  1.42979219e+01
  3.44015939e+01  5.26719783e+01  5.26719783e+01  5.26719783e+01
  1.36821890e+02  2.38575444e+02  2.38575444e+02  2.38575444e+02
  4.98390817e+02  1.86518886e+03  7.99525092e+03  4.77637378e+04]
E1 = -182.08738180317107  E_coul = 53.54960161340881
cycle= 1 E= -128.537780189762  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509565
diis-c [-0.25965606  1.        ]
  HOMO = -0.884154877622088  LUMO = 0.79613661769239
  mo_energy =
[-3.28778616e+01 -1.96641339e+00 -8.84154878e-01 -8.84154878e-01
 -8.84154878e-01  7.96136618e-01  7.96136618e-01  7.96136618e-01
  1.17062496e+00  3.84883895e+00  3.84883895e+00  3.84883895e+00
  7.22759195e+00  1.41078788e+01  1.41078788e+01  1.41078788e+01
  3.41559119e+01  5.23917675e+01  5.23917675e+01  5.23917675e+01
  1.36504961e+02  2.38229880e+02  2.38229880e+02  2.38229880e+02
  4.98029722e+02  1.86479170e+03  7.99482480e+03  4.77632929e+04]
E1 = -182.84794935326772  E_coul = 54.307586530808486
cycle= 2 E= -128.540362822459  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258628
diis-c [-6.43996340e-04  3.35868685e-01  6.64131315e-01]
  HOMO = -0.848559107083907  LUMO = 0.804836101634316
  mo_energy =
[-3.27698432e+01 -1.92892120e+00 -8.48559107e-01 -8.48559107e-01
 -8.48559107e-01  8.04836102e-01  8.04836102e-01  8.04836102e-01
  1.18519896e+00  3.88034262e+00  3.88034262e+00  3.88034262e+00
  7.27074000e+00  1.41708671e+01  1.41708671e+01  1.41708671e+01
  3.42382391e+01  5.24855707e+01  5.24855707e+01  5.24855707e+01
  1.36610785e+02  2.38343387e+02  2.38343387e+02  2.38343387e+02
  4.98146467e+02  1.86491371e+03  7.99494924e+03  4.77634182e+04]
E1 = -182.58973220530362  E_coul = 54.04845184650358
cycle= 3 E= -128.5412803588  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116905
diis-c [-1.23929328e-07 -2.25741115e-03 -1.28456834e-04  1.00238587e+00]
  HOMO = -0.848812785064251  LUMO = 0.804800242472318
  mo_energy =
[-3.27703105e+01 -1.92911767e+00 -8.48812785e-01 -8.48812785e-01
 -8.48812785e-01  8.04800242e-01  8.04800242e-01  8.04800242e-01
  1.18512474e+00  3.88016703e+00  3.88016703e+00  3.88016703e+00
  7.27052543e+00  1.41705628e+01  1.41705628e+01  1.41705628e+01
  3.42378798e+01  5.24851590e+01  5.24851590e+01  5.24851590e+01
  1.36610316e+02  2.38342850e+02  2.38342850e+02  2.38342850e+02
  4.98145873e+02  1.86491298e+03  7.99494841e+03  4.77634173e+04]
E1 = -182.59027166704246  E_coul = 54.04899128711685
cycle= 4 E= -128.541280379926  delta_E= -2.11e-08  |g|= 7.52e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185217
diis-c [-7.99031918e-10  1.92991963e-04  4.86698134e-04 -1.59431936e-01
  1.15875225e+00]
  HOMO = -0.848852223053757  LUMO = 0.80478849504847
  mo_energy =
[-3.27703814e+01 -1.92914890e+00 -8.48852223e-01 -8.48852223e-01
 -8.48852223e-01  8.04788495e-01  8.04788495e-01  8.04788495e-01
  1.18510770e+00  3.88013011e+00  3.88013011e+00  3.88013011e+00
  7.27048387e+00  1.41705072e+01  1.41705072e+01  1.41705072e+01
  3.42378179e+01  5.24850925e+01  5.24850925e+01  5.24850925e+01
  1.36610245e+02  2.38342775e+02  2.38342775e+02  2.38342775e+02
  4.98145794e+02  1.86491289e+03  7.99494832e+03  4.77634172e+04]
E1 = -182.5904148987012  E_coul = 54.04913451822568
cycle= 5 E= -128.541280380476  delta_E= -5.5e-10  |g|= 4.48e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5904148987012  E_coul = 54.04913451822568
  HOMO = -0.848850064953804  LUMO = 0.804789135908708
  mo_energy =
[-3.27703767e+01 -1.92914602e+00 -8.48850065e-01 -8.48850065e-01
 -8.48850065e-01  8.04789136e-01  8.04789136e-01  8.04789136e-01
  1.18510913e+00  3.88013219e+00  3.88013219e+00  3.88013219e+00
  7.27048687e+00  1.41705108e+01  1.41705108e+01  1.41705108e+01
  3.42378222e+01  5.24850970e+01  5.24850970e+01  5.24850970e+01
  1.36610250e+02  2.38342779e+02  2.38342779e+02  2.38342779e+02
  4.98145798e+02  1.86491289e+03  7.99494832e+03  4.77634173e+04]
E1 = -182.59040417042212  E_coul = 54.04912378994534
Extra cycle  E= -128.541280380477  delta_E= -1.28e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263801e+02 2.35872894e+02
 7.53626511e+01 9.92634852e+00 2.65902135e+01 3.80849798e-01
 1.11478239e+00 2.88479576e+00 7.07886905e+00 2.30129610e+01
 9.88172421e+01 2.65864869e-01 2.43296080e+00 8.32055723e-01]
E = -128.5412803804768
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45471228        1
[INPUT] 0    0    [1    /1   ]  833.263800564        1
[INPUT] 0    0    [1    /1   ]  235.872894476        1
[INPUT] 0    0    [1    /1   ]  75.3626510882        1
[INPUT] 0    0    [1    /1   ]  9.92634852069        1
[INPUT] 0    0    [1    /1   ]  26.5902134977        1
[INPUT] 0    0    [1    /1   ]  0.380849797573       1
[INPUT] 0    0    [1    /1   ]  1.11478239356        1
[INPUT] 0    0    [1    /1   ]  2.88479575638        1
[INPUT] 1    0    [1    /1   ]  7.07886905329        1
[INPUT] 1    0    [1    /1   ]  23.0129610333        1
[INPUT] 1    0    [1    /1   ]  98.8172420769        1
[INPUT] 1    0    [1    /1   ]  0.265864868862       1
[INPUT] 1    0    [1    /1   ]  2.43296079835        1
[INPUT] 1    0    [1    /1   ]  0.832055723343       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125555512, 1.0]], [0, [3661.454712275782, 1.0]], [0, [833.2638005637926, 1.0]], [0, [235.87289447559303, 1.0]], [0, [75.36265108824414, 1.0]], [0, [9.926348520685607, 1.0]], [0, [26.590213497668845, 1.0]], [0, [0.38084979757347537, 1.0]], [0, [1.1147823935610224, 1.0]], [0, [2.8847957563770166, 1.0]], [1, [7.078869053288513, 1.0]], [1, [23.012961033256264, 1.0]], [1, [98.81724207691789, 1.0]], [1, [0.26586486886201816, 1.0]], [1, [2.43296079834626, 1.0]], [1, [0.8320557233427731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412556]
bas 1, expnt(s) = [3661.45471228]
bas 2, expnt(s) = [833.26380056]
bas 3, expnt(s) = [235.87289448]
bas 4, expnt(s) = [75.36265109]
bas 5, expnt(s) = [9.92634852]
bas 6, expnt(s) = [26.5902135]
bas 7, expnt(s) = [0.3808498]
bas 8, expnt(s) = [1.11478239]
bas 9, expnt(s) = [2.88479576]
bas 10, expnt(s) = [7.07886905]
bas 11, expnt(s) = [23.01296103]
bas 12, expnt(s) = [98.81724208]
bas 13, expnt(s) = [0.26586487]
bas 14, expnt(s) = [2.4329608]
bas 15, expnt(s) = [0.83205572]
CPU time:       282.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263801e+02 3.91833813e+02 2.35872894e+02 1.52062999e+02
 7.53626511e+01 6.46222611e+01 9.92634852e+00 1.41288614e+01
 2.65902135e+01 2.95839659e+01 3.80849798e-01 1.22484271e+00
 1.11478239e+00 2.74099094e+00 2.88479576e+00 5.59243992e+00
 7.07886905e+00 3.36852086e+01 2.30129610e+01 1.47044918e+02
 9.88172421e+01 9.08919255e+02 2.65864869e-01 5.56942788e-01
 2.43296080e+00 8.86448035e+00 8.32055723e-01 2.31832815e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588388736923
cond(S) = 346.18412002098114
E1 = -183.58959857256554  E_coul = 55.0801787526385
init E= -128.509419819927
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400851103672  LUMO = 0.82274948180565
  mo_energy =
[-3.25550481e+01 -1.85258828e+00 -7.75400851e-01 -7.75400851e-01
 -7.75400851e-01  8.22749482e-01  8.22749482e-01  8.22749482e-01
  1.21598118e+00  3.94592229e+00  3.94592229e+00  3.94592229e+00
  7.35919586e+00  1.42979219e+01  1.42979219e+01  1.42979219e+01
  3.44015939e+01  5.26719783e+01  5.26719783e+01  5.26719783e+01
  1.36821890e+02  2.38575444e+02  2.38575444e+02  2.38575444e+02
  4.98390817e+02  1.86518886e+03  7.99525092e+03  4.77637378e+04]
E1 = -182.08738180317107  E_coul = 53.54960161340881
cycle= 1 E= -128.537780189762  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509565
diis-c [-0.25965606  1.        ]
  HOMO = -0.884154877622088  LUMO = 0.79613661769239
  mo_energy =
[-3.28778616e+01 -1.96641339e+00 -8.84154878e-01 -8.84154878e-01
 -8.84154878e-01  7.96136618e-01  7.96136618e-01  7.96136618e-01
  1.17062496e+00  3.84883895e+00  3.84883895e+00  3.84883895e+00
  7.22759195e+00  1.41078788e+01  1.41078788e+01  1.41078788e+01
  3.41559119e+01  5.23917675e+01  5.23917675e+01  5.23917675e+01
  1.36504961e+02  2.38229880e+02  2.38229880e+02  2.38229880e+02
  4.98029722e+02  1.86479170e+03  7.99482480e+03  4.77632929e+04]
E1 = -182.84794935326772  E_coul = 54.307586530808486
cycle= 2 E= -128.540362822459  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258628
diis-c [-6.43996340e-04  3.35868685e-01  6.64131315e-01]
  HOMO = -0.848559107083907  LUMO = 0.804836101634316
  mo_energy =
[-3.27698432e+01 -1.92892120e+00 -8.48559107e-01 -8.48559107e-01
 -8.48559107e-01  8.04836102e-01  8.04836102e-01  8.04836102e-01
  1.18519896e+00  3.88034262e+00  3.88034262e+00  3.88034262e+00
  7.27074000e+00  1.41708671e+01  1.41708671e+01  1.41708671e+01
  3.42382391e+01  5.24855707e+01  5.24855707e+01  5.24855707e+01
  1.36610785e+02  2.38343387e+02  2.38343387e+02  2.38343387e+02
  4.98146467e+02  1.86491371e+03  7.99494924e+03  4.77634182e+04]
E1 = -182.58973220530362  E_coul = 54.04845184650358
cycle= 3 E= -128.5412803588  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116905
diis-c [-1.23929328e-07 -2.25741115e-03 -1.28456834e-04  1.00238587e+00]
  HOMO = -0.848812785064251  LUMO = 0.804800242472318
  mo_energy =
[-3.27703105e+01 -1.92911767e+00 -8.48812785e-01 -8.48812785e-01
 -8.48812785e-01  8.04800242e-01  8.04800242e-01  8.04800242e-01
  1.18512474e+00  3.88016703e+00  3.88016703e+00  3.88016703e+00
  7.27052543e+00  1.41705628e+01  1.41705628e+01  1.41705628e+01
  3.42378798e+01  5.24851590e+01  5.24851590e+01  5.24851590e+01
  1.36610316e+02  2.38342850e+02  2.38342850e+02  2.38342850e+02
  4.98145873e+02  1.86491298e+03  7.99494841e+03  4.77634173e+04]
E1 = -182.59027166704246  E_coul = 54.04899128711685
cycle= 4 E= -128.541280379926  delta_E= -2.11e-08  |g|= 7.52e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185217
diis-c [-7.99031918e-10  1.92991963e-04  4.86698134e-04 -1.59431936e-01
  1.15875225e+00]
  HOMO = -0.848852223053757  LUMO = 0.80478849504847
  mo_energy =
[-3.27703814e+01 -1.92914890e+00 -8.48852223e-01 -8.48852223e-01
 -8.48852223e-01  8.04788495e-01  8.04788495e-01  8.04788495e-01
  1.18510770e+00  3.88013011e+00  3.88013011e+00  3.88013011e+00
  7.27048387e+00  1.41705072e+01  1.41705072e+01  1.41705072e+01
  3.42378179e+01  5.24850925e+01  5.24850925e+01  5.24850925e+01
  1.36610245e+02  2.38342775e+02  2.38342775e+02  2.38342775e+02
  4.98145794e+02  1.86491289e+03  7.99494832e+03  4.77634172e+04]
E1 = -182.5904148987012  E_coul = 54.04913451822568
cycle= 5 E= -128.541280380476  delta_E= -5.5e-10  |g|= 4.48e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5904148987012  E_coul = 54.04913451822568
  HOMO = -0.848850064953804  LUMO = 0.804789135908708
  mo_energy =
[-3.27703767e+01 -1.92914602e+00 -8.48850065e-01 -8.48850065e-01
 -8.48850065e-01  8.04789136e-01  8.04789136e-01  8.04789136e-01
  1.18510913e+00  3.88013219e+00  3.88013219e+00  3.88013219e+00
  7.27048687e+00  1.41705108e+01  1.41705108e+01  1.41705108e+01
  3.42378222e+01  5.24850970e+01  5.24850970e+01  5.24850970e+01
  1.36610250e+02  2.38342779e+02  2.38342779e+02  2.38342779e+02
  4.98145798e+02  1.86491289e+03  7.99494832e+03  4.77634173e+04]
E1 = -182.59040417042212  E_coul = 54.04912378994534
Extra cycle  E= -128.541280380477  delta_E= -1.28e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.18412002098114
E1 = -182.59040417042212  E_coul = 54.04912378994534
init E= -128.541280380477
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848850830120447  LUMO = 0.80478896283351
  mo_energy =
[-3.27703791e+01 -1.92914669e+00 -8.48850830e-01 -8.48850830e-01
 -8.48850830e-01  8.04788963e-01  8.04788963e-01  8.04788963e-01
  1.18510891e+00  3.88013153e+00  3.88013153e+00  3.88013153e+00
  7.27048601e+00  1.41705094e+01  1.41705094e+01  1.41705094e+01
  3.42378205e+01  5.24850949e+01  5.24850949e+01  5.24850949e+01
  1.36610247e+02  2.38342777e+02  2.38342777e+02  2.38342777e+02
  4.98145796e+02  1.86491289e+03  7.99494832e+03  4.77634172e+04]
E1 = -182.59041018336472  E_coul = 54.049129802887535
cycle= 1 E= -128.541280380477  delta_E= -3.98e-13  |g|= 8.3e-07  |ddm|= 5.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59041018336472  E_coul = 54.049129802887535
  HOMO = -0.848850408270101  LUMO = 0.804789068645148
  mo_energy =
[-3.27703778e+01 -1.92914622e+00 -8.48850408e-01 -8.48850408e-01
 -8.48850408e-01  8.04789069e-01  8.04789069e-01  8.04789069e-01
  1.18510910e+00  3.88013191e+00  3.88013191e+00  3.88013191e+00
  7.27048654e+00  1.41705102e+01  1.41705102e+01  1.41705102e+01
  3.42378214e+01  5.24850960e+01  5.24850960e+01  5.24850960e+01
  1.36610249e+02  2.38342778e+02  2.38342778e+02  2.38342778e+02
  4.98145797e+02  1.86491289e+03  7.99494832e+03  4.77634172e+04]
E1 = -182.59040717513335  E_coul = 54.04912679465625
Extra cycle  E= -128.541280380477  delta_E= 8.53e-14  |g|= 4.08e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263801e+02 2.35872894e+02
 7.53626511e+01 9.92634852e+00 2.65902135e+01 3.80849798e-01
 1.11478239e+00 2.88479576e+00 7.07886905e+00 2.30129610e+01
 9.88172421e+01 2.65864869e-01 2.43296080e+00 8.32055723e-01]
grad_E = [-2.46691090e-09  1.27486615e-07 -2.28154122e-06  1.90489628e-05
 -5.19190844e-05  2.60664966e-05  2.21471766e-05 -4.07922129e-06
  2.47703525e-05  2.90714431e-05 -6.08407519e-06  3.31293484e-07
 -9.62671403e-07 -2.57114525e-06  1.73999323e-05 -1.82531493e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45471079        1
[INPUT] 0    0    [1    /1   ]  833.263827695        1
[INPUT] 0    0    [1    /1   ]  235.872652467        1
[INPUT] 0    0    [1    /1   ]  75.3634769776        1
[INPUT] 0    0    [1    /1   ]  9.92636560494        1
[INPUT] 0    0    [1    /1   ]  26.5896544445        1
[INPUT] 0    0    [1    /1   ]  0.380981355617       1
[INPUT] 0    0    [1    /1   ]  1.11512910383        1
[INPUT] 0    0    [1    /1   ]  2.88450448313        1
[INPUT] 1    0    [1    /1   ]  7.07653281362        1
[INPUT] 1    0    [1    /1   ]  23.0068016433        1
[INPUT] 1    0    [1    /1   ]  98.8125184215        1
[INPUT] 1    0    [1    /1   ]  0.265822746359       1
[INPUT] 1    0    [1    /1   ]  2.43250104713        1
[INPUT] 1    0    [1    /1   ]  0.831921115918       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125584205, 1.0]], [0, [3661.454710789492, 1.0]], [0, [833.263827695356, 1.0]], [0, [235.87265246662605, 1.0]], [0, [75.36347697762143, 1.0]], [0, [9.926365604938526, 1.0]], [0, [26.58965444446856, 1.0]], [0, [0.3809813556165372, 1.0]], [0, [1.1151291038287252, 1.0]], [0, [2.8845044831257245, 1.0]], [1, [7.07653281362419, 1.0]], [1, [23.00680164327737, 1.0]], [1, [98.81251842152037, 1.0]], [1, [0.2658227463590054, 1.0]], [1, [2.4325010471329, 1.0]], [1, [0.8319211159179043, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412558]
bas 1, expnt(s) = [3661.45471079]
bas 2, expnt(s) = [833.2638277]
bas 3, expnt(s) = [235.87265247]
bas 4, expnt(s) = [75.36347698]
bas 5, expnt(s) = [9.9263656]
bas 6, expnt(s) = [26.58965444]
bas 7, expnt(s) = [0.38098136]
bas 8, expnt(s) = [1.1151291]
bas 9, expnt(s) = [2.88450448]
bas 10, expnt(s) = [7.07653281]
bas 11, expnt(s) = [23.00680164]
bas 12, expnt(s) = [98.81251842]
bas 13, expnt(s) = [0.26582275]
bas 14, expnt(s) = [2.43250105]
bas 15, expnt(s) = [0.83192112]
CPU time:       285.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263828e+02 3.91833823e+02 2.35872652e+02 1.52062882e+02
 7.53634770e+01 6.46227923e+01 9.92636560e+00 1.41288796e+01
 2.65896544e+01 2.95834994e+01 3.80981356e-01 1.22516002e+00
 1.11512910e+00 2.74163027e+00 2.88450448e+00 5.59201642e+00
 7.07653281e+00 3.36713127e+01 2.30068016e+01 1.46995724e+02
 9.88125184e+01 9.08864945e+02 2.65822746e-01 5.56832491e-01
 2.43250105e+00 8.86238652e+00 8.31921116e-01 2.31785934e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958858198083
cond(S) = 346.27793424634996
E1 = -183.58959628152593  E_coul = 55.08017819089944
init E= -128.509418090626
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.7754008365409  LUMO = 0.822585475237801
  mo_energy =
[-3.25550486e+01 -1.85258818e+00 -7.75400837e-01 -7.75400837e-01
 -7.75400837e-01  8.22585475e-01  8.22585475e-01  8.22585475e-01
  1.21651480e+00  3.94516513e+00  3.94516513e+00  3.94516513e+00
  7.36048939e+00  1.42941363e+01  1.42941363e+01  1.42941363e+01
  3.44024052e+01  5.26555045e+01  5.26555045e+01  5.26555045e+01
  1.36821941e+02  2.38539478e+02  2.38539478e+02  2.38539478e+02
  4.98391380e+02  1.86518969e+03  7.99525167e+03  4.77637385e+04]
E1 = -182.0873624013206  E_coul = 53.54958223409058
cycle= 1 E= -128.53778016723  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50957
diis-c [-0.2596617  1.       ]
  HOMO = -0.884156165277203  LUMO = 0.795979041413464
  mo_energy =
[-3.28778653e+01 -1.96641558e+00 -8.84156165e-01 -8.84156165e-01
 -8.84156165e-01  7.95979041e-01  7.95979041e-01  7.95979041e-01
  1.17114235e+00  3.84809571e+00  3.84809571e+00  3.84809571e+00
  7.22888134e+00  1.41041176e+01  1.41041176e+01  1.41041176e+01
  3.41567238e+01  5.23753078e+01  5.23753078e+01  5.23753078e+01
  1.36505010e+02  2.38193913e+02  2.38193913e+02  2.38193913e+02
  4.98030281e+02  1.86479253e+03  7.99482554e+03  4.77632935e+04]
E1 = -182.8479414231591  E_coul = 54.30757859372728
cycle= 2 E= -128.540362829432  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258634
diis-c [-6.43970360e-04  3.35871314e-01  6.64128686e-01]
  HOMO = -0.848559969693991  LUMO = 0.804676472273088
  mo_energy =
[-3.27698459e+01 -1.92892288e+00 -8.48559970e-01 -8.48559970e-01
 -8.48559970e-01  8.04676472e-01  8.04676472e-01  8.04676472e-01
  1.18572147e+00  3.87959469e+00  3.87959469e+00  3.87959469e+00
  7.27203054e+00  1.41670976e+01  1.41670976e+01  1.41670976e+01
  3.42390510e+01  5.24691062e+01  5.24691062e+01  5.24691062e+01
  1.36610834e+02  2.38307421e+02  2.38307421e+02  2.38307421e+02
  4.98147028e+02  1.86491454e+03  7.99494998e+03  4.77634188e+04]
E1 = -182.5897191487134  E_coul = 54.04843875067149
cycle= 3 E= -128.541280398042  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116861
diis-c [-1.23752316e-07 -2.25697259e-03 -1.29151066e-04  1.00238612e+00]
  HOMO = -0.848813619059245  LUMO = 0.804640633103627
  mo_energy =
[-3.27703130e+01 -1.92911937e+00 -8.48813619e-01 -8.48813619e-01
 -8.48813619e-01  8.04640633e-01  8.04640633e-01  8.04640633e-01
  1.18564721e+00  3.87941915e+00  3.87941915e+00  3.87941915e+00
  7.27181596e+00  1.41667934e+01  1.41667934e+01  1.41667934e+01
  3.42386918e+01  5.24686946e+01  5.24686946e+01  5.24686946e+01
  1.36610366e+02  2.38306883e+02  2.38306883e+02  2.38306883e+02
  4.98146434e+02  1.86491381e+03  7.99494916e+03  4.77634180e+04]
E1 = -182.59025837452836  E_coul = 54.04897795537827
cycle= 4 E= -128.54128041915  delta_E= -2.11e-08  |g|= 7.52e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185124
diis-c [-7.97936343e-10  1.92754143e-04  4.86516516e-04 -1.59322138e-01
  1.15864287e+00]
  HOMO = -0.848853044616819  LUMO = 0.804628891086217
  mo_energy =
[-3.27703840e+01 -1.92915061e+00 -8.48853045e-01 -8.48853045e-01
 -8.48853045e-01  8.04628891e-01  8.04628891e-01  8.04628891e-01
  1.18563016e+00  3.87938224e+00  3.87938224e+00  3.87938224e+00
  7.27177440e+00  1.41667378e+01  1.41667378e+01  1.41667378e+01
  3.42386299e+01  5.24686281e+01  5.24686281e+01  5.24686281e+01
  1.36610295e+02  2.38306808e+02  2.38306808e+02  2.38306808e+02
  4.98146355e+02  1.86491372e+03  7.99494907e+03  4.77634179e+04]
E1 = -182.59040153591462  E_coul = 54.04912111621553
cycle= 5 E= -128.541280419699  delta_E= -5.49e-10  |g|= 4.47e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59040153591462  E_coul = 54.04912111621553
  HOMO = -0.848850890281497  LUMO = 0.804629530604803
  mo_energy =
[-3.27703793e+01 -1.92914773e+00 -8.48850890e-01 -8.48850890e-01
 -8.48850890e-01  8.04629531e-01  8.04629531e-01  8.04629531e-01
  1.18563159e+00  3.87938431e+00  3.87938431e+00  3.87938431e+00
  7.27177739e+00  1.41667414e+01  1.41667414e+01  1.41667414e+01
  3.42386342e+01  5.24686326e+01  5.24686326e+01  5.24686326e+01
  1.36610299e+02  2.38306813e+02  2.38306813e+02  2.38306813e+02
  4.98146359e+02  1.86491373e+03  7.99494907e+03  4.77634179e+04]
E1 = -182.59039082280344  E_coul = 54.049110403102794
Extra cycle  E= -128.541280419701  delta_E= -1.56e-12  |g|= 1.53e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263828e+02 2.35872652e+02
 7.53634770e+01 9.92636560e+00 2.65896544e+01 3.80981356e-01
 1.11512910e+00 2.88450448e+00 7.07653281e+00 2.30068016e+01
 9.88125184e+01 2.65822746e-01 2.43250105e+00 8.31921116e-01]
E = -128.54128041970066
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941256        1
[INPUT] 0    0    [1    /1   ]  3661.45471079        1
[INPUT] 0    0    [1    /1   ]  833.263827695        1
[INPUT] 0    0    [1    /1   ]  235.872652467        1
[INPUT] 0    0    [1    /1   ]  75.3634769776        1
[INPUT] 0    0    [1    /1   ]  9.92636560494        1
[INPUT] 0    0    [1    /1   ]  26.5896544445        1
[INPUT] 0    0    [1    /1   ]  0.380981355617       1
[INPUT] 0    0    [1    /1   ]  1.11512910383        1
[INPUT] 0    0    [1    /1   ]  2.88450448313        1
[INPUT] 1    0    [1    /1   ]  7.07653281362        1
[INPUT] 1    0    [1    /1   ]  23.0068016433        1
[INPUT] 1    0    [1    /1   ]  98.8125184215        1
[INPUT] 1    0    [1    /1   ]  0.265822746359       1
[INPUT] 1    0    [1    /1   ]  2.43250104713        1
[INPUT] 1    0    [1    /1   ]  0.831921115918       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794125584205, 1.0]], [0, [3661.454710789492, 1.0]], [0, [833.263827695356, 1.0]], [0, [235.87265246662605, 1.0]], [0, [75.36347697762143, 1.0]], [0, [9.926365604938526, 1.0]], [0, [26.58965444446856, 1.0]], [0, [0.3809813556165372, 1.0]], [0, [1.1151291038287252, 1.0]], [0, [2.8845044831257245, 1.0]], [1, [7.07653281362419, 1.0]], [1, [23.00680164327737, 1.0]], [1, [98.81251842152037, 1.0]], [1, [0.2658227463590054, 1.0]], [1, [2.4325010471329, 1.0]], [1, [0.8319211159179043, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412558]
bas 1, expnt(s) = [3661.45471079]
bas 2, expnt(s) = [833.2638277]
bas 3, expnt(s) = [235.87265247]
bas 4, expnt(s) = [75.36347698]
bas 5, expnt(s) = [9.9263656]
bas 6, expnt(s) = [26.58965444]
bas 7, expnt(s) = [0.38098136]
bas 8, expnt(s) = [1.1151291]
bas 9, expnt(s) = [2.88450448]
bas 10, expnt(s) = [7.07653281]
bas 11, expnt(s) = [23.00680164]
bas 12, expnt(s) = [98.81251842]
bas 13, expnt(s) = [0.26582275]
bas 14, expnt(s) = [2.43250105]
bas 15, expnt(s) = [0.83192112]
CPU time:       286.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263828e+02 3.91833823e+02 2.35872652e+02 1.52062882e+02
 7.53634770e+01 6.46227923e+01 9.92636560e+00 1.41288796e+01
 2.65896544e+01 2.95834994e+01 3.80981356e-01 1.22516002e+00
 1.11512910e+00 2.74163027e+00 2.88450448e+00 5.59201642e+00
 7.07653281e+00 3.36713127e+01 2.30068016e+01 1.46995724e+02
 9.88125184e+01 9.08864945e+02 2.65822746e-01 5.56832491e-01
 2.43250105e+00 8.86238652e+00 8.31921116e-01 2.31785934e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958858198083
cond(S) = 346.27793424634996
E1 = -183.58959628152593  E_coul = 55.08017819089944
init E= -128.509418090626
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.7754008365409  LUMO = 0.822585475237801
  mo_energy =
[-3.25550486e+01 -1.85258818e+00 -7.75400837e-01 -7.75400837e-01
 -7.75400837e-01  8.22585475e-01  8.22585475e-01  8.22585475e-01
  1.21651480e+00  3.94516513e+00  3.94516513e+00  3.94516513e+00
  7.36048939e+00  1.42941363e+01  1.42941363e+01  1.42941363e+01
  3.44024052e+01  5.26555045e+01  5.26555045e+01  5.26555045e+01
  1.36821941e+02  2.38539478e+02  2.38539478e+02  2.38539478e+02
  4.98391380e+02  1.86518969e+03  7.99525167e+03  4.77637385e+04]
E1 = -182.0873624013206  E_coul = 53.54958223409058
cycle= 1 E= -128.53778016723  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50957
diis-c [-0.2596617  1.       ]
  HOMO = -0.884156165277203  LUMO = 0.795979041413464
  mo_energy =
[-3.28778653e+01 -1.96641558e+00 -8.84156165e-01 -8.84156165e-01
 -8.84156165e-01  7.95979041e-01  7.95979041e-01  7.95979041e-01
  1.17114235e+00  3.84809571e+00  3.84809571e+00  3.84809571e+00
  7.22888134e+00  1.41041176e+01  1.41041176e+01  1.41041176e+01
  3.41567238e+01  5.23753078e+01  5.23753078e+01  5.23753078e+01
  1.36505010e+02  2.38193913e+02  2.38193913e+02  2.38193913e+02
  4.98030281e+02  1.86479253e+03  7.99482554e+03  4.77632935e+04]
E1 = -182.8479414231591  E_coul = 54.30757859372728
cycle= 2 E= -128.540362829432  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258634
diis-c [-6.43970360e-04  3.35871314e-01  6.64128686e-01]
  HOMO = -0.848559969693991  LUMO = 0.804676472273088
  mo_energy =
[-3.27698459e+01 -1.92892288e+00 -8.48559970e-01 -8.48559970e-01
 -8.48559970e-01  8.04676472e-01  8.04676472e-01  8.04676472e-01
  1.18572147e+00  3.87959469e+00  3.87959469e+00  3.87959469e+00
  7.27203054e+00  1.41670976e+01  1.41670976e+01  1.41670976e+01
  3.42390510e+01  5.24691062e+01  5.24691062e+01  5.24691062e+01
  1.36610834e+02  2.38307421e+02  2.38307421e+02  2.38307421e+02
  4.98147028e+02  1.86491454e+03  7.99494998e+03  4.77634188e+04]
E1 = -182.5897191487134  E_coul = 54.04843875067149
cycle= 3 E= -128.541280398042  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116861
diis-c [-1.23752316e-07 -2.25697259e-03 -1.29151066e-04  1.00238612e+00]
  HOMO = -0.848813619059245  LUMO = 0.804640633103627
  mo_energy =
[-3.27703130e+01 -1.92911937e+00 -8.48813619e-01 -8.48813619e-01
 -8.48813619e-01  8.04640633e-01  8.04640633e-01  8.04640633e-01
  1.18564721e+00  3.87941915e+00  3.87941915e+00  3.87941915e+00
  7.27181596e+00  1.41667934e+01  1.41667934e+01  1.41667934e+01
  3.42386918e+01  5.24686946e+01  5.24686946e+01  5.24686946e+01
  1.36610366e+02  2.38306883e+02  2.38306883e+02  2.38306883e+02
  4.98146434e+02  1.86491381e+03  7.99494916e+03  4.77634180e+04]
E1 = -182.59025837452836  E_coul = 54.04897795537827
cycle= 4 E= -128.54128041915  delta_E= -2.11e-08  |g|= 7.52e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185124
diis-c [-7.97936343e-10  1.92754143e-04  4.86516516e-04 -1.59322138e-01
  1.15864287e+00]
  HOMO = -0.848853044616819  LUMO = 0.804628891086217
  mo_energy =
[-3.27703840e+01 -1.92915061e+00 -8.48853045e-01 -8.48853045e-01
 -8.48853045e-01  8.04628891e-01  8.04628891e-01  8.04628891e-01
  1.18563016e+00  3.87938224e+00  3.87938224e+00  3.87938224e+00
  7.27177440e+00  1.41667378e+01  1.41667378e+01  1.41667378e+01
  3.42386299e+01  5.24686281e+01  5.24686281e+01  5.24686281e+01
  1.36610295e+02  2.38306808e+02  2.38306808e+02  2.38306808e+02
  4.98146355e+02  1.86491372e+03  7.99494907e+03  4.77634179e+04]
E1 = -182.59040153591462  E_coul = 54.04912111621553
cycle= 5 E= -128.541280419699  delta_E= -5.49e-10  |g|= 4.47e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59040153591462  E_coul = 54.04912111621553
  HOMO = -0.848850890281497  LUMO = 0.804629530604803
  mo_energy =
[-3.27703793e+01 -1.92914773e+00 -8.48850890e-01 -8.48850890e-01
 -8.48850890e-01  8.04629531e-01  8.04629531e-01  8.04629531e-01
  1.18563159e+00  3.87938431e+00  3.87938431e+00  3.87938431e+00
  7.27177739e+00  1.41667414e+01  1.41667414e+01  1.41667414e+01
  3.42386342e+01  5.24686326e+01  5.24686326e+01  5.24686326e+01
  1.36610299e+02  2.38306813e+02  2.38306813e+02  2.38306813e+02
  4.98146359e+02  1.86491373e+03  7.99494907e+03  4.77634179e+04]
E1 = -182.59039082280344  E_coul = 54.049110403102794
Extra cycle  E= -128.541280419701  delta_E= -1.56e-12  |g|= 1.53e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.27793424634996
E1 = -182.59039082280344  E_coul = 54.049110403102794
init E= -128.541280419701
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.848851654408288  LUMO = 0.804629357798256
  mo_energy =
[-3.27703816e+01 -1.92914840e+00 -8.48851654e-01 -8.48851654e-01
 -8.48851654e-01  8.04629358e-01  8.04629358e-01  8.04629358e-01
  1.18563137e+00  3.87938366e+00  3.87938366e+00  3.87938366e+00
  7.27177654e+00  1.41667400e+01  1.41667400e+01  1.41667400e+01
  3.42386324e+01  5.24686305e+01  5.24686305e+01  5.24686305e+01
  1.36610297e+02  2.38306810e+02  2.38306810e+02  2.38306810e+02
  4.98146357e+02  1.86491372e+03  7.99494907e+03  4.77634179e+04]
E1 = -182.590396826932  E_coul = 54.04911640723076
cycle= 1 E= -128.541280419701  delta_E= -5.68e-13  |g|= 8.28e-07  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.590396826932  E_coul = 54.04911640723076
  HOMO = -0.848851233181436  LUMO = 0.804629463427515
  mo_energy =
[-3.27703804e+01 -1.92914793e+00 -8.48851233e-01 -8.48851233e-01
 -8.48851233e-01  8.04629463e-01  8.04629463e-01  8.04629463e-01
  1.18563156e+00  3.87938404e+00  3.87938404e+00  3.87938404e+00
  7.27177707e+00  1.41667408e+01  1.41667408e+01  1.41667408e+01
  3.42386334e+01  5.24686316e+01  5.24686316e+01  5.24686316e+01
  1.36610298e+02  2.38306811e+02  2.38306811e+02  2.38306811e+02
  4.98146358e+02  1.86491373e+03  7.99494907e+03  4.77634179e+04]
E1 = -182.59039382307148  E_coul = 54.04911340337049
Extra cycle  E= -128.541280419701  delta_E= 2.27e-13  |g|= 4.08e-07  |ddm|= 2.92e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263828e+02 2.35872652e+02
 7.53634770e+01 9.92636560e+00 2.65896544e+01 3.80981356e-01
 1.11512910e+00 2.88450448e+00 7.07653281e+00 2.30068016e+01
 9.88125184e+01 2.65822746e-01 2.43250105e+00 8.31921116e-01]
grad_E = [-2.45880070e-09  1.27059720e-07 -2.27340575e-06  1.89602454e-05
 -5.13798590e-05  2.74828156e-05  2.05741485e-05 -4.41645418e-06
  3.97461328e-05  2.49654874e-05 -1.75302705e-05  1.21540573e-06
 -9.19482170e-07 -4.36146283e-06  4.93116048e-05 -5.22614567e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941257        1
[INPUT] 0    0    [1    /1   ]  3661.45470665        1
[INPUT] 0    0    [1    /1   ]  833.26390224         1
[INPUT] 0    0    [1    /1   ]  235.872013642        1
[INPUT] 0    0    [1    /1   ]  75.3654043596        1
[INPUT] 0    0    [1    /1   ]  9.92601139642        1
[INPUT] 0    0    [1    /1   ]  26.5884685827        1
[INPUT] 0    0    [1    /1   ]  0.381148961593       1
[INPUT] 0    0    [1    /1   ]  1.11550011204        1
[INPUT] 0    0    [1    /1   ]  2.88352813495        1
[INPUT] 1    0    [1    /1   ]  7.07289625063        1
[INPUT] 1    0    [1    /1   ]  22.997613736         1
[INPUT] 1    0    [1    /1   ]  98.8091164211        1
[INPUT] 1    0    [1    /1   ]  0.265757982195       1
[INPUT] 1    0    [1    /1   ]  2.43179425076        1
[INPUT] 1    0    [1    /1   ]  0.831716885271       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412566414, 1.0]], [0, [3661.4547066547107, 1.0]], [0, [833.263902240005, 1.0]], [0, [235.87201364242046, 1.0]], [0, [75.36540435958605, 1.0]], [0, [9.926011396418499, 1.0]], [0, [26.58846858272977, 1.0]], [0, [0.3811489615929081, 1.0]], [0, [1.115500112036915, 1.0]], [0, [2.883528134946939, 1.0]], [1, [7.072896250630353, 1.0]], [1, [22.997613735972536, 1.0]], [1, [98.8091164210767, 1.0]], [1, [0.2657579821951211, 1.0]], [1, [2.4317942507621355, 1.0]], [1, [0.83171688527077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412566]
bas 1, expnt(s) = [3661.45470665]
bas 2, expnt(s) = [833.26390224]
bas 3, expnt(s) = [235.87201364]
bas 4, expnt(s) = [75.36540436]
bas 5, expnt(s) = [9.9260114]
bas 6, expnt(s) = [26.58846858]
bas 7, expnt(s) = [0.38114896]
bas 8, expnt(s) = [1.11550011]
bas 9, expnt(s) = [2.88352813]
bas 10, expnt(s) = [7.07289625]
bas 11, expnt(s) = [22.99761374]
bas 12, expnt(s) = [98.80911642]
bas 13, expnt(s) = [0.26575798]
bas 14, expnt(s) = [2.43179425]
bas 15, expnt(s) = [0.83171689]
CPU time:       290.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263902e+02 3.91833849e+02 2.35872014e+02 1.52062573e+02
 7.53654044e+01 6.46240318e+01 9.92601140e+00 1.41285015e+01
 2.65884686e+01 2.95825098e+01 3.81148962e-01 1.22556424e+00
 1.11550011e+00 2.74231436e+00 2.88352813e+00 5.59059677e+00
 7.07289625e+00 3.36496849e+01 2.29976137e+01 1.46922348e+02
 9.88091164e+01 9.08825831e+02 2.65757982e-01 5.56662915e-01
 2.43179425e+00 8.85916778e+00 8.31716885e-01 2.31714809e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588921740845
cond(S) = 346.3565855953753
E1 = -183.58959233150398  E_coul = 55.08017732930444
init E= -128.5094150022
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400808849257  LUMO = 0.822333996162457
  mo_energy =
[-3.25550492e+01 -1.85258813e+00 -7.75400809e-01 -7.75400809e-01
 -7.75400809e-01  8.22333996e-01  8.22333996e-01  8.22333996e-01
  1.21713165e+00  3.94400960e+00  3.94400960e+00  3.94400960e+00
  7.36108769e+00  1.42882932e+01  1.42882932e+01  1.42882932e+01
  3.44000800e+01  5.26304126e+01  5.26304126e+01  5.26304126e+01
  1.36817475e+02  2.38491428e+02  2.38491428e+02  2.38491428e+02
  4.98388443e+02  1.86518770e+03  7.99524990e+03  4.77637370e+04]
E1 = -182.08733055143674  E_coul = 53.54955038528711
cycle= 1 E= -128.53778016615  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509577
diis-c [-0.25966909  1.        ]
  HOMO = -0.884158314200091  LUMO = 0.795737314245115
  mo_energy =
[-3.28778713e+01 -1.96641917e+00 -8.84158314e-01 -8.84158314e-01
 -8.84158314e-01  7.95737314e-01  7.95737314e-01  7.95737314e-01
  1.17174168e+00  3.84696136e+00  3.84696136e+00  3.84696136e+00
  7.22948693e+00  1.40983121e+01  1.40983121e+01  1.40983121e+01
  3.41544027e+01  5.23502366e+01  5.23502366e+01  5.23502366e+01
  1.36500540e+02  2.38145858e+02  2.38145858e+02  2.38145858e+02
  4.98027338e+02  1.86479054e+03  7.99482377e+03  4.77632920e+04]
E1 = -182.84792807726538  E_coul = 54.30756519981068
cycle= 2 E= -128.540362877455  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258643
diis-c [-6.43909314e-04  3.35875408e-01  6.64124592e-01]
  HOMO = -0.848561423440236  LUMO = 0.804431619895356
  mo_energy =
[-3.27698501e+01 -1.92892565e+00 -8.48561423e-01 -8.48561423e-01
 -8.48561423e-01  8.04431620e-01  8.04431620e-01  8.04431620e-01
  1.18632622e+00  3.87845318e+00  3.87845318e+00  3.87845318e+00
  7.27263328e+00  1.41612792e+01  1.41612792e+01  1.41612792e+01
  3.42367287e+01  5.24440280e+01  5.24440280e+01  5.24440280e+01
  1.36606365e+02  2.38259367e+02  2.38259367e+02  2.38259367e+02
  4.98144087e+02  1.86491255e+03  7.99494821e+03  4.77634174e+04]
E1 = -182.5896974322992  E_coul = 54.04841693411943
cycle= 3 E= -128.54128049818  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116795
diis-c [-1.23494612e-07 -2.25631981e-03 -1.30136380e-04  1.00238646e+00]
  HOMO = -0.848815041021967  LUMO = 0.804395807372633
  mo_energy =
[-3.27703172e+01 -1.92912218e+00 -8.48815041e-01 -8.48815041e-01
 -8.48815041e-01  8.04395807e-01  8.04395807e-01  8.04395807e-01
  1.18625191e+00  3.87827770e+00  3.87827770e+00  3.87827770e+00
  7.27241869e+00  1.41609752e+01  1.41609752e+01  1.41609752e+01
  3.42363696e+01  5.24436165e+01  5.24436165e+01  5.24436165e+01
  1.36605897e+02  2.38258830e+02  2.38258830e+02  2.38258830e+02
  4.98143493e+02  1.86491182e+03  7.99494739e+03  4.77634165e+04]
E1 = -182.59023630652575  E_coul = 54.04895578726065
cycle= 4 E= -128.541280519265  delta_E= -2.11e-08  |g|= 7.52e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184987
diis-c [-7.96330964e-10  1.92400839e-04  4.86232408e-04 -1.59161442e-01
  1.15848281e+00]
  HOMO = -0.84885444987403  LUMO = 0.804384072854785
  mo_energy =
[-3.27703881e+01 -1.92915343e+00 -8.48854450e-01 -8.48854450e-01
 -8.48854450e-01  8.04384073e-01  8.04384073e-01  8.04384073e-01
  1.18623484e+00  3.87824080e+00  3.87824080e+00  3.87824080e+00
  7.27237715e+00  1.41609196e+01  1.41609196e+01  1.41609196e+01
  3.42363078e+01  5.24435501e+01  5.24435501e+01  5.24435501e+01
  1.36605826e+02  2.38258755e+02  2.38258755e+02  2.38258755e+02
  4.98143414e+02  1.86491173e+03  7.99494730e+03  4.77634164e+04]
E1 = -182.59037936116397  E_coul = 54.04909884135088
cycle= 5 E= -128.541280519813  delta_E= -5.48e-10  |g|= 4.46e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59037936116397  E_coul = 54.04909884135088
  HOMO = -0.848852301147121  LUMO = 0.804384710371594
  mo_energy =
[-3.27703834e+01 -1.92915055e+00 -8.48852301e-01 -8.48852301e-01
 -8.48852301e-01  8.04384710e-01  8.04384710e-01  8.04384710e-01
  1.18623628e+00  3.87824287e+00  3.87824287e+00  3.87824287e+00
  7.27238013e+00  1.41609232e+01  1.41609232e+01  1.41609232e+01
  3.42363121e+01  5.24435545e+01  5.24435545e+01  5.24435545e+01
  1.36605831e+02  2.38258759e+02  2.38258759e+02  2.38258759e+02
  4.98143418e+02  1.86491174e+03  7.99494730e+03  4.77634164e+04]
E1 = -182.59036867065979  E_coul = 54.04908815084517
Extra cycle  E= -128.541280519815  delta_E= -1.53e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263902e+02 2.35872014e+02
 7.53654044e+01 9.92601140e+00 2.65884686e+01 3.81148962e-01
 1.11550011e+00 2.88352813e+00 7.07289625e+00 2.29976137e+01
 9.88091164e+01 2.65757982e-01 2.43179425e+00 8.31716885e-01]
E = -128.54128051981462
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941257        1
[INPUT] 0    0    [1    /1   ]  3661.45470665        1
[INPUT] 0    0    [1    /1   ]  833.26390224         1
[INPUT] 0    0    [1    /1   ]  235.872013642        1
[INPUT] 0    0    [1    /1   ]  75.3654043596        1
[INPUT] 0    0    [1    /1   ]  9.92601139642        1
[INPUT] 0    0    [1    /1   ]  26.5884685827        1
[INPUT] 0    0    [1    /1   ]  0.381148961593       1
[INPUT] 0    0    [1    /1   ]  1.11550011204        1
[INPUT] 0    0    [1    /1   ]  2.88352813495        1
[INPUT] 1    0    [1    /1   ]  7.07289625063        1
[INPUT] 1    0    [1    /1   ]  22.997613736         1
[INPUT] 1    0    [1    /1   ]  98.8091164211        1
[INPUT] 1    0    [1    /1   ]  0.265757982195       1
[INPUT] 1    0    [1    /1   ]  2.43179425076        1
[INPUT] 1    0    [1    /1   ]  0.831716885271       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412566414, 1.0]], [0, [3661.4547066547107, 1.0]], [0, [833.263902240005, 1.0]], [0, [235.87201364242046, 1.0]], [0, [75.36540435958605, 1.0]], [0, [9.926011396418499, 1.0]], [0, [26.58846858272977, 1.0]], [0, [0.3811489615929081, 1.0]], [0, [1.115500112036915, 1.0]], [0, [2.883528134946939, 1.0]], [1, [7.072896250630353, 1.0]], [1, [22.997613735972536, 1.0]], [1, [98.8091164210767, 1.0]], [1, [0.2657579821951211, 1.0]], [1, [2.4317942507621355, 1.0]], [1, [0.83171688527077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412566]
bas 1, expnt(s) = [3661.45470665]
bas 2, expnt(s) = [833.26390224]
bas 3, expnt(s) = [235.87201364]
bas 4, expnt(s) = [75.36540436]
bas 5, expnt(s) = [9.9260114]
bas 6, expnt(s) = [26.58846858]
bas 7, expnt(s) = [0.38114896]
bas 8, expnt(s) = [1.11550011]
bas 9, expnt(s) = [2.88352813]
bas 10, expnt(s) = [7.07289625]
bas 11, expnt(s) = [22.99761374]
bas 12, expnt(s) = [98.80911642]
bas 13, expnt(s) = [0.26575798]
bas 14, expnt(s) = [2.43179425]
bas 15, expnt(s) = [0.83171689]
CPU time:       291.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145471e+03 1.18920102e+03
 8.33263902e+02 3.91833849e+02 2.35872014e+02 1.52062573e+02
 7.53654044e+01 6.46240318e+01 9.92601140e+00 1.41285015e+01
 2.65884686e+01 2.95825098e+01 3.81148962e-01 1.22556424e+00
 1.11550011e+00 2.74231436e+00 2.88352813e+00 5.59059677e+00
 7.07289625e+00 3.36496849e+01 2.29976137e+01 1.46922348e+02
 9.88091164e+01 9.08825831e+02 2.65757982e-01 5.56662915e-01
 2.43179425e+00 8.85916778e+00 8.31716885e-01 2.31714809e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999588921740845
cond(S) = 346.3565855953753
E1 = -183.58959233150398  E_coul = 55.08017732930444
init E= -128.5094150022
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400808849257  LUMO = 0.822333996162457
  mo_energy =
[-3.25550492e+01 -1.85258813e+00 -7.75400809e-01 -7.75400809e-01
 -7.75400809e-01  8.22333996e-01  8.22333996e-01  8.22333996e-01
  1.21713165e+00  3.94400960e+00  3.94400960e+00  3.94400960e+00
  7.36108769e+00  1.42882932e+01  1.42882932e+01  1.42882932e+01
  3.44000800e+01  5.26304126e+01  5.26304126e+01  5.26304126e+01
  1.36817475e+02  2.38491428e+02  2.38491428e+02  2.38491428e+02
  4.98388443e+02  1.86518770e+03  7.99524990e+03  4.77637370e+04]
E1 = -182.08733055143674  E_coul = 53.54955038528711
cycle= 1 E= -128.53778016615  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509577
diis-c [-0.25966909  1.        ]
  HOMO = -0.884158314200091  LUMO = 0.795737314245115
  mo_energy =
[-3.28778713e+01 -1.96641917e+00 -8.84158314e-01 -8.84158314e-01
 -8.84158314e-01  7.95737314e-01  7.95737314e-01  7.95737314e-01
  1.17174168e+00  3.84696136e+00  3.84696136e+00  3.84696136e+00
  7.22948693e+00  1.40983121e+01  1.40983121e+01  1.40983121e+01
  3.41544027e+01  5.23502366e+01  5.23502366e+01  5.23502366e+01
  1.36500540e+02  2.38145858e+02  2.38145858e+02  2.38145858e+02
  4.98027338e+02  1.86479054e+03  7.99482377e+03  4.77632920e+04]
E1 = -182.84792807726538  E_coul = 54.30756519981068
cycle= 2 E= -128.540362877455  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258643
diis-c [-6.43909314e-04  3.35875408e-01  6.64124592e-01]
  HOMO = -0.848561423440236  LUMO = 0.804431619895356
  mo_energy =
[-3.27698501e+01 -1.92892565e+00 -8.48561423e-01 -8.48561423e-01
 -8.48561423e-01  8.04431620e-01  8.04431620e-01  8.04431620e-01
  1.18632622e+00  3.87845318e+00  3.87845318e+00  3.87845318e+00
  7.27263328e+00  1.41612792e+01  1.41612792e+01  1.41612792e+01
  3.42367287e+01  5.24440280e+01  5.24440280e+01  5.24440280e+01
  1.36606365e+02  2.38259367e+02  2.38259367e+02  2.38259367e+02
  4.98144087e+02  1.86491255e+03  7.99494821e+03  4.77634174e+04]
E1 = -182.5896974322992  E_coul = 54.04841693411943
cycle= 3 E= -128.54128049818  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116795
diis-c [-1.23494612e-07 -2.25631981e-03 -1.30136380e-04  1.00238646e+00]
  HOMO = -0.848815041021967  LUMO = 0.804395807372633
  mo_energy =
[-3.27703172e+01 -1.92912218e+00 -8.48815041e-01 -8.48815041e-01
 -8.48815041e-01  8.04395807e-01  8.04395807e-01  8.04395807e-01
  1.18625191e+00  3.87827770e+00  3.87827770e+00  3.87827770e+00
  7.27241869e+00  1.41609752e+01  1.41609752e+01  1.41609752e+01
  3.42363696e+01  5.24436165e+01  5.24436165e+01  5.24436165e+01
  1.36605897e+02  2.38258830e+02  2.38258830e+02  2.38258830e+02
  4.98143493e+02  1.86491182e+03  7.99494739e+03  4.77634165e+04]
E1 = -182.59023630652575  E_coul = 54.04895578726065
cycle= 4 E= -128.541280519265  delta_E= -2.11e-08  |g|= 7.52e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184987
diis-c [-7.96330964e-10  1.92400839e-04  4.86232408e-04 -1.59161442e-01
  1.15848281e+00]
  HOMO = -0.84885444987403  LUMO = 0.804384072854785
  mo_energy =
[-3.27703881e+01 -1.92915343e+00 -8.48854450e-01 -8.48854450e-01
 -8.48854450e-01  8.04384073e-01  8.04384073e-01  8.04384073e-01
  1.18623484e+00  3.87824080e+00  3.87824080e+00  3.87824080e+00
  7.27237715e+00  1.41609196e+01  1.41609196e+01  1.41609196e+01
  3.42363078e+01  5.24435501e+01  5.24435501e+01  5.24435501e+01
  1.36605826e+02  2.38258755e+02  2.38258755e+02  2.38258755e+02
  4.98143414e+02  1.86491173e+03  7.99494730e+03  4.77634164e+04]
E1 = -182.59037936116397  E_coul = 54.04909884135088
cycle= 5 E= -128.541280519813  delta_E= -5.48e-10  |g|= 4.46e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59037936116397  E_coul = 54.04909884135088
  HOMO = -0.848852301147121  LUMO = 0.804384710371594
  mo_energy =
[-3.27703834e+01 -1.92915055e+00 -8.48852301e-01 -8.48852301e-01
 -8.48852301e-01  8.04384710e-01  8.04384710e-01  8.04384710e-01
  1.18623628e+00  3.87824287e+00  3.87824287e+00  3.87824287e+00
  7.27238013e+00  1.41609232e+01  1.41609232e+01  1.41609232e+01
  3.42363121e+01  5.24435545e+01  5.24435545e+01  5.24435545e+01
  1.36605831e+02  2.38258759e+02  2.38258759e+02  2.38258759e+02
  4.98143418e+02  1.86491174e+03  7.99494730e+03  4.77634164e+04]
E1 = -182.59036867065979  E_coul = 54.04908815084517
Extra cycle  E= -128.541280519815  delta_E= -1.53e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.3565855953753
E1 = -182.59036867065979  E_coul = 54.04908815084517
init E= -128.541280519815
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848853063725935  LUMO = 0.804384537966797
  mo_energy =
[-3.27703858e+01 -1.92915122e+00 -8.48853064e-01 -8.48853064e-01
 -8.48853064e-01  8.04384538e-01  8.04384538e-01  8.04384538e-01
  1.18623606e+00  3.87824222e+00  3.87824222e+00  3.87824222e+00
  7.27237928e+00  1.41609218e+01  1.41609218e+01  1.41609218e+01
  3.42363103e+01  5.24435525e+01  5.24435525e+01  5.24435525e+01
  1.36605828e+02  2.38258757e+02  2.38258757e+02  2.38258757e+02
  4.98143416e+02  1.86491173e+03  7.99494730e+03  4.77634164e+04]
E1 = -182.59037466166887  E_coul = 54.04909414185422
cycle= 1 E= -128.541280519815  delta_E= -2.84e-14  |g|= 8.27e-07  |ddm|= 5.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59037466166887  E_coul = 54.04909414185422
  HOMO = -0.848852643427438  LUMO = 0.804384643323678
  mo_energy =
[-3.27703845e+01 -1.92915075e+00 -8.48852643e-01 -8.48852643e-01
 -8.48852643e-01  8.04384643e-01  8.04384643e-01  8.04384643e-01
  1.18623625e+00  3.87824260e+00  3.87824260e+00  3.87824260e+00
  7.27237981e+00  1.41609226e+01  1.41609226e+01  1.41609226e+01
  3.42363113e+01  5.24435536e+01  5.24435536e+01  5.24435536e+01
  1.36605830e+02  2.38258758e+02  2.38258758e+02  2.38258758e+02
  4.98143417e+02  1.86491174e+03  7.99494730e+03  4.77634164e+04]
E1 = -182.59037166431278  E_coul = 54.0490911444977
Extra cycle  E= -128.541280519815  delta_E= -4.26e-13  |g|= 4.07e-07  |ddm|= 2.91e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145471e+03 8.33263902e+02 2.35872014e+02
 7.53654044e+01 9.92601140e+00 2.65884686e+01 3.81148962e-01
 1.11550011e+00 2.88352813e+00 7.07289625e+00 2.29976137e+01
 9.88091164e+01 2.65757982e-01 2.43179425e+00 8.31716885e-01]
grad_E = [-2.44240265e-09  1.26198027e-07 -2.25710658e-06  1.87863499e-05
 -5.03743538e-05  2.98069207e-05  1.78722354e-05 -3.98863915e-06
  6.16834894e-05  1.85668251e-05 -3.61652716e-05  2.70247040e-06
 -8.48787476e-07 -8.02192552e-06  1.00367274e-04 -1.05492357e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941259        1
[INPUT] 0    0    [1    /1   ]  3661.45469553        1
[INPUT] 0    0    [1    /1   ]  833.264101741        1
[INPUT] 0    0    [1    /1   ]  235.870335577        1
[INPUT] 0    0    [1    /1   ]  75.3701428394        1
[INPUT] 0    0    [1    /1   ]  9.9244513498         1
[INPUT] 0    0    [1    /1   ]  26.5858149961        1
[INPUT] 0    0    [1    /1   ]  0.381325981526       1
[INPUT] 0    0    [1    /1   ]  1.1156893504         1
[INPUT] 0    0    [1    /1   ]  2.88071997468        1
[INPUT] 1    0    [1    /1   ]  7.06741368059        1
[INPUT] 1    0    [1    /1   ]  22.9843428605        1
[INPUT] 1    0    [1    /1   ]  98.8105844616        1
[INPUT] 1    0    [1    /1   ]  0.265660520317       1
[INPUT] 1    0    [1    /1   ]  2.43074666119        1
[INPUT] 1    0    [1    /1   ]  0.831416003797       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412587938, 1.0]], [0, [3661.4546955276246, 1.0]], [0, [833.26410174077, 1.0]], [0, [235.87033557736504, 1.0]], [0, [75.37014283939213, 1.0]], [0, [9.924451349803084, 1.0]], [0, [26.585814996092598, 1.0]], [0, [0.38132598152606695, 1.0]], [0, [1.1156893503950902, 1.0]], [0, [2.880719974681013, 1.0]], [1, [7.067413680590908, 1.0]], [1, [22.98434286054096, 1.0]], [1, [98.81058446158143, 1.0]], [1, [0.2656605203168503, 1.0]], [1, [2.430746661193763, 1.0]], [1, [0.8314160037970415, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412588]
bas 1, expnt(s) = [3661.45469553]
bas 2, expnt(s) = [833.26410174]
bas 3, expnt(s) = [235.87033558]
bas 4, expnt(s) = [75.37014284]
bas 5, expnt(s) = [9.92445135]
bas 6, expnt(s) = [26.585815]
bas 7, expnt(s) = [0.38132598]
bas 8, expnt(s) = [1.11568935]
bas 9, expnt(s) = [2.88071997]
bas 10, expnt(s) = [7.06741368]
bas 11, expnt(s) = [22.98434286]
bas 12, expnt(s) = [98.81058446]
bas 13, expnt(s) = [0.26566052]
bas 14, expnt(s) = [2.43074666]
bas 15, expnt(s) = [0.831416]
CPU time:       294.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264102e+02 3.91833919e+02 2.35870336e+02 1.52061762e+02
 7.53701428e+01 6.46270791e+01 9.92445135e+00 1.41268360e+01
 2.65858150e+01 2.95802955e+01 3.81325982e-01 1.22599111e+00
 1.11568935e+00 2.74266327e+00 2.88071997e+00 5.58651292e+00
 7.06741368e+00 3.36170836e+01 2.29843429e+01 1.46816378e+02
 9.88105845e+01 9.08842709e+02 2.65660520e-01 5.56407744e-01
 2.43074666e+00 8.85439750e+00 8.31416004e-01 2.31610032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999589527747428
cond(S) = 346.31904111770416
E1 = -183.58958505819461  E_coul = 55.08017588161371
init E= -128.509409176581
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400765035049  LUMO = 0.821957485995211
  mo_energy =
[-3.25550500e+01 -1.85258834e+00 -7.75400765e-01 -7.75400765e-01
 -7.75400765e-01  8.21957486e-01  8.21957486e-01  8.21957486e-01
  1.21760071e+00  3.94229845e+00  3.94229845e+00  3.94229845e+00
  7.35864483e+00  1.42795652e+01  1.42795652e+01  1.42795652e+01
  3.43876381e+01  5.25934003e+01  5.25934003e+01  5.25934003e+01
  1.36799250e+02  2.38431965e+02  2.38431965e+02  2.38431965e+02
  4.98374591e+02  1.86517672e+03  7.99524012e+03  4.77637289e+04]
E1 = -182.08727831144537  E_coul = 53.54949805290561
cycle= 1 E= -128.53778025854  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509586
diis-c [-0.25967777  1.        ]
  HOMO = -0.884161906341163  LUMO = 0.795375144460784
  mo_energy =
[-3.28778810e+01 -1.96642505e+00 -8.84161906e-01 -8.84161906e-01
 -8.84161906e-01  7.95375144e-01  7.95375144e-01  7.95375144e-01
  1.17220153e+00  3.84528115e+00  3.84528115e+00  3.84528115e+00
  7.22708902e+00  1.40896399e+01  1.40896399e+01  1.40896399e+01
  3.41419750e+01  5.23132534e+01  5.23132534e+01  5.23132534e+01
  1.36482306e+02  2.38086384e+02  2.38086384e+02  2.38086384e+02
  4.98013475e+02  1.86477955e+03  7.99481398e+03  4.77632839e+04]
E1 = -182.84790506197197  E_coul = 54.30754201220395
cycle= 2 E= -128.540363049768  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258654
diis-c [-6.43764049e-04  3.35881596e-01  6.64118404e-01]
  HOMO = -0.84856389940576  LUMO = 0.804064819505216
  mo_energy =
[-3.27698571e+01 -1.92893024e+00 -8.48563899e-01 -8.48563899e-01
 -8.48563899e-01  8.04064820e-01  8.04064820e-01  8.04064820e-01
  1.18678858e+00  3.87676246e+00  3.87676246e+00  3.87676246e+00
  7.27021960e+00  1.41525880e+01  1.41525880e+01  1.41525880e+01
  3.42242966e+01  5.24070349e+01  5.24070349e+01  5.24070349e+01
  1.36588134e+02  2.38199897e+02  2.38199897e+02  2.38199897e+02
  4.98130227e+02  1.86490156e+03  7.99493842e+03  4.77634093e+04]
E1 = -182.58966083230274  E_coul = 54.04838007883625
cycle= 3 E= -128.541280753466  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116708
diis-c [-1.23139635e-07 -2.25541597e-03 -1.31354527e-04  1.00238677e+00]
  HOMO = -0.848817506146164  LUMO = 0.804029034741442
  mo_energy =
[-3.27703240e+01 -1.92912688e+00 -8.48817506e-01 -8.48817506e-01
 -8.48817506e-01  8.04029035e-01  8.04029035e-01  8.04029035e-01
  1.18671420e+00  3.87658704e+00  3.87658704e+00  3.87658704e+00
  7.27000502e+00  1.41522840e+01  1.41522840e+01  1.41522840e+01
  3.42239376e+01  5.24066236e+01  5.24066236e+01  5.24066236e+01
  1.36587666e+02  2.38199360e+02  2.38199360e+02  2.38199360e+02
  4.98129633e+02  1.86490083e+03  7.99493760e+03  4.77634084e+04]
E1 = -182.59019922906919  E_coul = 54.04891845454374
cycle= 4 E= -128.541280774525  delta_E= -2.11e-08  |g|= 7.51e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184795
diis-c [-7.94088318e-10  1.91891988e-04  4.85775332e-04 -1.58935480e-01
  1.15825781e+00]
  HOMO = -0.848856896029548  LUMO = 0.804017309402294
  mo_energy =
[-3.27703948e+01 -1.92915814e+00 -8.48856896e-01 -8.48856896e-01
 -8.48856896e-01  8.04017309e-01  8.04017309e-01  8.04017309e-01
  1.18669712e+00  3.87655017e+00  3.87655017e+00  3.87655017e+00
  7.26996349e+00  1.41522285e+01  1.41522285e+01  1.41522285e+01
  3.42238758e+01  5.24065571e+01  5.24065571e+01  5.24065571e+01
  1.36587595e+02  2.38199285e+02  2.38199285e+02  2.38199285e+02
  4.98129554e+02  1.86490075e+03  7.99493751e+03  4.77634083e+04]
E1 = -182.59034212576188  E_coul = 54.04906135068967
cycle= 5 E= -128.541280775072  delta_E= -5.47e-10  |g|= 4.45e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59034212576188  E_coul = 54.04906135068967
  HOMO = -0.84885475540513  LUMO = 0.804017944025767
  mo_energy =
[-3.27703902e+01 -1.92915527e+00 -8.48854755e-01 -8.48854755e-01
 -8.48854755e-01  8.04017944e-01  8.04017944e-01  8.04017944e-01
  1.18669855e+00  3.87655223e+00  3.87655223e+00  3.87655223e+00
  7.26996646e+00  1.41522320e+01  1.41522320e+01  1.41522320e+01
  3.42238800e+01  5.24065616e+01  5.24065616e+01  5.24065616e+01
  1.36587600e+02  2.38199289e+02  2.38199289e+02  2.38199289e+02
  4.98129559e+02  1.86490075e+03  7.99493751e+03  4.77634083e+04]
E1 = -182.59033146803168  E_coul = 54.04905069295784
Extra cycle  E= -128.541280775074  delta_E= -1.62e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264102e+02 2.35870336e+02
 7.53701428e+01 9.92445135e+00 2.65858150e+01 3.81325982e-01
 1.11568935e+00 2.88071997e+00 7.06741368e+00 2.29843429e+01
 9.88105845e+01 2.65660520e-01 2.43074666e+00 8.31416004e-01]
E = -128.54128077507383
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941259        1
[INPUT] 0    0    [1    /1   ]  3661.45469553        1
[INPUT] 0    0    [1    /1   ]  833.264101741        1
[INPUT] 0    0    [1    /1   ]  235.870335577        1
[INPUT] 0    0    [1    /1   ]  75.3701428394        1
[INPUT] 0    0    [1    /1   ]  9.9244513498         1
[INPUT] 0    0    [1    /1   ]  26.5858149961        1
[INPUT] 0    0    [1    /1   ]  0.381325981526       1
[INPUT] 0    0    [1    /1   ]  1.1156893504         1
[INPUT] 0    0    [1    /1   ]  2.88071997468        1
[INPUT] 1    0    [1    /1   ]  7.06741368059        1
[INPUT] 1    0    [1    /1   ]  22.9843428605        1
[INPUT] 1    0    [1    /1   ]  98.8105844616        1
[INPUT] 1    0    [1    /1   ]  0.265660520317       1
[INPUT] 1    0    [1    /1   ]  2.43074666119        1
[INPUT] 1    0    [1    /1   ]  0.831416003797       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412587938, 1.0]], [0, [3661.4546955276246, 1.0]], [0, [833.26410174077, 1.0]], [0, [235.87033557736504, 1.0]], [0, [75.37014283939213, 1.0]], [0, [9.924451349803084, 1.0]], [0, [26.585814996092598, 1.0]], [0, [0.38132598152606695, 1.0]], [0, [1.1156893503950902, 1.0]], [0, [2.880719974681013, 1.0]], [1, [7.067413680590908, 1.0]], [1, [22.98434286054096, 1.0]], [1, [98.81058446158143, 1.0]], [1, [0.2656605203168503, 1.0]], [1, [2.430746661193763, 1.0]], [1, [0.8314160037970415, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412588]
bas 1, expnt(s) = [3661.45469553]
bas 2, expnt(s) = [833.26410174]
bas 3, expnt(s) = [235.87033558]
bas 4, expnt(s) = [75.37014284]
bas 5, expnt(s) = [9.92445135]
bas 6, expnt(s) = [26.585815]
bas 7, expnt(s) = [0.38132598]
bas 8, expnt(s) = [1.11568935]
bas 9, expnt(s) = [2.88071997]
bas 10, expnt(s) = [7.06741368]
bas 11, expnt(s) = [22.98434286]
bas 12, expnt(s) = [98.81058446]
bas 13, expnt(s) = [0.26566052]
bas 14, expnt(s) = [2.43074666]
bas 15, expnt(s) = [0.831416]
CPU time:       295.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145470e+03 1.18920102e+03
 8.33264102e+02 3.91833919e+02 2.35870336e+02 1.52061762e+02
 7.53701428e+01 6.46270791e+01 9.92445135e+00 1.41268360e+01
 2.65858150e+01 2.95802955e+01 3.81325982e-01 1.22599111e+00
 1.11568935e+00 2.74266327e+00 2.88071997e+00 5.58651292e+00
 7.06741368e+00 3.36170836e+01 2.29843429e+01 1.46816378e+02
 9.88105845e+01 9.08842709e+02 2.65660520e-01 5.56407744e-01
 2.43074666e+00 8.85439750e+00 8.31416004e-01 2.31610032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999589527747428
cond(S) = 346.31904111770416
E1 = -183.58958505819461  E_coul = 55.08017588161371
init E= -128.509409176581
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400765035049  LUMO = 0.821957485995211
  mo_energy =
[-3.25550500e+01 -1.85258834e+00 -7.75400765e-01 -7.75400765e-01
 -7.75400765e-01  8.21957486e-01  8.21957486e-01  8.21957486e-01
  1.21760071e+00  3.94229845e+00  3.94229845e+00  3.94229845e+00
  7.35864483e+00  1.42795652e+01  1.42795652e+01  1.42795652e+01
  3.43876381e+01  5.25934003e+01  5.25934003e+01  5.25934003e+01
  1.36799250e+02  2.38431965e+02  2.38431965e+02  2.38431965e+02
  4.98374591e+02  1.86517672e+03  7.99524012e+03  4.77637289e+04]
E1 = -182.08727831144537  E_coul = 53.54949805290561
cycle= 1 E= -128.53778025854  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509586
diis-c [-0.25967777  1.        ]
  HOMO = -0.884161906341163  LUMO = 0.795375144460784
  mo_energy =
[-3.28778810e+01 -1.96642505e+00 -8.84161906e-01 -8.84161906e-01
 -8.84161906e-01  7.95375144e-01  7.95375144e-01  7.95375144e-01
  1.17220153e+00  3.84528115e+00  3.84528115e+00  3.84528115e+00
  7.22708902e+00  1.40896399e+01  1.40896399e+01  1.40896399e+01
  3.41419750e+01  5.23132534e+01  5.23132534e+01  5.23132534e+01
  1.36482306e+02  2.38086384e+02  2.38086384e+02  2.38086384e+02
  4.98013475e+02  1.86477955e+03  7.99481398e+03  4.77632839e+04]
E1 = -182.84790506197197  E_coul = 54.30754201220395
cycle= 2 E= -128.540363049768  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258654
diis-c [-6.43764049e-04  3.35881596e-01  6.64118404e-01]
  HOMO = -0.84856389940576  LUMO = 0.804064819505216
  mo_energy =
[-3.27698571e+01 -1.92893024e+00 -8.48563899e-01 -8.48563899e-01
 -8.48563899e-01  8.04064820e-01  8.04064820e-01  8.04064820e-01
  1.18678858e+00  3.87676246e+00  3.87676246e+00  3.87676246e+00
  7.27021960e+00  1.41525880e+01  1.41525880e+01  1.41525880e+01
  3.42242966e+01  5.24070349e+01  5.24070349e+01  5.24070349e+01
  1.36588134e+02  2.38199897e+02  2.38199897e+02  2.38199897e+02
  4.98130227e+02  1.86490156e+03  7.99493842e+03  4.77634093e+04]
E1 = -182.58966083230274  E_coul = 54.04838007883625
cycle= 3 E= -128.541280753466  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116708
diis-c [-1.23139635e-07 -2.25541597e-03 -1.31354527e-04  1.00238677e+00]
  HOMO = -0.848817506146164  LUMO = 0.804029034741442
  mo_energy =
[-3.27703240e+01 -1.92912688e+00 -8.48817506e-01 -8.48817506e-01
 -8.48817506e-01  8.04029035e-01  8.04029035e-01  8.04029035e-01
  1.18671420e+00  3.87658704e+00  3.87658704e+00  3.87658704e+00
  7.27000502e+00  1.41522840e+01  1.41522840e+01  1.41522840e+01
  3.42239376e+01  5.24066236e+01  5.24066236e+01  5.24066236e+01
  1.36587666e+02  2.38199360e+02  2.38199360e+02  2.38199360e+02
  4.98129633e+02  1.86490083e+03  7.99493760e+03  4.77634084e+04]
E1 = -182.59019922906919  E_coul = 54.04891845454374
cycle= 4 E= -128.541280774525  delta_E= -2.11e-08  |g|= 7.51e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184795
diis-c [-7.94088318e-10  1.91891988e-04  4.85775332e-04 -1.58935480e-01
  1.15825781e+00]
  HOMO = -0.848856896029548  LUMO = 0.804017309402294
  mo_energy =
[-3.27703948e+01 -1.92915814e+00 -8.48856896e-01 -8.48856896e-01
 -8.48856896e-01  8.04017309e-01  8.04017309e-01  8.04017309e-01
  1.18669712e+00  3.87655017e+00  3.87655017e+00  3.87655017e+00
  7.26996349e+00  1.41522285e+01  1.41522285e+01  1.41522285e+01
  3.42238758e+01  5.24065571e+01  5.24065571e+01  5.24065571e+01
  1.36587595e+02  2.38199285e+02  2.38199285e+02  2.38199285e+02
  4.98129554e+02  1.86490075e+03  7.99493751e+03  4.77634083e+04]
E1 = -182.59034212576188  E_coul = 54.04906135068967
cycle= 5 E= -128.541280775072  delta_E= -5.47e-10  |g|= 4.45e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59034212576188  E_coul = 54.04906135068967
  HOMO = -0.84885475540513  LUMO = 0.804017944025767
  mo_energy =
[-3.27703902e+01 -1.92915527e+00 -8.48854755e-01 -8.48854755e-01
 -8.48854755e-01  8.04017944e-01  8.04017944e-01  8.04017944e-01
  1.18669855e+00  3.87655223e+00  3.87655223e+00  3.87655223e+00
  7.26996646e+00  1.41522320e+01  1.41522320e+01  1.41522320e+01
  3.42238800e+01  5.24065616e+01  5.24065616e+01  5.24065616e+01
  1.36587600e+02  2.38199289e+02  2.38199289e+02  2.38199289e+02
  4.98129559e+02  1.86490075e+03  7.99493751e+03  4.77634083e+04]
E1 = -182.59033146803168  E_coul = 54.04905069295784
Extra cycle  E= -128.541280775074  delta_E= -1.62e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 346.31904111770416
E1 = -182.59033146803168  E_coul = 54.04905069295784
init E= -128.541280775074
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.848855515744271  LUMO = 0.80401777220592
  mo_energy =
[-3.27703926e+01 -1.92915594e+00 -8.48855516e-01 -8.48855516e-01
 -8.48855516e-01  8.04017772e-01  8.04017772e-01  8.04017772e-01
  1.18669833e+00  3.87655158e+00  3.87655158e+00  3.87655158e+00
  7.26996561e+00  1.41522307e+01  1.41522307e+01  1.41522307e+01
  3.42238783e+01  5.24065595e+01  5.24065595e+01  5.24065595e+01
  1.36587597e+02  2.38199287e+02  2.38199287e+02  2.38199287e+02
  4.98129556e+02  1.86490075e+03  7.99493751e+03  4.77634083e+04]
E1 = -182.5903374400838  E_coul = 54.049056665009545
cycle= 1 E= -128.541280775074  delta_E= -4.26e-13  |g|= 8.24e-07  |ddm|= 5.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5903374400838  E_coul = 54.049056665009545
  HOMO = -0.848855096788216  LUMO = 0.804017877167753
  mo_energy =
[-3.27703913e+01 -1.92915547e+00 -8.48855097e-01 -8.48855097e-01
 -8.48855097e-01  8.04017877e-01  8.04017877e-01  8.04017877e-01
  1.18669852e+00  3.87655195e+00  3.87655195e+00  3.87655195e+00
  7.26996614e+00  1.41522314e+01  1.41522314e+01  1.41522314e+01
  3.42238792e+01  5.24065606e+01  5.24065606e+01  5.24065606e+01
  1.36587598e+02  2.38199288e+02  2.38199288e+02  2.38199288e+02
  4.98129557e+02  1.86490075e+03  7.99493751e+03  4.77634083e+04]
E1 = -182.59033445212648  E_coul = 54.04905367705242
Extra cycle  E= -128.541280775074  delta_E= 1.99e-13  |g|= 4.06e-07  |ddm|= 2.91e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145470e+03 8.33264102e+02 2.35870336e+02
 7.53701428e+01 9.92445135e+00 2.65858150e+01 3.81325982e-01
 1.11568935e+00 2.88071997e+00 7.06741368e+00 2.29843429e+01
 9.88105845e+01 2.65660520e-01 2.43074666e+00 8.31416004e-01]
grad_E = [-2.40710041e-09  1.24346158e-07 -2.22233841e-06  1.84239603e-05
 -4.83972041e-05  3.33316727e-05  1.31442356e-05 -3.46879918e-06
  9.46351712e-05  8.26441165e-06 -6.56500546e-05  5.10022398e-06
 -7.33377504e-07 -1.52124926e-05  1.80227088e-04 -1.87410908e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941264        1
[INPUT] 0    0    [1    /1   ]  3661.45466718        1
[INPUT] 0    0    [1    /1   ]  833.264608653        1
[INPUT] 0    0    [1    /1   ]  235.866111232        1
[INPUT] 0    0    [1    /1   ]  75.3816542007        1
[INPUT] 0    0    [1    /1   ]  9.91951297287        1
[INPUT] 0    0    [1    /1   ]  26.5798119075        1
[INPUT] 0    0    [1    /1   ]  0.381387068864       1
[INPUT] 0    0    [1    /1   ]  1.1150285571         1
[INPUT] 0    0    [1    /1   ]  2.87343821388        1
[INPUT] 1    0    [1    /1   ]  7.05994323289        1
[INPUT] 1    0    [1    /1   ]  22.9673602463        1
[INPUT] 1    0    [1    /1   ]  98.8266728419        1
[INPUT] 1    0    [1    /1   ]  0.26552726867        1
[INPUT] 1    0    [1    /1   ]  2.42936832904        1
[INPUT] 1    0    [1    /1   ]  0.831020518481       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412642793, 1.0]], [0, [3661.454667178573, 1.0]], [0, [833.2646086529847, 1.0]], [0, [235.8661112315548, 1.0]], [0, [75.38165420069097, 1.0]], [0, [9.919512972870066, 1.0]], [0, [26.57981190749688, 1.0]], [0, [0.38138706886439866, 1.0]], [0, [1.1150285571028575, 1.0]], [0, [2.873438213882852, 1.0]], [1, [7.059943232890926, 1.0]], [1, [22.96736024625551, 1.0]], [1, [98.82667284186418, 1.0]], [1, [0.26552726867047105, 1.0]], [1, [2.4293683290408508, 1.0]], [1, [0.8310205184814246, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412643]
bas 1, expnt(s) = [3661.45466718]
bas 2, expnt(s) = [833.26460865]
bas 3, expnt(s) = [235.86611123]
bas 4, expnt(s) = [75.3816542]
bas 5, expnt(s) = [9.91951297]
bas 6, expnt(s) = [26.57981191]
bas 7, expnt(s) = [0.38138707]
bas 8, expnt(s) = [1.11502856]
bas 9, expnt(s) = [2.87343821]
bas 10, expnt(s) = [7.05994323]
bas 11, expnt(s) = [22.96736025]
bas 12, expnt(s) = [98.82667284]
bas 13, expnt(s) = [0.26552727]
bas 14, expnt(s) = [2.42936833]
bas 15, expnt(s) = [0.83102052]
CPU time:       298.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145467e+03 1.18920101e+03
 8.33264609e+02 3.91834098e+02 2.35866111e+02 1.52059719e+02
 7.53816542e+01 6.46344819e+01 9.91951297e+00 1.41215636e+01
 2.65798119e+01 2.95752859e+01 3.81387069e-01 1.22613841e+00
 1.11502856e+00 2.74144487e+00 2.87343821e+00 5.57591856e+00
 7.05994323e+00 3.35726717e+01 2.29673602e+01 1.46680792e+02
 9.88266728e+01 9.09027686e+02 2.65527269e-01 5.56058908e-01
 2.42936833e+00 8.84812194e+00 8.31020518e-01 2.31472326e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999590593777516
cond(S) = 345.8746026811637
E1 = -183.58957149991775  E_coul = 55.08017339854378
init E= -128.509398101374
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400709685211  LUMO = 0.821447601078914
  mo_energy =
[-3.25550508e+01 -1.85258932e+00 -7.75400710e-01 -7.75400710e-01
 -7.75400710e-01  8.21447601e-01  8.21447601e-01  8.21447601e-01
  1.21711038e+00  3.94003394e+00  3.94003394e+00  3.94003394e+00
  7.34684025e+00  1.42678700e+01  1.42678700e+01  1.42678700e+01
  3.43474692e+01  5.25445719e+01  5.25445719e+01  5.25445719e+01
  1.36744212e+02  2.38378242e+02  2.38378242e+02  2.38378242e+02
  4.98331125e+02  1.86514107e+03  7.99520836e+03  4.77637026e+04]
E1 = -182.0871971733604  E_coul = 53.549416534127566
cycle= 1 E= -128.537780639233  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509592
diis-c [-0.25968427  1.        ]
  HOMO = -0.884167610172053  LUMO = 0.794884056300452
  mo_energy =
[-3.28778959e+01 -1.96643424e+00 -8.84167610e-01 -8.84167610e-01
 -8.84167610e-01  7.94884056e-01  7.94884056e-01  7.94884056e-01
  1.17174137e+00  3.84305653e+00  3.84305653e+00  3.84305653e+00
  7.21543345e+00  1.40780186e+01  1.40780186e+01  1.40780186e+01
  3.41018478e+01  5.22644601e+01  5.22644601e+01  5.22644601e+01
  1.36427253e+02  2.38032641e+02  2.38032641e+02  2.38032641e+02
  4.97969991e+02  1.86474388e+03  7.99478220e+03  4.77632576e+04]
E1 = -182.847866582171  E_coul = 54.3075030306811
cycle= 2 E= -128.54036355149  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258666
diis-c [-6.43425583e-04  3.35890012e-01  6.64109988e-01]
  HOMO = -0.848567932368967  LUMO = 0.803567573894451
  mo_energy =
[-3.27698679e+01 -1.92893756e+00 -8.48567932e-01 -8.48567932e-01
 -8.48567932e-01  8.03567574e-01  8.03567574e-01  8.03567574e-01
  1.18631778e+00  3.87452415e+00  3.87452415e+00  3.87452415e+00
  7.25851293e+00  1.41409412e+01  1.41409412e+01  1.41409412e+01
  3.41841557e+01  5.23582292e+01  5.23582292e+01  5.23582292e+01
  1.36533086e+02  2.38146159e+02  2.38146159e+02  2.38146159e+02
  4.98086748e+02  1.86486589e+03  7.99490665e+03  4.77633830e+04]
E1 = -182.5896015636345  E_coul = 54.04832018540754
cycle= 3 E= -128.541281378227  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116619
diis-c [-1.22731038e-07 -2.25437693e-03 -1.32272999e-04  1.00238665e+00]
  HOMO = -0.84882162046096  LUMO = 0.803531795326875
  mo_energy =
[-3.27703347e+01 -1.92913443e+00 -8.48821620e-01 -8.48821620e-01
 -8.48821620e-01  8.03531795e-01  8.03531795e-01  8.03531795e-01
  1.18624331e+00  3.87434871e+00  3.87434871e+00  3.87434871e+00
  7.25829837e+00  1.41406373e+01  1.41406373e+01  1.41406373e+01
  3.41837966e+01  5.23578179e+01  5.23578179e+01  5.23578179e+01
  1.36532618e+02  2.38145622e+02  2.38145622e+02  2.38145622e+02
  4.98086155e+02  1.86486517e+03  7.99490583e+03  4.77633821e+04]
E1 = -182.59013945953086  E_coul = 54.04885806025971
cycle= 4 E= -128.541281399271  delta_E= -2.1e-08  |g|= 7.5e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184562
diis-c [-7.91422137e-10  1.91244204e-04  4.85057303e-04 -1.58661434e-01
  1.15798513e+00]
  HOMO = -0.848860999613193  LUMO = 0.803520077341424
  mo_energy =
[-3.27704055e+01 -1.92916570e+00 -8.48861000e-01 -8.48861000e-01
 -8.48861000e-01  8.03520077e-01  8.03520077e-01  8.03520077e-01
  1.18622622e+00  3.87431186e+00  3.87431186e+00  3.87431186e+00
  7.25825686e+00  1.41405818e+01  1.41405818e+01  1.41405818e+01
  3.41837349e+01  5.23577515e+01  5.23577515e+01  5.23577515e+01
  1.36532547e+02  2.38145547e+02  2.38145547e+02  2.38145547e+02
  4.98086076e+02  1.86486508e+03  7.99490574e+03  4.77633820e+04]
E1 = -182.5902821455948  E_coul = 54.04900074577835
cycle= 5 E= -128.541281399816  delta_E= -5.45e-10  |g|= 4.43e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5902821455948  E_coul = 54.04900074577835
  HOMO = -0.848858869374096  LUMO = 0.803520708258211
  mo_energy =
[-3.27704009e+01 -1.92916285e+00 -8.48858869e-01 -8.48858869e-01
 -8.48858869e-01  8.03520708e-01  8.03520708e-01  8.03520708e-01
  1.18622764e+00  3.87431391e+00  3.87431391e+00  3.87431391e+00
  7.25825982e+00  1.41405853e+01  1.41405853e+01  1.41405853e+01
  3.41837391e+01  5.23577560e+01  5.23577560e+01  5.23577560e+01
  1.36532552e+02  2.38145552e+02  2.38145552e+02  2.38145552e+02
  4.98086080e+02  1.86486508e+03  7.99490574e+03  4.77633820e+04]
E1 = -182.59027153014844  E_coul = 54.0489901303306
Extra cycle  E= -128.541281399818  delta_E= -1.39e-12  |g|= 1.52e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145467e+03 8.33264609e+02 2.35866111e+02
 7.53816542e+01 9.91951297e+00 2.65798119e+01 3.81387069e-01
 1.11502856e+00 2.87343821e+00 7.05994323e+00 2.29673602e+01
 9.88266728e+01 2.65527269e-01 2.42936833e+00 8.31020518e-01]
E = -128.54128139981785
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941264        1
[INPUT] 0    0    [1    /1   ]  3661.45466718        1
[INPUT] 0    0    [1    /1   ]  833.264608653        1
[INPUT] 0    0    [1    /1   ]  235.866111232        1
[INPUT] 0    0    [1    /1   ]  75.3816542007        1
[INPUT] 0    0    [1    /1   ]  9.91951297287        1
[INPUT] 0    0    [1    /1   ]  26.5798119075        1
[INPUT] 0    0    [1    /1   ]  0.381387068864       1
[INPUT] 0    0    [1    /1   ]  1.1150285571         1
[INPUT] 0    0    [1    /1   ]  2.87343821388        1
[INPUT] 1    0    [1    /1   ]  7.05994323289        1
[INPUT] 1    0    [1    /1   ]  22.9673602463        1
[INPUT] 1    0    [1    /1   ]  98.8266728419        1
[INPUT] 1    0    [1    /1   ]  0.26552726867        1
[INPUT] 1    0    [1    /1   ]  2.42936832904        1
[INPUT] 1    0    [1    /1   ]  0.831020518481       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412642793, 1.0]], [0, [3661.454667178573, 1.0]], [0, [833.2646086529847, 1.0]], [0, [235.8661112315548, 1.0]], [0, [75.38165420069097, 1.0]], [0, [9.919512972870066, 1.0]], [0, [26.57981190749688, 1.0]], [0, [0.38138706886439866, 1.0]], [0, [1.1150285571028575, 1.0]], [0, [2.873438213882852, 1.0]], [1, [7.059943232890926, 1.0]], [1, [22.96736024625551, 1.0]], [1, [98.82667284186418, 1.0]], [1, [0.26552726867047105, 1.0]], [1, [2.4293683290408508, 1.0]], [1, [0.8310205184814246, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412643]
bas 1, expnt(s) = [3661.45466718]
bas 2, expnt(s) = [833.26460865]
bas 3, expnt(s) = [235.86611123]
bas 4, expnt(s) = [75.3816542]
bas 5, expnt(s) = [9.91951297]
bas 6, expnt(s) = [26.57981191]
bas 7, expnt(s) = [0.38138707]
bas 8, expnt(s) = [1.11502856]
bas 9, expnt(s) = [2.87343821]
bas 10, expnt(s) = [7.05994323]
bas 11, expnt(s) = [22.96736025]
bas 12, expnt(s) = [98.82667284]
bas 13, expnt(s) = [0.26552727]
bas 14, expnt(s) = [2.42936833]
bas 15, expnt(s) = [0.83102052]
CPU time:       300.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145467e+03 1.18920101e+03
 8.33264609e+02 3.91834098e+02 2.35866111e+02 1.52059719e+02
 7.53816542e+01 6.46344819e+01 9.91951297e+00 1.41215636e+01
 2.65798119e+01 2.95752859e+01 3.81387069e-01 1.22613841e+00
 1.11502856e+00 2.74144487e+00 2.87343821e+00 5.57591856e+00
 7.05994323e+00 3.35726717e+01 2.29673602e+01 1.46680792e+02
 9.88266728e+01 9.09027686e+02 2.65527269e-01 5.56058908e-01
 2.42936833e+00 8.84812194e+00 8.31020518e-01 2.31472326e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999590593777516
cond(S) = 345.8746026811637
E1 = -183.58957149991775  E_coul = 55.08017339854378
init E= -128.509398101374
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400709685211  LUMO = 0.821447601078914
  mo_energy =
[-3.25550508e+01 -1.85258932e+00 -7.75400710e-01 -7.75400710e-01
 -7.75400710e-01  8.21447601e-01  8.21447601e-01  8.21447601e-01
  1.21711038e+00  3.94003394e+00  3.94003394e+00  3.94003394e+00
  7.34684025e+00  1.42678700e+01  1.42678700e+01  1.42678700e+01
  3.43474692e+01  5.25445719e+01  5.25445719e+01  5.25445719e+01
  1.36744212e+02  2.38378242e+02  2.38378242e+02  2.38378242e+02
  4.98331125e+02  1.86514107e+03  7.99520836e+03  4.77637026e+04]
E1 = -182.0871971733604  E_coul = 53.549416534127566
cycle= 1 E= -128.537780639233  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509592
diis-c [-0.25968427  1.        ]
  HOMO = -0.884167610172053  LUMO = 0.794884056300452
  mo_energy =
[-3.28778959e+01 -1.96643424e+00 -8.84167610e-01 -8.84167610e-01
 -8.84167610e-01  7.94884056e-01  7.94884056e-01  7.94884056e-01
  1.17174137e+00  3.84305653e+00  3.84305653e+00  3.84305653e+00
  7.21543345e+00  1.40780186e+01  1.40780186e+01  1.40780186e+01
  3.41018478e+01  5.22644601e+01  5.22644601e+01  5.22644601e+01
  1.36427253e+02  2.38032641e+02  2.38032641e+02  2.38032641e+02
  4.97969991e+02  1.86474388e+03  7.99478220e+03  4.77632576e+04]
E1 = -182.847866582171  E_coul = 54.3075030306811
cycle= 2 E= -128.54036355149  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258666
diis-c [-6.43425583e-04  3.35890012e-01  6.64109988e-01]
  HOMO = -0.848567932368967  LUMO = 0.803567573894451
  mo_energy =
[-3.27698679e+01 -1.92893756e+00 -8.48567932e-01 -8.48567932e-01
 -8.48567932e-01  8.03567574e-01  8.03567574e-01  8.03567574e-01
  1.18631778e+00  3.87452415e+00  3.87452415e+00  3.87452415e+00
  7.25851293e+00  1.41409412e+01  1.41409412e+01  1.41409412e+01
  3.41841557e+01  5.23582292e+01  5.23582292e+01  5.23582292e+01
  1.36533086e+02  2.38146159e+02  2.38146159e+02  2.38146159e+02
  4.98086748e+02  1.86486589e+03  7.99490665e+03  4.77633830e+04]
E1 = -182.5896015636345  E_coul = 54.04832018540754
cycle= 3 E= -128.541281378227  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116619
diis-c [-1.22731038e-07 -2.25437693e-03 -1.32272999e-04  1.00238665e+00]
  HOMO = -0.84882162046096  LUMO = 0.803531795326875
  mo_energy =
[-3.27703347e+01 -1.92913443e+00 -8.48821620e-01 -8.48821620e-01
 -8.48821620e-01  8.03531795e-01  8.03531795e-01  8.03531795e-01
  1.18624331e+00  3.87434871e+00  3.87434871e+00  3.87434871e+00
  7.25829837e+00  1.41406373e+01  1.41406373e+01  1.41406373e+01
  3.41837966e+01  5.23578179e+01  5.23578179e+01  5.23578179e+01
  1.36532618e+02  2.38145622e+02  2.38145622e+02  2.38145622e+02
  4.98086155e+02  1.86486517e+03  7.99490583e+03  4.77633821e+04]
E1 = -182.59013945953086  E_coul = 54.04885806025971
cycle= 4 E= -128.541281399271  delta_E= -2.1e-08  |g|= 7.5e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184562
diis-c [-7.91422137e-10  1.91244204e-04  4.85057303e-04 -1.58661434e-01
  1.15798513e+00]
  HOMO = -0.848860999613193  LUMO = 0.803520077341424
  mo_energy =
[-3.27704055e+01 -1.92916570e+00 -8.48861000e-01 -8.48861000e-01
 -8.48861000e-01  8.03520077e-01  8.03520077e-01  8.03520077e-01
  1.18622622e+00  3.87431186e+00  3.87431186e+00  3.87431186e+00
  7.25825686e+00  1.41405818e+01  1.41405818e+01  1.41405818e+01
  3.41837349e+01  5.23577515e+01  5.23577515e+01  5.23577515e+01
  1.36532547e+02  2.38145547e+02  2.38145547e+02  2.38145547e+02
  4.98086076e+02  1.86486508e+03  7.99490574e+03  4.77633820e+04]
E1 = -182.5902821455948  E_coul = 54.04900074577835
cycle= 5 E= -128.541281399816  delta_E= -5.45e-10  |g|= 4.43e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5902821455948  E_coul = 54.04900074577835
  HOMO = -0.848858869374096  LUMO = 0.803520708258211
  mo_energy =
[-3.27704009e+01 -1.92916285e+00 -8.48858869e-01 -8.48858869e-01
 -8.48858869e-01  8.03520708e-01  8.03520708e-01  8.03520708e-01
  1.18622764e+00  3.87431391e+00  3.87431391e+00  3.87431391e+00
  7.25825982e+00  1.41405853e+01  1.41405853e+01  1.41405853e+01
  3.41837391e+01  5.23577560e+01  5.23577560e+01  5.23577560e+01
  1.36532552e+02  2.38145552e+02  2.38145552e+02  2.38145552e+02
  4.98086080e+02  1.86486508e+03  7.99490574e+03  4.77633820e+04]
E1 = -182.59027153014844  E_coul = 54.0489901303306
Extra cycle  E= -128.541281399818  delta_E= -1.39e-12  |g|= 1.52e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.8746026811637
E1 = -182.59027153014844  E_coul = 54.0489901303306
init E= -128.541281399818
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.848859626836257  LUMO = 0.803520537197795
  mo_energy =
[-3.27704032e+01 -1.92916352e+00 -8.48859627e-01 -8.48859627e-01
 -8.48859627e-01  8.03520537e-01  8.03520537e-01  8.03520537e-01
  1.18622742e+00  3.87431326e+00  3.87431326e+00  3.87431326e+00
  7.25825897e+00  1.41405839e+01  1.41405839e+01  1.41405839e+01
  3.41837374e+01  5.23577539e+01  5.23577539e+01  5.23577539e+01
  1.36532549e+02  2.38145549e+02  2.38145549e+02  2.38145549e+02
  4.98086077e+02  1.86486508e+03  7.99490574e+03  4.77633820e+04]
E1 = -182.5902774779056  E_coul = 54.04899607808781
cycle= 1 E= -128.541281399818  delta_E= 5.68e-14  |g|= 8.21e-07  |ddm|= 5.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5902774779056  E_coul = 54.04899607808781
  HOMO = -0.848859209602919  LUMO = 0.803520641650992
  mo_energy =
[-3.27704020e+01 -1.92916305e+00 -8.48859210e-01 -8.48859210e-01
 -8.48859210e-01  8.03520642e-01  8.03520642e-01  8.03520642e-01
  1.18622761e+00  3.87431364e+00  3.87431364e+00  3.87431364e+00
  7.25825950e+00  1.41405847e+01  1.41405847e+01  1.41405847e+01
  3.41837383e+01  5.23577550e+01  5.23577550e+01  5.23577550e+01
  1.36532551e+02  2.38145550e+02  2.38145550e+02  2.38145550e+02
  4.98086079e+02  1.86486508e+03  7.99490574e+03  4.77633820e+04]
E1 = -182.59027450199812  E_coul = 54.04899310217975
Extra cycle  E= -128.541281399818  delta_E= -5.97e-13  |g|= 4.04e-07  |ddm|= 2.89e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145467e+03 8.33264609e+02 2.35866111e+02
 7.53816542e+01 9.91951297e+00 2.65798119e+01 3.81387069e-01
 1.11502856e+00 2.87343821e+00 7.05994323e+00 2.29673602e+01
 9.88266728e+01 2.65527269e-01 2.42936833e+00 8.31020518e-01]
grad_E = [-2.33009143e-09  1.20313285e-07 -2.14711351e-06  1.76571723e-05
 -4.44578503e-05  3.76578030e-05  5.05190287e-06 -3.80024889e-06
  1.41682595e-04 -7.94539480e-06 -1.08962163e-04  8.66592863e-06
 -5.53244116e-07 -2.71225911e-05  2.96659086e-04 -3.05463527e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941277        1
[INPUT] 0    0    [1    /1   ]  3661.45460179        1
[INPUT] 0    0    [1    /1   ]  833.265776106        1
[INPUT] 0    0    [1    /1   ]  235.856431271        1
[INPUT] 0    0    [1    /1   ]  75.4075065702        1
[INPUT] 0    0    [1    /1   ]  9.90664741722        1
[INPUT] 0    0    [1    /1   ]  26.5669808077        1
[INPUT] 0    0    [1    /1   ]  0.380973769328       1
[INPUT] 0    0    [1    /1   ]  1.11188819754        1
[INPUT] 0    0    [1    /1   ]  2.85667094139        1
[INPUT] 1    0    [1    /1   ]  7.05226782487        1
[INPUT] 1    0    [1    /1   ]  22.9525034207        1
[INPUT] 1    0    [1    /1   ]  98.8783939937        1
[INPUT] 1    0    [1    /1   ]  0.265387568993       1
[INPUT] 1    0    [1    /1   ]  2.42808018528        1
[INPUT] 1    0    [1    /1   ]  0.830646788505       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412769331, 1.0]], [0, [3661.4546017943658, 1.0]], [0, [833.2657761063612, 1.0]], [0, [235.85643127075735, 1.0]], [0, [75.40750657022708, 1.0]], [0, [9.90664741722142, 1.0]], [0, [26.566980807679396, 1.0]], [0, [0.38097376932840815, 1.0]], [0, [1.1118881975447568, 1.0]], [0, [2.8566709413858753, 1.0]], [1, [7.052267824867672, 1.0]], [1, [22.95250342068794, 1.0]], [1, [98.87839399373696, 1.0]], [1, [0.26538756899330035, 1.0]], [1, [2.4280801852794247, 1.0]], [1, [0.8306467885052381, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412769]
bas 1, expnt(s) = [3661.45460179]
bas 2, expnt(s) = [833.26577611]
bas 3, expnt(s) = [235.85643127]
bas 4, expnt(s) = [75.40750657]
bas 5, expnt(s) = [9.90664742]
bas 6, expnt(s) = [26.56698081]
bas 7, expnt(s) = [0.38097377]
bas 8, expnt(s) = [1.1118882]
bas 9, expnt(s) = [2.85667094]
bas 10, expnt(s) = [7.05226782]
bas 11, expnt(s) = [22.95250342]
bas 12, expnt(s) = [98.87839399]
bas 13, expnt(s) = [0.26538757]
bas 14, expnt(s) = [2.42808019]
bas 15, expnt(s) = [0.83064679]
CPU time:       303.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145460e+03 1.18920100e+03
 8.33265776e+02 3.91834510e+02 2.35856431e+02 1.52055039e+02
 7.54075066e+01 6.46511061e+01 9.90664742e+00 1.41078247e+01
 2.65669808e+01 2.95645774e+01 3.80973769e-01 1.22514172e+00
 1.11188820e+00 2.73565209e+00 2.85667094e+00 5.55149799e+00
 7.05226782e+00 3.35270536e+01 2.29525034e+01 1.46562198e+02
 9.88783940e+01 9.09622402e+02 2.65387569e-01 5.55693239e-01
 2.42808019e+00 8.84225782e+00 8.30646789e-01 2.31342210e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999592349395533
cond(S) = 344.369786812547
E1 = -183.58954734970433  E_coul = 55.08016931241678
init E= -128.509378037288
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400696227272  LUMO = 0.820925843649193
  mo_energy =
[-3.25550508e+01 -1.85259219e+00 -7.75400696e-01 -7.75400696e-01
 -7.75400696e-01  8.20925844e-01  8.20925844e-01  8.20925844e-01
  1.21359944e+00  3.93786156e+00  3.93786156e+00  3.93786156e+00
  7.31197754e+00  1.42563410e+01  1.42563410e+01  1.42563410e+01
  3.42433382e+01  5.24982172e+01  5.24982172e+01  5.24982172e+01
  1.36605447e+02  2.38390756e+02  2.38390756e+02  2.38390756e+02
  4.98219690e+02  1.86504837e+03  7.99512582e+03  4.77636342e+04]
E1 = -182.08708654836624  E_coul = 53.54930483908943
cycle= 1 E= -128.537781709277  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509586
diis-c [-0.25967818  1.        ]
  HOMO = -0.884175679166908  LUMO = 0.79437986539893
  mo_energy =
[-3.28779157e+01 -1.96644682e+00 -8.84175679e-01 -8.84175679e-01
 -8.84175679e-01  7.94379865e-01  7.94379865e-01  7.94379865e-01
  1.16837560e+00  3.84091930e+00  3.84091930e+00  3.84091930e+00
  7.18096121e+00  1.40665598e+01  1.40665598e+01  1.40665598e+01
  3.39978209e+01  5.22181301e+01  5.22181301e+01  5.22181301e+01
  1.36288464e+02  2.38045116e+02  2.38045116e+02  2.38045116e+02
  4.97858526e+02  1.86465116e+03  7.99469963e+03  4.77631892e+04]
E1 = -182.8478074703066  E_coul = 54.30744269171382
cycle= 2 E= -128.540364778593  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258672
diis-c [-6.42696179e-04  3.35898562e-01  6.64101438e-01]
  HOMO = -0.848573874920456  LUMO = 0.803057380663842
  mo_energy =
[-3.27698825e+01 -1.92894791e+00 -8.48573875e-01 -8.48573875e-01
 -8.48573875e-01  8.03057381e-01  8.03057381e-01  8.03057381e-01
  1.18290352e+00  3.87237447e+00  3.87237447e+00  3.87237447e+00
  7.22390804e+00  1.41294577e+01  1.41294577e+01  1.41294577e+01
  3.40800938e+01  5.23118899e+01  5.23118899e+01  5.23118899e+01
  1.36394304e+02  2.38158644e+02  2.38158644e+02  2.38158644e+02
  4.97975291e+02  1.86477318e+03  7.99482409e+03  4.77633146e+04]
E1 = -182.58951484961113  E_coul = 54.04823209074503
cycle= 3 E= -128.541282758866  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116611
diis-c [-1.22510476e-07 -2.25384794e-03 -1.31119075e-04  1.00238497e+00]
  HOMO = -0.848827913046557  LUMO = 0.803021521450495
  mo_energy =
[-3.27703497e+01 -1.92914524e+00 -8.48827913e-01 -8.48827913e-01
 -8.48827913e-01  8.03021521e-01  8.03021521e-01  8.03021521e-01
  1.18282896e+00  3.87219878e+00  3.87219878e+00  3.87219878e+00
  7.22369356e+00  1.41291534e+01  1.41291534e+01  1.41291534e+01
  3.40797344e+01  5.23114782e+01  5.23114782e+01  5.23114782e+01
  1.36393836e+02  2.38158107e+02  2.38158107e+02  2.38158107e+02
  4.97974697e+02  1.86477245e+03  7.99482326e+03  4.77633137e+04]
E1 = -182.5900526618917  E_coul = 54.04876988194058
cycle= 4 E= -128.541282779951  delta_E= -2.11e-08  |g|= 7.51e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184406
diis-c [-7.89704950e-10  1.90689009e-04  4.84041202e-04 -1.58466685e-01
  1.15779196e+00]
  HOMO = -0.848867322412464  LUMO = 0.803009797064626
  mo_energy =
[-3.27704205e+01 -1.92917657e+00 -8.48867322e-01 -8.48867322e-01
 -8.48867322e-01  8.03009797e-01  8.03009797e-01  8.03009797e-01
  1.18281187e+00  3.87216190e+00  3.87216190e+00  3.87216190e+00
  7.22365209e+00  1.41290979e+01  1.41290979e+01  1.41290979e+01
  3.40796727e+01  5.23114118e+01  5.23114118e+01  5.23114118e+01
  1.36393765e+02  2.38158032e+02  2.38158032e+02  2.38158032e+02
  4.97974619e+02  1.86477237e+03  7.99482317e+03  4.77633136e+04]
E1 = -182.59019514420348  E_coul = 54.04891236370726
cycle= 5 E= -128.541282780496  delta_E= -5.45e-10  |g|= 4.42e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59019514420348  E_coul = 54.04891236370726
  HOMO = -0.848865201213089  LUMO = 0.803010424755734
  mo_energy =
[-3.27704159e+01 -1.92917373e+00 -8.48865201e-01 -8.48865201e-01
 -8.48865201e-01  8.03010425e-01  8.03010425e-01  8.03010425e-01
  1.18281329e+00  3.87216395e+00  3.87216395e+00  3.87216395e+00
  7.22365503e+00  1.41291014e+01  1.41291014e+01  1.41291014e+01
  3.40796769e+01  5.23114162e+01  5.23114162e+01  5.23114162e+01
  1.36393769e+02  2.38158036e+02  2.38158036e+02  2.38158036e+02
  4.97974623e+02  1.86477237e+03  7.99482318e+03  4.77633136e+04]
E1 = -182.59018456638165  E_coul = 54.04890178588368
Extra cycle  E= -128.541282780498  delta_E= -1.76e-12  |g|= 1.51e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145460e+03 8.33265776e+02 2.35856431e+02
 7.54075066e+01 9.90664742e+00 2.65669808e+01 3.80973769e-01
 1.11188820e+00 2.85667094e+00 7.05226782e+00 2.29525034e+01
 9.88783940e+01 2.65387569e-01 2.42808019e+00 8.30646789e-01]
E = -128.54128278049797
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941277        1
[INPUT] 0    0    [1    /1   ]  3661.45460179        1
[INPUT] 0    0    [1    /1   ]  833.265776106        1
[INPUT] 0    0    [1    /1   ]  235.856431271        1
[INPUT] 0    0    [1    /1   ]  75.4075065702        1
[INPUT] 0    0    [1    /1   ]  9.90664741722        1
[INPUT] 0    0    [1    /1   ]  26.5669808077        1
[INPUT] 0    0    [1    /1   ]  0.380973769328       1
[INPUT] 0    0    [1    /1   ]  1.11188819754        1
[INPUT] 0    0    [1    /1   ]  2.85667094139        1
[INPUT] 1    0    [1    /1   ]  7.05226782487        1
[INPUT] 1    0    [1    /1   ]  22.9525034207        1
[INPUT] 1    0    [1    /1   ]  98.8783939937        1
[INPUT] 1    0    [1    /1   ]  0.265387568993       1
[INPUT] 1    0    [1    /1   ]  2.42808018528        1
[INPUT] 1    0    [1    /1   ]  0.830646788505       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79412769331, 1.0]], [0, [3661.4546017943658, 1.0]], [0, [833.2657761063612, 1.0]], [0, [235.85643127075735, 1.0]], [0, [75.40750657022708, 1.0]], [0, [9.90664741722142, 1.0]], [0, [26.566980807679396, 1.0]], [0, [0.38097376932840815, 1.0]], [0, [1.1118881975447568, 1.0]], [0, [2.8566709413858753, 1.0]], [1, [7.052267824867672, 1.0]], [1, [22.95250342068794, 1.0]], [1, [98.87839399373696, 1.0]], [1, [0.26538756899330035, 1.0]], [1, [2.4280801852794247, 1.0]], [1, [0.8306467885052381, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412769]
bas 1, expnt(s) = [3661.45460179]
bas 2, expnt(s) = [833.26577611]
bas 3, expnt(s) = [235.85643127]
bas 4, expnt(s) = [75.40750657]
bas 5, expnt(s) = [9.90664742]
bas 6, expnt(s) = [26.56698081]
bas 7, expnt(s) = [0.38097377]
bas 8, expnt(s) = [1.1118882]
bas 9, expnt(s) = [2.85667094]
bas 10, expnt(s) = [7.05226782]
bas 11, expnt(s) = [22.95250342]
bas 12, expnt(s) = [98.87839399]
bas 13, expnt(s) = [0.26538757]
bas 14, expnt(s) = [2.42808019]
bas 15, expnt(s) = [0.83064679]
CPU time:       304.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145460e+03 1.18920100e+03
 8.33265776e+02 3.91834510e+02 2.35856431e+02 1.52055039e+02
 7.54075066e+01 6.46511061e+01 9.90664742e+00 1.41078247e+01
 2.65669808e+01 2.95645774e+01 3.80973769e-01 1.22514172e+00
 1.11188820e+00 2.73565209e+00 2.85667094e+00 5.55149799e+00
 7.05226782e+00 3.35270536e+01 2.29525034e+01 1.46562198e+02
 9.88783940e+01 9.09622402e+02 2.65387569e-01 5.55693239e-01
 2.42808019e+00 8.84225782e+00 8.30646789e-01 2.31342210e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999592349395533
cond(S) = 344.369786812547
E1 = -183.58954734970433  E_coul = 55.08016931241678
init E= -128.509378037288
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775400696227272  LUMO = 0.820925843649193
  mo_energy =
[-3.25550508e+01 -1.85259219e+00 -7.75400696e-01 -7.75400696e-01
 -7.75400696e-01  8.20925844e-01  8.20925844e-01  8.20925844e-01
  1.21359944e+00  3.93786156e+00  3.93786156e+00  3.93786156e+00
  7.31197754e+00  1.42563410e+01  1.42563410e+01  1.42563410e+01
  3.42433382e+01  5.24982172e+01  5.24982172e+01  5.24982172e+01
  1.36605447e+02  2.38390756e+02  2.38390756e+02  2.38390756e+02
  4.98219690e+02  1.86504837e+03  7.99512582e+03  4.77636342e+04]
E1 = -182.08708654836624  E_coul = 53.54930483908943
cycle= 1 E= -128.537781709277  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509586
diis-c [-0.25967818  1.        ]
  HOMO = -0.884175679166908  LUMO = 0.79437986539893
  mo_energy =
[-3.28779157e+01 -1.96644682e+00 -8.84175679e-01 -8.84175679e-01
 -8.84175679e-01  7.94379865e-01  7.94379865e-01  7.94379865e-01
  1.16837560e+00  3.84091930e+00  3.84091930e+00  3.84091930e+00
  7.18096121e+00  1.40665598e+01  1.40665598e+01  1.40665598e+01
  3.39978209e+01  5.22181301e+01  5.22181301e+01  5.22181301e+01
  1.36288464e+02  2.38045116e+02  2.38045116e+02  2.38045116e+02
  4.97858526e+02  1.86465116e+03  7.99469963e+03  4.77631892e+04]
E1 = -182.8478074703066  E_coul = 54.30744269171382
cycle= 2 E= -128.540364778593  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258672
diis-c [-6.42696179e-04  3.35898562e-01  6.64101438e-01]
  HOMO = -0.848573874920456  LUMO = 0.803057380663842
  mo_energy =
[-3.27698825e+01 -1.92894791e+00 -8.48573875e-01 -8.48573875e-01
 -8.48573875e-01  8.03057381e-01  8.03057381e-01  8.03057381e-01
  1.18290352e+00  3.87237447e+00  3.87237447e+00  3.87237447e+00
  7.22390804e+00  1.41294577e+01  1.41294577e+01  1.41294577e+01
  3.40800938e+01  5.23118899e+01  5.23118899e+01  5.23118899e+01
  1.36394304e+02  2.38158644e+02  2.38158644e+02  2.38158644e+02
  4.97975291e+02  1.86477318e+03  7.99482409e+03  4.77633146e+04]
E1 = -182.58951484961113  E_coul = 54.04823209074503
cycle= 3 E= -128.541282758866  delta_E= -0.000918  |g|= 0.0005  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116611
diis-c [-1.22510476e-07 -2.25384794e-03 -1.31119075e-04  1.00238497e+00]
  HOMO = -0.848827913046557  LUMO = 0.803021521450495
  mo_energy =
[-3.27703497e+01 -1.92914524e+00 -8.48827913e-01 -8.48827913e-01
 -8.48827913e-01  8.03021521e-01  8.03021521e-01  8.03021521e-01
  1.18282896e+00  3.87219878e+00  3.87219878e+00  3.87219878e+00
  7.22369356e+00  1.41291534e+01  1.41291534e+01  1.41291534e+01
  3.40797344e+01  5.23114782e+01  5.23114782e+01  5.23114782e+01
  1.36393836e+02  2.38158107e+02  2.38158107e+02  2.38158107e+02
  4.97974697e+02  1.86477245e+03  7.99482326e+03  4.77633137e+04]
E1 = -182.5900526618917  E_coul = 54.04876988194058
cycle= 4 E= -128.541282779951  delta_E= -2.11e-08  |g|= 7.51e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184406
diis-c [-7.89704950e-10  1.90689009e-04  4.84041202e-04 -1.58466685e-01
  1.15779196e+00]
  HOMO = -0.848867322412464  LUMO = 0.803009797064626
  mo_energy =
[-3.27704205e+01 -1.92917657e+00 -8.48867322e-01 -8.48867322e-01
 -8.48867322e-01  8.03009797e-01  8.03009797e-01  8.03009797e-01
  1.18281187e+00  3.87216190e+00  3.87216190e+00  3.87216190e+00
  7.22365209e+00  1.41290979e+01  1.41290979e+01  1.41290979e+01
  3.40796727e+01  5.23114118e+01  5.23114118e+01  5.23114118e+01
  1.36393765e+02  2.38158032e+02  2.38158032e+02  2.38158032e+02
  4.97974619e+02  1.86477237e+03  7.99482317e+03  4.77633136e+04]
E1 = -182.59019514420348  E_coul = 54.04891236370726
cycle= 5 E= -128.541282780496  delta_E= -5.45e-10  |g|= 4.42e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59019514420348  E_coul = 54.04891236370726
  HOMO = -0.848865201213089  LUMO = 0.803010424755734
  mo_energy =
[-3.27704159e+01 -1.92917373e+00 -8.48865201e-01 -8.48865201e-01
 -8.48865201e-01  8.03010425e-01  8.03010425e-01  8.03010425e-01
  1.18281329e+00  3.87216395e+00  3.87216395e+00  3.87216395e+00
  7.22365503e+00  1.41291014e+01  1.41291014e+01  1.41291014e+01
  3.40796769e+01  5.23114162e+01  5.23114162e+01  5.23114162e+01
  1.36393769e+02  2.38158036e+02  2.38158036e+02  2.38158036e+02
  4.97974623e+02  1.86477237e+03  7.99482318e+03  4.77633136e+04]
E1 = -182.59018456638165  E_coul = 54.04890178588368
Extra cycle  E= -128.541282780498  delta_E= -1.76e-12  |g|= 1.51e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.369786812547
E1 = -182.59018456638165  E_coul = 54.04890178588368
init E= -128.541282780498
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848865956151631  LUMO = 0.803010254386856
  mo_energy =
[-3.27704182e+01 -1.92917440e+00 -8.48865956e-01 -8.48865956e-01
 -8.48865956e-01  8.03010254e-01  8.03010254e-01  8.03010254e-01
  1.18281307e+00  3.87216330e+00  3.87216330e+00  3.87216330e+00
  7.22365420e+00  1.41291001e+01  1.41291001e+01  1.41291001e+01
  3.40796752e+01  5.23114142e+01  5.23114142e+01  5.23114142e+01
  1.36393767e+02  2.38158034e+02  2.38158034e+02  2.38158034e+02
  4.97974620e+02  1.86477237e+03  7.99482317e+03  4.77633136e+04]
E1 = -182.59019049300878  E_coul = 54.048907712510506
cycle= 1 E= -128.541282780498  delta_E= -3.13e-13  |g|= 8.18e-07  |ddm|= 5.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59019049300878  E_coul = 54.048907712510506
  HOMO = -0.848865540423472  LUMO = 0.803010358389253
  mo_energy =
[-3.27704170e+01 -1.92917393e+00 -8.48865540e-01 -8.48865540e-01
 -8.48865540e-01  8.03010358e-01  8.03010358e-01  8.03010358e-01
  1.18281326e+00  3.87216367e+00  3.87216367e+00  3.87216367e+00
  7.22365472e+00  1.41291008e+01  1.41291008e+01  1.41291008e+01
  3.40796761e+01  5.23114153e+01  5.23114153e+01  5.23114153e+01
  1.36393768e+02  2.38158035e+02  2.38158035e+02  2.38158035e+02
  4.97974621e+02  1.86477237e+03  7.99482318e+03  4.77633136e+04]
E1 = -182.59018752759678  E_coul = 54.04890474709846
Extra cycle  E= -128.541282780498  delta_E= -2.84e-14  |g|= 4.03e-07  |ddm|= 2.88e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145460e+03 8.33265776e+02 2.35856431e+02
 7.54075066e+01 9.90664742e+00 2.65669808e+01 3.80973769e-01
 1.11188820e+00 2.85667094e+00 7.05226782e+00 2.29525034e+01
 9.88783940e+01 2.65387569e-01 2.42808019e+00 8.30646789e-01]
grad_E = [-2.17084260e-09  1.11988059e-07 -1.99259950e-06  1.61138280e-05
 -3.69706888e-05  4.00694415e-05 -7.68286114e-06 -9.15895130e-06
  1.99167732e-04 -3.12317512e-05 -1.61164432e-04  1.30006954e-05
 -3.07065375e-07 -4.36090540e-05  4.36299511e-04 -4.45368876e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45448189        1
[INPUT] 0    0    [1    /1   ]  833.267915144        1
[INPUT] 0    0    [1    /1   ]  235.838747452        1
[INPUT] 0    0    [1    /1   ]  75.4541811798        1
[INPUT] 0    0    [1    /1   ]  9.88095668938        1
[INPUT] 0    0    [1    /1   ]  26.5445136327        1
[INPUT] 0    0    [1    /1   ]  0.379477783478       1
[INPUT] 0    0    [1    /1   ]  1.10398776572        1
[INPUT] 0    0    [1    /1   ]  2.82648550259        1
[INPUT] 1    0    [1    /1   ]  7.05097858643        1
[INPUT] 1    0    [1    /1   ]  22.9574232175        1
[INPUT] 1    0    [1    /1   ]  98.9891275642        1
[INPUT] 1    0    [1    /1   ]  0.265353399413       1
[INPUT] 1    0    [1    /1   ]  2.42821506885        1
[INPUT] 1    0    [1    /1   ]  0.830666505758       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413001394, 1.0]], [0, [3661.4544818945756, 1.0]], [0, [833.2679151443422, 1.0]], [0, [235.8387474516066, 1.0]], [0, [75.45418117980739, 1.0]], [0, [9.880956689379996, 1.0]], [0, [26.544513632697605, 1.0]], [0, [0.37947778347770084, 1.0]], [0, [1.1039877657157, 1.0]], [0, [2.8264855025874276, 1.0]], [1, [7.050978586426231, 1.0]], [1, [22.957423217461393, 1.0]], [1, [98.98912756424245, 1.0]], [1, [0.2653533994131303, 1.0]], [1, [2.4282150688472557, 1.0]], [1, [0.8306665057580804, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413001]
bas 1, expnt(s) = [3661.45448189]
bas 2, expnt(s) = [833.26791514]
bas 3, expnt(s) = [235.83874745]
bas 4, expnt(s) = [75.45418118]
bas 5, expnt(s) = [9.88095669]
bas 6, expnt(s) = [26.54451363]
bas 7, expnt(s) = [0.37947778]
bas 8, expnt(s) = [1.10398777]
bas 9, expnt(s) = [2.8264855]
bas 10, expnt(s) = [7.05097859]
bas 11, expnt(s) = [22.95742322]
bas 12, expnt(s) = [98.98912756]
bas 13, expnt(s) = [0.2653534]
bas 14, expnt(s) = [2.42821507]
bas 15, expnt(s) = [0.83066651]
CPU time:       307.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145448e+03 1.18920097e+03
 8.33267915e+02 3.91835264e+02 2.35838747e+02 1.52046488e+02
 7.54541812e+01 6.46811164e+01 9.88095669e+00 1.40803766e+01
 2.65445136e+01 2.95458238e+01 3.79477783e-01 1.22153184e+00
 1.10398777e+00 2.72106064e+00 2.82648550e+00 5.50744408e+00
 7.05097859e+00 3.35193924e+01 2.29574232e+01 1.46601468e+02
 9.89891276e+01 9.10895934e+02 2.65353399e-01 5.55603806e-01
 2.42821507e+00 8.84287182e+00 8.30666506e-01 2.31349075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594646349077
cond(S) = 341.01607233727833
E1 = -183.5895130970723  E_coul = 55.080164313315265
init E= -128.509348783757
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775400882962532  LUMO = 0.820833465065973
  mo_energy =
[-3.25550479e+01 -1.85259816e+00 -7.75400883e-01 -7.75400883e-01
 -7.75400883e-01  8.20833465e-01  8.20833465e-01  8.20833465e-01
  1.20404017e+00  3.93789118e+00  3.93789118e+00  3.93789118e+00
  7.23862903e+00  1.42557087e+01  1.42557087e+01  1.42557087e+01
  3.40386010e+01  5.25012531e+01  5.25012531e+01  5.25012531e+01
  1.36336344e+02  2.38588800e+02  2.38588800e+02  2.38588800e+02
  4.98001411e+02  1.86486543e+03  7.99496295e+03  4.77634993e+04]
E1 = -182.08698751898626  E_coul = 53.54920365962124
cycle= 1 E= -128.537783859365  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509551
diis-c [-0.25964213  1.        ]
  HOMO = -0.884183560920747  LUMO = 0.794285755812146
  mo_energy =
[-3.28779326e+01 -1.96645813e+00 -8.84183561e-01 -8.84183561e-01
 -8.84183561e-01  7.94285756e-01  7.94285756e-01  7.94285756e-01
  1.15918136e+00  3.84093858e+00  3.84093858e+00  3.84093858e+00
  7.10838611e+00  1.40659222e+01  1.40659222e+01  1.40659222e+01
  3.37932851e+01  5.22211367e+01  5.22211367e+01  5.22211367e+01
  1.36019329e+02  2.38243100e+02  2.38243100e+02  2.38243100e+02
  4.97640211e+02  1.86446819e+03  7.99453674e+03  4.77630543e+04]
E1 = -182.84774064194997  E_coul = 54.307373585892826
cycle= 2 E= -128.540367056057  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258653
diis-c [-6.41439270e-04  3.35899621e-01  6.64100379e-01]
  HOMO = -0.848580138207458  LUMO = 0.802963067132358
  mo_energy =
[-3.27698953e+01 -1.92895788e+00 -8.48580138e-01 -8.48580138e-01
 -8.48580138e-01  8.02963067e-01  8.02963067e-01  8.02963067e-01
  1.17358909e+00  3.87239620e+00  3.87239620e+00  3.87239620e+00
  7.15107189e+00  1.41288203e+01  1.41288203e+01  1.41288203e+01
  3.38754893e+01  5.23149043e+01  5.23149043e+01  5.23149043e+01
  1.36125177e+02  2.38356642e+02  2.38356642e+02  2.38356642e+02
  4.97756984e+02  1.86459022e+03  7.99466120e+03  4.77631796e+04]
E1 = -182.58942457428003  E_coul = 54.0481394304235
cycle= 3 E= -128.541285143857  delta_E= -0.000918  |g|= 0.000502  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116861
diis-c [-1.23071955e-07 -2.25537628e-03 -1.24606602e-04  1.00237998e+00]
  HOMO = -0.848835029105288  LUMO = 0.802926934655991
  mo_energy =
[-3.27703639e+01 -1.92915599e+00 -8.48835029e-01 -8.48835029e-01
 -8.48835029e-01  8.02926935e-01  8.02926935e-01  8.02926935e-01
  1.17351458e+00  3.87221974e+00  3.87221974e+00  3.87221974e+00
  7.15085757e+00  1.41285149e+01  1.41285149e+01  1.41285149e+01
  3.38751290e+01  5.23144913e+01  5.23144913e+01  5.23144913e+01
  1.36124708e+02  2.38356103e+02  2.38356103e+02  2.38356103e+02
  4.97756389e+02  1.86458949e+03  7.99466038e+03  4.77631788e+04]
E1 = -182.58996366760783  E_coul = 54.048678502489494
cycle= 4 E= -128.541285165118  delta_E= -2.13e-08  |g|= 7.52e-05  |ddm|= 0.000218
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184627
diis-c [-7.92411689e-10  1.90899510e-04  4.83013466e-04 -1.58684610e-01
  1.15801070e+00]
  HOMO = -0.848874567212534  LUMO = 0.802915167369657
  mo_energy =
[-3.27704348e+01 -1.92918741e+00 -8.48874567e-01 -8.48874567e-01
 -8.48874567e-01  8.02915167e-01  8.02915167e-01  8.02915167e-01
  1.17349754e+00  3.87218275e+00  3.87218275e+00  3.87218275e+00
  7.15081616e+00  1.41284593e+01  1.41284593e+01  1.41284593e+01
  3.38750671e+01  5.23144247e+01  5.23144247e+01  5.23144247e+01
  1.36124637e+02  2.38356028e+02  2.38356028e+02  2.38356028e+02
  4.97756310e+02  1.86458940e+03  7.99466029e+03  4.77631787e+04]
E1 = -182.59010615343172  E_coul = 54.04882098776465
cycle= 5 E= -128.541285165667  delta_E= -5.49e-10  |g|= 4.44e-06  |ddm|= 3.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59010615343172  E_coul = 54.04882098776465
  HOMO = -0.848872442896716  LUMO = 0.802915796158482
  mo_energy =
[-3.27704302e+01 -1.92918456e+00 -8.48872443e-01 -8.48872443e-01
 -8.48872443e-01  8.02915796e-01  8.02915796e-01  8.02915796e-01
  1.17349895e+00  3.87218479e+00  3.87218479e+00  3.87218479e+00
  7.15081909e+00  1.41284628e+01  1.41284628e+01  1.41284628e+01
  3.38750714e+01  5.23144292e+01  5.23144292e+01  5.23144292e+01
  1.36124641e+02  2.38356033e+02  2.38356033e+02  2.38356033e+02
  4.97756315e+02  1.86458941e+03  7.99466029e+03  4.77631787e+04]
E1 = -182.5900955650257  E_coul = 54.04881039935714
Extra cycle  E= -128.541285165669  delta_E= -1.51e-12  |g|= 1.52e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145448e+03 8.33267915e+02 2.35838747e+02
 7.54541812e+01 9.88095669e+00 2.65445136e+01 3.79477783e-01
 1.10398777e+00 2.82648550e+00 7.05097859e+00 2.29574232e+01
 9.89891276e+01 2.65353399e-01 2.42821507e+00 8.30666506e-01]
E = -128.54128516566857
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45448189        1
[INPUT] 0    0    [1    /1   ]  833.267915144        1
[INPUT] 0    0    [1    /1   ]  235.838747452        1
[INPUT] 0    0    [1    /1   ]  75.4541811798        1
[INPUT] 0    0    [1    /1   ]  9.88095668938        1
[INPUT] 0    0    [1    /1   ]  26.5445136327        1
[INPUT] 0    0    [1    /1   ]  0.379477783478       1
[INPUT] 0    0    [1    /1   ]  1.10398776572        1
[INPUT] 0    0    [1    /1   ]  2.82648550259        1
[INPUT] 1    0    [1    /1   ]  7.05097858643        1
[INPUT] 1    0    [1    /1   ]  22.9574232175        1
[INPUT] 1    0    [1    /1   ]  98.9891275642        1
[INPUT] 1    0    [1    /1   ]  0.265353399413       1
[INPUT] 1    0    [1    /1   ]  2.42821506885        1
[INPUT] 1    0    [1    /1   ]  0.830666505758       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413001394, 1.0]], [0, [3661.4544818945756, 1.0]], [0, [833.2679151443422, 1.0]], [0, [235.8387474516066, 1.0]], [0, [75.45418117980739, 1.0]], [0, [9.880956689379996, 1.0]], [0, [26.544513632697605, 1.0]], [0, [0.37947778347770084, 1.0]], [0, [1.1039877657157, 1.0]], [0, [2.8264855025874276, 1.0]], [1, [7.050978586426231, 1.0]], [1, [22.957423217461393, 1.0]], [1, [98.98912756424245, 1.0]], [1, [0.2653533994131303, 1.0]], [1, [2.4282150688472557, 1.0]], [1, [0.8306665057580804, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413001]
bas 1, expnt(s) = [3661.45448189]
bas 2, expnt(s) = [833.26791514]
bas 3, expnt(s) = [235.83874745]
bas 4, expnt(s) = [75.45418118]
bas 5, expnt(s) = [9.88095669]
bas 6, expnt(s) = [26.54451363]
bas 7, expnt(s) = [0.37947778]
bas 8, expnt(s) = [1.10398777]
bas 9, expnt(s) = [2.8264855]
bas 10, expnt(s) = [7.05097859]
bas 11, expnt(s) = [22.95742322]
bas 12, expnt(s) = [98.98912756]
bas 13, expnt(s) = [0.2653534]
bas 14, expnt(s) = [2.42821507]
bas 15, expnt(s) = [0.83066651]
CPU time:       309.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145448e+03 1.18920097e+03
 8.33267915e+02 3.91835264e+02 2.35838747e+02 1.52046488e+02
 7.54541812e+01 6.46811164e+01 9.88095669e+00 1.40803766e+01
 2.65445136e+01 2.95458238e+01 3.79477783e-01 1.22153184e+00
 1.10398777e+00 2.72106064e+00 2.82648550e+00 5.50744408e+00
 7.05097859e+00 3.35193924e+01 2.29574232e+01 1.46601468e+02
 9.89891276e+01 9.10895934e+02 2.65353399e-01 5.55603806e-01
 2.42821507e+00 8.84287182e+00 8.30666506e-01 2.31349075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594646349077
cond(S) = 341.01607233727833
E1 = -183.5895130970723  E_coul = 55.080164313315265
init E= -128.509348783757
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400882962532  LUMO = 0.820833465065973
  mo_energy =
[-3.25550479e+01 -1.85259816e+00 -7.75400883e-01 -7.75400883e-01
 -7.75400883e-01  8.20833465e-01  8.20833465e-01  8.20833465e-01
  1.20404017e+00  3.93789118e+00  3.93789118e+00  3.93789118e+00
  7.23862903e+00  1.42557087e+01  1.42557087e+01  1.42557087e+01
  3.40386010e+01  5.25012531e+01  5.25012531e+01  5.25012531e+01
  1.36336344e+02  2.38588800e+02  2.38588800e+02  2.38588800e+02
  4.98001411e+02  1.86486543e+03  7.99496295e+03  4.77634993e+04]
E1 = -182.08698751898626  E_coul = 53.54920365962124
cycle= 1 E= -128.537783859365  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509551
diis-c [-0.25964213  1.        ]
  HOMO = -0.884183560920747  LUMO = 0.794285755812146
  mo_energy =
[-3.28779326e+01 -1.96645813e+00 -8.84183561e-01 -8.84183561e-01
 -8.84183561e-01  7.94285756e-01  7.94285756e-01  7.94285756e-01
  1.15918136e+00  3.84093858e+00  3.84093858e+00  3.84093858e+00
  7.10838611e+00  1.40659222e+01  1.40659222e+01  1.40659222e+01
  3.37932851e+01  5.22211367e+01  5.22211367e+01  5.22211367e+01
  1.36019329e+02  2.38243100e+02  2.38243100e+02  2.38243100e+02
  4.97640211e+02  1.86446819e+03  7.99453674e+03  4.77630543e+04]
E1 = -182.84774064194997  E_coul = 54.307373585892826
cycle= 2 E= -128.540367056057  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258653
diis-c [-6.41439270e-04  3.35899621e-01  6.64100379e-01]
  HOMO = -0.848580138207458  LUMO = 0.802963067132358
  mo_energy =
[-3.27698953e+01 -1.92895788e+00 -8.48580138e-01 -8.48580138e-01
 -8.48580138e-01  8.02963067e-01  8.02963067e-01  8.02963067e-01
  1.17358909e+00  3.87239620e+00  3.87239620e+00  3.87239620e+00
  7.15107189e+00  1.41288203e+01  1.41288203e+01  1.41288203e+01
  3.38754893e+01  5.23149043e+01  5.23149043e+01  5.23149043e+01
  1.36125177e+02  2.38356642e+02  2.38356642e+02  2.38356642e+02
  4.97756984e+02  1.86459022e+03  7.99466120e+03  4.77631796e+04]
E1 = -182.58942457428003  E_coul = 54.0481394304235
cycle= 3 E= -128.541285143857  delta_E= -0.000918  |g|= 0.000502  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116861
diis-c [-1.23071955e-07 -2.25537628e-03 -1.24606602e-04  1.00237998e+00]
  HOMO = -0.848835029105288  LUMO = 0.802926934655991
  mo_energy =
[-3.27703639e+01 -1.92915599e+00 -8.48835029e-01 -8.48835029e-01
 -8.48835029e-01  8.02926935e-01  8.02926935e-01  8.02926935e-01
  1.17351458e+00  3.87221974e+00  3.87221974e+00  3.87221974e+00
  7.15085757e+00  1.41285149e+01  1.41285149e+01  1.41285149e+01
  3.38751290e+01  5.23144913e+01  5.23144913e+01  5.23144913e+01
  1.36124708e+02  2.38356103e+02  2.38356103e+02  2.38356103e+02
  4.97756389e+02  1.86458949e+03  7.99466038e+03  4.77631788e+04]
E1 = -182.58996366760783  E_coul = 54.048678502489494
cycle= 4 E= -128.541285165118  delta_E= -2.13e-08  |g|= 7.52e-05  |ddm|= 0.000218
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184627
diis-c [-7.92411689e-10  1.90899510e-04  4.83013466e-04 -1.58684610e-01
  1.15801070e+00]
  HOMO = -0.848874567212534  LUMO = 0.802915167369657
  mo_energy =
[-3.27704348e+01 -1.92918741e+00 -8.48874567e-01 -8.48874567e-01
 -8.48874567e-01  8.02915167e-01  8.02915167e-01  8.02915167e-01
  1.17349754e+00  3.87218275e+00  3.87218275e+00  3.87218275e+00
  7.15081616e+00  1.41284593e+01  1.41284593e+01  1.41284593e+01
  3.38750671e+01  5.23144247e+01  5.23144247e+01  5.23144247e+01
  1.36124637e+02  2.38356028e+02  2.38356028e+02  2.38356028e+02
  4.97756310e+02  1.86458940e+03  7.99466029e+03  4.77631787e+04]
E1 = -182.59010615343172  E_coul = 54.04882098776465
cycle= 5 E= -128.541285165667  delta_E= -5.49e-10  |g|= 4.44e-06  |ddm|= 3.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59010615343172  E_coul = 54.04882098776465
  HOMO = -0.848872442896716  LUMO = 0.802915796158482
  mo_energy =
[-3.27704302e+01 -1.92918456e+00 -8.48872443e-01 -8.48872443e-01
 -8.48872443e-01  8.02915796e-01  8.02915796e-01  8.02915796e-01
  1.17349895e+00  3.87218479e+00  3.87218479e+00  3.87218479e+00
  7.15081909e+00  1.41284628e+01  1.41284628e+01  1.41284628e+01
  3.38750714e+01  5.23144292e+01  5.23144292e+01  5.23144292e+01
  1.36124641e+02  2.38356033e+02  2.38356033e+02  2.38356033e+02
  4.97756315e+02  1.86458941e+03  7.99466029e+03  4.77631787e+04]
E1 = -182.5900955650257  E_coul = 54.04881039935714
Extra cycle  E= -128.541285165669  delta_E= -1.51e-12  |g|= 1.52e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 341.01607233727833
E1 = -182.5900955650257  E_coul = 54.04881039935714
init E= -128.541285165669
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848873198674222  LUMO = 0.802915625652548
  mo_energy =
[-3.27704326e+01 -1.92918522e+00 -8.48873199e-01 -8.48873199e-01
 -8.48873199e-01  8.02915626e-01  8.02915626e-01  8.02915626e-01
  1.17349873e+00  3.87218415e+00  3.87218415e+00  3.87218415e+00
  7.15081826e+00  1.41284614e+01  1.41284614e+01  1.41284614e+01
  3.38750696e+01  5.23144271e+01  5.23144271e+01  5.23144271e+01
  1.36124639e+02  2.38356030e+02  2.38356030e+02  2.38356030e+02
  4.97756312e+02  1.86458940e+03  7.99466029e+03  4.77631787e+04]
E1 = -182.5901014992371  E_coul = 54.04881633356833
cycle= 1 E= -128.541285165669  delta_E= -1.99e-13  |g|= 8.19e-07  |ddm|= 5.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5901014992371  E_coul = 54.04881633356833
  HOMO = -0.848872782430447  LUMO = 0.80291572978443
  mo_energy =
[-3.27704313e+01 -1.92918476e+00 -8.48872782e-01 -8.48872782e-01
 -8.48872782e-01  8.02915730e-01  8.02915730e-01  8.02915730e-01
  1.17349892e+00  3.87218452e+00  3.87218452e+00  3.87218452e+00
  7.15081878e+00  1.41284622e+01  1.41284622e+01  1.41284622e+01
  3.38750706e+01  5.23144282e+01  5.23144282e+01  5.23144282e+01
  1.36124640e+02  2.38356032e+02  2.38356032e+02  2.38356032e+02
  4.97756313e+02  1.86458941e+03  7.99466029e+03  4.77631787e+04]
E1 = -182.5900985301129  E_coul = 54.048813364443866
Extra cycle  E= -128.541285165669  delta_E= -2.56e-13  |g|= 4.03e-07  |ddm|= 2.88e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145448e+03 8.33267915e+02 2.35838747e+02
 7.54541812e+01 9.88095669e+00 2.65445136e+01 3.79477783e-01
 1.10398777e+00 2.82648550e+00 7.05097859e+00 2.29574232e+01
 9.89891276e+01 2.65353399e-01 2.42821507e+00 8.30666506e-01]
grad_E = [-1.90176361e-09  9.79493254e-08 -1.73299210e-06  1.35714489e-05
 -2.53195531e-05  3.29434937e-05 -2.29121969e-05 -2.20064555e-05
  2.37197083e-04 -5.52258268e-05 -1.91116282e-04  1.55016400e-05
 -8.62880242e-08 -5.74211762e-05  5.16277777e-04 -5.22836864e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941326        1
[INPUT] 0    0    [1    /1   ]  3661.45434626        1
[INPUT] 0    0    [1    /1   ]  833.270333453        1
[INPUT] 0    0    [1    /1   ]  235.818794272        1
[INPUT] 0    0    [1    /1   ]  75.5064330963        1
[INPUT] 0    0    [1    /1   ]  9.84948140627        1
[INPUT] 0    0    [1    /1   ]  26.5199238894        1
[INPUT] 0    0    [1    /1   ]  0.37689599671        1
[INPUT] 0    0    [1    /1   ]  1.09248385857        1
[INPUT] 0    0    [1    /1   ]  2.7936404904         1
[INPUT] 1    0    [1    /1   ]  7.06378727301        1
[INPUT] 1    0    [1    /1   ]  22.998522064         1
[INPUT] 1    0    [1    /1   ]  99.1263078477        1
[INPUT] 1    0    [1    /1   ]  0.265557635598       1
[INPUT] 1    0    [1    /1   ]  2.43105613789        1
[INPUT] 1    0    [1    /1   ]  0.831438929875       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794132639196, 1.0]], [0, [3661.454346263206, 1.0]], [0, [833.2703334533277, 1.0]], [0, [235.81879427227489, 1.0]], [0, [75.50643309625723, 1.0]], [0, [9.84948140626535, 1.0]], [0, [26.519923889424625, 1.0]], [0, [0.3768959967099239, 1.0]], [0, [1.092483858572637, 1.0]], [0, [2.7936404903951795, 1.0]], [1, [7.063787273010055, 1.0]], [1, [22.99852206402393, 1.0]], [1, [99.12630784771815, 1.0]], [1, [0.265557635598448, 1.0]], [1, [2.431056137890235, 1.0]], [1, [0.8314389298750228, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413264]
bas 1, expnt(s) = [3661.45434626]
bas 2, expnt(s) = [833.27033345]
bas 3, expnt(s) = [235.81879427]
bas 4, expnt(s) = [75.5064331]
bas 5, expnt(s) = [9.84948141]
bas 6, expnt(s) = [26.51992389]
bas 7, expnt(s) = [0.376896]
bas 8, expnt(s) = [1.09248386]
bas 9, expnt(s) = [2.79364049]
bas 10, expnt(s) = [7.06378727]
bas 11, expnt(s) = [22.99852206]
bas 12, expnt(s) = [99.12630785]
bas 13, expnt(s) = [0.26555764]
bas 14, expnt(s) = [2.43105614]
bas 15, expnt(s) = [0.83143893]
CPU time:       312.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145435e+03 1.18920093e+03
 8.33270333e+02 3.91836117e+02 2.35818794e+02 1.52036840e+02
 7.55064331e+01 6.47147072e+01 9.84948141e+00 1.40467240e+01
 2.65199239e+01 2.95252939e+01 3.76895997e-01 1.21529348e+00
 1.09248386e+00 2.69976707e+00 2.79364049e+00 5.45937481e+00
 7.06378727e+00 3.35955231e+01 2.29985221e+01 1.46929602e+02
 9.91263078e+01 9.12474120e+02 2.65557636e-01 5.56138401e-01
 2.43105614e+00 8.85580667e+00 8.31438930e-01 2.31618016e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999596300289088
cond(S) = 336.53973537274817
E1 = -183.58948898669752  E_coul = 55.08016346319568
init E= -128.509325523502
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401286348004  LUMO = 0.82166955403304
  mo_energy =
[-3.25550409e+01 -1.85260559e+00 -7.75401286e-01 -7.75401286e-01
 -7.75401286e-01  8.21669554e-01  8.21669554e-01  8.21669554e-01
  1.18954249e+00  3.94223473e+00  3.94223473e+00  3.94223473e+00
  7.14524837e+00  1.42774711e+01  1.42774711e+01  1.42774711e+01
  3.37927057e+01  5.26020383e+01  5.26020383e+01  5.26020383e+01
  1.36016428e+02  2.38996962e+02  2.38996962e+02  2.38996962e+02
  4.97739744e+02  1.86464490e+03  7.99476670e+03  4.77633367e+04]
E1 = -182.08699697833617  E_coul = 53.549210468247054
cycle= 1 E= -128.537786510089  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509491
diis-c [-0.25958072  1.        ]
  HOMO = -0.88418431028485  LUMO = 0.795083344897523
  mo_energy =
[-3.28779289e+01 -1.96645748e+00 -8.84184310e-01 -8.84184310e-01
 -8.84184310e-01  7.95083345e-01  7.95083345e-01  7.95083345e-01
  1.14521274e+00  3.84519057e+00  3.84519057e+00  3.84519057e+00
  7.01594060e+00  1.40875304e+01  1.40875304e+01  1.40875304e+01
  3.35476278e+01  5.23218065e+01  5.23218065e+01  5.23218065e+01
  1.35699391e+02  2.38651212e+02  2.38651212e+02  2.38651212e+02
  4.97378524e+02  1.86424766e+03  7.99434048e+03  4.77628917e+04]
E1 = -182.8477213934904  E_coul = 54.30735170110423
cycle= 2 E= -128.540369692386  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.258604
diis-c [-6.40129172e-04  3.35884864e-01  6.64115136e-01]
  HOMO = -0.848581395691232  LUMO = 0.803772137376153
  mo_energy =
[-3.27698926e+01 -1.92895855e+00 -8.48581396e-01 -8.48581396e-01
 -8.48581396e-01  8.03772137e-01  8.03772137e-01  8.03772137e-01
  1.15944796e+00  3.87667830e+00  3.87667830e+00  3.87667830e+00
  7.05831297e+00  1.41504796e+01  1.41504796e+01  1.41504796e+01
  3.36297499e+01  5.24156112e+01  5.24156112e+01  5.24156112e+01
  1.35805245e+02  2.38764764e+02  2.38764764e+02  2.38764764e+02
  4.97495300e+02  1.86436968e+03  7.99446494e+03  4.77630171e+04]
E1 = -182.58940855943277  E_coul = 54.04812084564981
cycle= 3 E= -128.541287713783  delta_E= -0.000918  |g|= 0.000505  |ddm|= 0.0231
    CPU time for cycle= 3      0.02 sec, wall time      0.06 sec
diis-norm(errvec)=0.00117413
diis-c [-1.24784018e-07 -2.25963598e-03 -1.12912315e-04  1.00237255e+00]
  HOMO = -0.848837401781283  LUMO = 0.803735580802492
  mo_energy =
[-3.27703635e+01 -1.92915738e+00 -8.48837402e-01 -8.48837402e-01
 -8.48837402e-01  8.03735581e-01  8.03735581e-01  8.03735581e-01
  1.15937377e+00  3.87650071e+00  3.87650071e+00  3.87650071e+00
  7.05809898e+00  1.41501724e+01  1.41501724e+01  1.41501724e+01
  3.36293884e+01  5.24151960e+01  5.24151960e+01  5.24151960e+01
  1.35804773e+02  2.38764223e+02  2.38764223e+02  2.38764223e+02
  4.97494702e+02  1.86436895e+03  7.99446411e+03  4.77630162e+04]
E1 = -182.58995049826507  E_coul = 54.04866276291853
cycle= 4 E= -128.541287735347  delta_E= -2.16e-08  |g|= 7.57e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.12 sec
diis-norm(errvec)=0.000185424
diis-c [-8.01862354e-10  1.92449317e-04  4.82792939e-04 -1.59553032e-01
  1.15887779e+00]
  HOMO = -0.848877160908713  LUMO = 0.803723732157534
  mo_energy =
[-3.27704347e+01 -1.92918889e+00 -8.48877161e-01 -8.48877161e-01
 -8.48877161e-01  8.03723732e-01  8.03723732e-01  8.03723732e-01
  1.15935682e+00  3.87646350e+00  3.87646350e+00  3.87646350e+00
  7.05805761e+00  1.41501165e+01  1.41501165e+01  1.41501165e+01
  3.36293263e+01  5.24151292e+01  5.24151292e+01  5.24151292e+01
  1.35804702e+02  2.38764147e+02  2.38764147e+02  2.38764147e+02
  4.97494623e+02  1.86436886e+03  7.99446402e+03  4.77630161e+04]
E1 = -182.5900933950576  E_coul = 54.048805659154596
cycle= 5 E= -128.541287735903  delta_E= -5.56e-10  |g|= 4.48e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5900933950576  E_coul = 54.048805659154596
  HOMO = -0.848875011704559  LUMO = 0.803724369773187
  mo_energy =
[-3.27704300e+01 -1.92918601e+00 -8.48875012e-01 -8.48875012e-01
 -8.48875012e-01  8.03724370e-01  8.03724370e-01  8.03724370e-01
  1.15935823e+00  3.87646557e+00  3.87646557e+00  3.87646557e+00
  7.05806056e+00  1.41501200e+01  1.41501200e+01  1.41501200e+01
  3.36293306e+01  5.24151336e+01  5.24151336e+01  5.24151336e+01
  1.35804706e+02  2.38764152e+02  2.38764152e+02  2.38764152e+02
  4.97494627e+02  1.86436887e+03  7.99446403e+03  4.77630161e+04]
E1 = -182.59008270598784  E_coul = 54.0487949700828
Extra cycle  E= -128.541287735905  delta_E= -2.02e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.28 sec
exp = [2.44137941e+04 3.66145435e+03 8.33270333e+02 2.35818794e+02
 7.55064331e+01 9.84948141e+00 2.65199239e+01 3.76895997e-01
 1.09248386e+00 2.79364049e+00 7.06378727e+00 2.29985221e+01
 9.91263078e+01 2.65557636e-01 2.43105614e+00 8.31438930e-01]
E = -128.54128773590503
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941326        1
[INPUT] 0    0    [1    /1   ]  3661.45434626        1
[INPUT] 0    0    [1    /1   ]  833.270333453        1
[INPUT] 0    0    [1    /1   ]  235.818794272        1
[INPUT] 0    0    [1    /1   ]  75.5064330963        1
[INPUT] 0    0    [1    /1   ]  9.84948140627        1
[INPUT] 0    0    [1    /1   ]  26.5199238894        1
[INPUT] 0    0    [1    /1   ]  0.37689599671        1
[INPUT] 0    0    [1    /1   ]  1.09248385857        1
[INPUT] 0    0    [1    /1   ]  2.7936404904         1
[INPUT] 1    0    [1    /1   ]  7.06378727301        1
[INPUT] 1    0    [1    /1   ]  22.998522064         1
[INPUT] 1    0    [1    /1   ]  99.1263078477        1
[INPUT] 1    0    [1    /1   ]  0.265557635598       1
[INPUT] 1    0    [1    /1   ]  2.43105613789        1
[INPUT] 1    0    [1    /1   ]  0.831438929875       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794132639196, 1.0]], [0, [3661.454346263206, 1.0]], [0, [833.2703334533277, 1.0]], [0, [235.81879427227489, 1.0]], [0, [75.50643309625723, 1.0]], [0, [9.84948140626535, 1.0]], [0, [26.519923889424625, 1.0]], [0, [0.3768959967099239, 1.0]], [0, [1.092483858572637, 1.0]], [0, [2.7936404903951795, 1.0]], [1, [7.063787273010055, 1.0]], [1, [22.99852206402393, 1.0]], [1, [99.12630784771815, 1.0]], [1, [0.265557635598448, 1.0]], [1, [2.431056137890235, 1.0]], [1, [0.8314389298750228, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413264]
bas 1, expnt(s) = [3661.45434626]
bas 2, expnt(s) = [833.27033345]
bas 3, expnt(s) = [235.81879427]
bas 4, expnt(s) = [75.5064331]
bas 5, expnt(s) = [9.84948141]
bas 6, expnt(s) = [26.51992389]
bas 7, expnt(s) = [0.376896]
bas 8, expnt(s) = [1.09248386]
bas 9, expnt(s) = [2.79364049]
bas 10, expnt(s) = [7.06378727]
bas 11, expnt(s) = [22.99852206]
bas 12, expnt(s) = [99.12630785]
bas 13, expnt(s) = [0.26555764]
bas 14, expnt(s) = [2.43105614]
bas 15, expnt(s) = [0.83143893]
CPU time:       313.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145435e+03 1.18920093e+03
 8.33270333e+02 3.91836117e+02 2.35818794e+02 1.52036840e+02
 7.55064331e+01 6.47147072e+01 9.84948141e+00 1.40467240e+01
 2.65199239e+01 2.95252939e+01 3.76895997e-01 1.21529348e+00
 1.09248386e+00 2.69976707e+00 2.79364049e+00 5.45937481e+00
 7.06378727e+00 3.35955231e+01 2.29985221e+01 1.46929602e+02
 9.91263078e+01 9.12474120e+02 2.65557636e-01 5.56138401e-01
 2.43105614e+00 8.85580667e+00 8.31438930e-01 2.31618016e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999596300289088
cond(S) = 336.53973537274817
E1 = -183.58948898669752  E_coul = 55.08016346319568
init E= -128.509325523502
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401286348004  LUMO = 0.82166955403304
  mo_energy =
[-3.25550409e+01 -1.85260559e+00 -7.75401286e-01 -7.75401286e-01
 -7.75401286e-01  8.21669554e-01  8.21669554e-01  8.21669554e-01
  1.18954249e+00  3.94223473e+00  3.94223473e+00  3.94223473e+00
  7.14524837e+00  1.42774711e+01  1.42774711e+01  1.42774711e+01
  3.37927057e+01  5.26020383e+01  5.26020383e+01  5.26020383e+01
  1.36016428e+02  2.38996962e+02  2.38996962e+02  2.38996962e+02
  4.97739744e+02  1.86464490e+03  7.99476670e+03  4.77633367e+04]
E1 = -182.08699697833617  E_coul = 53.549210468247054
cycle= 1 E= -128.537786510089  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509491
diis-c [-0.25958072  1.        ]
  HOMO = -0.88418431028485  LUMO = 0.795083344897523
  mo_energy =
[-3.28779289e+01 -1.96645748e+00 -8.84184310e-01 -8.84184310e-01
 -8.84184310e-01  7.95083345e-01  7.95083345e-01  7.95083345e-01
  1.14521274e+00  3.84519057e+00  3.84519057e+00  3.84519057e+00
  7.01594060e+00  1.40875304e+01  1.40875304e+01  1.40875304e+01
  3.35476278e+01  5.23218065e+01  5.23218065e+01  5.23218065e+01
  1.35699391e+02  2.38651212e+02  2.38651212e+02  2.38651212e+02
  4.97378524e+02  1.86424766e+03  7.99434048e+03  4.77628917e+04]
E1 = -182.8477213934904  E_coul = 54.30735170110423
cycle= 2 E= -128.540369692386  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258604
diis-c [-6.40129172e-04  3.35884864e-01  6.64115136e-01]
  HOMO = -0.848581395691232  LUMO = 0.803772137376153
  mo_energy =
[-3.27698926e+01 -1.92895855e+00 -8.48581396e-01 -8.48581396e-01
 -8.48581396e-01  8.03772137e-01  8.03772137e-01  8.03772137e-01
  1.15944796e+00  3.87667830e+00  3.87667830e+00  3.87667830e+00
  7.05831297e+00  1.41504796e+01  1.41504796e+01  1.41504796e+01
  3.36297499e+01  5.24156112e+01  5.24156112e+01  5.24156112e+01
  1.35805245e+02  2.38764764e+02  2.38764764e+02  2.38764764e+02
  4.97495300e+02  1.86436968e+03  7.99446494e+03  4.77630171e+04]
E1 = -182.58940855943277  E_coul = 54.04812084564981
cycle= 3 E= -128.541287713783  delta_E= -0.000918  |g|= 0.000505  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117413
diis-c [-1.24784018e-07 -2.25963598e-03 -1.12912315e-04  1.00237255e+00]
  HOMO = -0.848837401781283  LUMO = 0.803735580802492
  mo_energy =
[-3.27703635e+01 -1.92915738e+00 -8.48837402e-01 -8.48837402e-01
 -8.48837402e-01  8.03735581e-01  8.03735581e-01  8.03735581e-01
  1.15937377e+00  3.87650071e+00  3.87650071e+00  3.87650071e+00
  7.05809898e+00  1.41501724e+01  1.41501724e+01  1.41501724e+01
  3.36293884e+01  5.24151960e+01  5.24151960e+01  5.24151960e+01
  1.35804773e+02  2.38764223e+02  2.38764223e+02  2.38764223e+02
  4.97494702e+02  1.86436895e+03  7.99446411e+03  4.77630162e+04]
E1 = -182.58995049826507  E_coul = 54.04866276291853
cycle= 4 E= -128.541287735347  delta_E= -2.16e-08  |g|= 7.57e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185424
diis-c [-8.01862354e-10  1.92449317e-04  4.82792939e-04 -1.59553032e-01
  1.15887779e+00]
  HOMO = -0.848877160908713  LUMO = 0.803723732157534
  mo_energy =
[-3.27704347e+01 -1.92918889e+00 -8.48877161e-01 -8.48877161e-01
 -8.48877161e-01  8.03723732e-01  8.03723732e-01  8.03723732e-01
  1.15935682e+00  3.87646350e+00  3.87646350e+00  3.87646350e+00
  7.05805761e+00  1.41501165e+01  1.41501165e+01  1.41501165e+01
  3.36293263e+01  5.24151292e+01  5.24151292e+01  5.24151292e+01
  1.35804702e+02  2.38764147e+02  2.38764147e+02  2.38764147e+02
  4.97494623e+02  1.86436886e+03  7.99446402e+03  4.77630161e+04]
E1 = -182.5900933950576  E_coul = 54.048805659154596
cycle= 5 E= -128.541287735903  delta_E= -5.56e-10  |g|= 4.48e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5900933950576  E_coul = 54.048805659154596
  HOMO = -0.848875011704559  LUMO = 0.803724369773187
  mo_energy =
[-3.27704300e+01 -1.92918601e+00 -8.48875012e-01 -8.48875012e-01
 -8.48875012e-01  8.03724370e-01  8.03724370e-01  8.03724370e-01
  1.15935823e+00  3.87646557e+00  3.87646557e+00  3.87646557e+00
  7.05806056e+00  1.41501200e+01  1.41501200e+01  1.41501200e+01
  3.36293306e+01  5.24151336e+01  5.24151336e+01  5.24151336e+01
  1.35804706e+02  2.38764152e+02  2.38764152e+02  2.38764152e+02
  4.97494627e+02  1.86436887e+03  7.99446403e+03  4.77630161e+04]
E1 = -182.59008270598784  E_coul = 54.0487949700828
Extra cycle  E= -128.541287735905  delta_E= -2.02e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 336.53973537274817
E1 = -182.59008270598784  E_coul = 54.0487949700828
init E= -128.541287735905
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.848875774536481  LUMO = 0.803724197540661
  mo_energy =
[-3.27704324e+01 -1.92918668e+00 -8.48875775e-01 -8.48875775e-01
 -8.48875775e-01  8.03724198e-01  8.03724198e-01  8.03724198e-01
  1.15935802e+00  3.87646492e+00  3.87646492e+00  3.87646492e+00
  7.05805973e+00  1.41501187e+01  1.41501187e+01  1.41501187e+01
  3.36293288e+01  5.24151316e+01  5.24151316e+01  5.24151316e+01
  1.35804704e+02  2.38764149e+02  2.38764149e+02  2.38764149e+02
  4.97494625e+02  1.86436887e+03  7.99446402e+03  4.77630161e+04]
E1 = -182.5900887000403  E_coul = 54.04880096413532
cycle= 1 E= -128.541287735905  delta_E= 5.68e-14  |g|= 8.27e-07  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5900887000403  E_coul = 54.04880096413532
  HOMO = -0.848875354086274  LUMO = 0.803724302872594
  mo_energy =
[-3.27704311e+01 -1.92918621e+00 -8.48875354e-01 -8.48875354e-01
 -8.48875354e-01  8.03724303e-01  8.03724303e-01  8.03724303e-01
  1.15935820e+00  3.87646530e+00  3.87646530e+00  3.87646530e+00
  7.05806025e+00  1.41501194e+01  1.41501194e+01  1.41501194e+01
  3.36293298e+01  5.24151327e+01  5.24151327e+01  5.24151327e+01
  1.35804705e+02  2.38764151e+02  2.38764151e+02  2.38764151e+02
  4.97494626e+02  1.86436887e+03  7.99446402e+03  4.77630161e+04]
E1 = -182.59008570127324  E_coul = 54.04879796536799
Extra cycle  E= -128.541287735905  delta_E= -2.84e-13  |g|= 4.07e-07  |ddm|= 2.9e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145435e+03 8.33270333e+02 2.35818794e+02
 7.55064331e+01 9.84948141e+00 2.65199239e+01 3.76895997e-01
 1.09248386e+00 2.79364049e+00 7.06378727e+00 2.29985221e+01
 9.91263078e+01 2.65557636e-01 2.43105614e+00 8.31438930e-01]
grad_E = [-1.62019426e-09  8.32934595e-08 -1.46298658e-06  1.09869823e-05
 -1.42964251e-05  1.19081354e-05 -3.12927571e-05 -8.41519027e-06
  1.85040859e-04 -5.65554521e-05 -1.48089925e-04  1.19006540e-05
 -9.91634223e-08 -4.93167500e-05  4.01292804e-04 -4.04733333e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941338        1
[INPUT] 0    0    [1    /1   ]  3661.45428569        1
[INPUT] 0    0    [1    /1   ]  833.271411873        1
[INPUT] 0    0    [1    /1   ]  235.809943477        1
[INPUT] 0    0    [1    /1   ]  75.5290479569        1
[INPUT] 0    0    [1    /1   ]  9.83364573431        1
[INPUT] 0    0    [1    /1   ]  26.5106431252        1
[INPUT] 0    0    [1    /1   ]  0.374739783777       1
[INPUT] 0    0    [1    /1   ]  1.08442811792        1
[INPUT] 0    0    [1    /1   ]  2.77899246456        1
[INPUT] 1    0    [1    /1   ]  7.08305883793        1
[INPUT] 1    0    [1    /1   ]  23.0504504491        1
[INPUT] 1    0    [1    /1   ]  99.1930079097        1
[INPUT] 1    0    [1    /1   ]  0.265878499115       1
[INPUT] 1    0    [1    /1   ]  2.43481072032        1
[INPUT] 1    0    [1    /1   ]  0.83247681143        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133811774, 1.0]], [0, [3661.4542856949834, 1.0]], [0, [833.2714118730736, 1.0]], [0, [235.80994347709574, 1.0]], [0, [75.52904795693844, 1.0]], [0, [9.833645734313189, 1.0]], [0, [26.510643125182035, 1.0]], [0, [0.3747397837774768, 1.0]], [0, [1.0844281179185518, 1.0]], [0, [2.7789924645580806, 1.0]], [1, [7.083058837931378, 1.0]], [1, [23.050450449075157, 1.0]], [1, [99.19300790968339, 1.0]], [1, [0.26587849911507166, 1.0]], [1, [2.434810720319313, 1.0]], [1, [0.8324768114299314, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413381]
bas 1, expnt(s) = [3661.45428569]
bas 2, expnt(s) = [833.27141187]
bas 3, expnt(s) = [235.80994348]
bas 4, expnt(s) = [75.52904796]
bas 5, expnt(s) = [9.83364573]
bas 6, expnt(s) = [26.51064313]
bas 7, expnt(s) = [0.37473978]
bas 8, expnt(s) = [1.08442812]
bas 9, expnt(s) = [2.77899246]
bas 10, expnt(s) = [7.08305884]
bas 11, expnt(s) = [23.05045045]
bas 12, expnt(s) = [99.19300791]
bas 13, expnt(s) = [0.2658785]
bas 14, expnt(s) = [2.43481072]
bas 15, expnt(s) = [0.83247681]
CPU time:       316.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145429e+03 1.18920092e+03
 8.33271412e+02 3.91836498e+02 2.35809943e+02 1.52032561e+02
 7.55290480e+01 6.47292436e+01 9.83364573e+00 1.40297827e+01
 2.65106431e+01 2.95175442e+01 3.74739784e-01 1.21007524e+00
 1.08442812e+00 2.68482264e+00 2.77899246e+00 5.43789166e+00
 7.08305884e+00 3.37101321e+01 2.30504504e+01 1.47344410e+02
 9.91930079e+01 9.13241666e+02 2.65878499e-01 5.56978480e-01
 2.43481072e+00 8.87290638e+00 8.32476811e-01 2.31979482e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999596270297166
cond(S) = 333.6847950898092
E1 = -183.5894938818335  E_coul = 55.080168810502045
init E= -128.509325071331
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401515946524  LUMO = 0.822928012080673
  mo_energy =
[-3.25550339e+01 -1.85260985e+00 -7.75401516e-01 -7.75401516e-01
 -7.75401516e-01  8.22928012e-01  8.22928012e-01  8.22928012e-01
  1.17883913e+00  3.94817641e+00  3.94817641e+00  3.94817641e+00
  7.08988788e+00  1.43082916e+01  1.43082916e+01  1.43082916e+01
  3.36634775e+01  5.27390110e+01  5.27390110e+01  5.27390110e+01
  1.35855265e+02  2.39343462e+02  2.39343462e+02  2.39343462e+02
  4.97606846e+02  1.86453190e+03  7.99466625e+03  4.77632535e+04]
E1 = -182.08711174355943  E_coul = 53.54932357021568
cycle= 1 E= -128.537788173344  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509449
diis-c [-0.25953819  1.        ]
  HOMO = -0.88417744907806  LUMO = 0.796290220934306
  mo_energy =
[-3.28779058e+01 -1.96644511e+00 -8.84177449e-01 -8.84177449e-01
 -8.84177449e-01  7.96290221e-01  7.96290221e-01  7.96290221e-01
  1.13488008e+00  3.85101725e+00  3.85101725e+00  3.85101725e+00
  6.96108108e+00  1.41181417e+01  1.41181417e+01  1.41181417e+01
  3.34185124e+01  5.24586494e+01  5.24586494e+01  5.24586494e+01
  1.35538230e+02  2.38997709e+02  2.38997709e+02  2.38997709e+02
  4.97245634e+02  1.86413467e+03  7.99424005e+03  4.77628085e+04]
E1 = -182.84776783964148  E_coul = 54.30739660947485
cycle= 2 E= -128.540371230167  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0661
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258558
diis-c [-6.39634863e-04  3.35863717e-01  6.64136283e-01]
  HOMO = -0.848576699291577  LUMO = 0.804995177501391
  mo_energy =
[-3.27698747e+01 -1.92894921e+00 -8.48576699e-01 -8.48576699e-01
 -8.48576699e-01  8.04995178e-01  8.04995178e-01  8.04995178e-01
  1.14899577e+00  3.88254391e+00  3.88254391e+00  3.88254391e+00
  7.00328758e+00  1.41811621e+01  1.41811621e+01  1.41811621e+01
  3.35005953e+01  5.25524978e+01  5.25524978e+01  5.25524978e+01
  1.35644083e+02  2.39111260e+02  2.39111260e+02  2.39111260e+02
  4.97362408e+02  1.86425669e+03  7.99436450e+03  4.77629339e+04]
E1 = -182.589482826147  E_coul = 54.04819376937162
cycle= 3 E= -128.541289056775  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117904
diis-c [-1.26655113e-07 -2.26389348e-03 -1.04136189e-04  1.00236803e+00]
  HOMO = -0.848833308679828  LUMO = 0.804958335029737
  mo_energy =
[-3.27703470e+01 -1.92914814e+00 -8.48833309e-01 -8.48833309e-01
 -8.48833309e-01  8.04958335e-01  8.04958335e-01  8.04958335e-01
  1.14892204e+00  3.88236562e+00  3.88236562e+00  3.88236562e+00
  7.00307398e+00  1.41808537e+01  1.41808537e+01  1.41808537e+01
  3.35002329e+01  5.25520813e+01  5.25520813e+01  5.25520813e+01
  1.35643609e+02  2.39110717e+02  2.39110717e+02  2.39110717e+02
  4.97361808e+02  1.86425596e+03  7.99436367e+03  4.77629330e+04]
E1 = -182.59002718474184  E_coul = 54.048738106170084
cycle= 4 E= -128.541289078572  delta_E= -2.18e-08  |g|= 7.6e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018633
diis-c [-8.12870445e-10  1.94524597e-04  4.83762504e-04 -1.60601750e-01
  1.15992346e+00]
  HOMO = -0.848873242173228  LUMO = 0.804946418057947
  mo_energy =
[-3.27704186e+01 -1.92917969e+00 -8.48873242e-01 -8.48873242e-01
 -8.48873242e-01  8.04946418e-01  8.04946418e-01  8.04946418e-01
  1.14890519e+00  3.88232824e+00  3.88232824e+00  3.88232824e+00
  7.00303262e+00  1.41807976e+01  1.41807976e+01  1.41807976e+01
  3.35001706e+01  5.25520141e+01  5.25520141e+01  5.25520141e+01
  1.35643538e+02  2.39110641e+02  2.39110641e+02  2.39110641e+02
  4.97361728e+02  1.86425587e+03  7.99436358e+03  4.77629329e+04]
E1 = -182.59017066561455  E_coul = 54.04888158647794
cycle= 5 E= -128.541289079137  delta_E= -5.65e-10  |g|= 4.54e-06  |ddm|= 3.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59017066561455  E_coul = 54.04888158647794
  HOMO = -0.848871059613884  LUMO = 0.804947067442795
  mo_energy =
[-3.27704138e+01 -1.92917677e+00 -8.48871060e-01 -8.48871060e-01
 -8.48871060e-01  8.04947067e-01  8.04947067e-01  8.04947067e-01
  1.14890661e+00  3.88233034e+00  3.88233034e+00  3.88233034e+00
  7.00303561e+00  1.41808011e+01  1.41808011e+01  1.41808011e+01
  3.35001749e+01  5.25520187e+01  5.25520187e+01  5.25520187e+01
  1.35643542e+02  2.39110646e+02  2.39110646e+02  2.39110646e+02
  4.97361732e+02  1.86425587e+03  7.99436358e+03  4.77629329e+04]
E1 = -182.59015983921836  E_coul = 54.048870760079915
Extra cycle  E= -128.541289079138  delta_E= -1.82e-12  |g|= 1.55e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145429e+03 8.33271412e+02 2.35809943e+02
 7.55290480e+01 9.83364573e+00 2.65106431e+01 3.74739784e-01
 1.08442812e+00 2.77899246e+00 7.08305884e+00 2.30504504e+01
 9.91930079e+01 2.65878499e-01 2.43481072e+00 8.32476811e-01]
E = -128.54128907913844
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941338        1
[INPUT] 0    0    [1    /1   ]  3661.45428569        1
[INPUT] 0    0    [1    /1   ]  833.271411873        1
[INPUT] 0    0    [1    /1   ]  235.809943477        1
[INPUT] 0    0    [1    /1   ]  75.5290479569        1
[INPUT] 0    0    [1    /1   ]  9.83364573431        1
[INPUT] 0    0    [1    /1   ]  26.5106431252        1
[INPUT] 0    0    [1    /1   ]  0.374739783777       1
[INPUT] 0    0    [1    /1   ]  1.08442811792        1
[INPUT] 0    0    [1    /1   ]  2.77899246456        1
[INPUT] 1    0    [1    /1   ]  7.08305883793        1
[INPUT] 1    0    [1    /1   ]  23.0504504491        1
[INPUT] 1    0    [1    /1   ]  99.1930079097        1
[INPUT] 1    0    [1    /1   ]  0.265878499115       1
[INPUT] 1    0    [1    /1   ]  2.43481072032        1
[INPUT] 1    0    [1    /1   ]  0.83247681143        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133811774, 1.0]], [0, [3661.4542856949834, 1.0]], [0, [833.2714118730736, 1.0]], [0, [235.80994347709574, 1.0]], [0, [75.52904795693844, 1.0]], [0, [9.833645734313189, 1.0]], [0, [26.510643125182035, 1.0]], [0, [0.3747397837774768, 1.0]], [0, [1.0844281179185518, 1.0]], [0, [2.7789924645580806, 1.0]], [1, [7.083058837931378, 1.0]], [1, [23.050450449075157, 1.0]], [1, [99.19300790968339, 1.0]], [1, [0.26587849911507166, 1.0]], [1, [2.434810720319313, 1.0]], [1, [0.8324768114299314, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413381]
bas 1, expnt(s) = [3661.45428569]
bas 2, expnt(s) = [833.27141187]
bas 3, expnt(s) = [235.80994348]
bas 4, expnt(s) = [75.52904796]
bas 5, expnt(s) = [9.83364573]
bas 6, expnt(s) = [26.51064313]
bas 7, expnt(s) = [0.37473978]
bas 8, expnt(s) = [1.08442812]
bas 9, expnt(s) = [2.77899246]
bas 10, expnt(s) = [7.08305884]
bas 11, expnt(s) = [23.05045045]
bas 12, expnt(s) = [99.19300791]
bas 13, expnt(s) = [0.2658785]
bas 14, expnt(s) = [2.43481072]
bas 15, expnt(s) = [0.83247681]
CPU time:       317.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145429e+03 1.18920092e+03
 8.33271412e+02 3.91836498e+02 2.35809943e+02 1.52032561e+02
 7.55290480e+01 6.47292436e+01 9.83364573e+00 1.40297827e+01
 2.65106431e+01 2.95175442e+01 3.74739784e-01 1.21007524e+00
 1.08442812e+00 2.68482264e+00 2.77899246e+00 5.43789166e+00
 7.08305884e+00 3.37101321e+01 2.30504504e+01 1.47344410e+02
 9.91930079e+01 9.13241666e+02 2.65878499e-01 5.56978480e-01
 2.43481072e+00 8.87290638e+00 8.32476811e-01 2.31979482e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999596270297166
cond(S) = 333.6847950898092
E1 = -183.5894938818335  E_coul = 55.080168810502045
init E= -128.509325071331
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401515946524  LUMO = 0.822928012080673
  mo_energy =
[-3.25550339e+01 -1.85260985e+00 -7.75401516e-01 -7.75401516e-01
 -7.75401516e-01  8.22928012e-01  8.22928012e-01  8.22928012e-01
  1.17883913e+00  3.94817641e+00  3.94817641e+00  3.94817641e+00
  7.08988788e+00  1.43082916e+01  1.43082916e+01  1.43082916e+01
  3.36634775e+01  5.27390110e+01  5.27390110e+01  5.27390110e+01
  1.35855265e+02  2.39343462e+02  2.39343462e+02  2.39343462e+02
  4.97606846e+02  1.86453190e+03  7.99466625e+03  4.77632535e+04]
E1 = -182.08711174355943  E_coul = 53.54932357021568
cycle= 1 E= -128.537788173344  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509449
diis-c [-0.25953819  1.        ]
  HOMO = -0.88417744907806  LUMO = 0.796290220934306
  mo_energy =
[-3.28779058e+01 -1.96644511e+00 -8.84177449e-01 -8.84177449e-01
 -8.84177449e-01  7.96290221e-01  7.96290221e-01  7.96290221e-01
  1.13488008e+00  3.85101725e+00  3.85101725e+00  3.85101725e+00
  6.96108108e+00  1.41181417e+01  1.41181417e+01  1.41181417e+01
  3.34185124e+01  5.24586494e+01  5.24586494e+01  5.24586494e+01
  1.35538230e+02  2.38997709e+02  2.38997709e+02  2.38997709e+02
  4.97245634e+02  1.86413467e+03  7.99424005e+03  4.77628085e+04]
E1 = -182.84776783964148  E_coul = 54.30739660947485
cycle= 2 E= -128.540371230167  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0661
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258558
diis-c [-6.39634863e-04  3.35863717e-01  6.64136283e-01]
  HOMO = -0.848576699291577  LUMO = 0.804995177501391
  mo_energy =
[-3.27698747e+01 -1.92894921e+00 -8.48576699e-01 -8.48576699e-01
 -8.48576699e-01  8.04995178e-01  8.04995178e-01  8.04995178e-01
  1.14899577e+00  3.88254391e+00  3.88254391e+00  3.88254391e+00
  7.00328758e+00  1.41811621e+01  1.41811621e+01  1.41811621e+01
  3.35005953e+01  5.25524978e+01  5.25524978e+01  5.25524978e+01
  1.35644083e+02  2.39111260e+02  2.39111260e+02  2.39111260e+02
  4.97362408e+02  1.86425669e+03  7.99436450e+03  4.77629339e+04]
E1 = -182.589482826147  E_coul = 54.04819376937162
cycle= 3 E= -128.541289056775  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117904
diis-c [-1.26655113e-07 -2.26389348e-03 -1.04136189e-04  1.00236803e+00]
  HOMO = -0.848833308679828  LUMO = 0.804958335029737
  mo_energy =
[-3.27703470e+01 -1.92914814e+00 -8.48833309e-01 -8.48833309e-01
 -8.48833309e-01  8.04958335e-01  8.04958335e-01  8.04958335e-01
  1.14892204e+00  3.88236562e+00  3.88236562e+00  3.88236562e+00
  7.00307398e+00  1.41808537e+01  1.41808537e+01  1.41808537e+01
  3.35002329e+01  5.25520813e+01  5.25520813e+01  5.25520813e+01
  1.35643609e+02  2.39110717e+02  2.39110717e+02  2.39110717e+02
  4.97361808e+02  1.86425596e+03  7.99436367e+03  4.77629330e+04]
E1 = -182.59002718474184  E_coul = 54.048738106170084
cycle= 4 E= -128.541289078572  delta_E= -2.18e-08  |g|= 7.6e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018633
diis-c [-8.12870445e-10  1.94524597e-04  4.83762504e-04 -1.60601750e-01
  1.15992346e+00]
  HOMO = -0.848873242173228  LUMO = 0.804946418057947
  mo_energy =
[-3.27704186e+01 -1.92917969e+00 -8.48873242e-01 -8.48873242e-01
 -8.48873242e-01  8.04946418e-01  8.04946418e-01  8.04946418e-01
  1.14890519e+00  3.88232824e+00  3.88232824e+00  3.88232824e+00
  7.00303262e+00  1.41807976e+01  1.41807976e+01  1.41807976e+01
  3.35001706e+01  5.25520141e+01  5.25520141e+01  5.25520141e+01
  1.35643538e+02  2.39110641e+02  2.39110641e+02  2.39110641e+02
  4.97361728e+02  1.86425587e+03  7.99436358e+03  4.77629329e+04]
E1 = -182.59017066561455  E_coul = 54.04888158647794
cycle= 5 E= -128.541289079137  delta_E= -5.65e-10  |g|= 4.54e-06  |ddm|= 3.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59017066561455  E_coul = 54.04888158647794
  HOMO = -0.848871059613884  LUMO = 0.804947067442795
  mo_energy =
[-3.27704138e+01 -1.92917677e+00 -8.48871060e-01 -8.48871060e-01
 -8.48871060e-01  8.04947067e-01  8.04947067e-01  8.04947067e-01
  1.14890661e+00  3.88233034e+00  3.88233034e+00  3.88233034e+00
  7.00303561e+00  1.41808011e+01  1.41808011e+01  1.41808011e+01
  3.35001749e+01  5.25520187e+01  5.25520187e+01  5.25520187e+01
  1.35643542e+02  2.39110646e+02  2.39110646e+02  2.39110646e+02
  4.97361732e+02  1.86425587e+03  7.99436358e+03  4.77629329e+04]
E1 = -182.59015983921836  E_coul = 54.048870760079915
Extra cycle  E= -128.541289079138  delta_E= -1.82e-12  |g|= 1.55e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 333.6847950898092
E1 = -182.59015983921836  E_coul = 54.048870760079915
init E= -128.541289079138
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.848871831952763  LUMO = 0.804946892819167
  mo_energy =
[-3.27704162e+01 -1.92917745e+00 -8.48871832e-01 -8.48871832e-01
 -8.48871832e-01  8.04946893e-01  8.04946893e-01  8.04946893e-01
  1.14890640e+00  3.88232968e+00  3.88232968e+00  3.88232968e+00
  7.00303477e+00  1.41807998e+01  1.41807998e+01  1.41807998e+01
  3.35001732e+01  5.25520166e+01  5.25520166e+01  5.25520166e+01
  1.35643540e+02  2.39110643e+02  2.39110643e+02  2.39110643e+02
  4.97361730e+02  1.86425587e+03  7.99436358e+03  4.77629329e+04]
E1 = -182.59016591334628  E_coul = 54.048876834207505
cycle= 1 E= -128.541289079139  delta_E= -3.41e-13  |g|= 8.38e-07  |ddm|= 5.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59016591334628  E_coul = 54.048876834207505
  HOMO = -0.848871405852066  LUMO = 0.804946999772649
  mo_energy =
[-3.27704149e+01 -1.92917697e+00 -8.48871406e-01 -8.48871406e-01
 -8.48871406e-01  8.04947000e-01  8.04947000e-01  8.04947000e-01
  1.14890659e+00  3.88233006e+00  3.88233006e+00  3.88233006e+00
  7.00303529e+00  1.41808005e+01  1.41808005e+01  1.41808005e+01
  3.35001741e+01  5.25520177e+01  5.25520177e+01  5.25520177e+01
  1.35643541e+02  2.39110645e+02  2.39110645e+02  2.39110645e+02
  4.97361731e+02  1.86425587e+03  7.99436358e+03  4.77629329e+04]
E1 = -182.5901628748355  E_coul = 54.048873795696714
Extra cycle  E= -128.541289079139  delta_E=    0  |g|= 4.12e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145429e+03 8.33271412e+02 2.35809943e+02
 7.55290480e+01 9.83364573e+00 2.65106431e+01 3.74739784e-01
 1.08442812e+00 2.77899246e+00 7.08305884e+00 2.30504504e+01
 9.91930079e+01 2.65878499e-01 2.43481072e+00 8.32476811e-01]
grad_E = [-1.51873844e-09  7.80345003e-08 -1.36758993e-06  1.01292592e-05
 -1.14863316e-05 -5.30698379e-06 -2.73784696e-05  3.23027870e-05
  5.14970912e-05 -2.79599669e-05 -5.44831744e-05  4.16450528e-06
 -3.63112317e-07 -1.52995933e-05  1.48949177e-04 -1.53521365e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941336        1
[INPUT] 0    0    [1    /1   ]  3661.4542948         1
[INPUT] 0    0    [1    /1   ]  833.271247219        1
[INPUT] 0    0    [1    /1   ]  235.811377331        1
[INPUT] 0    0    [1    /1   ]  75.5243732929        1
[INPUT] 0    0    [1    /1   ]  9.83494470024        1
[INPUT] 0    0    [1    /1   ]  26.5149514405        1
[INPUT] 0    0    [1    /1   ]  0.374118007044       1
[INPUT] 0    0    [1    /1   ]  1.08284234786        1
[INPUT] 0    0    [1    /1   ]  2.77916374089        1
[INPUT] 1    0    [1    /1   ]  7.09232046012        1
[INPUT] 1    0    [1    /1   ]  23.073313241         1
[INPUT] 1    0    [1    /1   ]  99.192792839         1
[INPUT] 1    0    [1    /1   ]  0.26604363642        1
[INPUT] 1    0    [1    /1   ]  2.43657009162        1
[INPUT] 1    0    [1    /1   ]  0.832983897618       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133636005, 1.0]], [0, [3661.4542947967875, 1.0]], [0, [833.2712472189983, 1.0]], [0, [235.81137733102935, 1.0]], [0, [75.52437329294287, 1.0]], [0, [9.834944700243387, 1.0]], [0, [26.51495144048169, 1.0]], [0, [0.3741180070435182, 1.0]], [0, [1.0828423478579376, 1.0]], [0, [2.7791637408878898, 1.0]], [1, [7.092320460116646, 1.0]], [1, [23.073313240982838, 1.0]], [1, [99.19279283904032, 1.0]], [1, [0.26604363641998124, 1.0]], [1, [2.4365700916229946, 1.0]], [1, [0.8329838976178182, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413364]
bas 1, expnt(s) = [3661.4542948]
bas 2, expnt(s) = [833.27124722]
bas 3, expnt(s) = [235.81137733]
bas 4, expnt(s) = [75.52437329]
bas 5, expnt(s) = [9.8349447]
bas 6, expnt(s) = [26.51495144]
bas 7, expnt(s) = [0.37411801]
bas 8, expnt(s) = [1.08284235]
bas 9, expnt(s) = [2.77916374]
bas 10, expnt(s) = [7.09232046]
bas 11, expnt(s) = [23.07331324]
bas 12, expnt(s) = [99.19279284]
bas 13, expnt(s) = [0.26604364]
bas 14, expnt(s) = [2.43657009]
bas 15, expnt(s) = [0.8329839]
CPU time:       321.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145429e+03 1.18920092e+03
 8.33271247e+02 3.91836440e+02 2.35811377e+02 1.52033254e+02
 7.55243733e+01 6.47262389e+01 9.83494470e+00 1.40311726e+01
 2.65149514e+01 2.95211418e+01 3.74118007e-01 1.20856909e+00
 1.08284235e+00 2.68187757e+00 2.77916374e+00 5.43814302e+00
 7.09232046e+00 3.37652392e+01 2.30733132e+01 1.47527113e+02
 9.91927928e+01 9.13239190e+02 2.66043636e-01 5.57410938e-01
 2.43657009e+00 8.88092145e+00 8.32983898e-01 2.32156127e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595537210048
cond(S) = 333.2288289408915
E1 = -183.58950447907543  E_coul = 55.08017120759474
init E= -128.509333271481
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77540157818426  LUMO = 0.823565210028805
  mo_energy =
[-3.25550320e+01 -1.85261034e+00 -7.75401578e-01 -7.75401578e-01
 -7.75401578e-01  8.23565210e-01  8.23565210e-01  8.23565210e-01
  1.17633941e+00  3.95106225e+00  3.95106225e+00  3.95106225e+00
  7.08252437e+00  1.43230151e+01  1.43230151e+01  1.43230151e+01
  3.36584358e+01  5.28020754e+01  5.28020754e+01  5.28020754e+01
  1.35858525e+02  2.39449072e+02  2.39449072e+02  2.39449072e+02
  4.97609395e+02  1.86453310e+03  7.99466741e+03  4.77632545e+04]
E1 = -182.08718536902603  E_coul = 53.54939673940668
cycle= 1 E= -128.537788629619  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509434
diis-c [-0.25952253  1.        ]
  HOMO = -0.884172905235494  LUMO = 0.796902466479442
  mo_energy =
[-3.28778912e+01 -1.96643679e+00 -8.84172905e-01 -8.84172905e-01
 -8.84172905e-01  7.96902466e-01  7.96902466e-01  7.96902466e-01
  1.13245811e+00  3.85384987e+00  3.85384987e+00  3.85384987e+00
  6.95375341e+00  1.41327695e+01  1.41327695e+01  1.41327695e+01
  3.34134611e+01  5.25216618e+01  5.25216618e+01  5.25216618e+01
  1.35541498e+02  2.39103334e+02  2.39103334e+02  2.39103334e+02
  4.97248198e+02  1.86413588e+03  7.99424122e+03  4.77628095e+04]
E1 = -182.84779656873272  E_coul = 54.30742499497557
cycle= 2 E= -128.540371573757  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258539
diis-c [-6.39739921e-04  3.35853400e-01  6.64146600e-01]
  HOMO = -0.848573828105009  LUMO = 0.805615324638275
  mo_energy =
[-3.27698641e+01 -1.92894290e+00 -8.48573828e-01 -8.48573828e-01
 -8.48573828e-01  8.05615325e-01  8.05615325e-01  8.05615325e-01
  1.14654912e+00  3.88539437e+00  3.88539437e+00  3.88539437e+00
  6.99594870e+00  1.41958223e+01  1.41958223e+01  1.41958223e+01
  3.34955466e+01  5.26155278e+01  5.26155278e+01  5.26155278e+01
  1.35647349e+02  2.39216881e+02  2.39216881e+02  2.39216881e+02
  4.97364967e+02  1.86425790e+03  7.99436567e+03  4.77629348e+04]
E1 = -182.58953120616485  E_coul = 54.048241930638234
cycle= 3 E= -128.541289275527  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118095
diis-c [-1.27455278e-07 -2.26592447e-03 -1.01603962e-04  1.00236753e+00]
  HOMO = -0.848830590658945  LUMO = 0.805578391143975
  mo_energy =
[-3.27703368e+01 -1.92914174e+00 -8.48830591e-01 -8.48830591e-01
 -8.48830591e-01  8.05578391e-01  8.05578391e-01  8.05578391e-01
  1.14647555e+00  3.88521587e+00  3.88521587e+00  3.88521587e+00
  6.99573513e+00  1.41955137e+01  1.41955137e+01  1.41955137e+01
  3.34951839e+01  5.26151109e+01  5.26151109e+01  5.26151109e+01
  1.35646875e+02  2.39216338e+02  2.39216338e+02  2.39216338e+02
  4.97364367e+02  1.86425717e+03  7.99436484e+03  4.77629339e+04]
E1 = -182.59007649941813  E_coul = 54.04878720201257
cycle= 4 E= -128.541289297406  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186743
diis-c [-8.18079375e-10  1.95629903e-04  4.84599912e-04 -1.61111355e-01
  1.16043112e+00]
  HOMO = -0.848870584557682  LUMO = 0.805566449689261
  mo_energy =
[-3.27704085e+01 -1.92917327e+00 -8.48870585e-01 -8.48870585e-01
 -8.48870585e-01  8.05566450e-01  8.05566450e-01  8.05566450e-01
  1.14645874e+00  3.88517842e+00  3.88517842e+00  3.88517842e+00
  6.99569375e+00  1.41954574e+01  1.41954574e+01  1.41954574e+01
  3.34951215e+01  5.26150436e+01  5.26150436e+01  5.26150436e+01
  1.35646803e+02  2.39216262e+02  2.39216262e+02  2.39216262e+02
  4.97364287e+02  1.86425708e+03  7.99436474e+03  4.77629339e+04]
E1 = -182.59022027976857  E_coul = 54.04893098179457
cycle= 5 E= -128.541289297974  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59022027976857  E_coul = 54.04893098179457
  HOMO = -0.848868384793335  LUMO = 0.805567105118668
  mo_energy =
[-3.27704037e+01 -1.92917033e+00 -8.48868385e-01 -8.48868385e-01
 -8.48868385e-01  8.05567105e-01  8.05567105e-01  8.05567105e-01
  1.14646017e+00  3.88518055e+00  3.88518055e+00  3.88518055e+00
  6.99569676e+00  1.41954610e+01  1.41954610e+01  1.41954610e+01
  3.34951259e+01  5.26150482e+01  5.26150482e+01  5.26150482e+01
  1.35646808e+02  2.39216266e+02  2.39216266e+02  2.39216266e+02
  4.97364291e+02  1.86425708e+03  7.99436475e+03  4.77629339e+04]
E1 = -182.59020938568608  E_coul = 54.048920087710606
Extra cycle  E= -128.541289297975  delta_E= -1.48e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145429e+03 8.33271247e+02 2.35811377e+02
 7.55243733e+01 9.83494470e+00 2.65149514e+01 3.74118007e-01
 1.08284235e+00 2.77916374e+00 7.09232046e+00 2.30733132e+01
 9.91927928e+01 2.66043636e-01 2.43657009e+00 8.32983898e-01]
E = -128.54128929797548
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941336        1
[INPUT] 0    0    [1    /1   ]  3661.4542948         1
[INPUT] 0    0    [1    /1   ]  833.271247219        1
[INPUT] 0    0    [1    /1   ]  235.811377331        1
[INPUT] 0    0    [1    /1   ]  75.5243732929        1
[INPUT] 0    0    [1    /1   ]  9.83494470024        1
[INPUT] 0    0    [1    /1   ]  26.5149514405        1
[INPUT] 0    0    [1    /1   ]  0.374118007044       1
[INPUT] 0    0    [1    /1   ]  1.08284234786        1
[INPUT] 0    0    [1    /1   ]  2.77916374089        1
[INPUT] 1    0    [1    /1   ]  7.09232046012        1
[INPUT] 1    0    [1    /1   ]  23.073313241         1
[INPUT] 1    0    [1    /1   ]  99.192792839         1
[INPUT] 1    0    [1    /1   ]  0.26604363642        1
[INPUT] 1    0    [1    /1   ]  2.43657009162        1
[INPUT] 1    0    [1    /1   ]  0.832983897618       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133636005, 1.0]], [0, [3661.4542947967875, 1.0]], [0, [833.2712472189983, 1.0]], [0, [235.81137733102935, 1.0]], [0, [75.52437329294287, 1.0]], [0, [9.834944700243387, 1.0]], [0, [26.51495144048169, 1.0]], [0, [0.3741180070435182, 1.0]], [0, [1.0828423478579376, 1.0]], [0, [2.7791637408878898, 1.0]], [1, [7.092320460116646, 1.0]], [1, [23.073313240982838, 1.0]], [1, [99.19279283904032, 1.0]], [1, [0.26604363641998124, 1.0]], [1, [2.4365700916229946, 1.0]], [1, [0.8329838976178182, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413364]
bas 1, expnt(s) = [3661.4542948]
bas 2, expnt(s) = [833.27124722]
bas 3, expnt(s) = [235.81137733]
bas 4, expnt(s) = [75.52437329]
bas 5, expnt(s) = [9.8349447]
bas 6, expnt(s) = [26.51495144]
bas 7, expnt(s) = [0.37411801]
bas 8, expnt(s) = [1.08284235]
bas 9, expnt(s) = [2.77916374]
bas 10, expnt(s) = [7.09232046]
bas 11, expnt(s) = [23.07331324]
bas 12, expnt(s) = [99.19279284]
bas 13, expnt(s) = [0.26604364]
bas 14, expnt(s) = [2.43657009]
bas 15, expnt(s) = [0.8329839]
CPU time:       322.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145429e+03 1.18920092e+03
 8.33271247e+02 3.91836440e+02 2.35811377e+02 1.52033254e+02
 7.55243733e+01 6.47262389e+01 9.83494470e+00 1.40311726e+01
 2.65149514e+01 2.95211418e+01 3.74118007e-01 1.20856909e+00
 1.08284235e+00 2.68187757e+00 2.77916374e+00 5.43814302e+00
 7.09232046e+00 3.37652392e+01 2.30733132e+01 1.47527113e+02
 9.91927928e+01 9.13239190e+02 2.66043636e-01 5.57410938e-01
 2.43657009e+00 8.88092145e+00 8.32983898e-01 2.32156127e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595537210048
cond(S) = 333.2288289408915
E1 = -183.58950447907543  E_coul = 55.08017120759474
init E= -128.509333271481
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77540157818426  LUMO = 0.823565210028805
  mo_energy =
[-3.25550320e+01 -1.85261034e+00 -7.75401578e-01 -7.75401578e-01
 -7.75401578e-01  8.23565210e-01  8.23565210e-01  8.23565210e-01
  1.17633941e+00  3.95106225e+00  3.95106225e+00  3.95106225e+00
  7.08252437e+00  1.43230151e+01  1.43230151e+01  1.43230151e+01
  3.36584358e+01  5.28020754e+01  5.28020754e+01  5.28020754e+01
  1.35858525e+02  2.39449072e+02  2.39449072e+02  2.39449072e+02
  4.97609395e+02  1.86453310e+03  7.99466741e+03  4.77632545e+04]
E1 = -182.08718536902603  E_coul = 53.54939673940668
cycle= 1 E= -128.537788629619  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509434
diis-c [-0.25952253  1.        ]
  HOMO = -0.884172905235494  LUMO = 0.796902466479442
  mo_energy =
[-3.28778912e+01 -1.96643679e+00 -8.84172905e-01 -8.84172905e-01
 -8.84172905e-01  7.96902466e-01  7.96902466e-01  7.96902466e-01
  1.13245811e+00  3.85384987e+00  3.85384987e+00  3.85384987e+00
  6.95375341e+00  1.41327695e+01  1.41327695e+01  1.41327695e+01
  3.34134611e+01  5.25216618e+01  5.25216618e+01  5.25216618e+01
  1.35541498e+02  2.39103334e+02  2.39103334e+02  2.39103334e+02
  4.97248198e+02  1.86413588e+03  7.99424122e+03  4.77628095e+04]
E1 = -182.84779656873272  E_coul = 54.30742499497557
cycle= 2 E= -128.540371573757  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258539
diis-c [-6.39739921e-04  3.35853400e-01  6.64146600e-01]
  HOMO = -0.848573828105009  LUMO = 0.805615324638275
  mo_energy =
[-3.27698641e+01 -1.92894290e+00 -8.48573828e-01 -8.48573828e-01
 -8.48573828e-01  8.05615325e-01  8.05615325e-01  8.05615325e-01
  1.14654912e+00  3.88539437e+00  3.88539437e+00  3.88539437e+00
  6.99594870e+00  1.41958223e+01  1.41958223e+01  1.41958223e+01
  3.34955466e+01  5.26155278e+01  5.26155278e+01  5.26155278e+01
  1.35647349e+02  2.39216881e+02  2.39216881e+02  2.39216881e+02
  4.97364967e+02  1.86425790e+03  7.99436567e+03  4.77629348e+04]
E1 = -182.58953120616485  E_coul = 54.048241930638234
cycle= 3 E= -128.541289275527  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118095
diis-c [-1.27455278e-07 -2.26592447e-03 -1.01603962e-04  1.00236753e+00]
  HOMO = -0.848830590658945  LUMO = 0.805578391143975
  mo_energy =
[-3.27703368e+01 -1.92914174e+00 -8.48830591e-01 -8.48830591e-01
 -8.48830591e-01  8.05578391e-01  8.05578391e-01  8.05578391e-01
  1.14647555e+00  3.88521587e+00  3.88521587e+00  3.88521587e+00
  6.99573513e+00  1.41955137e+01  1.41955137e+01  1.41955137e+01
  3.34951839e+01  5.26151109e+01  5.26151109e+01  5.26151109e+01
  1.35646875e+02  2.39216338e+02  2.39216338e+02  2.39216338e+02
  4.97364367e+02  1.86425717e+03  7.99436484e+03  4.77629339e+04]
E1 = -182.59007649941813  E_coul = 54.04878720201257
cycle= 4 E= -128.541289297406  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186743
diis-c [-8.18079375e-10  1.95629903e-04  4.84599912e-04 -1.61111355e-01
  1.16043112e+00]
  HOMO = -0.848870584557682  LUMO = 0.805566449689261
  mo_energy =
[-3.27704085e+01 -1.92917327e+00 -8.48870585e-01 -8.48870585e-01
 -8.48870585e-01  8.05566450e-01  8.05566450e-01  8.05566450e-01
  1.14645874e+00  3.88517842e+00  3.88517842e+00  3.88517842e+00
  6.99569375e+00  1.41954574e+01  1.41954574e+01  1.41954574e+01
  3.34951215e+01  5.26150436e+01  5.26150436e+01  5.26150436e+01
  1.35646803e+02  2.39216262e+02  2.39216262e+02  2.39216262e+02
  4.97364287e+02  1.86425708e+03  7.99436474e+03  4.77629339e+04]
E1 = -182.59022027976857  E_coul = 54.04893098179457
cycle= 5 E= -128.541289297974  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59022027976857  E_coul = 54.04893098179457
  HOMO = -0.848868384793335  LUMO = 0.805567105118668
  mo_energy =
[-3.27704037e+01 -1.92917033e+00 -8.48868385e-01 -8.48868385e-01
 -8.48868385e-01  8.05567105e-01  8.05567105e-01  8.05567105e-01
  1.14646017e+00  3.88518055e+00  3.88518055e+00  3.88518055e+00
  6.99569676e+00  1.41954610e+01  1.41954610e+01  1.41954610e+01
  3.34951259e+01  5.26150482e+01  5.26150482e+01  5.26150482e+01
  1.35646808e+02  2.39216266e+02  2.39216266e+02  2.39216266e+02
  4.97364291e+02  1.86425708e+03  7.99436475e+03  4.77629339e+04]
E1 = -182.59020938568608  E_coul = 54.048920087710606
Extra cycle  E= -128.541289297975  delta_E= -1.48e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 333.2288289408915
E1 = -182.59020938568608  E_coul = 54.048920087710606
init E= -128.541289297975
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848869161759671  LUMO = 0.805566929327085
  mo_energy =
[-3.27704061e+01 -1.92917102e+00 -8.48869162e-01 -8.48869162e-01
 -8.48869162e-01  8.05566929e-01  8.05566929e-01  8.05566929e-01
  1.14645996e+00  3.88517988e+00  3.88517988e+00  3.88517988e+00
  6.99569591e+00  1.41954596e+01  1.41954596e+01  1.41954596e+01
  3.34951241e+01  5.26150461e+01  5.26150461e+01  5.26150461e+01
  1.35646805e+02  2.39216264e+02  2.39216264e+02  2.39216264e+02
  4.97364289e+02  1.86425708e+03  7.99436474e+03  4.77629339e+04]
E1 = -182.590215499429  E_coul = 54.048926201453234
cycle= 1 E= -128.541289297976  delta_E= -2.84e-13  |g|= 8.44e-07  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.590215499429  E_coul = 54.048926201453234
  HOMO = -0.848868732854513  LUMO = 0.805567037087035
  mo_energy =
[-3.27704048e+01 -1.92917053e+00 -8.48868733e-01 -8.48868733e-01
 -8.48868733e-01  8.05567037e-01  8.05567037e-01  8.05567037e-01
  1.14646015e+00  3.88518027e+00  3.88518027e+00  3.88518027e+00
  6.99569644e+00  1.41954604e+01  1.41954604e+01  1.41954604e+01
  3.34951251e+01  5.26150472e+01  5.26150472e+01  5.26150472e+01
  1.35646807e+02  2.39216265e+02  2.39216265e+02  2.39216265e+02
  4.97364290e+02  1.86425708e+03  7.99436475e+03  4.77629339e+04]
E1 = -182.590212441285  E_coul = 54.04892314330935
Extra cycle  E= -128.541289297976  delta_E= 1.14e-13  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145429e+03 8.33271247e+02 2.35811377e+02
 7.55243733e+01 9.83494470e+00 2.65149514e+01 3.74118007e-01
 1.08284235e+00 2.77916374e+00 7.09232046e+00 2.30733132e+01
 9.91927928e+01 2.66043636e-01 2.43657009e+00 8.32983898e-01]
grad_E = [-1.56375969e-09  8.03929180e-08 -1.41263230e-06  1.06089589e-05
 -1.42801752e-05 -8.70313147e-06 -2.03366999e-05  7.08124107e-06
 -1.23701533e-06 -1.25953775e-05 -5.40098249e-06  2.78433063e-07
 -5.60681302e-07  2.87457343e-06  1.46212586e-05 -1.67745544e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941335        1
[INPUT] 0    0    [1    /1   ]  3661.45430309        1
[INPUT] 0    0    [1    /1   ]  833.271098565        1
[INPUT] 0    0    [1    /1   ]  235.812628402        1
[INPUT] 0    0    [1    /1   ]  75.5208336276        1
[INPUT] 0    0    [1    /1   ]  9.83658231278        1
[INPUT] 0    0    [1    /1   ]  26.516854353         1
[INPUT] 0    0    [1    /1   ]  0.374165018081       1
[INPUT] 0    0    [1    /1   ]  1.08322669794        1
[INPUT] 0    0    [1    /1   ]  2.78095430378        1
[INPUT] 1    0    [1    /1   ]  7.09344072571        1
[INPUT] 1    0    [1    /1   ]  23.076115354         1
[INPUT] 1    0    [1    /1   ]  99.1926373462        1
[INPUT] 1    0    [1    /1   ]  0.266064574173       1
[INPUT] 1    0    [1    /1   ]  2.43680355619        1
[INPUT] 1    0    [1    /1   ]  0.833054285703       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413347564, 1.0]], [0, [3661.454303087413, 1.0]], [0, [833.2710985645779, 1.0]], [0, [235.81262840215572, 1.0]], [0, [75.52083362762646, 1.0]], [0, [9.836582312784477, 1.0]], [0, [26.516854353046377, 1.0]], [0, [0.3741650180806693, 1.0]], [0, [1.0832266979411391, 1.0]], [0, [2.780954303784312, 1.0]], [1, [7.093440725708913, 1.0]], [1, [23.076115354033174, 1.0]], [1, [99.1926373462298, 1.0]], [1, [0.26606457417324064, 1.0]], [1, [2.4368035561880945, 1.0]], [1, [0.8330542857027888, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413348]
bas 1, expnt(s) = [3661.45430309]
bas 2, expnt(s) = [833.27109856]
bas 3, expnt(s) = [235.8126284]
bas 4, expnt(s) = [75.52083363]
bas 5, expnt(s) = [9.83658231]
bas 6, expnt(s) = [26.51685435]
bas 7, expnt(s) = [0.37416502]
bas 8, expnt(s) = [1.0832267]
bas 9, expnt(s) = [2.7809543]
bas 10, expnt(s) = [7.09344073]
bas 11, expnt(s) = [23.07611535]
bas 12, expnt(s) = [99.19263735]
bas 13, expnt(s) = [0.26606457]
bas 14, expnt(s) = [2.43680356]
bas 15, expnt(s) = [0.83305429]
CPU time:       325.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145430e+03 1.18920092e+03
 8.33271099e+02 3.91836387e+02 2.35812628e+02 1.52033859e+02
 7.55208336e+01 6.47239637e+01 9.83658231e+00 1.40329248e+01
 2.65168544e+01 2.95227308e+01 3.74165018e-01 1.20868299e+00
 1.08322670e+00 2.68259148e+00 2.78095430e+00 5.44077058e+00
 7.09344073e+00 3.37719061e+01 2.30761154e+01 1.47549509e+02
 9.91926373e+01 9.13237401e+02 2.66064574e-01 5.57465774e-01
 2.43680356e+00 8.88198514e+00 8.33054286e-01 2.32180649e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595278652997
cond(S) = 333.39423366249434
E1 = -183.5895078368919  E_coul = 55.08017146608278
init E= -128.509336370809
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401577527976  LUMO = 0.82364757795923
  mo_energy =
[-3.25550322e+01 -1.85261005e+00 -7.75401578e-01 -7.75401578e-01
 -7.75401578e-01  8.23647578e-01  8.23647578e-01  8.23647578e-01
  1.17674452e+00  3.95144998e+00  3.95144998e+00  3.95144998e+00
  7.08642603e+00  1.43248859e+01  1.43248859e+01  1.43248859e+01
  3.36704780e+01  5.28098488e+01  5.28098488e+01  5.28098488e+01
  1.35875191e+02  2.39461819e+02  2.39461819e+02  2.39461819e+02
  4.97622568e+02  1.86454382e+03  7.99467692e+03  4.77632624e+04]
E1 = -182.08719840322462  E_coul = 53.54940971766644
cycle= 1 E= -128.537788685558  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50943
diis-c [-0.25951898  1.        ]
  HOMO = -0.884172020074594  LUMO = 0.79698173551313
  mo_energy =
[-3.28778888e+01 -1.96643534e+00 -8.84172020e-01 -8.84172020e-01
 -8.84172020e-01  7.96981736e-01  7.96981736e-01  7.96981736e-01
  1.13284638e+00  3.85423067e+00  3.85423067e+00  3.85423067e+00
  6.95761036e+00  1.41346291e+01  1.41346291e+01  1.41346291e+01
  3.34254905e+01  5.25294298e+01  5.25294298e+01  5.25294298e+01
  1.35558166e+02  2.39116085e+02  2.39116085e+02  2.39116085e+02
  4.97261376e+02  1.86414661e+03  7.99425074e+03  4.77628174e+04]
E1 = -182.84780169895052  E_coul = 54.30743009586115
cycle= 2 E= -128.540371603089  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258536
diis-c [-6.39823533e-04  3.35852213e-01  6.64147787e-01]
  HOMO = -0.848573280247121  LUMO = 0.805695603198703
  mo_energy =
[-3.27698625e+01 -1.92894180e+00 -8.48573280e-01 -8.48573280e-01
 -8.48573280e-01  8.05695603e-01  8.05695603e-01  8.05695603e-01
  1.14694295e+00  3.88577745e+00  3.88577745e+00  3.88577745e+00
  6.99982070e+00  1.41976857e+01  1.41976857e+01  1.41976857e+01
  3.35075802e+01  5.26232977e+01  5.26232977e+01  5.26232977e+01
  1.35664016e+02  2.39229631e+02  2.39229631e+02  2.39229631e+02
  4.97378144e+02  1.86426862e+03  7.99437519e+03  4.77629427e+04]
E1 = -182.5895399569626  E_coul = 54.048250673214596
cycle= 3 E= -128.541289283748  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118105
diis-c [-1.27495949e-07 -2.26610114e-03 -1.01580649e-04  1.00236768e+00]
  HOMO = -0.848830028859685  LUMO = 0.805658669457839
  mo_energy =
[-3.27703352e+01 -1.92914061e+00 -8.48830029e-01 -8.48830029e-01
 -8.48830029e-01  8.05658669e-01  8.05658669e-01  8.05658669e-01
  1.14686938e+00  3.88559895e+00  3.88559895e+00  3.88559895e+00
  6.99960709e+00  1.41973770e+01  1.41973770e+01  1.41973770e+01
  3.35072175e+01  5.26228807e+01  5.26228807e+01  5.26228807e+01
  1.35663542e+02  2.39229087e+02  2.39229087e+02  2.39229087e+02
  4.97377543e+02  1.86426789e+03  7.99437436e+03  4.77629418e+04]
E1 = -182.5900853292914  E_coul = 54.04879602366466
cycle= 4 E= -128.541289305627  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018677
diis-c [-8.18387133e-10  1.95726318e-04  4.84717800e-04 -1.61144886e-01
  1.16046444e+00]
  HOMO = -0.848870021860846  LUMO = 0.80564672762865
  mo_energy =
[-3.27704069e+01 -1.92917214e+00 -8.48870022e-01 -8.48870022e-01
 -8.48870022e-01  8.05646728e-01  8.05646728e-01  8.05646728e-01
  1.14685257e+00  3.88556151e+00  3.88556151e+00  3.88556151e+00
  6.99956571e+00  1.41973208e+01  1.41973208e+01  1.41973208e+01
  3.35071551e+01  5.26228135e+01  5.26228135e+01  5.26228135e+01
  1.35663470e+02  2.39229011e+02  2.39229011e+02  2.39229011e+02
  4.97377464e+02  1.86426780e+03  7.99437426e+03  4.77629417e+04]
E1 = -182.59022913976446  E_coul = 54.0489398335694
cycle= 5 E= -128.541289306195  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59022913976446  E_coul = 54.0489398335694
  HOMO = -0.84886782060706  LUMO = 0.805647383601854
  mo_energy =
[-3.27704021e+01 -1.92916920e+00 -8.48867821e-01 -8.48867821e-01
 -8.48867821e-01  8.05647384e-01  8.05647384e-01  8.05647384e-01
  1.14685400e+00  3.88556363e+00  3.88556363e+00  3.88556363e+00
  6.99956872e+00  1.41973244e+01  1.41973244e+01  1.41973244e+01
  3.35071595e+01  5.26228181e+01  5.26228181e+01  5.26228181e+01
  1.35663475e+02  2.39229016e+02  2.39229016e+02  2.39229016e+02
  4.97377468e+02  1.86426781e+03  7.99437427e+03  4.77629417e+04]
E1 = -182.59021824011444  E_coul = 54.04892893391774
Extra cycle  E= -128.541289306197  delta_E= -1.62e-12  |g|= 1.56e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145430e+03 8.33271099e+02 2.35812628e+02
 7.55208336e+01 9.83658231e+00 2.65168544e+01 3.74165018e-01
 1.08322670e+00 2.78095430e+00 7.09344073e+00 2.30761154e+01
 9.91926373e+01 2.66064574e-01 2.43680356e+00 8.33054286e-01]
E = -128.5412893061967
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941335        1
[INPUT] 0    0    [1    /1   ]  3661.45430309        1
[INPUT] 0    0    [1    /1   ]  833.271098565        1
[INPUT] 0    0    [1    /1   ]  235.812628402        1
[INPUT] 0    0    [1    /1   ]  75.5208336276        1
[INPUT] 0    0    [1    /1   ]  9.83658231278        1
[INPUT] 0    0    [1    /1   ]  26.516854353         1
[INPUT] 0    0    [1    /1   ]  0.374165018081       1
[INPUT] 0    0    [1    /1   ]  1.08322669794        1
[INPUT] 0    0    [1    /1   ]  2.78095430378        1
[INPUT] 1    0    [1    /1   ]  7.09344072571        1
[INPUT] 1    0    [1    /1   ]  23.076115354         1
[INPUT] 1    0    [1    /1   ]  99.1926373462        1
[INPUT] 1    0    [1    /1   ]  0.266064574173       1
[INPUT] 1    0    [1    /1   ]  2.43680355619        1
[INPUT] 1    0    [1    /1   ]  0.833054285703       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413347564, 1.0]], [0, [3661.454303087413, 1.0]], [0, [833.2710985645779, 1.0]], [0, [235.81262840215572, 1.0]], [0, [75.52083362762646, 1.0]], [0, [9.836582312784477, 1.0]], [0, [26.516854353046377, 1.0]], [0, [0.3741650180806693, 1.0]], [0, [1.0832266979411391, 1.0]], [0, [2.780954303784312, 1.0]], [1, [7.093440725708913, 1.0]], [1, [23.076115354033174, 1.0]], [1, [99.1926373462298, 1.0]], [1, [0.26606457417324064, 1.0]], [1, [2.4368035561880945, 1.0]], [1, [0.8330542857027888, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413348]
bas 1, expnt(s) = [3661.45430309]
bas 2, expnt(s) = [833.27109856]
bas 3, expnt(s) = [235.8126284]
bas 4, expnt(s) = [75.52083363]
bas 5, expnt(s) = [9.83658231]
bas 6, expnt(s) = [26.51685435]
bas 7, expnt(s) = [0.37416502]
bas 8, expnt(s) = [1.0832267]
bas 9, expnt(s) = [2.7809543]
bas 10, expnt(s) = [7.09344073]
bas 11, expnt(s) = [23.07611535]
bas 12, expnt(s) = [99.19263735]
bas 13, expnt(s) = [0.26606457]
bas 14, expnt(s) = [2.43680356]
bas 15, expnt(s) = [0.83305429]
CPU time:       326.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145430e+03 1.18920092e+03
 8.33271099e+02 3.91836387e+02 2.35812628e+02 1.52033859e+02
 7.55208336e+01 6.47239637e+01 9.83658231e+00 1.40329248e+01
 2.65168544e+01 2.95227308e+01 3.74165018e-01 1.20868299e+00
 1.08322670e+00 2.68259148e+00 2.78095430e+00 5.44077058e+00
 7.09344073e+00 3.37719061e+01 2.30761154e+01 1.47549509e+02
 9.91926373e+01 9.13237401e+02 2.66064574e-01 5.57465774e-01
 2.43680356e+00 8.88198514e+00 8.33054286e-01 2.32180649e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595278652997
cond(S) = 333.39423366249434
E1 = -183.5895078368919  E_coul = 55.08017146608278
init E= -128.509336370809
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401577527976  LUMO = 0.82364757795923
  mo_energy =
[-3.25550322e+01 -1.85261005e+00 -7.75401578e-01 -7.75401578e-01
 -7.75401578e-01  8.23647578e-01  8.23647578e-01  8.23647578e-01
  1.17674452e+00  3.95144998e+00  3.95144998e+00  3.95144998e+00
  7.08642603e+00  1.43248859e+01  1.43248859e+01  1.43248859e+01
  3.36704780e+01  5.28098488e+01  5.28098488e+01  5.28098488e+01
  1.35875191e+02  2.39461819e+02  2.39461819e+02  2.39461819e+02
  4.97622568e+02  1.86454382e+03  7.99467692e+03  4.77632624e+04]
E1 = -182.08719840322462  E_coul = 53.54940971766644
cycle= 1 E= -128.537788685558  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50943
diis-c [-0.25951898  1.        ]
  HOMO = -0.884172020074594  LUMO = 0.79698173551313
  mo_energy =
[-3.28778888e+01 -1.96643534e+00 -8.84172020e-01 -8.84172020e-01
 -8.84172020e-01  7.96981736e-01  7.96981736e-01  7.96981736e-01
  1.13284638e+00  3.85423067e+00  3.85423067e+00  3.85423067e+00
  6.95761036e+00  1.41346291e+01  1.41346291e+01  1.41346291e+01
  3.34254905e+01  5.25294298e+01  5.25294298e+01  5.25294298e+01
  1.35558166e+02  2.39116085e+02  2.39116085e+02  2.39116085e+02
  4.97261376e+02  1.86414661e+03  7.99425074e+03  4.77628174e+04]
E1 = -182.84780169895052  E_coul = 54.30743009586115
cycle= 2 E= -128.540371603089  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258536
diis-c [-6.39823533e-04  3.35852213e-01  6.64147787e-01]
  HOMO = -0.848573280247121  LUMO = 0.805695603198703
  mo_energy =
[-3.27698625e+01 -1.92894180e+00 -8.48573280e-01 -8.48573280e-01
 -8.48573280e-01  8.05695603e-01  8.05695603e-01  8.05695603e-01
  1.14694295e+00  3.88577745e+00  3.88577745e+00  3.88577745e+00
  6.99982070e+00  1.41976857e+01  1.41976857e+01  1.41976857e+01
  3.35075802e+01  5.26232977e+01  5.26232977e+01  5.26232977e+01
  1.35664016e+02  2.39229631e+02  2.39229631e+02  2.39229631e+02
  4.97378144e+02  1.86426862e+03  7.99437519e+03  4.77629427e+04]
E1 = -182.5895399569626  E_coul = 54.048250673214596
cycle= 3 E= -128.541289283748  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118105
diis-c [-1.27495949e-07 -2.26610114e-03 -1.01580649e-04  1.00236768e+00]
  HOMO = -0.848830028859685  LUMO = 0.805658669457839
  mo_energy =
[-3.27703352e+01 -1.92914061e+00 -8.48830029e-01 -8.48830029e-01
 -8.48830029e-01  8.05658669e-01  8.05658669e-01  8.05658669e-01
  1.14686938e+00  3.88559895e+00  3.88559895e+00  3.88559895e+00
  6.99960709e+00  1.41973770e+01  1.41973770e+01  1.41973770e+01
  3.35072175e+01  5.26228807e+01  5.26228807e+01  5.26228807e+01
  1.35663542e+02  2.39229087e+02  2.39229087e+02  2.39229087e+02
  4.97377543e+02  1.86426789e+03  7.99437436e+03  4.77629418e+04]
E1 = -182.5900853292914  E_coul = 54.04879602366466
cycle= 4 E= -128.541289305627  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018677
diis-c [-8.18387133e-10  1.95726318e-04  4.84717800e-04 -1.61144886e-01
  1.16046444e+00]
  HOMO = -0.848870021860846  LUMO = 0.80564672762865
  mo_energy =
[-3.27704069e+01 -1.92917214e+00 -8.48870022e-01 -8.48870022e-01
 -8.48870022e-01  8.05646728e-01  8.05646728e-01  8.05646728e-01
  1.14685257e+00  3.88556151e+00  3.88556151e+00  3.88556151e+00
  6.99956571e+00  1.41973208e+01  1.41973208e+01  1.41973208e+01
  3.35071551e+01  5.26228135e+01  5.26228135e+01  5.26228135e+01
  1.35663470e+02  2.39229011e+02  2.39229011e+02  2.39229011e+02
  4.97377464e+02  1.86426780e+03  7.99437426e+03  4.77629417e+04]
E1 = -182.59022913976446  E_coul = 54.0489398335694
cycle= 5 E= -128.541289306195  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59022913976446  E_coul = 54.0489398335694
  HOMO = -0.84886782060706  LUMO = 0.805647383601854
  mo_energy =
[-3.27704021e+01 -1.92916920e+00 -8.48867821e-01 -8.48867821e-01
 -8.48867821e-01  8.05647384e-01  8.05647384e-01  8.05647384e-01
  1.14685400e+00  3.88556363e+00  3.88556363e+00  3.88556363e+00
  6.99956872e+00  1.41973244e+01  1.41973244e+01  1.41973244e+01
  3.35071595e+01  5.26228181e+01  5.26228181e+01  5.26228181e+01
  1.35663475e+02  2.39229016e+02  2.39229016e+02  2.39229016e+02
  4.97377468e+02  1.86426781e+03  7.99437427e+03  4.77629417e+04]
E1 = -182.59021824011444  E_coul = 54.04892893391774
Extra cycle  E= -128.541289306197  delta_E= -1.62e-12  |g|= 1.56e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 333.39423366249434
E1 = -182.59021824011444  E_coul = 54.04892893391774
init E= -128.541289306197
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848868597944103  LUMO = 0.80564720770693
  mo_energy =
[-3.27704045e+01 -1.92916988e+00 -8.48868598e-01 -8.48868598e-01
 -8.48868598e-01  8.05647208e-01  8.05647208e-01  8.05647208e-01
  1.14685379e+00  3.88556297e+00  3.88556297e+00  3.88556297e+00
  6.99956787e+00  1.41973230e+01  1.41973230e+01  1.41973230e+01
  3.35071577e+01  5.26228160e+01  5.26228160e+01  5.26228160e+01
  1.35663473e+02  2.39229013e+02  2.39229013e+02  2.39229013e+02
  4.97377465e+02  1.86426780e+03  7.99437426e+03  4.77629417e+04]
E1 = -182.59022435708607  E_coul = 54.04893505088912
cycle= 1 E= -128.541289306197  delta_E= -2.56e-13  |g|= 8.44e-07  |ddm|= 5.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59022435708607  E_coul = 54.04893505088912
  HOMO = -0.848868168808856  LUMO = 0.805647315537879
  mo_energy =
[-3.27704032e+01 -1.92916940e+00 -8.48868169e-01 -8.48868169e-01
 -8.48868169e-01  8.05647316e-01  8.05647316e-01  8.05647316e-01
  1.14685398e+00  3.88556335e+00  3.88556335e+00  3.88556335e+00
  6.99956840e+00  1.41973238e+01  1.41973238e+01  1.41973238e+01
  3.35071587e+01  5.26228171e+01  5.26228171e+01  5.26228171e+01
  1.35663474e+02  2.39229015e+02  2.39229015e+02  2.39229015e+02
  4.97377467e+02  1.86426780e+03  7.99437427e+03  4.77629417e+04]
E1 = -182.5902212973437  E_coul = 54.048931991146596
Extra cycle  E= -128.541289306197  delta_E= -1.71e-13  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145430e+03 8.33271099e+02 2.35812628e+02
 7.55208336e+01 9.83658231e+00 2.65168544e+01 3.74165018e-01
 1.08322670e+00 2.78095430e+00 7.09344073e+00 2.30761154e+01
 9.91926373e+01 2.66064574e-01 2.43680356e+00 8.33054286e-01]
grad_E = [-1.58694803e-09  8.16028396e-08 -1.43529806e-06  1.08369850e-05
 -1.54355401e-05 -9.48501283e-06 -1.81375825e-05  4.14636371e-07
 -4.84640907e-06 -1.01312598e-05 -9.56082440e-08 -1.04563929e-07
 -5.88658816e-07  2.02075189e-07 -2.61480650e-07  6.62826871e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941334        1
[INPUT] 0    0    [1    /1   ]  3661.45430475        1
[INPUT] 0    0    [1    /1   ]  833.271068831        1
[INPUT] 0    0    [1    /1   ]  235.812879174        1
[INPUT] 0    0    [1    /1   ]  75.520116552         1
[INPUT] 0    0    [1    /1   ]  9.83695951386        1
[INPUT] 0    0    [1    /1   ]  26.5172546443        1
[INPUT] 0    0    [1    /1   ]  0.374193641505       1
[INPUT] 0    0    [1    /1   ]  1.08336134589        1
[INPUT] 0    0    [1    /1   ]  2.78133195456        1
[INPUT] 1    0    [1    /1   ]  7.09351460098        1
[INPUT] 1    0    [1    /1   ]  23.0762546152        1
[INPUT] 1    0    [1    /1   ]  99.1924290841        1
[INPUT] 1    0    [1    /1   ]  0.266065367104       1
[INPUT] 1    0    [1    /1   ]  2.43681484166        1
[INPUT] 1    0    [1    /1   ]  0.833056653787       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133443575, 1.0]], [0, [3661.4543047454695, 1.0]], [0, [833.2710688311172, 1.0]], [0, [235.8128791739989, 1.0]], [0, [75.52011655202148, 1.0]], [0, [9.83695951386201, 1.0]], [0, [26.517254644349013, 1.0]], [0, [0.37419364150461343, 1.0]], [0, [1.08336134589387, 1.0]], [0, [2.7813319545602084, 1.0]], [1, [7.093514600979443, 1.0]], [1, [23.0762546152129, 1.0]], [1, [99.19242908411894, 1.0]], [1, [0.2660653671042784, 1.0]], [1, [2.436814841660675, 1.0]], [1, [0.8330566537865638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413344]
bas 1, expnt(s) = [3661.45430475]
bas 2, expnt(s) = [833.27106883]
bas 3, expnt(s) = [235.81287917]
bas 4, expnt(s) = [75.52011655]
bas 5, expnt(s) = [9.83695951]
bas 6, expnt(s) = [26.51725464]
bas 7, expnt(s) = [0.37419364]
bas 8, expnt(s) = [1.08336135]
bas 9, expnt(s) = [2.78133195]
bas 10, expnt(s) = [7.0935146]
bas 11, expnt(s) = [23.07625462]
bas 12, expnt(s) = [99.19242908]
bas 13, expnt(s) = [0.26606537]
bas 14, expnt(s) = [2.43681484]
bas 15, expnt(s) = [0.83305665]
CPU time:       330.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145430e+03 1.18920092e+03
 8.33271069e+02 3.91836377e+02 2.35812879e+02 1.52033980e+02
 7.55201166e+01 6.47235028e+01 9.83695951e+00 1.40333284e+01
 2.65172546e+01 2.95230651e+01 3.74193642e-01 1.20875234e+00
 1.08336135e+00 2.68284157e+00 2.78133195e+00 5.44132471e+00
 7.09351460e+00 3.37723457e+01 2.30762546e+01 1.47550622e+02
 9.91924291e+01 9.13235004e+02 2.66065367e-01 5.57467851e-01
 2.43681484e+00 8.88203656e+00 8.33056654e-01 2.32181474e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595235576784
cond(S) = 333.44513146420036
E1 = -183.5895082920088  E_coul = 55.08017139816849
init E= -128.50933689384
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401581502899  LUMO = 0.823650702691162
  mo_energy =
[-3.25550323e+01 -1.85260997e+00 -7.75401582e-01 -7.75401582e-01
 -7.75401582e-01  8.23650703e-01  8.23650703e-01  8.23650703e-01
  1.17690882e+00  3.95146504e+00  3.95146504e+00  3.95146504e+00
  7.08750230e+00  1.43249882e+01  1.43249882e+01  1.43249882e+01
  3.36733850e+01  5.28102826e+01  5.28102826e+01  5.28102826e+01
  1.35879118e+02  2.39462167e+02  2.39462167e+02  2.39462167e+02
  4.97625779e+02  1.86454648e+03  7.99467928e+03  4.77632643e+04]
E1 = -182.0871999639464  E_coul = 53.54941126998279
cycle= 1 E= -128.537788693964  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509429
diis-c [-0.25951832  1.        ]
  HOMO = -0.88417189941947  LUMO = 0.796984786675511
  mo_energy =
[-3.28778885e+01 -1.96643518e+00 -8.84171899e-01 -8.84171899e-01
 -8.84171899e-01  7.96984787e-01  7.96984787e-01  7.96984787e-01
  1.13300468e+00  3.85424547e+00  3.85424547e+00  3.85424547e+00
  6.95867583e+00  1.41347308e+01  1.41347308e+01  1.41347308e+01
  3.34283948e+01  5.25298634e+01  5.25298634e+01  5.25298634e+01
  1.35562094e+02  2.39116433e+02  2.39116433e+02  2.39116433e+02
  4.97264587e+02  1.86414927e+03  7.99425310e+03  4.77628193e+04]
E1 = -182.84780220815676  E_coul = 54.30743060132103
cycle= 2 E= -128.540371606836  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258535
diis-c [-6.39840132e-04  3.35852146e-01  6.64147854e-01]
  HOMO = -0.84857321024555  LUMO = 0.80569868097343
  mo_energy =
[-3.27698624e+01 -1.92894169e+00 -8.48573210e-01 -8.48573210e-01
 -8.48573210e-01  8.05698681e-01  8.05698681e-01  8.05698681e-01
  1.14710320e+00  3.88579233e+00  3.88579233e+00  3.88579233e+00
  7.00088978e+00  1.41977876e+01  1.41977876e+01  1.41977876e+01
  3.35104853e+01  5.26237313e+01  5.26237313e+01  5.26237313e+01
  1.35667943e+02  2.39229979e+02  2.39229979e+02  2.39229979e+02
  4.97381355e+02  1.86427129e+03  7.99437755e+03  4.77629447e+04]
E1 = -182.58954092265185  E_coul = 54.0482516377301
cycle= 3 E= -128.541289284922  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118104
diis-c [-1.27485573e-07 -2.26610247e-03 -1.01618361e-04  1.00236772e+00]
  HOMO = -0.848829954579121  LUMO = 0.805661748492134
  mo_energy =
[-3.27703351e+01 -1.92914049e+00 -8.48829955e-01 -8.48829955e-01
 -8.48829955e-01  8.05661748e-01  8.05661748e-01  8.05661748e-01
  1.14702963e+00  3.88561383e+00  3.88561383e+00  3.88561383e+00
  7.00067616e+00  1.41974790e+01  1.41974790e+01  1.41974790e+01
  3.35101226e+01  5.26233144e+01  5.26233144e+01  5.26233144e+01
  1.35667469e+02  2.39229436e+02  2.39229436e+02  2.39229436e+02
  4.97380755e+02  1.86427055e+03  7.99437672e+03  4.77629438e+04]
E1 = -182.59008629766095  E_coul = 54.04879699086203
cycle= 4 E= -128.541289306799  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186767
diis-c [-8.18331735e-10  1.95721187e-04  4.84721145e-04 -1.61139577e-01
  1.16045913e+00]
  HOMO = -0.848869946111753  LUMO = 0.805649807105371
  mo_energy =
[-3.27704067e+01 -1.92917202e+00 -8.48869946e-01 -8.48869946e-01
 -8.48869946e-01  8.05649807e-01  8.05649807e-01  8.05649807e-01
  1.14701281e+00  3.88557638e+00  3.88557638e+00  3.88557638e+00
  7.00063477e+00  1.41974227e+01  1.41974227e+01  1.41974227e+01
  3.35100602e+01  5.26232472e+01  5.26232472e+01  5.26232472e+01
  1.35667398e+02  2.39229360e+02  2.39229360e+02  2.39229360e+02
  4.97380675e+02  1.86427047e+03  7.99437663e+03  4.77629437e+04]
E1 = -182.59023010764446  E_coul = 54.048940800276974
cycle= 5 E= -128.541289307367  delta_E= -5.69e-10  |g|= 4.57e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59023010764446  E_coul = 54.048940800276974
  HOMO = -0.84886774495443  LUMO = 0.805650463050741
  mo_energy =
[-3.27704019e+01 -1.92916908e+00 -8.48867745e-01 -8.48867745e-01
 -8.48867745e-01  8.05650463e-01  8.05650463e-01  8.05650463e-01
  1.14701424e+00  3.88557851e+00  3.88557851e+00  3.88557851e+00
  7.00063778e+00  1.41974263e+01  1.41974263e+01  1.41974263e+01
  3.35100646e+01  5.26232517e+01  5.26232517e+01  5.26232517e+01
  1.35667402e+02  2.39229364e+02  2.39229364e+02  2.39229364e+02
  4.97380679e+02  1.86427047e+03  7.99437663e+03  4.77629437e+04]
E1 = -182.59021920850142  E_coul = 54.04892990113213
Extra cycle  E= -128.541289307369  delta_E= -1.82e-12  |g|= 1.56e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145430e+03 8.33271069e+02 2.35812879e+02
 7.55201166e+01 9.83695951e+00 2.65172546e+01 3.74193642e-01
 1.08336135e+00 2.78133195e+00 7.09351460e+00 2.30762546e+01
 9.91924291e+01 2.66065367e-01 2.43681484e+00 8.33056654e-01]
E = -128.5412893073693
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941334        1
[INPUT] 0    0    [1    /1   ]  3661.45430475        1
[INPUT] 0    0    [1    /1   ]  833.271068831        1
[INPUT] 0    0    [1    /1   ]  235.812879174        1
[INPUT] 0    0    [1    /1   ]  75.520116552         1
[INPUT] 0    0    [1    /1   ]  9.83695951386        1
[INPUT] 0    0    [1    /1   ]  26.5172546443        1
[INPUT] 0    0    [1    /1   ]  0.374193641505       1
[INPUT] 0    0    [1    /1   ]  1.08336134589        1
[INPUT] 0    0    [1    /1   ]  2.78133195456        1
[INPUT] 1    0    [1    /1   ]  7.09351460098        1
[INPUT] 1    0    [1    /1   ]  23.0762546152        1
[INPUT] 1    0    [1    /1   ]  99.1924290841        1
[INPUT] 1    0    [1    /1   ]  0.266065367104       1
[INPUT] 1    0    [1    /1   ]  2.43681484166        1
[INPUT] 1    0    [1    /1   ]  0.833056653787       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133443575, 1.0]], [0, [3661.4543047454695, 1.0]], [0, [833.2710688311172, 1.0]], [0, [235.8128791739989, 1.0]], [0, [75.52011655202148, 1.0]], [0, [9.83695951386201, 1.0]], [0, [26.517254644349013, 1.0]], [0, [0.37419364150461343, 1.0]], [0, [1.08336134589387, 1.0]], [0, [2.7813319545602084, 1.0]], [1, [7.093514600979443, 1.0]], [1, [23.0762546152129, 1.0]], [1, [99.19242908411894, 1.0]], [1, [0.2660653671042784, 1.0]], [1, [2.436814841660675, 1.0]], [1, [0.8330566537865638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413344]
bas 1, expnt(s) = [3661.45430475]
bas 2, expnt(s) = [833.27106883]
bas 3, expnt(s) = [235.81287917]
bas 4, expnt(s) = [75.52011655]
bas 5, expnt(s) = [9.83695951]
bas 6, expnt(s) = [26.51725464]
bas 7, expnt(s) = [0.37419364]
bas 8, expnt(s) = [1.08336135]
bas 9, expnt(s) = [2.78133195]
bas 10, expnt(s) = [7.0935146]
bas 11, expnt(s) = [23.07625462]
bas 12, expnt(s) = [99.19242908]
bas 13, expnt(s) = [0.26606537]
bas 14, expnt(s) = [2.43681484]
bas 15, expnt(s) = [0.83305665]
CPU time:       331.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145430e+03 1.18920092e+03
 8.33271069e+02 3.91836377e+02 2.35812879e+02 1.52033980e+02
 7.55201166e+01 6.47235028e+01 9.83695951e+00 1.40333284e+01
 2.65172546e+01 2.95230651e+01 3.74193642e-01 1.20875234e+00
 1.08336135e+00 2.68284157e+00 2.78133195e+00 5.44132471e+00
 7.09351460e+00 3.37723457e+01 2.30762546e+01 1.47550622e+02
 9.91924291e+01 9.13235004e+02 2.66065367e-01 5.57467851e-01
 2.43681484e+00 8.88203656e+00 8.33056654e-01 2.32181474e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595235576784
cond(S) = 333.44513146420036
E1 = -183.5895082920088  E_coul = 55.08017139816849
init E= -128.50933689384
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401581502899  LUMO = 0.823650702691162
  mo_energy =
[-3.25550323e+01 -1.85260997e+00 -7.75401582e-01 -7.75401582e-01
 -7.75401582e-01  8.23650703e-01  8.23650703e-01  8.23650703e-01
  1.17690882e+00  3.95146504e+00  3.95146504e+00  3.95146504e+00
  7.08750230e+00  1.43249882e+01  1.43249882e+01  1.43249882e+01
  3.36733850e+01  5.28102826e+01  5.28102826e+01  5.28102826e+01
  1.35879118e+02  2.39462167e+02  2.39462167e+02  2.39462167e+02
  4.97625779e+02  1.86454648e+03  7.99467928e+03  4.77632643e+04]
E1 = -182.0871999639464  E_coul = 53.54941126998279
cycle= 1 E= -128.537788693964  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509429
diis-c [-0.25951832  1.        ]
  HOMO = -0.88417189941947  LUMO = 0.796984786675511
  mo_energy =
[-3.28778885e+01 -1.96643518e+00 -8.84171899e-01 -8.84171899e-01
 -8.84171899e-01  7.96984787e-01  7.96984787e-01  7.96984787e-01
  1.13300468e+00  3.85424547e+00  3.85424547e+00  3.85424547e+00
  6.95867583e+00  1.41347308e+01  1.41347308e+01  1.41347308e+01
  3.34283948e+01  5.25298634e+01  5.25298634e+01  5.25298634e+01
  1.35562094e+02  2.39116433e+02  2.39116433e+02  2.39116433e+02
  4.97264587e+02  1.86414927e+03  7.99425310e+03  4.77628193e+04]
E1 = -182.84780220815676  E_coul = 54.30743060132103
cycle= 2 E= -128.540371606836  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258535
diis-c [-6.39840132e-04  3.35852146e-01  6.64147854e-01]
  HOMO = -0.84857321024555  LUMO = 0.80569868097343
  mo_energy =
[-3.27698624e+01 -1.92894169e+00 -8.48573210e-01 -8.48573210e-01
 -8.48573210e-01  8.05698681e-01  8.05698681e-01  8.05698681e-01
  1.14710320e+00  3.88579233e+00  3.88579233e+00  3.88579233e+00
  7.00088978e+00  1.41977876e+01  1.41977876e+01  1.41977876e+01
  3.35104853e+01  5.26237313e+01  5.26237313e+01  5.26237313e+01
  1.35667943e+02  2.39229979e+02  2.39229979e+02  2.39229979e+02
  4.97381355e+02  1.86427129e+03  7.99437755e+03  4.77629447e+04]
E1 = -182.58954092265185  E_coul = 54.0482516377301
cycle= 3 E= -128.541289284922  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118104
diis-c [-1.27485573e-07 -2.26610247e-03 -1.01618361e-04  1.00236772e+00]
  HOMO = -0.848829954579121  LUMO = 0.805661748492134
  mo_energy =
[-3.27703351e+01 -1.92914049e+00 -8.48829955e-01 -8.48829955e-01
 -8.48829955e-01  8.05661748e-01  8.05661748e-01  8.05661748e-01
  1.14702963e+00  3.88561383e+00  3.88561383e+00  3.88561383e+00
  7.00067616e+00  1.41974790e+01  1.41974790e+01  1.41974790e+01
  3.35101226e+01  5.26233144e+01  5.26233144e+01  5.26233144e+01
  1.35667469e+02  2.39229436e+02  2.39229436e+02  2.39229436e+02
  4.97380755e+02  1.86427055e+03  7.99437672e+03  4.77629438e+04]
E1 = -182.59008629766095  E_coul = 54.04879699086203
cycle= 4 E= -128.541289306799  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186767
diis-c [-8.18331735e-10  1.95721187e-04  4.84721145e-04 -1.61139577e-01
  1.16045913e+00]
  HOMO = -0.848869946111753  LUMO = 0.805649807105371
  mo_energy =
[-3.27704067e+01 -1.92917202e+00 -8.48869946e-01 -8.48869946e-01
 -8.48869946e-01  8.05649807e-01  8.05649807e-01  8.05649807e-01
  1.14701281e+00  3.88557638e+00  3.88557638e+00  3.88557638e+00
  7.00063477e+00  1.41974227e+01  1.41974227e+01  1.41974227e+01
  3.35100602e+01  5.26232472e+01  5.26232472e+01  5.26232472e+01
  1.35667398e+02  2.39229360e+02  2.39229360e+02  2.39229360e+02
  4.97380675e+02  1.86427047e+03  7.99437663e+03  4.77629437e+04]
E1 = -182.59023010764446  E_coul = 54.048940800276974
cycle= 5 E= -128.541289307367  delta_E= -5.69e-10  |g|= 4.57e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59023010764446  E_coul = 54.048940800276974
  HOMO = -0.84886774495443  LUMO = 0.805650463050741
  mo_energy =
[-3.27704019e+01 -1.92916908e+00 -8.48867745e-01 -8.48867745e-01
 -8.48867745e-01  8.05650463e-01  8.05650463e-01  8.05650463e-01
  1.14701424e+00  3.88557851e+00  3.88557851e+00  3.88557851e+00
  7.00063778e+00  1.41974263e+01  1.41974263e+01  1.41974263e+01
  3.35100646e+01  5.26232517e+01  5.26232517e+01  5.26232517e+01
  1.35667402e+02  2.39229364e+02  2.39229364e+02  2.39229364e+02
  4.97380679e+02  1.86427047e+03  7.99437663e+03  4.77629437e+04]
E1 = -182.59021920850142  E_coul = 54.04892990113213
Extra cycle  E= -128.541289307369  delta_E= -1.82e-12  |g|= 1.56e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 333.44513146420036
E1 = -182.59021920850142  E_coul = 54.04892990113213
init E= -128.541289307369
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.84886852225426  LUMO = 0.805650287163176
  mo_energy =
[-3.27704044e+01 -1.92916976e+00 -8.48868522e-01 -8.48868522e-01
 -8.48868522e-01  8.05650287e-01  8.05650287e-01  8.05650287e-01
  1.14701403e+00  3.88557784e+00  3.88557784e+00  3.88557784e+00
  7.00063694e+00  1.41974249e+01  1.41974249e+01  1.41974249e+01
  3.35100628e+01  5.26232496e+01  5.26232496e+01  5.26232496e+01
  1.35667400e+02  2.39229361e+02  2.39229361e+02  2.39229361e+02
  4.97380676e+02  1.86427047e+03  7.99437663e+03  4.77629437e+04]
E1 = -182.59022532518014  E_coul = 54.04893601781123
cycle= 1 E= -128.541289307369  delta_E= 3.98e-13  |g|= 8.44e-07  |ddm|= 5.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59022532518014  E_coul = 54.04893601781123
  HOMO = -0.848868093139295  LUMO = 0.805650394989468
  mo_energy =
[-3.27704031e+01 -1.92916928e+00 -8.48868093e-01 -8.48868093e-01
 -8.48868093e-01  8.05650395e-01  8.05650395e-01  8.05650395e-01
  1.14701422e+00  3.88557823e+00  3.88557823e+00  3.88557823e+00
  7.00063746e+00  1.41974257e+01  1.41974257e+01  1.41974257e+01
  3.35100638e+01  5.26232508e+01  5.26232508e+01  5.26232508e+01
  1.35667401e+02  2.39229363e+02  2.39229363e+02  2.39229363e+02
  4.97380678e+02  1.86427047e+03  7.99437663e+03  4.77629437e+04]
E1 = -182.59022226558514  E_coul = 54.048932958216106
Extra cycle  E= -128.541289307369  delta_E= -1.14e-13  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145430e+03 8.33271069e+02 2.35812879e+02
 7.55201166e+01 9.83695951e+00 2.65172546e+01 3.74193642e-01
 1.08336135e+00 2.78133195e+00 7.09351460e+00 2.30762546e+01
 9.91924291e+01 2.66065367e-01 2.43681484e+00 8.33056654e-01]
grad_E = [-1.59152748e-09  8.18417388e-08 -1.43976523e-06  1.08816632e-05
 -1.56569746e-05 -9.63009559e-06 -1.77444672e-05 -1.59292112e-06
 -3.46251272e-06 -1.01663063e-05  4.36885706e-07 -1.60702078e-07
 -5.89231278e-07 -3.50226479e-07 -1.58591960e-06  2.00102802e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:19:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941334        1
[INPUT] 0    0    [1    /1   ]  3661.45430833        1
[INPUT] 0    0    [1    /1   ]  833.271004464        1
[INPUT] 0    0    [1    /1   ]  235.813424476        1
[INPUT] 0    0    [1    /1   ]  75.5185263249        1
[INPUT] 0    0    [1    /1   ]  9.8378458733         1
[INPUT] 0    0    [1    /1   ]  26.5181961727        1
[INPUT] 0    0    [1    /1   ]  0.374274779857       1
[INPUT] 0    0    [1    /1   ]  1.08372418023        1
[INPUT] 0    0    [1    /1   ]  2.78234210241        1
[INPUT] 1    0    [1    /1   ]  7.09367429158        1
[INPUT] 1    0    [1    /1   ]  23.076446084         1
[INPUT] 1    0    [1    /1   ]  99.1915725748        1
[INPUT] 1    0    [1    /1   ]  0.266066563031       1
[INPUT] 1    0    [1    /1   ]  2.43683940968        1
[INPUT] 1    0    [1    /1   ]  0.833060146337       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133374213, 1.0]], [0, [3661.454308332975, 1.0]], [0, [833.2710044643121, 1.0]], [0, [235.81342447576475, 1.0]], [0, [75.51852632493195, 1.0]], [0, [9.83784587330009, 1.0]], [0, [26.518196172661426, 1.0]], [0, [0.3742747798568722, 1.0]], [0, [1.083724180230589, 1.0]], [0, [2.7823421024148542, 1.0]], [1, [7.093674291584166, 1.0]], [1, [23.0764460840404, 1.0]], [1, [99.19157257476624, 1.0]], [1, [0.2660665630314555, 1.0]], [1, [2.4368394096794908, 1.0]], [1, [0.8330601463366283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413337]
bas 1, expnt(s) = [3661.45430833]
bas 2, expnt(s) = [833.27100446]
bas 3, expnt(s) = [235.81342448]
bas 4, expnt(s) = [75.51852632]
bas 5, expnt(s) = [9.83784587]
bas 6, expnt(s) = [26.51819617]
bas 7, expnt(s) = [0.37427478]
bas 8, expnt(s) = [1.08372418]
bas 9, expnt(s) = [2.7823421]
bas 10, expnt(s) = [7.09367429]
bas 11, expnt(s) = [23.07644608]
bas 12, expnt(s) = [99.19157257]
bas 13, expnt(s) = [0.26606656]
bas 14, expnt(s) = [2.43683941]
bas 15, expnt(s) = [0.83306015]
CPU time:       334.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145431e+03 1.18920093e+03
 8.33271004e+02 3.91836354e+02 2.35813424e+02 1.52034244e+02
 7.55185263e+01 6.47224806e+01 9.83784587e+00 1.40342767e+01
 2.65181962e+01 2.95238512e+01 3.74274780e-01 1.20894891e+00
 1.08372418e+00 2.68351543e+00 2.78234210e+00 5.44280681e+00
 7.09367429e+00 3.37732961e+01 2.30764461e+01 1.47552153e+02
 9.91915726e+01 9.13225147e+02 2.66066563e-01 5.57470983e-01
 2.43683941e+00 8.88214850e+00 8.33060146e-01 2.32182691e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595127664016
cond(S) = 333.5806650973798
E1 = -183.58950942422538  E_coul = 55.0801712512422
init E= -128.509338172983
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401589715883  LUMO = 0.823655543522866
  mo_energy =
[-3.25550325e+01 -1.85260977e+00 -7.75401590e-01 -7.75401590e-01
 -7.75401590e-01  8.23655544e-01  8.23655544e-01  8.23655544e-01
  1.17736160e+00  3.95149113e+00  3.95149113e+00  3.95149113e+00
  7.09039850e+00  1.43252022e+01  1.43252022e+01  1.43252022e+01
  3.36809322e+01  5.28110791e+01  5.28110791e+01  5.28110791e+01
  1.35889138e+02  2.39461887e+02  2.39461887e+02  2.39461887e+02
  4.97634193e+02  1.86455356e+03  7.99468555e+03  4.77632695e+04]
E1 = -182.08720443030944  E_coul = 53.54941571348973
cycle= 1 E= -128.53778871682  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509428
diis-c [-0.25951696  1.        ]
  HOMO = -0.88417153167591  LUMO = 0.796989590812885
  mo_energy =
[-3.28778878e+01 -1.96643474e+00 -8.84171532e-01 -8.84171532e-01
 -8.84171532e-01  7.96989591e-01  7.96989591e-01  7.96989591e-01
  1.13344110e+00  3.85427116e+00  3.85427116e+00  3.85427116e+00
  6.96154341e+00  1.41349436e+01  1.41349436e+01  1.41349436e+01
  3.34359354e+01  5.25306602e+01  5.25306602e+01  5.25306602e+01
  1.35572115e+02  2.39116154e+02  2.39116154e+02  2.39116154e+02
  4.97273003e+02  1.86415635e+03  7.99425937e+03  4.77628245e+04]
E1 = -182.84780406946098  E_coul = 54.307432451784955
cycle= 2 E= -128.540371617676  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258535
diis-c [-6.39881920e-04  3.35852007e-01  6.64147993e-01]
  HOMO = -0.848572968807749  LUMO = 0.805703512688197
  mo_energy =
[-3.27698620e+01 -1.92894137e+00 -8.48572969e-01 -8.48572969e-01
 -8.48572969e-01  8.05703513e-01  8.05703513e-01  8.05703513e-01
  1.14754495e+00  3.88581814e+00  3.88581814e+00  3.88581814e+00
  7.00376695e+00  1.41980008e+01  1.41980008e+01  1.41980008e+01
  3.35180282e+01  5.26245280e+01  5.26245280e+01  5.26245280e+01
  1.35677964e+02  2.39229700e+02  2.39229700e+02  2.39229700e+02
  4.97389770e+02  1.86427837e+03  7.99438381e+03  4.77629498e+04]
E1 = -182.58954397545457  E_coul = 54.04825468623333
cycle= 3 E= -128.541289289221  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118098
diis-c [-1.27448687e-07 -2.26606912e-03 -1.01726775e-04  1.00236780e+00]
  HOMO = -0.848829696187273  LUMO = 0.805666585561294
  mo_energy =
[-3.27703347e+01 -1.92914016e+00 -8.48829696e-01 -8.48829696e-01
 -8.48829696e-01  8.05666586e-01  8.05666586e-01  8.05666586e-01
  1.14747136e+00  3.88563966e+00  3.88563966e+00  3.88563966e+00
  7.00355330e+00  1.41976922e+01  1.41976922e+01  1.41976922e+01
  3.35176655e+01  5.26241111e+01  5.26241111e+01  5.26241111e+01
  1.35677491e+02  2.39229157e+02  2.39229157e+02  2.39229157e+02
  4.97389170e+02  1.86427763e+03  7.99438298e+03  4.77629490e+04]
E1 = -182.59008934872637  E_coul = 54.048800037634145
cycle= 4 E= -128.541289311092  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186751
diis-c [-8.18114709e-10  1.95692285e-04  4.84718079e-04 -1.61118553e-01
  1.16043814e+00]
  HOMO = -0.848869682680766  LUMO = 0.805654645721222
  mo_energy =
[-3.27704063e+01 -1.92917169e+00 -8.48869683e-01 -8.48869683e-01
 -8.48869683e-01  8.05654646e-01  8.05654646e-01  8.05654646e-01
  1.14745454e+00  3.88560222e+00  3.88560222e+00  3.88560222e+00
  7.00351191e+00  1.41976359e+01  1.41976359e+01  1.41976359e+01
  3.35176031e+01  5.26240439e+01  5.26240439e+01  5.26240439e+01
  1.35677419e+02  2.39229081e+02  2.39229081e+02  2.39229081e+02
  4.97389090e+02  1.86427754e+03  7.99438289e+03  4.77629489e+04]
E1 = -182.59023315403198  E_coul = 54.04894384237138
cycle= 5 E= -128.541289311661  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59023315403198  E_coul = 54.04894384237138
  HOMO = -0.848867482007298  LUMO = 0.805655301516007
  mo_energy =
[-3.27704015e+01 -1.92916875e+00 -8.48867482e-01 -8.48867482e-01
 -8.48867482e-01  8.05655302e-01  8.05655302e-01  8.05655302e-01
  1.14745597e+00  3.88560434e+00  3.88560434e+00  3.88560434e+00
  7.00351492e+00  1.41976395e+01  1.41976395e+01  1.41976395e+01
  3.35176075e+01  5.26240485e+01  5.26240485e+01  5.26240485e+01
  1.35677424e+02  2.39229085e+02  2.39229085e+02  2.39229085e+02
  4.97389094e+02  1.86427755e+03  7.99438289e+03  4.77629489e+04]
E1 = -182.5902222569824  E_coul = 54.04893294532031
Extra cycle  E= -128.541289311662  delta_E= -1.51e-12  |g|= 1.56e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145431e+03 8.33271004e+02 2.35813424e+02
 7.55185263e+01 9.83784587e+00 2.65181962e+01 3.74274780e-01
 1.08372418e+00 2.78234210e+00 7.09367429e+00 2.30764461e+01
 9.91915726e+01 2.66066563e-01 2.43683941e+00 8.33060146e-01]
E = -128.5412893116621
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941334        1
[INPUT] 0    0    [1    /1   ]  3661.45430833        1
[INPUT] 0    0    [1    /1   ]  833.271004464        1
[INPUT] 0    0    [1    /1   ]  235.813424476        1
[INPUT] 0    0    [1    /1   ]  75.5185263249        1
[INPUT] 0    0    [1    /1   ]  9.8378458733         1
[INPUT] 0    0    [1    /1   ]  26.5181961727        1
[INPUT] 0    0    [1    /1   ]  0.374274779857       1
[INPUT] 0    0    [1    /1   ]  1.08372418023        1
[INPUT] 0    0    [1    /1   ]  2.78234210241        1
[INPUT] 1    0    [1    /1   ]  7.09367429158        1
[INPUT] 1    0    [1    /1   ]  23.076446084         1
[INPUT] 1    0    [1    /1   ]  99.1915725748        1
[INPUT] 1    0    [1    /1   ]  0.266066563031       1
[INPUT] 1    0    [1    /1   ]  2.43683940968        1
[INPUT] 1    0    [1    /1   ]  0.833060146337       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133374213, 1.0]], [0, [3661.454308332975, 1.0]], [0, [833.2710044643121, 1.0]], [0, [235.81342447576475, 1.0]], [0, [75.51852632493195, 1.0]], [0, [9.83784587330009, 1.0]], [0, [26.518196172661426, 1.0]], [0, [0.3742747798568722, 1.0]], [0, [1.083724180230589, 1.0]], [0, [2.7823421024148542, 1.0]], [1, [7.093674291584166, 1.0]], [1, [23.0764460840404, 1.0]], [1, [99.19157257476624, 1.0]], [1, [0.2660665630314555, 1.0]], [1, [2.4368394096794908, 1.0]], [1, [0.8330601463366283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413337]
bas 1, expnt(s) = [3661.45430833]
bas 2, expnt(s) = [833.27100446]
bas 3, expnt(s) = [235.81342448]
bas 4, expnt(s) = [75.51852632]
bas 5, expnt(s) = [9.83784587]
bas 6, expnt(s) = [26.51819617]
bas 7, expnt(s) = [0.37427478]
bas 8, expnt(s) = [1.08372418]
bas 9, expnt(s) = [2.7823421]
bas 10, expnt(s) = [7.09367429]
bas 11, expnt(s) = [23.07644608]
bas 12, expnt(s) = [99.19157257]
bas 13, expnt(s) = [0.26606656]
bas 14, expnt(s) = [2.43683941]
bas 15, expnt(s) = [0.83306015]
CPU time:       335.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145431e+03 1.18920093e+03
 8.33271004e+02 3.91836354e+02 2.35813424e+02 1.52034244e+02
 7.55185263e+01 6.47224806e+01 9.83784587e+00 1.40342767e+01
 2.65181962e+01 2.95238512e+01 3.74274780e-01 1.20894891e+00
 1.08372418e+00 2.68351543e+00 2.78234210e+00 5.44280681e+00
 7.09367429e+00 3.37732961e+01 2.30764461e+01 1.47552153e+02
 9.91915726e+01 9.13225147e+02 2.66066563e-01 5.57470983e-01
 2.43683941e+00 8.88214850e+00 8.33060146e-01 2.32182691e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999595127664016
cond(S) = 333.5806650973798
E1 = -183.58950942422538  E_coul = 55.0801712512422
init E= -128.509338172983
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401589715883  LUMO = 0.823655543522866
  mo_energy =
[-3.25550325e+01 -1.85260977e+00 -7.75401590e-01 -7.75401590e-01
 -7.75401590e-01  8.23655544e-01  8.23655544e-01  8.23655544e-01
  1.17736160e+00  3.95149113e+00  3.95149113e+00  3.95149113e+00
  7.09039850e+00  1.43252022e+01  1.43252022e+01  1.43252022e+01
  3.36809322e+01  5.28110791e+01  5.28110791e+01  5.28110791e+01
  1.35889138e+02  2.39461887e+02  2.39461887e+02  2.39461887e+02
  4.97634193e+02  1.86455356e+03  7.99468555e+03  4.77632695e+04]
E1 = -182.08720443030944  E_coul = 53.54941571348973
cycle= 1 E= -128.53778871682  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509428
diis-c [-0.25951696  1.        ]
  HOMO = -0.88417153167591  LUMO = 0.796989590812885
  mo_energy =
[-3.28778878e+01 -1.96643474e+00 -8.84171532e-01 -8.84171532e-01
 -8.84171532e-01  7.96989591e-01  7.96989591e-01  7.96989591e-01
  1.13344110e+00  3.85427116e+00  3.85427116e+00  3.85427116e+00
  6.96154341e+00  1.41349436e+01  1.41349436e+01  1.41349436e+01
  3.34359354e+01  5.25306602e+01  5.25306602e+01  5.25306602e+01
  1.35572115e+02  2.39116154e+02  2.39116154e+02  2.39116154e+02
  4.97273003e+02  1.86415635e+03  7.99425937e+03  4.77628245e+04]
E1 = -182.84780406946098  E_coul = 54.307432451784955
cycle= 2 E= -128.540371617676  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258535
diis-c [-6.39881920e-04  3.35852007e-01  6.64147993e-01]
  HOMO = -0.848572968807749  LUMO = 0.805703512688197
  mo_energy =
[-3.27698620e+01 -1.92894137e+00 -8.48572969e-01 -8.48572969e-01
 -8.48572969e-01  8.05703513e-01  8.05703513e-01  8.05703513e-01
  1.14754495e+00  3.88581814e+00  3.88581814e+00  3.88581814e+00
  7.00376695e+00  1.41980008e+01  1.41980008e+01  1.41980008e+01
  3.35180282e+01  5.26245280e+01  5.26245280e+01  5.26245280e+01
  1.35677964e+02  2.39229700e+02  2.39229700e+02  2.39229700e+02
  4.97389770e+02  1.86427837e+03  7.99438381e+03  4.77629498e+04]
E1 = -182.58954397545457  E_coul = 54.04825468623333
cycle= 3 E= -128.541289289221  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118098
diis-c [-1.27448687e-07 -2.26606912e-03 -1.01726775e-04  1.00236780e+00]
  HOMO = -0.848829696187273  LUMO = 0.805666585561294
  mo_energy =
[-3.27703347e+01 -1.92914016e+00 -8.48829696e-01 -8.48829696e-01
 -8.48829696e-01  8.05666586e-01  8.05666586e-01  8.05666586e-01
  1.14747136e+00  3.88563966e+00  3.88563966e+00  3.88563966e+00
  7.00355330e+00  1.41976922e+01  1.41976922e+01  1.41976922e+01
  3.35176655e+01  5.26241111e+01  5.26241111e+01  5.26241111e+01
  1.35677491e+02  2.39229157e+02  2.39229157e+02  2.39229157e+02
  4.97389170e+02  1.86427763e+03  7.99438298e+03  4.77629490e+04]
E1 = -182.59008934872637  E_coul = 54.048800037634145
cycle= 4 E= -128.541289311092  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186751
diis-c [-8.18114709e-10  1.95692285e-04  4.84718079e-04 -1.61118553e-01
  1.16043814e+00]
  HOMO = -0.848869682680766  LUMO = 0.805654645721222
  mo_energy =
[-3.27704063e+01 -1.92917169e+00 -8.48869683e-01 -8.48869683e-01
 -8.48869683e-01  8.05654646e-01  8.05654646e-01  8.05654646e-01
  1.14745454e+00  3.88560222e+00  3.88560222e+00  3.88560222e+00
  7.00351191e+00  1.41976359e+01  1.41976359e+01  1.41976359e+01
  3.35176031e+01  5.26240439e+01  5.26240439e+01  5.26240439e+01
  1.35677419e+02  2.39229081e+02  2.39229081e+02  2.39229081e+02
  4.97389090e+02  1.86427754e+03  7.99438289e+03  4.77629489e+04]
E1 = -182.59023315403198  E_coul = 54.04894384237138
cycle= 5 E= -128.541289311661  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59023315403198  E_coul = 54.04894384237138
  HOMO = -0.848867482007298  LUMO = 0.805655301516007
  mo_energy =
[-3.27704015e+01 -1.92916875e+00 -8.48867482e-01 -8.48867482e-01
 -8.48867482e-01  8.05655302e-01  8.05655302e-01  8.05655302e-01
  1.14745597e+00  3.88560434e+00  3.88560434e+00  3.88560434e+00
  7.00351492e+00  1.41976395e+01  1.41976395e+01  1.41976395e+01
  3.35176075e+01  5.26240485e+01  5.26240485e+01  5.26240485e+01
  1.35677424e+02  2.39229085e+02  2.39229085e+02  2.39229085e+02
  4.97389094e+02  1.86427755e+03  7.99438289e+03  4.77629489e+04]
E1 = -182.5902222569824  E_coul = 54.04893294532031
Extra cycle  E= -128.541289311662  delta_E= -1.51e-12  |g|= 1.56e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 333.5806650973798
E1 = -182.5902222569824  E_coul = 54.04893294532031
init E= -128.541289311662
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.848868259158197  LUMO = 0.805655125659169
  mo_energy =
[-3.27704040e+01 -1.92916943e+00 -8.48868259e-01 -8.48868259e-01
 -8.48868259e-01  8.05655126e-01  8.05655126e-01  8.05655126e-01
  1.14745575e+00  3.88560368e+00  3.88560368e+00  3.88560368e+00
  7.00351407e+00  1.41976382e+01  1.41976382e+01  1.41976382e+01
  3.35176057e+01  5.26240464e+01  5.26240464e+01  5.26240464e+01
  1.35677421e+02  2.39229083e+02  2.39229083e+02  2.39229083e+02
  4.97389092e+02  1.86427755e+03  7.99438289e+03  4.77629489e+04]
E1 = -182.590228372425  E_coul = 54.04893906076262
cycle= 1 E= -128.541289311662  delta_E= -2.84e-13  |g|= 8.44e-07  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.590228372425  E_coul = 54.04893906076262
  HOMO = -0.848867830130021  LUMO = 0.805655233464235
  mo_energy =
[-3.27704027e+01 -1.92916895e+00 -8.48867830e-01 -8.48867830e-01
 -8.48867830e-01  8.05655233e-01  8.05655233e-01  8.05655233e-01
  1.14745594e+00  3.88560406e+00  3.88560406e+00  3.88560406e+00
  7.00351460e+00  1.41976389e+01  1.41976389e+01  1.41976389e+01
  3.35176067e+01  5.26240475e+01  5.26240475e+01  5.26240475e+01
  1.35677422e+02  2.39229084e+02  2.39229084e+02  2.39229084e+02
  4.97389093e+02  1.86427755e+03  7.99438289e+03  4.77629489e+04]
E1 = -182.59022531344812  E_coul = 54.048936001785385
Extra cycle  E= -128.541289311663  delta_E= -3.41e-13  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145431e+03 8.33271004e+02 2.35813424e+02
 7.55185263e+01 9.83784587e+00 2.65181962e+01 3.74274780e-01
 1.08372418e+00 2.78234210e+00 7.09367429e+00 2.30764461e+01
 9.91915726e+01 2.66066563e-01 2.43683941e+00 8.33060146e-01]
grad_E = [-1.60191480e-09  8.23838193e-08 -1.44991759e-06  1.09836903e-05
 -1.61691976e-05 -1.01630434e-05 -1.67910630e-05 -4.56486331e-06
 -2.31603929e-07 -1.01710571e-05  1.74674967e-06 -3.27340462e-07
 -5.88190904e-07 -1.27669274e-06 -4.42075882e-06  4.31555276e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941333        1
[INPUT] 0    0    [1    /1   ]  3661.45431217        1
[INPUT] 0    0    [1    /1   ]  833.270935468        1
[INPUT] 0    0    [1    /1   ]  235.814019464        1
[INPUT] 0    0    [1    /1   ]  75.5166580692        1
[INPUT] 0    0    [1    /1   ]  9.83905879943        1
[INPUT] 0    0    [1    /1   ]  26.5195725281        1
[INPUT] 0    0    [1    /1   ]  0.374387798138       1
[INPUT] 0    0    [1    /1   ]  1.08422207975        1
[INPUT] 0    0    [1    /1   ]  2.78367327007        1
[INPUT] 1    0    [1    /1   ]  7.09390559024        1
[INPUT] 1    0    [1    /1   ]  23.0766352624        1
[INPUT] 1    0    [1    /1   ]  99.1896916574        1
[INPUT] 1    0    [1    /1   ]  0.266068216063       1
[INPUT] 1    0    [1    /1   ]  2.43687598933        1
[INPUT] 1    0    [1    /1   ]  0.833064656442       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413330017, 1.0]], [0, [3661.4543121667825, 1.0]], [0, [833.2709354684648, 1.0]], [0, [235.8140194642942, 1.0]], [0, [75.51665806915527, 1.0]], [0, [9.839058799428667, 1.0]], [0, [26.51957252809042, 1.0]], [0, [0.3743877981378151, 1.0]], [0, [1.084222079753267, 1.0]], [0, [2.783673270072914, 1.0]], [1, [7.09390559024459, 1.0]], [1, [23.076635262441734, 1.0]], [1, [99.189691657365, 1.0]], [1, [0.2660682160628582, 1.0]], [1, [2.436875989326402, 1.0]], [1, [0.8330646564418981, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941333]
bas 1, expnt(s) = [3661.45431217]
bas 2, expnt(s) = [833.27093547]
bas 3, expnt(s) = [235.81401946]
bas 4, expnt(s) = [75.51665807]
bas 5, expnt(s) = [9.8390588]
bas 6, expnt(s) = [26.51957253]
bas 7, expnt(s) = [0.3743878]
bas 8, expnt(s) = [1.08422208]
bas 9, expnt(s) = [2.78367327]
bas 10, expnt(s) = [7.09390559]
bas 11, expnt(s) = [23.07663526]
bas 12, expnt(s) = [99.18969166]
bas 13, expnt(s) = [0.26606822]
bas 14, expnt(s) = [2.43687599]
bas 15, expnt(s) = [0.83306466]
CPU time:       339.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145431e+03 1.18920093e+03
 8.33270935e+02 3.91836330e+02 2.35814019e+02 1.52034531e+02
 7.55166581e+01 6.47212797e+01 9.83905880e+00 1.40355744e+01
 2.65195725e+01 2.95250005e+01 3.74387798e-01 1.20922269e+00
 1.08422208e+00 2.68444005e+00 2.78367327e+00 5.44475972e+00
 7.09390559e+00 3.37746726e+01 2.30766353e+01 1.47553665e+02
 9.91896917e+01 9.13203501e+02 2.66068216e-01 5.57475313e-01
 2.43687599e+00 8.88231516e+00 8.33064656e-01 2.32184262e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594978677163
cond(S) = 333.7646079614975
E1 = -183.58951078958683  E_coul = 55.08017099746012
init E= -128.509339792127
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401603911072  LUMO = 0.823662168477973
  mo_energy =
[-3.25550328e+01 -1.85260950e+00 -7.75401604e-01 -7.75401604e-01
 -7.75401604e-01  8.23662168e-01  8.23662168e-01  8.23662168e-01
  1.17798550e+00  3.95152745e+00  3.95152745e+00  3.95152745e+00
  7.09430863e+00  1.43255119e+01  1.43255119e+01  1.43255119e+01
  3.36911203e+01  5.28121244e+01  5.28121244e+01  5.28121244e+01
  1.35903050e+02  2.39460129e+02  2.39460129e+02  2.39460129e+02
  4.97646496e+02  1.86456410e+03  7.99469486e+03  4.77632772e+04]
E1 = -182.08721091178168  E_coul = 53.549422158015716
cycle= 1 E= -128.537788753766  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509426
diis-c [-0.25951519  1.        ]
  HOMO = -0.884170995768899  LUMO = 0.796996178166286
  mo_energy =
[-3.28778868e+01 -1.96643412e+00 -8.84170996e-01 -8.84170996e-01
 -8.84170996e-01  7.96996178e-01  7.96996178e-01  7.96996178e-01
  1.13404262e+00  3.85430690e+00  3.85430690e+00  3.85430690e+00
  6.96541535e+00  1.41352517e+01  1.41352517e+01  1.41352517e+01
  3.34461145e+01  5.25317060e+01  5.25317060e+01  5.25317060e+01
  1.35586029e+02  2.39114398e+02  2.39114398e+02  2.39114398e+02
  4.97285307e+02  1.86416689e+03  7.99426868e+03  4.77628322e+04]
E1 = -182.84780666405464  E_coul = 54.30743502734074
cycle= 2 E= -128.540371636714  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258534
diis-c [-6.39937271e-04  3.35851784e-01  6.64148216e-01]
  HOMO = -0.84857261977603  LUMO = 0.805710132868901
  mo_energy =
[-3.27698615e+01 -1.92894092e+00 -8.48572620e-01 -8.48572620e-01
 -8.48572620e-01  8.05710133e-01  8.05710133e-01  8.05710133e-01
  1.14815375e+00  3.88585407e+00  3.88585407e+00  3.88585407e+00
  7.00765168e+00  1.41983095e+01  1.41983095e+01  1.41983095e+01
  3.35282102e+01  5.26255736e+01  5.26255736e+01  5.26255736e+01
  1.35691877e+02  2.39227943e+02  2.39227943e+02  2.39227943e+02
  4.97402074e+02  1.86428891e+03  7.99439312e+03  4.77629576e+04]
E1 = -182.5895483041525  E_coul = 54.048259005564674
cycle= 3 E= -128.541289298588  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011809
diis-c [-1.27396750e-07 -2.26602468e-03 -1.01851092e-04  1.00236788e+00]
  HOMO = -0.848829325772713  LUMO = 0.805673212542189
  mo_energy =
[-3.27703341e+01 -1.92913970e+00 -8.48829326e-01 -8.48829326e-01
 -8.48829326e-01  8.05673213e-01  8.05673213e-01  8.05673213e-01
  1.14808013e+00  3.88567560e+00  3.88567560e+00  3.88567560e+00
  7.00743799e+00  1.41980009e+01  1.41980009e+01  1.41980009e+01
  3.35278476e+01  5.26251568e+01  5.26251568e+01  5.26251568e+01
  1.35691403e+02  2.39227400e+02  2.39227400e+02  2.39227400e+02
  4.97401473e+02  1.86428817e+03  7.99439229e+03  4.77629567e+04]
E1 = -182.59009368164908  E_coul = 54.048804361196915
cycle= 4 E= -128.541289320452  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018673
diis-c [-8.17811709e-10  1.95650672e-04  4.84707301e-04 -1.61088752e-01
  1.16040839e+00]
  HOMO = -0.848869305382135  LUMO = 0.805661274811543
  mo_energy =
[-3.27704058e+01 -1.92917122e+00 -8.48869305e-01 -8.48869305e-01
 -8.48869305e-01  8.05661275e-01  8.05661275e-01  8.05661275e-01
  1.14806331e+00  3.88563816e+00  3.88563816e+00  3.88563816e+00
  7.00739660e+00  1.41979446e+01  1.41979446e+01  1.41979446e+01
  3.35277852e+01  5.26250895e+01  5.26250895e+01  5.26250895e+01
  1.35691332e+02  2.39227324e+02  2.39227324e+02  2.39227324e+02
  4.97401393e+02  1.86428809e+03  7.99439220e+03  4.77629566e+04]
E1 = -182.5902374799133  E_coul = 54.048948158893275
cycle= 5 E= -128.54128932102  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5902374799133  E_coul = 54.048948158893275
  HOMO = -0.8488671054077  LUMO = 0.805661930389033
  mo_energy =
[-3.27704010e+01 -1.92916828e+00 -8.48867105e-01 -8.48867105e-01
 -8.48867105e-01  8.05661930e-01  8.05661930e-01  8.05661930e-01
  1.14806474e+00  3.88564029e+00  3.88564029e+00  3.88564029e+00
  7.00739961e+00  1.41979482e+01  1.41979482e+01  1.41979482e+01
  3.35277896e+01  5.26250941e+01  5.26250941e+01  5.26250941e+01
  1.35691336e+02  2.39227329e+02  2.39227329e+02  2.39227329e+02
  4.97401398e+02  1.86428809e+03  7.99439220e+03  4.77629566e+04]
E1 = -182.59022658591496  E_coul = 54.048937264893425
Extra cycle  E= -128.541289321022  delta_E= -1.51e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145431e+03 8.33270935e+02 2.35814019e+02
 7.55166581e+01 9.83905880e+00 2.65195725e+01 3.74387798e-01
 1.08422208e+00 2.78367327e+00 7.09390559e+00 2.30766353e+01
 9.91896917e+01 2.66068216e-01 2.43687599e+00 8.33064656e-01]
E = -128.54128932102154
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941333        1
[INPUT] 0    0    [1    /1   ]  3661.45431217        1
[INPUT] 0    0    [1    /1   ]  833.270935468        1
[INPUT] 0    0    [1    /1   ]  235.814019464        1
[INPUT] 0    0    [1    /1   ]  75.5166580692        1
[INPUT] 0    0    [1    /1   ]  9.83905879943        1
[INPUT] 0    0    [1    /1   ]  26.5195725281        1
[INPUT] 0    0    [1    /1   ]  0.374387798138       1
[INPUT] 0    0    [1    /1   ]  1.08422207975        1
[INPUT] 0    0    [1    /1   ]  2.78367327007        1
[INPUT] 1    0    [1    /1   ]  7.09390559024        1
[INPUT] 1    0    [1    /1   ]  23.0766352624        1
[INPUT] 1    0    [1    /1   ]  99.1896916574        1
[INPUT] 1    0    [1    /1   ]  0.266068216063       1
[INPUT] 1    0    [1    /1   ]  2.43687598933        1
[INPUT] 1    0    [1    /1   ]  0.833064656442       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413330017, 1.0]], [0, [3661.4543121667825, 1.0]], [0, [833.2709354684648, 1.0]], [0, [235.8140194642942, 1.0]], [0, [75.51665806915527, 1.0]], [0, [9.839058799428667, 1.0]], [0, [26.51957252809042, 1.0]], [0, [0.3743877981378151, 1.0]], [0, [1.084222079753267, 1.0]], [0, [2.783673270072914, 1.0]], [1, [7.09390559024459, 1.0]], [1, [23.076635262441734, 1.0]], [1, [99.189691657365, 1.0]], [1, [0.2660682160628582, 1.0]], [1, [2.436875989326402, 1.0]], [1, [0.8330646564418981, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.7941333]
bas 1, expnt(s) = [3661.45431217]
bas 2, expnt(s) = [833.27093547]
bas 3, expnt(s) = [235.81401946]
bas 4, expnt(s) = [75.51665807]
bas 5, expnt(s) = [9.8390588]
bas 6, expnt(s) = [26.51957253]
bas 7, expnt(s) = [0.3743878]
bas 8, expnt(s) = [1.08422208]
bas 9, expnt(s) = [2.78367327]
bas 10, expnt(s) = [7.09390559]
bas 11, expnt(s) = [23.07663526]
bas 12, expnt(s) = [99.18969166]
bas 13, expnt(s) = [0.26606822]
bas 14, expnt(s) = [2.43687599]
bas 15, expnt(s) = [0.83306466]
CPU time:       340.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145431e+03 1.18920093e+03
 8.33270935e+02 3.91836330e+02 2.35814019e+02 1.52034531e+02
 7.55166581e+01 6.47212797e+01 9.83905880e+00 1.40355744e+01
 2.65195725e+01 2.95250005e+01 3.74387798e-01 1.20922269e+00
 1.08422208e+00 2.68444005e+00 2.78367327e+00 5.44475972e+00
 7.09390559e+00 3.37746726e+01 2.30766353e+01 1.47553665e+02
 9.91896917e+01 9.13203501e+02 2.66068216e-01 5.57475313e-01
 2.43687599e+00 8.88231516e+00 8.33064656e-01 2.32184262e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594978677163
cond(S) = 333.7646079614975
E1 = -183.58951078958683  E_coul = 55.08017099746012
init E= -128.509339792127
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401603911072  LUMO = 0.823662168477973
  mo_energy =
[-3.25550328e+01 -1.85260950e+00 -7.75401604e-01 -7.75401604e-01
 -7.75401604e-01  8.23662168e-01  8.23662168e-01  8.23662168e-01
  1.17798550e+00  3.95152745e+00  3.95152745e+00  3.95152745e+00
  7.09430863e+00  1.43255119e+01  1.43255119e+01  1.43255119e+01
  3.36911203e+01  5.28121244e+01  5.28121244e+01  5.28121244e+01
  1.35903050e+02  2.39460129e+02  2.39460129e+02  2.39460129e+02
  4.97646496e+02  1.86456410e+03  7.99469486e+03  4.77632772e+04]
E1 = -182.08721091178168  E_coul = 53.549422158015716
cycle= 1 E= -128.537788753766  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509426
diis-c [-0.25951519  1.        ]
  HOMO = -0.884170995768899  LUMO = 0.796996178166286
  mo_energy =
[-3.28778868e+01 -1.96643412e+00 -8.84170996e-01 -8.84170996e-01
 -8.84170996e-01  7.96996178e-01  7.96996178e-01  7.96996178e-01
  1.13404262e+00  3.85430690e+00  3.85430690e+00  3.85430690e+00
  6.96541535e+00  1.41352517e+01  1.41352517e+01  1.41352517e+01
  3.34461145e+01  5.25317060e+01  5.25317060e+01  5.25317060e+01
  1.35586029e+02  2.39114398e+02  2.39114398e+02  2.39114398e+02
  4.97285307e+02  1.86416689e+03  7.99426868e+03  4.77628322e+04]
E1 = -182.84780666405464  E_coul = 54.30743502734074
cycle= 2 E= -128.540371636714  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258534
diis-c [-6.39937271e-04  3.35851784e-01  6.64148216e-01]
  HOMO = -0.84857261977603  LUMO = 0.805710132868901
  mo_energy =
[-3.27698615e+01 -1.92894092e+00 -8.48572620e-01 -8.48572620e-01
 -8.48572620e-01  8.05710133e-01  8.05710133e-01  8.05710133e-01
  1.14815375e+00  3.88585407e+00  3.88585407e+00  3.88585407e+00
  7.00765168e+00  1.41983095e+01  1.41983095e+01  1.41983095e+01
  3.35282102e+01  5.26255736e+01  5.26255736e+01  5.26255736e+01
  1.35691877e+02  2.39227943e+02  2.39227943e+02  2.39227943e+02
  4.97402074e+02  1.86428891e+03  7.99439312e+03  4.77629576e+04]
E1 = -182.5895483041525  E_coul = 54.048259005564674
cycle= 3 E= -128.541289298588  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011809
diis-c [-1.27396750e-07 -2.26602468e-03 -1.01851092e-04  1.00236788e+00]
  HOMO = -0.848829325772713  LUMO = 0.805673212542189
  mo_energy =
[-3.27703341e+01 -1.92913970e+00 -8.48829326e-01 -8.48829326e-01
 -8.48829326e-01  8.05673213e-01  8.05673213e-01  8.05673213e-01
  1.14808013e+00  3.88567560e+00  3.88567560e+00  3.88567560e+00
  7.00743799e+00  1.41980009e+01  1.41980009e+01  1.41980009e+01
  3.35278476e+01  5.26251568e+01  5.26251568e+01  5.26251568e+01
  1.35691403e+02  2.39227400e+02  2.39227400e+02  2.39227400e+02
  4.97401473e+02  1.86428817e+03  7.99439229e+03  4.77629567e+04]
E1 = -182.59009368164908  E_coul = 54.048804361196915
cycle= 4 E= -128.541289320452  delta_E= -2.19e-08  |g|= 7.62e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018673
diis-c [-8.17811709e-10  1.95650672e-04  4.84707301e-04 -1.61088752e-01
  1.16040839e+00]
  HOMO = -0.848869305382135  LUMO = 0.805661274811543
  mo_energy =
[-3.27704058e+01 -1.92917122e+00 -8.48869305e-01 -8.48869305e-01
 -8.48869305e-01  8.05661275e-01  8.05661275e-01  8.05661275e-01
  1.14806331e+00  3.88563816e+00  3.88563816e+00  3.88563816e+00
  7.00739660e+00  1.41979446e+01  1.41979446e+01  1.41979446e+01
  3.35277852e+01  5.26250895e+01  5.26250895e+01  5.26250895e+01
  1.35691332e+02  2.39227324e+02  2.39227324e+02  2.39227324e+02
  4.97401393e+02  1.86428809e+03  7.99439220e+03  4.77629566e+04]
E1 = -182.5902374799133  E_coul = 54.048948158893275
cycle= 5 E= -128.54128932102  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5902374799133  E_coul = 54.048948158893275
  HOMO = -0.8488671054077  LUMO = 0.805661930389033
  mo_energy =
[-3.27704010e+01 -1.92916828e+00 -8.48867105e-01 -8.48867105e-01
 -8.48867105e-01  8.05661930e-01  8.05661930e-01  8.05661930e-01
  1.14806474e+00  3.88564029e+00  3.88564029e+00  3.88564029e+00
  7.00739961e+00  1.41979482e+01  1.41979482e+01  1.41979482e+01
  3.35277896e+01  5.26250941e+01  5.26250941e+01  5.26250941e+01
  1.35691336e+02  2.39227329e+02  2.39227329e+02  2.39227329e+02
  4.97401398e+02  1.86428809e+03  7.99439220e+03  4.77629566e+04]
E1 = -182.59022658591496  E_coul = 54.048937264893425
Extra cycle  E= -128.541289321022  delta_E= -1.51e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 333.7646079614975
E1 = -182.59022658591496  E_coul = 54.048937264893425
init E= -128.541289321022
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848867882342153  LUMO = 0.805661754577256
  mo_energy =
[-3.27704034e+01 -1.92916897e+00 -8.48867882e-01 -8.48867882e-01
 -8.48867882e-01  8.05661755e-01  8.05661755e-01  8.05661755e-01
  1.14806453e+00  3.88563962e+00  3.88563962e+00  3.88563962e+00
  7.00739876e+00  1.41979468e+01  1.41979468e+01  1.41979468e+01
  3.35277878e+01  5.26250920e+01  5.26250920e+01  5.26250920e+01
  1.35691334e+02  2.39227326e+02  2.39227326e+02  2.39227326e+02
  4.97401395e+02  1.86428809e+03  7.99439220e+03  4.77629566e+04]
E1 = -182.59023269956367  E_coul = 54.04894337854182
cycle= 1 E= -128.541289321022  delta_E= -3.13e-13  |g|= 8.44e-07  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59023269956367  E_coul = 54.04894337854182
  HOMO = -0.848867453439833  LUMO = 0.805661862351389
  mo_energy =
[-3.27704021e+01 -1.92916849e+00 -8.48867453e-01 -8.48867453e-01
 -8.48867453e-01  8.05661862e-01  8.05661862e-01  8.05661862e-01
  1.14806472e+00  3.88564001e+00  3.88564001e+00  3.88564001e+00
  7.00739929e+00  1.41979476e+01  1.41979476e+01  1.41979476e+01
  3.35277888e+01  5.26250931e+01  5.26250931e+01  5.26250931e+01
  1.35691335e+02  2.39227327e+02  2.39227327e+02  2.39227327e+02
  4.97401396e+02  1.86428809e+03  7.99439220e+03  4.77629566e+04]
E1 = -182.5902296414842  E_coul = 54.048940320462215
Extra cycle  E= -128.541289321022  delta_E= -1.42e-13  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145431e+03 8.33270935e+02 2.35814019e+02
 7.55166581e+01 9.83905880e+00 2.65195725e+01 3.74387798e-01
 1.08422208e+00 2.78367327e+00 7.09390559e+00 2.30766353e+01
 9.91896917e+01 2.66068216e-01 2.43687599e+00 8.33064656e-01]
grad_E = [-1.61501944e-09  8.30684142e-08 -1.46279259e-06  1.11145675e-05
 -1.68403466e-05 -1.09403253e-05 -1.55060830e-05 -9.30405531e-06
  5.02169183e-06 -1.04011985e-05  3.72694397e-06 -5.89887011e-07
 -5.86590798e-07 -1.84020903e-06 -8.45303860e-06  7.09559658e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941332        1
[INPUT] 0    0    [1    /1   ]  3661.45431641        1
[INPUT] 0    0    [1    /1   ]  833.270858322        1
[INPUT] 0    0    [1    /1   ]  235.814720537        1
[INPUT] 0    0    [1    /1   ]  75.5140216068        1
[INPUT] 0    0    [1    /1   ]  9.84124221363        1
[INPUT] 0    0    [1    /1   ]  26.5222301907        1
[INPUT] 0    0    [1    /1   ]  0.374592951781       1
[INPUT] 0    0    [1    /1   ]  1.08511950138        1
[INPUT] 0    0    [1    /1   ]  2.78608007084        1
[INPUT] 1    0    [1    /1   ]  7.09432801534        1
[INPUT] 1    0    [1    /1   ]  23.0769438477        1
[INPUT] 1    0    [1    /1   ]  99.1861369563        1
[INPUT] 1    0    [1    /1   ]  0.266071074302       1
[INPUT] 1    0    [1    /1   ]  2.43694551146        1
[INPUT] 1    0    [1    /1   ]  0.83307277183        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133218445, 1.0]], [0, [3661.454316411394, 1.0]], [0, [833.2708583218327, 1.0]], [0, [235.81472053682458, 1.0]], [0, [75.51402160675367, 1.0]], [0, [9.84124221363311, 1.0]], [0, [26.522230190727903, 1.0]], [0, [0.3745929517814912, 1.0]], [0, [1.085119501377574, 1.0]], [0, [2.7860800708441618, 1.0]], [1, [7.09432801533564, 1.0]], [1, [23.076943847680425, 1.0]], [1, [99.18613695632915, 1.0]], [1, [0.2660710743022416, 1.0]], [1, [2.4369455114640126, 1.0]], [1, [0.8330727718297551, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413322]
bas 1, expnt(s) = [3661.45431641]
bas 2, expnt(s) = [833.27085832]
bas 3, expnt(s) = [235.81472054]
bas 4, expnt(s) = [75.51402161]
bas 5, expnt(s) = [9.84124221]
bas 6, expnt(s) = [26.52223019]
bas 7, expnt(s) = [0.37459295]
bas 8, expnt(s) = [1.0851195]
bas 9, expnt(s) = [2.78608007]
bas 10, expnt(s) = [7.09432802]
bas 11, expnt(s) = [23.07694385]
bas 12, expnt(s) = [99.18613696]
bas 13, expnt(s) = [0.26607107]
bas 14, expnt(s) = [2.43694551]
bas 15, expnt(s) = [0.83307277]
CPU time:       344.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145432e+03 1.18920093e+03
 8.33270858e+02 3.91836302e+02 2.35814721e+02 1.52034870e+02
 7.55140216e+01 6.47195850e+01 9.84124221e+00 1.40379104e+01
 2.65222302e+01 2.95272196e+01 3.74592952e-01 1.20971962e+00
 1.08511950e+00 2.68610633e+00 2.78608007e+00 5.44829004e+00
 7.09432802e+00 3.37771866e+01 2.30769438e+01 1.47556131e+02
 9.91861370e+01 9.13162593e+02 2.66071074e-01 5.57482798e-01
 2.43694551e+00 8.88263192e+00 8.33072772e-01 2.32187090e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594710457185
cond(S) = 334.0946224431559
E1 = -183.58951306718689  E_coul = 55.08017056600157
init E= -128.509342501185
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401628443346  LUMO = 0.823673784635049
  mo_energy =
[-3.25550334e+01 -1.85260902e+00 -7.75401628e-01 -7.75401628e-01
 -7.75401628e-01  8.23673785e-01  8.23673785e-01  8.23673785e-01
  1.17911451e+00  3.95159425e+00  3.95159425e+00  3.95159425e+00
  7.10137390e+00  1.43260838e+01  1.43260838e+01  1.43260838e+01
  3.37095837e+01  5.28139963e+01  5.28139963e+01  5.28139963e+01
  1.35929010e+02  2.39456608e+02  2.39456608e+02  2.39456608e+02
  4.97670858e+02  1.86458538e+03  7.99471360e+03  4.77632927e+04]
E1 = -182.08722298336426  E_coul = 53.54943415367003
cycle= 1 E= -128.537788829694  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509423
diis-c [-0.25951214  1.        ]
  HOMO = -0.884169990668672  LUMO = 0.797007750560733
  mo_energy =
[-3.28778850e+01 -1.96643298e+00 -8.84169991e-01 -8.84169991e-01
 -8.84169991e-01  7.97007751e-01  7.97007751e-01  7.97007751e-01
  1.13513121e+00  3.85437263e+00  3.85437263e+00  3.85437263e+00
  6.97241170e+00  1.41358206e+01  1.41358206e+01  1.41358206e+01
  3.34645617e+01  5.25335790e+01  5.25335790e+01  5.25335790e+01
  1.35611992e+02  2.39110881e+02  2.39110881e+02  2.39110881e+02
  4.97309673e+02  1.86418817e+03  7.99428742e+03  4.77628477e+04]
E1 = -182.84781173376786  E_coul = 54.30744005346608
cycle= 2 E= -128.540371680302  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258532
diis-c [-6.40036158e-04  3.35851377e-01  6.64148623e-01]
  HOMO = -0.84857195049506  LUMO = 0.805721762200585
  mo_energy =
[-3.27698605e+01 -1.92894008e+00 -8.48571950e-01 -8.48571950e-01
 -8.48571950e-01  8.05721762e-01  8.05721762e-01  8.05721762e-01
  1.14925552e+00  3.88592015e+00  3.88592015e+00  3.88592015e+00
  7.01467115e+00  1.41988794e+01  1.41988794e+01  1.41988794e+01
  3.35466628e+01  5.26274462e+01  5.26274462e+01  5.26274462e+01
  1.35717839e+02  2.39224425e+02  2.39224425e+02  2.39224425e+02
  4.97426439e+02  1.86431018e+03  7.99441187e+03  4.77629731e+04]
E1 = -182.5895565404607  E_coul = 54.04826721585608
cycle= 3 E= -128.541289324605  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118075
diis-c [-1.27299471e-07 -2.26592272e-03 -1.02065132e-04  1.00236799e+00]
  HOMO = -0.848828614600161  LUMO = 0.805684855302052
  mo_energy =
[-3.27703331e+01 -1.92913884e+00 -8.48828615e-01 -8.48828615e-01
 -8.48828615e-01  8.05684855e-01  8.05684855e-01  8.05684855e-01
  1.14918185e+00  3.88574171e+00  3.88574171e+00  3.88574171e+00
  7.01445738e+00  1.41985708e+01  1.41985708e+01  1.41985708e+01
  3.35463002e+01  5.26270294e+01  5.26270294e+01  5.26270294e+01
  1.35717365e+02  2.39223881e+02  2.39223881e+02  2.39223881e+02
  4.97425838e+02  1.86430945e+03  7.99441103e+03  4.77629722e+04]
E1 = -182.59010192350073  E_coul = 54.04881257704624
cycle= 4 E= -128.541289346454  delta_E= -2.18e-08  |g|= 7.61e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186689
diis-c [-8.17238913e-10  1.95569372e-04  4.84681224e-04 -1.61032511e-01
  1.16035226e+00]
  HOMO = -0.84886858119137  LUMO = 0.80567292156513
  mo_energy =
[-3.27704047e+01 -1.92917036e+00 -8.48868581e-01 -8.48868581e-01
 -8.48868581e-01  8.05672922e-01  8.05672922e-01  8.05672922e-01
  1.14916502e+00  3.88570429e+00  3.88570429e+00  3.88570429e+00
  7.01441598e+00  1.41985146e+01  1.41985146e+01  1.41985146e+01
  3.35462378e+01  5.26269622e+01  5.26269622e+01  5.26269622e+01
  1.35717294e+02  2.39223805e+02  2.39223805e+02  2.39223805e+02
  4.97425759e+02  1.86430936e+03  7.99441094e+03  4.77629721e+04]
E1 = -182.59024570779766  E_coul = 54.04895636077554
cycle= 5 E= -128.541289347022  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59024570779766  E_coul = 54.04895636077554
  HOMO = -0.848866382560129  LUMO = 0.80567357672363
  mo_energy =
[-3.27703999e+01 -1.92916742e+00 -8.48866383e-01 -8.48866383e-01
 -8.48866383e-01  8.05673577e-01  8.05673577e-01  8.05673577e-01
  1.14916645e+00  3.88570641e+00  3.88570641e+00  3.88570641e+00
  7.01441899e+00  1.41985182e+01  1.41985182e+01  1.41985182e+01
  3.35462422e+01  5.26269668e+01  5.26269668e+01  5.26269668e+01
  1.35717298e+02  2.39223810e+02  2.39223810e+02  2.39223810e+02
  4.97425763e+02  1.86430937e+03  7.99441094e+03  4.77629721e+04]
E1 = -182.59023481954023  E_coul = 54.048945472516706
Extra cycle  E= -128.541289347024  delta_E= -1.39e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145432e+03 8.33270858e+02 2.35814721e+02
 7.55140216e+01 9.84124221e+00 2.65222302e+01 3.74592952e-01
 1.08511950e+00 2.78608007e+00 7.09432802e+00 2.30769438e+01
 9.91861370e+01 2.66071074e-01 2.43694551e+00 8.33072772e-01]
E = -128.5412893470235
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941332        1
[INPUT] 0    0    [1    /1   ]  3661.45431641        1
[INPUT] 0    0    [1    /1   ]  833.270858322        1
[INPUT] 0    0    [1    /1   ]  235.814720537        1
[INPUT] 0    0    [1    /1   ]  75.5140216068        1
[INPUT] 0    0    [1    /1   ]  9.84124221363        1
[INPUT] 0    0    [1    /1   ]  26.5222301907        1
[INPUT] 0    0    [1    /1   ]  0.374592951781       1
[INPUT] 0    0    [1    /1   ]  1.08511950138        1
[INPUT] 0    0    [1    /1   ]  2.78608007084        1
[INPUT] 1    0    [1    /1   ]  7.09432801534        1
[INPUT] 1    0    [1    /1   ]  23.0769438477        1
[INPUT] 1    0    [1    /1   ]  99.1861369563        1
[INPUT] 1    0    [1    /1   ]  0.266071074302       1
[INPUT] 1    0    [1    /1   ]  2.43694551146        1
[INPUT] 1    0    [1    /1   ]  0.83307277183        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133218445, 1.0]], [0, [3661.454316411394, 1.0]], [0, [833.2708583218327, 1.0]], [0, [235.81472053682458, 1.0]], [0, [75.51402160675367, 1.0]], [0, [9.84124221363311, 1.0]], [0, [26.522230190727903, 1.0]], [0, [0.3745929517814912, 1.0]], [0, [1.085119501377574, 1.0]], [0, [2.7860800708441618, 1.0]], [1, [7.09432801533564, 1.0]], [1, [23.076943847680425, 1.0]], [1, [99.18613695632915, 1.0]], [1, [0.2660710743022416, 1.0]], [1, [2.4369455114640126, 1.0]], [1, [0.8330727718297551, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413322]
bas 1, expnt(s) = [3661.45431641]
bas 2, expnt(s) = [833.27085832]
bas 3, expnt(s) = [235.81472054]
bas 4, expnt(s) = [75.51402161]
bas 5, expnt(s) = [9.84124221]
bas 6, expnt(s) = [26.52223019]
bas 7, expnt(s) = [0.37459295]
bas 8, expnt(s) = [1.0851195]
bas 9, expnt(s) = [2.78608007]
bas 10, expnt(s) = [7.09432802]
bas 11, expnt(s) = [23.07694385]
bas 12, expnt(s) = [99.18613696]
bas 13, expnt(s) = [0.26607107]
bas 14, expnt(s) = [2.43694551]
bas 15, expnt(s) = [0.83307277]
CPU time:       345.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145432e+03 1.18920093e+03
 8.33270858e+02 3.91836302e+02 2.35814721e+02 1.52034870e+02
 7.55140216e+01 6.47195850e+01 9.84124221e+00 1.40379104e+01
 2.65222302e+01 2.95272196e+01 3.74592952e-01 1.20971962e+00
 1.08511950e+00 2.68610633e+00 2.78608007e+00 5.44829004e+00
 7.09432802e+00 3.37771866e+01 2.30769438e+01 1.47556131e+02
 9.91861370e+01 9.13162593e+02 2.66071074e-01 5.57482798e-01
 2.43694551e+00 8.88263192e+00 8.33072772e-01 2.32187090e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999594710457185
cond(S) = 334.0946224431559
E1 = -183.58951306718689  E_coul = 55.08017056600157
init E= -128.509342501185
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401628443346  LUMO = 0.823673784635049
  mo_energy =
[-3.25550334e+01 -1.85260902e+00 -7.75401628e-01 -7.75401628e-01
 -7.75401628e-01  8.23673785e-01  8.23673785e-01  8.23673785e-01
  1.17911451e+00  3.95159425e+00  3.95159425e+00  3.95159425e+00
  7.10137390e+00  1.43260838e+01  1.43260838e+01  1.43260838e+01
  3.37095837e+01  5.28139963e+01  5.28139963e+01  5.28139963e+01
  1.35929010e+02  2.39456608e+02  2.39456608e+02  2.39456608e+02
  4.97670858e+02  1.86458538e+03  7.99471360e+03  4.77632927e+04]
E1 = -182.08722298336426  E_coul = 53.54943415367003
cycle= 1 E= -128.537788829694  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509423
diis-c [-0.25951214  1.        ]
  HOMO = -0.884169990668672  LUMO = 0.797007750560733
  mo_energy =
[-3.28778850e+01 -1.96643298e+00 -8.84169991e-01 -8.84169991e-01
 -8.84169991e-01  7.97007751e-01  7.97007751e-01  7.97007751e-01
  1.13513121e+00  3.85437263e+00  3.85437263e+00  3.85437263e+00
  6.97241170e+00  1.41358206e+01  1.41358206e+01  1.41358206e+01
  3.34645617e+01  5.25335790e+01  5.25335790e+01  5.25335790e+01
  1.35611992e+02  2.39110881e+02  2.39110881e+02  2.39110881e+02
  4.97309673e+02  1.86418817e+03  7.99428742e+03  4.77628477e+04]
E1 = -182.84781173376786  E_coul = 54.30744005346608
cycle= 2 E= -128.540371680302  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258532
diis-c [-6.40036158e-04  3.35851377e-01  6.64148623e-01]
  HOMO = -0.84857195049506  LUMO = 0.805721762200585
  mo_energy =
[-3.27698605e+01 -1.92894008e+00 -8.48571950e-01 -8.48571950e-01
 -8.48571950e-01  8.05721762e-01  8.05721762e-01  8.05721762e-01
  1.14925552e+00  3.88592015e+00  3.88592015e+00  3.88592015e+00
  7.01467115e+00  1.41988794e+01  1.41988794e+01  1.41988794e+01
  3.35466628e+01  5.26274462e+01  5.26274462e+01  5.26274462e+01
  1.35717839e+02  2.39224425e+02  2.39224425e+02  2.39224425e+02
  4.97426439e+02  1.86431018e+03  7.99441187e+03  4.77629731e+04]
E1 = -182.5895565404607  E_coul = 54.04826721585608
cycle= 3 E= -128.541289324605  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118075
diis-c [-1.27299471e-07 -2.26592272e-03 -1.02065132e-04  1.00236799e+00]
  HOMO = -0.848828614600161  LUMO = 0.805684855302052
  mo_energy =
[-3.27703331e+01 -1.92913884e+00 -8.48828615e-01 -8.48828615e-01
 -8.48828615e-01  8.05684855e-01  8.05684855e-01  8.05684855e-01
  1.14918185e+00  3.88574171e+00  3.88574171e+00  3.88574171e+00
  7.01445738e+00  1.41985708e+01  1.41985708e+01  1.41985708e+01
  3.35463002e+01  5.26270294e+01  5.26270294e+01  5.26270294e+01
  1.35717365e+02  2.39223881e+02  2.39223881e+02  2.39223881e+02
  4.97425838e+02  1.86430945e+03  7.99441103e+03  4.77629722e+04]
E1 = -182.59010192350073  E_coul = 54.04881257704624
cycle= 4 E= -128.541289346454  delta_E= -2.18e-08  |g|= 7.61e-05  |ddm|= 0.000223
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186689
diis-c [-8.17238913e-10  1.95569372e-04  4.84681224e-04 -1.61032511e-01
  1.16035226e+00]
  HOMO = -0.84886858119137  LUMO = 0.80567292156513
  mo_energy =
[-3.27704047e+01 -1.92917036e+00 -8.48868581e-01 -8.48868581e-01
 -8.48868581e-01  8.05672922e-01  8.05672922e-01  8.05672922e-01
  1.14916502e+00  3.88570429e+00  3.88570429e+00  3.88570429e+00
  7.01441598e+00  1.41985146e+01  1.41985146e+01  1.41985146e+01
  3.35462378e+01  5.26269622e+01  5.26269622e+01  5.26269622e+01
  1.35717294e+02  2.39223805e+02  2.39223805e+02  2.39223805e+02
  4.97425759e+02  1.86430936e+03  7.99441094e+03  4.77629721e+04]
E1 = -182.59024570779766  E_coul = 54.04895636077554
cycle= 5 E= -128.541289347022  delta_E= -5.68e-10  |g|= 4.57e-06  |ddm|= 3.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59024570779766  E_coul = 54.04895636077554
  HOMO = -0.848866382560129  LUMO = 0.80567357672363
  mo_energy =
[-3.27703999e+01 -1.92916742e+00 -8.48866383e-01 -8.48866383e-01
 -8.48866383e-01  8.05673577e-01  8.05673577e-01  8.05673577e-01
  1.14916645e+00  3.88570641e+00  3.88570641e+00  3.88570641e+00
  7.01441899e+00  1.41985182e+01  1.41985182e+01  1.41985182e+01
  3.35462422e+01  5.26269668e+01  5.26269668e+01  5.26269668e+01
  1.35717298e+02  2.39223810e+02  2.39223810e+02  2.39223810e+02
  4.97425763e+02  1.86430937e+03  7.99441094e+03  4.77629721e+04]
E1 = -182.59023481954023  E_coul = 54.048945472516706
Extra cycle  E= -128.541289347024  delta_E= -1.39e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 334.0946224431559
E1 = -182.59023481954023  E_coul = 54.048945472516706
init E= -128.541289347024
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848867159088415  LUMO = 0.805673400996253
  mo_energy =
[-3.27704024e+01 -1.92916810e+00 -8.48867159e-01 -8.48867159e-01
 -8.48867159e-01  8.05673401e-01  8.05673401e-01  8.05673401e-01
  1.14916624e+00  3.88570574e+00  3.88570574e+00  3.88570574e+00
  7.01441815e+00  1.41985168e+01  1.41985168e+01  1.41985168e+01
  3.35462404e+01  5.26269647e+01  5.26269647e+01  5.26269647e+01
  1.35717296e+02  2.39223807e+02  2.39223807e+02  2.39223807e+02
  4.97425760e+02  1.86430936e+03  7.99441094e+03  4.77629721e+04]
E1 = -182.5902409297998  E_coul = 54.048951582775786
cycle= 1 E= -128.541289347024  delta_E= -5.12e-13  |g|= 8.43e-07  |ddm|= 5.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5902409297998  E_coul = 54.048951582775786
  HOMO = -0.848866730424214  LUMO = 0.805673508711869
  mo_energy =
[-3.27704011e+01 -1.92916762e+00 -8.48866730e-01 -8.48866730e-01
 -8.48866730e-01  8.05673509e-01  8.05673509e-01  8.05673509e-01
  1.14916643e+00  3.88570613e+00  3.88570613e+00  3.88570613e+00
  7.01441867e+00  1.41985176e+01  1.41985176e+01  1.41985176e+01
  3.35462414e+01  5.26269658e+01  5.26269658e+01  5.26269658e+01
  1.35717297e+02  2.39223809e+02  2.39223809e+02  2.39223809e+02
  4.97425761e+02  1.86430936e+03  7.99441094e+03  4.77629721e+04]
E1 = -182.59023787341502  E_coul = 54.048948526391044
Extra cycle  E= -128.541289347024  delta_E= 5.68e-14  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145432e+03 8.33270858e+02 2.35814721e+02
 7.55140216e+01 9.84124221e+00 2.65222302e+01 3.74592952e-01
 1.08511950e+00 2.78608007e+00 7.09432802e+00 2.30769438e+01
 9.91861370e+01 2.66071074e-01 2.43694551e+00 8.33072772e-01]
grad_E = [-1.63582931e-09  8.41572922e-08 -1.48340701e-06  1.13277865e-05
 -1.79674431e-05 -1.24064338e-05 -1.32709720e-05 -1.65369649e-05
  1.40487195e-05 -1.07352339e-05  7.29018124e-06 -1.07402433e-06
 -5.83205781e-07 -2.31509674e-06 -1.54127919e-05  1.13440140e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941332        1
[INPUT] 0    0    [1    /1   ]  3661.45431703        1
[INPUT] 0    0    [1    /1   ]  833.270843991        1
[INPUT] 0    0    [1    /1   ]  235.81499601         1
[INPUT] 0    0    [1    /1   ]  75.5113157427        1
[INPUT] 0    0    [1    /1   ]  9.84495548387        1
[INPUT] 0    0    [1    /1   ]  26.5272210402        1
[INPUT] 0    0    [1    /1   ]  0.374926765973       1
[INPUT] 0    0    [1    /1   ]  1.08657753759        1
[INPUT] 0    0    [1    /1   ]  2.78996671215        1
[INPUT] 1    0    [1    /1   ]  7.09504233893        1
[INPUT] 1    0    [1    /1   ]  23.0775394641        1
[INPUT] 1    0    [1    /1   ]  99.1809032987        1
[INPUT] 1    0    [1    /1   ]  0.266076251781       1
[INPUT] 1    0    [1    /1   ]  2.43706795863        1
[INPUT] 1    0    [1    /1   ]  0.83308812815        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133207655, 1.0]], [0, [3661.4543170260295, 1.0]], [0, [833.2708439914551, 1.0]], [0, [235.81499600952267, 1.0]], [0, [75.51131574274326, 1.0]], [0, [9.844955483867054, 1.0]], [0, [26.527221040186927, 1.0]], [0, [0.3749267659729334, 1.0]], [0, [1.0865775375920395, 1.0]], [0, [2.7899667121521907, 1.0]], [1, [7.095042338931492, 1.0]], [1, [23.077539464096443, 1.0]], [1, [99.18090329869123, 1.0]], [1, [0.2660762517805459, 1.0]], [1, [2.4370679586288033, 1.0]], [1, [0.8330881281501721, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413321]
bas 1, expnt(s) = [3661.45431703]
bas 2, expnt(s) = [833.27084399]
bas 3, expnt(s) = [235.81499601]
bas 4, expnt(s) = [75.51131574]
bas 5, expnt(s) = [9.84495548]
bas 6, expnt(s) = [26.52722104]
bas 7, expnt(s) = [0.37492677]
bas 8, expnt(s) = [1.08657754]
bas 9, expnt(s) = [2.78996671]
bas 10, expnt(s) = [7.09504234]
bas 11, expnt(s) = [23.07753946]
bas 12, expnt(s) = [99.1809033]
bas 13, expnt(s) = [0.26607625]
bas 14, expnt(s) = [2.43706796]
bas 15, expnt(s) = [0.83308813]
CPU time:       349.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145432e+03 1.18920093e+03
 8.33270844e+02 3.91836297e+02 2.35814996e+02 1.52035004e+02
 7.55113157e+01 6.47178457e+01 9.84495548e+00 1.40418827e+01
 2.65272210e+01 2.95313868e+01 3.74926766e-01 1.21052805e+00
 1.08657754e+00 2.68881280e+00 2.78996671e+00 5.45398941e+00
 7.09504234e+00 3.37814379e+01 2.30775395e+01 1.47560892e+02
 9.91809033e+01 9.13102363e+02 2.66076252e-01 5.57496359e-01
 2.43706796e+00 8.88318982e+00 8.33088128e-01 2.32192440e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99959426698102
cond(S) = 334.6277612044678
E1 = -183.58951628704165  E_coul = 55.080169851742255
init E= -128.509346435299
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401669142076  LUMO = 0.823694850998225
  mo_energy =
[-3.25550344e+01 -1.85260822e+00 -7.75401669e-01 -7.75401669e-01
 -7.75401669e-01  8.23694851e-01  8.23694851e-01  8.23694851e-01
  1.18095077e+00  3.95171570e+00  3.95171570e+00  3.95171570e+00
  7.11284417e+00  1.43270717e+01  1.43270717e+01  1.43270717e+01
  3.37400474e+01  5.28172772e+01  5.28172772e+01  5.28172772e+01
  1.35974184e+02  2.39452210e+02  2.39452210e+02  2.39452210e+02
  4.97716643e+02  1.86462622e+03  7.99474946e+03  4.77633224e+04]
E1 = -182.08724330638807  E_coul = 53.549454326859006
cycle= 1 E= -128.537788979529  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509418
diis-c [-0.25950664  1.        ]
  HOMO = -0.884168301622817  LUMO = 0.797028672820415
  mo_energy =
[-3.28778819e+01 -1.96643107e+00 -8.84168302e-01 -8.84168302e-01
 -8.84168302e-01  7.97028673e-01  7.97028673e-01  7.97028673e-01
  1.13690184e+00  3.85449212e+00  3.85449212e+00  3.85449212e+00
  6.98377010e+00  1.41368033e+01  1.41368033e+01  1.41368033e+01
  3.34949974e+01  5.25368614e+01  5.25368614e+01  5.25368614e+01
  1.35657169e+02  2.39106489e+02  2.39106489e+02  2.39106489e+02
  4.97355464e+02  1.86422902e+03  7.99432329e+03  4.77628774e+04]
E1 = -182.84782026402323  E_coul = 54.30744848820789
cycle= 2 E= -128.540371775815  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258528
diis-c [-6.40196150e-04  3.35850666e-01  6.64149334e-01]
  HOMO = -0.84857082475096  LUMO = 0.805742803118302
  mo_energy =
[-3.27698589e+01 -1.92893867e+00 -8.48570825e-01 -8.48570825e-01
 -8.48570825e-01  8.05742803e-01  8.05742803e-01  8.05742803e-01
  1.15104753e+00  3.88604029e+00  3.88604029e+00  3.88604029e+00
  7.02606705e+00  1.41998638e+01  1.41998638e+01  1.41998638e+01
  3.35771079e+01  5.26307281e+01  5.26307281e+01  5.26307281e+01
  1.35763015e+02  2.39220030e+02  2.39220030e+02  2.39220030e+02
  4.97472228e+02  1.86435103e+03  7.99444773e+03  4.77630028e+04]
E1 = -182.58957039194533  E_coul = 54.0482810014284
cycle= 3 E= -128.541289390517  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118051
diis-c [-1.27140115e-07 -2.26574153e-03 -1.02372927e-04  1.00236811e+00]
  HOMO = -0.848827420350386  LUMO = 0.805705918193292
  mo_energy =
[-3.27703313e+01 -1.92913740e+00 -8.48827420e-01 -8.48827420e-01
 -8.48827420e-01  8.05705918e-01  8.05705918e-01  8.05705918e-01
  1.15097380e+00  3.88586190e+00  3.88586190e+00  3.88586190e+00
  7.02585317e+00  1.41995553e+01  1.41995553e+01  1.41995553e+01
  3.35767453e+01  5.26303114e+01  5.26303114e+01  5.26303114e+01
  1.35762542e+02  2.39219487e+02  2.39219487e+02  2.39219487e+02
  4.97471628e+02  1.86435030e+03  7.99444690e+03  4.77630019e+04]
E1 = -182.59011578966258  E_coul = 54.04882637731891
cycle= 4 E= -128.541289412344  delta_E= -2.18e-08  |g|= 7.61e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186621
diis-c [-8.16303347e-10  1.95436937e-04  4.84632525e-04 -1.60941217e-01
  1.16026115e+00]
  HOMO = -0.848867365524405  LUMO = 0.805693991007734
  mo_energy =
[-3.27704029e+01 -1.92916892e+00 -8.48867366e-01 -8.48867366e-01
 -8.48867366e-01  8.05693991e-01  8.05693991e-01  8.05693991e-01
  1.15095695e+00  3.88582449e+00  3.88582449e+00  3.88582449e+00
  7.02581176e+00  1.41994991e+01  1.41994991e+01  1.41994991e+01
  3.35766829e+01  5.26302442e+01  5.26302442e+01  5.26302442e+01
  1.35762470e+02  2.39219411e+02  2.39219411e+02  2.39219411e+02
  4.97471548e+02  1.86435021e+03  7.99444681e+03  4.77630018e+04]
E1 = -182.59025955066704  E_coul = 54.048970137756584
cycle= 5 E= -128.54128941291  delta_E= -5.67e-10  |g|= 4.56e-06  |ddm|= 3.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59025955066704  E_coul = 54.048970137756584
  HOMO = -0.84886516907929  LUMO = 0.805694645486277
  mo_energy =
[-3.27703982e+01 -1.92916598e+00 -8.48865169e-01 -8.48865169e-01
 -8.48865169e-01  8.05694645e-01  8.05694645e-01  8.05694645e-01
  1.15095838e+00  3.88582662e+00  3.88582662e+00  3.88582662e+00
  7.02581477e+00  1.41995027e+01  1.41995027e+01  1.41995027e+01
  3.35766873e+01  5.26302488e+01  5.26302488e+01  5.26302488e+01
  1.35762475e+02  2.39219416e+02  2.39219416e+02  2.39219416e+02
  4.97471552e+02  1.86435022e+03  7.99444681e+03  4.77630018e+04]
E1 = -182.59024867176373  E_coul = 54.0489592588516
Extra cycle  E= -128.541289412912  delta_E= -1.68e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145432e+03 8.33270844e+02 2.35814996e+02
 7.55113157e+01 9.84495548e+00 2.65272210e+01 3.74926766e-01
 1.08657754e+00 2.78996671e+00 7.09504234e+00 2.30775395e+01
 9.91809033e+01 2.66076252e-01 2.43706796e+00 8.33088128e-01]
E = -128.54128941291214
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941332        1
[INPUT] 0    0    [1    /1   ]  3661.45431703        1
[INPUT] 0    0    [1    /1   ]  833.270843991        1
[INPUT] 0    0    [1    /1   ]  235.81499601         1
[INPUT] 0    0    [1    /1   ]  75.5113157427        1
[INPUT] 0    0    [1    /1   ]  9.84495548387        1
[INPUT] 0    0    [1    /1   ]  26.5272210402        1
[INPUT] 0    0    [1    /1   ]  0.374926765973       1
[INPUT] 0    0    [1    /1   ]  1.08657753759        1
[INPUT] 0    0    [1    /1   ]  2.78996671215        1
[INPUT] 1    0    [1    /1   ]  7.09504233893        1
[INPUT] 1    0    [1    /1   ]  23.0775394641        1
[INPUT] 1    0    [1    /1   ]  99.1809032987        1
[INPUT] 1    0    [1    /1   ]  0.266076251781       1
[INPUT] 1    0    [1    /1   ]  2.43706795863        1
[INPUT] 1    0    [1    /1   ]  0.83308812815        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794133207655, 1.0]], [0, [3661.4543170260295, 1.0]], [0, [833.2708439914551, 1.0]], [0, [235.81499600952267, 1.0]], [0, [75.51131574274326, 1.0]], [0, [9.844955483867054, 1.0]], [0, [26.527221040186927, 1.0]], [0, [0.3749267659729334, 1.0]], [0, [1.0865775375920395, 1.0]], [0, [2.7899667121521907, 1.0]], [1, [7.095042338931492, 1.0]], [1, [23.077539464096443, 1.0]], [1, [99.18090329869123, 1.0]], [1, [0.2660762517805459, 1.0]], [1, [2.4370679586288033, 1.0]], [1, [0.8330881281501721, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413321]
bas 1, expnt(s) = [3661.45431703]
bas 2, expnt(s) = [833.27084399]
bas 3, expnt(s) = [235.81499601]
bas 4, expnt(s) = [75.51131574]
bas 5, expnt(s) = [9.84495548]
bas 6, expnt(s) = [26.52722104]
bas 7, expnt(s) = [0.37492677]
bas 8, expnt(s) = [1.08657754]
bas 9, expnt(s) = [2.78996671]
bas 10, expnt(s) = [7.09504234]
bas 11, expnt(s) = [23.07753946]
bas 12, expnt(s) = [99.1809033]
bas 13, expnt(s) = [0.26607625]
bas 14, expnt(s) = [2.43706796]
bas 15, expnt(s) = [0.83308813]
CPU time:       350.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145432e+03 1.18920093e+03
 8.33270844e+02 3.91836297e+02 2.35814996e+02 1.52035004e+02
 7.55113157e+01 6.47178457e+01 9.84495548e+00 1.40418827e+01
 2.65272210e+01 2.95313868e+01 3.74926766e-01 1.21052805e+00
 1.08657754e+00 2.68881280e+00 2.78996671e+00 5.45398941e+00
 7.09504234e+00 3.37814379e+01 2.30775395e+01 1.47560892e+02
 9.91809033e+01 9.13102363e+02 2.66076252e-01 5.57496359e-01
 2.43706796e+00 8.88318982e+00 8.33088128e-01 2.32192440e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99959426698102
cond(S) = 334.6277612044678
E1 = -183.58951628704165  E_coul = 55.080169851742255
init E= -128.509346435299
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401669142076  LUMO = 0.823694850998225
  mo_energy =
[-3.25550344e+01 -1.85260822e+00 -7.75401669e-01 -7.75401669e-01
 -7.75401669e-01  8.23694851e-01  8.23694851e-01  8.23694851e-01
  1.18095077e+00  3.95171570e+00  3.95171570e+00  3.95171570e+00
  7.11284417e+00  1.43270717e+01  1.43270717e+01  1.43270717e+01
  3.37400474e+01  5.28172772e+01  5.28172772e+01  5.28172772e+01
  1.35974184e+02  2.39452210e+02  2.39452210e+02  2.39452210e+02
  4.97716643e+02  1.86462622e+03  7.99474946e+03  4.77633224e+04]
E1 = -182.08724330638807  E_coul = 53.549454326859006
cycle= 1 E= -128.537788979529  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509418
diis-c [-0.25950664  1.        ]
  HOMO = -0.884168301622817  LUMO = 0.797028672820415
  mo_energy =
[-3.28778819e+01 -1.96643107e+00 -8.84168302e-01 -8.84168302e-01
 -8.84168302e-01  7.97028673e-01  7.97028673e-01  7.97028673e-01
  1.13690184e+00  3.85449212e+00  3.85449212e+00  3.85449212e+00
  6.98377010e+00  1.41368033e+01  1.41368033e+01  1.41368033e+01
  3.34949974e+01  5.25368614e+01  5.25368614e+01  5.25368614e+01
  1.35657169e+02  2.39106489e+02  2.39106489e+02  2.39106489e+02
  4.97355464e+02  1.86422902e+03  7.99432329e+03  4.77628774e+04]
E1 = -182.84782026402323  E_coul = 54.30744848820789
cycle= 2 E= -128.540371775815  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258528
diis-c [-6.40196150e-04  3.35850666e-01  6.64149334e-01]
  HOMO = -0.84857082475096  LUMO = 0.805742803118302
  mo_energy =
[-3.27698589e+01 -1.92893867e+00 -8.48570825e-01 -8.48570825e-01
 -8.48570825e-01  8.05742803e-01  8.05742803e-01  8.05742803e-01
  1.15104753e+00  3.88604029e+00  3.88604029e+00  3.88604029e+00
  7.02606705e+00  1.41998638e+01  1.41998638e+01  1.41998638e+01
  3.35771079e+01  5.26307281e+01  5.26307281e+01  5.26307281e+01
  1.35763015e+02  2.39220030e+02  2.39220030e+02  2.39220030e+02
  4.97472228e+02  1.86435103e+03  7.99444773e+03  4.77630028e+04]
E1 = -182.58957039194533  E_coul = 54.0482810014284
cycle= 3 E= -128.541289390517  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118051
diis-c [-1.27140115e-07 -2.26574153e-03 -1.02372927e-04  1.00236811e+00]
  HOMO = -0.848827420350386  LUMO = 0.805705918193292
  mo_energy =
[-3.27703313e+01 -1.92913740e+00 -8.48827420e-01 -8.48827420e-01
 -8.48827420e-01  8.05705918e-01  8.05705918e-01  8.05705918e-01
  1.15097380e+00  3.88586190e+00  3.88586190e+00  3.88586190e+00
  7.02585317e+00  1.41995553e+01  1.41995553e+01  1.41995553e+01
  3.35767453e+01  5.26303114e+01  5.26303114e+01  5.26303114e+01
  1.35762542e+02  2.39219487e+02  2.39219487e+02  2.39219487e+02
  4.97471628e+02  1.86435030e+03  7.99444690e+03  4.77630019e+04]
E1 = -182.59011578966258  E_coul = 54.04882637731891
cycle= 4 E= -128.541289412344  delta_E= -2.18e-08  |g|= 7.61e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186621
diis-c [-8.16303347e-10  1.95436937e-04  4.84632525e-04 -1.60941217e-01
  1.16026115e+00]
  HOMO = -0.848867365524405  LUMO = 0.805693991007734
  mo_energy =
[-3.27704029e+01 -1.92916892e+00 -8.48867366e-01 -8.48867366e-01
 -8.48867366e-01  8.05693991e-01  8.05693991e-01  8.05693991e-01
  1.15095695e+00  3.88582449e+00  3.88582449e+00  3.88582449e+00
  7.02581176e+00  1.41994991e+01  1.41994991e+01  1.41994991e+01
  3.35766829e+01  5.26302442e+01  5.26302442e+01  5.26302442e+01
  1.35762470e+02  2.39219411e+02  2.39219411e+02  2.39219411e+02
  4.97471548e+02  1.86435021e+03  7.99444681e+03  4.77630018e+04]
E1 = -182.59025955066704  E_coul = 54.048970137756584
cycle= 5 E= -128.54128941291  delta_E= -5.67e-10  |g|= 4.56e-06  |ddm|= 3.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59025955066704  E_coul = 54.048970137756584
  HOMO = -0.84886516907929  LUMO = 0.805694645486277
  mo_energy =
[-3.27703982e+01 -1.92916598e+00 -8.48865169e-01 -8.48865169e-01
 -8.48865169e-01  8.05694645e-01  8.05694645e-01  8.05694645e-01
  1.15095838e+00  3.88582662e+00  3.88582662e+00  3.88582662e+00
  7.02581477e+00  1.41995027e+01  1.41995027e+01  1.41995027e+01
  3.35766873e+01  5.26302488e+01  5.26302488e+01  5.26302488e+01
  1.35762475e+02  2.39219416e+02  2.39219416e+02  2.39219416e+02
  4.97471552e+02  1.86435022e+03  7.99444681e+03  4.77630018e+04]
E1 = -182.59024867176373  E_coul = 54.0489592588516
Extra cycle  E= -128.541289412912  delta_E= -1.68e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 334.6277612044678
E1 = -182.59024867176373  E_coul = 54.0489592588516
init E= -128.541289412912
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.848865944945834  LUMO = 0.805694469895777
  mo_energy =
[-3.27704006e+01 -1.92916666e+00 -8.48865945e-01 -8.48865945e-01
 -8.48865945e-01  8.05694470e-01  8.05694470e-01  8.05694470e-01
  1.15095817e+00  3.88582595e+00  3.88582595e+00  3.88582595e+00
  7.02581393e+00  1.41995013e+01  1.41995013e+01  1.41995013e+01
  3.35766855e+01  5.26302467e+01  5.26302467e+01  5.26302467e+01
  1.35762472e+02  2.39219413e+02  2.39219413e+02  2.39219413e+02
  4.97471549e+02  1.86435021e+03  7.99444681e+03  4.77630018e+04]
E1 = -182.59025477650127  E_coul = 54.04896536358888
cycle= 1 E= -128.541289412912  delta_E= -2.56e-13  |g|= 8.42e-07  |ddm|= 5.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59025477650127  E_coul = 54.04896536358888
  HOMO = -0.848865516669602  LUMO = 0.805694577516523
  mo_energy =
[-3.27703993e+01 -1.92916618e+00 -8.48865517e-01 -8.48865517e-01
 -8.48865517e-01  8.05694578e-01  8.05694578e-01  8.05694578e-01
  1.15095836e+00  3.88582633e+00  3.88582633e+00  3.88582633e+00
  7.02581445e+00  1.41995020e+01  1.41995020e+01  1.41995020e+01
  3.35766865e+01  5.26302478e+01  5.26302478e+01  5.26302478e+01
  1.35762473e+02  2.39219415e+02  2.39219415e+02  2.39219415e+02
  4.97471551e+02  1.86435021e+03  7.99444681e+03  4.77630018e+04]
E1 = -182.5902517228781  E_coul = 54.048962309965674
Extra cycle  E= -128.541289412912  delta_E= -2.84e-14  |g|= 4.15e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145432e+03 8.33270844e+02 2.35814996e+02
 7.55113157e+01 9.84495548e+00 2.65272210e+01 3.74926766e-01
 1.08657754e+00 2.78996671e+00 7.09504234e+00 2.30775395e+01
 9.91809033e+01 2.66076252e-01 2.43706796e+00 8.33088128e-01]
grad_E = [-1.66436030e-09  8.56550000e-08 -1.51213722e-06  1.16348288e-05
 -1.96754902e-05 -1.47393459e-05 -9.74804979e-06 -2.83190405e-05
  2.88171347e-05 -1.13904300e-05  1.30385356e-05 -1.86062315e-06
 -5.77138710e-07 -2.32232733e-06 -2.64328517e-05  1.75807734e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941335        1
[INPUT] 0    0    [1    /1   ]  3661.45430247        1
[INPUT] 0    0    [1    /1   ]  833.271095243        1
[INPUT] 0    0    [1    /1   ]  235.813326006        1
[INPUT] 0    0    [1    /1   ]  75.5105571094        1
[INPUT] 0    0    [1    /1   ]  9.85173442674        1
[INPUT] 0    0    [1    /1   ]  26.537424501         1
[INPUT] 0    0    [1    /1   ]  0.375494976057       1
[INPUT] 0    0    [1    /1   ]  1.08906321782        1
[INPUT] 0    0    [1    /1   ]  2.79663143467        1
[INPUT] 1    0    [1    /1   ]  7.09631027058        1
[INPUT] 1    0    [1    /1   ]  23.0789507239        1
[INPUT] 1    0    [1    /1   ]  99.175119907         1
[INPUT] 1    0    [1    /1   ]  0.266086290061       1
[INPUT] 1    0    [1    /1   ]  2.43729698281        1
[INPUT] 1    0    [1    /1   ]  0.833120445559       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413349238, 1.0]], [0, [3661.4543024656614, 1.0]], [0, [833.2710952425523, 1.0]], [0, [235.81332600560947, 1.0]], [0, [75.51055710943795, 1.0]], [0, [9.851734426738833, 1.0]], [0, [26.537424501042004, 1.0]], [0, [0.37549497605714927, 1.0]], [0, [1.0890632178187458, 1.0]], [0, [2.7966314346721473, 1.0]], [1, [7.0963102705813474, 1.0]], [1, [23.078950723891047, 1.0]], [1, [99.17511990698324, 1.0]], [1, [0.26608629006101436, 1.0]], [1, [2.43729698280718, 1.0]], [1, [0.8331204455592397, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413349]
bas 1, expnt(s) = [3661.45430247]
bas 2, expnt(s) = [833.27109524]
bas 3, expnt(s) = [235.81332601]
bas 4, expnt(s) = [75.51055711]
bas 5, expnt(s) = [9.85173443]
bas 6, expnt(s) = [26.5374245]
bas 7, expnt(s) = [0.37549498]
bas 8, expnt(s) = [1.08906322]
bas 9, expnt(s) = [2.79663143]
bas 10, expnt(s) = [7.09631027]
bas 11, expnt(s) = [23.07895072]
bas 12, expnt(s) = [99.17511991]
bas 13, expnt(s) = [0.26608629]
bas 14, expnt(s) = [2.43729698]
bas 15, expnt(s) = [0.83312045]
CPU time:       353.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145430e+03 1.18920092e+03
 8.33271095e+02 3.91836386e+02 2.35813326e+02 1.52034196e+02
 7.55105571e+01 6.47173581e+01 9.85173443e+00 1.40491337e+01
 2.65374245e+01 2.95399056e+01 3.75494976e-01 1.21190373e+00
 1.08906322e+00 2.69342472e+00 2.79663143e+00 5.46375794e+00
 7.09631027e+00 3.37889843e+01 2.30789507e+01 1.47572171e+02
 9.91751199e+01 9.13035808e+02 2.66086290e-01 5.57522650e-01
 2.43729698e+00 8.88423333e+00 8.33120446e-01 2.32203699e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9995934922953
cond(S) = 335.532073583559
E1 = -183.5895207847292  E_coul = 55.08016870316111
init E= -128.509352081568
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401734912017  LUMO = 0.823736071795062
  mo_energy =
[-3.25550362e+01 -1.85260685e+00 -7.75401735e-01 -7.75401735e-01
 -7.75401735e-01  8.23736072e-01  8.23736072e-01  8.23736072e-01
  1.18408444e+00  3.95195532e+00  3.95195532e+00  3.95195532e+00
  7.13249996e+00  1.43288807e+01  1.43288807e+01  1.43288807e+01
  3.37935643e+01  5.28236034e+01  5.28236034e+01  5.28236034e+01
  1.36059163e+02  2.39451456e+02  2.39451456e+02  2.39451456e+02
  4.97810524e+02  1.86471178e+03  7.99482433e+03  4.77633844e+04]
E1 = -182.08727923147464  E_coul = 53.54948993375233
cycle= 1 E= -128.537789297722  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509407
diis-c [-0.25949556  1.        ]
  HOMO = -0.884165322827645  LUMO = 0.797069450073787
  mo_energy =
[-3.28778764e+01 -1.96642770e+00 -8.84165323e-01 -8.84165323e-01
 -8.84165323e-01  7.97069450e-01  7.97069450e-01  7.97069450e-01
  1.13992354e+00  3.85472781e+00  3.85472781e+00  3.85472781e+00
  7.00323351e+00  1.41386028e+01  1.41386028e+01  1.41386028e+01
  3.35484624e+01  5.25431894e+01  5.25431894e+01  5.25431894e+01
  1.35742152e+02  2.39105744e+02  2.39105744e+02  2.39105744e+02
  4.97449355e+02  1.86431459e+03  7.99439816e+03  4.77629394e+04]
E1 = -182.8478356025936  E_coul = 54.30746360316773
cycle= 2 E= -128.540371999426  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258522
diis-c [-6.40470293e-04  3.35849395e-01  6.64150605e-01]
  HOMO = -0.848568826175617  LUMO = 0.805783856345734
  mo_energy =
[-3.27698559e+01 -1.92893619e+00 -8.48568826e-01 -8.48568826e-01
 -8.48568826e-01  8.05783856e-01  8.05783856e-01  8.05783856e-01
  1.15410573e+00  3.88627730e+00  3.88627730e+00  3.88627730e+00
  7.04559500e+00  1.42016665e+01  1.42016665e+01  1.42016665e+01
  3.36305902e+01  5.26370555e+01  5.26370555e+01  5.26370555e+01
  1.35847996e+02  2.39219282e+02  2.39219282e+02  2.39219282e+02
  4.97566115e+02  1.86443660e+03  7.99452260e+03  4.77630647e+04]
E1 = -182.5895950752401  E_coul = 54.048305512990666
cycle= 3 E= -128.541289562249  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118008
diis-c [-1.26865154e-07 -2.26538032e-03 -1.02836375e-04  1.00236822e+00]
  HOMO = -0.848825299431225  LUMO = 0.805747010558811
  mo_energy =
[-3.27703282e+01 -1.92913487e+00 -8.48825299e-01 -8.48825299e-01
 -8.48825299e-01  8.05747011e-01  8.05747011e-01  8.05747011e-01
  1.15403188e+00  3.88609899e+00  3.88609899e+00  3.88609899e+00
  7.04538093e+00  1.42013581e+01  1.42013581e+01  1.42013581e+01
  3.36302277e+01  5.26366389e+01  5.26366389e+01  5.26366389e+01
  1.35847522e+02  2.39218739e+02  2.39218739e+02  2.39218739e+02
  4.97565515e+02  1.86443586e+03  7.99452177e+03  4.77630638e+04]
E1 = -182.59014049904735  E_coul = 54.04885091501137
cycle= 4 E= -128.541289584036  delta_E= -2.18e-08  |g|= 7.6e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186503
diis-c [-8.14683305e-10  1.95208444e-04  4.84539181e-04 -1.60785437e-01
  1.16010569e+00]
  HOMO = -0.848865207092248  LUMO = 0.805735094793203
  mo_energy =
[-3.27703998e+01 -1.92916636e+00 -8.48865207e-01 -8.48865207e-01
 -8.48865207e-01  8.05735095e-01  8.05735095e-01  8.05735095e-01
  1.15401501e+00  3.88606162e+00  3.88606162e+00  3.88606162e+00
  7.04533950e+00  1.42013019e+01  1.42013019e+01  1.42013019e+01
  3.36301653e+01  5.26365718e+01  5.26365718e+01  5.26365718e+01
  1.35847451e+02  2.39218664e+02  2.39218664e+02  2.39218664e+02
  4.97565435e+02  1.86443578e+03  7.99452168e+03  4.77630637e+04]
E1 = -182.59028421889005  E_coul = 54.04899463428852
cycle= 5 E= -128.541289584602  delta_E= -5.66e-10  |g|= 4.55e-06  |ddm|= 3.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59028421889005  E_coul = 54.04899463428852
  HOMO = -0.848863014386533  LUMO = 0.80573574811206
  mo_energy =
[-3.27703950e+01 -1.92916343e+00 -8.48863014e-01 -8.48863014e-01
 -8.48863014e-01  8.05735748e-01  8.05735748e-01  8.05735748e-01
  1.15401645e+00  3.88606374e+00  3.88606374e+00  3.88606374e+00
  7.04534251e+00  1.42013055e+01  1.42013055e+01  1.42013055e+01
  3.36301697e+01  5.26365763e+01  5.26365763e+01  5.26365763e+01
  1.35847455e+02  2.39218668e+02  2.39218668e+02  2.39218668e+02
  4.97565440e+02  1.86443578e+03  7.99452168e+03  4.77630637e+04]
E1 = -182.59027335590415  E_coul = 54.048983771301366
Extra cycle  E= -128.541289584603  delta_E= -1.25e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145430e+03 8.33271095e+02 2.35813326e+02
 7.55105571e+01 9.85173443e+00 2.65374245e+01 3.75494976e-01
 1.08906322e+00 2.79663143e+00 7.09631027e+00 2.30789507e+01
 9.91751199e+01 2.66086290e-01 2.43729698e+00 8.33120446e-01]
E = -128.5412895846028
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941335        1
[INPUT] 0    0    [1    /1   ]  3661.45430247        1
[INPUT] 0    0    [1    /1   ]  833.271095243        1
[INPUT] 0    0    [1    /1   ]  235.813326006        1
[INPUT] 0    0    [1    /1   ]  75.5105571094        1
[INPUT] 0    0    [1    /1   ]  9.85173442674        1
[INPUT] 0    0    [1    /1   ]  26.537424501         1
[INPUT] 0    0    [1    /1   ]  0.375494976057       1
[INPUT] 0    0    [1    /1   ]  1.08906321782        1
[INPUT] 0    0    [1    /1   ]  2.79663143467        1
[INPUT] 1    0    [1    /1   ]  7.09631027058        1
[INPUT] 1    0    [1    /1   ]  23.0789507239        1
[INPUT] 1    0    [1    /1   ]  99.175119907         1
[INPUT] 1    0    [1    /1   ]  0.266086290061       1
[INPUT] 1    0    [1    /1   ]  2.43729698281        1
[INPUT] 1    0    [1    /1   ]  0.833120445559       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413349238, 1.0]], [0, [3661.4543024656614, 1.0]], [0, [833.2710952425523, 1.0]], [0, [235.81332600560947, 1.0]], [0, [75.51055710943795, 1.0]], [0, [9.851734426738833, 1.0]], [0, [26.537424501042004, 1.0]], [0, [0.37549497605714927, 1.0]], [0, [1.0890632178187458, 1.0]], [0, [2.7966314346721473, 1.0]], [1, [7.0963102705813474, 1.0]], [1, [23.078950723891047, 1.0]], [1, [99.17511990698324, 1.0]], [1, [0.26608629006101436, 1.0]], [1, [2.43729698280718, 1.0]], [1, [0.8331204455592397, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413349]
bas 1, expnt(s) = [3661.45430247]
bas 2, expnt(s) = [833.27109524]
bas 3, expnt(s) = [235.81332601]
bas 4, expnt(s) = [75.51055711]
bas 5, expnt(s) = [9.85173443]
bas 6, expnt(s) = [26.5374245]
bas 7, expnt(s) = [0.37549498]
bas 8, expnt(s) = [1.08906322]
bas 9, expnt(s) = [2.79663143]
bas 10, expnt(s) = [7.09631027]
bas 11, expnt(s) = [23.07895072]
bas 12, expnt(s) = [99.17511991]
bas 13, expnt(s) = [0.26608629]
bas 14, expnt(s) = [2.43729698]
bas 15, expnt(s) = [0.83312045]
CPU time:       354.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145430e+03 1.18920092e+03
 8.33271095e+02 3.91836386e+02 2.35813326e+02 1.52034196e+02
 7.55105571e+01 6.47173581e+01 9.85173443e+00 1.40491337e+01
 2.65374245e+01 2.95399056e+01 3.75494976e-01 1.21190373e+00
 1.08906322e+00 2.69342472e+00 2.79663143e+00 5.46375794e+00
 7.09631027e+00 3.37889843e+01 2.30789507e+01 1.47572171e+02
 9.91751199e+01 9.13035808e+02 2.66086290e-01 5.57522650e-01
 2.43729698e+00 8.88423333e+00 8.33120446e-01 2.32203699e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9995934922953
cond(S) = 335.532073583559
E1 = -183.5895207847292  E_coul = 55.08016870316111
init E= -128.509352081568
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401734912017  LUMO = 0.823736071795062
  mo_energy =
[-3.25550362e+01 -1.85260685e+00 -7.75401735e-01 -7.75401735e-01
 -7.75401735e-01  8.23736072e-01  8.23736072e-01  8.23736072e-01
  1.18408444e+00  3.95195532e+00  3.95195532e+00  3.95195532e+00
  7.13249996e+00  1.43288807e+01  1.43288807e+01  1.43288807e+01
  3.37935643e+01  5.28236034e+01  5.28236034e+01  5.28236034e+01
  1.36059163e+02  2.39451456e+02  2.39451456e+02  2.39451456e+02
  4.97810524e+02  1.86471178e+03  7.99482433e+03  4.77633844e+04]
E1 = -182.08727923147464  E_coul = 53.54948993375233
cycle= 1 E= -128.537789297722  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509407
diis-c [-0.25949556  1.        ]
  HOMO = -0.884165322827645  LUMO = 0.797069450073787
  mo_energy =
[-3.28778764e+01 -1.96642770e+00 -8.84165323e-01 -8.84165323e-01
 -8.84165323e-01  7.97069450e-01  7.97069450e-01  7.97069450e-01
  1.13992354e+00  3.85472781e+00  3.85472781e+00  3.85472781e+00
  7.00323351e+00  1.41386028e+01  1.41386028e+01  1.41386028e+01
  3.35484624e+01  5.25431894e+01  5.25431894e+01  5.25431894e+01
  1.35742152e+02  2.39105744e+02  2.39105744e+02  2.39105744e+02
  4.97449355e+02  1.86431459e+03  7.99439816e+03  4.77629394e+04]
E1 = -182.8478356025936  E_coul = 54.30746360316773
cycle= 2 E= -128.540371999426  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258522
diis-c [-6.40470293e-04  3.35849395e-01  6.64150605e-01]
  HOMO = -0.848568826175617  LUMO = 0.805783856345734
  mo_energy =
[-3.27698559e+01 -1.92893619e+00 -8.48568826e-01 -8.48568826e-01
 -8.48568826e-01  8.05783856e-01  8.05783856e-01  8.05783856e-01
  1.15410573e+00  3.88627730e+00  3.88627730e+00  3.88627730e+00
  7.04559500e+00  1.42016665e+01  1.42016665e+01  1.42016665e+01
  3.36305902e+01  5.26370555e+01  5.26370555e+01  5.26370555e+01
  1.35847996e+02  2.39219282e+02  2.39219282e+02  2.39219282e+02
  4.97566115e+02  1.86443660e+03  7.99452260e+03  4.77630647e+04]
E1 = -182.5895950752401  E_coul = 54.048305512990666
cycle= 3 E= -128.541289562249  delta_E= -0.000918  |g|= 0.000507  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118008
diis-c [-1.26865154e-07 -2.26538032e-03 -1.02836375e-04  1.00236822e+00]
  HOMO = -0.848825299431225  LUMO = 0.805747010558811
  mo_energy =
[-3.27703282e+01 -1.92913487e+00 -8.48825299e-01 -8.48825299e-01
 -8.48825299e-01  8.05747011e-01  8.05747011e-01  8.05747011e-01
  1.15403188e+00  3.88609899e+00  3.88609899e+00  3.88609899e+00
  7.04538093e+00  1.42013581e+01  1.42013581e+01  1.42013581e+01
  3.36302277e+01  5.26366389e+01  5.26366389e+01  5.26366389e+01
  1.35847522e+02  2.39218739e+02  2.39218739e+02  2.39218739e+02
  4.97565515e+02  1.86443586e+03  7.99452177e+03  4.77630638e+04]
E1 = -182.59014049904735  E_coul = 54.04885091501137
cycle= 4 E= -128.541289584036  delta_E= -2.18e-08  |g|= 7.6e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186503
diis-c [-8.14683305e-10  1.95208444e-04  4.84539181e-04 -1.60785437e-01
  1.16010569e+00]
  HOMO = -0.848865207092248  LUMO = 0.805735094793203
  mo_energy =
[-3.27703998e+01 -1.92916636e+00 -8.48865207e-01 -8.48865207e-01
 -8.48865207e-01  8.05735095e-01  8.05735095e-01  8.05735095e-01
  1.15401501e+00  3.88606162e+00  3.88606162e+00  3.88606162e+00
  7.04533950e+00  1.42013019e+01  1.42013019e+01  1.42013019e+01
  3.36301653e+01  5.26365718e+01  5.26365718e+01  5.26365718e+01
  1.35847451e+02  2.39218664e+02  2.39218664e+02  2.39218664e+02
  4.97565435e+02  1.86443578e+03  7.99452168e+03  4.77630637e+04]
E1 = -182.59028421889005  E_coul = 54.04899463428852
cycle= 5 E= -128.541289584602  delta_E= -5.66e-10  |g|= 4.55e-06  |ddm|= 3.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59028421889005  E_coul = 54.04899463428852
  HOMO = -0.848863014386533  LUMO = 0.80573574811206
  mo_energy =
[-3.27703950e+01 -1.92916343e+00 -8.48863014e-01 -8.48863014e-01
 -8.48863014e-01  8.05735748e-01  8.05735748e-01  8.05735748e-01
  1.15401645e+00  3.88606374e+00  3.88606374e+00  3.88606374e+00
  7.04534251e+00  1.42013055e+01  1.42013055e+01  1.42013055e+01
  3.36301697e+01  5.26365763e+01  5.26365763e+01  5.26365763e+01
  1.35847455e+02  2.39218668e+02  2.39218668e+02  2.39218668e+02
  4.97565440e+02  1.86443578e+03  7.99452168e+03  4.77630637e+04]
E1 = -182.59027335590415  E_coul = 54.048983771301366
Extra cycle  E= -128.541289584603  delta_E= -1.25e-12  |g|= 1.56e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 335.532073583559
E1 = -182.59027335590415  E_coul = 54.048983771301366
init E= -128.541289584603
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.848863789127265  LUMO = 0.805735572752262
  mo_energy =
[-3.27703974e+01 -1.92916411e+00 -8.48863789e-01 -8.48863789e-01
 -8.48863789e-01  8.05735573e-01  8.05735573e-01  8.05735573e-01
  1.15401623e+00  3.88606307e+00  3.88606307e+00  3.88606307e+00
  7.04534166e+00  1.42013041e+01  1.42013041e+01  1.42013041e+01
  3.36301679e+01  5.26365742e+01  5.26365742e+01  5.26365742e+01
  1.35847453e+02  2.39218665e+02  2.39218665e+02  2.39218665e+02
  4.97565437e+02  1.86443578e+03  7.99452168e+03  4.77630637e+04]
E1 = -182.59027945122537  E_coul = 54.04898986662244
cycle= 1 E= -128.541289584603  delta_E= -1.42e-13  |g|= 8.41e-07  |ddm|= 5.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59027945122537  E_coul = 54.04898986662244
  HOMO = -0.84886336151258  LUMO = 0.805735680211889
  mo_energy =
[-3.27703961e+01 -1.92916363e+00 -8.48863362e-01 -8.48863362e-01
 -8.48863362e-01  8.05735680e-01  8.05735680e-01  8.05735680e-01
  1.15401642e+00  3.88606346e+00  3.88606346e+00  3.88606346e+00
  7.04534219e+00  1.42013049e+01  1.42013049e+01  1.42013049e+01
  3.36301689e+01  5.26365754e+01  5.26365754e+01  5.26365754e+01
  1.35847454e+02  2.39218667e+02  2.39218667e+02  2.39218667e+02
  4.97565438e+02  1.86443578e+03  7.99452168e+03  4.77630637e+04]
E1 = -182.5902764023099  E_coul = 54.04898681770685
Extra cycle  E= -128.541289584603  delta_E= -1.42e-13  |g|= 4.14e-07  |ddm|= 2.95e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [2.44137941e+04 3.66145430e+03 8.33271095e+02 2.35813326e+02
 7.55105571e+01 9.85173443e+00 2.65374245e+01 3.75494976e-01
 1.08906322e+00 2.79663143e+00 7.09631027e+00 2.30789507e+01
 9.91751199e+01 2.66086290e-01 2.43729698e+00 8.33120446e-01]
grad_E = [-1.70015333e-09  8.75477915e-08 -1.54954686e-06  1.20628189e-05
 -2.22897225e-05 -1.85191379e-05 -4.01863376e-06 -4.66141143e-05
  5.25854313e-05 -1.23804357e-05  2.23572625e-05 -3.14308035e-06
 -5.64170909e-07 -1.84476225e-06 -4.40580582e-05  2.70644083e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941347        1
[INPUT] 0    0    [1    /1   ]  3661.45424001        1
[INPUT] 0    0    [1    /1   ]  833.272188312        1
[INPUT] 0    0    [1    /1   ]  235.805319001        1
[INPUT] 0    0    [1    /1   ]  75.5185765041        1
[INPUT] 0    0    [1    /1   ]  9.86429974838        1
[INPUT] 0    0    [1    /1   ]  26.5588200148        1
[INPUT] 0    0    [1    /1   ]  0.376439631385       1
[INPUT] 0    0    [1    /1   ]  1.09321673193        1
[INPUT] 0    0    [1    /1   ]  2.80785678344        1
[INPUT] 1    0    [1    /1   ]  7.09856003592        1
[INPUT] 1    0    [1    /1   ]  23.082438999         1
[INPUT] 1    0    [1    /1   ]  99.1742850807        1
[INPUT] 1    0    [1    /1   ]  0.266106660414       1
[INPUT] 1    0    [1    /1   ]  2.43772979094        1
[INPUT] 1    0    [1    /1   ]  0.833191367638       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794134708703, 1.0]], [0, [3661.4542400061014, 1.0]], [0, [833.2721883119166, 1.0]], [0, [235.80531900124026, 1.0]], [0, [75.51857650405924, 1.0]], [0, [9.86429974838495, 1.0]], [0, [26.558820014751728, 1.0]], [0, [0.3764396313850977, 1.0]], [0, [1.0932167319280375, 1.0]], [0, [2.8078567834418866, 1.0]], [1, [7.098560035923088, 1.0]], [1, [23.08243899901057, 1.0]], [1, [99.17428508065774, 1.0]], [1, [0.26610666041440734, 1.0]], [1, [2.4377297909397724, 1.0]], [1, [0.8331913676383378, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413471]
bas 1, expnt(s) = [3661.45424001]
bas 2, expnt(s) = [833.27218831]
bas 3, expnt(s) = [235.805319]
bas 4, expnt(s) = [75.5185765]
bas 5, expnt(s) = [9.86429975]
bas 6, expnt(s) = [26.55882001]
bas 7, expnt(s) = [0.37643963]
bas 8, expnt(s) = [1.09321673]
bas 9, expnt(s) = [2.80785678]
bas 10, expnt(s) = [7.09856004]
bas 11, expnt(s) = [23.082439]
bas 12, expnt(s) = [99.17428508]
bas 13, expnt(s) = [0.26610666]
bas 14, expnt(s) = [2.43772979]
bas 15, expnt(s) = [0.83319137]
CPU time:       358.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145424e+03 1.18920091e+03
 8.33272188e+02 3.91836771e+02 2.35805319e+02 1.52030324e+02
 7.55185765e+01 6.47225129e+01 9.86429975e+00 1.40625707e+01
 2.65588200e+01 2.95577660e+01 3.76439631e-01 1.21418966e+00
 1.09321673e+00 2.70112528e+00 2.80785678e+00 5.48019786e+00
 7.09856004e+00 3.38023751e+01 2.30824390e+01 1.47600053e+02
 9.91742851e+01 9.13026201e+02 2.66106660e-01 5.57576002e-01
 2.43772979e+00 8.88620542e+00 8.33191368e-01 2.32228408e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999592144261673
cond(S) = 337.03332902364184
E1 = -183.58952589983105  E_coul = 55.08016691640184
init E= -128.509358983429
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401837580305  LUMO = 0.82382027124856
  mo_energy =
[-3.25550392e+01 -1.85260450e+00 -7.75401838e-01 -7.75401838e-01
 -7.75401838e-01  8.23820271e-01  8.23820271e-01  8.23820271e-01
  1.18932266e+00  3.95244345e+00  3.95244345e+00  3.95244345e+00
  7.16558951e+00  1.43322274e+01  1.43322274e+01  1.43322274e+01
  3.38871461e+01  5.28362031e+01  5.28362031e+01  5.28362031e+01
  1.36221456e+02  2.39469167e+02  2.39469167e+02  2.39469167e+02
  4.98006974e+02  1.86489444e+03  7.99498365e+03  4.77635162e+04]
E1 = -182.08734224802117  E_coul = 53.549552263646746
cycle= 1 E= -128.537789984374  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509384
diis-c [-0.25947214  1.        ]
  HOMO = -0.884160126685882  LUMO = 0.797152322180622
  mo_energy =
[-3.28778669e+01 -1.96642181e+00 -8.84160127e-01 -8.84160127e-01
 -8.84160127e-01  7.97152322e-01  7.97152322e-01  7.97152322e-01
  1.14497457e+00  3.85520783e+00  3.85520783e+00  3.85520783e+00
  7.03599743e+00  1.41419321e+01  1.41419321e+01  1.41419321e+01
  3.36419462e+01  5.25557894e+01  5.25557894e+01  5.25557894e+01
  1.35904445e+02  2.39123468e+02  2.39123468e+02  2.39123468e+02
  4.97645822e+02  1.86449726e+03  7.99455750e+03  4.77630712e+04]
E1 = -182.84786277371336  E_coul = 54.307490251445394
cycle= 2 E= -128.540372522268  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258508
diis-c [-6.40933371e-04  3.35847099e-01  6.64152901e-01]
  HOMO = -0.848565329420182  LUMO = 0.805867396150968
  mo_energy =
[-3.27698508e+01 -1.92893185e+00 -8.48565329e-01 -8.48565329e-01
 -8.48565329e-01  8.05867396e-01  8.05867396e-01  8.05867396e-01
  1.15921781e+00  3.88676004e+00  3.88676004e+00  3.88676004e+00
  7.07846820e+00  1.42050016e+01  1.42050016e+01  1.42050016e+01
  3.37241070e+01  5.26496553e+01  5.26496553e+01  5.26496553e+01
  1.36010288e+02  2.39237001e+02  2.39237001e+02  2.39237001e+02
  4.97762576e+02  1.86461927e+03  7.99468194e+03  4.77631966e+04]
E1 = -182.58963858307192  E_coul = 54.048348588579934
cycle= 3 E= -128.541289994492  delta_E= -0.000917  |g|= 0.000506  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117935
diis-c [-1.26403155e-07 -2.26467281e-03 -1.03459656e-04  1.00236813e+00]
  HOMO = -0.848821589098629  LUMO = 0.805830618216583
  mo_energy =
[-3.27703228e+01 -1.92913041e+00 -8.48821589e-01 -8.48821589e-01
 -8.48821589e-01  8.05830618e-01  8.05830618e-01  8.05830618e-01
  1.15914377e+00  3.88658189e+00  3.88658189e+00  3.88658189e+00
  7.07825381e+00  1.42046935e+01  1.42046935e+01  1.42046935e+01
  3.37237445e+01  5.26492390e+01  5.26492390e+01  5.26492390e+01
  1.36009815e+02  2.39236459e+02  2.39236459e+02  2.39236459e+02
  4.97761977e+02  1.86461853e+03  7.99468111e+03  4.77631957e+04]
E1 = -182.59018405767577  E_coul = 54.048894041466134
cycle= 4 E= -128.54129001621  delta_E= -2.17e-08  |g|= 7.59e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001863
diis-c [-8.11953352e-10  1.94830037e-04  4.84365916e-04 -1.60528977e-01
  1.15984978e+00]
  HOMO = -0.848861432407274  LUMO = 0.805818721878083
  mo_energy =
[-3.27703942e+01 -1.92916188e+00 -8.48861432e-01 -8.48861432e-01
 -8.48861432e-01  8.05818722e-01  8.05818722e-01  8.05818722e-01
  1.15912686e+00  3.88654457e+00  3.88654457e+00  3.88654457e+00
  7.07821235e+00  1.42046374e+01  1.42046374e+01  1.42046374e+01
  3.37236822e+01  5.26491719e+01  5.26491719e+01  5.26491719e+01
  1.36009744e+02  2.39236383e+02  2.39236383e+02  2.39236383e+02
  4.97761897e+02  1.86461845e+03  7.99468101e+03  4.77631956e+04]
E1 = -182.59032770680602  E_coul = 54.049037690033515
cycle= 5 E= -128.541290016773  delta_E= -5.63e-10  |g|= 4.54e-06  |ddm|= 3.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59032770680602  E_coul = 54.049037690033515
  HOMO = -0.848859245848028  LUMO = 0.805819373303349
  mo_energy =
[-3.27703895e+01 -1.92915895e+00 -8.48859246e-01 -8.48859246e-01
 -8.48859246e-01  8.05819373e-01  8.05819373e-01  8.05819373e-01
  1.15912830e+00  3.88654668e+00  3.88654668e+00  3.88654668e+00
  7.07821536e+00  1.42046409e+01  1.42046409e+01  1.42046409e+01
  3.37236866e+01  5.26491765e+01  5.26491765e+01  5.26491765e+01
  1.36009748e+02  2.39236387e+02  2.39236387e+02  2.39236387e+02
  4.97761901e+02  1.86461845e+03  7.99468102e+03  4.77631956e+04]
E1 = -182.59031686995542  E_coul = 54.04902685318139
Extra cycle  E= -128.541290016774  delta_E= -1.53e-12  |g|= 1.55e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145424e+03 8.33272188e+02 2.35805319e+02
 7.55185765e+01 9.86429975e+00 2.65588200e+01 3.76439631e-01
 1.09321673e+00 2.80785678e+00 7.09856004e+00 2.30824390e+01
 9.91742851e+01 2.66106660e-01 2.43772979e+00 8.33191368e-01]
E = -128.54129001677404
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941347        1
[INPUT] 0    0    [1    /1   ]  3661.45424001        1
[INPUT] 0    0    [1    /1   ]  833.272188312        1
[INPUT] 0    0    [1    /1   ]  235.805319001        1
[INPUT] 0    0    [1    /1   ]  75.5185765041        1
[INPUT] 0    0    [1    /1   ]  9.86429974838        1
[INPUT] 0    0    [1    /1   ]  26.5588200148        1
[INPUT] 0    0    [1    /1   ]  0.376439631385       1
[INPUT] 0    0    [1    /1   ]  1.09321673193        1
[INPUT] 0    0    [1    /1   ]  2.80785678344        1
[INPUT] 1    0    [1    /1   ]  7.09856003592        1
[INPUT] 1    0    [1    /1   ]  23.082438999         1
[INPUT] 1    0    [1    /1   ]  99.1742850807        1
[INPUT] 1    0    [1    /1   ]  0.266106660414       1
[INPUT] 1    0    [1    /1   ]  2.43772979094        1
[INPUT] 1    0    [1    /1   ]  0.833191367638       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794134708703, 1.0]], [0, [3661.4542400061014, 1.0]], [0, [833.2721883119166, 1.0]], [0, [235.80531900124026, 1.0]], [0, [75.51857650405924, 1.0]], [0, [9.86429974838495, 1.0]], [0, [26.558820014751728, 1.0]], [0, [0.3764396313850977, 1.0]], [0, [1.0932167319280375, 1.0]], [0, [2.8078567834418866, 1.0]], [1, [7.098560035923088, 1.0]], [1, [23.08243899901057, 1.0]], [1, [99.17428508065774, 1.0]], [1, [0.26610666041440734, 1.0]], [1, [2.4377297909397724, 1.0]], [1, [0.8331913676383378, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413471]
bas 1, expnt(s) = [3661.45424001]
bas 2, expnt(s) = [833.27218831]
bas 3, expnt(s) = [235.805319]
bas 4, expnt(s) = [75.5185765]
bas 5, expnt(s) = [9.86429975]
bas 6, expnt(s) = [26.55882001]
bas 7, expnt(s) = [0.37643963]
bas 8, expnt(s) = [1.09321673]
bas 9, expnt(s) = [2.80785678]
bas 10, expnt(s) = [7.09856004]
bas 11, expnt(s) = [23.082439]
bas 12, expnt(s) = [99.17428508]
bas 13, expnt(s) = [0.26610666]
bas 14, expnt(s) = [2.43772979]
bas 15, expnt(s) = [0.83319137]
CPU time:       359.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145424e+03 1.18920091e+03
 8.33272188e+02 3.91836771e+02 2.35805319e+02 1.52030324e+02
 7.55185765e+01 6.47225129e+01 9.86429975e+00 1.40625707e+01
 2.65588200e+01 2.95577660e+01 3.76439631e-01 1.21418966e+00
 1.09321673e+00 2.70112528e+00 2.80785678e+00 5.48019786e+00
 7.09856004e+00 3.38023751e+01 2.30824390e+01 1.47600053e+02
 9.91742851e+01 9.13026201e+02 2.66106660e-01 5.57576002e-01
 2.43772979e+00 8.88620542e+00 8.33191368e-01 2.32228408e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999592144261673
cond(S) = 337.03332902364184
E1 = -183.58952589983105  E_coul = 55.08016691640184
init E= -128.509358983429
    CPU time for initialize scf      0.03 sec, wall time      0.05 sec
  HOMO = -0.775401837580305  LUMO = 0.82382027124856
  mo_energy =
[-3.25550392e+01 -1.85260450e+00 -7.75401838e-01 -7.75401838e-01
 -7.75401838e-01  8.23820271e-01  8.23820271e-01  8.23820271e-01
  1.18932266e+00  3.95244345e+00  3.95244345e+00  3.95244345e+00
  7.16558951e+00  1.43322274e+01  1.43322274e+01  1.43322274e+01
  3.38871461e+01  5.28362031e+01  5.28362031e+01  5.28362031e+01
  1.36221456e+02  2.39469167e+02  2.39469167e+02  2.39469167e+02
  4.98006974e+02  1.86489444e+03  7.99498365e+03  4.77635162e+04]
E1 = -182.08734224802117  E_coul = 53.549552263646746
cycle= 1 E= -128.537789984374  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509384
diis-c [-0.25947214  1.        ]
  HOMO = -0.884160126685882  LUMO = 0.797152322180622
  mo_energy =
[-3.28778669e+01 -1.96642181e+00 -8.84160127e-01 -8.84160127e-01
 -8.84160127e-01  7.97152322e-01  7.97152322e-01  7.97152322e-01
  1.14497457e+00  3.85520783e+00  3.85520783e+00  3.85520783e+00
  7.03599743e+00  1.41419321e+01  1.41419321e+01  1.41419321e+01
  3.36419462e+01  5.25557894e+01  5.25557894e+01  5.25557894e+01
  1.35904445e+02  2.39123468e+02  2.39123468e+02  2.39123468e+02
  4.97645822e+02  1.86449726e+03  7.99455750e+03  4.77630712e+04]
E1 = -182.84786277371336  E_coul = 54.307490251445394
cycle= 2 E= -128.540372522268  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0662
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258508
diis-c [-6.40933371e-04  3.35847099e-01  6.64152901e-01]
  HOMO = -0.848565329420182  LUMO = 0.805867396150968
  mo_energy =
[-3.27698508e+01 -1.92893185e+00 -8.48565329e-01 -8.48565329e-01
 -8.48565329e-01  8.05867396e-01  8.05867396e-01  8.05867396e-01
  1.15921781e+00  3.88676004e+00  3.88676004e+00  3.88676004e+00
  7.07846820e+00  1.42050016e+01  1.42050016e+01  1.42050016e+01
  3.37241070e+01  5.26496553e+01  5.26496553e+01  5.26496553e+01
  1.36010288e+02  2.39237001e+02  2.39237001e+02  2.39237001e+02
  4.97762576e+02  1.86461927e+03  7.99468194e+03  4.77631966e+04]
E1 = -182.58963858307192  E_coul = 54.048348588579934
cycle= 3 E= -128.541289994492  delta_E= -0.000917  |g|= 0.000506  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117935
diis-c [-1.26403155e-07 -2.26467281e-03 -1.03459656e-04  1.00236813e+00]
  HOMO = -0.848821589098629  LUMO = 0.805830618216583
  mo_energy =
[-3.27703228e+01 -1.92913041e+00 -8.48821589e-01 -8.48821589e-01
 -8.48821589e-01  8.05830618e-01  8.05830618e-01  8.05830618e-01
  1.15914377e+00  3.88658189e+00  3.88658189e+00  3.88658189e+00
  7.07825381e+00  1.42046935e+01  1.42046935e+01  1.42046935e+01
  3.37237445e+01  5.26492390e+01  5.26492390e+01  5.26492390e+01
  1.36009815e+02  2.39236459e+02  2.39236459e+02  2.39236459e+02
  4.97761977e+02  1.86461853e+03  7.99468111e+03  4.77631957e+04]
E1 = -182.59018405767577  E_coul = 54.048894041466134
cycle= 4 E= -128.54129001621  delta_E= -2.17e-08  |g|= 7.59e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001863
diis-c [-8.11953352e-10  1.94830037e-04  4.84365916e-04 -1.60528977e-01
  1.15984978e+00]
  HOMO = -0.848861432407274  LUMO = 0.805818721878083
  mo_energy =
[-3.27703942e+01 -1.92916188e+00 -8.48861432e-01 -8.48861432e-01
 -8.48861432e-01  8.05818722e-01  8.05818722e-01  8.05818722e-01
  1.15912686e+00  3.88654457e+00  3.88654457e+00  3.88654457e+00
  7.07821235e+00  1.42046374e+01  1.42046374e+01  1.42046374e+01
  3.37236822e+01  5.26491719e+01  5.26491719e+01  5.26491719e+01
  1.36009744e+02  2.39236383e+02  2.39236383e+02  2.39236383e+02
  4.97761897e+02  1.86461845e+03  7.99468101e+03  4.77631956e+04]
E1 = -182.59032770680602  E_coul = 54.049037690033515
cycle= 5 E= -128.541290016773  delta_E= -5.63e-10  |g|= 4.54e-06  |ddm|= 3.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59032770680602  E_coul = 54.049037690033515
  HOMO = -0.848859245848028  LUMO = 0.805819373303349
  mo_energy =
[-3.27703895e+01 -1.92915895e+00 -8.48859246e-01 -8.48859246e-01
 -8.48859246e-01  8.05819373e-01  8.05819373e-01  8.05819373e-01
  1.15912830e+00  3.88654668e+00  3.88654668e+00  3.88654668e+00
  7.07821536e+00  1.42046409e+01  1.42046409e+01  1.42046409e+01
  3.37236866e+01  5.26491765e+01  5.26491765e+01  5.26491765e+01
  1.36009748e+02  2.39236387e+02  2.39236387e+02  2.39236387e+02
  4.97761901e+02  1.86461845e+03  7.99468102e+03  4.77631956e+04]
E1 = -182.59031686995542  E_coul = 54.04902685318139
Extra cycle  E= -128.541290016774  delta_E= -1.53e-12  |g|= 1.55e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.03332902364184
E1 = -182.59031686995542  E_coul = 54.04902685318139
init E= -128.541290016774
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.84886001873857  LUMO = 0.805819198317327
  mo_energy =
[-3.27703919e+01 -1.92915963e+00 -8.48860019e-01 -8.48860019e-01
 -8.48860019e-01  8.05819198e-01  8.05819198e-01  8.05819198e-01
  1.15912808e+00  3.88654602e+00  3.88654602e+00  3.88654602e+00
  7.07821451e+00  1.42046396e+01  1.42046396e+01  1.42046396e+01
  3.37236848e+01  5.26491744e+01  5.26491744e+01  5.26491744e+01
  1.36009746e+02  2.39236385e+02  2.39236385e+02  2.39236385e+02
  4.97761899e+02  1.86461845e+03  7.99468101e+03  4.77631956e+04]
E1 = -182.59032294978672  E_coul = 54.049032933012235
cycle= 1 E= -128.541290016774  delta_E= -4.55e-13  |g|= 8.39e-07  |ddm|= 5.72e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59032294978672  E_coul = 54.049032933012235
  HOMO = -0.848859592212074  LUMO = 0.80581930551469
  mo_energy =
[-3.27703906e+01 -1.92915915e+00 -8.48859592e-01 -8.48859592e-01
 -8.48859592e-01  8.05819306e-01  8.05819306e-01  8.05819306e-01
  1.15912827e+00  3.88654640e+00  3.88654640e+00  3.88654640e+00
  7.07821504e+00  1.42046403e+01  1.42046403e+01  1.42046403e+01
  3.37236858e+01  5.26491755e+01  5.26491755e+01  5.26491755e+01
  1.36009747e+02  2.39236386e+02  2.39236386e+02  2.39236386e+02
  4.97761900e+02  1.86461845e+03  7.99468102e+03  4.77631956e+04]
E1 = -182.59031990861473  E_coul = 54.04902989184015
Extra cycle  E= -128.541290016775  delta_E= -8.53e-14  |g|= 4.13e-07  |ddm|= 2.94e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145424e+03 8.33272188e+02 2.35805319e+02
 7.55185765e+01 9.86429975e+00 2.65588200e+01 3.76439631e-01
 1.09321673e+00 2.80785678e+00 7.09856004e+00 2.30824390e+01
 9.91742851e+01 2.66106660e-01 2.43772979e+00 8.33191368e-01]
grad_E = [-1.72966766e-09  8.91534357e-08 -1.58488275e-06  1.25556859e-05
 -2.59819522e-05 -2.41878506e-05  4.92870999e-06 -7.47044936e-05
  8.94036529e-05 -1.38846642e-05  3.66662767e-05 -5.11618904e-06
 -5.35797048e-07 -4.57621848e-07 -7.09114836e-05  4.10338527e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941384        1
[INPUT] 0    0    [1    /1   ]  3661.45404868        1
[INPUT] 0    0    [1    /1   ]  833.275550588        1
[INPUT] 0    0    [1    /1   ]  235.780021952        1
[INPUT] 0    0    [1    /1   ]  75.5534418713        1
[INPUT] 0    0    [1    /1   ]  9.88765125435        1
[INPUT] 0    0    [1    /1   ]  26.6038391811        1
[INPUT] 0    0    [1    /1   ]  0.377954909143       1
[INPUT] 0    0    [1    /1   ]  1.09994131889        1
[INPUT] 0    0    [1    /1   ]  2.82633369962        1
[INPUT] 1    0    [1    /1   ]  7.10249290861        1
[INPUT] 1    0    [1    /1   ]  23.0908772615        1
[INPUT] 1    0    [1    /1   ]  99.195207367         1
[INPUT] 1    0    [1    /1   ]  0.266148039036       1
[INPUT] 1    0    [1    /1   ]  2.43854486433        1
[INPUT] 1    0    [1    /1   ]  0.833346511126       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413842999, 1.0]], [0, [3661.454048675527, 1.0]], [0, [833.2755505875491, 1.0]], [0, [235.78002195206, 1.0]], [0, [75.55344187133896, 1.0]], [0, [9.887651254353141, 1.0]], [0, [26.603839181072345, 1.0]], [0, [0.3779549091426739, 1.0]], [0, [1.0999413188892562, 1.0]], [0, [2.826333699621565, 1.0]], [1, [7.102492908605044, 1.0]], [1, [23.090877261454324, 1.0]], [1, [99.19520736696295, 1.0]], [1, [0.26614803903643264, 1.0]], [1, [2.4385448643336027, 1.0]], [1, [0.8333465111262032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413843]
bas 1, expnt(s) = [3661.45404868]
bas 2, expnt(s) = [833.27555059]
bas 3, expnt(s) = [235.78002195]
bas 4, expnt(s) = [75.55344187]
bas 5, expnt(s) = [9.88765125]
bas 6, expnt(s) = [26.60383918]
bas 7, expnt(s) = [0.37795491]
bas 8, expnt(s) = [1.09994132]
bas 9, expnt(s) = [2.8263337]
bas 10, expnt(s) = [7.10249291]
bas 11, expnt(s) = [23.09087726]
bas 12, expnt(s) = [99.19520737]
bas 13, expnt(s) = [0.26614804]
bas 14, expnt(s) = [2.43854486]
bas 15, expnt(s) = [0.83334651]
CPU time:       363.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145405e+03 1.18920086e+03
 8.33275551e+02 3.91837957e+02 2.35780022e+02 1.52018092e+02
 7.55534419e+01 6.47449224e+01 9.88765125e+00 1.40875308e+01
 2.66038392e+01 2.95953350e+01 3.77954909e-01 1.21785341e+00
 1.09994132e+00 2.71357708e+00 2.82633370e+00 5.50722223e+00
 7.10249291e+00 3.38257865e+01 2.30908773e+01 1.47667504e+02
 9.91952074e+01 9.13266978e+02 2.66148039e-01 5.57684380e-01
 2.43854486e+00 8.88991954e+00 8.33346511e-01 2.32282461e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999589832496593
cond(S) = 339.44358589499075
E1 = -183.58952871832253  E_coul = 55.08016439154596
init E= -128.509364326777
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401985004404  LUMO = 0.823992566157474
  mo_energy =
[-3.25550442e+01 -1.85260052e+00 -7.75401985e-01 -7.75401985e-01
 -7.75401985e-01  8.23992566e-01  8.23992566e-01  8.23992566e-01
  1.19780650e+00  3.95343994e+00  3.95343994e+00  3.95343994e+00
  7.21987244e+00  1.43383868e+01  1.43383868e+01  1.43383868e+01
  3.40490089e+01  5.28614794e+01  5.28614794e+01  5.28614794e+01
  1.36533012e+02  2.39545350e+02  2.39545350e+02  2.39545350e+02
  4.98419402e+02  1.86528473e+03  7.99532314e+03  4.77637971e+04]
E1 = -182.08745088573116  E_coul = 53.54965943385761
cycle= 1 E= -128.537791451874  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509335
diis-c [-0.25942231  1.        ]
  HOMO = -0.884151234373352  LUMO = 0.79732107627281
  mo_energy =
[-3.28778505e+01 -1.96641165e+00 -8.84151234e-01 -8.84151234e-01
 -8.84151234e-01  7.97321076e-01  7.97321076e-01  7.97321076e-01
  1.15315499e+00  3.85618754e+00  3.85618754e+00  3.85618754e+00
  7.08974158e+00  1.41480596e+01  1.41480596e+01  1.41480596e+01
  3.38036230e+01  5.25810597e+01  5.25810597e+01  5.25810597e+01
  1.36215988e+02  2.39199666e+02  2.39199666e+02  2.39199666e+02
  4.98058278e+02  1.86488758e+03  7.99489702e+03  4.77633521e+04]
E1 = -182.84791034623123  E_coul = 54.307536633464444
cycle= 2 E= -128.540373712767  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.25848
diis-c [-6.41697679e-04  3.35843020e-01  6.64156980e-01]
  HOMO = -0.848559317147409  LUMO = 0.806037722908493
  mo_energy =
[-3.27698418e+01 -1.92892433e+00 -8.48559317e-01 -8.48559317e-01
 -8.48559317e-01  8.06037723e-01  8.06037723e-01  8.06037723e-01
  1.16749727e+00  3.88774540e+00  3.88774540e+00  3.88774540e+00
  7.13239328e+00  1.42111400e+01  1.42111400e+01  1.42111400e+01
  3.38858466e+01  5.26749273e+01  5.26749273e+01  5.26749273e+01
  1.36321834e+02  2.39313194e+02  2.39313194e+02  2.39313194e+02
  4.98175023e+02  1.86500958e+03  7.99502145e+03  4.77634775e+04]
E1 = -182.5897141904979  E_coul = 54.0484231605787
cycle= 3 E= -128.541291029919  delta_E= -0.000917  |g|= 0.000505  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117808
diis-c [-1.25651505e-07 -2.26328006e-03 -1.04149409e-04  1.00236743e+00]
  HOMO = -0.848815206988643  LUMO = 0.806001061263215
  mo_energy =
[-3.27703133e+01 -1.92912269e+00 -8.48815207e-01 -8.48815207e-01
 -8.48815207e-01  8.06001061e-01  8.06001061e-01  8.06001061e-01
  1.16742293e+00  3.88756752e+00  3.88756752e+00  3.88756752e+00
  7.13217839e+00  1.42108323e+01  1.42108323e+01  1.42108323e+01
  3.38854843e+01  5.26745115e+01  5.26745115e+01  5.26745115e+01
  1.36321361e+02  2.39312652e+02  2.39312652e+02  2.39312652e+02
  4.98174423e+02  1.86500884e+03  7.99502062e+03  4.77634766e+04]
E1 = -182.5902597539893  E_coul = 54.04896870246745
cycle= 4 E= -128.541291051522  delta_E= -2.16e-08  |g|= 7.57e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185959
diis-c [-8.07481584e-10  1.94225992e-04  4.84050552e-04 -1.60123626e-01
  1.15944535e+00]
  HOMO = -0.848854942169028  LUMO = 0.805989197183575
  mo_energy =
[-3.27703847e+01 -1.92915410e+00 -8.48854942e-01 -8.48854942e-01
 -8.48854942e-01  8.05989197e-01  8.05989197e-01  8.05989197e-01
  1.16740597e+00  3.88753029e+00  3.88753029e+00  3.88753029e+00
  7.13213689e+00  1.42107763e+01  1.42107763e+01  1.42107763e+01
  3.38854222e+01  5.26744445e+01  5.26744445e+01  5.26744445e+01
  1.36321289e+02  2.39312576e+02  2.39312576e+02  2.39312576e+02
  4.98174344e+02  1.86500876e+03  7.99502052e+03  4.77634765e+04]
E1 = -182.590403284497  E_coul = 54.04911223241653
cycle= 5 E= -128.54129105208  delta_E= -5.59e-10  |g|= 4.52e-06  |ddm|= 3.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.590403284497  E_coul = 54.04911223241653
  HOMO = -0.84885276528758  LUMO = 0.805989845656458
  mo_energy =
[-3.27703799e+01 -1.92915119e+00 -8.48852765e-01 -8.48852765e-01
 -8.48852765e-01  8.05989846e-01  8.05989846e-01  8.05989846e-01
  1.16740741e+00  3.88753239e+00  3.88753239e+00  3.88753239e+00
  7.13213989e+00  1.42107799e+01  1.42107799e+01  1.42107799e+01
  3.38854265e+01  5.26744491e+01  5.26744491e+01  5.26744491e+01
  1.36321294e+02  2.39312581e+02  2.39312581e+02  2.39312581e+02
  4.98174348e+02  1.86500876e+03  7.99502053e+03  4.77634765e+04]
E1 = -182.59039248866915  E_coul = 54.04910143658725
Extra cycle  E= -128.541291052082  delta_E= -1.45e-12  |g|= 1.55e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145405e+03 8.33275551e+02 2.35780022e+02
 7.55534419e+01 9.88765125e+00 2.66038392e+01 3.77954909e-01
 1.09994132e+00 2.82633370e+00 7.10249291e+00 2.30908773e+01
 9.91952074e+01 2.66148039e-01 2.43854486e+00 8.33346511e-01]
E = -128.5412910520819
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941384        1
[INPUT] 0    0    [1    /1   ]  3661.45404868        1
[INPUT] 0    0    [1    /1   ]  833.275550588        1
[INPUT] 0    0    [1    /1   ]  235.780021952        1
[INPUT] 0    0    [1    /1   ]  75.5534418713        1
[INPUT] 0    0    [1    /1   ]  9.88765125435        1
[INPUT] 0    0    [1    /1   ]  26.6038391811        1
[INPUT] 0    0    [1    /1   ]  0.377954909143       1
[INPUT] 0    0    [1    /1   ]  1.09994131889        1
[INPUT] 0    0    [1    /1   ]  2.82633369962        1
[INPUT] 1    0    [1    /1   ]  7.10249290861        1
[INPUT] 1    0    [1    /1   ]  23.0908772615        1
[INPUT] 1    0    [1    /1   ]  99.195207367         1
[INPUT] 1    0    [1    /1   ]  0.266148039036       1
[INPUT] 1    0    [1    /1   ]  2.43854486433        1
[INPUT] 1    0    [1    /1   ]  0.833346511126       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79413842999, 1.0]], [0, [3661.454048675527, 1.0]], [0, [833.2755505875491, 1.0]], [0, [235.78002195206, 1.0]], [0, [75.55344187133896, 1.0]], [0, [9.887651254353141, 1.0]], [0, [26.603839181072345, 1.0]], [0, [0.3779549091426739, 1.0]], [0, [1.0999413188892562, 1.0]], [0, [2.826333699621565, 1.0]], [1, [7.102492908605044, 1.0]], [1, [23.090877261454324, 1.0]], [1, [99.19520736696295, 1.0]], [1, [0.26614803903643264, 1.0]], [1, [2.4385448643336027, 1.0]], [1, [0.8333465111262032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413843]
bas 1, expnt(s) = [3661.45404868]
bas 2, expnt(s) = [833.27555059]
bas 3, expnt(s) = [235.78002195]
bas 4, expnt(s) = [75.55344187]
bas 5, expnt(s) = [9.88765125]
bas 6, expnt(s) = [26.60383918]
bas 7, expnt(s) = [0.37795491]
bas 8, expnt(s) = [1.09994132]
bas 9, expnt(s) = [2.8263337]
bas 10, expnt(s) = [7.10249291]
bas 11, expnt(s) = [23.09087726]
bas 12, expnt(s) = [99.19520737]
bas 13, expnt(s) = [0.26614804]
bas 14, expnt(s) = [2.43854486]
bas 15, expnt(s) = [0.83334651]
CPU time:       364.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145405e+03 1.18920086e+03
 8.33275551e+02 3.91837957e+02 2.35780022e+02 1.52018092e+02
 7.55534419e+01 6.47449224e+01 9.88765125e+00 1.40875308e+01
 2.66038392e+01 2.95953350e+01 3.77954909e-01 1.21785341e+00
 1.09994132e+00 2.71357708e+00 2.82633370e+00 5.50722223e+00
 7.10249291e+00 3.38257865e+01 2.30908773e+01 1.47667504e+02
 9.91952074e+01 9.13266978e+02 2.66148039e-01 5.57684380e-01
 2.43854486e+00 8.88991954e+00 8.33346511e-01 2.32282461e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999589832496593
cond(S) = 339.44358589499075
E1 = -183.58952871832253  E_coul = 55.08016439154596
init E= -128.509364326777
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401985004404  LUMO = 0.823992566157474
  mo_energy =
[-3.25550442e+01 -1.85260052e+00 -7.75401985e-01 -7.75401985e-01
 -7.75401985e-01  8.23992566e-01  8.23992566e-01  8.23992566e-01
  1.19780650e+00  3.95343994e+00  3.95343994e+00  3.95343994e+00
  7.21987244e+00  1.43383868e+01  1.43383868e+01  1.43383868e+01
  3.40490089e+01  5.28614794e+01  5.28614794e+01  5.28614794e+01
  1.36533012e+02  2.39545350e+02  2.39545350e+02  2.39545350e+02
  4.98419402e+02  1.86528473e+03  7.99532314e+03  4.77637971e+04]
E1 = -182.08745088573116  E_coul = 53.54965943385761
cycle= 1 E= -128.537791451874  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509335
diis-c [-0.25942231  1.        ]
  HOMO = -0.884151234373352  LUMO = 0.79732107627281
  mo_energy =
[-3.28778505e+01 -1.96641165e+00 -8.84151234e-01 -8.84151234e-01
 -8.84151234e-01  7.97321076e-01  7.97321076e-01  7.97321076e-01
  1.15315499e+00  3.85618754e+00  3.85618754e+00  3.85618754e+00
  7.08974158e+00  1.41480596e+01  1.41480596e+01  1.41480596e+01
  3.38036230e+01  5.25810597e+01  5.25810597e+01  5.25810597e+01
  1.36215988e+02  2.39199666e+02  2.39199666e+02  2.39199666e+02
  4.98058278e+02  1.86488758e+03  7.99489702e+03  4.77633521e+04]
E1 = -182.84791034623123  E_coul = 54.307536633464444
cycle= 2 E= -128.540373712767  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25848
diis-c [-6.41697679e-04  3.35843020e-01  6.64156980e-01]
  HOMO = -0.848559317147409  LUMO = 0.806037722908493
  mo_energy =
[-3.27698418e+01 -1.92892433e+00 -8.48559317e-01 -8.48559317e-01
 -8.48559317e-01  8.06037723e-01  8.06037723e-01  8.06037723e-01
  1.16749727e+00  3.88774540e+00  3.88774540e+00  3.88774540e+00
  7.13239328e+00  1.42111400e+01  1.42111400e+01  1.42111400e+01
  3.38858466e+01  5.26749273e+01  5.26749273e+01  5.26749273e+01
  1.36321834e+02  2.39313194e+02  2.39313194e+02  2.39313194e+02
  4.98175023e+02  1.86500958e+03  7.99502145e+03  4.77634775e+04]
E1 = -182.5897141904979  E_coul = 54.0484231605787
cycle= 3 E= -128.541291029919  delta_E= -0.000917  |g|= 0.000505  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117808
diis-c [-1.25651505e-07 -2.26328006e-03 -1.04149409e-04  1.00236743e+00]
  HOMO = -0.848815206988643  LUMO = 0.806001061263215
  mo_energy =
[-3.27703133e+01 -1.92912269e+00 -8.48815207e-01 -8.48815207e-01
 -8.48815207e-01  8.06001061e-01  8.06001061e-01  8.06001061e-01
  1.16742293e+00  3.88756752e+00  3.88756752e+00  3.88756752e+00
  7.13217839e+00  1.42108323e+01  1.42108323e+01  1.42108323e+01
  3.38854843e+01  5.26745115e+01  5.26745115e+01  5.26745115e+01
  1.36321361e+02  2.39312652e+02  2.39312652e+02  2.39312652e+02
  4.98174423e+02  1.86500884e+03  7.99502062e+03  4.77634766e+04]
E1 = -182.5902597539893  E_coul = 54.04896870246745
cycle= 4 E= -128.541291051522  delta_E= -2.16e-08  |g|= 7.57e-05  |ddm|= 0.000219
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185959
diis-c [-8.07481584e-10  1.94225992e-04  4.84050552e-04 -1.60123626e-01
  1.15944535e+00]
  HOMO = -0.848854942169028  LUMO = 0.805989197183575
  mo_energy =
[-3.27703847e+01 -1.92915410e+00 -8.48854942e-01 -8.48854942e-01
 -8.48854942e-01  8.05989197e-01  8.05989197e-01  8.05989197e-01
  1.16740597e+00  3.88753029e+00  3.88753029e+00  3.88753029e+00
  7.13213689e+00  1.42107763e+01  1.42107763e+01  1.42107763e+01
  3.38854222e+01  5.26744445e+01  5.26744445e+01  5.26744445e+01
  1.36321289e+02  2.39312576e+02  2.39312576e+02  2.39312576e+02
  4.98174344e+02  1.86500876e+03  7.99502052e+03  4.77634765e+04]
E1 = -182.590403284497  E_coul = 54.04911223241653
cycle= 5 E= -128.54129105208  delta_E= -5.59e-10  |g|= 4.52e-06  |ddm|= 3.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.590403284497  E_coul = 54.04911223241653
  HOMO = -0.84885276528758  LUMO = 0.805989845656458
  mo_energy =
[-3.27703799e+01 -1.92915119e+00 -8.48852765e-01 -8.48852765e-01
 -8.48852765e-01  8.05989846e-01  8.05989846e-01  8.05989846e-01
  1.16740741e+00  3.88753239e+00  3.88753239e+00  3.88753239e+00
  7.13213989e+00  1.42107799e+01  1.42107799e+01  1.42107799e+01
  3.38854265e+01  5.26744491e+01  5.26744491e+01  5.26744491e+01
  1.36321294e+02  2.39312581e+02  2.39312581e+02  2.39312581e+02
  4.98174348e+02  1.86500876e+03  7.99502053e+03  4.77634765e+04]
E1 = -182.59039248866915  E_coul = 54.04910143658725
Extra cycle  E= -128.541291052082  delta_E= -1.45e-12  |g|= 1.55e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 339.44358589499075
E1 = -182.59039248866915  E_coul = 54.04910143658725
init E= -128.541291052082
    CPU time for initialize scf      0.30 sec, wall time      0.31 sec
  HOMO = -0.848853535269986  LUMO = 0.805989671244441
  mo_energy =
[-3.27703823e+01 -1.92915187e+00 -8.48853535e-01 -8.48853535e-01
 -8.48853535e-01  8.05989671e-01  8.05989671e-01  8.05989671e-01
  1.16740719e+00  3.88753173e+00  3.88753173e+00  3.88753173e+00
  7.13213905e+00  1.42107785e+01  1.42107785e+01  1.42107785e+01
  3.38854247e+01  5.26744470e+01  5.26744470e+01  5.26744470e+01
  1.36321292e+02  2.39312578e+02  2.39312578e+02  2.39312578e+02
  4.98174346e+02  1.86500876e+03  7.99502052e+03  4.77634765e+04]
E1 = -182.59039854409983  E_coul = 54.049107492017725
cycle= 1 E= -128.541291052082  delta_E= -1.99e-13  |g|= 8.36e-07  |ddm|= 5.69e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59039854409983  E_coul = 54.049107492017725
  HOMO = -0.848853110457152  LUMO = 0.805989778034951
  mo_energy =
[-3.27703811e+01 -1.92915139e+00 -8.48853110e-01 -8.48853110e-01
 -8.48853110e-01  8.05989778e-01  8.05989778e-01  8.05989778e-01
  1.16740738e+00  3.88753211e+00  3.88753211e+00  3.88753211e+00
  7.13213957e+00  1.42107793e+01  1.42107793e+01  1.42107793e+01
  3.38854257e+01  5.26744481e+01  5.26744481e+01  5.26744481e+01
  1.36321293e+02  2.39312579e+02  2.39312579e+02  2.39312579e+02
  4.98174347e+02  1.86500876e+03  7.99502053e+03  4.77634765e+04]
E1 = -182.59039551512345  E_coul = 54.04910446304087
Extra cycle  E= -128.541291052083  delta_E= -4.83e-13  |g|= 4.11e-07  |ddm|= 2.94e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.38 sec
exp = [2.44137941e+04 3.66145405e+03 8.33275551e+02 2.35780022e+02
 7.55534419e+01 9.88765125e+00 2.66038392e+01 3.77954909e-01
 1.09994132e+00 2.82633370e+00 7.10249291e+00 2.30908773e+01
 9.91952074e+01 2.66148039e-01 2.43854486e+00 8.33346511e-01]
grad_E = [-1.70639750e-09  8.81001674e-08 -1.57840706e-06  1.28327084e-05
 -3.03686386e-05 -3.17183152e-05  1.78962368e-05 -1.13441642e-04
  1.41151167e-04 -1.57581957e-05  5.65580867e-05 -7.86361224e-06
 -4.73028163e-07  2.07835285e-06 -1.07936682e-04  5.96975255e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941476        1
[INPUT] 0    0    [1    /1   ]  3661.45357783        1
[INPUT] 0    0    [1    /1   ]  833.283841072        1
[INPUT] 0    0    [1    /1   ]  235.716870174        1
[INPUT] 0    0    [1    /1   ]  75.6512667413        1
[INPUT] 0    0    [1    /1   ]  9.92740464542        1
[INPUT] 0    0    [1    /1   ]  26.6906494745        1
[INPUT] 0    0    [1    /1   ]  0.380051816679       1
[INPUT] 0    0    [1    /1   ]  1.10940750884        1
[INPUT] 0    0    [1    /1   ]  2.8531266714         1
[INPUT] 1    0    [1    /1   ]  7.10863514067        1
[INPUT] 1    0    [1    /1   ]  23.1089826502        1
[INPUT] 1    0    [1    /1   ]  99.2748911703        1
[INPUT] 1    0    [1    /1   ]  0.266224719967       1
[INPUT] 1    0    [1    /1   ]  2.43993536496        1
[INPUT] 1    0    [1    /1   ]  0.833653125583       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79414758234, 1.0]], [0, [3661.453577827247, 1.0]], [0, [833.2838410723723, 1.0]], [0, [235.71687017362393, 1.0]], [0, [75.65126674126297, 1.0]], [0, [9.92740464542147, 1.0]], [0, [26.69064947452206, 1.0]], [0, [0.3800518166785283, 1.0]], [0, [1.1094075088365285, 1.0]], [0, [2.8531266714019012, 1.0]], [1, [7.108635140669648, 1.0]], [1, [23.108982650174728, 1.0]], [1, [99.27489117030112, 1.0]], [1, [0.2662247199671808, 1.0]], [1, [2.439935364956188, 1.0]], [1, [0.8336531255832361, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79414758]
bas 1, expnt(s) = [3661.45357783]
bas 2, expnt(s) = [833.28384107]
bas 3, expnt(s) = [235.71687017]
bas 4, expnt(s) = [75.65126674]
bas 5, expnt(s) = [9.92740465]
bas 6, expnt(s) = [26.69064947]
bas 7, expnt(s) = [0.38005182]
bas 8, expnt(s) = [1.10940751]
bas 9, expnt(s) = [2.85312667]
bas 10, expnt(s) = [7.10863514]
bas 11, expnt(s) = [23.10898265]
bas 12, expnt(s) = [99.27489117]
bas 13, expnt(s) = [0.26622472]
bas 14, expnt(s) = [2.43993536]
bas 15, expnt(s) = [0.83365313]
CPU time:       368.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145358e+03 1.18920075e+03
 8.33283841e+02 3.91840881e+02 2.35716870e+02 1.51987553e+02
 7.56512667e+01 6.48077849e+01 9.92740465e+00 1.41299888e+01
 2.66906495e+01 2.96677343e+01 3.80051817e-01 1.22291743e+00
 1.10940751e+00 2.73107326e+00 2.85312667e+00 5.54633138e+00
 7.10863514e+00 3.38623561e+01 2.31089827e+01 1.47812249e+02
 9.92748912e+01 9.14184108e+02 2.66224720e-01 5.57885233e-01
 2.43993536e+00 8.89625647e+00 8.33653126e-01 2.32389296e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999586301406719
cond(S) = 342.7895056990301
E1 = -183.58952082006238  E_coul = 55.080161638374
init E= -128.509359181688
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.7754021574037  LUMO = 0.824313872235754
  mo_energy =
[-3.25550517e+01 -1.85259456e+00 -7.75402157e-01 -7.75402157e-01
 -7.75402157e-01  8.24313872e-01  8.24313872e-01  8.24313872e-01
  1.20974576e+00  3.95529090e+00  3.95529090e+00  3.95529090e+00
  7.29803516e+00  1.43486380e+01  1.43486380e+01  1.43486380e+01
  3.43008118e+01  5.29077778e+01  5.29077778e+01  5.29077778e+01
  1.37081996e+02  2.39759339e+02  2.39759339e+02  2.39759339e+02
  4.99212181e+02  1.86604675e+03  7.99598446e+03  4.77643442e+04]
E1 = -182.0876172497017  E_coul = 53.54982298522752
cycle= 1 E= -128.537794264474  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.509241
diis-c [-0.25932603  1.        ]
  HOMO = -0.88413777457822  LUMO = 0.797634325623079
  mo_energy =
[-3.28778256e+01 -1.96639604e+00 -8.84137775e-01 -8.84137775e-01
 -8.84137775e-01  7.97634326e-01  7.97634326e-01  7.97634326e-01
  1.16466615e+00  3.85800699e+00  3.85800699e+00  3.85800699e+00
  7.16711705e+00  1.41582580e+01  1.41582580e+01  1.41582580e+01
  3.40551029e+01  5.26273353e+01  5.26273353e+01  5.26273353e+01
  1.36764921e+02  2.39413662e+02  2.39413662e+02  2.39413662e+02
  4.98851095e+02  1.86564965e+03  7.99555838e+03  4.77638993e+04]
E1 = -182.84798478000388  E_coul = 54.30760866742968
cycle= 2 E= -128.540376112574  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.258427
diis-c [-6.42809899e-04  3.35836537e-01  6.64163463e-01]
  HOMO = -0.848550163479843  LUMO = 0.806354270317671
  mo_energy =
[-3.27698281e+01 -1.92891271e+00 -8.48550163e-01 -8.48550163e-01
 -8.48550163e-01  8.06354270e-01  8.06354270e-01  8.06354270e-01
  1.17914834e+00  3.88957550e+00  3.88957550e+00  3.88957550e+00
  7.21003336e+00  1.42213567e+01  1.42213567e+01  1.42213567e+01
  3.41374363e+01  5.27212101e+01  5.27212101e+01  5.27212101e+01
  1.36870780e+02  2.39527185e+02  2.39527185e+02  2.39527185e+02
  4.98967828e+02  1.86577163e+03  7.99568280e+03  4.77640246e+04]
E1 = -182.58983132901432  E_coul = 54.04853813448556
cycle= 3 E= -128.541293194529  delta_E= -0.000917  |g|= 0.000504  |ddm|= 0.0232
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00117616
diis-c [-1.24593947e-07 -2.26078250e-03 -1.04435084e-04  1.00236522e+00]
  HOMO = -0.848805478425254  LUMO = 0.80631778718583
  mo_energy =
[-3.27702988e+01 -1.92911073e+00 -8.48805478e-01 -8.48805478e-01
 -8.48805478e-01  8.06317787e-01  8.06317787e-01  8.06317787e-01
  1.17907364e+00  3.88939804e+00  3.88939804e+00  3.88939804e+00
  7.20981781e+00  1.42210495e+01  1.42210495e+01  1.42210495e+01
  3.41370742e+01  5.27207949e+01  5.27207949e+01  5.27207949e+01
  1.36870307e+02  2.39526643e+02  2.39526643e+02  2.39526643e+02
  4.98967229e+02  1.86577090e+03  7.99568197e+03  4.77640237e+04]
E1 = -182.5903770249659  E_coul = 54.04908380900457
cycle= 4 E= -128.541293215961  delta_E= -2.14e-08  |g|= 7.55e-05  |ddm|= 0.000217
    CPU time for cycle= 4      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.000185457
diis-c [-8.01146939e-10  1.93411252e-04  4.83553428e-04 -1.59582759e-01
  1.15890579e+00]
  HOMO = -0.848845053381965  LUMO = 0.806305970178479
  mo_energy =
[-3.27703699e+01 -1.92914205e+00 -8.48845053e-01 -8.48845053e-01
 -8.48845053e-01  8.06305970e-01  8.06305970e-01  8.06305970e-01
  1.17905661e+00  3.88936094e+00  3.88936094e+00  3.88936094e+00
  7.20977627e+00  1.42209937e+01  1.42209937e+01  1.42209937e+01
  3.41370122e+01  5.27207282e+01  5.27207282e+01  5.27207282e+01
  1.36870236e+02  2.39526568e+02  2.39526568e+02  2.39526568e+02
  4.98967150e+02  1.86577081e+03  7.99568188e+03  4.77640236e+04]
E1 = -182.59052038351285  E_coul = 54.04922716699757
cycle= 5 E= -128.541293216515  delta_E= -5.54e-10  |g|= 4.5e-06  |ddm|= 3.2e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59052038351285  E_coul = 54.04922716699757
  HOMO = -0.848842889263861  LUMO = 0.80630661482521
  mo_energy =
[-3.27703652e+01 -1.92913916e+00 -8.48842889e-01 -8.48842889e-01
 -8.48842889e-01  8.06306615e-01  8.06306615e-01  8.06306615e-01
  1.17905804e+00  3.88936303e+00  3.88936303e+00  3.88936303e+00
  7.20977926e+00  1.42209973e+01  1.42209973e+01  1.42209973e+01
  3.41370165e+01  5.27207327e+01  5.27207327e+01  5.27207327e+01
  1.36870241e+02  2.39526572e+02  2.39526572e+02  2.39526572e+02
  4.98967155e+02  1.86577082e+03  7.99568188e+03  4.77640237e+04]
E1 = -182.59050964163356  E_coul = 54.04921642511673
Extra cycle  E= -128.541293216517  delta_E= -1.56e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.17 sec, wall time      0.17 sec
exp = [2.44137941e+04 3.66145358e+03 8.33283841e+02 2.35716870e+02
 7.56512667e+01 9.92740465e+00 2.66906495e+01 3.80051817e-01
 1.10940751e+00 2.85312667e+00 7.10863514e+00 2.31089827e+01
 9.92748912e+01 2.66224720e-01 2.43993536e+00 8.33653126e-01]
E = -128.54129321651683
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941476        1
[INPUT] 0    0    [1    /1   ]  3661.45357783        1
[INPUT] 0    0    [1    /1   ]  833.283841072        1
[INPUT] 0    0    [1    /1   ]  235.716870174        1
[INPUT] 0    0    [1    /1   ]  75.6512667413        1
[INPUT] 0    0    [1    /1   ]  9.92740464542        1
[INPUT] 0    0    [1    /1   ]  26.6906494745        1
[INPUT] 0    0    [1    /1   ]  0.380051816679       1
[INPUT] 0    0    [1    /1   ]  1.10940750884        1
[INPUT] 0    0    [1    /1   ]  2.8531266714         1
[INPUT] 1    0    [1    /1   ]  7.10863514067        1
[INPUT] 1    0    [1    /1   ]  23.1089826502        1
[INPUT] 1    0    [1    /1   ]  99.2748911703        1
[INPUT] 1    0    [1    /1   ]  0.266224719967       1
[INPUT] 1    0    [1    /1   ]  2.43993536496        1
[INPUT] 1    0    [1    /1   ]  0.833653125583       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79414758234, 1.0]], [0, [3661.453577827247, 1.0]], [0, [833.2838410723723, 1.0]], [0, [235.71687017362393, 1.0]], [0, [75.65126674126297, 1.0]], [0, [9.92740464542147, 1.0]], [0, [26.69064947452206, 1.0]], [0, [0.3800518166785283, 1.0]], [0, [1.1094075088365285, 1.0]], [0, [2.8531266714019012, 1.0]], [1, [7.108635140669648, 1.0]], [1, [23.108982650174728, 1.0]], [1, [99.27489117030112, 1.0]], [1, [0.2662247199671808, 1.0]], [1, [2.439935364956188, 1.0]], [1, [0.8336531255832361, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79414758]
bas 1, expnt(s) = [3661.45357783]
bas 2, expnt(s) = [833.28384107]
bas 3, expnt(s) = [235.71687017]
bas 4, expnt(s) = [75.65126674]
bas 5, expnt(s) = [9.92740465]
bas 6, expnt(s) = [26.69064947]
bas 7, expnt(s) = [0.38005182]
bas 8, expnt(s) = [1.10940751]
bas 9, expnt(s) = [2.85312667]
bas 10, expnt(s) = [7.10863514]
bas 11, expnt(s) = [23.10898265]
bas 12, expnt(s) = [99.27489117]
bas 13, expnt(s) = [0.26622472]
bas 14, expnt(s) = [2.43993536]
bas 15, expnt(s) = [0.83365313]
CPU time:       369.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145358e+03 1.18920075e+03
 8.33283841e+02 3.91840881e+02 2.35716870e+02 1.51987553e+02
 7.56512667e+01 6.48077849e+01 9.92740465e+00 1.41299888e+01
 2.66906495e+01 2.96677343e+01 3.80051817e-01 1.22291743e+00
 1.10940751e+00 2.73107326e+00 2.85312667e+00 5.54633138e+00
 7.10863514e+00 3.38623561e+01 2.31089827e+01 1.47812249e+02
 9.92748912e+01 9.14184108e+02 2.66224720e-01 5.57885233e-01
 2.43993536e+00 8.89625647e+00 8.33653126e-01 2.32389296e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999586301406719
cond(S) = 342.7895056990301
E1 = -183.58952082006238  E_coul = 55.080161638374
init E= -128.509359181688
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.7754021574037  LUMO = 0.824313872235754
  mo_energy =
[-3.25550517e+01 -1.85259456e+00 -7.75402157e-01 -7.75402157e-01
 -7.75402157e-01  8.24313872e-01  8.24313872e-01  8.24313872e-01
  1.20974576e+00  3.95529090e+00  3.95529090e+00  3.95529090e+00
  7.29803516e+00  1.43486380e+01  1.43486380e+01  1.43486380e+01
  3.43008118e+01  5.29077778e+01  5.29077778e+01  5.29077778e+01
  1.37081996e+02  2.39759339e+02  2.39759339e+02  2.39759339e+02
  4.99212181e+02  1.86604675e+03  7.99598446e+03  4.77643442e+04]
E1 = -182.0876172497017  E_coul = 53.54982298522752
cycle= 1 E= -128.537794264474  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509241
diis-c [-0.25932603  1.        ]
  HOMO = -0.88413777457822  LUMO = 0.797634325623079
  mo_energy =
[-3.28778256e+01 -1.96639604e+00 -8.84137775e-01 -8.84137775e-01
 -8.84137775e-01  7.97634326e-01  7.97634326e-01  7.97634326e-01
  1.16466615e+00  3.85800699e+00  3.85800699e+00  3.85800699e+00
  7.16711705e+00  1.41582580e+01  1.41582580e+01  1.41582580e+01
  3.40551029e+01  5.26273353e+01  5.26273353e+01  5.26273353e+01
  1.36764921e+02  2.39413662e+02  2.39413662e+02  2.39413662e+02
  4.98851095e+02  1.86564965e+03  7.99555838e+03  4.77638993e+04]
E1 = -182.84798478000388  E_coul = 54.30760866742968
cycle= 2 E= -128.540376112574  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.258427
diis-c [-6.42809899e-04  3.35836537e-01  6.64163463e-01]
  HOMO = -0.848550163479843  LUMO = 0.806354270317671
  mo_energy =
[-3.27698281e+01 -1.92891271e+00 -8.48550163e-01 -8.48550163e-01
 -8.48550163e-01  8.06354270e-01  8.06354270e-01  8.06354270e-01
  1.17914834e+00  3.88957550e+00  3.88957550e+00  3.88957550e+00
  7.21003336e+00  1.42213567e+01  1.42213567e+01  1.42213567e+01
  3.41374363e+01  5.27212101e+01  5.27212101e+01  5.27212101e+01
  1.36870780e+02  2.39527185e+02  2.39527185e+02  2.39527185e+02
  4.98967828e+02  1.86577163e+03  7.99568280e+03  4.77640246e+04]
E1 = -182.58983132901432  E_coul = 54.04853813448556
cycle= 3 E= -128.541293194529  delta_E= -0.000917  |g|= 0.000504  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117616
diis-c [-1.24593947e-07 -2.26078250e-03 -1.04435084e-04  1.00236522e+00]
  HOMO = -0.848805478425254  LUMO = 0.80631778718583
  mo_energy =
[-3.27702988e+01 -1.92911073e+00 -8.48805478e-01 -8.48805478e-01
 -8.48805478e-01  8.06317787e-01  8.06317787e-01  8.06317787e-01
  1.17907364e+00  3.88939804e+00  3.88939804e+00  3.88939804e+00
  7.20981781e+00  1.42210495e+01  1.42210495e+01  1.42210495e+01
  3.41370742e+01  5.27207949e+01  5.27207949e+01  5.27207949e+01
  1.36870307e+02  2.39526643e+02  2.39526643e+02  2.39526643e+02
  4.98967229e+02  1.86577090e+03  7.99568197e+03  4.77640237e+04]
E1 = -182.5903770249659  E_coul = 54.04908380900457
cycle= 4 E= -128.541293215961  delta_E= -2.14e-08  |g|= 7.55e-05  |ddm|= 0.000217
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185457
diis-c [-8.01146939e-10  1.93411252e-04  4.83553428e-04 -1.59582759e-01
  1.15890579e+00]
  HOMO = -0.848845053381965  LUMO = 0.806305970178479
  mo_energy =
[-3.27703699e+01 -1.92914205e+00 -8.48845053e-01 -8.48845053e-01
 -8.48845053e-01  8.06305970e-01  8.06305970e-01  8.06305970e-01
  1.17905661e+00  3.88936094e+00  3.88936094e+00  3.88936094e+00
  7.20977627e+00  1.42209937e+01  1.42209937e+01  1.42209937e+01
  3.41370122e+01  5.27207282e+01  5.27207282e+01  5.27207282e+01
  1.36870236e+02  2.39526568e+02  2.39526568e+02  2.39526568e+02
  4.98967150e+02  1.86577081e+03  7.99568188e+03  4.77640236e+04]
E1 = -182.59052038351285  E_coul = 54.04922716699757
cycle= 5 E= -128.541293216515  delta_E= -5.54e-10  |g|= 4.5e-06  |ddm|= 3.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59052038351285  E_coul = 54.04922716699757
  HOMO = -0.848842889263861  LUMO = 0.80630661482521
  mo_energy =
[-3.27703652e+01 -1.92913916e+00 -8.48842889e-01 -8.48842889e-01
 -8.48842889e-01  8.06306615e-01  8.06306615e-01  8.06306615e-01
  1.17905804e+00  3.88936303e+00  3.88936303e+00  3.88936303e+00
  7.20977926e+00  1.42209973e+01  1.42209973e+01  1.42209973e+01
  3.41370165e+01  5.27207327e+01  5.27207327e+01  5.27207327e+01
  1.36870241e+02  2.39526572e+02  2.39526572e+02  2.39526572e+02
  4.98967155e+02  1.86577082e+03  7.99568188e+03  4.77640237e+04]
E1 = -182.59050964163356  E_coul = 54.04921642511673
Extra cycle  E= -128.541293216517  delta_E= -1.56e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 342.7895056990301
E1 = -182.59050964163356  E_coul = 54.04921642511673
init E= -128.541293216517
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848843655409755  LUMO = 0.806306441139055
  mo_energy =
[-3.27703676e+01 -1.92913983e+00 -8.48843655e-01 -8.48843655e-01
 -8.48843655e-01  8.06306441e-01  8.06306441e-01  8.06306441e-01
  1.17905783e+00  3.88936237e+00  3.88936237e+00  3.88936237e+00
  7.20977841e+00  1.42209959e+01  1.42209959e+01  1.42209959e+01
  3.41370147e+01  5.27207306e+01  5.27207306e+01  5.27207306e+01
  1.36870239e+02  2.39526570e+02  2.39526570e+02  2.39526570e+02
  4.98967152e+02  1.86577081e+03  7.99568188e+03  4.77640236e+04]
E1 = -182.5905156647821  E_coul = 54.0492224482653
cycle= 1 E= -128.541293216517  delta_E= 2.84e-14  |g|= 8.31e-07  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5905156647821  E_coul = 54.0492224482653
  HOMO = -0.848843232862165  LUMO = 0.806306547406336
  mo_energy =
[-3.27703663e+01 -1.92913936e+00 -8.48843233e-01 -8.48843233e-01
 -8.48843233e-01  8.06306547e-01  8.06306547e-01  8.06306547e-01
  1.17905802e+00  3.88936275e+00  3.88936275e+00  3.88936275e+00
  7.20977894e+00  1.42209967e+01  1.42209967e+01  1.42209967e+01
  3.41370157e+01  5.27207317e+01  5.27207317e+01  5.27207317e+01
  1.36870240e+02  2.39526571e+02  2.39526571e+02  2.39526571e+02
  4.98967153e+02  1.86577082e+03  7.99568188e+03  4.77640237e+04]
E1 = -182.5905126519311  E_coul = 54.0492194354143
Extra cycle  E= -128.541293216517  delta_E=    0  |g|= 4.09e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.34 sec
exp = [2.44137941e+04 3.66145358e+03 8.33283841e+02 2.35716870e+02
 7.56512667e+01 9.92740465e+00 2.66906495e+01 3.80051817e-01
 1.10940751e+00 2.85312667e+00 7.10863514e+00 2.31089827e+01
 9.92748912e+01 2.66224720e-01 2.43993536e+00 8.33653126e-01]
grad_E = [-1.51684578e-09  7.85630538e-08 -1.42887318e-06  1.20780010e-05
 -3.30465058e-05 -3.82696071e-05  3.26881966e-05 -1.53533821e-04
  1.95572259e-04 -1.70805232e-05  7.70721353e-05 -1.07006191e-05
 -3.47419763e-07  5.90094646e-06 -1.45544070e-04  7.75776113e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941641        1
[INPUT] 0    0    [1    /1   ]  3661.45272671        1
[INPUT] 0    0    [1    /1   ]  833.298845987        1
[INPUT] 0    0    [1    /1   ]  235.601673966        1
[INPUT] 0    0    [1    /1   ]  75.8420400017        1
[INPUT] 0    0    [1    /1   ]  9.97866766398        1
[INPUT] 0    0    [1    /1   ]  26.8197701632        1
[INPUT] 0    0    [1    /1   ]  0.381939329125       1
[INPUT] 0    0    [1    /1   ]  1.1182801802         1
[INPUT] 0    0    [1    /1   ]  2.8800506561         1
[INPUT] 1    0    [1    /1   ]  7.11545243741        1
[INPUT] 1    0    [1    /1   ]  23.1383285994        1
[INPUT] 1    0    [1    /1   ]  99.4516271135        1
[INPUT] 1    0    [1    /1   ]  0.26633174557        1
[INPUT] 1    0    [1    /1   ]  2.44168732213        1
[INPUT] 1    0    [1    /1   ]  0.834109877853       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794164120085, 1.0]], [0, [3661.452726709701, 1.0]], [0, [833.2988459869478, 1.0]], [0, [235.60167396558316, 1.0]], [0, [75.84204000165313, 1.0]], [0, [9.978667663981314, 1.0]], [0, [26.819770163243504, 1.0]], [0, [0.3819393291253305, 1.0]], [0, [1.118280180199621, 1.0]], [0, [2.8800506561005306, 1.0]], [1, [7.115452437406712, 1.0]], [1, [23.138328599394466, 1.0]], [1, [99.45162711345098, 1.0]], [1, [0.2663317455699802, 1.0]], [1, [2.441687322128353, 1.0]], [1, [0.8341098778527576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79416412]
bas 1, expnt(s) = [3661.45272671]
bas 2, expnt(s) = [833.29884599]
bas 3, expnt(s) = [235.60167397]
bas 4, expnt(s) = [75.84204]
bas 5, expnt(s) = [9.97866766]
bas 6, expnt(s) = [26.81977016]
bas 7, expnt(s) = [0.38193933]
bas 8, expnt(s) = [1.11828018]
bas 9, expnt(s) = [2.88005066]
bas 10, expnt(s) = [7.11545244]
bas 11, expnt(s) = [23.1383286]
bas 12, expnt(s) = [99.45162711]
bas 13, expnt(s) = [0.26633175]
bas 14, expnt(s) = [2.44168732]
bas 15, expnt(s) = [0.83410988]
CPU time:       373.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448102e+03 3.66145273e+03 1.18920054e+03
 8.33298846e+02 3.91846173e+02 2.35601674e+02 1.51931842e+02
 7.58420400e+01 6.49303178e+01 9.97866766e+00 1.41846768e+01
 2.68197702e+01 2.97753115e+01 3.81939329e-01 1.22746978e+00
 1.11828018e+00 2.74743860e+00 2.88005066e+00 5.58553939e+00
 7.11545244e+00 3.39029542e+01 2.31383286e+01 1.48046919e+02
 9.94516271e+01 9.16218926e+02 2.66331746e-01 5.58165593e-01
 2.44168732e+00 8.90424196e+00 8.34109878e-01 2.32548463e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999582541305081
cond(S) = 345.8087005595524
E1 = -183.5894900108258  E_coul = 55.080160763704754
init E= -128.509329247121
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775402256325465  LUMO = 0.824765227254027
  mo_energy =
[-3.25550593e+01 -1.85258835e+00 -7.75402256e-01 -7.75402256e-01
 -7.75402256e-01  8.24765227e-01  8.24765227e-01  8.24765227e-01
  1.22088523e+00  3.95787805e+00  3.95787805e+00  3.95787805e+00
  7.37508945e+00  1.43611521e+01  1.43611521e+01  1.43611521e+01
  3.45865900e+01  5.29719261e+01  5.29719261e+01  5.29719261e+01
  1.37822105e+02  2.40175294e+02  2.40175294e+02  2.40175294e+02
  5.00387332e+02  1.86719417e+03  7.99697820e+03  4.77651663e+04]
E1 = -182.08779466203853  E_coul = 53.549996396105655
cycle= 1 E= -128.537798265933  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509103
diis-c [-0.25918571  1.        ]
  HOMO = -0.884123800927821  LUMO = 0.798072142880119
  mo_energy =
[-3.28777991e+01 -1.96637928e+00 -8.84123801e-01 -8.84123801e-01
 -8.84123801e-01  7.98072143e-01  7.98072143e-01  7.98072143e-01
  1.17540166e+00  3.86054944e+00  3.86054944e+00  3.86054944e+00
  7.24336478e+00  1.41707078e+01  1.41707078e+01  1.41707078e+01
  3.43404519e+01  5.26914326e+01  5.26914326e+01  5.26914326e+01
  1.37504920e+02  2.39829595e+02  2.39829595e+02  2.39829595e+02
  5.00026280e+02  1.86679712e+03  7.99655217e+03  4.77647215e+04]
E1 = -182.848068432119  E_coul = 54.30768873363827
cycle= 2 E= -128.540379698481  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258351
diis-c [-6.43935465e-04  3.35829338e-01  6.64170662e-01]
  HOMO = -0.848540531062368  LUMO = 0.806797304453788
  mo_energy =
[-3.27698128e+01 -1.92890004e+00 -8.48540531e-01 -8.48540531e-01
 -8.48540531e-01  8.06797304e-01  8.06797304e-01  8.06797304e-01
  1.19001624e+00  3.89213314e+00  3.89213314e+00  3.89213314e+00
  7.28655268e+00  1.42338292e+01  1.42338292e+01  1.42338292e+01
  3.44229322e+01  5.27853239e+01  5.27853239e+01  5.27853239e+01
  1.37610810e+02  2.39943120e+02  2.39943120e+02  2.39943120e+02
  5.00143002e+02  1.86691909e+03  7.99667657e+03  4.77648468e+04]
E1 = -182.5899599671949  E_coul = 54.048663431489025
cycle= 3 E= -128.541296535706  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117406
diis-c [-1.23614560e-07 -2.25731709e-03 -1.03294809e-04  1.00236061e+00]
  HOMO = -0.848795183961356  LUMO = 0.806761025150537
  mo_energy =
[-3.27702826e+01 -1.92909759e+00 -8.48795184e-01 -8.48795184e-01
 -8.48795184e-01  8.06761025e-01  8.06761025e-01  8.06761025e-01
  1.18994129e+00  3.89195617e+00  3.89195617e+00  3.89195617e+00
  7.28633659e+00  1.42335228e+01  1.42335228e+01  1.42335228e+01
  3.44225703e+01  5.27849095e+01  5.27849095e+01  5.27849095e+01
  1.37610338e+02  2.39942580e+02  2.39942580e+02  2.39942580e+02
  5.00142405e+02  1.86691836e+03  7.99667574e+03  4.77648459e+04]
E1 = -182.5905057824546  E_coul = 54.049209225491936
cycle= 4 E= -128.541296556963  delta_E= -2.13e-08  |g|= 7.52e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018496
diis-c [-7.95337408e-10  1.92764573e-04  4.83056325e-04 -1.59158664e-01
  1.15848284e+00]
  HOMO = -0.848834593019814  LUMO = 0.806749256043643
  mo_energy =
[-3.27703535e+01 -1.92912881e+00 -8.48834593e-01 -8.48834593e-01
 -8.48834593e-01  8.06749256e-01  8.06749256e-01  8.06749256e-01
  1.18992421e+00  3.89191919e+00  3.89191919e+00  3.89191919e+00
  7.28629502e+00  1.42334671e+01  1.42334671e+01  1.42334671e+01
  3.44225084e+01  5.27848430e+01  5.27848430e+01  5.27848430e+01
  1.37610268e+02  2.39942505e+02  2.39942505e+02  2.39942505e+02
  5.00142326e+02  1.86691828e+03  7.99667565e+03  4.77648458e+04]
E1 = -182.59064898543622  E_coul = 54.04935242792512
cycle= 5 E= -128.541296557511  delta_E= -5.48e-10  |g|= 4.47e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59064898543622  E_coul = 54.04935242792512
  HOMO = -0.848832438399  LUMO = 0.8067498979947
  mo_energy =
[-3.27703488e+01 -1.92912593e+00 -8.48832438e-01 -8.48832438e-01
 -8.48832438e-01  8.06749898e-01  8.06749898e-01  8.06749898e-01
  1.18992565e+00  3.89192128e+00  3.89192128e+00  3.89192128e+00
  7.28629801e+00  1.42334707e+01  1.42334707e+01  1.42334707e+01
  3.44225127e+01  5.27848474e+01  5.27848474e+01  5.27848474e+01
  1.37610272e+02  2.39942509e+02  2.39942509e+02  2.39942509e+02
  5.00142330e+02  1.86691828e+03  7.99667565e+03  4.77648458e+04]
E1 = -182.59063828367803  E_coul = 54.04934172616575
Extra cycle  E= -128.541296557512  delta_E= -1.19e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137942e+04 3.66145273e+03 8.33298846e+02 2.35601674e+02
 7.58420400e+01 9.97866766e+00 2.68197702e+01 3.81939329e-01
 1.11828018e+00 2.88005066e+00 7.11545244e+00 2.31383286e+01
 9.94516271e+01 2.66331746e-01 2.44168732e+00 8.34109878e-01]
E = -128.54129655751228
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941641        1
[INPUT] 0    0    [1    /1   ]  3661.45272671        1
[INPUT] 0    0    [1    /1   ]  833.298845987        1
[INPUT] 0    0    [1    /1   ]  235.601673966        1
[INPUT] 0    0    [1    /1   ]  75.8420400017        1
[INPUT] 0    0    [1    /1   ]  9.97866766398        1
[INPUT] 0    0    [1    /1   ]  26.8197701632        1
[INPUT] 0    0    [1    /1   ]  0.381939329125       1
[INPUT] 0    0    [1    /1   ]  1.1182801802         1
[INPUT] 0    0    [1    /1   ]  2.8800506561         1
[INPUT] 1    0    [1    /1   ]  7.11545243741        1
[INPUT] 1    0    [1    /1   ]  23.1383285994        1
[INPUT] 1    0    [1    /1   ]  99.4516271135        1
[INPUT] 1    0    [1    /1   ]  0.26633174557        1
[INPUT] 1    0    [1    /1   ]  2.44168732213        1
[INPUT] 1    0    [1    /1   ]  0.834109877853       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794164120085, 1.0]], [0, [3661.452726709701, 1.0]], [0, [833.2988459869478, 1.0]], [0, [235.60167396558316, 1.0]], [0, [75.84204000165313, 1.0]], [0, [9.978667663981314, 1.0]], [0, [26.819770163243504, 1.0]], [0, [0.3819393291253305, 1.0]], [0, [1.118280180199621, 1.0]], [0, [2.8800506561005306, 1.0]], [1, [7.115452437406712, 1.0]], [1, [23.138328599394466, 1.0]], [1, [99.45162711345098, 1.0]], [1, [0.2663317455699802, 1.0]], [1, [2.441687322128353, 1.0]], [1, [0.8341098778527576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79416412]
bas 1, expnt(s) = [3661.45272671]
bas 2, expnt(s) = [833.29884599]
bas 3, expnt(s) = [235.60167397]
bas 4, expnt(s) = [75.84204]
bas 5, expnt(s) = [9.97866766]
bas 6, expnt(s) = [26.81977016]
bas 7, expnt(s) = [0.38193933]
bas 8, expnt(s) = [1.11828018]
bas 9, expnt(s) = [2.88005066]
bas 10, expnt(s) = [7.11545244]
bas 11, expnt(s) = [23.1383286]
bas 12, expnt(s) = [99.45162711]
bas 13, expnt(s) = [0.26633175]
bas 14, expnt(s) = [2.44168732]
bas 15, expnt(s) = [0.83410988]
CPU time:       374.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448102e+03 3.66145273e+03 1.18920054e+03
 8.33298846e+02 3.91846173e+02 2.35601674e+02 1.51931842e+02
 7.58420400e+01 6.49303178e+01 9.97866766e+00 1.41846768e+01
 2.68197702e+01 2.97753115e+01 3.81939329e-01 1.22746978e+00
 1.11828018e+00 2.74743860e+00 2.88005066e+00 5.58553939e+00
 7.11545244e+00 3.39029542e+01 2.31383286e+01 1.48046919e+02
 9.94516271e+01 9.16218926e+02 2.66331746e-01 5.58165593e-01
 2.44168732e+00 8.90424196e+00 8.34109878e-01 2.32548463e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999582541305081
cond(S) = 345.8087005595524
E1 = -183.5894900108258  E_coul = 55.080160763704754
init E= -128.509329247121
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402256325465  LUMO = 0.824765227254027
  mo_energy =
[-3.25550593e+01 -1.85258835e+00 -7.75402256e-01 -7.75402256e-01
 -7.75402256e-01  8.24765227e-01  8.24765227e-01  8.24765227e-01
  1.22088523e+00  3.95787805e+00  3.95787805e+00  3.95787805e+00
  7.37508945e+00  1.43611521e+01  1.43611521e+01  1.43611521e+01
  3.45865900e+01  5.29719261e+01  5.29719261e+01  5.29719261e+01
  1.37822105e+02  2.40175294e+02  2.40175294e+02  2.40175294e+02
  5.00387332e+02  1.86719417e+03  7.99697820e+03  4.77651663e+04]
E1 = -182.08779466203853  E_coul = 53.549996396105655
cycle= 1 E= -128.537798265933  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509103
diis-c [-0.25918571  1.        ]
  HOMO = -0.884123800927821  LUMO = 0.798072142880119
  mo_energy =
[-3.28777991e+01 -1.96637928e+00 -8.84123801e-01 -8.84123801e-01
 -8.84123801e-01  7.98072143e-01  7.98072143e-01  7.98072143e-01
  1.17540166e+00  3.86054944e+00  3.86054944e+00  3.86054944e+00
  7.24336478e+00  1.41707078e+01  1.41707078e+01  1.41707078e+01
  3.43404519e+01  5.26914326e+01  5.26914326e+01  5.26914326e+01
  1.37504920e+02  2.39829595e+02  2.39829595e+02  2.39829595e+02
  5.00026280e+02  1.86679712e+03  7.99655217e+03  4.77647215e+04]
E1 = -182.848068432119  E_coul = 54.30768873363827
cycle= 2 E= -128.540379698481  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258351
diis-c [-6.43935465e-04  3.35829338e-01  6.64170662e-01]
  HOMO = -0.848540531062368  LUMO = 0.806797304453788
  mo_energy =
[-3.27698128e+01 -1.92890004e+00 -8.48540531e-01 -8.48540531e-01
 -8.48540531e-01  8.06797304e-01  8.06797304e-01  8.06797304e-01
  1.19001624e+00  3.89213314e+00  3.89213314e+00  3.89213314e+00
  7.28655268e+00  1.42338292e+01  1.42338292e+01  1.42338292e+01
  3.44229322e+01  5.27853239e+01  5.27853239e+01  5.27853239e+01
  1.37610810e+02  2.39943120e+02  2.39943120e+02  2.39943120e+02
  5.00143002e+02  1.86691909e+03  7.99667657e+03  4.77648468e+04]
E1 = -182.5899599671949  E_coul = 54.048663431489025
cycle= 3 E= -128.541296535706  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117406
diis-c [-1.23614560e-07 -2.25731709e-03 -1.03294809e-04  1.00236061e+00]
  HOMO = -0.848795183961356  LUMO = 0.806761025150537
  mo_energy =
[-3.27702826e+01 -1.92909759e+00 -8.48795184e-01 -8.48795184e-01
 -8.48795184e-01  8.06761025e-01  8.06761025e-01  8.06761025e-01
  1.18994129e+00  3.89195617e+00  3.89195617e+00  3.89195617e+00
  7.28633659e+00  1.42335228e+01  1.42335228e+01  1.42335228e+01
  3.44225703e+01  5.27849095e+01  5.27849095e+01  5.27849095e+01
  1.37610338e+02  2.39942580e+02  2.39942580e+02  2.39942580e+02
  5.00142405e+02  1.86691836e+03  7.99667574e+03  4.77648459e+04]
E1 = -182.5905057824546  E_coul = 54.049209225491936
cycle= 4 E= -128.541296556963  delta_E= -2.13e-08  |g|= 7.52e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018496
diis-c [-7.95337408e-10  1.92764573e-04  4.83056325e-04 -1.59158664e-01
  1.15848284e+00]
  HOMO = -0.848834593019814  LUMO = 0.806749256043643
  mo_energy =
[-3.27703535e+01 -1.92912881e+00 -8.48834593e-01 -8.48834593e-01
 -8.48834593e-01  8.06749256e-01  8.06749256e-01  8.06749256e-01
  1.18992421e+00  3.89191919e+00  3.89191919e+00  3.89191919e+00
  7.28629502e+00  1.42334671e+01  1.42334671e+01  1.42334671e+01
  3.44225084e+01  5.27848430e+01  5.27848430e+01  5.27848430e+01
  1.37610268e+02  2.39942505e+02  2.39942505e+02  2.39942505e+02
  5.00142326e+02  1.86691828e+03  7.99667565e+03  4.77648458e+04]
E1 = -182.59064898543622  E_coul = 54.04935242792512
cycle= 5 E= -128.541296557511  delta_E= -5.48e-10  |g|= 4.47e-06  |ddm|= 3.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59064898543622  E_coul = 54.04935242792512
  HOMO = -0.848832438399  LUMO = 0.8067498979947
  mo_energy =
[-3.27703488e+01 -1.92912593e+00 -8.48832438e-01 -8.48832438e-01
 -8.48832438e-01  8.06749898e-01  8.06749898e-01  8.06749898e-01
  1.18992565e+00  3.89192128e+00  3.89192128e+00  3.89192128e+00
  7.28629801e+00  1.42334707e+01  1.42334707e+01  1.42334707e+01
  3.44225127e+01  5.27848474e+01  5.27848474e+01  5.27848474e+01
  1.37610272e+02  2.39942509e+02  2.39942509e+02  2.39942509e+02
  5.00142330e+02  1.86691828e+03  7.99667565e+03  4.77648458e+04]
E1 = -182.59063828367803  E_coul = 54.04934172616575
Extra cycle  E= -128.541296557512  delta_E= -1.19e-12  |g|= 1.53e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.8087005595524
E1 = -182.59063828367803  E_coul = 54.04934172616575
init E= -128.541296557512
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848833201657028  LUMO = 0.806749724784644
  mo_energy =
[-3.27703512e+01 -1.92912661e+00 -8.48833202e-01 -8.48833202e-01
 -8.48833202e-01  8.06749725e-01  8.06749725e-01  8.06749725e-01
  1.18992543e+00  3.89192062e+00  3.89192062e+00  3.89192062e+00
  7.28629716e+00  1.42334693e+01  1.42334693e+01  1.42334693e+01
  3.44225110e+01  5.27848454e+01  5.27848454e+01  5.27848454e+01
  1.37610270e+02  2.39942506e+02  2.39942506e+02  2.39942506e+02
  5.00142327e+02  1.86691828e+03  7.99667565e+03  4.77648458e+04]
E1 = -182.5906442823799  E_coul = 54.04934772486764
cycle= 1 E= -128.541296557512  delta_E=    0  |g|= 8.28e-07  |ddm|= 5.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5906442823799  E_coul = 54.04934772486764
  HOMO = -0.848832780820246  LUMO = 0.80674983068976
  mo_energy =
[-3.27703499e+01 -1.92912613e+00 -8.48832781e-01 -8.48832781e-01
 -8.48832781e-01  8.06749831e-01  8.06749831e-01  8.06749831e-01
  1.18992562e+00  3.89192100e+00  3.89192100e+00  3.89192100e+00
  7.28629769e+00  1.42334701e+01  1.42334701e+01  1.42334701e+01
  3.44225119e+01  5.27848465e+01  5.27848465e+01  5.27848465e+01
  1.37610271e+02  2.39942508e+02  2.39942508e+02  2.39942508e+02
  5.00142329e+02  1.86691828e+03  7.99667565e+03  4.77648458e+04]
E1 = -182.5906412817277  E_coul = 54.04934472421463
Extra cycle  E= -128.541296557513  delta_E= -7.96e-13  |g|= 4.07e-07  |ddm|= 2.92e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137942e+04 3.66145273e+03 8.33298846e+02 2.35601674e+02
 7.58420400e+01 9.97866766e+00 2.68197702e+01 3.81939329e-01
 1.11828018e+00 2.88005066e+00 7.11545244e+00 2.31383286e+01
 9.94516271e+01 2.66331746e-01 2.44168732e+00 8.34109878e-01]
grad_E = [-1.02434639e-09  5.34923506e-08 -1.00684924e-06  9.09541512e-06
 -2.87031202e-05 -3.54007546e-05  3.96447894e-05 -1.58129566e-04
  2.02656947e-04 -1.44293130e-05  8.05397441e-05 -1.11865217e-05
 -1.55840017e-07  9.85890722e-06 -1.50396224e-04  7.69498456e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941811        1
[INPUT] 0    0    [1    /1   ]  3661.45185045        1
[INPUT] 0    0    [1    /1   ]  833.314313028        1
[INPUT] 0    0    [1    /1   ]  235.482030654        1
[INPUT] 0    0    [1    /1   ]  76.0524331847        1
[INPUT] 0    0    [1    /1   ]  10.0106750013        1
[INPUT] 0    0    [1    /1   ]  26.9247092348        1
[INPUT] 0    0    [1    /1   ]  0.382051168557       1
[INPUT] 0    0    [1    /1   ]  1.1194443522         1
[INPUT] 0    0    [1    /1   ]  2.88687123586        1
[INPUT] 1    0    [1    /1   ]  7.11802184913        1
[INPUT] 1    0    [1    /1   ]  23.1649979975        1
[INPUT] 1    0    [1    /1   ]  99.6670755946        1
[INPUT] 1    0    [1    /1   ]  0.266407966885       1
[INPUT] 1    0    [1    /1   ]  2.44267427786        1
[INPUT] 1    0    [1    /1   ]  0.834470534588       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79418114001, 1.0]], [0, [3661.4518504524776, 1.0]], [0, [833.3143130275538, 1.0]], [0, [235.4820306541364, 1.0]], [0, [76.05243318465874, 1.0]], [0, [10.01067500127778, 1.0]], [0, [26.924709234776095, 1.0]], [0, [0.3820511685570801, 1.0]], [0, [1.1194443521965518, 1.0]], [0, [2.8868712358615056, 1.0]], [1, [7.118021849129105, 1.0]], [1, [23.164997997471467, 1.0]], [1, [99.66707559464719, 1.0]], [1, [0.2664079668848507, 1.0]], [1, [2.4426742778610246, 1.0]], [1, [0.8344705345883848, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418114]
bas 1, expnt(s) = [3661.45185045]
bas 2, expnt(s) = [833.31431303]
bas 3, expnt(s) = [235.48203065]
bas 4, expnt(s) = [76.05243318]
bas 5, expnt(s) = [10.010675]
bas 6, expnt(s) = [26.92470923]
bas 7, expnt(s) = [0.38205117]
bas 8, expnt(s) = [1.11944435]
bas 9, expnt(s) = [2.88687124]
bas 10, expnt(s) = [7.11802185]
bas 11, expnt(s) = [23.164998]
bas 12, expnt(s) = [99.66707559]
bas 13, expnt(s) = [0.26640797]
bas 14, expnt(s) = [2.44267428]
bas 15, expnt(s) = [0.83447053]
CPU time:       378.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145185e+03 1.18920033e+03
 8.33314313e+02 3.91851628e+02 2.35482031e+02 1.51873973e+02
 7.60524332e+01 6.50653633e+01 1.00106750e+01 1.42187869e+01
 2.69247092e+01 2.98626463e+01 3.82051169e-01 1.22773934e+00
 1.11944435e+00 2.74958346e+00 2.88687124e+00 5.59545728e+00
 7.11802185e+00 3.39182579e+01 2.31649980e+01 1.48260249e+02
 9.96670756e+01 9.18700678e+02 2.66407967e-01 5.58365277e-01
 2.44267428e+00 8.90874117e+00 8.34470535e-01 2.32674158e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999581402653497
cond(S) = 345.9406352166797
E1 = -183.58944227618582  E_coul = 55.08016406696531
init E= -128.50927820922
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775402136090869  LUMO = 0.825089744321058
  mo_energy =
[-3.25550611e+01 -1.85258671e+00 -7.75402136e-01 -7.75402136e-01
 -7.75402136e-01  8.25089744e-01  8.25089744e-01  8.25089744e-01
  1.22219061e+00  3.95971321e+00  3.95971321e+00  3.95971321e+00
  7.39189886e+00  1.43676828e+01  1.43676828e+01  1.43676828e+01
  3.47148936e+01  5.30175173e+01  5.30175173e+01  5.30175173e+01
  1.38334832e+02  2.40632913e+02  2.40632913e+02  2.40632913e+02
  5.01341165e+02  1.86814700e+03  7.99780101e+03  4.77658471e+04]
E1 = -182.08785071583452  E_coul = 53.55004944151469
cycle= 1 E= -128.53780127432  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508996
diis-c [-0.25907653  1.        ]
  HOMO = -0.884120117610122  LUMO = 0.798384145638982
  mo_energy =
[-3.28777903e+01 -1.96637396e+00 -8.84120118e-01 -8.84120118e-01
 -8.84120118e-01  7.98384146e-01  7.98384146e-01  7.98384146e-01
  1.17664851e+00  3.86235207e+00  3.86235207e+00  3.86235207e+00
  7.25993248e+00  1.41772049e+01  1.41772049e+01  1.41772049e+01
  3.44684646e+01  5.27369619e+01  5.27369619e+01  5.27369619e+01
  1.38017514e+02  2.40287155e+02  2.40287155e+02  2.40287155e+02
  5.00980113e+02  1.86774999e+03  7.99737501e+03  4.77654022e+04]
E1 = -182.84810398338968  E_coul = 54.307721363259134
cycle= 2 E= -128.540382620131  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258294
diis-c [-6.44237989e-04  3.35826851e-01  6.64173149e-01]
  HOMO = -0.848537713677223  LUMO = 0.807113825078756
  mo_energy =
[-3.27698063e+01 -1.92889568e+00 -8.48537714e-01 -8.48537714e-01
 -8.48537714e-01  8.07113825e-01  8.07113825e-01  8.07113825e-01
  1.19128295e+00  3.89394695e+00  3.89394695e+00  3.89394695e+00
  7.30320250e+00  1.42403390e+01  1.42403390e+01  1.42403390e+01
  3.45510461e+01  5.28308739e+01  5.28308739e+01  5.28308739e+01
  1.38123446e+02  2.40400696e+02  2.40400696e+02  2.40400696e+02
  5.01096837e+02  1.86787196e+03  7.99749941e+03  4.77655275e+04]
E1 = -182.59000844714052  E_coul = 54.04870905364774
cycle= 3 E= -128.541299393493  delta_E= -0.000917  |g|= 0.000502  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117322
diis-c [-1.23495224e-07 -2.25464828e-03 -1.00322266e-04  1.00235497e+00]
  HOMO = -0.848792034556405  LUMO = 0.80707764902023
  mo_energy =
[-3.27702757e+01 -1.92909288e+00 -8.48792035e-01 -8.48792035e-01
 -8.48792035e-01  8.07077649e-01  8.07077649e-01  8.07077649e-01
  1.19120817e+00  3.89377024e+00  3.89377024e+00  3.89377024e+00
  7.30298651e+00  1.42400330e+01  1.42400330e+01  1.42400330e+01
  3.45506843e+01  5.28304599e+01  5.28304599e+01  5.28304599e+01
  1.38122974e+02  2.40400156e+02  2.40400156e+02  2.40400156e+02
  5.01096240e+02  1.86787122e+03  7.99749858e+03  4.77655267e+04]
E1 = -182.59055427082208  E_coul = 54.049254856132286
cycle= 4 E= -128.54129941469  delta_E= -2.12e-08  |g|= 7.51e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184854
diis-c [-7.94926336e-10  1.92930236e-04  4.82994566e-04 -1.59273179e-01
  1.15859725e+00]
  HOMO = -0.848831391273555  LUMO = 0.807065894376324
  mo_energy =
[-3.27703465e+01 -1.92912404e+00 -8.48831391e-01 -8.48831391e-01
 -8.48831391e-01  8.07065894e-01  8.07065894e-01  8.07065894e-01
  1.19119111e+00  3.89373331e+00  3.89373331e+00  3.89373331e+00
  7.30294495e+00  1.42399774e+01  1.42399774e+01  1.42399774e+01
  3.45506224e+01  5.28303934e+01  5.28303934e+01  5.28303934e+01
  1.38122903e+02  2.40400081e+02  2.40400081e+02  2.40400081e+02
  5.01096161e+02  1.86787114e+03  7.99749849e+03  4.77655266e+04]
E1 = -182.59069747901964  E_coul = 54.04939806378269
cycle= 5 E= -128.541299415237  delta_E= -5.47e-10  |g|= 4.48e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59069747901964  E_coul = 54.04939806378269
  HOMO = -0.84882923280029  LUMO = 0.807066537784759
  mo_energy =
[-3.27703418e+01 -1.92912116e+00 -8.48829233e-01 -8.48829233e-01
 -8.48829233e-01  8.07066538e-01  8.07066538e-01  8.07066538e-01
  1.19119256e+00  3.89373540e+00  3.89373540e+00  3.89373540e+00
  7.30294795e+00  1.42399810e+01  1.42399810e+01  1.42399810e+01
  3.45506267e+01  5.28303979e+01  5.28303979e+01  5.28303979e+01
  1.38122908e+02  2.40400085e+02  2.40400085e+02  2.40400085e+02
  5.01096165e+02  1.86787114e+03  7.99749849e+03  4.77655266e+04]
E1 = -182.59068676119148  E_coul = 54.049387345952766
Extra cycle  E= -128.541299415239  delta_E= -1.76e-12  |g|= 1.53e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137942e+04 3.66145185e+03 8.33314313e+02 2.35482031e+02
 7.60524332e+01 1.00106750e+01 2.69247092e+01 3.82051169e-01
 1.11944435e+00 2.88687124e+00 7.11802185e+00 2.31649980e+01
 9.96670756e+01 2.66407967e-01 2.44267428e+00 8.34470535e-01]
E = -128.5412994152387
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941811        1
[INPUT] 0    0    [1    /1   ]  3661.45185045        1
[INPUT] 0    0    [1    /1   ]  833.314313028        1
[INPUT] 0    0    [1    /1   ]  235.482030654        1
[INPUT] 0    0    [1    /1   ]  76.0524331847        1
[INPUT] 0    0    [1    /1   ]  10.0106750013        1
[INPUT] 0    0    [1    /1   ]  26.9247092348        1
[INPUT] 0    0    [1    /1   ]  0.382051168557       1
[INPUT] 0    0    [1    /1   ]  1.1194443522         1
[INPUT] 0    0    [1    /1   ]  2.88687123586        1
[INPUT] 1    0    [1    /1   ]  7.11802184913        1
[INPUT] 1    0    [1    /1   ]  23.1649979975        1
[INPUT] 1    0    [1    /1   ]  99.6670755946        1
[INPUT] 1    0    [1    /1   ]  0.266407966885       1
[INPUT] 1    0    [1    /1   ]  2.44267427786        1
[INPUT] 1    0    [1    /1   ]  0.834470534588       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79418114001, 1.0]], [0, [3661.4518504524776, 1.0]], [0, [833.3143130275538, 1.0]], [0, [235.4820306541364, 1.0]], [0, [76.05243318465874, 1.0]], [0, [10.01067500127778, 1.0]], [0, [26.924709234776095, 1.0]], [0, [0.3820511685570801, 1.0]], [0, [1.1194443521965518, 1.0]], [0, [2.8868712358615056, 1.0]], [1, [7.118021849129105, 1.0]], [1, [23.164997997471467, 1.0]], [1, [99.66707559464719, 1.0]], [1, [0.2664079668848507, 1.0]], [1, [2.4426742778610246, 1.0]], [1, [0.8344705345883848, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418114]
bas 1, expnt(s) = [3661.45185045]
bas 2, expnt(s) = [833.31431303]
bas 3, expnt(s) = [235.48203065]
bas 4, expnt(s) = [76.05243318]
bas 5, expnt(s) = [10.010675]
bas 6, expnt(s) = [26.92470923]
bas 7, expnt(s) = [0.38205117]
bas 8, expnt(s) = [1.11944435]
bas 9, expnt(s) = [2.88687124]
bas 10, expnt(s) = [7.11802185]
bas 11, expnt(s) = [23.164998]
bas 12, expnt(s) = [99.66707559]
bas 13, expnt(s) = [0.26640797]
bas 14, expnt(s) = [2.44267428]
bas 15, expnt(s) = [0.83447053]
CPU time:       379.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145185e+03 1.18920033e+03
 8.33314313e+02 3.91851628e+02 2.35482031e+02 1.51873973e+02
 7.60524332e+01 6.50653633e+01 1.00106750e+01 1.42187869e+01
 2.69247092e+01 2.98626463e+01 3.82051169e-01 1.22773934e+00
 1.11944435e+00 2.74958346e+00 2.88687124e+00 5.59545728e+00
 7.11802185e+00 3.39182579e+01 2.31649980e+01 1.48260249e+02
 9.96670756e+01 9.18700678e+02 2.66407967e-01 5.58365277e-01
 2.44267428e+00 8.90874117e+00 8.34470535e-01 2.32674158e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999581402653497
cond(S) = 345.9406352166797
E1 = -183.58944227618582  E_coul = 55.08016406696531
init E= -128.50927820922
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402136090869  LUMO = 0.825089744321058
  mo_energy =
[-3.25550611e+01 -1.85258671e+00 -7.75402136e-01 -7.75402136e-01
 -7.75402136e-01  8.25089744e-01  8.25089744e-01  8.25089744e-01
  1.22219061e+00  3.95971321e+00  3.95971321e+00  3.95971321e+00
  7.39189886e+00  1.43676828e+01  1.43676828e+01  1.43676828e+01
  3.47148936e+01  5.30175173e+01  5.30175173e+01  5.30175173e+01
  1.38334832e+02  2.40632913e+02  2.40632913e+02  2.40632913e+02
  5.01341165e+02  1.86814700e+03  7.99780101e+03  4.77658471e+04]
E1 = -182.08785071583452  E_coul = 53.55004944151469
cycle= 1 E= -128.53780127432  delta_E= -0.0285  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508996
diis-c [-0.25907653  1.        ]
  HOMO = -0.884120117610122  LUMO = 0.798384145638982
  mo_energy =
[-3.28777903e+01 -1.96637396e+00 -8.84120118e-01 -8.84120118e-01
 -8.84120118e-01  7.98384146e-01  7.98384146e-01  7.98384146e-01
  1.17664851e+00  3.86235207e+00  3.86235207e+00  3.86235207e+00
  7.25993248e+00  1.41772049e+01  1.41772049e+01  1.41772049e+01
  3.44684646e+01  5.27369619e+01  5.27369619e+01  5.27369619e+01
  1.38017514e+02  2.40287155e+02  2.40287155e+02  2.40287155e+02
  5.00980113e+02  1.86774999e+03  7.99737501e+03  4.77654022e+04]
E1 = -182.84810398338968  E_coul = 54.307721363259134
cycle= 2 E= -128.540382620131  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258294
diis-c [-6.44237989e-04  3.35826851e-01  6.64173149e-01]
  HOMO = -0.848537713677223  LUMO = 0.807113825078756
  mo_energy =
[-3.27698063e+01 -1.92889568e+00 -8.48537714e-01 -8.48537714e-01
 -8.48537714e-01  8.07113825e-01  8.07113825e-01  8.07113825e-01
  1.19128295e+00  3.89394695e+00  3.89394695e+00  3.89394695e+00
  7.30320250e+00  1.42403390e+01  1.42403390e+01  1.42403390e+01
  3.45510461e+01  5.28308739e+01  5.28308739e+01  5.28308739e+01
  1.38123446e+02  2.40400696e+02  2.40400696e+02  2.40400696e+02
  5.01096837e+02  1.86787196e+03  7.99749941e+03  4.77655275e+04]
E1 = -182.59000844714052  E_coul = 54.04870905364774
cycle= 3 E= -128.541299393493  delta_E= -0.000917  |g|= 0.000502  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117322
diis-c [-1.23495224e-07 -2.25464828e-03 -1.00322266e-04  1.00235497e+00]
  HOMO = -0.848792034556405  LUMO = 0.80707764902023
  mo_energy =
[-3.27702757e+01 -1.92909288e+00 -8.48792035e-01 -8.48792035e-01
 -8.48792035e-01  8.07077649e-01  8.07077649e-01  8.07077649e-01
  1.19120817e+00  3.89377024e+00  3.89377024e+00  3.89377024e+00
  7.30298651e+00  1.42400330e+01  1.42400330e+01  1.42400330e+01
  3.45506843e+01  5.28304599e+01  5.28304599e+01  5.28304599e+01
  1.38122974e+02  2.40400156e+02  2.40400156e+02  2.40400156e+02
  5.01096240e+02  1.86787122e+03  7.99749858e+03  4.77655267e+04]
E1 = -182.59055427082208  E_coul = 54.049254856132286
cycle= 4 E= -128.54129941469  delta_E= -2.12e-08  |g|= 7.51e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184854
diis-c [-7.94926336e-10  1.92930236e-04  4.82994566e-04 -1.59273179e-01
  1.15859725e+00]
  HOMO = -0.848831391273555  LUMO = 0.807065894376324
  mo_energy =
[-3.27703465e+01 -1.92912404e+00 -8.48831391e-01 -8.48831391e-01
 -8.48831391e-01  8.07065894e-01  8.07065894e-01  8.07065894e-01
  1.19119111e+00  3.89373331e+00  3.89373331e+00  3.89373331e+00
  7.30294495e+00  1.42399774e+01  1.42399774e+01  1.42399774e+01
  3.45506224e+01  5.28303934e+01  5.28303934e+01  5.28303934e+01
  1.38122903e+02  2.40400081e+02  2.40400081e+02  2.40400081e+02
  5.01096161e+02  1.86787114e+03  7.99749849e+03  4.77655266e+04]
E1 = -182.59069747901964  E_coul = 54.04939806378269
cycle= 5 E= -128.541299415237  delta_E= -5.47e-10  |g|= 4.48e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59069747901964  E_coul = 54.04939806378269
  HOMO = -0.84882923280029  LUMO = 0.807066537784759
  mo_energy =
[-3.27703418e+01 -1.92912116e+00 -8.48829233e-01 -8.48829233e-01
 -8.48829233e-01  8.07066538e-01  8.07066538e-01  8.07066538e-01
  1.19119256e+00  3.89373540e+00  3.89373540e+00  3.89373540e+00
  7.30294795e+00  1.42399810e+01  1.42399810e+01  1.42399810e+01
  3.45506267e+01  5.28303979e+01  5.28303979e+01  5.28303979e+01
  1.38122908e+02  2.40400085e+02  2.40400085e+02  2.40400085e+02
  5.01096165e+02  1.86787114e+03  7.99749849e+03  4.77655266e+04]
E1 = -182.59068676119148  E_coul = 54.049387345952766
Extra cycle  E= -128.541299415239  delta_E= -1.76e-12  |g|= 1.53e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 345.9406352166797
E1 = -182.59068676119148  E_coul = 54.049387345952766
init E= -128.541299415239
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.848829997127906  LUMO = 0.807066364231838
  mo_energy =
[-3.27703442e+01 -1.92912183e+00 -8.48829997e-01 -8.48829997e-01
 -8.48829997e-01  8.07066364e-01  8.07066364e-01  8.07066364e-01
  1.19119234e+00  3.89373474e+00  3.89373474e+00  3.89373474e+00
  7.30294710e+00  1.42399796e+01  1.42399796e+01  1.42399796e+01
  3.45506250e+01  5.28303959e+01  5.28303959e+01  5.28303959e+01
  1.38122905e+02  2.40400083e+02  2.40400083e+02  2.40400083e+02
  5.01096163e+02  1.86787114e+03  7.99749849e+03  4.77655266e+04]
E1 = -182.59069276861717  E_coul = 54.049393353378306
cycle= 1 E= -128.541299415239  delta_E= -1.71e-13  |g|= 8.29e-07  |ddm|= 5.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59069276861717  E_coul = 54.049393353378306
  HOMO = -0.848829575668789  LUMO = 0.80706647034655
  mo_energy =
[-3.27703429e+01 -1.92912136e+00 -8.48829576e-01 -8.48829576e-01
 -8.48829576e-01  8.07066470e-01  8.07066470e-01  8.07066470e-01
  1.19119253e+00  3.89373512e+00  3.89373512e+00  3.89373512e+00
  7.30294762e+00  1.42399804e+01  1.42399804e+01  1.42399804e+01
  3.45506259e+01  5.28303970e+01  5.28303970e+01  5.28303970e+01
  1.38122907e+02  2.40400084e+02  2.40400084e+02  2.40400084e+02
  5.01096164e+02  1.86787114e+03  7.99749849e+03  4.77655266e+04]
E1 = -182.59068976357455  E_coul = 54.04939034833546
Extra cycle  E= -128.541299415239  delta_E= -1.99e-13  |g|= 4.08e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [2.44137942e+04 3.66145185e+03 8.33314313e+02 2.35482031e+02
 7.60524332e+01 1.00106750e+01 2.69247092e+01 3.82051169e-01
 1.11944435e+00 2.88687124e+00 7.11802185e+00 2.31649980e+01
 9.96670756e+01 2.66407967e-01 2.44267428e+00 8.34470535e-01]
grad_E = [-3.72213523e-10  2.01608870e-08 -4.25163404e-07  4.48795026e-06
 -1.56821939e-05 -1.84466201e-05  2.84438916e-05 -8.81492385e-05
  1.11991416e-04 -4.30065223e-06  5.01868734e-05 -6.97931104e-06
  5.71562964e-09  9.94652633e-06 -9.25455232e-05  4.45242827e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941874        1
[INPUT] 0    0    [1    /1   ]  3661.4515257         1
[INPUT] 0    0    [1    /1   ]  833.320060883        1
[INPUT] 0    0    [1    /1   ]  235.436831153        1
[INPUT] 0    0    [1    /1   ]  76.1419158383        1
[INPUT] 0    0    [1    /1   ]  10.0053753637        1
[INPUT] 0    0    [1    /1   ]  26.9402819249        1
[INPUT] 0    0    [1    /1   ]  0.380746542028       1
[INPUT] 0    0    [1    /1   ]  1.11387996906        1
[INPUT] 0    0    [1    /1   ]  2.8726132956         1
[INPUT] 1    0    [1    /1   ]  7.11570060982        1
[INPUT] 1    0    [1    /1   ]  23.1729958469        1
[INPUT] 1    0    [1    /1   ]  99.7776991657        1
[INPUT] 1    0    [1    /1   ]  0.266413128557       1
[INPUT] 1    0    [1    /1   ]  2.44244203471        1
[INPUT] 1    0    [1    /1   ]  0.834531953461       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79418744266, 1.0]], [0, [3661.4515256975938, 1.0]], [0, [833.3200608829086, 1.0]], [0, [235.43683115346653, 1.0]], [0, [76.14191583834223, 1.0]], [0, [10.005375363712039, 1.0]], [0, [26.940281924911485, 1.0]], [0, [0.38074654202779706, 1.0]], [0, [1.1138799690631815, 1.0]], [0, [2.87261329560002, 1.0]], [1, [7.1157006098205, 1.0]], [1, [23.172995846934192, 1.0]], [1, [99.77769916571202, 1.0]], [1, [0.2664131285566671, 1.0]], [1, [2.4424420347091127, 1.0]], [1, [0.8345319534605661, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418744]
bas 1, expnt(s) = [3661.4515257]
bas 2, expnt(s) = [833.32006088]
bas 3, expnt(s) = [235.43683115]
bas 4, expnt(s) = [76.14191584]
bas 5, expnt(s) = [10.00537536]
bas 6, expnt(s) = [26.94028192]
bas 7, expnt(s) = [0.38074654]
bas 8, expnt(s) = [1.11387997]
bas 9, expnt(s) = [2.8726133]
bas 10, expnt(s) = [7.11570061]
bas 11, expnt(s) = [23.17299585]
bas 12, expnt(s) = [99.77769917]
bas 13, expnt(s) = [0.26641313]
bas 14, expnt(s) = [2.44244203]
bas 15, expnt(s) = [0.83453195]
CPU time:       382.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145153e+03 1.18920025e+03
 8.33320061e+02 3.91853655e+02 2.35436831e+02 1.51852109e+02
 7.61419158e+01 6.51227714e+01 1.00053754e+01 1.42131410e+01
 2.69402819e+01 2.98755993e+01 3.80746542e-01 1.22459364e+00
 1.11387997e+00 2.73932663e+00 2.87261330e+00 5.57471794e+00
 7.11570061e+00 3.39044323e+01 2.31729958e+01 1.48324237e+02
 9.97776992e+01 9.19975473e+02 2.66413129e-01 5.58378800e-01
 2.44244203e+00 8.90768241e+00 8.34531953e-01 2.32695565e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999583016974938
cond(S) = 343.7050244575592
E1 = -183.58941054810887  E_coul = 55.08016799480843
init E= -128.5092425533
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401919500278  LUMO = 0.825114681860365
  mo_energy =
[-3.25550574e+01 -1.85258992e+00 -7.75401920e-01 -7.75401920e-01
 -7.75401920e-01  8.25114682e-01  8.25114682e-01  8.25114682e-01
  1.21505806e+00  3.95981673e+00  3.95981673e+00  3.95981673e+00
  7.34955677e+00  1.43654761e+01  1.43654761e+01  1.43654761e+01
  3.46301369e+01  5.30202994e+01  5.30202994e+01  5.30202994e+01
  1.38323633e+02  2.40836734e+02  2.40836734e+02  2.40836734e+02
  5.01487260e+02  1.86831437e+03  7.99794288e+03  4.77659644e+04]
E1 = -182.0877810244799  E_coul = 53.549979020586335
cycle= 1 E= -128.537802003894  delta_E= -0.0286  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508975
diis-c [-0.25905532  1.        ]
  HOMO = -0.88412636485398  LUMO = 0.79840515613551
  mo_energy =
[-3.28778004e+01 -1.96638089e+00 -8.84126365e-01 -8.84126365e-01
 -8.84126365e-01  7.98405156e-01  7.98405156e-01  7.98405156e-01
  1.16976485e+00  3.86245316e+00  3.86245316e+00  3.86245316e+00
  7.21796551e+00  1.41750099e+01  1.41750099e+01  1.41750099e+01
  3.43837246e+01  5.27397126e+01  5.27397126e+01  5.27397126e+01
  1.38006253e+02  2.40490926e+02  2.40490926e+02  2.40490926e+02
  5.01126182e+02  1.86791735e+03  7.99751687e+03  4.77655195e+04]
E1 = -182.84807793441433  E_coul = 54.30769439021175
cycle= 2 E= -128.540383544203  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258286
diis-c [-6.43660903e-04  3.35829287e-01  6.64170713e-01]
  HOMO = -0.848541847655119  LUMO = 0.807135928679
  mo_energy =
[-3.27698111e+01 -1.92890080e+00 -8.48541848e-01 -8.48541848e-01
 -8.48541848e-01  8.07135929e-01  8.07135929e-01  8.07135929e-01
  1.18431831e+00  3.89404886e+00  3.89404886e+00  3.89404886e+00
  7.26110980e+00  1.42381406e+01  1.42381406e+01  1.42381406e+01
  3.44663018e+01  5.28336353e+01  5.28336353e+01  5.28336353e+01
  1.38112206e+02  2.40604483e+02  2.40604483e+02  2.40604483e+02
  5.01242915e+02  1.86803932e+03  7.99764127e+03  4.77656448e+04]
E1 = -182.58996357047013  E_coul = 54.04866314641306
cycle= 3 E= -128.541300424057  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117399
diis-c [-1.24079164e-07 -2.25440324e-03 -9.74846408e-05  1.00235189e+00]
  HOMO = -0.848796361095424  LUMO = 0.807099691915572
  mo_energy =
[-3.27702807e+01 -1.92909803e+00 -8.48796361e-01 -8.48796361e-01
 -8.48796361e-01  8.07099692e-01  8.07099692e-01  8.07099692e-01
  1.18424386e+00  3.89387201e+00  3.89387201e+00  3.89387201e+00
  7.26089427e+00  1.42378343e+01  1.42378343e+01  1.42378343e+01
  3.44659399e+01  5.28332210e+01  5.28332210e+01  5.28332210e+01
  1.38111734e+02  2.40603942e+02  2.40603942e+02  2.40603942e+02
  5.01242318e+02  1.86803859e+03  7.99764045e+03  4.77656440e+04]
E1 = -182.5905094313448  E_coul = 54.04920898601668
cycle= 4 E= -128.541300445328  delta_E= -2.13e-08  |g|= 7.53e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185099
diis-c [-7.98651608e-10  1.93553969e-04  4.83166781e-04 -1.59695520e-01
  1.15901880e+00]
  HOMO = -0.848835788459771  LUMO = 0.80708791548433
  mo_energy =
[-3.27703516e+01 -1.92912922e+00 -8.48835788e-01 -8.48835788e-01
 -8.48835788e-01  8.07087915e-01  8.07087915e-01  8.07087915e-01
  1.18422686e+00  3.89383503e+00  3.89383503e+00  3.89383503e+00
  7.26085276e+00  1.42377787e+01  1.42377787e+01  1.42377787e+01
  3.44658780e+01  5.28331544e+01  5.28331544e+01  5.28331544e+01
  1.38111663e+02  2.40603866e+02  2.40603866e+02  2.40603866e+02
  5.01242239e+02  1.86803850e+03  7.99764035e+03  4.77656439e+04]
E1 = -182.59065274698654  E_coul = 54.04935230110814
cycle= 5 E= -128.541300445878  delta_E= -5.5e-10  |g|= 4.5e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59065274698654  E_coul = 54.04935230110814
  HOMO = -0.848833619404607  LUMO = 0.807088562293772
  mo_energy =
[-3.27703469e+01 -1.92912632e+00 -8.48833619e-01 -8.48833619e-01
 -8.48833619e-01  8.07088562e-01  8.07088562e-01  8.07088562e-01
  1.18422831e+00  3.89383712e+00  3.89383712e+00  3.89383712e+00
  7.26085577e+00  1.42377823e+01  1.42377823e+01  1.42377823e+01
  3.44658823e+01  5.28331589e+01  5.28331589e+01  5.28331589e+01
  1.38111667e+02  2.40603871e+02  2.40603871e+02  2.40603871e+02
  5.01242243e+02  1.86803851e+03  7.99764036e+03  4.77656439e+04]
E1 = -182.59064198509702  E_coul = 54.04934153921709
Extra cycle  E= -128.54130044588  delta_E= -1.53e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137942e+04 3.66145153e+03 8.33320061e+02 2.35436831e+02
 7.61419158e+01 1.00053754e+01 2.69402819e+01 3.80746542e-01
 1.11387997e+00 2.87261330e+00 7.11570061e+00 2.31729958e+01
 9.97776992e+01 2.66413129e-01 2.44244203e+00 8.34531953e-01]
E = -128.54130044587993
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941874        1
[INPUT] 0    0    [1    /1   ]  3661.4515257         1
[INPUT] 0    0    [1    /1   ]  833.320060883        1
[INPUT] 0    0    [1    /1   ]  235.436831153        1
[INPUT] 0    0    [1    /1   ]  76.1419158383        1
[INPUT] 0    0    [1    /1   ]  10.0053753637        1
[INPUT] 0    0    [1    /1   ]  26.9402819249        1
[INPUT] 0    0    [1    /1   ]  0.380746542028       1
[INPUT] 0    0    [1    /1   ]  1.11387996906        1
[INPUT] 0    0    [1    /1   ]  2.8726132956         1
[INPUT] 1    0    [1    /1   ]  7.11570060982        1
[INPUT] 1    0    [1    /1   ]  23.1729958469        1
[INPUT] 1    0    [1    /1   ]  99.7776991657        1
[INPUT] 1    0    [1    /1   ]  0.266413128557       1
[INPUT] 1    0    [1    /1   ]  2.44244203471        1
[INPUT] 1    0    [1    /1   ]  0.834531953461       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.79418744266, 1.0]], [0, [3661.4515256975938, 1.0]], [0, [833.3200608829086, 1.0]], [0, [235.43683115346653, 1.0]], [0, [76.14191583834223, 1.0]], [0, [10.005375363712039, 1.0]], [0, [26.940281924911485, 1.0]], [0, [0.38074654202779706, 1.0]], [0, [1.1138799690631815, 1.0]], [0, [2.87261329560002, 1.0]], [1, [7.1157006098205, 1.0]], [1, [23.172995846934192, 1.0]], [1, [99.77769916571202, 1.0]], [1, [0.2664131285566671, 1.0]], [1, [2.4424420347091127, 1.0]], [1, [0.8345319534605661, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418744]
bas 1, expnt(s) = [3661.4515257]
bas 2, expnt(s) = [833.32006088]
bas 3, expnt(s) = [235.43683115]
bas 4, expnt(s) = [76.14191584]
bas 5, expnt(s) = [10.00537536]
bas 6, expnt(s) = [26.94028192]
bas 7, expnt(s) = [0.38074654]
bas 8, expnt(s) = [1.11387997]
bas 9, expnt(s) = [2.8726133]
bas 10, expnt(s) = [7.11570061]
bas 11, expnt(s) = [23.17299585]
bas 12, expnt(s) = [99.77769917]
bas 13, expnt(s) = [0.26641313]
bas 14, expnt(s) = [2.44244203]
bas 15, expnt(s) = [0.83453195]
CPU time:       384.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145153e+03 1.18920025e+03
 8.33320061e+02 3.91853655e+02 2.35436831e+02 1.51852109e+02
 7.61419158e+01 6.51227714e+01 1.00053754e+01 1.42131410e+01
 2.69402819e+01 2.98755993e+01 3.80746542e-01 1.22459364e+00
 1.11387997e+00 2.73932663e+00 2.87261330e+00 5.57471794e+00
 7.11570061e+00 3.39044323e+01 2.31729958e+01 1.48324237e+02
 9.97776992e+01 9.19975473e+02 2.66413129e-01 5.58378800e-01
 2.44244203e+00 8.90768241e+00 8.34531953e-01 2.32695565e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999583016974938
cond(S) = 343.7050244575592
E1 = -183.58941054810887  E_coul = 55.08016799480843
init E= -128.5092425533
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401919500278  LUMO = 0.825114681860365
  mo_energy =
[-3.25550574e+01 -1.85258992e+00 -7.75401920e-01 -7.75401920e-01
 -7.75401920e-01  8.25114682e-01  8.25114682e-01  8.25114682e-01
  1.21505806e+00  3.95981673e+00  3.95981673e+00  3.95981673e+00
  7.34955677e+00  1.43654761e+01  1.43654761e+01  1.43654761e+01
  3.46301369e+01  5.30202994e+01  5.30202994e+01  5.30202994e+01
  1.38323633e+02  2.40836734e+02  2.40836734e+02  2.40836734e+02
  5.01487260e+02  1.86831437e+03  7.99794288e+03  4.77659644e+04]
E1 = -182.0877810244799  E_coul = 53.549979020586335
cycle= 1 E= -128.537802003894  delta_E= -0.0286  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508975
diis-c [-0.25905532  1.        ]
  HOMO = -0.88412636485398  LUMO = 0.79840515613551
  mo_energy =
[-3.28778004e+01 -1.96638089e+00 -8.84126365e-01 -8.84126365e-01
 -8.84126365e-01  7.98405156e-01  7.98405156e-01  7.98405156e-01
  1.16976485e+00  3.86245316e+00  3.86245316e+00  3.86245316e+00
  7.21796551e+00  1.41750099e+01  1.41750099e+01  1.41750099e+01
  3.43837246e+01  5.27397126e+01  5.27397126e+01  5.27397126e+01
  1.38006253e+02  2.40490926e+02  2.40490926e+02  2.40490926e+02
  5.01126182e+02  1.86791735e+03  7.99751687e+03  4.77655195e+04]
E1 = -182.84807793441433  E_coul = 54.30769439021175
cycle= 2 E= -128.540383544203  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258286
diis-c [-6.43660903e-04  3.35829287e-01  6.64170713e-01]
  HOMO = -0.848541847655119  LUMO = 0.807135928679
  mo_energy =
[-3.27698111e+01 -1.92890080e+00 -8.48541848e-01 -8.48541848e-01
 -8.48541848e-01  8.07135929e-01  8.07135929e-01  8.07135929e-01
  1.18431831e+00  3.89404886e+00  3.89404886e+00  3.89404886e+00
  7.26110980e+00  1.42381406e+01  1.42381406e+01  1.42381406e+01
  3.44663018e+01  5.28336353e+01  5.28336353e+01  5.28336353e+01
  1.38112206e+02  2.40604483e+02  2.40604483e+02  2.40604483e+02
  5.01242915e+02  1.86803932e+03  7.99764127e+03  4.77656448e+04]
E1 = -182.58996357047013  E_coul = 54.04866314641306
cycle= 3 E= -128.541300424057  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117399
diis-c [-1.24079164e-07 -2.25440324e-03 -9.74846408e-05  1.00235189e+00]
  HOMO = -0.848796361095424  LUMO = 0.807099691915572
  mo_energy =
[-3.27702807e+01 -1.92909803e+00 -8.48796361e-01 -8.48796361e-01
 -8.48796361e-01  8.07099692e-01  8.07099692e-01  8.07099692e-01
  1.18424386e+00  3.89387201e+00  3.89387201e+00  3.89387201e+00
  7.26089427e+00  1.42378343e+01  1.42378343e+01  1.42378343e+01
  3.44659399e+01  5.28332210e+01  5.28332210e+01  5.28332210e+01
  1.38111734e+02  2.40603942e+02  2.40603942e+02  2.40603942e+02
  5.01242318e+02  1.86803859e+03  7.99764045e+03  4.77656440e+04]
E1 = -182.5905094313448  E_coul = 54.04920898601668
cycle= 4 E= -128.541300445328  delta_E= -2.13e-08  |g|= 7.53e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185099
diis-c [-7.98651608e-10  1.93553969e-04  4.83166781e-04 -1.59695520e-01
  1.15901880e+00]
  HOMO = -0.848835788459771  LUMO = 0.80708791548433
  mo_energy =
[-3.27703516e+01 -1.92912922e+00 -8.48835788e-01 -8.48835788e-01
 -8.48835788e-01  8.07087915e-01  8.07087915e-01  8.07087915e-01
  1.18422686e+00  3.89383503e+00  3.89383503e+00  3.89383503e+00
  7.26085276e+00  1.42377787e+01  1.42377787e+01  1.42377787e+01
  3.44658780e+01  5.28331544e+01  5.28331544e+01  5.28331544e+01
  1.38111663e+02  2.40603866e+02  2.40603866e+02  2.40603866e+02
  5.01242239e+02  1.86803850e+03  7.99764035e+03  4.77656439e+04]
E1 = -182.59065274698654  E_coul = 54.04935230110814
cycle= 5 E= -128.541300445878  delta_E= -5.5e-10  |g|= 4.5e-06  |ddm|= 3.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59065274698654  E_coul = 54.04935230110814
  HOMO = -0.848833619404607  LUMO = 0.807088562293772
  mo_energy =
[-3.27703469e+01 -1.92912632e+00 -8.48833619e-01 -8.48833619e-01
 -8.48833619e-01  8.07088562e-01  8.07088562e-01  8.07088562e-01
  1.18422831e+00  3.89383712e+00  3.89383712e+00  3.89383712e+00
  7.26085577e+00  1.42377823e+01  1.42377823e+01  1.42377823e+01
  3.44658823e+01  5.28331589e+01  5.28331589e+01  5.28331589e+01
  1.38111667e+02  2.40603871e+02  2.40603871e+02  2.40603871e+02
  5.01242243e+02  1.86803851e+03  7.99764036e+03  4.77656439e+04]
E1 = -182.59064198509702  E_coul = 54.04934153921709
Extra cycle  E= -128.54130044588  delta_E= -1.53e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.7050244575592
E1 = -182.59064198509702  E_coul = 54.04934153921709
init E= -128.54130044588
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848834386820788  LUMO = 0.807088388062204
  mo_energy =
[-3.27703493e+01 -1.92912699e+00 -8.48834387e-01 -8.48834387e-01
 -8.48834387e-01  8.07088388e-01  8.07088388e-01  8.07088388e-01
  1.18422809e+00  3.89383646e+00  3.89383646e+00  3.89383646e+00
  7.26085491e+00  1.42377809e+01  1.42377809e+01  1.42377809e+01
  3.44658805e+01  5.28331569e+01  5.28331569e+01  5.28331569e+01
  1.38111665e+02  2.40603868e+02  2.40603868e+02  2.40603868e+02
  5.01242241e+02  1.86803850e+03  7.99764035e+03  4.77656439e+04]
E1 = -182.5906480184099  E_coul = 54.04934757252955
cycle= 1 E= -128.54130044588  delta_E= -4.26e-13  |g|= 8.32e-07  |ddm|= 5.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5906480184099  E_coul = 54.04934757252955
  HOMO = -0.848833963539377  LUMO = 0.807088494644616
  mo_energy =
[-3.27703480e+01 -1.92912652e+00 -8.48833964e-01 -8.48833964e-01
 -8.48833964e-01  8.07088495e-01  8.07088495e-01  8.07088495e-01
  1.18422828e+00  3.89383684e+00  3.89383684e+00  3.89383684e+00
  7.26085544e+00  1.42377817e+01  1.42377817e+01  1.42377817e+01
  3.44658815e+01  5.28331580e+01  5.28331580e+01  5.28331580e+01
  1.38111666e+02  2.40603870e+02  2.40603870e+02  2.40603870e+02
  5.01242242e+02  1.86803851e+03  7.99764036e+03  4.77656439e+04]
E1 = -182.59064500041697  E_coul = 54.049344554536574
Extra cycle  E= -128.54130044588  delta_E= -2.84e-14  |g|= 4.1e-07  |ddm|= 2.93e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.33 sec
exp = [2.44137942e+04 3.66145153e+03 8.33320061e+02 2.35436831e+02
 7.61419158e+01 1.00053754e+01 2.69402819e+01 3.80746542e-01
 1.11387997e+00 2.87261330e+00 7.11570061e+00 2.31729958e+01
 9.97776992e+01 2.66413129e-01 2.44244203e+00 8.34531953e-01]
grad_E = [-9.58635305e-12  1.52789374e-09 -8.72567226e-08  1.50831672e-06
 -3.98835753e-06 -3.55188972e-06  1.04061177e-05 -1.33541074e-05
  1.64929990e-05  3.44493050e-06  1.29235421e-05 -1.76228368e-06
  4.23182979e-08  2.71253753e-06 -2.45090219e-05  1.23840076e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261642        1
[INPUT] 0    0    [1    /1   ]  235.442497605        1
[INPUT] 0    0    [1    /1   ]  76.138925686         1
[INPUT] 0    0    [1    /1   ]  9.99179086579        1
[INPUT] 0    0    [1    /1   ]  26.9186513219        1
[INPUT] 0    0    [1    /1   ]  0.379853594604       1
[INPUT] 0    0    [1    /1   ]  1.10977232002        1
[INPUT] 0    0    [1    /1   ]  2.85995276365        1
[INPUT] 1    0    [1    /1   ]  7.1138216687         1
[INPUT] 1    0    [1    /1   ]  23.1710125063        1
[INPUT] 1    0    [1    /1   ]  99.7863721101        1
[INPUT] 1    0    [1    /1   ]  0.2663986627         1
[INPUT] 1    0    [1    /1   ]  2.44209552332        1
[INPUT] 1    0    [1    /1   ]  0.834486593732       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794186547566, 1.0]], [0, [3661.4515715933576, 1.0]], [0, [833.3192616415741, 1.0]], [0, [235.44249760504746, 1.0]], [0, [76.13892568597512, 1.0]], [0, [9.991790865785616, 1.0]], [0, [26.918651321937844, 1.0]], [0, [0.3798535946043467, 1.0]], [0, [1.109772320020386, 1.0]], [0, [2.859952763645397, 1.0]], [1, [7.113821668699218, 1.0]], [1, [23.171012506273396, 1.0]], [1, [99.7863721100639, 1.0]], [1, [0.2663986626998784, 1.0]], [1, [2.442095523318457, 1.0]], [1, [0.8344865937319704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418655]
bas 1, expnt(s) = [3661.45157159]
bas 2, expnt(s) = [833.31926164]
bas 3, expnt(s) = [235.44249761]
bas 4, expnt(s) = [76.13892569]
bas 5, expnt(s) = [9.99179087]
bas 6, expnt(s) = [26.91865132]
bas 7, expnt(s) = [0.37985359]
bas 8, expnt(s) = [1.10977232]
bas 9, expnt(s) = [2.85995276]
bas 10, expnt(s) = [7.11382167]
bas 11, expnt(s) = [23.17101251]
bas 12, expnt(s) = [99.78637211]
bas 13, expnt(s) = [0.26639866]
bas 14, expnt(s) = [2.44209552]
bas 15, expnt(s) = [0.83448659]
CPU time:       387.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145157e+03 1.18920026e+03
 8.33319262e+02 3.91853373e+02 2.35442498e+02 1.51854850e+02
 7.61389257e+01 6.51208533e+01 9.99179087e+00 1.41986654e+01
 2.69186513e+01 2.98576070e+01 3.79853595e-01 1.22243902e+00
 1.10977232e+00 2.73174678e+00 2.85995276e+00 5.55628059e+00
 7.11382167e+00 3.38932418e+01 2.31710125e+01 1.48308368e+02
 9.97863721e+01 9.20075432e+02 2.66398663e-01 5.58340901e-01
 2.44209552e+00 8.90610276e+00 8.34486594e-01 2.32679755e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584362767493
cond(S) = 342.1310663872592
E1 = -183.58940207985628  E_coul = 55.08016877295094
init E= -128.509233306905
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401851052719  LUMO = 0.825055586703795
  mo_energy =
[-3.25550546e+01 -1.85259268e+00 -7.75401851e-01 -7.75401851e-01
 -7.75401851e-01  8.25055587e-01  8.25055587e-01  8.25055587e-01
  1.20988126e+00  3.95946599e+00  3.95946599e+00  3.95946599e+00
  7.31469422e+00  1.43627840e+01  1.43627840e+01  1.43627840e+01
  3.45298336e+01  5.30110363e+01  5.30110363e+01  5.30110363e+01
  1.38155293e+02  2.40838374e+02  2.40838374e+02  2.40838374e+02
  5.01292007e+02  1.86813426e+03  7.99778542e+03  4.77658340e+04]
E1 = -182.08772345671971  E_coul = 53.54992149683036
cycle= 1 E= -128.537801959889  delta_E= -0.0286  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508987
diis-c [-0.25906816  1.        ]
  HOMO = -0.884131182512951  LUMO = 0.798346307010843
  mo_energy =
[-3.28778090e+01 -1.96638678e+00 -8.84131183e-01 -8.84131183e-01
 -8.84131183e-01  7.98346307e-01  7.98346307e-01  7.98346307e-01
  1.16477569e+00  3.86210787e+00  3.86210787e+00  3.86210787e+00
  7.18345002e+00  1.41723313e+01  1.41723313e+01  1.41723313e+01
  3.42835268e+01  5.27304461e+01  5.27304461e+01  5.27304461e+01
  1.37837912e+02  2.40492551e+02  2.40492551e+02  2.40492551e+02
  5.00930911e+02  1.86773722e+03  7.99735939e+03  4.77653892e+04]
E1 = -182.84804838684144  E_coul = 54.3076647632043
cycle= 2 E= -128.540383623637  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258293
diis-c [-6.43147694e-04  3.35831029e-01  6.64168971e-01]
  HOMO = -0.848545323794189  LUMO = 0.807076672780389
  mo_energy =
[-3.27698162e+01 -1.92890552e+00 -8.48545324e-01 -8.48545324e-01
 -8.48545324e-01  8.07076673e-01  8.07076673e-01  8.07076673e-01
  1.17926770e+00  3.89370150e+00  3.89370150e+00  3.89370150e+00
  7.22647742e+00  1.42354572e+01  1.42354572e+01  1.42354572e+01
  3.43660682e+01  5.28243696e+01  5.28243696e+01  5.28243696e+01
  1.37943865e+02  2.40606112e+02  2.40606112e+02  2.40606112e+02
  5.01047650e+02  1.86785919e+03  7.99748380e+03  4.77655145e+04]
E1 = -182.5899195626196  E_coul = 54.04861898353259
cycle= 3 E= -128.541300579087  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117493
diis-c [-1.24496875e-07 -2.25523146e-03 -9.61373146e-05  1.00235137e+00]
  HOMO = -0.848800129848747  LUMO = 0.807040340972812
  mo_energy =
[-3.27702862e+01 -1.92910295e+00 -8.48800130e-01 -8.48800130e-01
 -8.48800130e-01  8.07040341e-01  8.07040341e-01  8.07040341e-01
  1.17919338e+00  3.89352441e+00  3.89352441e+00  3.89352441e+00
  7.22626213e+00  1.42351506e+01  1.42351506e+01  1.42351506e+01
  3.43657061e+01  5.28239549e+01  5.28239549e+01  5.28239549e+01
  1.37943393e+02  2.40605570e+02  2.40605570e+02  2.40605570e+02
  5.01047052e+02  1.86785846e+03  7.99748297e+03  4.77655136e+04]
E1 = -182.59046558264257  E_coul = 54.04916498220721
cycle= 4 E= -128.541300600435  delta_E= -2.13e-08  |g|= 7.54e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185289
diis-c [-8.01168310e-10  1.93899245e-04  4.83193134e-04 -1.59926768e-01
  1.15924968e+00]
  HOMO = -0.848839624467545  LUMO = 0.807028543533342
  mo_energy =
[-3.27703572e+01 -1.92913417e+00 -8.48839624e-01 -8.48839624e-01
 -8.48839624e-01  8.07028544e-01  8.07028544e-01  8.07028544e-01
  1.17917642e+00  3.89348737e+00  3.89348737e+00  3.89348737e+00
  7.22622063e+00  1.42350949e+01  1.42350949e+01  1.42350949e+01
  3.43656441e+01  5.28238882e+01  5.28238882e+01  5.28238882e+01
  1.37943322e+02  2.40605495e+02  2.40605495e+02  2.40605495e+02
  5.01046973e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59060895741325  E_coul = 54.04930835642555
cycle= 5 E= -128.541300600988  delta_E= -5.52e-10  |g|= 4.51e-06  |ddm|= 3.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59060895741325  E_coul = 54.04930835642555
  HOMO = -0.848837450056749  LUMO = 0.807029192042262
  mo_energy =
[-3.27703525e+01 -1.92913127e+00 -8.48837450e-01 -8.48837450e-01
 -8.48837450e-01  8.07029192e-01  8.07029192e-01  8.07029192e-01
  1.17917786e+00  3.89348947e+00  3.89348947e+00  3.89348947e+00
  7.22622365e+00  1.42350984e+01  1.42350984e+01  1.42350984e+01
  3.43656485e+01  5.28238927e+01  5.28238927e+01  5.28238927e+01
  1.37943327e+02  2.40605499e+02  2.40605499e+02  2.40605499e+02
  5.01046977e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59059817414786  E_coul = 54.04929757315866
Extra cycle  E= -128.541300600989  delta_E= -1.48e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137942e+04 3.66145157e+03 8.33319262e+02 2.35442498e+02
 7.61389257e+01 9.99179087e+00 2.69186513e+01 3.79853595e-01
 1.10977232e+00 2.85995276e+00 7.11382167e+00 2.31710125e+01
 9.97863721e+01 2.66398663e-01 2.44209552e+00 8.34486594e-01]
E = -128.5413006009892
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261642        1
[INPUT] 0    0    [1    /1   ]  235.442497605        1
[INPUT] 0    0    [1    /1   ]  76.138925686         1
[INPUT] 0    0    [1    /1   ]  9.99179086579        1
[INPUT] 0    0    [1    /1   ]  26.9186513219        1
[INPUT] 0    0    [1    /1   ]  0.379853594604       1
[INPUT] 0    0    [1    /1   ]  1.10977232002        1
[INPUT] 0    0    [1    /1   ]  2.85995276365        1
[INPUT] 1    0    [1    /1   ]  7.1138216687         1
[INPUT] 1    0    [1    /1   ]  23.1710125063        1
[INPUT] 1    0    [1    /1   ]  99.7863721101        1
[INPUT] 1    0    [1    /1   ]  0.2663986627         1
[INPUT] 1    0    [1    /1   ]  2.44209552332        1
[INPUT] 1    0    [1    /1   ]  0.834486593732       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794186547566, 1.0]], [0, [3661.4515715933576, 1.0]], [0, [833.3192616415741, 1.0]], [0, [235.44249760504746, 1.0]], [0, [76.13892568597512, 1.0]], [0, [9.991790865785616, 1.0]], [0, [26.918651321937844, 1.0]], [0, [0.3798535946043467, 1.0]], [0, [1.109772320020386, 1.0]], [0, [2.859952763645397, 1.0]], [1, [7.113821668699218, 1.0]], [1, [23.171012506273396, 1.0]], [1, [99.7863721100639, 1.0]], [1, [0.2663986626998784, 1.0]], [1, [2.442095523318457, 1.0]], [1, [0.8344865937319704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418655]
bas 1, expnt(s) = [3661.45157159]
bas 2, expnt(s) = [833.31926164]
bas 3, expnt(s) = [235.44249761]
bas 4, expnt(s) = [76.13892569]
bas 5, expnt(s) = [9.99179087]
bas 6, expnt(s) = [26.91865132]
bas 7, expnt(s) = [0.37985359]
bas 8, expnt(s) = [1.10977232]
bas 9, expnt(s) = [2.85995276]
bas 10, expnt(s) = [7.11382167]
bas 11, expnt(s) = [23.17101251]
bas 12, expnt(s) = [99.78637211]
bas 13, expnt(s) = [0.26639866]
bas 14, expnt(s) = [2.44209552]
bas 15, expnt(s) = [0.83448659]
CPU time:       388.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145157e+03 1.18920026e+03
 8.33319262e+02 3.91853373e+02 2.35442498e+02 1.51854850e+02
 7.61389257e+01 6.51208533e+01 9.99179087e+00 1.41986654e+01
 2.69186513e+01 2.98576070e+01 3.79853595e-01 1.22243902e+00
 1.10977232e+00 2.73174678e+00 2.85995276e+00 5.55628059e+00
 7.11382167e+00 3.38932418e+01 2.31710125e+01 1.48308368e+02
 9.97863721e+01 9.20075432e+02 2.66398663e-01 5.58340901e-01
 2.44209552e+00 8.90610276e+00 8.34486594e-01 2.32679755e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584362767493
cond(S) = 342.1310663872592
E1 = -183.58940207985628  E_coul = 55.08016877295094
init E= -128.509233306905
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401851052719  LUMO = 0.825055586703795
  mo_energy =
[-3.25550546e+01 -1.85259268e+00 -7.75401851e-01 -7.75401851e-01
 -7.75401851e-01  8.25055587e-01  8.25055587e-01  8.25055587e-01
  1.20988126e+00  3.95946599e+00  3.95946599e+00  3.95946599e+00
  7.31469422e+00  1.43627840e+01  1.43627840e+01  1.43627840e+01
  3.45298336e+01  5.30110363e+01  5.30110363e+01  5.30110363e+01
  1.38155293e+02  2.40838374e+02  2.40838374e+02  2.40838374e+02
  5.01292007e+02  1.86813426e+03  7.99778542e+03  4.77658340e+04]
E1 = -182.08772345671971  E_coul = 53.54992149683036
cycle= 1 E= -128.537801959889  delta_E= -0.0286  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508987
diis-c [-0.25906816  1.        ]
  HOMO = -0.884131182512951  LUMO = 0.798346307010843
  mo_energy =
[-3.28778090e+01 -1.96638678e+00 -8.84131183e-01 -8.84131183e-01
 -8.84131183e-01  7.98346307e-01  7.98346307e-01  7.98346307e-01
  1.16477569e+00  3.86210787e+00  3.86210787e+00  3.86210787e+00
  7.18345002e+00  1.41723313e+01  1.41723313e+01  1.41723313e+01
  3.42835268e+01  5.27304461e+01  5.27304461e+01  5.27304461e+01
  1.37837912e+02  2.40492551e+02  2.40492551e+02  2.40492551e+02
  5.00930911e+02  1.86773722e+03  7.99735939e+03  4.77653892e+04]
E1 = -182.84804838684144  E_coul = 54.3076647632043
cycle= 2 E= -128.540383623637  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258293
diis-c [-6.43147694e-04  3.35831029e-01  6.64168971e-01]
  HOMO = -0.848545323794189  LUMO = 0.807076672780389
  mo_energy =
[-3.27698162e+01 -1.92890552e+00 -8.48545324e-01 -8.48545324e-01
 -8.48545324e-01  8.07076673e-01  8.07076673e-01  8.07076673e-01
  1.17926770e+00  3.89370150e+00  3.89370150e+00  3.89370150e+00
  7.22647742e+00  1.42354572e+01  1.42354572e+01  1.42354572e+01
  3.43660682e+01  5.28243696e+01  5.28243696e+01  5.28243696e+01
  1.37943865e+02  2.40606112e+02  2.40606112e+02  2.40606112e+02
  5.01047650e+02  1.86785919e+03  7.99748380e+03  4.77655145e+04]
E1 = -182.5899195626196  E_coul = 54.04861898353259
cycle= 3 E= -128.541300579087  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117493
diis-c [-1.24496875e-07 -2.25523146e-03 -9.61373146e-05  1.00235137e+00]
  HOMO = -0.848800129848747  LUMO = 0.807040340972812
  mo_energy =
[-3.27702862e+01 -1.92910295e+00 -8.48800130e-01 -8.48800130e-01
 -8.48800130e-01  8.07040341e-01  8.07040341e-01  8.07040341e-01
  1.17919338e+00  3.89352441e+00  3.89352441e+00  3.89352441e+00
  7.22626213e+00  1.42351506e+01  1.42351506e+01  1.42351506e+01
  3.43657061e+01  5.28239549e+01  5.28239549e+01  5.28239549e+01
  1.37943393e+02  2.40605570e+02  2.40605570e+02  2.40605570e+02
  5.01047052e+02  1.86785846e+03  7.99748297e+03  4.77655136e+04]
E1 = -182.59046558264257  E_coul = 54.04916498220721
cycle= 4 E= -128.541300600435  delta_E= -2.13e-08  |g|= 7.54e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185289
diis-c [-8.01168310e-10  1.93899245e-04  4.83193134e-04 -1.59926768e-01
  1.15924968e+00]
  HOMO = -0.848839624467545  LUMO = 0.807028543533342
  mo_energy =
[-3.27703572e+01 -1.92913417e+00 -8.48839624e-01 -8.48839624e-01
 -8.48839624e-01  8.07028544e-01  8.07028544e-01  8.07028544e-01
  1.17917642e+00  3.89348737e+00  3.89348737e+00  3.89348737e+00
  7.22622063e+00  1.42350949e+01  1.42350949e+01  1.42350949e+01
  3.43656441e+01  5.28238882e+01  5.28238882e+01  5.28238882e+01
  1.37943322e+02  2.40605495e+02  2.40605495e+02  2.40605495e+02
  5.01046973e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59060895741325  E_coul = 54.04930835642555
cycle= 5 E= -128.541300600988  delta_E= -5.52e-10  |g|= 4.51e-06  |ddm|= 3.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59060895741325  E_coul = 54.04930835642555
  HOMO = -0.848837450056749  LUMO = 0.807029192042262
  mo_energy =
[-3.27703525e+01 -1.92913127e+00 -8.48837450e-01 -8.48837450e-01
 -8.48837450e-01  8.07029192e-01  8.07029192e-01  8.07029192e-01
  1.17917786e+00  3.89348947e+00  3.89348947e+00  3.89348947e+00
  7.22622365e+00  1.42350984e+01  1.42350984e+01  1.42350984e+01
  3.43656485e+01  5.28238927e+01  5.28238927e+01  5.28238927e+01
  1.37943327e+02  2.40605499e+02  2.40605499e+02  2.40605499e+02
  5.01046977e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59059817414786  E_coul = 54.04929757315866
Extra cycle  E= -128.541300600989  delta_E= -1.48e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 342.1310663872592
E1 = -182.59059817414786  E_coul = 54.04929757315866
init E= -128.541300600989
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848838218990253  LUMO = 0.807029017507431
  mo_energy =
[-3.27703549e+01 -1.92913194e+00 -8.48838219e-01 -8.48838219e-01
 -8.48838219e-01  8.07029018e-01  8.07029018e-01  8.07029018e-01
  1.17917764e+00  3.89348881e+00  3.89348881e+00  3.89348881e+00
  7.22622279e+00  1.42350971e+01  1.42350971e+01  1.42350971e+01
  3.43656467e+01  5.28238907e+01  5.28238907e+01  5.28238907e+01
  1.37943324e+02  2.40605497e+02  2.40605497e+02  2.40605497e+02
  5.01046975e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.5906042204345  E_coul = 54.04930361944491
cycle= 1 E= -128.54130060099  delta_E= -3.98e-13  |g|= 8.34e-07  |ddm|= 5.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5906042204345  E_coul = 54.04930361944491
  HOMO = -0.848837794798834  LUMO = 0.807029124313118
  mo_energy =
[-3.27703536e+01 -1.92913147e+00 -8.48837795e-01 -8.48837795e-01
 -8.48837795e-01  8.07029124e-01  8.07029124e-01  8.07029124e-01
  1.17917783e+00  3.89348920e+00  3.89348920e+00  3.89348920e+00
  7.22622332e+00  1.42350978e+01  1.42350978e+01  1.42350978e+01
  3.43656477e+01  5.28238918e+01  5.28238918e+01  5.28238918e+01
  1.37943325e+02  2.40605498e+02  2.40605498e+02  2.40605498e+02
  5.01046976e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59060119598047  E_coul = 54.04930059499103
Extra cycle  E= -128.541300600989  delta_E= 1.42e-13  |g|= 4.11e-07  |ddm|= 2.94e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137942e+04 3.66145157e+03 8.33319262e+02 2.35442498e+02
 7.61389257e+01 9.99179087e+00 2.69186513e+01 3.79853595e-01
 1.10977232e+00 2.85995276e+00 7.11382167e+00 2.31710125e+01
 9.97863721e+01 2.66398663e-01 2.44209552e+00 8.34486594e-01]
grad_E = [ 4.18074027e-11 -1.18983501e-09 -3.13955496e-08  8.43707887e-07
  2.09836779e-07  8.90752202e-07  1.34523086e-06 -3.41935381e-07
 -4.15710031e-06  1.80974723e-06 -5.98042583e-07  1.49786730e-07
  2.04487161e-08 -2.97990354e-06 -5.21440420e-07  3.39885104e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]

basis = "10s6p"

exps = np.zeros((16, 2))
exps[:-1, 0] = basis_sets["10s5p"][:]
exps[-1, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:20:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261642        1
[INPUT] 0    0    [1    /1   ]  235.442497605        1
[INPUT] 0    0    [1    /1   ]  76.138925686         1
[INPUT] 0    0    [1    /1   ]  9.99179086579        1
[INPUT] 0    0    [1    /1   ]  26.9186513219        1
[INPUT] 0    0    [1    /1   ]  0.379853594604       1
[INPUT] 0    0    [1    /1   ]  1.10977232002        1
[INPUT] 0    0    [1    /1   ]  2.85995276365        1
[INPUT] 1    0    [1    /1   ]  7.1138216687         1
[INPUT] 1    0    [1    /1   ]  23.1710125063        1
[INPUT] 1    0    [1    /1   ]  99.7863721101        1
[INPUT] 1    0    [1    /1   ]  0.2663986627         1
[INPUT] 1    0    [1    /1   ]  2.44209552332        1
[INPUT] 1    0    [1    /1   ]  0.834486593732       1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 28
number of NR cGTOs = 28
basis = {'Ne': [[0, [24413.794186547566, 1.0]], [0, [3661.4515715933576, 1.0]], [0, [833.3192616415741, 1.0]], [0, [235.44249760504746, 1.0]], [0, [76.13892568597512, 1.0]], [0, [9.991790865785616, 1.0]], [0, [26.918651321937844, 1.0]], [0, [0.3798535946043467, 1.0]], [0, [1.109772320020386, 1.0]], [0, [2.859952763645397, 1.0]], [1, [7.113821668699218, 1.0]], [1, [23.171012506273396, 1.0]], [1, [99.7863721100639, 1.0]], [1, [0.2663986626998784, 1.0]], [1, [2.442095523318457, 1.0]], [1, [0.8344865937319704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79418655]
bas 1, expnt(s) = [3661.45157159]
bas 2, expnt(s) = [833.31926164]
bas 3, expnt(s) = [235.44249761]
bas 4, expnt(s) = [76.13892569]
bas 5, expnt(s) = [9.99179087]
bas 6, expnt(s) = [26.91865132]
bas 7, expnt(s) = [0.37985359]
bas 8, expnt(s) = [1.10977232]
bas 9, expnt(s) = [2.85995276]
bas 10, expnt(s) = [7.11382167]
bas 11, expnt(s) = [23.17101251]
bas 12, expnt(s) = [99.78637211]
bas 13, expnt(s) = [0.26639866]
bas 14, expnt(s) = [2.44209552]
bas 15, expnt(s) = [0.83448659]
CPU time:       392.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137942e+04 4.93448103e+03 3.66145157e+03 1.18920026e+03
 8.33319262e+02 3.91853373e+02 2.35442498e+02 1.51854850e+02
 7.61389257e+01 6.51208533e+01 9.99179087e+00 1.41986654e+01
 2.69186513e+01 2.98576070e+01 3.79853595e-01 1.22243902e+00
 1.10977232e+00 2.73174678e+00 2.85995276e+00 5.55628059e+00
 7.11382167e+00 3.38932418e+01 2.31710125e+01 1.48308368e+02
 9.97863721e+01 9.20075432e+02 2.66398663e-01 5.58340901e-01
 2.44209552e+00 8.90610276e+00 8.34486594e-01 2.32679755e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999584362767493
cond(S) = 342.1310663872592
E1 = -183.58940207985628  E_coul = 55.08016877295094
init E= -128.509233306905
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401851052719  LUMO = 0.825055586703795
  mo_energy =
[-3.25550546e+01 -1.85259268e+00 -7.75401851e-01 -7.75401851e-01
 -7.75401851e-01  8.25055587e-01  8.25055587e-01  8.25055587e-01
  1.20988126e+00  3.95946599e+00  3.95946599e+00  3.95946599e+00
  7.31469422e+00  1.43627840e+01  1.43627840e+01  1.43627840e+01
  3.45298336e+01  5.30110363e+01  5.30110363e+01  5.30110363e+01
  1.38155293e+02  2.40838374e+02  2.40838374e+02  2.40838374e+02
  5.01292007e+02  1.86813426e+03  7.99778542e+03  4.77658340e+04]
E1 = -182.08772345671971  E_coul = 53.54992149683036
cycle= 1 E= -128.537801959889  delta_E= -0.0286  |g|= 0.204  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508987
diis-c [-0.25906816  1.        ]
  HOMO = -0.884131182512951  LUMO = 0.798346307010843
  mo_energy =
[-3.28778090e+01 -1.96638678e+00 -8.84131183e-01 -8.84131183e-01
 -8.84131183e-01  7.98346307e-01  7.98346307e-01  7.98346307e-01
  1.16477569e+00  3.86210787e+00  3.86210787e+00  3.86210787e+00
  7.18345002e+00  1.41723313e+01  1.41723313e+01  1.41723313e+01
  3.42835268e+01  5.27304461e+01  5.27304461e+01  5.27304461e+01
  1.37837912e+02  2.40492551e+02  2.40492551e+02  2.40492551e+02
  5.00930911e+02  1.86773722e+03  7.99735939e+03  4.77653892e+04]
E1 = -182.84804838684144  E_coul = 54.3076647632043
cycle= 2 E= -128.540383623637  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0664
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258293
diis-c [-6.43147694e-04  3.35831029e-01  6.64168971e-01]
  HOMO = -0.848545323794189  LUMO = 0.807076672780389
  mo_energy =
[-3.27698162e+01 -1.92890552e+00 -8.48545324e-01 -8.48545324e-01
 -8.48545324e-01  8.07076673e-01  8.07076673e-01  8.07076673e-01
  1.17926770e+00  3.89370150e+00  3.89370150e+00  3.89370150e+00
  7.22647742e+00  1.42354572e+01  1.42354572e+01  1.42354572e+01
  3.43660682e+01  5.28243696e+01  5.28243696e+01  5.28243696e+01
  1.37943865e+02  2.40606112e+02  2.40606112e+02  2.40606112e+02
  5.01047650e+02  1.86785919e+03  7.99748380e+03  4.77655145e+04]
E1 = -182.5899195626196  E_coul = 54.04861898353259
cycle= 3 E= -128.541300579087  delta_E= -0.000917  |g|= 0.000503  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117493
diis-c [-1.24496875e-07 -2.25523146e-03 -9.61373146e-05  1.00235137e+00]
  HOMO = -0.848800129848747  LUMO = 0.807040340972812
  mo_energy =
[-3.27702862e+01 -1.92910295e+00 -8.48800130e-01 -8.48800130e-01
 -8.48800130e-01  8.07040341e-01  8.07040341e-01  8.07040341e-01
  1.17919338e+00  3.89352441e+00  3.89352441e+00  3.89352441e+00
  7.22626213e+00  1.42351506e+01  1.42351506e+01  1.42351506e+01
  3.43657061e+01  5.28239549e+01  5.28239549e+01  5.28239549e+01
  1.37943393e+02  2.40605570e+02  2.40605570e+02  2.40605570e+02
  5.01047052e+02  1.86785846e+03  7.99748297e+03  4.77655136e+04]
E1 = -182.59046558264257  E_coul = 54.04916498220721
cycle= 4 E= -128.541300600435  delta_E= -2.13e-08  |g|= 7.54e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185289
diis-c [-8.01168310e-10  1.93899245e-04  4.83193134e-04 -1.59926768e-01
  1.15924968e+00]
  HOMO = -0.848839624467545  LUMO = 0.807028543533342
  mo_energy =
[-3.27703572e+01 -1.92913417e+00 -8.48839624e-01 -8.48839624e-01
 -8.48839624e-01  8.07028544e-01  8.07028544e-01  8.07028544e-01
  1.17917642e+00  3.89348737e+00  3.89348737e+00  3.89348737e+00
  7.22622063e+00  1.42350949e+01  1.42350949e+01  1.42350949e+01
  3.43656441e+01  5.28238882e+01  5.28238882e+01  5.28238882e+01
  1.37943322e+02  2.40605495e+02  2.40605495e+02  2.40605495e+02
  5.01046973e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59060895741325  E_coul = 54.04930835642555
cycle= 5 E= -128.541300600988  delta_E= -5.52e-10  |g|= 4.51e-06  |ddm|= 3.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59060895741325  E_coul = 54.04930835642555
  HOMO = -0.848837450056749  LUMO = 0.807029192042262
  mo_energy =
[-3.27703525e+01 -1.92913127e+00 -8.48837450e-01 -8.48837450e-01
 -8.48837450e-01  8.07029192e-01  8.07029192e-01  8.07029192e-01
  1.17917786e+00  3.89348947e+00  3.89348947e+00  3.89348947e+00
  7.22622365e+00  1.42350984e+01  1.42350984e+01  1.42350984e+01
  3.43656485e+01  5.28238927e+01  5.28238927e+01  5.28238927e+01
  1.37943327e+02  2.40605499e+02  2.40605499e+02  2.40605499e+02
  5.01046977e+02  1.86785838e+03  7.99748288e+03  4.77655135e+04]
E1 = -182.59059817414786  E_coul = 54.04929757315866
Extra cycle  E= -128.541300600989  delta_E= -1.48e-12  |g|= 1.54e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137942e+04 3.66145157e+03 8.33319262e+02 2.35442498e+02
 7.61389257e+01 9.99179087e+00 2.69186513e+01 3.79853595e-01
 1.10977232e+00 2.85995276e+00 7.11382167e+00 2.31710125e+01
 9.97863721e+01 2.66398663e-01 2.44209552e+00 8.34486594e-01]
E = -128.5413006009892
 message: Iteration limit reached
 success: False
  status: 9
     fun: -128.5413006009892
       x: [ 2.441e+04  3.661e+03 ...  2.442e+00  8.345e-01]
     nit: 100
     jac: [ 4.181e-11 -1.190e-09 ... -5.214e-07  3.399e-06]
    nfev: 100
    njev: 100
E = -128.5413006009892
S                         P                         
2.4413794186547566e+04    7.1138216686992184e+00
3.6614515715933576e+03    2.3171012506273396e+01
8.3331926164157414e+02    9.9786372110063894e+01
2.3544249760504746e+02    2.6639866269987839e-01
7.6138925685975124e+01    2.4420955233184571e+00
9.9917908657856156e+00    8.3448659373197043e-01
2.6918651321937844e+01    
3.7985359460434670e-01    
1.1097723200203859e+00    
2.8599527636453970e+00    
E = -128.5413006009892
exp = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]
