#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154206        1
[INPUT] 0    0    [1    /1   ]  215.458444554        1
[INPUT] 0    0    [1    /1   ]  1429.46102804        1
[INPUT] 0    0    [1    /1   ]  0.567717378905       1
[INPUT] 0    0    [1    /1   ]  48.4585973054        1
[INPUT] 0    0    [1    /1   ]  13.0328336133        1
[INPUT] 0    0    [1    /1   ]  1.90224065621        1
[INPUT] 1    0    [1    /1   ]  2.77760426799        1
[INPUT] 1    0    [1    /1   ]  13.3319133077        1
[INPUT] 1    0    [1    /1   ]  0.600574707452       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915420579808, 1.0]], [0, [215.45844455359133, 1.0]], [0, [1429.4610280386537, 1.0]], [0, [0.5677173789049907, 1.0]], [0, [48.45859730536646, 1.0]], [0, [13.032833613337074, 1.0]], [0, [1.9022406562127316, 1.0]], [1, [2.7776042679910673, 1.0]], [1, [13.33191330773249, 1.0]], [1, [0.6005747074522553, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154206]
bas 1, expnt(s) = [215.45844455]
bas 2, expnt(s) = [1429.46102804]
bas 3, expnt(s) = [0.56771738]
bas 4, expnt(s) = [48.45859731]
bas 5, expnt(s) = [13.03283361]
bas 6, expnt(s) = [1.90224066]
bas 7, expnt(s) = [2.77760427]
bas 8, expnt(s) = [13.33191331]
bas 9, expnt(s) = [0.60057471]
CPU time:         1.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419154e+03 7.96090989e+02 2.15458445e+02 1.42081543e+02
 1.42946103e+03 5.87346336e+02 5.67717379e-01 1.65239612e+00
 4.84585973e+01 4.64026895e+01 1.30328336e+01 1.73298244e+01
 1.90224066e+00 4.09226848e+00 2.77760427e+00 1.04609796e+01
 1.33319133e+01 7.43190233e+01 6.00574707e-01 1.54238641e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965780864283118
cond(S) = 156.3037736824839
E1 = -183.1357068001988  E_coul = 55.011225952726235
init E= -128.124480847473
    CPU time for initialize scf      0.11 sec, wall time      0.11 sec
  HOMO = -0.742894181662367  LUMO = 2.6579662999474
  mo_energy =
[-3.25128659e+01 -1.85388050e+00 -7.42894182e-01 -7.42894182e-01
 -7.42894182e-01  2.65796630e+00  2.65796630e+00  2.65796630e+00
  2.70227650e+00  1.99606947e+01  1.99606947e+01  1.99606947e+01
  4.40511986e+01  3.19573371e+02  1.98496529e+03  7.27407799e+03]
E1 = -182.12816712336294  E_coul = 53.93308227017969
cycle= 1 E= -128.195084853183  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.25 sec, wall time      0.26 sec
diis-norm(errvec)=0.26244
diis-c [-0.06887479  1.        ]
  HOMO = -0.808034514213963  LUMO = 2.60365535373203
  mo_energy =
[-3.27871554e+01 -1.92110048e+00 -8.08034514e-01 -8.08034514e-01
 -8.08034514e-01  2.60365535e+00  2.60365535e+00  2.60365535e+00
  2.64961491e+00  1.97693873e+01  1.97693873e+01  1.97693873e+01
  4.38169092e+01  3.19262897e+02  1.98460413e+03  7.27369136e+03]
E1 = -182.59167552671238  E_coul = 54.39495188039686
cycle= 2 E= -128.196723646316  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.08 sec, wall time      0.08 sec
diis-norm(errvec)=0.10211
diis-c [-4.49390632e-04  2.76332839e-01  7.23667161e-01]
  HOMO = -0.785165543497528  LUMO = 2.6243675889914
  mo_energy =
[-3.27120876e+01 -1.89737750e+00 -7.85165543e-01 -7.85165543e-01
 -7.85165543e-01  2.62436759e+00  2.62436759e+00  2.62436759e+00
  2.66952697e+00  1.98257771e+01  1.98257771e+01  1.98257771e+01
  4.38829171e+01  3.19344753e+02  1.98469161e+03  7.27378034e+03]
E1 = -182.45885221330172  E_coul = 54.261822137763474
cycle= 3 E= -128.197030075538  delta_E= -0.000306  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107387
diis-c [-6.10159379e-08 -3.47101164e-03  1.38525613e-03  1.00208576e+00]
  HOMO = -0.785443076283742  LUMO = 2.62415083719174
  mo_energy =
[-3.27128938e+01 -1.89771729e+00 -7.85443076e-01 -7.85443076e-01
 -7.85443076e-01  2.62415084e+00  2.62415084e+00  2.62415084e+00
  2.66926204e+00  1.98251504e+01  1.98251504e+01  1.98251504e+01
  4.38821717e+01  3.19344079e+02  1.98469105e+03  7.27377982e+03]
E1 = -182.46038268213164  E_coul = 54.263352562795326
cycle= 4 E= -128.197030119336  delta_E= -4.38e-08  |g|= 4.44e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0912e-05
diis-c [-1.98141129e-10  4.44343193e-04 -1.19884980e-03 -1.62638936e-01
  1.16339344e+00]
  HOMO = -0.78543029751615  LUMO = 2.62416195405862
  mo_energy =
[-3.27128609e+01 -1.89771482e+00 -7.85430298e-01 -7.85430298e-01
 -7.85430298e-01  2.62416195e+00  2.62416195e+00  2.62416195e+00
  2.66926345e+00  1.98251759e+01  1.98251759e+01  1.98251759e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032776344822  E_coul = 54.263297643887064
cycle= 5 E= -128.197030119561  delta_E= -2.25e-10  |g|= 1.59e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46032776344822  E_coul = 54.263297643887064
  HOMO = -0.785430161661336  LUMO = 2.62416208200367
  mo_energy =
[-3.27128607e+01 -1.89771508e+00 -7.85430162e-01 -7.85430162e-01
 -7.85430162e-01  2.62416208e+00  2.62416208e+00  2.62416208e+00
  2.66926323e+00  1.98251761e+01  1.98251761e+01  1.98251761e+01
  4.38821984e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032742465485  E_coul = 54.263297305093474
Extra cycle  E= -128.197030119561  delta_E= -1.99e-13  |g|= 3.02e-07  |ddm|= 9.17e-07
    CPU time for scf_cycle      0.48 sec, wall time      0.49 sec
exp = [2.14419154e+03 2.15458445e+02 1.42946103e+03 5.67717379e-01
 4.84585973e+01 1.30328336e+01 1.90224066e+00 2.77760427e+00
 1.33319133e+01 6.00574707e-01]
E = -128.19703011956136
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154206        1
[INPUT] 0    0    [1    /1   ]  215.458444554        1
[INPUT] 0    0    [1    /1   ]  1429.46102804        1
[INPUT] 0    0    [1    /1   ]  0.567717378905       1
[INPUT] 0    0    [1    /1   ]  48.4585973054        1
[INPUT] 0    0    [1    /1   ]  13.0328336133        1
[INPUT] 0    0    [1    /1   ]  1.90224065621        1
[INPUT] 1    0    [1    /1   ]  2.77760426799        1
[INPUT] 1    0    [1    /1   ]  13.3319133077        1
[INPUT] 1    0    [1    /1   ]  0.600574707452       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915420579808, 1.0]], [0, [215.45844455359133, 1.0]], [0, [1429.4610280386537, 1.0]], [0, [0.5677173789049907, 1.0]], [0, [48.45859730536646, 1.0]], [0, [13.032833613337074, 1.0]], [0, [1.9022406562127316, 1.0]], [1, [2.7776042679910673, 1.0]], [1, [13.33191330773249, 1.0]], [1, [0.6005747074522553, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154206]
bas 1, expnt(s) = [215.45844455]
bas 2, expnt(s) = [1429.46102804]
bas 3, expnt(s) = [0.56771738]
bas 4, expnt(s) = [48.45859731]
bas 5, expnt(s) = [13.03283361]
bas 6, expnt(s) = [1.90224066]
bas 7, expnt(s) = [2.77760427]
bas 8, expnt(s) = [13.33191331]
bas 9, expnt(s) = [0.60057471]
CPU time:         2.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419154e+03 7.96090989e+02 2.15458445e+02 1.42081543e+02
 1.42946103e+03 5.87346336e+02 5.67717379e-01 1.65239612e+00
 4.84585973e+01 4.64026895e+01 1.30328336e+01 1.73298244e+01
 1.90224066e+00 4.09226848e+00 2.77760427e+00 1.04609796e+01
 1.33319133e+01 7.43190233e+01 6.00574707e-01 1.54238641e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965780864283118
cond(S) = 156.3037736824839
E1 = -183.1357068001988  E_coul = 55.011225952726235
init E= -128.124480847473
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894181662367  LUMO = 2.6579662999474
  mo_energy =
[-3.25128659e+01 -1.85388050e+00 -7.42894182e-01 -7.42894182e-01
 -7.42894182e-01  2.65796630e+00  2.65796630e+00  2.65796630e+00
  2.70227650e+00  1.99606947e+01  1.99606947e+01  1.99606947e+01
  4.40511986e+01  3.19573371e+02  1.98496529e+03  7.27407799e+03]
E1 = -182.12816712336294  E_coul = 53.93308227017969
cycle= 1 E= -128.195084853183  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26244
diis-c [-0.06887479  1.        ]
  HOMO = -0.808034514213963  LUMO = 2.60365535373203
  mo_energy =
[-3.27871554e+01 -1.92110048e+00 -8.08034514e-01 -8.08034514e-01
 -8.08034514e-01  2.60365535e+00  2.60365535e+00  2.60365535e+00
  2.64961491e+00  1.97693873e+01  1.97693873e+01  1.97693873e+01
  4.38169092e+01  3.19262897e+02  1.98460413e+03  7.27369136e+03]
E1 = -182.59167552671238  E_coul = 54.39495188039686
cycle= 2 E= -128.196723646316  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10211
diis-c [-4.49390632e-04  2.76332839e-01  7.23667161e-01]
  HOMO = -0.785165543497528  LUMO = 2.6243675889914
  mo_energy =
[-3.27120876e+01 -1.89737750e+00 -7.85165543e-01 -7.85165543e-01
 -7.85165543e-01  2.62436759e+00  2.62436759e+00  2.62436759e+00
  2.66952697e+00  1.98257771e+01  1.98257771e+01  1.98257771e+01
  4.38829171e+01  3.19344753e+02  1.98469161e+03  7.27378034e+03]
E1 = -182.45885221330172  E_coul = 54.261822137763474
cycle= 3 E= -128.197030075538  delta_E= -0.000306  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107387
diis-c [-6.10159379e-08 -3.47101164e-03  1.38525613e-03  1.00208576e+00]
  HOMO = -0.785443076283742  LUMO = 2.62415083719174
  mo_energy =
[-3.27128938e+01 -1.89771729e+00 -7.85443076e-01 -7.85443076e-01
 -7.85443076e-01  2.62415084e+00  2.62415084e+00  2.62415084e+00
  2.66926204e+00  1.98251504e+01  1.98251504e+01  1.98251504e+01
  4.38821717e+01  3.19344079e+02  1.98469105e+03  7.27377982e+03]
E1 = -182.46038268213164  E_coul = 54.263352562795326
cycle= 4 E= -128.197030119336  delta_E= -4.38e-08  |g|= 4.44e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0912e-05
diis-c [-1.98141129e-10  4.44343193e-04 -1.19884980e-03 -1.62638936e-01
  1.16339344e+00]
  HOMO = -0.78543029751615  LUMO = 2.62416195405862
  mo_energy =
[-3.27128609e+01 -1.89771482e+00 -7.85430298e-01 -7.85430298e-01
 -7.85430298e-01  2.62416195e+00  2.62416195e+00  2.62416195e+00
  2.66926345e+00  1.98251759e+01  1.98251759e+01  1.98251759e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032776344822  E_coul = 54.263297643887064
cycle= 5 E= -128.197030119561  delta_E= -2.25e-10  |g|= 1.59e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46032776344822  E_coul = 54.263297643887064
  HOMO = -0.785430161661336  LUMO = 2.62416208200367
  mo_energy =
[-3.27128607e+01 -1.89771508e+00 -7.85430162e-01 -7.85430162e-01
 -7.85430162e-01  2.62416208e+00  2.62416208e+00  2.62416208e+00
  2.66926323e+00  1.98251761e+01  1.98251761e+01  1.98251761e+01
  4.38821984e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032742465485  E_coul = 54.263297305093474
Extra cycle  E= -128.197030119561  delta_E= -1.99e-13  |g|= 3.02e-07  |ddm|= 9.17e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.3037736824839
E1 = -182.46032742465485  E_coul = 54.263297305093474
init E= -128.197030119561
    CPU time for initialize scf      0.27 sec, wall time      0.26 sec
  HOMO = -0.785430168491077  LUMO = 2.62416207416457
  mo_energy =
[-3.27128607e+01 -1.89771516e+00 -7.85430168e-01 -7.85430168e-01
 -7.85430168e-01  2.62416207e+00  2.62416207e+00  2.62416207e+00
  2.66926315e+00  1.98251760e+01  1.98251760e+01  1.98251760e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032757183687  E_coul = 54.26329745227544
cycle= 1 E= -128.197030119561  delta_E= -5.68e-14  |g|= 5.59e-08  |ddm|= 1.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46032757183687  E_coul = 54.26329745227544
  HOMO = -0.785430155340098  LUMO = 2.62416208578757
  mo_energy =
[-3.27128607e+01 -1.89771516e+00 -7.85430155e-01 -7.85430155e-01
 -7.85430155e-01  2.62416209e+00  2.62416209e+00  2.62416209e+00
  2.66926315e+00  1.98251761e+01  1.98251761e+01  1.98251761e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.4603275162329  E_coul = 54.26329739667139
Extra cycle  E= -128.197030119562  delta_E= -8.53e-14  |g|= 1.29e-08  |ddm|= 2.86e-08
    CPU time for scf_cycle      0.96 sec, wall time      0.97 sec
exp = [2.14419154e+03 2.15458445e+02 1.42946103e+03 5.67717379e-01
 4.84585973e+01 1.30328336e+01 1.90224066e+00 2.77760427e+00
 1.33319133e+01 6.00574707e-01]
grad_E = [-7.42834696e-06 -3.47415849e-04  4.62779589e-05  3.93388885e-04
  8.93554498e-04 -1.29823923e-03  1.38084586e-04 -9.07373379e-06
  5.67611089e-07  3.12027359e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154949        1
[INPUT] 0    0    [1    /1   ]  215.458791969        1
[INPUT] 0    0    [1    /1   ]  1429.46098176        1
[INPUT] 0    0    [1    /1   ]  0.56732399002        1
[INPUT] 0    0    [1    /1   ]  48.4577037509        1
[INPUT] 0    0    [1    /1   ]  13.0341318526        1
[INPUT] 0    0    [1    /1   ]  1.90210257163        1
[INPUT] 1    0    [1    /1   ]  2.77761334172        1
[INPUT] 1    0    [1    /1   ]  13.3319127401        1
[INPUT] 1    0    [1    /1   ]  0.600543504716       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191549486328, 1.0]], [0, [215.45879196944054, 1.0]], [0, [1429.4609817606947, 1.0]], [0, [0.5673239900198472, 1.0]], [0, [48.45770375086883, 1.0]], [0, [13.034131852569432, 1.0]], [0, [1.9021025716267643, 1.0]], [1, [2.7776133417248565, 1.0]], [1, [13.331912740121401, 1.0]], [1, [0.600543504716358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154949]
bas 1, expnt(s) = [215.45879197]
bas 2, expnt(s) = [1429.46098176]
bas 3, expnt(s) = [0.56732399]
bas 4, expnt(s) = [48.45770375]
bas 5, expnt(s) = [13.03413185]
bas 6, expnt(s) = [1.90210257]
bas 7, expnt(s) = [2.77761334]
bas 8, expnt(s) = [13.33191274]
bas 9, expnt(s) = [0.6005435]
CPU time:         6.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419155e+03 7.96090991e+02 2.15458792e+02 1.42081715e+02
 1.42946098e+03 5.87346322e+02 5.67323990e-01 1.65153730e+00
 4.84577038e+01 4.64020478e+01 1.30341319e+01 1.73311191e+01
 1.90210257e+00 4.09204569e+00 2.77761334e+00 1.04610223e+01
 1.33319127e+01 7.43190194e+01 6.00543505e-01 1.54228624e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965790800493671
cond(S) = 156.30083931844777
E1 = -183.13574885493927  E_coul = 55.01128366282014
init E= -128.124465192119
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894853371492  LUMO = 2.65786325270874
  mo_energy =
[-3.25128324e+01 -1.85388767e+00 -7.42894853e-01 -7.42894853e-01
 -7.42894853e-01  2.65786325e+00  2.65786325e+00  2.65786325e+00
  2.70070528e+00  1.99606564e+01  1.99606564e+01  1.99606564e+01
  4.40516362e+01  3.19574186e+02  1.98496612e+03  7.27407886e+03]
E1 = -182.12721160706758  E_coul = 53.93212747675877
cycle= 1 E= -128.195084130309  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262671
diis-c [-0.0689959  1.       ]
  HOMO = -0.808123760587482  LUMO = 2.6034746921383
  mo_energy =
[-3.27872898e+01 -1.92117770e+00 -8.08123761e-01 -8.08123761e-01
 -8.08123761e-01  2.60347469e+00  2.60347469e+00  2.60347469e+00
  2.64800099e+00  1.97691970e+01  1.97691970e+01  1.97691970e+01
  4.38171702e+01  3.19263577e+02  1.98460484e+03  7.27369210e+03]
E1 = -182.59114681481452  E_coul = 54.39442123173953
cycle= 2 E= -128.196725583075  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102203
diis-c [-4.49720516e-04  2.76343648e-01  7.23656352e-01]
  HOMO = -0.78523408815856  LUMO = 2.6242055280746
  mo_energy =
[-3.27121552e+01 -1.89743216e+00 -7.85234088e-01 -7.85234088e-01
 -7.85234088e-01  2.62420553e+00  2.62420553e+00  2.62420553e+00
  2.66792731e+00  1.98256375e+01  1.98256375e+01  1.98256375e+01
  4.38832385e+01  3.19345504e+02  1.98469239e+03  7.27378116e+03]
E1 = -182.45818655341503  E_coul = 54.26115394583734
cycle= 3 E= -128.197032607578  delta_E= -0.000307  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107782
diis-c [-5.88377829e-08 -3.46038777e-03  1.45468825e-03  1.00200570e+00]
  HOMO = -0.785512500870565  LUMO = 2.62398807276753
  mo_energy =
[-3.27129633e+01 -1.89777147e+00 -7.85512501e-01 -7.85512501e-01
 -7.85512501e-01  2.62398807e+00  2.62398807e+00  2.62398807e+00
  2.66766292e+00  1.98250095e+01  1.98250095e+01  1.98250095e+01
  4.38824917e+01  3.19344828e+02  1.98469183e+03  7.27378063e+03]
E1 = -182.4597201810633  E_coul = 54.262687529738386
cycle= 4 E= -128.197032651325  delta_E= -4.37e-08  |g|= 4.34e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.94104e-05
diis-c [-1.94993187e-10  4.39926337e-04 -1.18512924e-03 -1.60976782e-01
  1.16172199e+00]
  HOMO = -0.785499981034718  LUMO = 2.6239989627251
  mo_energy =
[-3.27129310e+01 -1.89776898e+00 -7.85499981e-01 -7.85499981e-01
 -7.85499981e-01  2.62399896e+00  2.62399896e+00  2.62399896e+00
  2.66766436e+00  1.98250345e+01  1.98250345e+01  1.98250345e+01
  4.38825177e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966632927622  E_coul = 54.26263367773677
cycle= 5 E= -128.197032651539  delta_E= -2.15e-10  |g|= 1.6e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45966632927622  E_coul = 54.26263367773677
  HOMO = -0.785499835818219  LUMO = 2.62399909904962
  mo_energy =
[-3.27129307e+01 -1.89776923e+00 -7.85499836e-01 -7.85499836e-01
 -7.85499836e-01  2.62399910e+00  2.62399910e+00  2.62399910e+00
  2.66766414e+00  1.98250347e+01  1.98250347e+01  1.98250347e+01
  4.38825179e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.4596659433308  E_coul = 54.26263329179128
Extra cycle  E= -128.19703265154  delta_E= -8.53e-14  |g|= 3.05e-07  |ddm|= 9.21e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [2.14419155e+03 2.15458792e+02 1.42946098e+03 5.67323990e-01
 4.84577038e+01 1.30341319e+01 1.90210257e+00 2.77761334e+00
 1.33319127e+01 6.00543505e-01]
E = -128.19703265153953
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154949        1
[INPUT] 0    0    [1    /1   ]  215.458791969        1
[INPUT] 0    0    [1    /1   ]  1429.46098176        1
[INPUT] 0    0    [1    /1   ]  0.56732399002        1
[INPUT] 0    0    [1    /1   ]  48.4577037509        1
[INPUT] 0    0    [1    /1   ]  13.0341318526        1
[INPUT] 0    0    [1    /1   ]  1.90210257163        1
[INPUT] 1    0    [1    /1   ]  2.77761334172        1
[INPUT] 1    0    [1    /1   ]  13.3319127401        1
[INPUT] 1    0    [1    /1   ]  0.600543504716       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191549486328, 1.0]], [0, [215.45879196944054, 1.0]], [0, [1429.4609817606947, 1.0]], [0, [0.5673239900198472, 1.0]], [0, [48.45770375086883, 1.0]], [0, [13.034131852569432, 1.0]], [0, [1.9021025716267643, 1.0]], [1, [2.7776133417248565, 1.0]], [1, [13.331912740121401, 1.0]], [1, [0.600543504716358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154949]
bas 1, expnt(s) = [215.45879197]
bas 2, expnt(s) = [1429.46098176]
bas 3, expnt(s) = [0.56732399]
bas 4, expnt(s) = [48.45770375]
bas 5, expnt(s) = [13.03413185]
bas 6, expnt(s) = [1.90210257]
bas 7, expnt(s) = [2.77761334]
bas 8, expnt(s) = [13.33191274]
bas 9, expnt(s) = [0.6005435]
CPU time:         6.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419155e+03 7.96090991e+02 2.15458792e+02 1.42081715e+02
 1.42946098e+03 5.87346322e+02 5.67323990e-01 1.65153730e+00
 4.84577038e+01 4.64020478e+01 1.30341319e+01 1.73311191e+01
 1.90210257e+00 4.09204569e+00 2.77761334e+00 1.04610223e+01
 1.33319127e+01 7.43190194e+01 6.00543505e-01 1.54228624e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965790800493671
cond(S) = 156.30083931844777
E1 = -183.13574885493927  E_coul = 55.01128366282014
init E= -128.124465192119
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894853371492  LUMO = 2.65786325270874
  mo_energy =
[-3.25128324e+01 -1.85388767e+00 -7.42894853e-01 -7.42894853e-01
 -7.42894853e-01  2.65786325e+00  2.65786325e+00  2.65786325e+00
  2.70070528e+00  1.99606564e+01  1.99606564e+01  1.99606564e+01
  4.40516362e+01  3.19574186e+02  1.98496612e+03  7.27407886e+03]
E1 = -182.12721160706758  E_coul = 53.93212747675877
cycle= 1 E= -128.195084130309  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262671
diis-c [-0.0689959  1.       ]
  HOMO = -0.808123760587482  LUMO = 2.6034746921383
  mo_energy =
[-3.27872898e+01 -1.92117770e+00 -8.08123761e-01 -8.08123761e-01
 -8.08123761e-01  2.60347469e+00  2.60347469e+00  2.60347469e+00
  2.64800099e+00  1.97691970e+01  1.97691970e+01  1.97691970e+01
  4.38171702e+01  3.19263577e+02  1.98460484e+03  7.27369210e+03]
E1 = -182.59114681481452  E_coul = 54.39442123173953
cycle= 2 E= -128.196725583075  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102203
diis-c [-4.49720516e-04  2.76343648e-01  7.23656352e-01]
  HOMO = -0.78523408815856  LUMO = 2.6242055280746
  mo_energy =
[-3.27121552e+01 -1.89743216e+00 -7.85234088e-01 -7.85234088e-01
 -7.85234088e-01  2.62420553e+00  2.62420553e+00  2.62420553e+00
  2.66792731e+00  1.98256375e+01  1.98256375e+01  1.98256375e+01
  4.38832385e+01  3.19345504e+02  1.98469239e+03  7.27378116e+03]
E1 = -182.45818655341503  E_coul = 54.26115394583734
cycle= 3 E= -128.197032607578  delta_E= -0.000307  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107782
diis-c [-5.88377829e-08 -3.46038777e-03  1.45468825e-03  1.00200570e+00]
  HOMO = -0.785512500870565  LUMO = 2.62398807276753
  mo_energy =
[-3.27129633e+01 -1.89777147e+00 -7.85512501e-01 -7.85512501e-01
 -7.85512501e-01  2.62398807e+00  2.62398807e+00  2.62398807e+00
  2.66766292e+00  1.98250095e+01  1.98250095e+01  1.98250095e+01
  4.38824917e+01  3.19344828e+02  1.98469183e+03  7.27378063e+03]
E1 = -182.4597201810633  E_coul = 54.262687529738386
cycle= 4 E= -128.197032651325  delta_E= -4.37e-08  |g|= 4.34e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.94104e-05
diis-c [-1.94993187e-10  4.39926337e-04 -1.18512924e-03 -1.60976782e-01
  1.16172199e+00]
  HOMO = -0.785499981034718  LUMO = 2.6239989627251
  mo_energy =
[-3.27129310e+01 -1.89776898e+00 -7.85499981e-01 -7.85499981e-01
 -7.85499981e-01  2.62399896e+00  2.62399896e+00  2.62399896e+00
  2.66766436e+00  1.98250345e+01  1.98250345e+01  1.98250345e+01
  4.38825177e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966632927622  E_coul = 54.26263367773677
cycle= 5 E= -128.197032651539  delta_E= -2.15e-10  |g|= 1.6e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45966632927622  E_coul = 54.26263367773677
  HOMO = -0.785499835818219  LUMO = 2.62399909904962
  mo_energy =
[-3.27129307e+01 -1.89776923e+00 -7.85499836e-01 -7.85499836e-01
 -7.85499836e-01  2.62399910e+00  2.62399910e+00  2.62399910e+00
  2.66766414e+00  1.98250347e+01  1.98250347e+01  1.98250347e+01
  4.38825179e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.4596659433308  E_coul = 54.26263329179128
Extra cycle  E= -128.19703265154  delta_E= -8.53e-14  |g|= 3.05e-07  |ddm|= 9.21e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30083931844777
E1 = -182.4596659433308  E_coul = 54.26263329179128
init E= -128.19703265154
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785499845730159  LUMO = 2.62399908841453
  mo_energy =
[-3.27129308e+01 -1.89776932e+00 -7.85499846e-01 -7.85499846e-01
 -7.85499846e-01  2.62399909e+00  2.62399909e+00  2.62399909e+00
  2.66766406e+00  1.98250346e+01  1.98250346e+01  1.98250346e+01
  4.38825178e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966610952172  E_coul = 54.26263345798185
cycle= 1 E= -128.19703265154  delta_E= -3.41e-13  |g|= 5.7e-08  |ddm|= 1.79e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45966610952172  E_coul = 54.26263345798185
  HOMO = -0.785499831255129  LUMO = 2.62399910123454
  mo_energy =
[-3.27129308e+01 -1.89776932e+00 -7.85499831e-01 -7.85499831e-01
 -7.85499831e-01  2.62399910e+00  2.62399910e+00  2.62399910e+00
  2.66766406e+00  1.98250347e+01  1.98250347e+01  1.98250347e+01
  4.38825178e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966604639798  E_coul = 54.262633394858184
Extra cycle  E= -128.19703265154  delta_E= 5.68e-14  |g|= 1.37e-08  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419155e+03 2.15458792e+02 1.42946098e+03 5.67323990e-01
 4.84577038e+01 1.30341319e+01 1.90210257e+00 2.77761334e+00
 1.33319127e+01 6.00543505e-01]
grad_E = [-7.43085278e-06 -3.45938620e-04  4.62640663e-05 -5.40856046e-04
  8.72084494e-04 -1.20401098e-03  3.08519383e-04  7.77121462e-05
 -3.47393724e-06 -3.72761909e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19162481        1
[INPUT] 0    0    [1    /1   ]  215.462310855        1
[INPUT] 0    0    [1    /1   ]  1429.46051255        1
[INPUT] 0    0    [1    /1   ]  0.565737074454       1
[INPUT] 0    0    [1    /1   ]  48.4486985984        1
[INPUT] 0    0    [1    /1   ]  13.0470533167        1
[INPUT] 0    0    [1    /1   ]  1.90026425551        1
[INPUT] 1    0    [1    /1   ]  2.77748222218        1
[INPUT] 1    0    [1    /1   ]  13.3319173754        1
[INPUT] 1    0    [1    /1   ]  0.60126570176        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1916248137877, 1.0]], [0, [215.4623108549529, 1.0]], [0, [1429.4605125529981, 1.0]], [0, [0.5657370744544798, 1.0]], [0, [48.44869859844658, 1.0]], [0, [13.047053316686139, 1.0]], [0, [1.90026425551194, 1.0]], [1, [2.777482222182839, 1.0]], [1, [13.331917375445839, 1.0]], [1, [0.6012657017600744, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19162481]
bas 1, expnt(s) = [215.46231085]
bas 2, expnt(s) = [1429.46051255]
bas 3, expnt(s) = [0.56573707]
bas 4, expnt(s) = [48.4486986]
bas 5, expnt(s) = [13.04705332]
bas 6, expnt(s) = [1.90026426]
bas 7, expnt(s) = [2.77748222]
bas 8, expnt(s) = [13.33191738]
bas 9, expnt(s) = [0.6012657]
CPU time:         8.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419162e+03 7.96091012e+02 2.15462311e+02 1.42083455e+02
 1.42946051e+03 5.87346177e+02 5.65737074e-01 1.64807133e+00
 4.84486986e+01 4.63955803e+01 1.30470533e+01 1.73440035e+01
 1.90026426e+00 4.08907921e+00 2.77748222e+00 1.04604051e+01
 1.33319174e+01 7.43190517e+01 6.01265702e-01 1.54460498e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965681733988628
cond(S) = 156.29121691488245
E1 = -183.13640914108586  E_coul = 55.012087091097705
init E= -128.124322049988
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742824979114199  LUMO = 2.66032116833318
  mo_energy =
[-3.25126521e+01 -1.85386127e+00 -7.42824979e-01 -7.42824979e-01
 -7.42824979e-01  2.66032117e+00  2.66032117e+00  2.66032117e+00
  2.69316968e+00  1.99625011e+01  1.99625011e+01  1.99625011e+01
  4.40636166e+01  3.19587871e+02  1.98497887e+03  7.27409164e+03]
E1 = -182.1335129208691  E_coul = 53.938398663666945
cycle= 1 E= -128.195114257202  delta_E= -0.0708  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261612
diis-c [-0.06844102  1.        ]
  HOMO = -0.807669704044034  LUMO = 2.60628524578823
  mo_energy =
[-3.27860813e+01 -1.92061532e+00 -8.07669704e-01 -8.07669704e-01
 -8.07669704e-01  2.60628525e+00  2.60628525e+00  2.60628525e+00
  2.64102634e+00  1.97719686e+01  1.97719686e+01  1.97719686e+01
  4.38300410e+01  3.19278540e+02  1.98461890e+03  7.27370624e+03]
E1 = -182.5951753516098  E_coul = 54.39843395249766
cycle= 2 E= -128.196741399112  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0639
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101661
diis-c [-4.49679535e-04  2.76043737e-01  7.23956263e-01]
  HOMO = -0.784883264637864  LUMO = 2.62692572253434
  mo_energy =
[-3.27112807e+01 -1.89697691e+00 -7.84883265e-01 -7.84883265e-01
 -7.84883265e-01  2.62692572e+00  2.62692572e+00  2.62692572e+00
  2.66083689e+00  1.98281535e+01  1.98281535e+01  1.98281535e+01
  4.38958234e+01  3.19360111e+02  1.98470608e+03  7.27379492e+03]
E1 = -182.4629193439543  E_coul = 54.26587417931944
cycle= 3 E= -128.197045164635  delta_E= -0.000304  |g|= 0.000789  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109444
diis-c [-4.84746441e-08 -3.43468148e-03  1.78689948e-03  1.00164778e+00]
  HOMO = -0.785165085119841  LUMO = 2.626705083435
  mo_energy =
[-3.27120965e+01 -1.89731212e+00 -7.85165085e-01 -7.85165085e-01
 -7.85165085e-01  2.62670508e+00  2.62670508e+00  2.62670508e+00
  2.66057635e+00  1.98275203e+01  1.98275203e+01  1.98275203e+01
  4.38950710e+01  3.19359426e+02  1.98470551e+03  7.27379437e+03]
E1 = -182.46446428289872  E_coul = 54.26741907499204
cycle= 4 E= -128.197045207907  delta_E= -4.33e-08  |g|= 3.81e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.16658e-05
diis-c [-1.83787702e-10  4.06203524e-04 -1.10549954e-03 -1.47739436e-01
  1.14843873e+00]
  HOMO = -0.785153836442827  LUMO = 2.62671486825442
  mo_energy =
[-3.27120674e+01 -1.89730935e+00 -7.85153836e-01 -7.85153836e-01
 -7.85153836e-01  2.62671487e+00  2.62671487e+00  2.62671487e+00
  2.66057811e+00  1.98275429e+01  1.98275429e+01  1.98275429e+01
  4.38950946e+01  3.19359466e+02  1.98470556e+03  7.27379443e+03]
E1 = -182.46441559069223  E_coul = 54.26737038262365
cycle= 5 E= -128.197045208069  delta_E= -1.62e-10  |g|= 1.7e-06  |ddm|= 1.83e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46441559069223  E_coul = 54.26737038262365
  HOMO = -0.785153635115027  LUMO = 2.62671505393025
  mo_energy =
[-3.27120669e+01 -1.89730957e+00 -7.85153635e-01 -7.85153635e-01
 -7.85153635e-01  2.62671505e+00  2.62671505e+00  2.62671505e+00
  2.66057791e+00  1.98275432e+01  1.98275432e+01  1.98275432e+01
  4.38950949e+01  3.19359467e+02  1.98470556e+03  7.27379443e+03]
E1 = -182.46441493209292  E_coul = 54.26736972402394
Extra cycle  E= -128.197045208069  delta_E= -3.98e-13  |g|= 3.36e-07  |ddm|= 9.7e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419162e+03 2.15462311e+02 1.42946051e+03 5.65737074e-01
 4.84486986e+01 1.30470533e+01 1.90026426e+00 2.77748222e+00
 1.33319174e+01 6.01265702e-01]
E = -128.19704520806897
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19162481        1
[INPUT] 0    0    [1    /1   ]  215.462310855        1
[INPUT] 0    0    [1    /1   ]  1429.46051255        1
[INPUT] 0    0    [1    /1   ]  0.565737074454       1
[INPUT] 0    0    [1    /1   ]  48.4486985984        1
[INPUT] 0    0    [1    /1   ]  13.0470533167        1
[INPUT] 0    0    [1    /1   ]  1.90026425551        1
[INPUT] 1    0    [1    /1   ]  2.77748222218        1
[INPUT] 1    0    [1    /1   ]  13.3319173754        1
[INPUT] 1    0    [1    /1   ]  0.60126570176        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1916248137877, 1.0]], [0, [215.4623108549529, 1.0]], [0, [1429.4605125529981, 1.0]], [0, [0.5657370744544798, 1.0]], [0, [48.44869859844658, 1.0]], [0, [13.047053316686139, 1.0]], [0, [1.90026425551194, 1.0]], [1, [2.777482222182839, 1.0]], [1, [13.331917375445839, 1.0]], [1, [0.6012657017600744, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19162481]
bas 1, expnt(s) = [215.46231085]
bas 2, expnt(s) = [1429.46051255]
bas 3, expnt(s) = [0.56573707]
bas 4, expnt(s) = [48.4486986]
bas 5, expnt(s) = [13.04705332]
bas 6, expnt(s) = [1.90026426]
bas 7, expnt(s) = [2.77748222]
bas 8, expnt(s) = [13.33191738]
bas 9, expnt(s) = [0.6012657]
CPU time:         8.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419162e+03 7.96091012e+02 2.15462311e+02 1.42083455e+02
 1.42946051e+03 5.87346177e+02 5.65737074e-01 1.64807133e+00
 4.84486986e+01 4.63955803e+01 1.30470533e+01 1.73440035e+01
 1.90026426e+00 4.08907921e+00 2.77748222e+00 1.04604051e+01
 1.33319174e+01 7.43190517e+01 6.01265702e-01 1.54460498e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965681733988628
cond(S) = 156.29121691488245
E1 = -183.13640914108586  E_coul = 55.012087091097705
init E= -128.124322049988
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742824979114199  LUMO = 2.66032116833318
  mo_energy =
[-3.25126521e+01 -1.85386127e+00 -7.42824979e-01 -7.42824979e-01
 -7.42824979e-01  2.66032117e+00  2.66032117e+00  2.66032117e+00
  2.69316968e+00  1.99625011e+01  1.99625011e+01  1.99625011e+01
  4.40636166e+01  3.19587871e+02  1.98497887e+03  7.27409164e+03]
E1 = -182.1335129208691  E_coul = 53.938398663666945
cycle= 1 E= -128.195114257202  delta_E= -0.0708  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261612
diis-c [-0.06844102  1.        ]
  HOMO = -0.807669704044034  LUMO = 2.60628524578823
  mo_energy =
[-3.27860813e+01 -1.92061532e+00 -8.07669704e-01 -8.07669704e-01
 -8.07669704e-01  2.60628525e+00  2.60628525e+00  2.60628525e+00
  2.64102634e+00  1.97719686e+01  1.97719686e+01  1.97719686e+01
  4.38300410e+01  3.19278540e+02  1.98461890e+03  7.27370624e+03]
E1 = -182.5951753516098  E_coul = 54.39843395249766
cycle= 2 E= -128.196741399112  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0639
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101661
diis-c [-4.49679535e-04  2.76043737e-01  7.23956263e-01]
  HOMO = -0.784883264637864  LUMO = 2.62692572253434
  mo_energy =
[-3.27112807e+01 -1.89697691e+00 -7.84883265e-01 -7.84883265e-01
 -7.84883265e-01  2.62692572e+00  2.62692572e+00  2.62692572e+00
  2.66083689e+00  1.98281535e+01  1.98281535e+01  1.98281535e+01
  4.38958234e+01  3.19360111e+02  1.98470608e+03  7.27379492e+03]
E1 = -182.4629193439543  E_coul = 54.26587417931944
cycle= 3 E= -128.197045164635  delta_E= -0.000304  |g|= 0.000789  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109444
diis-c [-4.84746441e-08 -3.43468148e-03  1.78689948e-03  1.00164778e+00]
  HOMO = -0.785165085119841  LUMO = 2.626705083435
  mo_energy =
[-3.27120965e+01 -1.89731212e+00 -7.85165085e-01 -7.85165085e-01
 -7.85165085e-01  2.62670508e+00  2.62670508e+00  2.62670508e+00
  2.66057635e+00  1.98275203e+01  1.98275203e+01  1.98275203e+01
  4.38950710e+01  3.19359426e+02  1.98470551e+03  7.27379437e+03]
E1 = -182.46446428289872  E_coul = 54.26741907499204
cycle= 4 E= -128.197045207907  delta_E= -4.33e-08  |g|= 3.81e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.16658e-05
diis-c [-1.83787702e-10  4.06203524e-04 -1.10549954e-03 -1.47739436e-01
  1.14843873e+00]
  HOMO = -0.785153836442827  LUMO = 2.62671486825442
  mo_energy =
[-3.27120674e+01 -1.89730935e+00 -7.85153836e-01 -7.85153836e-01
 -7.85153836e-01  2.62671487e+00  2.62671487e+00  2.62671487e+00
  2.66057811e+00  1.98275429e+01  1.98275429e+01  1.98275429e+01
  4.38950946e+01  3.19359466e+02  1.98470556e+03  7.27379443e+03]
E1 = -182.46441559069223  E_coul = 54.26737038262365
cycle= 5 E= -128.197045208069  delta_E= -1.62e-10  |g|= 1.7e-06  |ddm|= 1.83e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46441559069223  E_coul = 54.26737038262365
  HOMO = -0.785153635115027  LUMO = 2.62671505393025
  mo_energy =
[-3.27120669e+01 -1.89730957e+00 -7.85153635e-01 -7.85153635e-01
 -7.85153635e-01  2.62671505e+00  2.62671505e+00  2.62671505e+00
  2.66057791e+00  1.98275432e+01  1.98275432e+01  1.98275432e+01
  4.38950949e+01  3.19359467e+02  1.98470556e+03  7.27379443e+03]
E1 = -182.46441493209292  E_coul = 54.26736972402394
Extra cycle  E= -128.197045208069  delta_E= -3.98e-13  |g|= 3.36e-07  |ddm|= 9.7e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.29121691488245
E1 = -182.46441493209292  E_coul = 54.26736972402394
init E= -128.197045208069
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785153662414014  LUMO = 2.62671502748743
  mo_energy =
[-3.27120671e+01 -1.89730968e+00 -7.85153662e-01 -7.85153662e-01
 -7.85153662e-01  2.62671503e+00  2.62671503e+00  2.62671503e+00
  2.66057782e+00  1.98275431e+01  1.98275431e+01  1.98275431e+01
  4.38950948e+01  3.19359467e+02  1.98470556e+03  7.27379443e+03]
E1 = -182.46441520845656  E_coul = 54.267370000387636
cycle= 1 E= -128.197045208069  delta_E= 5.68e-14  |g|= 6.62e-08  |ddm|= 1.97e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46441520845656  E_coul = 54.267370000387636
  HOMO = -0.785153640183883  LUMO = 2.62671504731588
  mo_energy =
[-3.27120670e+01 -1.89730967e+00 -7.85153640e-01 -7.85153640e-01
 -7.85153640e-01  2.62671505e+00  2.62671505e+00  2.62671505e+00
  2.66057782e+00  1.98275431e+01  1.98275431e+01  1.98275431e+01
  4.38950948e+01  3.19359467e+02  1.98470556e+03  7.27379443e+03]
E1 = -182.46441510200276  E_coul = 54.26736989393373
Extra cycle  E= -128.197045208069  delta_E= -1.14e-13  |g|= 1.86e-08  |ddm|= 3.06e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419162e+03 2.15462311e+02 1.42946051e+03 5.65737074e-01
 4.84486986e+01 1.30470533e+01 1.90026426e+00 2.77748222e+00
 1.33319174e+01 6.01265702e-01]
grad_E = [-7.45494574e-06 -3.31709953e-04  4.61294596e-05 -4.01592982e-03
  6.69245930e-04 -3.68631807e-04  7.11889314e-04 -1.83497641e-03
  8.21933512e-05  8.57958617e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19170292        1
[INPUT] 0    0    [1    /1   ]  215.465955247        1
[INPUT] 0    0    [1    /1   ]  1429.46002613        1
[INPUT] 0    0    [1    /1   ]  0.56514069785        1
[INPUT] 0    0    [1    /1   ]  48.4394177395        1
[INPUT] 0    0    [1    /1   ]  13.0602206747        1
[INPUT] 0    0    [1    /1   ]  1.89822569519        1
[INPUT] 1    0    [1    /1   ]  2.77781792152        1
[INPUT] 1    0    [1    /1   ]  13.3319010841        1
[INPUT] 1    0    [1    /1   ]  0.599806546637       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917029175884, 1.0]], [0, [215.46595524695255, 1.0]], [0, [1429.4600261293908, 1.0]], [0, [0.5651406978503091, 1.0]], [0, [48.43941773954869, 1.0]], [0, [13.060220674705306, 1.0]], [0, [1.89822569519123, 1.0]], [1, [2.7778179215184524, 1.0]], [1, [13.331901084115959, 1.0]], [1, [0.5998065466374484, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19170292]
bas 1, expnt(s) = [215.46595525]
bas 2, expnt(s) = [1429.46002613]
bas 3, expnt(s) = [0.5651407]
bas 4, expnt(s) = [48.43941774]
bas 5, expnt(s) = [13.06022067]
bas 6, expnt(s) = [1.8982257]
bas 7, expnt(s) = [2.77781792]
bas 8, expnt(s) = [13.33190108]
bas 9, expnt(s) = [0.59980655]
CPU time:        10.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419170e+03 7.96091034e+02 2.15465955e+02 1.42085257e+02
 1.42946003e+03 5.87346027e+02 5.65140698e-01 1.64676816e+00
 4.84394177e+01 4.63889145e+01 1.30602207e+01 1.73571298e+01
 1.89822570e+00 4.08578877e+00 2.77781792e+00 1.04619855e+01
 1.33319011e+01 7.43189382e+01 5.99806547e-01 1.53992083e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965937592567672
cond(S) = 156.29011211650612
E1 = -183.13550080220514  E_coul = 55.01114069457654
init E= -128.124360107629
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742942887216304  LUMO = 2.65541962657102
  mo_energy =
[-3.25126765e+01 -1.85401104e+00 -7.42942887e-01 -7.42942887e-01
 -7.42942887e-01  2.65541963e+00  2.65541963e+00  2.65541963e+00
  2.68875482e+00  1.99592394e+01  1.99592394e+01  1.99592394e+01
  4.40792283e+01  3.19603908e+02  1.98499340e+03  7.27410605e+03]
E1 = -182.1167368476409  E_coul = 53.92166978278719
cycle= 1 E= -128.195067064854  delta_E= -0.0707  |g|= 0.167  |ddm|= 0.184
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264731
diis-c [-0.07008241  1.        ]
  HOMO = -0.809062162858957  LUMO = 2.60025150958599
  mo_energy =
[-3.27887096e+01 -1.92218698e+00 -8.09062163e-01 -8.09062163e-01
 -8.09062163e-01  2.60025151e+00  2.60025151e+00  2.60025151e+00
  2.63545375e+00  1.97662720e+01  1.97662720e+01  1.97662720e+01
  4.38430839e+01  3.19292310e+02  1.98463125e+03  7.27371851e+03]
E1 = -182.5850586109013  E_coul = 54.38832297322804
cycle= 2 E= -128.196735637673  delta_E= -0.00167  |g|= 0.0633  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10319
diis-c [-4.56438595e-04  2.76722913e-01  7.23277087e-01]
  HOMO = -0.7859666509768  LUMO = 2.62116621805215
  mo_energy =
[-3.27129169e+01 -1.89822310e+00 -7.85966651e-01 -7.85966651e-01
 -7.85966651e-01  2.62116622e+00  2.62116622e+00  2.62116622e+00
  2.65551630e+00  1.98232154e+01  1.98232154e+01  1.98232154e+01
  4.39097508e+01  3.19374941e+02  1.98471954e+03  7.27380831e+03]
E1 = -182.45071023025517  E_coul = 54.253661348174084
cycle= 3 E= -128.197048882081  delta_E= -0.000313  |g|= 0.000789  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108209
diis-c [-5.45447976e-08 -3.48485549e-03  1.37012551e-03  1.00211473e+00]
  HOMO = -0.786245879168837  LUMO = 2.62094872333225
  mo_energy =
[-3.27137242e+01 -1.89856029e+00 -7.86245879e-01 -7.86245879e-01
 -7.86245879e-01  2.62094872e+00  2.62094872e+00  2.62094872e+00
  2.65525478e+00  1.98225881e+01  1.98225881e+01  1.98225881e+01
  4.39090046e+01  3.19374265e+02  1.98471898e+03  7.27380778e+03]
E1 = -182.45224545581658  E_coul = 54.25519653037048
cycle= 4 E= -128.197048925446  delta_E= -4.34e-08  |g|= 4.13e-05  |ddm|= 0.000271
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.63189e-05
diis-c [-1.89110082e-10  4.36968066e-04 -1.11157260e-03 -1.56914644e-01
  1.15758925e+00]
  HOMO = -0.786233876137963  LUMO = 2.62095914800391
  mo_energy =
[-3.27136933e+01 -1.89855774e+00 -7.86233876e-01 -7.86233876e-01
 -7.86233876e-01  2.62095915e+00  2.62095915e+00  2.62095915e+00
  2.65525629e+00  1.98226120e+01  1.98226120e+01  1.98226120e+01
  4.39090296e+01  3.19374308e+02  1.98471903e+03  7.27380784e+03]
E1 = -182.4521937360966  E_coul = 54.25514481045726
cycle= 5 E= -128.197048925639  delta_E= -1.93e-10  |g|= 1.64e-06  |ddm|= 2.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4521937360966  E_coul = 54.25514481045726
  HOMO = -0.786233708208082  LUMO = 2.62095930598671
  mo_energy =
[-3.27136929e+01 -1.89855798e+00 -7.86233708e-01 -7.86233708e-01
 -7.86233708e-01  2.62095931e+00  2.62095931e+00  2.62095931e+00
  2.65525608e+00  1.98226123e+01  1.98226123e+01  1.98226123e+01
  4.39090298e+01  3.19374308e+02  1.98471903e+03  7.27380784e+03]
E1 = -182.45219323434833  E_coul = 54.2551443087086
Extra cycle  E= -128.19704892564  delta_E= -3.98e-13  |g|= 3.17e-07  |ddm|= 9.38e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419170e+03 2.15465955e+02 1.42946003e+03 5.65140698e-01
 4.84394177e+01 1.30602207e+01 1.89822570e+00 2.77781792e+00
 1.33319011e+01 5.99806547e-01]
E = -128.19704892563973
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19170292        1
[INPUT] 0    0    [1    /1   ]  215.465955247        1
[INPUT] 0    0    [1    /1   ]  1429.46002613        1
[INPUT] 0    0    [1    /1   ]  0.56514069785        1
[INPUT] 0    0    [1    /1   ]  48.4394177395        1
[INPUT] 0    0    [1    /1   ]  13.0602206747        1
[INPUT] 0    0    [1    /1   ]  1.89822569519        1
[INPUT] 1    0    [1    /1   ]  2.77781792152        1
[INPUT] 1    0    [1    /1   ]  13.3319010841        1
[INPUT] 1    0    [1    /1   ]  0.599806546637       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917029175884, 1.0]], [0, [215.46595524695255, 1.0]], [0, [1429.4600261293908, 1.0]], [0, [0.5651406978503091, 1.0]], [0, [48.43941773954869, 1.0]], [0, [13.060220674705306, 1.0]], [0, [1.89822569519123, 1.0]], [1, [2.7778179215184524, 1.0]], [1, [13.331901084115959, 1.0]], [1, [0.5998065466374484, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19170292]
bas 1, expnt(s) = [215.46595525]
bas 2, expnt(s) = [1429.46002613]
bas 3, expnt(s) = [0.5651407]
bas 4, expnt(s) = [48.43941774]
bas 5, expnt(s) = [13.06022067]
bas 6, expnt(s) = [1.8982257]
bas 7, expnt(s) = [2.77781792]
bas 8, expnt(s) = [13.33190108]
bas 9, expnt(s) = [0.59980655]
CPU time:        10.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419170e+03 7.96091034e+02 2.15465955e+02 1.42085257e+02
 1.42946003e+03 5.87346027e+02 5.65140698e-01 1.64676816e+00
 4.84394177e+01 4.63889145e+01 1.30602207e+01 1.73571298e+01
 1.89822570e+00 4.08578877e+00 2.77781792e+00 1.04619855e+01
 1.33319011e+01 7.43189382e+01 5.99806547e-01 1.53992083e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965937592567672
cond(S) = 156.29011211650612
E1 = -183.13550080220514  E_coul = 55.01114069457654
init E= -128.124360107629
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742942887216304  LUMO = 2.65541962657102
  mo_energy =
[-3.25126765e+01 -1.85401104e+00 -7.42942887e-01 -7.42942887e-01
 -7.42942887e-01  2.65541963e+00  2.65541963e+00  2.65541963e+00
  2.68875482e+00  1.99592394e+01  1.99592394e+01  1.99592394e+01
  4.40792283e+01  3.19603908e+02  1.98499340e+03  7.27410605e+03]
E1 = -182.1167368476409  E_coul = 53.92166978278719
cycle= 1 E= -128.195067064854  delta_E= -0.0707  |g|= 0.167  |ddm|= 0.184
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264731
diis-c [-0.07008241  1.        ]
  HOMO = -0.809062162858957  LUMO = 2.60025150958599
  mo_energy =
[-3.27887096e+01 -1.92218698e+00 -8.09062163e-01 -8.09062163e-01
 -8.09062163e-01  2.60025151e+00  2.60025151e+00  2.60025151e+00
  2.63545375e+00  1.97662720e+01  1.97662720e+01  1.97662720e+01
  4.38430839e+01  3.19292310e+02  1.98463125e+03  7.27371851e+03]
E1 = -182.5850586109013  E_coul = 54.38832297322804
cycle= 2 E= -128.196735637673  delta_E= -0.00167  |g|= 0.0633  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10319
diis-c [-4.56438595e-04  2.76722913e-01  7.23277087e-01]
  HOMO = -0.7859666509768  LUMO = 2.62116621805215
  mo_energy =
[-3.27129169e+01 -1.89822310e+00 -7.85966651e-01 -7.85966651e-01
 -7.85966651e-01  2.62116622e+00  2.62116622e+00  2.62116622e+00
  2.65551630e+00  1.98232154e+01  1.98232154e+01  1.98232154e+01
  4.39097508e+01  3.19374941e+02  1.98471954e+03  7.27380831e+03]
E1 = -182.45071023025517  E_coul = 54.253661348174084
cycle= 3 E= -128.197048882081  delta_E= -0.000313  |g|= 0.000789  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108209
diis-c [-5.45447976e-08 -3.48485549e-03  1.37012551e-03  1.00211473e+00]
  HOMO = -0.786245879168837  LUMO = 2.62094872333225
  mo_energy =
[-3.27137242e+01 -1.89856029e+00 -7.86245879e-01 -7.86245879e-01
 -7.86245879e-01  2.62094872e+00  2.62094872e+00  2.62094872e+00
  2.65525478e+00  1.98225881e+01  1.98225881e+01  1.98225881e+01
  4.39090046e+01  3.19374265e+02  1.98471898e+03  7.27380778e+03]
E1 = -182.45224545581658  E_coul = 54.25519653037048
cycle= 4 E= -128.197048925446  delta_E= -4.34e-08  |g|= 4.13e-05  |ddm|= 0.000271
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.63189e-05
diis-c [-1.89110082e-10  4.36968066e-04 -1.11157260e-03 -1.56914644e-01
  1.15758925e+00]
  HOMO = -0.786233876137963  LUMO = 2.62095914800391
  mo_energy =
[-3.27136933e+01 -1.89855774e+00 -7.86233876e-01 -7.86233876e-01
 -7.86233876e-01  2.62095915e+00  2.62095915e+00  2.62095915e+00
  2.65525629e+00  1.98226120e+01  1.98226120e+01  1.98226120e+01
  4.39090296e+01  3.19374308e+02  1.98471903e+03  7.27380784e+03]
E1 = -182.4521937360966  E_coul = 54.25514481045726
cycle= 5 E= -128.197048925639  delta_E= -1.93e-10  |g|= 1.64e-06  |ddm|= 2.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4521937360966  E_coul = 54.25514481045726
  HOMO = -0.786233708208082  LUMO = 2.62095930598671
  mo_energy =
[-3.27136929e+01 -1.89855798e+00 -7.86233708e-01 -7.86233708e-01
 -7.86233708e-01  2.62095931e+00  2.62095931e+00  2.62095931e+00
  2.65525608e+00  1.98226123e+01  1.98226123e+01  1.98226123e+01
  4.39090298e+01  3.19374308e+02  1.98471903e+03  7.27380784e+03]
E1 = -182.45219323434833  E_coul = 54.2551443087086
Extra cycle  E= -128.19704892564  delta_E= -3.98e-13  |g|= 3.17e-07  |ddm|= 9.38e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.29011211650612
E1 = -182.45219323434833  E_coul = 54.2551443087086
init E= -128.19704892564
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786233725552996  LUMO = 2.62095928859953
  mo_energy =
[-3.27136931e+01 -1.89855808e+00 -7.86233726e-01 -7.86233726e-01
 -7.86233726e-01  2.62095929e+00  2.62095929e+00  2.62095929e+00
  2.65525599e+00  1.98226122e+01  1.98226122e+01  1.98226122e+01
  4.39090297e+01  3.19374308e+02  1.98471903e+03  7.27380784e+03]
E1 = -182.45219344780566  E_coul = 54.25514452216573
cycle= 1 E= -128.19704892564  delta_E= -1.99e-13  |g|= 6.05e-08  |ddm|= 1.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45219344780566  E_coul = 54.25514452216573
  HOMO = -0.786233707754848  LUMO = 2.62095930441953
  mo_energy =
[-3.27136930e+01 -1.89855807e+00 -7.86233708e-01 -7.86233708e-01
 -7.86233708e-01  2.62095930e+00  2.62095930e+00  2.62095930e+00
  2.65525600e+00  1.98226122e+01  1.98226122e+01  1.98226122e+01
  4.39090297e+01  3.19374308e+02  1.98471903e+03  7.27380784e+03]
E1 = -182.45219336594764  E_coul = 54.255144440307646
Extra cycle  E= -128.19704892564  delta_E= -5.68e-14  |g|= 1.57e-08  |ddm|= 2.93e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419170e+03 2.15465955e+02 1.42946003e+03 5.65140698e-01
 4.84394177e+01 1.30602207e+01 1.89822570e+00 2.77781792e+00
 1.33319011e+01 5.99806547e-01]
grad_E = [-7.47929670e-06 -3.17383326e-04  4.59947688e-05 -5.05152975e-03
  4.67086098e-04  4.40641084e-04  5.84428267e-04  2.13209945e-03
 -9.84291514e-05 -9.76859570e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19168467        1
[INPUT] 0    0    [1    /1   ]  215.465100543        1
[INPUT] 0    0    [1    /1   ]  1429.46013982        1
[INPUT] 0    0    [1    /1   ]  0.566058167588       1
[INPUT] 0    0    [1    /1   ]  48.44163114          1
[INPUT] 0    0    [1    /1   ]  13.0569591994        1
[INPUT] 0    0    [1    /1   ]  1.89860931637        1
[INPUT] 1    0    [1    /1   ]  2.77766485185        1
[INPUT] 1    0    [1    /1   ]  13.3319084854        1
[INPUT] 1    0    [1    /1   ]  0.600480902844       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191684672949, 1.0]], [0, [215.4651005431929, 1.0]], [0, [1429.4601398182645, 1.0]], [0, [0.5660581675878468, 1.0]], [0, [48.44163114000846, 1.0]], [0, [13.056959199364208, 1.0]], [0, [1.8986093163663955, 1.0]], [1, [2.7776648518465232, 1.0]], [1, [13.331908485364345, 1.0]], [1, [0.6004809028441928, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19168467]
bas 1, expnt(s) = [215.46510054]
bas 2, expnt(s) = [1429.46013982]
bas 3, expnt(s) = [0.56605817]
bas 4, expnt(s) = [48.44163114]
bas 5, expnt(s) = [13.0569592]
bas 6, expnt(s) = [1.89860932]
bas 7, expnt(s) = [2.77766485]
bas 8, expnt(s) = [13.33190849]
bas 9, expnt(s) = [0.6004809]
CPU time:        12.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419168e+03 7.96091029e+02 2.15465101e+02 1.42084835e+02
 1.42946014e+03 5.87346062e+02 5.66058168e-01 1.64877282e+00
 4.84416311e+01 4.63905042e+01 1.30569592e+01 1.73538788e+01
 1.89860932e+00 4.08640804e+00 2.77766485e+00 1.04612648e+01
 1.33319085e+01 7.43189897e+01 6.00480903e-01 1.54208528e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965812349848356
cond(S) = 156.2969327508574
E1 = -183.13583023416777  E_coul = 55.011439908495014
init E= -128.124390325673
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742890633955127  LUMO = 2.65768959305857
  mo_energy =
[-3.25127235e+01 -1.85394476e+00 -7.42890634e-01 -7.42890634e-01
 -7.42890634e-01  2.65768959e+00  2.65768959e+00  2.65768959e+00
  2.69256464e+00  1.99607094e+01  1.99607094e+01  1.99607094e+01
  4.40779956e+01  3.19601769e+02  1.98499128e+03  7.27410385e+03]
E1 = -182.12580145348932  E_coul = 53.93069902739297
cycle= 1 E= -128.195102426096  delta_E= -0.0707  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262911
diis-c [-0.06912237  1.        ]
  HOMO = -0.808301060975196  LUMO = 2.60315099630591
  mo_energy =
[-3.27872742e+01 -1.92138849e+00 -8.08301061e-01 -8.08301061e-01
 -8.08301061e-01  2.60315100e+00  2.60315100e+00  2.60315100e+00
  2.63985007e+00  1.97691017e+01  1.97691017e+01  1.97691017e+01
  4.38433101e+01  3.19291544e+02  1.98463048e+03  7.27371764e+03]
E1 = -182.59044383815404  E_coul = 54.39369588440626
cycle= 2 E= -128.196747953748  delta_E= -0.00165  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102354
diis-c [-4.53687171e-04  2.76434029e-01  7.23565971e-01]
  HOMO = -0.785378464056568  LUMO = 2.62391192706123
  mo_energy =
[-3.27120384e+01 -1.89760866e+00 -7.85378464e-01 -7.85378464e-01
 -7.85378464e-01  2.62391193e+00  2.62391193e+00  2.62391193e+00
  2.65977073e+00  1.98256202e+01  1.98256202e+01  1.98256202e+01
  4.39094816e+01  3.19373583e+02  1.98471815e+03  7.27380682e+03]
E1 = -182.4572592358816  E_coul = 54.26020327554345
cycle= 3 E= -128.197055960338  delta_E= -0.000308  |g|= 0.000788  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107697
diis-c [-5.63452769e-08 -3.49798062e-03  1.34963233e-03  1.00214835e+00]
  HOMO = -0.785656481941007  LUMO = 2.62369500563558
  mo_energy =
[-3.27128440e+01 -1.89794559e+00 -7.85656482e-01 -7.85656482e-01
 -7.85656482e-01  2.62369501e+00  2.62369501e+00  2.62369501e+00
  2.65950894e+00  1.98249944e+01  1.98249944e+01  1.98249944e+01
  4.39087370e+01  3.19372911e+02  1.98471759e+03  7.27380629e+03]
E1 = -182.4587898707826  E_coul = 54.2617338671826
cycle= 4 E= -128.1970560036  delta_E= -4.33e-08  |g|= 4.21e-05  |ddm|= 0.000272
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.76189e-05
diis-c [-1.96866289e-10  4.36246103e-04 -1.13314447e-03 -1.56871154e-01
  1.15756805e+00]
  HOMO = -0.785644219909481  LUMO = 2.62370566552532
  mo_energy =
[-3.27128124e+01 -1.89794295e+00 -7.85644220e-01 -7.85644220e-01
 -7.85644220e-01  2.62370567e+00  2.62370567e+00  2.62370567e+00
  2.65951053e+00  1.98250189e+01  1.98250189e+01  1.98250189e+01
  4.39087625e+01  3.19372955e+02  1.98471765e+03  7.27380636e+03]
E1 = -182.45873704925813  E_coul = 54.2616810454577
cycle= 5 E= -128.1970560038  delta_E= -2e-10  |g|= 1.66e-06  |ddm|= 2.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45873704925813  E_coul = 54.2616810454577
  HOMO = -0.785644057805362  LUMO = 2.62370581756114
  mo_energy =
[-3.27128121e+01 -1.89794320e+00 -7.85644058e-01 -7.85644058e-01
 -7.85644058e-01  2.62370582e+00  2.62370582e+00  2.62370582e+00
  2.65951031e+00  1.98250191e+01  1.98250191e+01  1.98250191e+01
  4.39087627e+01  3.19372955e+02  1.98471765e+03  7.27380636e+03]
E1 = -182.45873658486474  E_coul = 54.2616805810638
Extra cycle  E= -128.197056003801  delta_E= -4.83e-13  |g|= 3.2e-07  |ddm|= 9.54e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419168e+03 2.15465101e+02 1.42946014e+03 5.66058168e-01
 4.84416311e+01 1.30569592e+01 1.89860932e+00 2.77766485e+00
 1.33319085e+01 6.00480903e-01]
E = -128.19705600380092
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19168467        1
[INPUT] 0    0    [1    /1   ]  215.465100543        1
[INPUT] 0    0    [1    /1   ]  1429.46013982        1
[INPUT] 0    0    [1    /1   ]  0.566058167588       1
[INPUT] 0    0    [1    /1   ]  48.44163114          1
[INPUT] 0    0    [1    /1   ]  13.0569591994        1
[INPUT] 0    0    [1    /1   ]  1.89860931637        1
[INPUT] 1    0    [1    /1   ]  2.77766485185        1
[INPUT] 1    0    [1    /1   ]  13.3319084854        1
[INPUT] 1    0    [1    /1   ]  0.600480902844       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191684672949, 1.0]], [0, [215.4651005431929, 1.0]], [0, [1429.4601398182645, 1.0]], [0, [0.5660581675878468, 1.0]], [0, [48.44163114000846, 1.0]], [0, [13.056959199364208, 1.0]], [0, [1.8986093163663955, 1.0]], [1, [2.7776648518465232, 1.0]], [1, [13.331908485364345, 1.0]], [1, [0.6004809028441928, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19168467]
bas 1, expnt(s) = [215.46510054]
bas 2, expnt(s) = [1429.46013982]
bas 3, expnt(s) = [0.56605817]
bas 4, expnt(s) = [48.44163114]
bas 5, expnt(s) = [13.0569592]
bas 6, expnt(s) = [1.89860932]
bas 7, expnt(s) = [2.77766485]
bas 8, expnt(s) = [13.33190849]
bas 9, expnt(s) = [0.6004809]
CPU time:        12.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419168e+03 7.96091029e+02 2.15465101e+02 1.42084835e+02
 1.42946014e+03 5.87346062e+02 5.66058168e-01 1.64877282e+00
 4.84416311e+01 4.63905042e+01 1.30569592e+01 1.73538788e+01
 1.89860932e+00 4.08640804e+00 2.77766485e+00 1.04612648e+01
 1.33319085e+01 7.43189897e+01 6.00480903e-01 1.54208528e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965812349848356
cond(S) = 156.2969327508574
E1 = -183.13583023416777  E_coul = 55.011439908495014
init E= -128.124390325673
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742890633955127  LUMO = 2.65768959305857
  mo_energy =
[-3.25127235e+01 -1.85394476e+00 -7.42890634e-01 -7.42890634e-01
 -7.42890634e-01  2.65768959e+00  2.65768959e+00  2.65768959e+00
  2.69256464e+00  1.99607094e+01  1.99607094e+01  1.99607094e+01
  4.40779956e+01  3.19601769e+02  1.98499128e+03  7.27410385e+03]
E1 = -182.12580145348932  E_coul = 53.93069902739297
cycle= 1 E= -128.195102426096  delta_E= -0.0707  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262911
diis-c [-0.06912237  1.        ]
  HOMO = -0.808301060975196  LUMO = 2.60315099630591
  mo_energy =
[-3.27872742e+01 -1.92138849e+00 -8.08301061e-01 -8.08301061e-01
 -8.08301061e-01  2.60315100e+00  2.60315100e+00  2.60315100e+00
  2.63985007e+00  1.97691017e+01  1.97691017e+01  1.97691017e+01
  4.38433101e+01  3.19291544e+02  1.98463048e+03  7.27371764e+03]
E1 = -182.59044383815404  E_coul = 54.39369588440626
cycle= 2 E= -128.196747953748  delta_E= -0.00165  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102354
diis-c [-4.53687171e-04  2.76434029e-01  7.23565971e-01]
  HOMO = -0.785378464056568  LUMO = 2.62391192706123
  mo_energy =
[-3.27120384e+01 -1.89760866e+00 -7.85378464e-01 -7.85378464e-01
 -7.85378464e-01  2.62391193e+00  2.62391193e+00  2.62391193e+00
  2.65977073e+00  1.98256202e+01  1.98256202e+01  1.98256202e+01
  4.39094816e+01  3.19373583e+02  1.98471815e+03  7.27380682e+03]
E1 = -182.4572592358816  E_coul = 54.26020327554345
cycle= 3 E= -128.197055960338  delta_E= -0.000308  |g|= 0.000788  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107697
diis-c [-5.63452769e-08 -3.49798062e-03  1.34963233e-03  1.00214835e+00]
  HOMO = -0.785656481941007  LUMO = 2.62369500563558
  mo_energy =
[-3.27128440e+01 -1.89794559e+00 -7.85656482e-01 -7.85656482e-01
 -7.85656482e-01  2.62369501e+00  2.62369501e+00  2.62369501e+00
  2.65950894e+00  1.98249944e+01  1.98249944e+01  1.98249944e+01
  4.39087370e+01  3.19372911e+02  1.98471759e+03  7.27380629e+03]
E1 = -182.4587898707826  E_coul = 54.2617338671826
cycle= 4 E= -128.1970560036  delta_E= -4.33e-08  |g|= 4.21e-05  |ddm|= 0.000272
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.76189e-05
diis-c [-1.96866289e-10  4.36246103e-04 -1.13314447e-03 -1.56871154e-01
  1.15756805e+00]
  HOMO = -0.785644219909481  LUMO = 2.62370566552532
  mo_energy =
[-3.27128124e+01 -1.89794295e+00 -7.85644220e-01 -7.85644220e-01
 -7.85644220e-01  2.62370567e+00  2.62370567e+00  2.62370567e+00
  2.65951053e+00  1.98250189e+01  1.98250189e+01  1.98250189e+01
  4.39087625e+01  3.19372955e+02  1.98471765e+03  7.27380636e+03]
E1 = -182.45873704925813  E_coul = 54.2616810454577
cycle= 5 E= -128.1970560038  delta_E= -2e-10  |g|= 1.66e-06  |ddm|= 2.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45873704925813  E_coul = 54.2616810454577
  HOMO = -0.785644057805362  LUMO = 2.62370581756114
  mo_energy =
[-3.27128121e+01 -1.89794320e+00 -7.85644058e-01 -7.85644058e-01
 -7.85644058e-01  2.62370582e+00  2.62370582e+00  2.62370582e+00
  2.65951031e+00  1.98250191e+01  1.98250191e+01  1.98250191e+01
  4.39087627e+01  3.19372955e+02  1.98471765e+03  7.27380636e+03]
E1 = -182.45873658486474  E_coul = 54.2616805810638
Extra cycle  E= -128.197056003801  delta_E= -4.83e-13  |g|= 3.2e-07  |ddm|= 9.54e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.2969327508574
E1 = -182.45873658486474  E_coul = 54.2616805810638
init E= -128.197056003801
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785644072374293  LUMO = 2.62370580266246
  mo_energy =
[-3.27128122e+01 -1.89794330e+00 -7.85644072e-01 -7.85644072e-01
 -7.85644072e-01  2.62370580e+00  2.62370580e+00  2.62370580e+00
  2.65951023e+00  1.98250190e+01  1.98250190e+01  1.98250190e+01
  4.39087626e+01  3.19372955e+02  1.98471765e+03  7.27380636e+03]
E1 = -182.4587367833438  E_coul = 54.26168077954273
cycle= 1 E= -128.197056003801  delta_E= -1.42e-13  |g|= 6.04e-08  |ddm|= 1.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4587367833438  E_coul = 54.26168077954273
  HOMO = -0.785644055559013  LUMO = 2.62370581759118
  mo_energy =
[-3.27128122e+01 -1.89794329e+00 -7.85644056e-01 -7.85644056e-01
 -7.85644056e-01  2.62370582e+00  2.62370582e+00  2.62370582e+00
  2.65951023e+00  1.98250191e+01  1.98250191e+01  1.98250191e+01
  4.39087626e+01  3.19372955e+02  1.98471765e+03  7.27380636e+03]
E1 = -182.45873670757854  E_coul = 54.26168070377751
Extra cycle  E= -128.197056003801  delta_E= 2.84e-14  |g|= 1.52e-08  |ddm|= 2.97e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419168e+03 2.15465101e+02 1.42946014e+03 5.66058168e-01
 4.84416311e+01 1.30569592e+01 1.89860932e+00 2.77766485e+00
 1.33319085e+01 6.00480903e-01]
grad_E = [-7.47305400e-06 -3.21071979e-04  4.60290425e-05 -2.87406844e-03
  5.20465988e-04  2.07002293e-04  1.89319130e-04  3.02532309e-04
 -1.52909340e-05 -1.26715177e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19169237        1
[INPUT] 0    0    [1    /1   ]  215.465454768        1
[INPUT] 0    0    [1    /1   ]  1429.46009197        1
[INPUT] 0    0    [1    /1   ]  0.566756221787       1
[INPUT] 0    0    [1    /1   ]  48.4407822066        1
[INPUT] 0    0    [1    /1   ]  13.0579922991        1
[INPUT] 0    0    [1    /1   ]  1.89835717941        1
[INPUT] 1    0    [1    /1   ]  2.77762871965        1
[INPUT] 1    0    [1    /1   ]  13.3319103203        1
[INPUT] 1    0    [1    /1   ]  0.600635070734       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191692369948, 1.0]], [0, [215.4654547677745, 1.0]], [0, [1429.4600919733443, 1.0]], [0, [0.5667562217865436, 1.0]], [0, [48.4407822065846, 1.0]], [0, [13.05799229905769, 1.0]], [0, [1.8983571794091783, 1.0]], [1, [2.777628719653288, 1.0]], [1, [13.331910320345267, 1.0]], [1, [0.6006350707344424, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19169237]
bas 1, expnt(s) = [215.46545477]
bas 2, expnt(s) = [1429.46009197]
bas 3, expnt(s) = [0.56675622]
bas 4, expnt(s) = [48.44078221]
bas 5, expnt(s) = [13.0579923]
bas 6, expnt(s) = [1.89835718]
bas 7, expnt(s) = [2.77762872]
bas 8, expnt(s) = [13.33191032]
bas 9, expnt(s) = [0.60063507]
CPU time:        14.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419169e+03 7.96091031e+02 2.15465455e+02 1.42085010e+02
 1.42946009e+03 5.87346048e+02 5.66756222e-01 1.65029752e+00
 4.84407822e+01 4.63898945e+01 1.30579923e+01 1.73549086e+01
 1.89835718e+00 4.08600102e+00 2.77762872e+00 1.04610947e+01
 1.33319103e+01 7.43190025e+01 6.00635071e-01 1.54258019e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965777284399525
cond(S) = 156.30325531079492
E1 = -183.13581865875585  E_coul = 55.01139911783168
init E= -128.124419540924
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742880528516939  LUMO = 2.65820901483414
  mo_energy =
[-3.25127782e+01 -1.85393080e+00 -7.42880529e-01 -7.42880529e-01
 -7.42880529e-01  2.65820901e+00  2.65820901e+00  2.65820901e+00
  2.69486993e+00  1.99610090e+01  1.99610090e+01  1.99610090e+01
  4.40818541e+01  3.19604793e+02  1.98499385e+03  7.27410631e+03]
E1 = -182.1288311061124  E_coul = 53.93371707119794
cycle= 1 E= -128.195114034914  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26222
diis-c [-0.06875911  1.        ]
  HOMO = -0.808039478530731  LUMO = 2.60389381451569
  mo_energy =
[-3.27867862e+01 -1.92115091e+00 -8.08039479e-01 -8.08039479e-01
 -8.08039479e-01  2.60389381e+00  2.60389381e+00  2.60389381e+00
  2.64232639e+00  1.97698842e+01  1.97698842e+01  1.97698842e+01
  4.38477018e+01  3.19295114e+02  1.98463360e+03  7.27372065e+03]
E1 = -182.5921922556002  E_coul = 54.39544074360214
cycle= 2 E= -128.196751511998  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102069
diis-c [-4.53319254e-04  2.76384266e-01  7.23615734e-01]
  HOMO = -0.78517843413681  LUMO = 2.62459974586972
  mo_energy =
[-3.27117497e+01 -1.89743774e+00 -7.85178434e-01 -7.85178434e-01
 -7.85178434e-01  2.62459975e+00  2.62459975e+00  2.62459975e+00
  2.66219660e+00  1.98262511e+01  1.98262511e+01  1.98262511e+01
  4.39136967e+01  3.19376942e+02  1.98472105e+03  7.27380961e+03]
E1 = -182.4594166039541  E_coul = 54.26235888536518
cycle= 3 E= -128.197057718589  delta_E= -0.000306  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106824
diis-c [-6.03691173e-08 -3.52763516e-03  1.19091686e-03  1.00233672e+00]
  HOMO = -0.785454456946895  LUMO = 2.6243843994287
  mo_energy =
[-3.27125511e+01 -1.89777516e+00 -7.85454457e-01 -7.85454457e-01
 -7.85454457e-01  2.62438440e+00  2.62438440e+00  2.62438440e+00
  2.66193418e+00  1.98256286e+01  1.98256286e+01  1.98256286e+01
  4.39129555e+01  3.19376278e+02  1.98472050e+03  7.27380910e+03]
E1 = -182.46093977015272  E_coul = 54.26388200831752
cycle= 4 E= -128.197057761835  delta_E= -4.32e-08  |g|= 4.4e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.04507e-05
diis-c [-2.05462879e-10  4.44958130e-04 -1.15436581e-03 -1.59595972e-01
  1.16030538e+00]
  HOMO = -0.785441690938176  LUMO = 2.62439550156732
  mo_energy =
[-3.27125182e+01 -1.89777250e+00 -7.85441691e-01 -7.85441691e-01
 -7.85441691e-01  2.62439550e+00  2.62439550e+00  2.62439550e+00
  2.66193575e+00  1.98256541e+01  1.98256541e+01  1.98256541e+01
  4.39129820e+01  3.19376323e+02  1.98472056e+03  7.27380916e+03]
E1 = -182.4608848644384  E_coul = 54.263827102383715
cycle= 5 E= -128.197057762055  delta_E= -2.2e-10  |g|= 1.66e-06  |ddm|= 2.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4608848644384  E_coul = 54.263827102383715
  HOMO = -0.785441545512029  LUMO = 2.62439563870243
  mo_energy =
[-3.27125179e+01 -1.89777277e+00 -7.85441546e-01 -7.85441546e-01
 -7.85441546e-01  2.62439564e+00  2.62439564e+00  2.62439564e+00
  2.66193552e+00  1.98256543e+01  1.98256543e+01  1.98256543e+01
  4.39129822e+01  3.19376323e+02  1.98472056e+03  7.27380916e+03]
E1 = -182.46088448689284  E_coul = 54.26382672483767
Extra cycle  E= -128.197057762055  delta_E= -4.83e-13  |g|= 3.16e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419169e+03 2.15465455e+02 1.42946009e+03 5.66756222e-01
 4.84407822e+01 1.30579923e+01 1.89835718e+00 2.77762872e+00
 1.33319103e+01 6.00635071e-01]
E = -128.19705776205518
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19169237        1
[INPUT] 0    0    [1    /1   ]  215.465454768        1
[INPUT] 0    0    [1    /1   ]  1429.46009197        1
[INPUT] 0    0    [1    /1   ]  0.566756221787       1
[INPUT] 0    0    [1    /1   ]  48.4407822066        1
[INPUT] 0    0    [1    /1   ]  13.0579922991        1
[INPUT] 0    0    [1    /1   ]  1.89835717941        1
[INPUT] 1    0    [1    /1   ]  2.77762871965        1
[INPUT] 1    0    [1    /1   ]  13.3319103203        1
[INPUT] 1    0    [1    /1   ]  0.600635070734       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191692369948, 1.0]], [0, [215.4654547677745, 1.0]], [0, [1429.4600919733443, 1.0]], [0, [0.5667562217865436, 1.0]], [0, [48.4407822065846, 1.0]], [0, [13.05799229905769, 1.0]], [0, [1.8983571794091783, 1.0]], [1, [2.777628719653288, 1.0]], [1, [13.331910320345267, 1.0]], [1, [0.6006350707344424, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19169237]
bas 1, expnt(s) = [215.46545477]
bas 2, expnt(s) = [1429.46009197]
bas 3, expnt(s) = [0.56675622]
bas 4, expnt(s) = [48.44078221]
bas 5, expnt(s) = [13.0579923]
bas 6, expnt(s) = [1.89835718]
bas 7, expnt(s) = [2.77762872]
bas 8, expnt(s) = [13.33191032]
bas 9, expnt(s) = [0.60063507]
CPU time:        15.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419169e+03 7.96091031e+02 2.15465455e+02 1.42085010e+02
 1.42946009e+03 5.87346048e+02 5.66756222e-01 1.65029752e+00
 4.84407822e+01 4.63898945e+01 1.30579923e+01 1.73549086e+01
 1.89835718e+00 4.08600102e+00 2.77762872e+00 1.04610947e+01
 1.33319103e+01 7.43190025e+01 6.00635071e-01 1.54258019e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965777284399525
cond(S) = 156.30325531079492
E1 = -183.13581865875585  E_coul = 55.01139911783168
init E= -128.124419540924
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742880528516939  LUMO = 2.65820901483414
  mo_energy =
[-3.25127782e+01 -1.85393080e+00 -7.42880529e-01 -7.42880529e-01
 -7.42880529e-01  2.65820901e+00  2.65820901e+00  2.65820901e+00
  2.69486993e+00  1.99610090e+01  1.99610090e+01  1.99610090e+01
  4.40818541e+01  3.19604793e+02  1.98499385e+03  7.27410631e+03]
E1 = -182.1288311061124  E_coul = 53.93371707119794
cycle= 1 E= -128.195114034914  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26222
diis-c [-0.06875911  1.        ]
  HOMO = -0.808039478530731  LUMO = 2.60389381451569
  mo_energy =
[-3.27867862e+01 -1.92115091e+00 -8.08039479e-01 -8.08039479e-01
 -8.08039479e-01  2.60389381e+00  2.60389381e+00  2.60389381e+00
  2.64232639e+00  1.97698842e+01  1.97698842e+01  1.97698842e+01
  4.38477018e+01  3.19295114e+02  1.98463360e+03  7.27372065e+03]
E1 = -182.5921922556002  E_coul = 54.39544074360214
cycle= 2 E= -128.196751511998  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102069
diis-c [-4.53319254e-04  2.76384266e-01  7.23615734e-01]
  HOMO = -0.78517843413681  LUMO = 2.62459974586972
  mo_energy =
[-3.27117497e+01 -1.89743774e+00 -7.85178434e-01 -7.85178434e-01
 -7.85178434e-01  2.62459975e+00  2.62459975e+00  2.62459975e+00
  2.66219660e+00  1.98262511e+01  1.98262511e+01  1.98262511e+01
  4.39136967e+01  3.19376942e+02  1.98472105e+03  7.27380961e+03]
E1 = -182.4594166039541  E_coul = 54.26235888536518
cycle= 3 E= -128.197057718589  delta_E= -0.000306  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106824
diis-c [-6.03691173e-08 -3.52763516e-03  1.19091686e-03  1.00233672e+00]
  HOMO = -0.785454456946895  LUMO = 2.6243843994287
  mo_energy =
[-3.27125511e+01 -1.89777516e+00 -7.85454457e-01 -7.85454457e-01
 -7.85454457e-01  2.62438440e+00  2.62438440e+00  2.62438440e+00
  2.66193418e+00  1.98256286e+01  1.98256286e+01  1.98256286e+01
  4.39129555e+01  3.19376278e+02  1.98472050e+03  7.27380910e+03]
E1 = -182.46093977015272  E_coul = 54.26388200831752
cycle= 4 E= -128.197057761835  delta_E= -4.32e-08  |g|= 4.4e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.04507e-05
diis-c [-2.05462879e-10  4.44958130e-04 -1.15436581e-03 -1.59595972e-01
  1.16030538e+00]
  HOMO = -0.785441690938176  LUMO = 2.62439550156732
  mo_energy =
[-3.27125182e+01 -1.89777250e+00 -7.85441691e-01 -7.85441691e-01
 -7.85441691e-01  2.62439550e+00  2.62439550e+00  2.62439550e+00
  2.66193575e+00  1.98256541e+01  1.98256541e+01  1.98256541e+01
  4.39129820e+01  3.19376323e+02  1.98472056e+03  7.27380916e+03]
E1 = -182.4608848644384  E_coul = 54.263827102383715
cycle= 5 E= -128.197057762055  delta_E= -2.2e-10  |g|= 1.66e-06  |ddm|= 2.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4608848644384  E_coul = 54.263827102383715
  HOMO = -0.785441545512029  LUMO = 2.62439563870243
  mo_energy =
[-3.27125179e+01 -1.89777277e+00 -7.85441546e-01 -7.85441546e-01
 -7.85441546e-01  2.62439564e+00  2.62439564e+00  2.62439564e+00
  2.66193552e+00  1.98256543e+01  1.98256543e+01  1.98256543e+01
  4.39129822e+01  3.19376323e+02  1.98472056e+03  7.27380916e+03]
E1 = -182.46088448689284  E_coul = 54.26382672483767
Extra cycle  E= -128.197057762055  delta_E= -4.83e-13  |g|= 3.16e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30325531079492
E1 = -182.46088448689284  E_coul = 54.26382672483767
init E= -128.197057762055
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785441554234604  LUMO = 2.6243956290924
  mo_energy =
[-3.27125180e+01 -1.89777285e+00 -7.85441554e-01 -7.85441554e-01
 -7.85441554e-01  2.62439563e+00  2.62439563e+00  2.62439563e+00
  2.66193544e+00  1.98256542e+01  1.98256542e+01  1.98256542e+01
  4.39129821e+01  3.19376323e+02  1.98472056e+03  7.27380916e+03]
E1 = -182.46088465049527  E_coul = 54.26382688844028
cycle= 1 E= -128.197057762055  delta_E= 1.71e-13  |g|= 5.87e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46088465049527  E_coul = 54.26382688844028
  HOMO = -0.785441539816946  LUMO = 2.62439564185119
  mo_energy =
[-3.27125180e+01 -1.89777285e+00 -7.85441540e-01 -7.85441540e-01
 -7.85441540e-01  2.62439564e+00  2.62439564e+00  2.62439564e+00
  2.66193544e+00  1.98256543e+01  1.98256543e+01  1.98256543e+01
  4.39129821e+01  3.19376323e+02  1.98472056e+03  7.27380916e+03]
E1 = -182.46088458858168  E_coul = 54.26382682652661
Extra cycle  E= -128.197057762055  delta_E= -5.68e-14  |g|= 1.38e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419169e+03 2.15465455e+02 1.42946009e+03 5.66756222e-01
 4.84407822e+01 1.30579923e+01 1.89835718e+00 2.77762872e+00
 1.33319103e+01 6.00635071e-01]
grad_E = [-7.47478736e-06 -3.20066160e-04  4.60192091e-05 -1.11743156e-03
  5.07704516e-04  2.38557895e-04 -2.27445321e-04 -1.13616532e-04
  3.71044779e-06  6.85012778e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19170577        1
[INPUT] 0    0    [1    /1   ]  215.466069993        1
[INPUT] 0    0    [1    /1   ]  1429.46000871        1
[INPUT] 0    0    [1    /1   ]  0.567199661751       1
[INPUT] 0    0    [1    /1   ]  48.4393229245        1
[INPUT] 0    0    [1    /1   ]  13.0597261038        1
[INPUT] 0    0    [1    /1   ]  1.8981245713         1
[INPUT] 1    0    [1    /1   ]  2.77762452645        1
[INPUT] 1    0    [1    /1   ]  13.331910862         1
[INPUT] 1    0    [1    /1   ]  0.600615366849       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917057699266, 1.0]], [0, [215.4660699929169, 1.0]], [0, [1429.4600087056367, 1.0]], [0, [0.5671996617508027, 1.0]], [0, [48.439322924479875, 1.0]], [0, [13.05972610377991, 1.0]], [0, [1.8981245712953347, 1.0]], [1, [2.77762452644749, 1.0]], [1, [13.331910861971181, 1.0]], [1, [0.6006153668485701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19170577]
bas 1, expnt(s) = [215.46606999]
bas 2, expnt(s) = [1429.46000871]
bas 3, expnt(s) = [0.56719966]
bas 4, expnt(s) = [48.43932292]
bas 5, expnt(s) = [13.0597261]
bas 6, expnt(s) = [1.89812457]
bas 7, expnt(s) = [2.77762453]
bas 8, expnt(s) = [13.33191086]
bas 9, expnt(s) = [0.60061537]
CPU time:        16.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419171e+03 7.96091035e+02 2.15466070e+02 1.42085314e+02
 1.42946001e+03 5.87346022e+02 5.67199662e-01 1.65126584e+00
 4.84393229e+01 4.63888464e+01 1.30597261e+01 1.73566368e+01
 1.89812457e+00 4.08562552e+00 2.77762453e+00 1.04610750e+01
 1.33319109e+01 7.43190063e+01 6.00615367e-01 1.54251694e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965774906714454
cond(S) = 156.30788730108605
E1 = -183.13573298349456  E_coul = 55.01129248436861
init E= -128.124440499126
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742883680890093  LUMO = 2.65813946741461
  mo_energy =
[-3.25128177e+01 -1.85393255e+00 -7.42883681e-01 -7.42883681e-01
 -7.42883681e-01  2.65813947e+00  2.65813947e+00  2.65813947e+00
  2.69626360e+00  1.99609095e+01  1.99609095e+01  1.99609095e+01
  4.40861026e+01  3.19608127e+02  1.98499678e+03  7.27410918e+03]
E1 = -182.1294649368595  E_coul = 53.93434792768643
cycle= 1 E= -128.195117009173  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262016
diis-c [-0.06865216  1.        ]
  HOMO = -0.80797978437908  LUMO = 2.60388025990045
  mo_energy =
[-3.27866792e+01 -1.92112139e+00 -8.07979784e-01 -8.07979784e-01
 -8.07979784e-01  2.60388026e+00  2.60388026e+00  2.60388026e+00
  2.64373418e+00  1.97699055e+01  1.97699055e+01  1.97699055e+01
  4.38520938e+01  3.19298623e+02  1.98463670e+03  7.27372370e+03]
E1 = -182.5925211512751  E_coul = 54.39576860778868
cycle= 2 E= -128.196752543486  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102005
diis-c [-4.53633059e-04  2.76407708e-01  7.23592292e-01]
  HOMO = -0.785134328711528  LUMO = 2.62457204484569
  mo_energy =
[-3.27116937e+01 -1.89742583e+00 -7.85134329e-01 -7.85134329e-01
 -7.85134329e-01  2.62457204e+00  2.62457204e+00  2.62457204e+00
  2.66359267e+00  1.98262340e+01  1.98262340e+01  1.98262340e+01
  4.39180437e+01  3.19380398e+02  1.98472410e+03  7.27381261e+03]
E1 = -182.45984568699038  E_coul = 54.262787355335405
cycle= 3 E= -128.197058331655  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106145
diis-c [-6.37639291e-08 -3.55215401e-03  1.04796731e-03  1.00250419e+00]
  HOMO = -0.785408789596418  LUMO = 2.62435802372567
  mo_energy =
[-3.27124915e+01 -1.89776375e+00 -7.85408790e-01 -7.85408790e-01
 -7.85408790e-01  2.62435802e+00  2.62435802e+00  2.62435802e+00
  2.66332971e+00  1.98256143e+01  1.98256143e+01  1.98256143e+01
  4.39173053e+01  3.19379739e+02  1.98472356e+03  7.27381210e+03]
E1 = -182.46136298634022  E_coul = 54.2643046114137
cycle= 4 E= -128.197058374927  delta_E= -4.33e-08  |g|= 4.55e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.27531e-05
diis-c [-2.11222578e-10  4.52713153e-04 -1.16774068e-03 -1.61955582e-01
  1.16267061e+00]
  HOMO = -0.785395620893844  LUMO = 2.62436947723889
  mo_energy =
[-3.27124576e+01 -1.89776110e+00 -7.85395621e-01 -7.85395621e-01
 -7.85395621e-01  2.62436948e+00  2.62436948e+00  2.62436948e+00
  2.66333125e+00  1.98256405e+01  1.98256405e+01  1.98256405e+01
  4.39173327e+01  3.19379785e+02  1.98472362e+03  7.27381217e+03]
E1 = -182.4613064190804  E_coul = 54.26424804391833
cycle= 5 E= -128.197058375162  delta_E= -2.36e-10  |g|= 1.65e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4613064190804  E_coul = 54.26424804391833
  HOMO = -0.785395489458288  LUMO = 2.6243696020407
  mo_energy =
[-3.27124573e+01 -1.89776138e+00 -7.85395489e-01 -7.85395489e-01
 -7.85395489e-01  2.62436960e+00  2.62436960e+00  2.62436960e+00
  2.66333100e+00  1.98256407e+01  1.98256407e+01  1.98256407e+01
  4.39173328e+01  3.19379786e+02  1.98472363e+03  7.27381217e+03]
E1 = -182.46130611230004  E_coul = 54.26424773713754
Extra cycle  E= -128.197058375162  delta_E= -4.55e-13  |g|= 3.11e-07  |ddm|= 9.53e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419171e+03 2.15466070e+02 1.42946001e+03 5.67199662e-01
 4.84393229e+01 1.30597261e+01 1.89812457e+00 2.77762453e+00
 1.33319109e+01 6.00615367e-01]
E = -128.1970583751625
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19170577        1
[INPUT] 0    0    [1    /1   ]  215.466069993        1
[INPUT] 0    0    [1    /1   ]  1429.46000871        1
[INPUT] 0    0    [1    /1   ]  0.567199661751       1
[INPUT] 0    0    [1    /1   ]  48.4393229245        1
[INPUT] 0    0    [1    /1   ]  13.0597261038        1
[INPUT] 0    0    [1    /1   ]  1.8981245713         1
[INPUT] 1    0    [1    /1   ]  2.77762452645        1
[INPUT] 1    0    [1    /1   ]  13.331910862         1
[INPUT] 1    0    [1    /1   ]  0.600615366849       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917057699266, 1.0]], [0, [215.4660699929169, 1.0]], [0, [1429.4600087056367, 1.0]], [0, [0.5671996617508027, 1.0]], [0, [48.439322924479875, 1.0]], [0, [13.05972610377991, 1.0]], [0, [1.8981245712953347, 1.0]], [1, [2.77762452644749, 1.0]], [1, [13.331910861971181, 1.0]], [1, [0.6006153668485701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19170577]
bas 1, expnt(s) = [215.46606999]
bas 2, expnt(s) = [1429.46000871]
bas 3, expnt(s) = [0.56719966]
bas 4, expnt(s) = [48.43932292]
bas 5, expnt(s) = [13.0597261]
bas 6, expnt(s) = [1.89812457]
bas 7, expnt(s) = [2.77762453]
bas 8, expnt(s) = [13.33191086]
bas 9, expnt(s) = [0.60061537]
CPU time:        17.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419171e+03 7.96091035e+02 2.15466070e+02 1.42085314e+02
 1.42946001e+03 5.87346022e+02 5.67199662e-01 1.65126584e+00
 4.84393229e+01 4.63888464e+01 1.30597261e+01 1.73566368e+01
 1.89812457e+00 4.08562552e+00 2.77762453e+00 1.04610750e+01
 1.33319109e+01 7.43190063e+01 6.00615367e-01 1.54251694e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965774906714454
cond(S) = 156.30788730108605
E1 = -183.13573298349456  E_coul = 55.01129248436861
init E= -128.124440499126
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742883680890093  LUMO = 2.65813946741461
  mo_energy =
[-3.25128177e+01 -1.85393255e+00 -7.42883681e-01 -7.42883681e-01
 -7.42883681e-01  2.65813947e+00  2.65813947e+00  2.65813947e+00
  2.69626360e+00  1.99609095e+01  1.99609095e+01  1.99609095e+01
  4.40861026e+01  3.19608127e+02  1.98499678e+03  7.27410918e+03]
E1 = -182.1294649368595  E_coul = 53.93434792768643
cycle= 1 E= -128.195117009173  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262016
diis-c [-0.06865216  1.        ]
  HOMO = -0.80797978437908  LUMO = 2.60388025990045
  mo_energy =
[-3.27866792e+01 -1.92112139e+00 -8.07979784e-01 -8.07979784e-01
 -8.07979784e-01  2.60388026e+00  2.60388026e+00  2.60388026e+00
  2.64373418e+00  1.97699055e+01  1.97699055e+01  1.97699055e+01
  4.38520938e+01  3.19298623e+02  1.98463670e+03  7.27372370e+03]
E1 = -182.5925211512751  E_coul = 54.39576860778868
cycle= 2 E= -128.196752543486  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102005
diis-c [-4.53633059e-04  2.76407708e-01  7.23592292e-01]
  HOMO = -0.785134328711528  LUMO = 2.62457204484569
  mo_energy =
[-3.27116937e+01 -1.89742583e+00 -7.85134329e-01 -7.85134329e-01
 -7.85134329e-01  2.62457204e+00  2.62457204e+00  2.62457204e+00
  2.66359267e+00  1.98262340e+01  1.98262340e+01  1.98262340e+01
  4.39180437e+01  3.19380398e+02  1.98472410e+03  7.27381261e+03]
E1 = -182.45984568699038  E_coul = 54.262787355335405
cycle= 3 E= -128.197058331655  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106145
diis-c [-6.37639291e-08 -3.55215401e-03  1.04796731e-03  1.00250419e+00]
  HOMO = -0.785408789596418  LUMO = 2.62435802372567
  mo_energy =
[-3.27124915e+01 -1.89776375e+00 -7.85408790e-01 -7.85408790e-01
 -7.85408790e-01  2.62435802e+00  2.62435802e+00  2.62435802e+00
  2.66332971e+00  1.98256143e+01  1.98256143e+01  1.98256143e+01
  4.39173053e+01  3.19379739e+02  1.98472356e+03  7.27381210e+03]
E1 = -182.46136298634022  E_coul = 54.2643046114137
cycle= 4 E= -128.197058374927  delta_E= -4.33e-08  |g|= 4.55e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.27531e-05
diis-c [-2.11222578e-10  4.52713153e-04 -1.16774068e-03 -1.61955582e-01
  1.16267061e+00]
  HOMO = -0.785395620893844  LUMO = 2.62436947723889
  mo_energy =
[-3.27124576e+01 -1.89776110e+00 -7.85395621e-01 -7.85395621e-01
 -7.85395621e-01  2.62436948e+00  2.62436948e+00  2.62436948e+00
  2.66333125e+00  1.98256405e+01  1.98256405e+01  1.98256405e+01
  4.39173327e+01  3.19379785e+02  1.98472362e+03  7.27381217e+03]
E1 = -182.4613064190804  E_coul = 54.26424804391833
cycle= 5 E= -128.197058375162  delta_E= -2.36e-10  |g|= 1.65e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4613064190804  E_coul = 54.26424804391833
  HOMO = -0.785395489458288  LUMO = 2.6243696020407
  mo_energy =
[-3.27124573e+01 -1.89776138e+00 -7.85395489e-01 -7.85395489e-01
 -7.85395489e-01  2.62436960e+00  2.62436960e+00  2.62436960e+00
  2.66333100e+00  1.98256407e+01  1.98256407e+01  1.98256407e+01
  4.39173328e+01  3.19379786e+02  1.98472363e+03  7.27381217e+03]
E1 = -182.46130611230004  E_coul = 54.26424773713754
Extra cycle  E= -128.197058375162  delta_E= -4.55e-13  |g|= 3.11e-07  |ddm|= 9.53e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30788730108605
E1 = -182.46130611230004  E_coul = 54.26424773713754
init E= -128.197058375162
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785395493496463  LUMO = 2.62436959667529
  mo_energy =
[-3.27124574e+01 -1.89776146e+00 -7.85395493e-01 -7.85395493e-01
 -7.85395493e-01  2.62436960e+00  2.62436960e+00  2.62436960e+00
  2.66333093e+00  1.98256406e+01  1.98256406e+01  1.98256406e+01
  4.39173327e+01  3.19379786e+02  1.98472363e+03  7.27381217e+03]
E1 = -182.4613062474542  E_coul = 54.26424787229167
cycle= 1 E= -128.197058375163  delta_E= -2.84e-14  |g|= 5.73e-08  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4613062474542  E_coul = 54.26424787229167
  HOMO = -0.785395481048847  LUMO = 2.62436960765185
  mo_energy =
[-3.27124573e+01 -1.89776146e+00 -7.85395481e-01 -7.85395481e-01
 -7.85395481e-01  2.62436961e+00  2.62436961e+00  2.62436961e+00
  2.66333093e+00  1.98256407e+01  1.98256407e+01  1.98256407e+01
  4.39173328e+01  3.19379786e+02  1.98472363e+03  7.27381217e+03]
E1 = -182.4613061968005  E_coul = 54.26424782163805
Extra cycle  E= -128.197058375162  delta_E= 8.53e-14  |g|= 1.28e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419171e+03 2.15466070e+02 1.42946001e+03 5.67199662e-01
 4.84393229e+01 1.30597261e+01 1.89812457e+00 2.77762453e+00
 1.33319109e+01 6.00615367e-01]
grad_E = [-7.47800601e-06 -3.18197287e-04  4.60012434e-05 -2.28701253e-05
  4.82703540e-04  3.23833026e-04 -5.11390034e-04 -6.64093560e-05
  1.95211911e-06  4.66538724e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19171685        1
[INPUT] 0    0    [1    /1   ]  215.466564394        1
[INPUT] 0    0    [1    /1   ]  1429.45994014        1
[INPUT] 0    0    [1    /1   ]  0.567383163962       1
[INPUT] 0    0    [1    /1   ]  48.4383035601        1
[INPUT] 0    0    [1    /1   ]  13.0604322802        1
[INPUT] 0    0    [1    /1   ]  1.89830516718        1
[INPUT] 1    0    [1    /1   ]  2.77760882113        1
[INPUT] 1    0    [1    /1   ]  13.3319122812        1
[INPUT] 1    0    [1    /1   ]  0.600582084627       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917168471005, 1.0]], [0, [215.466564394226, 1.0]], [0, [1429.4599401354742, 1.0]], [0, [0.5673831639619095, 1.0]], [0, [48.43830356010718, 1.0]], [0, [13.060432280212956, 1.0]], [0, [1.8983051671797844, 1.0]], [1, [2.7776088211280077, 1.0]], [1, [13.331912281244598, 1.0]], [1, [0.6005820846265666, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19171685]
bas 1, expnt(s) = [215.46656439]
bas 2, expnt(s) = [1429.45994014]
bas 3, expnt(s) = [0.56738316]
bas 4, expnt(s) = [48.43830356]
bas 5, expnt(s) = [13.06043228]
bas 6, expnt(s) = [1.89830517]
bas 7, expnt(s) = [2.77760882]
bas 8, expnt(s) = [13.33191228]
bas 9, expnt(s) = [0.60058208]
CPU time:        18.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419172e+03 7.96091038e+02 2.15466564e+02 1.42085559e+02
 1.42945994e+03 5.87346001e+02 5.67383164e-01 1.65166649e+00
 4.84383036e+01 4.63881142e+01 1.30604323e+01 1.73573407e+01
 1.89830517e+00 4.08591706e+00 2.77760882e+00 1.04610011e+01
 1.33319123e+01 7.43190162e+01 6.00582085e-01 1.54241009e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965778148279178
cond(S) = 156.31058313346324
E1 = -183.13569680041073  E_coul = 55.01124806852144
init E= -128.124448731889
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742886500210181  LUMO = 2.65801596178163
  mo_energy =
[-3.25128316e+01 -1.85393268e+00 -7.42886500e-01 -7.42886500e-01
 -7.42886500e-01  2.65801596e+00  2.65801596e+00  2.65801596e+00
  2.69716703e+00  1.99607562e+01  1.99607562e+01  1.99607562e+01
  4.40887961e+01  3.19609437e+02  1.98499800e+03  7.27411044e+03]
E1 = -182.12938031551587  E_coul = 53.934262972020996
cycle= 1 E= -128.195117343495  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262007
diis-c [-0.06864752  1.        ]
  HOMO = -0.807984447596109  LUMO = 2.60375563735054
  mo_energy =
[-3.27866929e+01 -1.92113646e+00 -8.07984448e-01 -8.07984448e-01
 -8.07984448e-01  2.60375564e+00  2.60375564e+00  2.60375564e+00
  2.64461143e+00  1.97697479e+01  1.97697479e+01  1.97697479e+01
  4.38547868e+01  3.19299946e+02  1.98463794e+03  7.27372498e+03]
E1 = -182.59245580341957  E_coul = 54.3957028049827
cycle= 2 E= -128.196752998437  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102012
diis-c [-4.53840098e-04  2.76426563e-01  7.23573437e-01]
  HOMO = -0.785138626135537  LUMO = 2.62444751696788
  mo_energy =
[-3.27117061e+01 -1.89744077e+00 -7.85138626e-01 -7.85138626e-01
 -7.85138626e-01  2.62444752e+00  2.62444752e+00  2.62444752e+00
  2.66447361e+00  1.98260775e+01  1.98260775e+01  1.98260775e+01
  4.39207379e+01  3.19381723e+02  1.98472534e+03  7.27381388e+03]
E1 = -182.45977584066517  E_coul = 54.26271702095074
cycle= 3 E= -128.197058819714  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105914
diis-c [-6.49713667e-08 -3.56100306e-03  9.95162870e-04  1.00256584e+00]
  HOMO = -0.785412553063029  LUMO = 2.6242339673808
  mo_energy =
[-3.27125025e+01 -1.89777887e+00 -7.85412553e-01 -7.85412553e-01
 -7.85412553e-01  2.62423397e+00  2.62423397e+00  2.62423397e+00
  2.66421042e+00  1.98254588e+01  1.98254588e+01  1.98254588e+01
  4.39200005e+01  3.19381066e+02  1.98472480e+03  7.27381338e+03]
E1 = -182.4612910870265  E_coul = 54.264232224027346
cycle= 4 E= -128.197058862999  delta_E= -4.33e-08  |g|= 4.6e-05  |ddm|= 0.000279
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.35455e-05
diis-c [-2.12903679e-10  4.55447246e-04 -1.17145133e-03 -1.62769495e-01
  1.16348550e+00]
  HOMO = -0.785399247962559  LUMO = 2.62424553944019
  mo_energy =
[-3.27124683e+01 -1.89777623e+00 -7.85399248e-01 -7.85399248e-01
 -7.85399248e-01  2.62424554e+00  2.62424554e+00  2.62424554e+00
  2.66421195e+00  1.98254853e+01  1.98254853e+01  1.98254853e+01
  4.39200281e+01  3.19381113e+02  1.98472486e+03  7.27381345e+03]
E1 = -182.461233951973  E_coul = 54.26417508873227
cycle= 5 E= -128.197058863241  delta_E= -2.42e-10  |g|= 1.64e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.461233951973  E_coul = 54.26417508873227
  HOMO = -0.785399121378027  LUMO = 2.62424565999474
  mo_energy =
[-3.27124680e+01 -1.89777651e+00 -7.85399121e-01 -7.85399121e-01
 -7.85399121e-01  2.62424566e+00  2.62424566e+00  2.62424566e+00
  2.66421170e+00  1.98254855e+01  1.98254855e+01  1.98254855e+01
  4.39200282e+01  3.19381113e+02  1.98472486e+03  7.27381345e+03]
E1 = -182.46123366910723  E_coul = 54.26417480586624
Extra cycle  E= -128.197058863241  delta_E= -2.56e-13  |g|= 3.1e-07  |ddm|= 9.51e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419172e+03 2.15466564e+02 1.42945994e+03 5.67383164e-01
 4.84383036e+01 1.30604323e+01 1.89830517e+00 2.77760882e+00
 1.33319123e+01 6.00582085e-01]
E = -128.19705886324098
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19171685        1
[INPUT] 0    0    [1    /1   ]  215.466564394        1
[INPUT] 0    0    [1    /1   ]  1429.45994014        1
[INPUT] 0    0    [1    /1   ]  0.567383163962       1
[INPUT] 0    0    [1    /1   ]  48.4383035601        1
[INPUT] 0    0    [1    /1   ]  13.0604322802        1
[INPUT] 0    0    [1    /1   ]  1.89830516718        1
[INPUT] 1    0    [1    /1   ]  2.77760882113        1
[INPUT] 1    0    [1    /1   ]  13.3319122812        1
[INPUT] 1    0    [1    /1   ]  0.600582084627       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917168471005, 1.0]], [0, [215.466564394226, 1.0]], [0, [1429.4599401354742, 1.0]], [0, [0.5673831639619095, 1.0]], [0, [48.43830356010718, 1.0]], [0, [13.060432280212956, 1.0]], [0, [1.8983051671797844, 1.0]], [1, [2.7776088211280077, 1.0]], [1, [13.331912281244598, 1.0]], [1, [0.6005820846265666, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19171685]
bas 1, expnt(s) = [215.46656439]
bas 2, expnt(s) = [1429.45994014]
bas 3, expnt(s) = [0.56738316]
bas 4, expnt(s) = [48.43830356]
bas 5, expnt(s) = [13.06043228]
bas 6, expnt(s) = [1.89830517]
bas 7, expnt(s) = [2.77760882]
bas 8, expnt(s) = [13.33191228]
bas 9, expnt(s) = [0.60058208]
CPU time:        19.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419172e+03 7.96091038e+02 2.15466564e+02 1.42085559e+02
 1.42945994e+03 5.87346001e+02 5.67383164e-01 1.65166649e+00
 4.84383036e+01 4.63881142e+01 1.30604323e+01 1.73573407e+01
 1.89830517e+00 4.08591706e+00 2.77760882e+00 1.04610011e+01
 1.33319123e+01 7.43190162e+01 6.00582085e-01 1.54241009e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965778148279178
cond(S) = 156.31058313346324
E1 = -183.13569680041073  E_coul = 55.01124806852144
init E= -128.124448731889
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742886500210181  LUMO = 2.65801596178163
  mo_energy =
[-3.25128316e+01 -1.85393268e+00 -7.42886500e-01 -7.42886500e-01
 -7.42886500e-01  2.65801596e+00  2.65801596e+00  2.65801596e+00
  2.69716703e+00  1.99607562e+01  1.99607562e+01  1.99607562e+01
  4.40887961e+01  3.19609437e+02  1.98499800e+03  7.27411044e+03]
E1 = -182.12938031551587  E_coul = 53.934262972020996
cycle= 1 E= -128.195117343495  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262007
diis-c [-0.06864752  1.        ]
  HOMO = -0.807984447596109  LUMO = 2.60375563735054
  mo_energy =
[-3.27866929e+01 -1.92113646e+00 -8.07984448e-01 -8.07984448e-01
 -8.07984448e-01  2.60375564e+00  2.60375564e+00  2.60375564e+00
  2.64461143e+00  1.97697479e+01  1.97697479e+01  1.97697479e+01
  4.38547868e+01  3.19299946e+02  1.98463794e+03  7.27372498e+03]
E1 = -182.59245580341957  E_coul = 54.3957028049827
cycle= 2 E= -128.196752998437  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102012
diis-c [-4.53840098e-04  2.76426563e-01  7.23573437e-01]
  HOMO = -0.785138626135537  LUMO = 2.62444751696788
  mo_energy =
[-3.27117061e+01 -1.89744077e+00 -7.85138626e-01 -7.85138626e-01
 -7.85138626e-01  2.62444752e+00  2.62444752e+00  2.62444752e+00
  2.66447361e+00  1.98260775e+01  1.98260775e+01  1.98260775e+01
  4.39207379e+01  3.19381723e+02  1.98472534e+03  7.27381388e+03]
E1 = -182.45977584066517  E_coul = 54.26271702095074
cycle= 3 E= -128.197058819714  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105914
diis-c [-6.49713667e-08 -3.56100306e-03  9.95162870e-04  1.00256584e+00]
  HOMO = -0.785412553063029  LUMO = 2.6242339673808
  mo_energy =
[-3.27125025e+01 -1.89777887e+00 -7.85412553e-01 -7.85412553e-01
 -7.85412553e-01  2.62423397e+00  2.62423397e+00  2.62423397e+00
  2.66421042e+00  1.98254588e+01  1.98254588e+01  1.98254588e+01
  4.39200005e+01  3.19381066e+02  1.98472480e+03  7.27381338e+03]
E1 = -182.4612910870265  E_coul = 54.264232224027346
cycle= 4 E= -128.197058862999  delta_E= -4.33e-08  |g|= 4.6e-05  |ddm|= 0.000279
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.35455e-05
diis-c [-2.12903679e-10  4.55447246e-04 -1.17145133e-03 -1.62769495e-01
  1.16348550e+00]
  HOMO = -0.785399247962559  LUMO = 2.62424553944019
  mo_energy =
[-3.27124683e+01 -1.89777623e+00 -7.85399248e-01 -7.85399248e-01
 -7.85399248e-01  2.62424554e+00  2.62424554e+00  2.62424554e+00
  2.66421195e+00  1.98254853e+01  1.98254853e+01  1.98254853e+01
  4.39200281e+01  3.19381113e+02  1.98472486e+03  7.27381345e+03]
E1 = -182.461233951973  E_coul = 54.26417508873227
cycle= 5 E= -128.197058863241  delta_E= -2.42e-10  |g|= 1.64e-06  |ddm|= 2.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.461233951973  E_coul = 54.26417508873227
  HOMO = -0.785399121378027  LUMO = 2.62424565999474
  mo_energy =
[-3.27124680e+01 -1.89777651e+00 -7.85399121e-01 -7.85399121e-01
 -7.85399121e-01  2.62424566e+00  2.62424566e+00  2.62424566e+00
  2.66421170e+00  1.98254855e+01  1.98254855e+01  1.98254855e+01
  4.39200282e+01  3.19381113e+02  1.98472486e+03  7.27381345e+03]
E1 = -182.46123366910723  E_coul = 54.26417480586624
Extra cycle  E= -128.197058863241  delta_E= -2.56e-13  |g|= 3.1e-07  |ddm|= 9.51e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.31058313346324
E1 = -182.46123366910723  E_coul = 54.26417480586624
init E= -128.197058863241
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785399123850636  LUMO = 2.62424565604943
  mo_energy =
[-3.27124681e+01 -1.89777659e+00 -7.85399124e-01 -7.85399124e-01
 -7.85399124e-01  2.62424566e+00  2.62424566e+00  2.62424566e+00
  2.66421163e+00  1.98254854e+01  1.98254854e+01  1.98254854e+01
  4.39200282e+01  3.19381113e+02  1.98472486e+03  7.27381345e+03]
E1 = -182.46123379460218  E_coul = 54.2641749313614
cycle= 1 E= -128.197058863241  delta_E= 1.99e-13  |g|= 5.69e-08  |ddm|= 1.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46123379460218  E_coul = 54.2641749313614
  HOMO = -0.785399112075219  LUMO = 2.62424566641802
  mo_energy =
[-3.27124680e+01 -1.89777659e+00 -7.85399112e-01 -7.85399112e-01
 -7.85399112e-01  2.62424567e+00  2.62424567e+00  2.62424567e+00
  2.66421163e+00  1.98254854e+01  1.98254854e+01  1.98254854e+01
  4.39200282e+01  3.19381113e+02  1.98472486e+03  7.27381345e+03]
E1 = -182.46123374775968  E_coul = 54.26417488451877
Extra cycle  E= -128.197058863241  delta_E= -1.14e-13  |g|= 1.25e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419172e+03 2.15466564e+02 1.42945994e+03 5.67383164e-01
 4.84383036e+01 1.30604323e+01 1.89830517e+00 2.77760882e+00
 1.33319123e+01 6.00582085e-01]
grad_E = [-7.47970369e-06 -3.17255019e-04  4.59918205e-05  2.83974798e-04
  4.70945260e-04  3.61641390e-04 -5.81309006e-04  1.32048534e-06
 -1.21104907e-07  1.06502681e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19179781        1
[INPUT] 0    0    [1    /1   ]  215.470139186        1
[INPUT] 0    0    [1    /1   ]  1429.45943967        1
[INPUT] 0    0    [1    /1   ]  0.568483917406       1
[INPUT] 0    0    [1    /1   ]  48.4313629253        1
[INPUT] 0    0    [1    /1   ]  13.0636182071        1
[INPUT] 0    0    [1    /1   ]  1.9005448323         1
[INPUT] 1    0    [1    /1   ]  2.77745967859        1
[INPUT] 1    0    [1    /1   ]  13.3319234138        1
[INPUT] 1    0    [1    /1   ]  0.600402300046       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917978117112, 1.0]], [0, [215.47013918585677, 1.0]], [0, [1429.459439670879, 1.0]], [0, [0.5684839174062531, 1.0]], [0, [48.43136292529555, 1.0]], [0, [13.063618207106158, 1.0]], [0, [1.9005448323029728, 1.0]], [1, [2.777459678587779, 1.0]], [1, [13.331923413762727, 1.0]], [1, [0.6004023000461529, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19179781]
bas 1, expnt(s) = [215.47013919]
bas 2, expnt(s) = [1429.45943967]
bas 3, expnt(s) = [0.56848392]
bas 4, expnt(s) = [48.43136293]
bas 5, expnt(s) = [13.06361821]
bas 6, expnt(s) = [1.90054483]
bas 7, expnt(s) = [2.77745968]
bas 8, expnt(s) = [13.33192341]
bas 9, expnt(s) = [0.6004023]
CPU time:        21.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419180e+03 7.96091060e+02 2.15470139e+02 1.42087327e+02
 1.42945944e+03 5.87345847e+02 5.68483917e-01 1.65406915e+00
 4.84313629e+01 4.63831290e+01 1.30636182e+01 1.73605162e+01
 1.90054483e+00 4.08953202e+00 2.77745968e+00 1.04602989e+01
 1.33319234e+01 7.43190938e+01 6.00402300e-01 1.54183296e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965793765221546
cond(S) = 156.32923230116398
E1 = -183.13555129307073  E_coul = 55.011059855502786
init E= -128.124491437568
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742899863874775  LUMO = 2.65731545181696
  mo_energy =
[-3.25129004e+01 -1.85392036e+00 -7.42899864e-01 -7.42899864e-01
 -7.42899864e-01  2.65731545e+00  2.65731545e+00  2.65731545e+00
  2.70393983e+00  1.99597443e+01  1.99597443e+01  1.99597443e+01
  4.41069266e+01  3.19615589e+02  1.98500404e+03  7.27411699e+03]
E1 = -182.1287953078193  E_coul = 53.93367628063255
cycle= 1 E= -128.195119027187  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262016
diis-c [-0.06865253  1.        ]
  HOMO = -0.808021963131021  LUMO = 2.60303812995071
  mo_energy =
[-3.27867986e+01 -1.92121340e+00 -8.08021963e-01 -8.08021963e-01
 -8.08021963e-01  2.60303813e+00  2.60303813e+00  2.60303813e+00
  2.65119547e+00  1.97686830e+01  1.97686830e+01  1.97686830e+01
  4.38728753e+01  3.19306113e+02  1.98464399e+03  7.27373156e+03]
E1 = -182.59205019972833  E_coul = 54.39529431460163
cycle= 2 E= -128.196755885127  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102066
diis-c [-4.54861360e-04  2.76520511e-01  7.23479489e-01]
  HOMO = -0.785170630360297  LUMO = 2.62373333131008
  mo_energy =
[-3.27117907e+01 -1.89751238e+00 -7.85170630e-01 -7.85170630e-01
 -7.85170630e-01  2.62373333e+00  2.62373333e+00  2.62373333e+00
  2.67109301e+00  1.98250289e+01  1.98250289e+01  1.98250289e+01
  4.39388439e+01  3.19387916e+02  1.98473143e+03  7.27382050e+03]
E1 = -182.4593215562325  E_coul = 54.26225956064875
cycle= 3 E= -128.197061995584  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104867
diis-c [-7.07337480e-08 -3.60385015e-03  7.44609054e-04  1.00285924e+00]
  HOMO = -0.785442110649193  LUMO = 2.62352196361657
  mo_energy =
[-3.27125810e+01 -1.89785133e+00 -7.85442111e-01 -7.85442111e-01
 -7.85442111e-01  2.62352196e+00  2.62352196e+00  2.62352196e+00
  2.67082861e+00  1.98244147e+01  1.98244147e+01  1.98244147e+01
  4.39381112e+01  3.19387268e+02  1.98473090e+03  7.27382001e+03]
E1 = -182.4608271675109  E_coul = 54.26376512856056
cycle= 4 E= -128.19706203895  delta_E= -4.34e-08  |g|= 4.84e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.71659e-05
diis-c [-2.19666806e-10  4.67359088e-04 -1.18582803e-03 -1.66227366e-01
  1.16694583e+00]
  HOMO = -0.785428189515683  LUMO = 2.62353407007936
  mo_energy =
[-3.27125452e+01 -1.89784873e+00 -7.85428190e-01 -7.85428190e-01
 -7.85428190e-01  2.62353407e+00  2.62353407e+00  2.62353407e+00
  2.67083007e+00  1.98244424e+01  1.98244424e+01  1.98244424e+01
  4.39381400e+01  3.19387317e+02  1.98473097e+03  7.27382008e+03]
E1 = -182.4607674332653  E_coul = 54.26370539404651
cycle= 5 E= -128.197062039219  delta_E= -2.68e-10  |g|= 1.62e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4607674332653  E_coul = 54.26370539404651
  HOMO = -0.785428084785657  LUMO = 2.62353417152746
  mo_energy =
[-3.27125450e+01 -1.89784903e+00 -7.85428085e-01 -7.85428085e-01
 -7.85428085e-01  2.62353417e+00  2.62353417e+00  2.62353417e+00
  2.67082981e+00  1.98244425e+01  1.98244425e+01  1.98244425e+01
  4.39381400e+01  3.19387317e+02  1.98473097e+03  7.27382008e+03]
E1 = -182.46076725609828  E_coul = 54.26370521687922
Extra cycle  E= -128.197062039219  delta_E= -2.84e-13  |g|= 3.02e-07  |ddm|= 9.41e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419180e+03 2.15470139e+02 1.42945944e+03 5.68483917e-01
 4.84313629e+01 1.30636182e+01 1.90054483e+00 2.77745968e+00
 1.33319234e+01 6.00402300e-01]
E = -128.19706203921908
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19179781        1
[INPUT] 0    0    [1    /1   ]  215.470139186        1
[INPUT] 0    0    [1    /1   ]  1429.45943967        1
[INPUT] 0    0    [1    /1   ]  0.568483917406       1
[INPUT] 0    0    [1    /1   ]  48.4313629253        1
[INPUT] 0    0    [1    /1   ]  13.0636182071        1
[INPUT] 0    0    [1    /1   ]  1.9005448323         1
[INPUT] 1    0    [1    /1   ]  2.77745967859        1
[INPUT] 1    0    [1    /1   ]  13.3319234138        1
[INPUT] 1    0    [1    /1   ]  0.600402300046       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917978117112, 1.0]], [0, [215.47013918585677, 1.0]], [0, [1429.459439670879, 1.0]], [0, [0.5684839174062531, 1.0]], [0, [48.43136292529555, 1.0]], [0, [13.063618207106158, 1.0]], [0, [1.9005448323029728, 1.0]], [1, [2.777459678587779, 1.0]], [1, [13.331923413762727, 1.0]], [1, [0.6004023000461529, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19179781]
bas 1, expnt(s) = [215.47013919]
bas 2, expnt(s) = [1429.45943967]
bas 3, expnt(s) = [0.56848392]
bas 4, expnt(s) = [48.43136293]
bas 5, expnt(s) = [13.06361821]
bas 6, expnt(s) = [1.90054483]
bas 7, expnt(s) = [2.77745968]
bas 8, expnt(s) = [13.33192341]
bas 9, expnt(s) = [0.6004023]
CPU time:        21.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419180e+03 7.96091060e+02 2.15470139e+02 1.42087327e+02
 1.42945944e+03 5.87345847e+02 5.68483917e-01 1.65406915e+00
 4.84313629e+01 4.63831290e+01 1.30636182e+01 1.73605162e+01
 1.90054483e+00 4.08953202e+00 2.77745968e+00 1.04602989e+01
 1.33319234e+01 7.43190938e+01 6.00402300e-01 1.54183296e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965793765221546
cond(S) = 156.32923230116398
E1 = -183.13555129307073  E_coul = 55.011059855502786
init E= -128.124491437568
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742899863874775  LUMO = 2.65731545181696
  mo_energy =
[-3.25129004e+01 -1.85392036e+00 -7.42899864e-01 -7.42899864e-01
 -7.42899864e-01  2.65731545e+00  2.65731545e+00  2.65731545e+00
  2.70393983e+00  1.99597443e+01  1.99597443e+01  1.99597443e+01
  4.41069266e+01  3.19615589e+02  1.98500404e+03  7.27411699e+03]
E1 = -182.1287953078193  E_coul = 53.93367628063255
cycle= 1 E= -128.195119027187  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262016
diis-c [-0.06865253  1.        ]
  HOMO = -0.808021963131021  LUMO = 2.60303812995071
  mo_energy =
[-3.27867986e+01 -1.92121340e+00 -8.08021963e-01 -8.08021963e-01
 -8.08021963e-01  2.60303813e+00  2.60303813e+00  2.60303813e+00
  2.65119547e+00  1.97686830e+01  1.97686830e+01  1.97686830e+01
  4.38728753e+01  3.19306113e+02  1.98464399e+03  7.27373156e+03]
E1 = -182.59205019972833  E_coul = 54.39529431460163
cycle= 2 E= -128.196755885127  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102066
diis-c [-4.54861360e-04  2.76520511e-01  7.23479489e-01]
  HOMO = -0.785170630360297  LUMO = 2.62373333131008
  mo_energy =
[-3.27117907e+01 -1.89751238e+00 -7.85170630e-01 -7.85170630e-01
 -7.85170630e-01  2.62373333e+00  2.62373333e+00  2.62373333e+00
  2.67109301e+00  1.98250289e+01  1.98250289e+01  1.98250289e+01
  4.39388439e+01  3.19387916e+02  1.98473143e+03  7.27382050e+03]
E1 = -182.4593215562325  E_coul = 54.26225956064875
cycle= 3 E= -128.197061995584  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104867
diis-c [-7.07337480e-08 -3.60385015e-03  7.44609054e-04  1.00285924e+00]
  HOMO = -0.785442110649193  LUMO = 2.62352196361657
  mo_energy =
[-3.27125810e+01 -1.89785133e+00 -7.85442111e-01 -7.85442111e-01
 -7.85442111e-01  2.62352196e+00  2.62352196e+00  2.62352196e+00
  2.67082861e+00  1.98244147e+01  1.98244147e+01  1.98244147e+01
  4.39381112e+01  3.19387268e+02  1.98473090e+03  7.27382001e+03]
E1 = -182.4608271675109  E_coul = 54.26376512856056
cycle= 4 E= -128.19706203895  delta_E= -4.34e-08  |g|= 4.84e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.71659e-05
diis-c [-2.19666806e-10  4.67359088e-04 -1.18582803e-03 -1.66227366e-01
  1.16694583e+00]
  HOMO = -0.785428189515683  LUMO = 2.62353407007936
  mo_energy =
[-3.27125452e+01 -1.89784873e+00 -7.85428190e-01 -7.85428190e-01
 -7.85428190e-01  2.62353407e+00  2.62353407e+00  2.62353407e+00
  2.67083007e+00  1.98244424e+01  1.98244424e+01  1.98244424e+01
  4.39381400e+01  3.19387317e+02  1.98473097e+03  7.27382008e+03]
E1 = -182.4607674332653  E_coul = 54.26370539404651
cycle= 5 E= -128.197062039219  delta_E= -2.68e-10  |g|= 1.62e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4607674332653  E_coul = 54.26370539404651
  HOMO = -0.785428084785657  LUMO = 2.62353417152746
  mo_energy =
[-3.27125450e+01 -1.89784903e+00 -7.85428085e-01 -7.85428085e-01
 -7.85428085e-01  2.62353417e+00  2.62353417e+00  2.62353417e+00
  2.67082981e+00  1.98244425e+01  1.98244425e+01  1.98244425e+01
  4.39381400e+01  3.19387317e+02  1.98473097e+03  7.27382008e+03]
E1 = -182.46076725609828  E_coul = 54.26370521687922
Extra cycle  E= -128.197062039219  delta_E= -2.84e-13  |g|= 3.02e-07  |ddm|= 9.41e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.32923230116398
E1 = -182.46076725609828  E_coul = 54.26370521687922
init E= -128.197062039219
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785428080386803  LUMO = 2.62353417381899
  mo_energy =
[-3.27125451e+01 -1.89784910e+00 -7.85428080e-01 -7.85428080e-01
 -7.85428080e-01  2.62353417e+00  2.62353417e+00  2.62353417e+00
  2.67082974e+00  1.98244425e+01  1.98244425e+01  1.98244425e+01
  4.39381400e+01  3.19387317e+02  1.98473097e+03  7.27382008e+03]
E1 = -182.46076733868463  E_coul = 54.263705299465606
cycle= 1 E= -128.197062039219  delta_E= 5.68e-14  |g|= 5.5e-08  |ddm|= 1.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46076733868463  E_coul = 54.263705299465606
  HOMO = -0.785428071606708  LUMO = 2.62353418147912
  mo_energy =
[-3.27125450e+01 -1.89784911e+00 -7.85428072e-01 -7.85428072e-01
 -7.85428072e-01  2.62353418e+00  2.62353418e+00  2.62353418e+00
  2.67082974e+00  1.98244425e+01  1.98244425e+01  1.98244425e+01
  4.39381400e+01  3.19387317e+02  1.98473097e+03  7.27382008e+03]
E1 = -182.4607673087333  E_coul = 54.263705269514176
Extra cycle  E= -128.197062039219  delta_E= -1.14e-13  |g|= 1.11e-08  |ddm|= 2.97e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419180e+03 2.15470139e+02 1.42945944e+03 5.68483917e-01
 4.84313629e+01 1.30636182e+01 1.90054483e+00 2.77745968e+00
 1.33319234e+01 6.00402300e-01]
grad_E = [-7.48939113e-06 -3.12062651e-04  4.59381618e-05  1.56931726e-03
  4.10419306e-04  5.37853833e-04 -7.95289190e-04  3.01766550e-04
 -5.56333515e-06 -1.69006820e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19191759        1
[INPUT] 0    0    [1    /1   ]  215.47537932         1
[INPUT] 0    0    [1    /1   ]  1429.45870017        1
[INPUT] 0    0    [1    /1   ]  0.569867094044       1
[INPUT] 0    0    [1    /1   ]  48.4217266918        1
[INPUT] 0    0    [1    /1   ]  13.0659051459        1
[INPUT] 0    0    [1    /1   ]  1.90490439406        1
[INPUT] 1    0    [1    /1   ]  2.77722767113        1
[INPUT] 1    0    [1    /1   ]  13.3319361262        1
[INPUT] 1    0    [1    /1   ]  0.600246204957       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1919175937905, 1.0]], [0, [215.47537932030392, 1.0]], [0, [1429.4587001736875, 1.0]], [0, [0.5698670940438105, 1.0]], [0, [48.421726691843745, 1.0]], [0, [13.065905145854204, 1.0]], [0, [1.9049043940614656, 1.0]], [1, [2.777227671129119, 1.0]], [1, [13.331936126236101, 1.0]], [1, [0.6002462049569113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19191759]
bas 1, expnt(s) = [215.47537932]
bas 2, expnt(s) = [1429.45870017]
bas 3, expnt(s) = [0.56986709]
bas 4, expnt(s) = [48.42172669]
bas 5, expnt(s) = [13.06590515]
bas 6, expnt(s) = [1.90490439]
bas 7, expnt(s) = [2.77722767]
bas 8, expnt(s) = [13.33193613]
bas 9, expnt(s) = [0.6002462]
CPU time:        23.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419192e+03 7.96091094e+02 2.15475379e+02 1.42089918e+02
 1.42945870e+03 5.87345619e+02 5.69867094e-01 1.65708661e+00
 4.84217267e+01 4.63762073e+01 1.30659051e+01 1.73627955e+01
 1.90490439e+00 4.09656558e+00 2.77722767e+00 1.04592067e+01
 1.33319361e+01 7.43191823e+01 6.00246205e-01 1.54133192e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965800710328809
cond(S) = 156.35571665571723
E1 = -183.13548839004733  E_coul = 55.0109523966591
init E= -128.124535993388
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742908725230086  LUMO = 2.65665479922998
  mo_energy =
[-3.25129667e+01 -1.85388411e+00 -7.42908725e-01 -7.42908725e-01
 -7.42908725e-01  2.65665480e+00  2.65665480e+00  2.65665480e+00
  2.71426256e+00  1.99585628e+01  1.99585628e+01  1.99585628e+01
  4.41316919e+01  3.19620368e+02  1.98500937e+03  7.27412337e+03]
E1 = -182.12840965496525  E_coul = 53.93328755164088
cycle= 1 E= -128.195122103324  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262029
diis-c [-0.06865914  1.        ]
  HOMO = -0.808044840889474  LUMO = 2.60237169974348
  mo_energy =
[-3.27868897e+01 -1.92125044e+00 -8.08044841e-01 -8.08044841e-01
 -8.08044841e-01  2.60237170e+00  2.60237170e+00  2.60237170e+00
  2.66127215e+00  1.97674643e+01  1.97674643e+01  1.97674643e+01
  4.38976063e+01  3.19310895e+02  1.98464932e+03  7.27373793e+03]
E1 = -182.59179420857768  E_coul = 54.39503422098458
cycle= 2 E= -128.196759987593  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10211
diis-c [-4.55674491e-04  2.76593547e-01  7.23406453e-01]
  HOMO = -0.785190527439532  LUMO = 2.62306759481734
  mo_energy =
[-3.27118648e+01 -1.89754556e+00 -7.85190527e-01 -7.85190527e-01
 -7.85190527e-01  2.62306759e+00  2.62306759e+00  2.62306759e+00
  2.68122428e+00  1.98238227e+01  1.98238227e+01  1.98238227e+01
  4.39635871e+01  3.19392719e+02  1.98473678e+03  7.27382690e+03]
E1 = -182.45903190421942  E_coul = 54.26196557749943
cycle= 3 E= -128.19706632672  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104046
diis-c [-7.56766815e-08 -3.64235486e-03  5.32089703e-04  1.00311027e+00]
  HOMO = -0.78546005791218  LUMO = 2.62285797774322
  mo_energy =
[-3.27126500e+01 -1.89788523e+00 -7.85460058e-01 -7.85460058e-01
 -7.85460058e-01  2.62285798e+00  2.62285798e+00  2.62285798e+00
  2.68095851e+00  1.98232123e+01  1.98232123e+01  1.98232123e+01
  4.39628581e+01  3.19392078e+02  1.98473626e+03  7.27382642e+03]
E1 = -182.46052945674546  E_coul = 54.26346308656982
cycle= 4 E= -128.197066370176  delta_E= -4.35e-08  |g|= 5.04e-05  |ddm|= 0.000286
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.0056e-05
diis-c [-2.23909085e-10  4.76059919e-04 -1.19450390e-03 -1.68614873e-01
  1.16933332e+00]
  HOMO = -0.785445656817261  LUMO = 2.62287049940185
  mo_energy =
[-3.27126130e+01 -1.89788267e+00 -7.85445657e-01 -7.85445657e-01
 -7.85445657e-01  2.62287050e+00  2.62287050e+00  2.62287050e+00
  2.68095992e+00  1.98232410e+01  1.98232410e+01  1.98232410e+01
  4.39628879e+01  3.19392129e+02  1.98473633e+03  7.27382649e+03]
E1 = -182.46046763133896  E_coul = 54.26340126087231
cycle= 5 E= -128.197066370467  delta_E= -2.91e-10  |g|= 1.6e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46046763133896  E_coul = 54.26340126087231
  HOMO = -0.785445569032667  LUMO = 2.62287058605437
  mo_energy =
[-3.27126129e+01 -1.89788298e+00 -7.85445569e-01 -7.85445569e-01
 -7.85445569e-01  2.62287059e+00  2.62287059e+00  2.62287059e+00
  2.68095965e+00  1.98232410e+01  1.98232410e+01  1.98232410e+01
  4.39628879e+01  3.19392129e+02  1.98473633e+03  7.27382649e+03]
E1 = -182.46046753314198  E_coul = 54.26340116267498
Extra cycle  E= -128.197066370467  delta_E= -3.41e-13  |g|= 2.96e-07  |ddm|= 9.32e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419192e+03 2.15475379e+02 1.42945870e+03 5.69867094e-01
 4.84217267e+01 1.30659051e+01 1.90490439e+00 2.77722767e+00
 1.33319361e+01 6.00246205e-01]
E = -128.19706637046698
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19191759        1
[INPUT] 0    0    [1    /1   ]  215.47537932         1
[INPUT] 0    0    [1    /1   ]  1429.45870017        1
[INPUT] 0    0    [1    /1   ]  0.569867094044       1
[INPUT] 0    0    [1    /1   ]  48.4217266918        1
[INPUT] 0    0    [1    /1   ]  13.0659051459        1
[INPUT] 0    0    [1    /1   ]  1.90490439406        1
[INPUT] 1    0    [1    /1   ]  2.77722767113        1
[INPUT] 1    0    [1    /1   ]  13.3319361262        1
[INPUT] 1    0    [1    /1   ]  0.600246204957       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1919175937905, 1.0]], [0, [215.47537932030392, 1.0]], [0, [1429.4587001736875, 1.0]], [0, [0.5698670940438105, 1.0]], [0, [48.421726691843745, 1.0]], [0, [13.065905145854204, 1.0]], [0, [1.9049043940614656, 1.0]], [1, [2.777227671129119, 1.0]], [1, [13.331936126236101, 1.0]], [1, [0.6002462049569113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19191759]
bas 1, expnt(s) = [215.47537932]
bas 2, expnt(s) = [1429.45870017]
bas 3, expnt(s) = [0.56986709]
bas 4, expnt(s) = [48.42172669]
bas 5, expnt(s) = [13.06590515]
bas 6, expnt(s) = [1.90490439]
bas 7, expnt(s) = [2.77722767]
bas 8, expnt(s) = [13.33193613]
bas 9, expnt(s) = [0.6002462]
CPU time:        23.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419192e+03 7.96091094e+02 2.15475379e+02 1.42089918e+02
 1.42945870e+03 5.87345619e+02 5.69867094e-01 1.65708661e+00
 4.84217267e+01 4.63762073e+01 1.30659051e+01 1.73627955e+01
 1.90490439e+00 4.09656558e+00 2.77722767e+00 1.04592067e+01
 1.33319361e+01 7.43191823e+01 6.00246205e-01 1.54133192e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965800710328809
cond(S) = 156.35571665571723
E1 = -183.13548839004733  E_coul = 55.0109523966591
init E= -128.124535993388
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742908725230086  LUMO = 2.65665479922998
  mo_energy =
[-3.25129667e+01 -1.85388411e+00 -7.42908725e-01 -7.42908725e-01
 -7.42908725e-01  2.65665480e+00  2.65665480e+00  2.65665480e+00
  2.71426256e+00  1.99585628e+01  1.99585628e+01  1.99585628e+01
  4.41316919e+01  3.19620368e+02  1.98500937e+03  7.27412337e+03]
E1 = -182.12840965496525  E_coul = 53.93328755164088
cycle= 1 E= -128.195122103324  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262029
diis-c [-0.06865914  1.        ]
  HOMO = -0.808044840889474  LUMO = 2.60237169974348
  mo_energy =
[-3.27868897e+01 -1.92125044e+00 -8.08044841e-01 -8.08044841e-01
 -8.08044841e-01  2.60237170e+00  2.60237170e+00  2.60237170e+00
  2.66127215e+00  1.97674643e+01  1.97674643e+01  1.97674643e+01
  4.38976063e+01  3.19310895e+02  1.98464932e+03  7.27373793e+03]
E1 = -182.59179420857768  E_coul = 54.39503422098458
cycle= 2 E= -128.196759987593  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10211
diis-c [-4.55674491e-04  2.76593547e-01  7.23406453e-01]
  HOMO = -0.785190527439532  LUMO = 2.62306759481734
  mo_energy =
[-3.27118648e+01 -1.89754556e+00 -7.85190527e-01 -7.85190527e-01
 -7.85190527e-01  2.62306759e+00  2.62306759e+00  2.62306759e+00
  2.68122428e+00  1.98238227e+01  1.98238227e+01  1.98238227e+01
  4.39635871e+01  3.19392719e+02  1.98473678e+03  7.27382690e+03]
E1 = -182.45903190421942  E_coul = 54.26196557749943
cycle= 3 E= -128.19706632672  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104046
diis-c [-7.56766815e-08 -3.64235486e-03  5.32089703e-04  1.00311027e+00]
  HOMO = -0.78546005791218  LUMO = 2.62285797774322
  mo_energy =
[-3.27126500e+01 -1.89788523e+00 -7.85460058e-01 -7.85460058e-01
 -7.85460058e-01  2.62285798e+00  2.62285798e+00  2.62285798e+00
  2.68095851e+00  1.98232123e+01  1.98232123e+01  1.98232123e+01
  4.39628581e+01  3.19392078e+02  1.98473626e+03  7.27382642e+03]
E1 = -182.46052945674546  E_coul = 54.26346308656982
cycle= 4 E= -128.197066370176  delta_E= -4.35e-08  |g|= 5.04e-05  |ddm|= 0.000286
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.0056e-05
diis-c [-2.23909085e-10  4.76059919e-04 -1.19450390e-03 -1.68614873e-01
  1.16933332e+00]
  HOMO = -0.785445656817261  LUMO = 2.62287049940185
  mo_energy =
[-3.27126130e+01 -1.89788267e+00 -7.85445657e-01 -7.85445657e-01
 -7.85445657e-01  2.62287050e+00  2.62287050e+00  2.62287050e+00
  2.68095992e+00  1.98232410e+01  1.98232410e+01  1.98232410e+01
  4.39628879e+01  3.19392129e+02  1.98473633e+03  7.27382649e+03]
E1 = -182.46046763133896  E_coul = 54.26340126087231
cycle= 5 E= -128.197066370467  delta_E= -2.91e-10  |g|= 1.6e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46046763133896  E_coul = 54.26340126087231
  HOMO = -0.785445569032667  LUMO = 2.62287058605437
  mo_energy =
[-3.27126129e+01 -1.89788298e+00 -7.85445569e-01 -7.85445569e-01
 -7.85445569e-01  2.62287059e+00  2.62287059e+00  2.62287059e+00
  2.68095965e+00  1.98232410e+01  1.98232410e+01  1.98232410e+01
  4.39628879e+01  3.19392129e+02  1.98473633e+03  7.27382649e+03]
E1 = -182.46046753314198  E_coul = 54.26340116267498
Extra cycle  E= -128.197066370467  delta_E= -3.41e-13  |g|= 2.96e-07  |ddm|= 9.32e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.35571665571723
E1 = -182.46046753314198  E_coul = 54.26340116267498
init E= -128.197066370467
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785445559558318  LUMO = 2.62287059295683
  mo_energy =
[-3.27126129e+01 -1.89788304e+00 -7.85445560e-01 -7.85445560e-01
 -7.85445560e-01  2.62287059e+00  2.62287059e+00  2.62287059e+00
  2.68095959e+00  1.98232410e+01  1.98232410e+01  1.98232410e+01
  4.39628879e+01  3.19392129e+02  1.98473633e+03  7.27382649e+03]
E1 = -182.4604675833024  E_coul = 54.263401212835454
cycle= 1 E= -128.197066370467  delta_E= 2.84e-14  |g|= 5.39e-08  |ddm|= 1.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4604675833024  E_coul = 54.263401212835454
  HOMO = -0.785445553053086  LUMO = 2.62287059856094
  mo_energy =
[-3.27126129e+01 -1.89788305e+00 -7.85445553e-01 -7.85445553e-01
 -7.85445553e-01  2.62287060e+00  2.62287060e+00  2.62287060e+00
  2.68095958e+00  1.98232410e+01  1.98232410e+01  1.98232410e+01
  4.39628879e+01  3.19392129e+02  1.98473633e+03  7.27382649e+03]
E1 = -182.46046756605273  E_coul = 54.26340119558567
Extra cycle  E= -128.197066370467  delta_E= -8.53e-14  |g|= 1.03e-08  |ddm|= 2.97e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419192e+03 2.15475379e+02 1.42945870e+03 5.69867094e-01
 4.84217267e+01 1.30659051e+01 1.90490439e+00 2.77722767e+00
 1.33319361e+01 6.00246205e-01]
grad_E = [-7.50035933e-06 -3.06470688e-04  4.58775411e-05  2.46834952e-03
  3.52261855e-04  6.73666333e-04 -7.91118485e-04  4.58645720e-04
 -1.10686607e-06 -3.01442675e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19213658        1
[INPUT] 0    0    [1    /1   ]  215.484885906        1
[INPUT] 0    0    [1    /1   ]  1429.45734962        1
[INPUT] 0    0    [1    /1   ]  0.57201311739        1
[INPUT] 0    0    [1    /1   ]  48.4050369981        1
[INPUT] 0    0    [1    /1   ]  13.0666488738        1
[INPUT] 0    0    [1    /1   ]  1.91396799613        1
[INPUT] 1    0    [1    /1   ]  2.77695526766        1
[INPUT] 1    0    [1    /1   ]  13.3319311513        1
[INPUT] 1    0    [1    /1   ]  0.60015861389        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192136580433, 1.0]], [0, [215.4848859061674, 1.0]], [0, [1429.4573496160162, 1.0]], [0, [0.572013117390296, 1.0]], [0, [48.40503699813678, 1.0]], [0, [13.066648873833268, 1.0]], [0, [1.9139679961252287, 1.0]], [1, [2.776955267664737, 1.0]], [1, [13.331931151293379, 1.0]], [1, [0.6001586138899041, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19213658]
bas 1, expnt(s) = [215.48488591]
bas 2, expnt(s) = [1429.45734962]
bas 3, expnt(s) = [0.57201312]
bas 4, expnt(s) = [48.405037]
bas 5, expnt(s) = [13.06664887]
bas 6, expnt(s) = [1.913968]
bas 7, expnt(s) = [2.77695527]
bas 8, expnt(s) = [13.33193115]
bas 9, expnt(s) = [0.60015861]
CPU time:        25.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419214e+03 7.96091155e+02 2.15484886e+02 1.42094620e+02
 1.42945735e+03 5.87345202e+02 5.72013117e-01 1.66176465e+00
 4.84050370e+01 4.63642183e+01 1.30666489e+01 1.73635367e+01
 1.91396800e+00 4.11117561e+00 2.77695527e+00 1.04579244e+01
 1.33319312e+01 7.43191477e+01 6.00158614e-01 1.54105077e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965783271274821
cond(S) = 156.40100171418038
E1 = -183.13558090654507  E_coul = 55.01098866898192
init E= -128.124592237563
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742908453168334  LUMO = 2.65621305443572
  mo_energy =
[-3.25130413e+01 -1.85379505e+00 -7.42908453e-01 -7.42908453e-01
 -7.42908453e-01  2.65621305e+00  2.65621305e+00  2.65621305e+00
  2.73299221e+00  1.99574720e+01  1.99574720e+01  1.99574720e+01
  4.41722659e+01  3.19621598e+02  1.98501291e+03  7.27412929e+03]
E1 = -182.12874448350988  E_coul = 53.93361482874218
cycle= 1 E= -128.195129654768  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261976
diis-c [-0.06863142  1.        ]
  HOMO = -0.808012082161  LUMO = 2.60196773427967
  mo_energy =
[-3.27868954e+01 -1.92118294e+00 -8.08012082e-01 -8.08012082e-01
 -8.08012082e-01  2.60196773e+00  2.60196773e+00  2.60196773e+00
  2.67963778e+00  1.97664219e+01  1.97664219e+01  1.97664219e+01
  4.39382260e+01  3.19312182e+02  1.98465288e+03  7.27374387e+03]
E1 = -182.59201553893163  E_coul = 54.39524819753201
cycle= 2 E= -128.1967673414  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102104
diis-c [-4.56092469e-04  2.76619542e-01  7.23380458e-01]
  HOMO = -0.785166984101794  LUMO = 2.62265362258617
  mo_energy =
[-3.27118832e+01 -1.89748472e+00 -7.85166984e-01 -7.85166984e-01
 -7.85166984e-01  2.62265362e+00  2.62265362e+00  2.62265362e+00
  2.69968232e+00  1.98227687e+01  1.98227687e+01  1.98227687e+01
  4.40041888e+01  3.19393997e+02  1.98474034e+03  7.27383284e+03]
E1 = -182.45929489176106  E_coul = 54.26222129628613
cycle= 3 E= -128.197073595475  delta_E= -0.000306  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103555
diis-c [-7.93322667e-08 -3.67705083e-03  3.72755366e-04  1.00330430e+00]
  HOMO = -0.785435357986931  LUMO = 2.62244503812687
  mo_energy =
[-3.27126651e+01 -1.89782503e+00 -7.85435358e-01 -7.85435358e-01
 -7.85435358e-01  2.62244504e+00  2.62244504e+00  2.62244504e+00
  2.69941459e+00  1.98221607e+01  1.98221607e+01  1.98221607e+01
  4.40034622e+01  3.19393361e+02  1.98473983e+03  7.27383237e+03]
E1 = -182.4607869257328  E_coul = 54.26371328671734
cycle= 4 E= -128.197073639015  delta_E= -4.35e-08  |g|= 5.16e-05  |ddm|= 0.000288
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.19529e-05
diis-c [-2.24892523e-10  4.81270521e-04 -1.19793638e-03 -1.69789019e-01
  1.17050569e+00]
  HOMO = -0.785420667365531  LUMO = 2.62245780889888
  mo_energy =
[-3.27126273e+01 -1.89782250e+00 -7.85420667e-01 -7.85420667e-01
 -7.85420667e-01  2.62245781e+00  2.62245781e+00  2.62245781e+00
  2.69941596e+00  1.98221899e+01  1.98221899e+01  1.98221899e+01
  4.40034926e+01  3.19393412e+02  1.98473990e+03  7.27383244e+03]
E1 = -182.4607236889393  E_coul = 54.26365004961803
cycle= 5 E= -128.197073639321  delta_E= -3.06e-10  |g|= 1.59e-06  |ddm|= 2.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4607236889393  E_coul = 54.26365004961803
  HOMO = -0.785420590739243  LUMO = 2.62245788583373
  mo_energy =
[-3.27126272e+01 -1.89782282e+00 -7.85420591e-01 -7.85420591e-01
 -7.85420591e-01  2.62245789e+00  2.62245789e+00  2.62245789e+00
  2.69941569e+00  1.98221900e+01  1.98221900e+01  1.98221900e+01
  4.40034926e+01  3.19393413e+02  1.98473990e+03  7.27383244e+03]
E1 = -182.46072363674148  E_coul = 54.263649997419655
Extra cycle  E= -128.197073639322  delta_E= -5.4e-13  |g|= 2.92e-07  |ddm|= 9.24e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419214e+03 2.15484886e+02 1.42945735e+03 5.72013117e-01
 4.84050370e+01 1.30666489e+01 1.91396800e+00 2.77695527e+00
 1.33319312e+01 6.00158614e-01]
E = -128.19707363932181
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19213658        1
[INPUT] 0    0    [1    /1   ]  215.484885906        1
[INPUT] 0    0    [1    /1   ]  1429.45734962        1
[INPUT] 0    0    [1    /1   ]  0.57201311739        1
[INPUT] 0    0    [1    /1   ]  48.4050369981        1
[INPUT] 0    0    [1    /1   ]  13.0666488738        1
[INPUT] 0    0    [1    /1   ]  1.91396799613        1
[INPUT] 1    0    [1    /1   ]  2.77695526766        1
[INPUT] 1    0    [1    /1   ]  13.3319311513        1
[INPUT] 1    0    [1    /1   ]  0.60015861389        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192136580433, 1.0]], [0, [215.4848859061674, 1.0]], [0, [1429.4573496160162, 1.0]], [0, [0.572013117390296, 1.0]], [0, [48.40503699813678, 1.0]], [0, [13.066648873833268, 1.0]], [0, [1.9139679961252287, 1.0]], [1, [2.776955267664737, 1.0]], [1, [13.331931151293379, 1.0]], [1, [0.6001586138899041, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19213658]
bas 1, expnt(s) = [215.48488591]
bas 2, expnt(s) = [1429.45734962]
bas 3, expnt(s) = [0.57201312]
bas 4, expnt(s) = [48.405037]
bas 5, expnt(s) = [13.06664887]
bas 6, expnt(s) = [1.913968]
bas 7, expnt(s) = [2.77695527]
bas 8, expnt(s) = [13.33193115]
bas 9, expnt(s) = [0.60015861]
CPU time:        25.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419214e+03 7.96091155e+02 2.15484886e+02 1.42094620e+02
 1.42945735e+03 5.87345202e+02 5.72013117e-01 1.66176465e+00
 4.84050370e+01 4.63642183e+01 1.30666489e+01 1.73635367e+01
 1.91396800e+00 4.11117561e+00 2.77695527e+00 1.04579244e+01
 1.33319312e+01 7.43191477e+01 6.00158614e-01 1.54105077e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965783271274821
cond(S) = 156.40100171418038
E1 = -183.13558090654507  E_coul = 55.01098866898192
init E= -128.124592237563
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742908453168334  LUMO = 2.65621305443572
  mo_energy =
[-3.25130413e+01 -1.85379505e+00 -7.42908453e-01 -7.42908453e-01
 -7.42908453e-01  2.65621305e+00  2.65621305e+00  2.65621305e+00
  2.73299221e+00  1.99574720e+01  1.99574720e+01  1.99574720e+01
  4.41722659e+01  3.19621598e+02  1.98501291e+03  7.27412929e+03]
E1 = -182.12874448350988  E_coul = 53.93361482874218
cycle= 1 E= -128.195129654768  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261976
diis-c [-0.06863142  1.        ]
  HOMO = -0.808012082161  LUMO = 2.60196773427967
  mo_energy =
[-3.27868954e+01 -1.92118294e+00 -8.08012082e-01 -8.08012082e-01
 -8.08012082e-01  2.60196773e+00  2.60196773e+00  2.60196773e+00
  2.67963778e+00  1.97664219e+01  1.97664219e+01  1.97664219e+01
  4.39382260e+01  3.19312182e+02  1.98465288e+03  7.27374387e+03]
E1 = -182.59201553893163  E_coul = 54.39524819753201
cycle= 2 E= -128.1967673414  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102104
diis-c [-4.56092469e-04  2.76619542e-01  7.23380458e-01]
  HOMO = -0.785166984101794  LUMO = 2.62265362258617
  mo_energy =
[-3.27118832e+01 -1.89748472e+00 -7.85166984e-01 -7.85166984e-01
 -7.85166984e-01  2.62265362e+00  2.62265362e+00  2.62265362e+00
  2.69968232e+00  1.98227687e+01  1.98227687e+01  1.98227687e+01
  4.40041888e+01  3.19393997e+02  1.98474034e+03  7.27383284e+03]
E1 = -182.45929489176106  E_coul = 54.26222129628613
cycle= 3 E= -128.197073595475  delta_E= -0.000306  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103555
diis-c [-7.93322667e-08 -3.67705083e-03  3.72755366e-04  1.00330430e+00]
  HOMO = -0.785435357986931  LUMO = 2.62244503812687
  mo_energy =
[-3.27126651e+01 -1.89782503e+00 -7.85435358e-01 -7.85435358e-01
 -7.85435358e-01  2.62244504e+00  2.62244504e+00  2.62244504e+00
  2.69941459e+00  1.98221607e+01  1.98221607e+01  1.98221607e+01
  4.40034622e+01  3.19393361e+02  1.98473983e+03  7.27383237e+03]
E1 = -182.4607869257328  E_coul = 54.26371328671734
cycle= 4 E= -128.197073639015  delta_E= -4.35e-08  |g|= 5.16e-05  |ddm|= 0.000288
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.19529e-05
diis-c [-2.24892523e-10  4.81270521e-04 -1.19793638e-03 -1.69789019e-01
  1.17050569e+00]
  HOMO = -0.785420667365531  LUMO = 2.62245780889888
  mo_energy =
[-3.27126273e+01 -1.89782250e+00 -7.85420667e-01 -7.85420667e-01
 -7.85420667e-01  2.62245781e+00  2.62245781e+00  2.62245781e+00
  2.69941596e+00  1.98221899e+01  1.98221899e+01  1.98221899e+01
  4.40034926e+01  3.19393412e+02  1.98473990e+03  7.27383244e+03]
E1 = -182.4607236889393  E_coul = 54.26365004961803
cycle= 5 E= -128.197073639321  delta_E= -3.06e-10  |g|= 1.59e-06  |ddm|= 2.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4607236889393  E_coul = 54.26365004961803
  HOMO = -0.785420590739243  LUMO = 2.62245788583373
  mo_energy =
[-3.27126272e+01 -1.89782282e+00 -7.85420591e-01 -7.85420591e-01
 -7.85420591e-01  2.62245789e+00  2.62245789e+00  2.62245789e+00
  2.69941569e+00  1.98221900e+01  1.98221900e+01  1.98221900e+01
  4.40034926e+01  3.19393413e+02  1.98473990e+03  7.27383244e+03]
E1 = -182.46072363674148  E_coul = 54.263649997419655
Extra cycle  E= -128.197073639322  delta_E= -5.4e-13  |g|= 2.92e-07  |ddm|= 9.24e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.40100171418038
E1 = -182.46072363674148  E_coul = 54.263649997419655
init E= -128.197073639322
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785420578406793  LUMO = 2.62245789534042
  mo_energy =
[-3.27126272e+01 -1.89782288e+00 -7.85420578e-01 -7.85420578e-01
 -7.85420578e-01  2.62245790e+00  2.62245790e+00  2.62245790e+00
  2.69941563e+00  1.98221900e+01  1.98221900e+01  1.98221900e+01
  4.40034926e+01  3.19393413e+02  1.98473990e+03  7.27383244e+03]
E1 = -182.46072366719122  E_coul = 54.26365002786956
cycle= 1 E= -128.197073639322  delta_E= 1.42e-13  |g|= 5.32e-08  |ddm|= 1.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46072366719122  E_coul = 54.26365002786956
  HOMO = -0.78542057330405  LUMO = 2.62245789967872
  mo_energy =
[-3.27126272e+01 -1.89782289e+00 -7.85420573e-01 -7.85420573e-01
 -7.85420573e-01  2.62245790e+00  2.62245790e+00  2.62245790e+00
  2.69941562e+00  1.98221900e+01  1.98221900e+01  1.98221900e+01
  4.40034926e+01  3.19393413e+02  1.98473990e+03  7.27383244e+03]
E1 = -182.460723657518  E_coul = 54.26365001819629
Extra cycle  E= -128.197073639322  delta_E= -5.68e-14  |g|= 9.91e-09  |ddm|= 2.96e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419214e+03 2.15484886e+02 1.42945735e+03 5.72013117e-01
 4.84050370e+01 1.30666489e+01 1.91396800e+00 2.77695527e+00
 1.33319312e+01 6.00158614e-01]
grad_E = [-7.51567901e-06 -2.99179031e-04  4.57930669e-05  2.83729539e-03
  2.89773200e-04  7.49465548e-04 -3.92876769e-04  3.99706045e-04
  1.43450526e-05 -3.45622619e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19249312        1
[INPUT] 0    0    [1    /1   ]  215.500128295        1
[INPUT] 0    0    [1    /1   ]  1429.45515572        1
[INPUT] 0    0    [1    /1   ]  0.573607576848       1
[INPUT] 0    0    [1    /1   ]  48.3801562977        1
[INPUT] 0    0    [1    /1   ]  13.062288991         1
[INPUT] 0    0    [1    /1   ]  1.92141215549        1
[INPUT] 1    0    [1    /1   ]  2.77931540552        1
[INPUT] 1    0    [1    /1   ]  13.3315463209        1
[INPUT] 1    0    [1    /1   ]  0.600789476058       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.19249312055, 1.0]], [0, [215.50012829471763, 1.0]], [0, [1429.4551557204793, 1.0]], [0, [0.5736075768477975, 1.0]], [0, [48.38015629769336, 1.0]], [0, [13.062288991014276, 1.0]], [0, [1.9214121554944201, 1.0]], [1, [2.7793154055235156, 1.0]], [1, [13.331546320935477, 1.0]], [1, [0.6007894760584299, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19249312]
bas 1, expnt(s) = [215.50012829]
bas 2, expnt(s) = [1429.45515572]
bas 3, expnt(s) = [0.57360758]
bas 4, expnt(s) = [48.3801563]
bas 5, expnt(s) = [13.06228899]
bas 6, expnt(s) = [1.92141216]
bas 7, expnt(s) = [2.77931541]
bas 8, expnt(s) = [13.33154632]
bas 9, expnt(s) = [0.60078948]
CPU time:        27.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419249e+03 7.96091254e+02 2.15500128e+02 1.42102158e+02
 1.42945516e+03 5.87344526e+02 5.73607577e-01 1.66523751e+00
 4.83801563e+01 4.63463433e+01 1.30622890e+01 1.73591913e+01
 1.92141216e+00 4.12316225e+00 2.77931541e+00 1.04690358e+01
 1.33315463e+01 7.43164661e+01 6.00789476e-01 1.54307590e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965637497395184
cond(S) = 156.42814284470327
E1 = -183.13587650958507  E_coul = 55.01121630902262
init E= -128.124660200562
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742877788509962  LUMO = 2.65963930578577
  mo_energy =
[-3.25131005e+01 -1.85370327e+00 -7.42877789e-01 -7.42877789e-01
 -7.42877789e-01  2.65963931e+00  2.65963931e+00  2.65963931e+00
  2.74768580e+00  1.99663843e+01  1.99663843e+01  1.99663843e+01
  4.41871379e+01  3.19577558e+02  1.98498172e+03  7.27410495e+03]
E1 = -182.13384018759115  E_coul = 53.9386844453842
cycle= 1 E= -128.195155742207  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261154
diis-c [-0.06820122  1.        ]
  HOMO = -0.807626022619609  LUMO = 2.60566777179144
  mo_energy =
[-3.27859956e+01 -1.92070837e+00 -8.07626023e-01 -8.07626023e-01
 -8.07626023e-01  2.60566777e+00  2.60566777e+00  2.60566777e+00
  2.69440010e+00  1.97760915e+01  1.97760915e+01  1.97760915e+01
  4.39539812e+01  3.19269088e+02  1.98462259e+03  7.27372043e+03]
E1 = -182.59503926330433  E_coul = 54.39825812221133
cycle= 2 E= -128.196781141093  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101669
diis-c [-4.54727115e-04  2.76370432e-01  7.23629568e-01]
  HOMO = -0.784879742941595  LUMO = 2.62628388762999
  mo_energy =
[-3.27112755e+01 -1.89711158e+00 -7.84879743e-01 -7.84879743e-01
 -7.84879743e-01  2.62628389e+00  2.62628389e+00  2.62628389e+00
  2.71443574e+00  1.98322109e+01  1.98322109e+01  1.98322109e+01
  4.40196743e+01  3.19350590e+02  1.98470972e+03  7.27380906e+03]
E1 = -182.4629473085804  E_coul = 54.265862681230864
cycle= 3 E= -128.19708462735  delta_E= -0.000303  |g|= 0.000793  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010474
diis-c [-7.72707675e-08 -3.67308870e-03  5.50891635e-04  1.00312220e+00]
  HOMO = -0.785151091215513  LUMO = 2.62607218322651
  mo_energy =
[-3.27120655e+01 -1.89745393e+00 -7.85151091e-01 -7.85151091e-01
 -7.85151091e-01  2.62607218e+00  2.62607218e+00  2.62607218e+00
  2.71416503e+00  1.98315963e+01  1.98315963e+01  1.98315963e+01
  4.40189406e+01  3.19349944e+02  1.98470920e+03  7.27380857e+03]
E1 = -182.46445284490338  E_coul = 54.267368173497324
cycle= 4 E= -128.197084671406  delta_E= -4.41e-08  |g|= 5.08e-05  |ddm|= 0.000288
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.07487e-05
diis-c [-2.18895980e-10  4.80277073e-04 -1.21444148e-03 -1.69077629e-01
  1.16981179e+00]
  HOMO = -0.785136627644572  LUMO = 2.62608477128922
  mo_energy =
[-3.27120282e+01 -1.89745141e+00 -7.85136628e-01 -7.85136628e-01
 -7.85136628e-01  2.62608477e+00  2.62608477e+00  2.62608477e+00
  2.71416642e+00  1.98316251e+01  1.98316251e+01  1.98316251e+01
  4.40189706e+01  3.19349995e+02  1.98470927e+03  7.27380865e+03]
E1 = -182.46439044730104  E_coul = 54.267305775599205
cycle= 5 E= -128.197084671702  delta_E= -2.96e-10  |g|= 1.57e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46439044730104  E_coul = 54.267305775599205
  HOMO = -0.785136552352951  LUMO = 2.62608484687387
  mo_energy =
[-3.27120281e+01 -1.89745173e+00 -7.85136552e-01 -7.85136552e-01
 -7.85136552e-01  2.62608485e+00  2.62608485e+00  2.62608485e+00
  2.71416615e+00  1.98316252e+01  1.98316252e+01  1.98316252e+01
  4.40189706e+01  3.19349995e+02  1.98470927e+03  7.27380865e+03]
E1 = -182.46439039582785  E_coul = 54.267305724125904
Extra cycle  E= -128.197084671702  delta_E= -8.53e-14  |g|= 2.89e-07  |ddm|= 9.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419249e+03 2.15500128e+02 1.42945516e+03 5.73607577e-01
 4.83801563e+01 1.30622890e+01 1.92141216e+00 2.77931541e+00
 1.33315463e+01 6.00789476e-01]
E = -128.19708467170193
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19249312        1
[INPUT] 0    0    [1    /1   ]  215.500128295        1
[INPUT] 0    0    [1    /1   ]  1429.45515572        1
[INPUT] 0    0    [1    /1   ]  0.573607576848       1
[INPUT] 0    0    [1    /1   ]  48.3801562977        1
[INPUT] 0    0    [1    /1   ]  13.062288991         1
[INPUT] 0    0    [1    /1   ]  1.92141215549        1
[INPUT] 1    0    [1    /1   ]  2.77931540552        1
[INPUT] 1    0    [1    /1   ]  13.3315463209        1
[INPUT] 1    0    [1    /1   ]  0.600789476058       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.19249312055, 1.0]], [0, [215.50012829471763, 1.0]], [0, [1429.4551557204793, 1.0]], [0, [0.5736075768477975, 1.0]], [0, [48.38015629769336, 1.0]], [0, [13.062288991014276, 1.0]], [0, [1.9214121554944201, 1.0]], [1, [2.7793154055235156, 1.0]], [1, [13.331546320935477, 1.0]], [1, [0.6007894760584299, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19249312]
bas 1, expnt(s) = [215.50012829]
bas 2, expnt(s) = [1429.45515572]
bas 3, expnt(s) = [0.57360758]
bas 4, expnt(s) = [48.3801563]
bas 5, expnt(s) = [13.06228899]
bas 6, expnt(s) = [1.92141216]
bas 7, expnt(s) = [2.77931541]
bas 8, expnt(s) = [13.33154632]
bas 9, expnt(s) = [0.60078948]
CPU time:        27.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419249e+03 7.96091254e+02 2.15500128e+02 1.42102158e+02
 1.42945516e+03 5.87344526e+02 5.73607577e-01 1.66523751e+00
 4.83801563e+01 4.63463433e+01 1.30622890e+01 1.73591913e+01
 1.92141216e+00 4.12316225e+00 2.77931541e+00 1.04690358e+01
 1.33315463e+01 7.43164661e+01 6.00789476e-01 1.54307590e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965637497395184
cond(S) = 156.42814284470327
E1 = -183.13587650958507  E_coul = 55.01121630902262
init E= -128.124660200562
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742877788509962  LUMO = 2.65963930578577
  mo_energy =
[-3.25131005e+01 -1.85370327e+00 -7.42877789e-01 -7.42877789e-01
 -7.42877789e-01  2.65963931e+00  2.65963931e+00  2.65963931e+00
  2.74768580e+00  1.99663843e+01  1.99663843e+01  1.99663843e+01
  4.41871379e+01  3.19577558e+02  1.98498172e+03  7.27410495e+03]
E1 = -182.13384018759115  E_coul = 53.9386844453842
cycle= 1 E= -128.195155742207  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261154
diis-c [-0.06820122  1.        ]
  HOMO = -0.807626022619609  LUMO = 2.60566777179144
  mo_energy =
[-3.27859956e+01 -1.92070837e+00 -8.07626023e-01 -8.07626023e-01
 -8.07626023e-01  2.60566777e+00  2.60566777e+00  2.60566777e+00
  2.69440010e+00  1.97760915e+01  1.97760915e+01  1.97760915e+01
  4.39539812e+01  3.19269088e+02  1.98462259e+03  7.27372043e+03]
E1 = -182.59503926330433  E_coul = 54.39825812221133
cycle= 2 E= -128.196781141093  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101669
diis-c [-4.54727115e-04  2.76370432e-01  7.23629568e-01]
  HOMO = -0.784879742941595  LUMO = 2.62628388762999
  mo_energy =
[-3.27112755e+01 -1.89711158e+00 -7.84879743e-01 -7.84879743e-01
 -7.84879743e-01  2.62628389e+00  2.62628389e+00  2.62628389e+00
  2.71443574e+00  1.98322109e+01  1.98322109e+01  1.98322109e+01
  4.40196743e+01  3.19350590e+02  1.98470972e+03  7.27380906e+03]
E1 = -182.4629473085804  E_coul = 54.265862681230864
cycle= 3 E= -128.19708462735  delta_E= -0.000303  |g|= 0.000793  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010474
diis-c [-7.72707675e-08 -3.67308870e-03  5.50891635e-04  1.00312220e+00]
  HOMO = -0.785151091215513  LUMO = 2.62607218322651
  mo_energy =
[-3.27120655e+01 -1.89745393e+00 -7.85151091e-01 -7.85151091e-01
 -7.85151091e-01  2.62607218e+00  2.62607218e+00  2.62607218e+00
  2.71416503e+00  1.98315963e+01  1.98315963e+01  1.98315963e+01
  4.40189406e+01  3.19349944e+02  1.98470920e+03  7.27380857e+03]
E1 = -182.46445284490338  E_coul = 54.267368173497324
cycle= 4 E= -128.197084671406  delta_E= -4.41e-08  |g|= 5.08e-05  |ddm|= 0.000288
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.07487e-05
diis-c [-2.18895980e-10  4.80277073e-04 -1.21444148e-03 -1.69077629e-01
  1.16981179e+00]
  HOMO = -0.785136627644572  LUMO = 2.62608477128922
  mo_energy =
[-3.27120282e+01 -1.89745141e+00 -7.85136628e-01 -7.85136628e-01
 -7.85136628e-01  2.62608477e+00  2.62608477e+00  2.62608477e+00
  2.71416642e+00  1.98316251e+01  1.98316251e+01  1.98316251e+01
  4.40189706e+01  3.19349995e+02  1.98470927e+03  7.27380865e+03]
E1 = -182.46439044730104  E_coul = 54.267305775599205
cycle= 5 E= -128.197084671702  delta_E= -2.96e-10  |g|= 1.57e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46439044730104  E_coul = 54.267305775599205
  HOMO = -0.785136552352951  LUMO = 2.62608484687387
  mo_energy =
[-3.27120281e+01 -1.89745173e+00 -7.85136552e-01 -7.85136552e-01
 -7.85136552e-01  2.62608485e+00  2.62608485e+00  2.62608485e+00
  2.71416615e+00  1.98316252e+01  1.98316252e+01  1.98316252e+01
  4.40189706e+01  3.19349995e+02  1.98470927e+03  7.27380865e+03]
E1 = -182.46439039582785  E_coul = 54.267305724125904
Extra cycle  E= -128.197084671702  delta_E= -8.53e-14  |g|= 2.89e-07  |ddm|= 9.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.42814284470327
E1 = -182.46439039582785  E_coul = 54.267305724125904
init E= -128.197084671702
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785136540166348  LUMO = 2.62608485628271
  mo_energy =
[-3.27120281e+01 -1.89745179e+00 -7.85136540e-01 -7.85136540e-01
 -7.85136540e-01  2.62608486e+00  2.62608486e+00  2.62608486e+00
  2.71416609e+00  1.98316252e+01  1.98316252e+01  1.98316252e+01
  4.40189706e+01  3.19349995e+02  1.98470927e+03  7.27380865e+03]
E1 = -182.4643904253446  E_coul = 54.26730575364254
cycle= 1 E= -128.197084671702  delta_E= -1.14e-13  |g|= 5.26e-08  |ddm|= 1.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4643904253446  E_coul = 54.26730575364254
  HOMO = -0.785136535169649  LUMO = 2.6260848605338
  mo_energy =
[-3.27120281e+01 -1.89745180e+00 -7.85136535e-01 -7.85136535e-01
 -7.85136535e-01  2.62608486e+00  2.62608486e+00  2.62608486e+00
  2.71416609e+00  1.98316252e+01  1.98316252e+01  1.98316252e+01
  4.40189706e+01  3.19349995e+02  1.98470927e+03  7.27380865e+03]
E1 = -182.464390415918  E_coul = 54.26730574421603
Extra cycle  E= -128.197084671702  delta_E= 8.53e-14  |g|= 9.79e-09  |ddm|= 2.92e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419249e+03 2.15500128e+02 1.42945516e+03 5.73607577e-01
 4.83801563e+01 1.30622890e+01 1.92141216e+00 2.77931541e+00
 1.33315463e+01 6.00789476e-01]
grad_E = [-7.53382563e-06 -2.91352060e-04  4.56930416e-05  2.95817738e-03
  2.43701296e-04  7.10797152e-04  1.10263502e-05  1.15619072e-03
 -1.26933741e-04 -1.84317133e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19311041        1
[INPUT] 0    0    [1    /1   ]  215.526330959        1
[INPUT] 0    0    [1    /1   ]  1429.45136137        1
[INPUT] 0    0    [1    /1   ]  0.574301652357       1
[INPUT] 0    0    [1    /1   ]  48.3388611713        1
[INPUT] 0    0    [1    /1   ]  13.0504079836        1
[INPUT] 0    0    [1    /1   ]  1.92992844283        1
[INPUT] 1    0    [1    /1   ]  2.7802655553         1
[INPUT] 1    0    [1    /1   ]  13.3313590494        1
[INPUT] 1    0    [1    /1   ]  0.601072399053       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.193110408468, 1.0]], [0, [215.52633095856424, 1.0]], [0, [1429.4513613662916, 1.0]], [0, [0.5743016523572685, 1.0]], [0, [48.33886117131658, 1.0]], [0, [13.050407983571647, 1.0]], [0, [1.9299284428285732, 1.0]], [1, [2.7802655553021056, 1.0]], [1, [13.33135904941919, 1.0]], [1, [0.6010723990530128, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19311041]
bas 1, expnt(s) = [215.52633096]
bas 2, expnt(s) = [1429.45136137]
bas 3, expnt(s) = [0.57430165]
bas 4, expnt(s) = [48.33886117]
bas 5, expnt(s) = [13.05040798]
bas 6, expnt(s) = [1.92992844]
bas 7, expnt(s) = [2.78026556]
bas 8, expnt(s) = [13.33135905]
bas 9, expnt(s) = [0.6010724]
CPU time:        29.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419311e+03 7.96091426e+02 2.15526331e+02 1.42115117e+02
 1.42945136e+03 5.87343357e+02 5.74301652e-01 1.66674850e+00
 4.83388612e+01 4.63166708e+01 1.30504080e+01 1.73473480e+01
 1.92992844e+00 4.13686101e+00 2.78026556e+00 1.04735098e+01
 1.33313590e+01 7.43151612e+01 6.01072399e-01 1.54398428e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965572255007622
cond(S) = 156.43790976370718
E1 = -183.13627488629115  E_coul = 55.01154141995896
init E= -128.124733466332
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74285908948683  LUMO = 2.66111646796849
  mo_energy =
[-3.25130900e+01 -1.85361569e+00 -7.42859089e-01 -7.42859089e-01
 -7.42859089e-01  2.66111647e+00  2.66111647e+00  2.66111647e+00
  2.76018640e+00  1.99700992e+01  1.99700992e+01  1.99700992e+01
  4.41762128e+01  3.19468289e+02  1.98490131e+03  7.27403854e+03]
E1 = -182.1346507313304  E_coul = 53.939476270750255
cycle= 1 E= -128.19517446058  delta_E= -0.0704  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261248
diis-c [-0.06825033  1.        ]
  HOMO = -0.807586798867207  LUMO = 2.60714796839694
  mo_energy =
[-3.27858961e+01 -1.92053827e+00 -8.07586799e-01 -8.07586799e-01
 -8.07586799e-01  2.60714797e+00  2.60714797e+00  2.60714797e+00
  2.70671716e+00  1.97798687e+01  1.97798687e+01  1.97798687e+01
  4.39431595e+01  3.19159800e+02  1.98454205e+03  7.27365387e+03]
E1 = -182.59562007433166  E_coul = 54.39882100766474
cycle= 2 E= -128.196799066667  delta_E= -0.00162  |g|= 0.0624  |ddm|= 0.064
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10163
diis-c [-4.52942079e-04  2.76233624e-01  7.23766376e-01]
  HOMO = -0.784851402236512  LUMO = 2.62776235185798
  mo_energy =
[-3.27111889e+01 -1.89694750e+00 -7.84851402e-01 -7.84851402e-01
 -7.84851402e-01  2.62776235e+00  2.62776235e+00  2.62776235e+00
  2.72682234e+00  1.98359741e+01  1.98359741e+01  1.98359741e+01
  4.40088229e+01  3.19241285e+02  1.98462916e+03  7.27374248e+03]
E1 = -182.4635879600398  E_coul = 54.26648565854858
cycle= 3 E= -128.197102301491  delta_E= -0.000303  |g|= 0.000794  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106327
diis-c [-6.92053170e-08 -3.63272274e-03  8.60281207e-04  1.00277244e+00]
  HOMO = -0.78512660792803  LUMO = 2.62754717500798
  mo_energy =
[-3.27119874e+01 -1.89728925e+00 -7.85126608e-01 -7.85126608e-01
 -7.85126608e-01  2.62754718e+00  2.62754718e+00  2.62754718e+00
  2.72655116e+00  1.98353526e+01  1.98353526e+01  1.98353526e+01
  4.40080823e+01  3.19240626e+02  1.98462863e+03  7.27374197e+03]
E1 = -182.46510740456213  E_coul = 54.268005059096765
cycle= 4 E= -128.197102345465  delta_E= -4.4e-08  |g|= 4.75e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.56959e-05
diis-c [-2.06119518e-10  4.67843660e-04 -1.19080493e-03 -1.64858787e-01
  1.16558175e+00]
  HOMO = -0.785113043249077  LUMO = 2.62755898250935
  mo_energy =
[-3.27119524e+01 -1.89728672e+00 -7.85113043e-01 -7.85113043e-01
 -7.85113043e-01  2.62755898e+00  2.62755898e+00  2.62755898e+00
  2.72655262e+00  1.98353798e+01  1.98353798e+01  1.98353798e+01
  4.40081105e+01  3.19240674e+02  1.98462869e+03  7.27374204e+03]
E1 = -182.465048630684  E_coul = 54.267946284962484
cycle= 5 E= -128.197102345722  delta_E= -2.56e-10  |g|= 1.59e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.465048630684  E_coul = 54.267946284962484
  HOMO = -0.78511294329293  LUMO = 2.62755908002811
  mo_energy =
[-3.27119522e+01 -1.89728702e+00 -7.85112943e-01 -7.85112943e-01
 -7.85112943e-01  2.62755908e+00  2.62755908e+00  2.62755908e+00
  2.72655236e+00  1.98353799e+01  1.98353799e+01  1.98353799e+01
  4.40081106e+01  3.19240674e+02  1.98462869e+03  7.27374204e+03]
E1 = -182.46504844796905  E_coul = 54.26794610224731
Extra cycle  E= -128.197102345722  delta_E= -2.27e-13  |g|= 2.95e-07  |ddm|= 9.18e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419311e+03 2.15526331e+02 1.42945136e+03 5.74301652e-01
 4.83388612e+01 1.30504080e+01 1.92992844e+00 2.78026556e+00
 1.33313590e+01 6.01072399e-01]
E = -128.19710234572176
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19311041        1
[INPUT] 0    0    [1    /1   ]  215.526330959        1
[INPUT] 0    0    [1    /1   ]  1429.45136137        1
[INPUT] 0    0    [1    /1   ]  0.574301652357       1
[INPUT] 0    0    [1    /1   ]  48.3388611713        1
[INPUT] 0    0    [1    /1   ]  13.0504079836        1
[INPUT] 0    0    [1    /1   ]  1.92992844283        1
[INPUT] 1    0    [1    /1   ]  2.7802655553         1
[INPUT] 1    0    [1    /1   ]  13.3313590494        1
[INPUT] 1    0    [1    /1   ]  0.601072399053       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.193110408468, 1.0]], [0, [215.52633095856424, 1.0]], [0, [1429.4513613662916, 1.0]], [0, [0.5743016523572685, 1.0]], [0, [48.33886117131658, 1.0]], [0, [13.050407983571647, 1.0]], [0, [1.9299284428285732, 1.0]], [1, [2.7802655553021056, 1.0]], [1, [13.33135904941919, 1.0]], [1, [0.6010723990530128, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19311041]
bas 1, expnt(s) = [215.52633096]
bas 2, expnt(s) = [1429.45136137]
bas 3, expnt(s) = [0.57430165]
bas 4, expnt(s) = [48.33886117]
bas 5, expnt(s) = [13.05040798]
bas 6, expnt(s) = [1.92992844]
bas 7, expnt(s) = [2.78026556]
bas 8, expnt(s) = [13.33135905]
bas 9, expnt(s) = [0.6010724]
CPU time:        30.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419311e+03 7.96091426e+02 2.15526331e+02 1.42115117e+02
 1.42945136e+03 5.87343357e+02 5.74301652e-01 1.66674850e+00
 4.83388612e+01 4.63166708e+01 1.30504080e+01 1.73473480e+01
 1.92992844e+00 4.13686101e+00 2.78026556e+00 1.04735098e+01
 1.33313590e+01 7.43151612e+01 6.01072399e-01 1.54398428e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965572255007622
cond(S) = 156.43790976370718
E1 = -183.13627488629115  E_coul = 55.01154141995896
init E= -128.124733466332
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74285908948683  LUMO = 2.66111646796849
  mo_energy =
[-3.25130900e+01 -1.85361569e+00 -7.42859089e-01 -7.42859089e-01
 -7.42859089e-01  2.66111647e+00  2.66111647e+00  2.66111647e+00
  2.76018640e+00  1.99700992e+01  1.99700992e+01  1.99700992e+01
  4.41762128e+01  3.19468289e+02  1.98490131e+03  7.27403854e+03]
E1 = -182.1346507313304  E_coul = 53.939476270750255
cycle= 1 E= -128.19517446058  delta_E= -0.0704  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261248
diis-c [-0.06825033  1.        ]
  HOMO = -0.807586798867207  LUMO = 2.60714796839694
  mo_energy =
[-3.27858961e+01 -1.92053827e+00 -8.07586799e-01 -8.07586799e-01
 -8.07586799e-01  2.60714797e+00  2.60714797e+00  2.60714797e+00
  2.70671716e+00  1.97798687e+01  1.97798687e+01  1.97798687e+01
  4.39431595e+01  3.19159800e+02  1.98454205e+03  7.27365387e+03]
E1 = -182.59562007433166  E_coul = 54.39882100766474
cycle= 2 E= -128.196799066667  delta_E= -0.00162  |g|= 0.0624  |ddm|= 0.064
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10163
diis-c [-4.52942079e-04  2.76233624e-01  7.23766376e-01]
  HOMO = -0.784851402236512  LUMO = 2.62776235185798
  mo_energy =
[-3.27111889e+01 -1.89694750e+00 -7.84851402e-01 -7.84851402e-01
 -7.84851402e-01  2.62776235e+00  2.62776235e+00  2.62776235e+00
  2.72682234e+00  1.98359741e+01  1.98359741e+01  1.98359741e+01
  4.40088229e+01  3.19241285e+02  1.98462916e+03  7.27374248e+03]
E1 = -182.4635879600398  E_coul = 54.26648565854858
cycle= 3 E= -128.197102301491  delta_E= -0.000303  |g|= 0.000794  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106327
diis-c [-6.92053170e-08 -3.63272274e-03  8.60281207e-04  1.00277244e+00]
  HOMO = -0.78512660792803  LUMO = 2.62754717500798
  mo_energy =
[-3.27119874e+01 -1.89728925e+00 -7.85126608e-01 -7.85126608e-01
 -7.85126608e-01  2.62754718e+00  2.62754718e+00  2.62754718e+00
  2.72655116e+00  1.98353526e+01  1.98353526e+01  1.98353526e+01
  4.40080823e+01  3.19240626e+02  1.98462863e+03  7.27374197e+03]
E1 = -182.46510740456213  E_coul = 54.268005059096765
cycle= 4 E= -128.197102345465  delta_E= -4.4e-08  |g|= 4.75e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.56959e-05
diis-c [-2.06119518e-10  4.67843660e-04 -1.19080493e-03 -1.64858787e-01
  1.16558175e+00]
  HOMO = -0.785113043249077  LUMO = 2.62755898250935
  mo_energy =
[-3.27119524e+01 -1.89728672e+00 -7.85113043e-01 -7.85113043e-01
 -7.85113043e-01  2.62755898e+00  2.62755898e+00  2.62755898e+00
  2.72655262e+00  1.98353798e+01  1.98353798e+01  1.98353798e+01
  4.40081105e+01  3.19240674e+02  1.98462869e+03  7.27374204e+03]
E1 = -182.465048630684  E_coul = 54.267946284962484
cycle= 5 E= -128.197102345722  delta_E= -2.56e-10  |g|= 1.59e-06  |ddm|= 2.38e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.465048630684  E_coul = 54.267946284962484
  HOMO = -0.78511294329293  LUMO = 2.62755908002811
  mo_energy =
[-3.27119522e+01 -1.89728702e+00 -7.85112943e-01 -7.85112943e-01
 -7.85112943e-01  2.62755908e+00  2.62755908e+00  2.62755908e+00
  2.72655236e+00  1.98353799e+01  1.98353799e+01  1.98353799e+01
  4.40081106e+01  3.19240674e+02  1.98462869e+03  7.27374204e+03]
E1 = -182.46504844796905  E_coul = 54.26794610224731
Extra cycle  E= -128.197102345722  delta_E= -2.27e-13  |g|= 2.95e-07  |ddm|= 9.18e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.43790976370718
E1 = -182.46504844796905  E_coul = 54.26794610224731
init E= -128.197102345722
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785112939881564  LUMO = 2.6275590814909
  mo_energy =
[-3.27119522e+01 -1.89728709e+00 -7.85112940e-01 -7.85112940e-01
 -7.85112940e-01  2.62755908e+00  2.62755908e+00  2.62755908e+00
  2.72655230e+00  1.98353798e+01  1.98353798e+01  1.98353798e+01
  4.40081105e+01  3.19240674e+02  1.98462869e+03  7.27374204e+03]
E1 = -182.4650485293266  E_coul = 54.267946183604806
cycle= 1 E= -128.197102345722  delta_E= -2.84e-14  |g|= 5.36e-08  |ddm|= 1.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4650485293266  E_coul = 54.267946183604806
  HOMO = -0.785112931318487  LUMO = 2.62755908897581
  mo_energy =
[-3.27119522e+01 -1.89728709e+00 -7.85112931e-01 -7.85112931e-01
 -7.85112931e-01  2.62755909e+00  2.62755909e+00  2.62755909e+00
  2.72655230e+00  1.98353799e+01  1.98353799e+01  1.98353799e+01
  4.40081105e+01  3.19240675e+02  1.98462869e+03  7.27374204e+03]
E1 = -182.46504849924227  E_coul = 54.26794615352062
Extra cycle  E= -128.197102345722  delta_E= 1.42e-13  |g|= 1.08e-08  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419311e+03 2.15526331e+02 1.42945136e+03 5.74301652e-01
 4.83388612e+01 1.30504080e+01 1.92992844e+00 2.78026556e+00
 1.33313590e+01 6.01072399e-01]
grad_E = [-7.56010229e-06 -2.80886729e-04  4.55490143e-05  6.52490981e-04
  2.05848702e-04  5.36309196e-04  1.06420015e-03  1.37817081e-03
 -1.80289233e-04 -9.06735987e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19394043        1
[INPUT] 0    0    [1    /1   ]  215.561209266        1
[INPUT] 0    0    [1    /1   ]  1429.44626695        1
[INPUT] 0    0    [1    /1   ]  0.574038678742       1
[INPUT] 0    0    [1    /1   ]  48.2867542521        1
[INPUT] 0    0    [1    /1   ]  13.0257864372        1
[INPUT] 0    0    [1    /1   ]  1.93379660756        1
[INPUT] 1    0    [1    /1   ]  2.78069715772        1
[INPUT] 1    0    [1    /1   ]  13.3312616413        1
[INPUT] 1    0    [1    /1   ]  0.60149084905        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.193940425738, 1.0]], [0, [215.56120926637908, 1.0]], [0, [1429.446266954578, 1.0]], [0, [0.5740386787420491, 1.0]], [0, [48.286754252084506, 1.0]], [0, [13.025786437175737, 1.0]], [0, [1.9337966075613329, 1.0]], [1, [2.7806971577179866, 1.0]], [1, [13.331261641253398, 1.0]], [1, [0.6014908490497404, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19394043]
bas 1, expnt(s) = [215.56120927]
bas 2, expnt(s) = [1429.44626695]
bas 3, expnt(s) = [0.57403868]
bas 4, expnt(s) = [48.28675425]
bas 5, expnt(s) = [13.02578644]
bas 6, expnt(s) = [1.93379661]
bas 7, expnt(s) = [2.78069716]
bas 8, expnt(s) = [13.33126164]
bas 9, expnt(s) = [0.60149085]
CPU time:        32.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419394e+03 7.96091657e+02 2.15561209e+02 1.42132365e+02
 1.42944627e+03 5.87341787e+02 5.74038679e-01 1.66617606e+00
 4.82867543e+01 4.62792204e+01 1.30257864e+01 1.73227959e+01
 1.93379661e+00 4.14307810e+00 2.78069716e+00 1.04755422e+01
 1.33312616e+01 7.43144825e+01 6.01490849e-01 1.54532800e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96550462976625
cond(S) = 156.40702641157327
E1 = -183.1367680495785  E_coul = 55.011893656309645
init E= -128.124874393269
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742829915324549  LUMO = 2.66278720434974
  mo_energy =
[-3.25130686e+01 -1.85355377e+00 -7.42829915e-01 -7.42829915e-01
 -7.42829915e-01  2.66278720e+00  2.66278720e+00  2.66278720e+00
  2.76327890e+00  1.99726347e+01  1.99726347e+01  1.99726347e+01
  4.41053359e+01  3.19268288e+02  1.98475067e+03  7.27391013e+03]
E1 = -182.13713032207008  E_coul = 53.941928039676625
cycle= 1 E= -128.195202282393  delta_E= -0.0703  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260973
diis-c [-0.06810715  1.        ]
  HOMO = -0.807387774800736  LUMO = 2.60895871645039
  mo_energy =
[-3.27856032e+01 -1.92021145e+00 -8.07387775e-01 -8.07387775e-01
 -8.07387775e-01  2.60895872e+00  2.60895872e+00  2.60895872e+00
  2.70996813e+00  1.97826983e+01  1.97826983e+01  1.97826983e+01
  4.38726713e+01  3.18959795e+02  1.98439122e+03  7.27352522e+03]
E1 = -182.59717084587857  E_coul = 54.40034934844682
cycle= 2 E= -128.196821497432  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0638
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101416
diis-c [-4.4877824e-04  2.7604017e-01  7.2395983e-01]
  HOMO = -0.784694171758908  LUMO = 2.6295401227596
  mo_energy =
[-3.27110207e+01 -1.89666138e+00 -7.84694172e-01 -7.84694172e-01
 -7.84694172e-01  2.62954012e+00  2.62954012e+00  2.62954012e+00
  2.73006124e+00  1.98387061e+01  1.98387061e+01  1.98387061e+01
  4.39381973e+01  3.19041141e+02  1.98447818e+03  7.27361368e+03]
E1 = -182.46542514920876  E_coul = 54.268301718870575
cycle= 3 E= -128.197123430338  delta_E= -0.000302  |g|= 0.000793  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107764
diis-c [-6.03716991e-08 -3.57224570e-03  1.22364011e-03  1.00234861e+00]
  HOMO = -0.784972734295829  LUMO = 2.62932187287412
  mo_energy =
[-3.27118267e+01 -1.89700129e+00 -7.84972734e-01 -7.84972734e-01
 -7.84972734e-01  2.62932187e+00  2.62932187e+00  2.62932187e+00
  2.72979136e+00  1.98380789e+01  1.98380789e+01  1.98380789e+01
  4.39374513e+01  3.19040470e+02  1.98447763e+03  7.27361316e+03]
E1 = -182.46695544463975  E_coul = 54.26983197059857
cycle= 4 E= -128.197123474041  delta_E= -4.37e-08  |g|= 4.36e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.99095e-05
diis-c [-1.93416406e-10  4.48942682e-04 -1.16247802e-03 -1.59250055e-01
  1.15996359e+00]
  HOMO = -0.784960172626531  LUMO = 2.6293328089234
  mo_energy =
[-3.27117942e+01 -1.89699873e+00 -7.84960173e-01 -7.84960173e-01
 -7.84960173e-01  2.62933281e+00  2.62933281e+00  2.62933281e+00
  2.72979291e+00  1.98381041e+01  1.98381041e+01  1.98381041e+01
  4.39374775e+01  3.19040515e+02  1.98447769e+03  7.27361322e+03]
E1 = -182.46690084133587  E_coul = 54.269777367080145
cycle= 5 E= -128.197123474256  delta_E= -2.15e-10  |g|= 1.61e-06  |ddm|= 2.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46690084133587  E_coul = 54.269777367080145
  HOMO = -0.784960041918387  LUMO = 2.6293329333827
  mo_energy =
[-3.27117939e+01 -1.89699900e+00 -7.84960042e-01 -7.84960042e-01
 -7.84960042e-01  2.62933293e+00  2.62933293e+00  2.62933293e+00
  2.72979268e+00  1.98381042e+01  1.98381042e+01  1.98381042e+01
  4.39374776e+01  3.19040515e+02  1.98447769e+03  7.27361322e+03]
E1 = -182.46690050234525  E_coul = 54.269777028089244
Extra cycle  E= -128.197123474256  delta_E= -2.84e-13  |g|= 3.05e-07  |ddm|= 9.23e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419394e+03 2.15561209e+02 1.42944627e+03 5.74038679e-01
 4.82867543e+01 1.30257864e+01 1.93379661e+00 2.78069716e+00
 1.33312616e+01 6.01490849e-01]
E = -128.19712347425602
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19394043        1
[INPUT] 0    0    [1    /1   ]  215.561209266        1
[INPUT] 0    0    [1    /1   ]  1429.44626695        1
[INPUT] 0    0    [1    /1   ]  0.574038678742       1
[INPUT] 0    0    [1    /1   ]  48.2867542521        1
[INPUT] 0    0    [1    /1   ]  13.0257864372        1
[INPUT] 0    0    [1    /1   ]  1.93379660756        1
[INPUT] 1    0    [1    /1   ]  2.78069715772        1
[INPUT] 1    0    [1    /1   ]  13.3312616413        1
[INPUT] 1    0    [1    /1   ]  0.60149084905        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.193940425738, 1.0]], [0, [215.56120926637908, 1.0]], [0, [1429.446266954578, 1.0]], [0, [0.5740386787420491, 1.0]], [0, [48.286754252084506, 1.0]], [0, [13.025786437175737, 1.0]], [0, [1.9337966075613329, 1.0]], [1, [2.7806971577179866, 1.0]], [1, [13.331261641253398, 1.0]], [1, [0.6014908490497404, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19394043]
bas 1, expnt(s) = [215.56120927]
bas 2, expnt(s) = [1429.44626695]
bas 3, expnt(s) = [0.57403868]
bas 4, expnt(s) = [48.28675425]
bas 5, expnt(s) = [13.02578644]
bas 6, expnt(s) = [1.93379661]
bas 7, expnt(s) = [2.78069716]
bas 8, expnt(s) = [13.33126164]
bas 9, expnt(s) = [0.60149085]
CPU time:        32.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419394e+03 7.96091657e+02 2.15561209e+02 1.42132365e+02
 1.42944627e+03 5.87341787e+02 5.74038679e-01 1.66617606e+00
 4.82867543e+01 4.62792204e+01 1.30257864e+01 1.73227959e+01
 1.93379661e+00 4.14307810e+00 2.78069716e+00 1.04755422e+01
 1.33312616e+01 7.43144825e+01 6.01490849e-01 1.54532800e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96550462976625
cond(S) = 156.40702641157327
E1 = -183.1367680495785  E_coul = 55.011893656309645
init E= -128.124874393269
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742829915324549  LUMO = 2.66278720434974
  mo_energy =
[-3.25130686e+01 -1.85355377e+00 -7.42829915e-01 -7.42829915e-01
 -7.42829915e-01  2.66278720e+00  2.66278720e+00  2.66278720e+00
  2.76327890e+00  1.99726347e+01  1.99726347e+01  1.99726347e+01
  4.41053359e+01  3.19268288e+02  1.98475067e+03  7.27391013e+03]
E1 = -182.13713032207008  E_coul = 53.941928039676625
cycle= 1 E= -128.195202282393  delta_E= -0.0703  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260973
diis-c [-0.06810715  1.        ]
  HOMO = -0.807387774800736  LUMO = 2.60895871645039
  mo_energy =
[-3.27856032e+01 -1.92021145e+00 -8.07387775e-01 -8.07387775e-01
 -8.07387775e-01  2.60895872e+00  2.60895872e+00  2.60895872e+00
  2.70996813e+00  1.97826983e+01  1.97826983e+01  1.97826983e+01
  4.38726713e+01  3.18959795e+02  1.98439122e+03  7.27352522e+03]
E1 = -182.59717084587857  E_coul = 54.40034934844682
cycle= 2 E= -128.196821497432  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0638
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101416
diis-c [-4.4877824e-04  2.7604017e-01  7.2395983e-01]
  HOMO = -0.784694171758908  LUMO = 2.6295401227596
  mo_energy =
[-3.27110207e+01 -1.89666138e+00 -7.84694172e-01 -7.84694172e-01
 -7.84694172e-01  2.62954012e+00  2.62954012e+00  2.62954012e+00
  2.73006124e+00  1.98387061e+01  1.98387061e+01  1.98387061e+01
  4.39381973e+01  3.19041141e+02  1.98447818e+03  7.27361368e+03]
E1 = -182.46542514920876  E_coul = 54.268301718870575
cycle= 3 E= -128.197123430338  delta_E= -0.000302  |g|= 0.000793  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107764
diis-c [-6.03716991e-08 -3.57224570e-03  1.22364011e-03  1.00234861e+00]
  HOMO = -0.784972734295829  LUMO = 2.62932187287412
  mo_energy =
[-3.27118267e+01 -1.89700129e+00 -7.84972734e-01 -7.84972734e-01
 -7.84972734e-01  2.62932187e+00  2.62932187e+00  2.62932187e+00
  2.72979136e+00  1.98380789e+01  1.98380789e+01  1.98380789e+01
  4.39374513e+01  3.19040470e+02  1.98447763e+03  7.27361316e+03]
E1 = -182.46695544463975  E_coul = 54.26983197059857
cycle= 4 E= -128.197123474041  delta_E= -4.37e-08  |g|= 4.36e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.99095e-05
diis-c [-1.93416406e-10  4.48942682e-04 -1.16247802e-03 -1.59250055e-01
  1.15996359e+00]
  HOMO = -0.784960172626531  LUMO = 2.6293328089234
  mo_energy =
[-3.27117942e+01 -1.89699873e+00 -7.84960173e-01 -7.84960173e-01
 -7.84960173e-01  2.62933281e+00  2.62933281e+00  2.62933281e+00
  2.72979291e+00  1.98381041e+01  1.98381041e+01  1.98381041e+01
  4.39374775e+01  3.19040515e+02  1.98447769e+03  7.27361322e+03]
E1 = -182.46690084133587  E_coul = 54.269777367080145
cycle= 5 E= -128.197123474256  delta_E= -2.15e-10  |g|= 1.61e-06  |ddm|= 2.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46690084133587  E_coul = 54.269777367080145
  HOMO = -0.784960041918387  LUMO = 2.6293329333827
  mo_energy =
[-3.27117939e+01 -1.89699900e+00 -7.84960042e-01 -7.84960042e-01
 -7.84960042e-01  2.62933293e+00  2.62933293e+00  2.62933293e+00
  2.72979268e+00  1.98381042e+01  1.98381042e+01  1.98381042e+01
  4.39374776e+01  3.19040515e+02  1.98447769e+03  7.27361322e+03]
E1 = -182.46690050234525  E_coul = 54.269777028089244
Extra cycle  E= -128.197123474256  delta_E= -2.84e-13  |g|= 3.05e-07  |ddm|= 9.23e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.40702641157327
E1 = -182.46690050234525  E_coul = 54.269777028089244
init E= -128.197123474256
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.784960048873971  LUMO = 2.6293329254438
  mo_energy =
[-3.27117940e+01 -1.89699908e+00 -7.84960049e-01 -7.84960049e-01
 -7.84960049e-01  2.62933293e+00  2.62933293e+00  2.62933293e+00
  2.72979260e+00  1.98381042e+01  1.98381042e+01  1.98381042e+01
  4.39374776e+01  3.19040515e+02  1.98447769e+03  7.27361322e+03]
E1 = -182.46690064612915  E_coul = 54.26977717187295
cycle= 1 E= -128.197123474256  delta_E= -1.71e-13  |g|= 5.59e-08  |ddm|= 1.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46690064612915  E_coul = 54.26977717187295
  HOMO = -0.784960035998643  LUMO = 2.62933293683766
  mo_energy =
[-3.27117940e+01 -1.89699908e+00 -7.84960036e-01 -7.84960036e-01
 -7.84960036e-01  2.62933294e+00  2.62933294e+00  2.62933294e+00
  2.72979260e+00  1.98381042e+01  1.98381042e+01  1.98381042e+01
  4.39374776e+01  3.19040515e+02  1.98447769e+03  7.27361322e+03]
E1 = -182.46690059133007  E_coul = 54.269777117073936
Extra cycle  E= -128.197123474256  delta_E= 5.68e-14  |g|= 1.29e-08  |ddm|= 2.85e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419394e+03 2.15561209e+02 1.42944627e+03 5.74038679e-01
 4.82867543e+01 1.30257864e+01 1.93379661e+00 2.78069716e+00
 1.33312616e+01 6.01490849e-01]
grad_E = [-7.58413201e-06 -2.73718630e-04  4.54187062e-05 -1.08702292e-03
  2.54464534e-04 -5.20300667e-05  1.91320170e-03  7.52336234e-04
 -1.74517717e-04  3.00203368e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19490483        1
[INPUT] 0    0    [1    /1   ]  215.601801261        1
[INPUT] 0    0    [1    /1   ]  1429.4403471         1
[INPUT] 0    0    [1    /1   ]  0.571376799982       1
[INPUT] 0    0    [1    /1   ]  48.2245467148        1
[INPUT] 0    0    [1    /1   ]  13.0063902739        1
[INPUT] 0    0    [1    /1   ]  1.92901123456        1
[INPUT] 1    0    [1    /1   ]  2.78031025648        1
[INPUT] 1    0    [1    /1   ]  13.3313035858        1
[INPUT] 1    0    [1    /1   ]  0.602255677947       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1949048274128, 1.0]], [0, [215.60180126072603, 1.0]], [0, [1429.4403470985608, 1.0]], [0, [0.5713767999821259, 1.0]], [0, [48.224546714798045, 1.0]], [0, [13.006390273933794, 1.0]], [0, [1.929011234558565, 1.0]], [1, [2.7803102564801576, 1.0]], [1, [13.331303585819061, 1.0]], [1, [0.6022556779472901, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19490483]
bas 1, expnt(s) = [215.60180126]
bas 2, expnt(s) = [1429.4403471]
bas 3, expnt(s) = [0.5713768]
bas 4, expnt(s) = [48.22454671]
bas 5, expnt(s) = [13.00639027]
bas 6, expnt(s) = [1.92901123]
bas 7, expnt(s) = [2.78031026]
bas 8, expnt(s) = [13.33130359]
bas 9, expnt(s) = [0.60225568]
CPU time:        34.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419490e+03 7.96091925e+02 2.15601801e+02 1.42152438e+02
 1.42944035e+03 5.87339963e+02 5.71376800e-01 1.66037802e+00
 4.82245467e+01 4.62344973e+01 1.30063903e+01 1.73034463e+01
 1.92901123e+00 4.13538637e+00 2.78031026e+00 1.04737202e+01
 1.33313036e+01 7.43147747e+01 6.02255678e-01 1.54778460e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965413776305923
cond(S) = 156.3279775221917
E1 = -183.1375332355028  E_coul = 55.01263095938283
init E= -128.12490227612
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742762651632824  LUMO = 2.66524006380318
  mo_energy =
[-3.25129006e+01 -1.85354760e+00 -7.42762652e-01 -7.42762652e-01
 -7.42762652e-01  2.66524006e+00  2.66524006e+00  2.66524006e+00
  2.74741318e+00  1.99737970e+01  1.99737970e+01  1.99737970e+01
  4.39949800e+01  3.19025297e+02  1.98456820e+03  7.27375424e+03]
E1 = -182.14288083671266  E_coul = 53.947642499942134
cycle= 1 E= -128.195238336771  delta_E= -0.0703  |g|= 0.164  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260044
diis-c [-0.06762304  1.        ]
  HOMO = -0.806943952541884  LUMO = 2.61175375512316
  mo_energy =
[-3.27846654e+01 -1.91962989e+00 -8.06943953e-01 -8.06943953e-01
 -8.06943953e-01  2.61175376e+00  2.61175376e+00  2.61175376e+00
  2.69485855e+00  1.97846541e+01  1.97846541e+01  1.97846541e+01
  4.37631885e+01  3.18717450e+02  1.98420924e+03  7.27336979e+03]
E1 = -182.60081466591166  E_coul = 54.403970372448136
cycle= 2 E= -128.196844293464  delta_E= -0.00161  |g|= 0.062  |ddm|= 0.0634
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.100898
diis-c [-4.44322993e-04  2.75726092e-01  7.24273908e-01]
  HOMO = -0.784343828592334  LUMO = 2.63225129468286
  mo_energy =
[-3.27103935e+01 -1.89617727e+00 -7.84343829e-01 -7.84343829e-01
 -7.84343829e-01  2.63225129e+00  2.63225129e+00  2.63225129e+00
  2.71479890e+00  1.98404247e+01  1.98404247e+01  1.98404247e+01
  4.38284184e+01  3.18798458e+02  1.98429584e+03  7.27345788e+03]
E1 = -182.4697276549108  E_coul = 54.27258448896168
cycle= 3 E= -128.197143165949  delta_E= -0.000299  |g|= 0.000789  |ddm|= 0.0181
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109615
diis-c [-4.66176011e-08 -3.49803596e-03  1.71564253e-03  1.00178239e+00]
  HOMO = -0.784626192625163  LUMO = 2.63202957953359
  mo_energy =
[-3.27112075e+01 -1.89651142e+00 -7.84626193e-01 -7.84626193e-01
 -7.84626193e-01  2.63202958e+00  2.63202958e+00  2.63202958e+00
  2.71453500e+00  1.98397920e+01  1.98397920e+01  1.98397920e+01
  4.38276676e+01  3.18797776e+02  1.98429527e+03  7.27345734e+03]
E1 = -182.47126829414165  E_coul = 54.27412508525941
cycle= 4 E= -128.197143208882  delta_E= -4.29e-08  |g|= 3.69e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.98267e-05
diis-c [-1.74316586e-10  4.04802518e-04 -1.07134594e-03 -1.44193413e-01
  1.14485996e+00]
  HOMO = -0.784615302194962  LUMO = 2.63203905886417
  mo_energy =
[-3.27111792e+01 -1.89650861e+00 -7.84615302e-01 -7.84615302e-01
 -7.84615302e-01  2.63203906e+00  2.63203906e+00  2.63203906e+00
  2.71453685e+00  1.98398140e+01  1.98398140e+01  1.98398140e+01
  4.38276906e+01  3.18797814e+02  1.98429532e+03  7.27345740e+03]
E1 = -182.47122069619678  E_coul = 54.27407748716519
cycle= 5 E= -128.197143209032  delta_E= -1.49e-10  |g|= 1.69e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47122069619678  E_coul = 54.27407748716519
  HOMO = -0.784615104926601  LUMO = 2.63203924168556
  mo_energy =
[-3.27111787e+01 -1.89650883e+00 -7.84615105e-01 -7.84615105e-01
 -7.84615105e-01  2.63203924e+00  2.63203924e+00  2.63203924e+00
  2.71453665e+00  1.98398143e+01  1.98398143e+01  1.98398143e+01
  4.38276909e+01  3.18797815e+02  1.98429532e+03  7.27345740e+03]
E1 = -182.4712200306227  E_coul = 54.274076821590725
Extra cycle  E= -128.197143209032  delta_E= -3.98e-13  |g|= 3.33e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419490e+03 2.15601801e+02 1.42944035e+03 5.71376800e-01
 4.82245467e+01 1.30063903e+01 1.92901123e+00 2.78031026e+00
 1.33313036e+01 6.02255678e-01]
E = -128.197143209032
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:42:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19490483        1
[INPUT] 0    0    [1    /1   ]  215.601801261        1
[INPUT] 0    0    [1    /1   ]  1429.4403471         1
[INPUT] 0    0    [1    /1   ]  0.571376799982       1
[INPUT] 0    0    [1    /1   ]  48.2245467148        1
[INPUT] 0    0    [1    /1   ]  13.0063902739        1
[INPUT] 0    0    [1    /1   ]  1.92901123456        1
[INPUT] 1    0    [1    /1   ]  2.78031025648        1
[INPUT] 1    0    [1    /1   ]  13.3313035858        1
[INPUT] 1    0    [1    /1   ]  0.602255677947       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1949048274128, 1.0]], [0, [215.60180126072603, 1.0]], [0, [1429.4403470985608, 1.0]], [0, [0.5713767999821259, 1.0]], [0, [48.224546714798045, 1.0]], [0, [13.006390273933794, 1.0]], [0, [1.929011234558565, 1.0]], [1, [2.7803102564801576, 1.0]], [1, [13.331303585819061, 1.0]], [1, [0.6022556779472901, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19490483]
bas 1, expnt(s) = [215.60180126]
bas 2, expnt(s) = [1429.4403471]
bas 3, expnt(s) = [0.5713768]
bas 4, expnt(s) = [48.22454671]
bas 5, expnt(s) = [13.00639027]
bas 6, expnt(s) = [1.92901123]
bas 7, expnt(s) = [2.78031026]
bas 8, expnt(s) = [13.33130359]
bas 9, expnt(s) = [0.60225568]
CPU time:        34.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419490e+03 7.96091925e+02 2.15601801e+02 1.42152438e+02
 1.42944035e+03 5.87339963e+02 5.71376800e-01 1.66037802e+00
 4.82245467e+01 4.62344973e+01 1.30063903e+01 1.73034463e+01
 1.92901123e+00 4.13538637e+00 2.78031026e+00 1.04737202e+01
 1.33313036e+01 7.43147747e+01 6.02255678e-01 1.54778460e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965413776305923
cond(S) = 156.3279775221917
E1 = -183.1375332355028  E_coul = 55.01263095938283
init E= -128.12490227612
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742762651632824  LUMO = 2.66524006380318
  mo_energy =
[-3.25129006e+01 -1.85354760e+00 -7.42762652e-01 -7.42762652e-01
 -7.42762652e-01  2.66524006e+00  2.66524006e+00  2.66524006e+00
  2.74741318e+00  1.99737970e+01  1.99737970e+01  1.99737970e+01
  4.39949800e+01  3.19025297e+02  1.98456820e+03  7.27375424e+03]
E1 = -182.14288083671266  E_coul = 53.947642499942134
cycle= 1 E= -128.195238336771  delta_E= -0.0703  |g|= 0.164  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260044
diis-c [-0.06762304  1.        ]
  HOMO = -0.806943952541884  LUMO = 2.61175375512316
  mo_energy =
[-3.27846654e+01 -1.91962989e+00 -8.06943953e-01 -8.06943953e-01
 -8.06943953e-01  2.61175376e+00  2.61175376e+00  2.61175376e+00
  2.69485855e+00  1.97846541e+01  1.97846541e+01  1.97846541e+01
  4.37631885e+01  3.18717450e+02  1.98420924e+03  7.27336979e+03]
E1 = -182.60081466591166  E_coul = 54.403970372448136
cycle= 2 E= -128.196844293464  delta_E= -0.00161  |g|= 0.062  |ddm|= 0.0634
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.100898
diis-c [-4.44322993e-04  2.75726092e-01  7.24273908e-01]
  HOMO = -0.784343828592334  LUMO = 2.63225129468286
  mo_energy =
[-3.27103935e+01 -1.89617727e+00 -7.84343829e-01 -7.84343829e-01
 -7.84343829e-01  2.63225129e+00  2.63225129e+00  2.63225129e+00
  2.71479890e+00  1.98404247e+01  1.98404247e+01  1.98404247e+01
  4.38284184e+01  3.18798458e+02  1.98429584e+03  7.27345788e+03]
E1 = -182.4697276549108  E_coul = 54.27258448896168
cycle= 3 E= -128.197143165949  delta_E= -0.000299  |g|= 0.000789  |ddm|= 0.0181
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109615
diis-c [-4.66176011e-08 -3.49803596e-03  1.71564253e-03  1.00178239e+00]
  HOMO = -0.784626192625163  LUMO = 2.63202957953359
  mo_energy =
[-3.27112075e+01 -1.89651142e+00 -7.84626193e-01 -7.84626193e-01
 -7.84626193e-01  2.63202958e+00  2.63202958e+00  2.63202958e+00
  2.71453500e+00  1.98397920e+01  1.98397920e+01  1.98397920e+01
  4.38276676e+01  3.18797776e+02  1.98429527e+03  7.27345734e+03]
E1 = -182.47126829414165  E_coul = 54.27412508525941
cycle= 4 E= -128.197143208882  delta_E= -4.29e-08  |g|= 3.69e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.98267e-05
diis-c [-1.74316586e-10  4.04802518e-04 -1.07134594e-03 -1.44193413e-01
  1.14485996e+00]
  HOMO = -0.784615302194962  LUMO = 2.63203905886417
  mo_energy =
[-3.27111792e+01 -1.89650861e+00 -7.84615302e-01 -7.84615302e-01
 -7.84615302e-01  2.63203906e+00  2.63203906e+00  2.63203906e+00
  2.71453685e+00  1.98398140e+01  1.98398140e+01  1.98398140e+01
  4.38276906e+01  3.18797814e+02  1.98429532e+03  7.27345740e+03]
E1 = -182.47122069619678  E_coul = 54.27407748716519
cycle= 5 E= -128.197143209032  delta_E= -1.49e-10  |g|= 1.69e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47122069619678  E_coul = 54.27407748716519
  HOMO = -0.784615104926601  LUMO = 2.63203924168556
  mo_energy =
[-3.27111787e+01 -1.89650883e+00 -7.84615105e-01 -7.84615105e-01
 -7.84615105e-01  2.63203924e+00  2.63203924e+00  2.63203924e+00
  2.71453665e+00  1.98398143e+01  1.98398143e+01  1.98398143e+01
  4.38276909e+01  3.18797815e+02  1.98429532e+03  7.27345740e+03]
E1 = -182.4712200306227  E_coul = 54.274076821590725
Extra cycle  E= -128.197143209032  delta_E= -3.98e-13  |g|= 3.33e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.3279775221917
E1 = -182.4712200306227  E_coul = 54.274076821590725
init E= -128.197143209032
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78461513312886  LUMO = 2.63203921444435
  mo_energy =
[-3.27111789e+01 -1.89650894e+00 -7.84615133e-01 -7.84615133e-01
 -7.84615133e-01  2.63203921e+00  2.63203921e+00  2.63203921e+00
  2.71453655e+00  1.98398142e+01  1.98398142e+01  1.98398142e+01
  4.38276908e+01  3.18797815e+02  1.98429532e+03  7.27345740e+03]
E1 = -182.47122030617092  E_coul = 54.274077097138964
cycle= 1 E= -128.197143209032  delta_E= 2.84e-14  |g|= 6.54e-08  |ddm|= 1.94e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.47122030617092  E_coul = 54.274077097138964
  HOMO = -0.784615111062948  LUMO = 2.63203923415878
  mo_energy =
[-3.27111788e+01 -1.89650893e+00 -7.84615111e-01 -7.84615111e-01
 -7.84615111e-01  2.63203923e+00  2.63203923e+00  2.63203923e+00
  2.71453656e+00  1.98398142e+01  1.98398142e+01  1.98398142e+01
  4.38276908e+01  3.18797815e+02  1.98429532e+03  7.27345740e+03]
E1 = -182.47122019956237  E_coul = 54.274076990530475
Extra cycle  E= -128.197143209032  delta_E= 8.53e-14  |g|= 1.85e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419490e+03 2.15601801e+02 1.42944035e+03 5.71376800e-01
 4.82245467e+01 1.30063903e+01 1.92901123e+00 2.78031026e+00
 1.33313036e+01 6.02255678e-01]
grad_E = [-7.62558565e-06 -2.56497133e-04  4.51899588e-05 -4.54229675e-03
  1.71549300e-04 -9.36259935e-05  2.54333327e-03 -1.52253077e-03
 -6.22658841e-05  1.31313543e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19597333        1
[INPUT] 0    0    [1    /1   ]  215.646524942        1
[INPUT] 0    0    [1    /1   ]  1429.43379353        1
[INPUT] 0    0    [1    /1   ]  0.567521011447       1
[INPUT] 0    0    [1    /1   ]  48.1580591792        1
[INPUT] 0    0    [1    /1   ]  12.9786107723        1
[INPUT] 0    0    [1    /1   ]  1.91883065209        1
[INPUT] 1    0    [1    /1   ]  2.77998353395        1
[INPUT] 1    0    [1    /1   ]  13.3313889269        1
[INPUT] 1    0    [1    /1   ]  0.6016526562         1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1959733331328, 1.0]], [0, [215.64652494152062, 1.0]], [0, [1429.433793525961, 1.0]], [0, [0.5675210114466905, 1.0]], [0, [48.15805917919986, 1.0]], [0, [12.978610772304723, 1.0]], [0, [1.9188306520884744, 1.0]], [1, [2.779983533949124, 1.0]], [1, [13.331388926867243, 1.0]], [1, [0.6016526562003812, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19597333]
bas 1, expnt(s) = [215.64652494]
bas 2, expnt(s) = [1429.43379353]
bas 3, expnt(s) = [0.56752101]
bas 4, expnt(s) = [48.15805918]
bas 5, expnt(s) = [12.97861077]
bas 6, expnt(s) = [1.91883065]
bas 7, expnt(s) = [2.77998353]
bas 8, expnt(s) = [13.33138893]
bas 9, expnt(s) = [0.60165266]
CPU time:        36.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419597e+03 7.96092223e+02 2.15646525e+02 1.42174553e+02
 1.42943379e+03 5.87337943e+02 5.67521011e-01 1.65196744e+00
 4.81580592e+01 4.61866812e+01 1.29786108e+01 1.72757209e+01
 1.91883065e+00 4.11900681e+00 2.77998353e+00 1.04721818e+01
 1.33313889e+01 7.43153694e+01 6.01652656e-01 1.54584765e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96558294028506
cond(S) = 156.210057310003
E1 = -183.1374610059194  E_coul = 55.01237185891047
init E= -128.125089147009
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742811126856628  LUMO = 2.66295514827842
  mo_energy =
[-3.25127824e+01 -1.85369658e+00 -7.42811127e-01 -7.42811127e-01
 -7.42811127e-01  2.66295515e+00  2.66295515e+00  2.66295515e+00
  2.72036364e+00  1.99710917e+01  1.99710917e+01  1.99710917e+01
  4.38343471e+01  3.18719193e+02  1.98433645e+03  7.27355430e+03]
E1 = -182.1328501172673  E_coul = 53.93761658373639
cycle= 1 E= -128.195233533531  delta_E= -0.0701  |g|= 0.165  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262047
diis-c [-0.06866877  1.        ]
  HOMO = -0.807768080646025  LUMO = 2.60877933032947
  mo_energy =
[-3.27863725e+01 -1.92048257e+00 -8.07768081e-01 -8.07768081e-01
 -8.07768081e-01  2.60877933e+00  2.60877933e+00  2.60877933e+00
  2.66766178e+00  1.97803987e+01  1.97803987e+01  1.97803987e+01
  4.36010188e+01  3.18409361e+02  1.98397534e+03  7.27316765e+03]
E1 = -182.59482670613468  E_coul = 54.397962545048436
cycle= 2 E= -128.196864161086  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0638
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101783
diis-c [-4.42884069e-04  2.76019388e-01  7.23980612e-01]
  HOMO = -0.784973627943397  LUMO = 2.6294464461828
  mo_energy =
[-3.27114956e+01 -1.89682584e+00 -7.84973628e-01 -7.84973628e-01
 -7.84973628e-01  2.62944645e+00  2.62944645e+00  2.62944645e+00
  2.68764354e+00  1.98366332e+01  1.98366332e+01  1.98366332e+01
  4.36667562e+01  3.18491006e+02  1.98406259e+03  7.27325641e+03]
E1 = -182.4624718835801  E_coul = 54.265303317042346
cycle= 3 E= -128.197168566538  delta_E= -0.000304  |g|= 0.000784  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00110546
diis-c [-3.92513930e-08 -3.43061524e-03  1.93455747e-03  1.00149606e+00]
  HOMO = -0.785257872501457  LUMO = 2.62922372203913
  mo_energy =
[-3.27123112e+01 -1.89715658e+00 -7.85257873e-01 -7.85257873e-01
 -7.85257873e-01  2.62922372e+00  2.62922372e+00  2.62922372e+00
  2.68738478e+00  1.98359990e+01  1.98359990e+01  1.98359990e+01
  4.36660053e+01  3.18490316e+02  1.98406201e+03  7.27325585e+03]
E1 = -182.4640154245266  E_coul = 54.26684681547981
cycle= 4 E= -128.197168609047  delta_E= -4.25e-08  |g|= 3.3e-05  |ddm|= 0.000255
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.38519e-05
diis-c [-1.54559372e-10  3.81061025e-04 -9.96878625e-04 -1.36735713e-01
  1.13735153e+00]
  HOMO = -0.785248025768381  LUMO = 2.62923227823737
  mo_energy =
[-3.27122856e+01 -1.89715383e+00 -7.85248026e-01 -7.85248026e-01
 -7.85248026e-01  2.62923228e+00  2.62923228e+00  2.62923228e+00
  2.68738662e+00  1.98360190e+01  1.98360190e+01  1.98360190e+01
  4.36660261e+01  3.18490351e+02  1.98406205e+03  7.27325590e+03]
E1 = -182.4639723367204  E_coul = 54.26680372755487
cycle= 5 E= -128.197168609166  delta_E= -1.19e-10  |g|= 1.67e-06  |ddm|= 1.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4639723367204  E_coul = 54.26680372755487
  HOMO = -0.785247793591502  LUMO = 2.6292324923647
  mo_energy =
[-3.27122850e+01 -1.89715401e+00 -7.85247794e-01 -7.85247794e-01
 -7.85247794e-01  2.62923249e+00  2.62923249e+00  2.62923249e+00
  2.68738645e+00  1.98360194e+01  1.98360194e+01  1.98360194e+01
  4.36660265e+01  3.18490352e+02  1.98406206e+03  7.27325590e+03]
E1 = -182.46397149275452  E_coul = 54.26680288358883
Extra cycle  E= -128.197168609166  delta_E= -1.71e-13  |g|= 3.39e-07  |ddm|= 9.35e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419597e+03 2.15646525e+02 1.42943379e+03 5.67521011e-01
 4.81580592e+01 1.29786108e+01 1.91883065e+00 2.77998353e+00
 1.33313889e+01 6.01652656e-01]
E = -128.1971686091657
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19597333        1
[INPUT] 0    0    [1    /1   ]  215.646524942        1
[INPUT] 0    0    [1    /1   ]  1429.43379353        1
[INPUT] 0    0    [1    /1   ]  0.567521011447       1
[INPUT] 0    0    [1    /1   ]  48.1580591792        1
[INPUT] 0    0    [1    /1   ]  12.9786107723        1
[INPUT] 0    0    [1    /1   ]  1.91883065209        1
[INPUT] 1    0    [1    /1   ]  2.77998353395        1
[INPUT] 1    0    [1    /1   ]  13.3313889269        1
[INPUT] 1    0    [1    /1   ]  0.6016526562         1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1959733331328, 1.0]], [0, [215.64652494152062, 1.0]], [0, [1429.433793525961, 1.0]], [0, [0.5675210114466905, 1.0]], [0, [48.15805917919986, 1.0]], [0, [12.978610772304723, 1.0]], [0, [1.9188306520884744, 1.0]], [1, [2.779983533949124, 1.0]], [1, [13.331388926867243, 1.0]], [1, [0.6016526562003812, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19597333]
bas 1, expnt(s) = [215.64652494]
bas 2, expnt(s) = [1429.43379353]
bas 3, expnt(s) = [0.56752101]
bas 4, expnt(s) = [48.15805918]
bas 5, expnt(s) = [12.97861077]
bas 6, expnt(s) = [1.91883065]
bas 7, expnt(s) = [2.77998353]
bas 8, expnt(s) = [13.33138893]
bas 9, expnt(s) = [0.60165266]
CPU time:        36.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419597e+03 7.96092223e+02 2.15646525e+02 1.42174553e+02
 1.42943379e+03 5.87337943e+02 5.67521011e-01 1.65196744e+00
 4.81580592e+01 4.61866812e+01 1.29786108e+01 1.72757209e+01
 1.91883065e+00 4.11900681e+00 2.77998353e+00 1.04721818e+01
 1.33313889e+01 7.43153694e+01 6.01652656e-01 1.54584765e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96558294028506
cond(S) = 156.210057310003
E1 = -183.1374610059194  E_coul = 55.01237185891047
init E= -128.125089147009
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742811126856628  LUMO = 2.66295514827842
  mo_energy =
[-3.25127824e+01 -1.85369658e+00 -7.42811127e-01 -7.42811127e-01
 -7.42811127e-01  2.66295515e+00  2.66295515e+00  2.66295515e+00
  2.72036364e+00  1.99710917e+01  1.99710917e+01  1.99710917e+01
  4.38343471e+01  3.18719193e+02  1.98433645e+03  7.27355430e+03]
E1 = -182.1328501172673  E_coul = 53.93761658373639
cycle= 1 E= -128.195233533531  delta_E= -0.0701  |g|= 0.165  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262047
diis-c [-0.06866877  1.        ]
  HOMO = -0.807768080646025  LUMO = 2.60877933032947
  mo_energy =
[-3.27863725e+01 -1.92048257e+00 -8.07768081e-01 -8.07768081e-01
 -8.07768081e-01  2.60877933e+00  2.60877933e+00  2.60877933e+00
  2.66766178e+00  1.97803987e+01  1.97803987e+01  1.97803987e+01
  4.36010188e+01  3.18409361e+02  1.98397534e+03  7.27316765e+03]
E1 = -182.59482670613468  E_coul = 54.397962545048436
cycle= 2 E= -128.196864161086  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0638
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101783
diis-c [-4.42884069e-04  2.76019388e-01  7.23980612e-01]
  HOMO = -0.784973627943397  LUMO = 2.6294464461828
  mo_energy =
[-3.27114956e+01 -1.89682584e+00 -7.84973628e-01 -7.84973628e-01
 -7.84973628e-01  2.62944645e+00  2.62944645e+00  2.62944645e+00
  2.68764354e+00  1.98366332e+01  1.98366332e+01  1.98366332e+01
  4.36667562e+01  3.18491006e+02  1.98406259e+03  7.27325641e+03]
E1 = -182.4624718835801  E_coul = 54.265303317042346
cycle= 3 E= -128.197168566538  delta_E= -0.000304  |g|= 0.000784  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00110546
diis-c [-3.92513930e-08 -3.43061524e-03  1.93455747e-03  1.00149606e+00]
  HOMO = -0.785257872501457  LUMO = 2.62922372203913
  mo_energy =
[-3.27123112e+01 -1.89715658e+00 -7.85257873e-01 -7.85257873e-01
 -7.85257873e-01  2.62922372e+00  2.62922372e+00  2.62922372e+00
  2.68738478e+00  1.98359990e+01  1.98359990e+01  1.98359990e+01
  4.36660053e+01  3.18490316e+02  1.98406201e+03  7.27325585e+03]
E1 = -182.4640154245266  E_coul = 54.26684681547981
cycle= 4 E= -128.197168609047  delta_E= -4.25e-08  |g|= 3.3e-05  |ddm|= 0.000255
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.38519e-05
diis-c [-1.54559372e-10  3.81061025e-04 -9.96878625e-04 -1.36735713e-01
  1.13735153e+00]
  HOMO = -0.785248025768381  LUMO = 2.62923227823737
  mo_energy =
[-3.27122856e+01 -1.89715383e+00 -7.85248026e-01 -7.85248026e-01
 -7.85248026e-01  2.62923228e+00  2.62923228e+00  2.62923228e+00
  2.68738662e+00  1.98360190e+01  1.98360190e+01  1.98360190e+01
  4.36660261e+01  3.18490351e+02  1.98406205e+03  7.27325590e+03]
E1 = -182.4639723367204  E_coul = 54.26680372755487
cycle= 5 E= -128.197168609166  delta_E= -1.19e-10  |g|= 1.67e-06  |ddm|= 1.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4639723367204  E_coul = 54.26680372755487
  HOMO = -0.785247793591502  LUMO = 2.6292324923647
  mo_energy =
[-3.27122850e+01 -1.89715401e+00 -7.85247794e-01 -7.85247794e-01
 -7.85247794e-01  2.62923249e+00  2.62923249e+00  2.62923249e+00
  2.68738645e+00  1.98360194e+01  1.98360194e+01  1.98360194e+01
  4.36660265e+01  3.18490352e+02  1.98406206e+03  7.27325590e+03]
E1 = -182.46397149275452  E_coul = 54.26680288358883
Extra cycle  E= -128.197168609166  delta_E= -1.71e-13  |g|= 3.39e-07  |ddm|= 9.35e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.210057310003
E1 = -182.46397149275452  E_coul = 54.26680288358883
init E= -128.197168609166
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785247834023184  LUMO = 2.62923245407658
  mo_energy =
[-3.27122852e+01 -1.89715413e+00 -7.85247834e-01 -7.85247834e-01
 -7.85247834e-01  2.62923245e+00  2.62923245e+00  2.62923245e+00
  2.68738635e+00  1.98360192e+01  1.98360192e+01  1.98360192e+01
  4.36660263e+01  3.18490352e+02  1.98406206e+03  7.27325590e+03]
E1 = -182.46397184123654  E_coul = 54.26680323207092
cycle= 1 E= -128.197168609166  delta_E= 5.68e-14  |g|= 7.03e-08  |ddm|= 1.97e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46397184123654  E_coul = 54.26680323207092
  HOMO = -0.785247806976014  LUMO = 2.6292324783011
  mo_energy =
[-3.27122851e+01 -1.89715412e+00 -7.85247807e-01 -7.85247807e-01
 -7.85247807e-01  2.62923248e+00  2.62923248e+00  2.62923248e+00
  2.68738636e+00  1.98360193e+01  1.98360193e+01  1.98360193e+01
  4.36660264e+01  3.18490352e+02  1.98406206e+03  7.27325590e+03]
E1 = -182.46397170580786  E_coul = 54.26680309664212
Extra cycle  E= -128.197168609166  delta_E= -1.14e-13  |g|= 2.18e-08  |ddm|= 3.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419597e+03 2.15646525e+02 1.42943379e+03 5.67521011e-01
 4.81580592e+01 1.29786108e+01 1.91883065e+00 2.77998353e+00
 1.33313889e+01 6.01652656e-01]
grad_E = [-7.66333243e-06 -2.42436117e-04  4.49832640e-05 -7.79284400e-03
  1.52990984e-04 -4.04176552e-04  2.98127711e-03 -3.52552728e-04
 -9.68223625e-05  6.82552833e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19760635        1
[INPUT] 0    0    [1    /1   ]  215.714919828        1
[INPUT] 0    0    [1    /1   ]  1429.42377768        1
[INPUT] 0    0    [1    /1   ]  0.562342164167       1
[INPUT] 0    0    [1    /1   ]  48.0547377044        1
[INPUT] 0    0    [1    /1   ]  12.9465667764        1
[INPUT] 0    0    [1    /1   ]  1.89163425514        1
[INPUT] 1    0    [1    /1   ]  2.77802860958        1
[INPUT] 1    0    [1    /1   ]  13.3317446334        1
[INPUT] 1    0    [1    /1   ]  0.601819827717       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1976063485336, 1.0]], [0, [215.71491982833737, 1.0]], [0, [1429.4237776785544, 1.0]], [0, [0.5623421641671345, 1.0]], [0, [48.054737704355254, 1.0]], [0, [12.946566776364707, 1.0]], [0, [1.8916342551387055, 1.0]], [1, [2.7780286095816096, 1.0]], [1, [13.33174463338265, 1.0]], [1, [0.6018198277165245, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19760635]
bas 1, expnt(s) = [215.71491983]
bas 2, expnt(s) = [1429.42377768]
bas 3, expnt(s) = [0.56234216]
bas 4, expnt(s) = [48.0547377]
bas 5, expnt(s) = [12.94656678]
bas 6, expnt(s) = [1.89163426]
bas 7, expnt(s) = [2.77802861]
bas 8, expnt(s) = [13.33174463]
bas 9, expnt(s) = [0.60181983]
CPU time:        39.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419761e+03 7.96092678e+02 2.15714920e+02 1.42208371e+02
 1.42942378e+03 5.87334857e+02 5.62342164e-01 1.64064837e+00
 4.80547377e+01 4.61123423e+01 1.29465668e+01 1.72437209e+01
 1.89163426e+00 4.07514346e+00 2.77802861e+00 1.04629773e+01
 1.33317446e+01 7.43178480e+01 6.01819828e-01 1.54638457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965651878698297
cond(S) = 156.00813838388487
E1 = -183.13759847218185  E_coul = 55.01218864027096
init E= -128.125409831911
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74278966456647  LUMO = 2.66250751307898
  mo_energy =
[-3.25127192e+01 -1.85391674e+00 -7.42789665e-01 -7.42789665e-01
 -7.42789665e-01  2.66250751e+00  2.66250751e+00  2.66250751e+00
  2.66853856e+00  1.99656302e+01  1.99656302e+01  1.99656302e+01
  4.35663352e+01  3.18246595e+02  1.98397989e+03  7.27324672e+03]
E1 = -182.13620361211736  E_coul = 53.94092667268039
cycle= 1 E= -128.195276939437  delta_E= -0.0699  |g|= 0.164  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260915
diis-c [-0.06807679  1.        ]
  HOMO = -0.807435891220501  LUMO = 2.608633338098
  mo_energy =
[-3.27858894e+01 -1.92031931e+00 -8.07435891e-01 -8.07435891e-01
 -8.07435891e-01  2.60863334e+00  2.60863334e+00  2.60863334e+00
  2.61717061e+00  1.97755096e+01  1.97755096e+01  1.97755096e+01
  4.33338240e+01  3.17937061e+02  1.98361884e+03  7.27286009e+03]
E1 = -182.59667133171547  E_coul = 54.39977485473982
cycle= 2 E= -128.196896476976  delta_E= -0.00162  |g|= 0.0622  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101373
diis-c [-4.38154560e-04  2.76088366e-01  7.23911634e-01]
  HOMO = -0.784707926174476  LUMO = 2.6292264469538
  mo_energy =
[-3.27112902e+01 -1.89674541e+00 -7.84707926e-01 -7.84707926e-01
 -7.84707926e-01  2.62922645e+00  2.62922645e+00  2.62922645e+00
  2.63679426e+00  1.98315416e+01  1.98315416e+01  1.98315416e+01
  4.33992822e+01  3.18018406e+02  1.98370578e+03  7.27294853e+03]
E1 = -182.46483157882463  E_coul = 54.267633121450075
cycle= 3 E= -128.197198457375  delta_E= -0.000302  |g|= 0.000768  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107552
diis-c [-4.00850143e-08 -3.45471822e-03  1.60791478e-03  1.00184680e+00]
  HOMO = -0.784985152537717  LUMO = 2.62901002076597
  mo_energy =
[-3.27120865e+01 -1.89706931e+00 -7.84985153e-01 -7.84985153e-01
 -7.84985153e-01  2.62901002e+00  2.62901002e+00  2.62901002e+00
  2.63654509e+00  1.98309231e+01  1.98309231e+01  1.98309231e+01
  4.33985495e+01  3.18017741e+02  1.98370522e+03  7.27294800e+03]
E1 = -182.46633972082412  E_coul = 54.26914122283004
cycle= 4 E= -128.197198497994  delta_E= -4.06e-08  |g|= 3.36e-05  |ddm|= 0.000251
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.48359e-05
diis-c [-1.67732864e-10  3.79395415e-04 -9.64105590e-04 -1.35519885e-01
  1.13610459e+00]
  HOMO = -0.78497502852322  LUMO = 2.62901881447993
  mo_energy =
[-3.27120603e+01 -1.89706637e+00 -7.84975029e-01 -7.84975029e-01
 -7.84975029e-01  2.62901881e+00  2.62901881e+00  2.62901881e+00
  2.63654703e+00  1.98309435e+01  1.98309435e+01  1.98309435e+01
  4.33985709e+01  3.18017777e+02  1.98370527e+03  7.27294805e+03]
E1 = -182.46629577115863  E_coul = 54.269097273042036
cycle= 5 E= -128.197198498117  delta_E= -1.22e-10  |g|= 1.74e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46629577115863  E_coul = 54.269097273042036
  HOMO = -0.784974783507774  LUMO = 2.62901903982217
  mo_energy =
[-3.27120597e+01 -1.89706656e+00 -7.84974784e-01 -7.84974784e-01
 -7.84974784e-01  2.62901904e+00  2.62901904e+00  2.62901904e+00
  2.63654687e+00  1.98309440e+01  1.98309440e+01  1.98309440e+01
  4.33985713e+01  3.18017777e+02  1.98370527e+03  7.27294805e+03]
E1 = -182.46629490037975  E_coul = 54.26909640226253
Extra cycle  E= -128.197198498117  delta_E= -6.25e-13  |g|= 3.53e-07  |ddm|= 9.79e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419761e+03 2.15714920e+02 1.42942378e+03 5.62342164e-01
 4.80547377e+01 1.29465668e+01 1.89163426e+00 2.77802861e+00
 1.33317446e+01 6.01819828e-01]
E = -128.19719849811722
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19760635        1
[INPUT] 0    0    [1    /1   ]  215.714919828        1
[INPUT] 0    0    [1    /1   ]  1429.42377768        1
[INPUT] 0    0    [1    /1   ]  0.562342164167       1
[INPUT] 0    0    [1    /1   ]  48.0547377044        1
[INPUT] 0    0    [1    /1   ]  12.9465667764        1
[INPUT] 0    0    [1    /1   ]  1.89163425514        1
[INPUT] 1    0    [1    /1   ]  2.77802860958        1
[INPUT] 1    0    [1    /1   ]  13.3317446334        1
[INPUT] 1    0    [1    /1   ]  0.601819827717       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1976063485336, 1.0]], [0, [215.71491982833737, 1.0]], [0, [1429.4237776785544, 1.0]], [0, [0.5623421641671345, 1.0]], [0, [48.054737704355254, 1.0]], [0, [12.946566776364707, 1.0]], [0, [1.8916342551387055, 1.0]], [1, [2.7780286095816096, 1.0]], [1, [13.33174463338265, 1.0]], [1, [0.6018198277165245, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19760635]
bas 1, expnt(s) = [215.71491983]
bas 2, expnt(s) = [1429.42377768]
bas 3, expnt(s) = [0.56234216]
bas 4, expnt(s) = [48.0547377]
bas 5, expnt(s) = [12.94656678]
bas 6, expnt(s) = [1.89163426]
bas 7, expnt(s) = [2.77802861]
bas 8, expnt(s) = [13.33174463]
bas 9, expnt(s) = [0.60181983]
CPU time:        39.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419761e+03 7.96092678e+02 2.15714920e+02 1.42208371e+02
 1.42942378e+03 5.87334857e+02 5.62342164e-01 1.64064837e+00
 4.80547377e+01 4.61123423e+01 1.29465668e+01 1.72437209e+01
 1.89163426e+00 4.07514346e+00 2.77802861e+00 1.04629773e+01
 1.33317446e+01 7.43178480e+01 6.01819828e-01 1.54638457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965651878698297
cond(S) = 156.00813838388487
E1 = -183.13759847218185  E_coul = 55.01218864027096
init E= -128.125409831911
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74278966456647  LUMO = 2.66250751307898
  mo_energy =
[-3.25127192e+01 -1.85391674e+00 -7.42789665e-01 -7.42789665e-01
 -7.42789665e-01  2.66250751e+00  2.66250751e+00  2.66250751e+00
  2.66853856e+00  1.99656302e+01  1.99656302e+01  1.99656302e+01
  4.35663352e+01  3.18246595e+02  1.98397989e+03  7.27324672e+03]
E1 = -182.13620361211736  E_coul = 53.94092667268039
cycle= 1 E= -128.195276939437  delta_E= -0.0699  |g|= 0.164  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260915
diis-c [-0.06807679  1.        ]
  HOMO = -0.807435891220501  LUMO = 2.608633338098
  mo_energy =
[-3.27858894e+01 -1.92031931e+00 -8.07435891e-01 -8.07435891e-01
 -8.07435891e-01  2.60863334e+00  2.60863334e+00  2.60863334e+00
  2.61717061e+00  1.97755096e+01  1.97755096e+01  1.97755096e+01
  4.33338240e+01  3.17937061e+02  1.98361884e+03  7.27286009e+03]
E1 = -182.59667133171547  E_coul = 54.39977485473982
cycle= 2 E= -128.196896476976  delta_E= -0.00162  |g|= 0.0622  |ddm|= 0.0637
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101373
diis-c [-4.38154560e-04  2.76088366e-01  7.23911634e-01]
  HOMO = -0.784707926174476  LUMO = 2.6292264469538
  mo_energy =
[-3.27112902e+01 -1.89674541e+00 -7.84707926e-01 -7.84707926e-01
 -7.84707926e-01  2.62922645e+00  2.62922645e+00  2.62922645e+00
  2.63679426e+00  1.98315416e+01  1.98315416e+01  1.98315416e+01
  4.33992822e+01  3.18018406e+02  1.98370578e+03  7.27294853e+03]
E1 = -182.46483157882463  E_coul = 54.267633121450075
cycle= 3 E= -128.197198457375  delta_E= -0.000302  |g|= 0.000768  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107552
diis-c [-4.00850143e-08 -3.45471822e-03  1.60791478e-03  1.00184680e+00]
  HOMO = -0.784985152537717  LUMO = 2.62901002076597
  mo_energy =
[-3.27120865e+01 -1.89706931e+00 -7.84985153e-01 -7.84985153e-01
 -7.84985153e-01  2.62901002e+00  2.62901002e+00  2.62901002e+00
  2.63654509e+00  1.98309231e+01  1.98309231e+01  1.98309231e+01
  4.33985495e+01  3.18017741e+02  1.98370522e+03  7.27294800e+03]
E1 = -182.46633972082412  E_coul = 54.26914122283004
cycle= 4 E= -128.197198497994  delta_E= -4.06e-08  |g|= 3.36e-05  |ddm|= 0.000251
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.48359e-05
diis-c [-1.67732864e-10  3.79395415e-04 -9.64105590e-04 -1.35519885e-01
  1.13610459e+00]
  HOMO = -0.78497502852322  LUMO = 2.62901881447993
  mo_energy =
[-3.27120603e+01 -1.89706637e+00 -7.84975029e-01 -7.84975029e-01
 -7.84975029e-01  2.62901881e+00  2.62901881e+00  2.62901881e+00
  2.63654703e+00  1.98309435e+01  1.98309435e+01  1.98309435e+01
  4.33985709e+01  3.18017777e+02  1.98370527e+03  7.27294805e+03]
E1 = -182.46629577115863  E_coul = 54.269097273042036
cycle= 5 E= -128.197198498117  delta_E= -1.22e-10  |g|= 1.74e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46629577115863  E_coul = 54.269097273042036
  HOMO = -0.784974783507774  LUMO = 2.62901903982217
  mo_energy =
[-3.27120597e+01 -1.89706656e+00 -7.84974784e-01 -7.84974784e-01
 -7.84974784e-01  2.62901904e+00  2.62901904e+00  2.62901904e+00
  2.63654687e+00  1.98309440e+01  1.98309440e+01  1.98309440e+01
  4.33985713e+01  3.18017777e+02  1.98370527e+03  7.27294805e+03]
E1 = -182.46629490037975  E_coul = 54.26909640226253
Extra cycle  E= -128.197198498117  delta_E= -6.25e-13  |g|= 3.53e-07  |ddm|= 9.79e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.00813838388487
E1 = -182.46629490037975  E_coul = 54.26909640226253
init E= -128.197198498117
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.784974824761328  LUMO = 2.62901900072476
  mo_energy =
[-3.27120599e+01 -1.89706668e+00 -7.84974825e-01 -7.84974825e-01
 -7.84974825e-01  2.62901900e+00  2.62901900e+00  2.62901900e+00
  2.63654676e+00  1.98309438e+01  1.98309438e+01  1.98309438e+01
  4.33985711e+01  3.18017777e+02  1.98370527e+03  7.27294805e+03]
E1 = -182.4662952634989  E_coul = 54.269096765381676
cycle= 1 E= -128.197198498117  delta_E=    0  |g|= 7.34e-08  |ddm|= 2.07e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4662952634989  E_coul = 54.269096765381676
  HOMO = -0.78497479649817  LUMO = 2.62901902601661
  mo_energy =
[-3.27120598e+01 -1.89706667e+00 -7.84974796e-01 -7.84974796e-01
 -7.84974796e-01  2.62901903e+00  2.62901903e+00  2.62901903e+00
  2.63654677e+00  1.98309439e+01  1.98309439e+01  1.98309439e+01
  4.33985712e+01  3.18017777e+02  1.98370527e+03  7.27294805e+03]
E1 = -182.46629512312236  E_coul = 54.26909662500518
Extra cycle  E= -128.197198498117  delta_E= 2.84e-14  |g|= 2.27e-08  |ddm|= 3.2e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419761e+03 2.15714920e+02 1.42942378e+03 5.62342164e-01
 4.80547377e+01 1.29465668e+01 1.89163426e+00 2.77802861e+00
 1.33317446e+01 6.01819828e-01]
grad_E = [-7.73447919e-06 -2.11638020e-04  4.45876916e-05 -5.18478501e-03
 -1.72758141e-05 -3.11119253e-04  1.15645506e-03 -2.66722585e-03
  8.89083580e-05  1.39594442e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19792344        1
[INPUT] 0    0    [1    /1   ]  215.72816572         1
[INPUT] 0    0    [1    /1   ]  1429.42183393        1
[INPUT] 0    0    [1    /1   ]  0.562876093373       1
[INPUT] 0    0    [1    /1   ]  48.034589071         1
[INPUT] 0    0    [1    /1   ]  12.9416687992        1
[INPUT] 0    0    [1    /1   ]  1.88876181415        1
[INPUT] 1    0    [1    /1   ]  2.7780263303         1
[INPUT] 1    0    [1    /1   ]  13.3317773034        1
[INPUT] 1    0    [1    /1   ]  0.60044208983        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197923437935, 1.0]], [0, [215.72816572010038, 1.0]], [0, [1429.4218339325644, 1.0]], [0, [0.5628760933728079, 1.0]], [0, [48.03458907102084, 1.0]], [0, [12.941668799195963, 1.0]], [0, [1.8887618141484717, 1.0]], [1, [2.778026330302839, 1.0]], [1, [13.33177730338741, 1.0]], [1, [0.6004420898301814, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19792344]
bas 1, expnt(s) = [215.72816572]
bas 2, expnt(s) = [1429.42183393]
bas 3, expnt(s) = [0.56287609]
bas 4, expnt(s) = [48.03458907]
bas 5, expnt(s) = [12.9416688]
bas 6, expnt(s) = [1.88876181]
bas 7, expnt(s) = [2.77802633]
bas 8, expnt(s) = [13.3317773]
bas 9, expnt(s) = [0.60044209]
CPU time:        41.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419792e+03 7.96092766e+02 2.15728166e+02 1.42214920e+02
 1.42942183e+03 5.87334258e+02 5.62876093e-01 1.64181654e+00
 4.80345891e+01 4.60978408e+01 1.29416688e+01 1.72388279e+01
 1.88876181e+00 4.07050150e+00 2.77802633e+00 1.04629666e+01
 1.33317773e+01 7.43180756e+01 6.00442090e-01 1.54196069e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965890839093506
cond(S) = 155.99240880351223
E1 = -183.13660408521034  E_coul = 55.01096951131782
init E= -128.125634573893
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742909244271335  LUMO = 2.65770538409224
  mo_energy =
[-3.25128875e+01 -1.85404809e+00 -7.42909244e-01 -7.42909244e-01
 -7.42909244e-01  2.65770538e+00  2.65770538e+00  2.65770538e+00
  2.66684124e+00  1.99614696e+01  1.99614696e+01  1.99614696e+01
  4.35340445e+01  3.18172593e+02  1.98392519e+03  7.27320034e+03]
E1 = -182.12262309881913  E_coul = 53.92737277344058
cycle= 1 E= -128.195250325379  delta_E= -0.0696  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263237
diis-c [-0.06929394  1.        ]
  HOMO = -0.808504937562534  LUMO = 2.60298382772079
  mo_energy =
[-3.27881848e+01 -1.92160851e+00 -8.08504938e-01 -8.08504938e-01
 -8.08504938e-01  2.60298383e+00  2.60298383e+00  2.60298383e+00
  2.61454584e+00  1.97693984e+01  1.97693984e+01  1.97693984e+01
  4.32995823e+01  3.17860961e+02  1.98356201e+03  7.27281159e+03]
E1 = -182.58826673083462  E_coul = 54.391364859616345
cycle= 2 E= -128.196901871218  delta_E= -0.00165  |g|= 0.0629  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102573
diis-c [-4.41643851e-04  2.76733359e-01  7.23266641e-01]
  HOMO = -0.785539045919729  LUMO = 2.62378481482965
  mo_energy =
[-3.27128282e+01 -1.89778768e+00 -7.85539046e-01 -7.85539046e-01
 -7.85539046e-01  2.62378481e+00  2.62378481e+00  2.62378481e+00
  2.63435312e+00  1.98260112e+01  1.98260112e+01  1.98260112e+01
  4.33656999e+01  3.17943116e+02  1.98364980e+03  7.27290088e+03]
E1 = -182.45481998578225  E_coul = 54.25760880631237
cycle= 3 E= -128.19721117947  delta_E= -0.000309  |g|= 0.000765  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104627
diis-c [-5.19831378e-08 -3.52353273e-03  9.73748347e-04  1.00254978e+00]
  HOMO = -0.785810055547634  LUMO = 2.62357449814735
  mo_energy =
[-3.27136083e+01 -1.89811486e+00 -7.85810056e-01 -7.85810056e-01
 -7.85810056e-01  2.62357450e+00  2.62357450e+00  2.62357450e+00
  2.63410162e+00  1.98254044e+01  1.98254044e+01  1.98254044e+01
  4.33649798e+01  3.17942470e+02  1.98364927e+03  7.27290038e+03]
E1 = -182.45630456208698  E_coul = 54.25909334205718
cycle= 4 E= -128.19721122003  delta_E= -4.06e-08  |g|= 4.03e-05  |ddm|= 0.000263
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.48262e-05
diis-c [-1.93027907e-10  4.37619941e-04 -1.03283558e-03 -1.54896655e-01
  1.15549187e+00]
  HOMO = -0.785798245755898  LUMO = 2.62358474884453
  mo_energy =
[-3.27135780e+01 -1.89811222e+00 -7.85798246e-01 -7.85798246e-01
 -7.85798246e-01  2.62358475e+00  2.62358475e+00  2.62358475e+00
  2.63410320e+00  1.98254280e+01  1.98254280e+01  1.98254280e+01
  4.33650043e+01  3.17942511e+02  1.98364933e+03  7.27290044e+03]
E1 = -182.4562538775229  E_coul = 54.2590426573094
cycle= 5 E= -128.197211220213  delta_E= -1.84e-10  |g|= 1.65e-06  |ddm|= 1.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4562538775229  E_coul = 54.2590426573094
  HOMO = -0.785798073208357  LUMO = 2.62358491179393
  mo_energy =
[-3.27135776e+01 -1.89811246e+00 -7.85798073e-01 -7.85798073e-01
 -7.85798073e-01  2.62358491e+00  2.62358491e+00  2.62358491e+00
  2.63410299e+00  1.98254283e+01  1.98254283e+01  1.98254283e+01
  4.33650045e+01  3.17942512e+02  1.98364933e+03  7.27290044e+03]
E1 = -182.45625336914222  E_coul = 54.259042148928344
Extra cycle  E= -128.197211220214  delta_E= -3.98e-13  |g|= 3.21e-07  |ddm|= 9.5e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419792e+03 2.15728166e+02 1.42942183e+03 5.62876093e-01
 4.80345891e+01 1.29416688e+01 1.88876181e+00 2.77802633e+00
 1.33317773e+01 6.00442090e-01]
E = -128.1972112202139
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19792344        1
[INPUT] 0    0    [1    /1   ]  215.72816572         1
[INPUT] 0    0    [1    /1   ]  1429.42183393        1
[INPUT] 0    0    [1    /1   ]  0.562876093373       1
[INPUT] 0    0    [1    /1   ]  48.034589071         1
[INPUT] 0    0    [1    /1   ]  12.9416687992        1
[INPUT] 0    0    [1    /1   ]  1.88876181415        1
[INPUT] 1    0    [1    /1   ]  2.7780263303         1
[INPUT] 1    0    [1    /1   ]  13.3317773034        1
[INPUT] 1    0    [1    /1   ]  0.60044208983        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197923437935, 1.0]], [0, [215.72816572010038, 1.0]], [0, [1429.4218339325644, 1.0]], [0, [0.5628760933728079, 1.0]], [0, [48.03458907102084, 1.0]], [0, [12.941668799195963, 1.0]], [0, [1.8887618141484717, 1.0]], [1, [2.778026330302839, 1.0]], [1, [13.33177730338741, 1.0]], [1, [0.6004420898301814, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19792344]
bas 1, expnt(s) = [215.72816572]
bas 2, expnt(s) = [1429.42183393]
bas 3, expnt(s) = [0.56287609]
bas 4, expnt(s) = [48.03458907]
bas 5, expnt(s) = [12.9416688]
bas 6, expnt(s) = [1.88876181]
bas 7, expnt(s) = [2.77802633]
bas 8, expnt(s) = [13.3317773]
bas 9, expnt(s) = [0.60044209]
CPU time:        42.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419792e+03 7.96092766e+02 2.15728166e+02 1.42214920e+02
 1.42942183e+03 5.87334258e+02 5.62876093e-01 1.64181654e+00
 4.80345891e+01 4.60978408e+01 1.29416688e+01 1.72388279e+01
 1.88876181e+00 4.07050150e+00 2.77802633e+00 1.04629666e+01
 1.33317773e+01 7.43180756e+01 6.00442090e-01 1.54196069e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965890839093506
cond(S) = 155.99240880351223
E1 = -183.13660408521034  E_coul = 55.01096951131782
init E= -128.125634573893
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742909244271335  LUMO = 2.65770538409224
  mo_energy =
[-3.25128875e+01 -1.85404809e+00 -7.42909244e-01 -7.42909244e-01
 -7.42909244e-01  2.65770538e+00  2.65770538e+00  2.65770538e+00
  2.66684124e+00  1.99614696e+01  1.99614696e+01  1.99614696e+01
  4.35340445e+01  3.18172593e+02  1.98392519e+03  7.27320034e+03]
E1 = -182.12262309881913  E_coul = 53.92737277344058
cycle= 1 E= -128.195250325379  delta_E= -0.0696  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263237
diis-c [-0.06929394  1.        ]
  HOMO = -0.808504937562534  LUMO = 2.60298382772079
  mo_energy =
[-3.27881848e+01 -1.92160851e+00 -8.08504938e-01 -8.08504938e-01
 -8.08504938e-01  2.60298383e+00  2.60298383e+00  2.60298383e+00
  2.61454584e+00  1.97693984e+01  1.97693984e+01  1.97693984e+01
  4.32995823e+01  3.17860961e+02  1.98356201e+03  7.27281159e+03]
E1 = -182.58826673083462  E_coul = 54.391364859616345
cycle= 2 E= -128.196901871218  delta_E= -0.00165  |g|= 0.0629  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102573
diis-c [-4.41643851e-04  2.76733359e-01  7.23266641e-01]
  HOMO = -0.785539045919729  LUMO = 2.62378481482965
  mo_energy =
[-3.27128282e+01 -1.89778768e+00 -7.85539046e-01 -7.85539046e-01
 -7.85539046e-01  2.62378481e+00  2.62378481e+00  2.62378481e+00
  2.63435312e+00  1.98260112e+01  1.98260112e+01  1.98260112e+01
  4.33656999e+01  3.17943116e+02  1.98364980e+03  7.27290088e+03]
E1 = -182.45481998578225  E_coul = 54.25760880631237
cycle= 3 E= -128.19721117947  delta_E= -0.000309  |g|= 0.000765  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104627
diis-c [-5.19831378e-08 -3.52353273e-03  9.73748347e-04  1.00254978e+00]
  HOMO = -0.785810055547634  LUMO = 2.62357449814735
  mo_energy =
[-3.27136083e+01 -1.89811486e+00 -7.85810056e-01 -7.85810056e-01
 -7.85810056e-01  2.62357450e+00  2.62357450e+00  2.62357450e+00
  2.63410162e+00  1.98254044e+01  1.98254044e+01  1.98254044e+01
  4.33649798e+01  3.17942470e+02  1.98364927e+03  7.27290038e+03]
E1 = -182.45630456208698  E_coul = 54.25909334205718
cycle= 4 E= -128.19721122003  delta_E= -4.06e-08  |g|= 4.03e-05  |ddm|= 0.000263
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.48262e-05
diis-c [-1.93027907e-10  4.37619941e-04 -1.03283558e-03 -1.54896655e-01
  1.15549187e+00]
  HOMO = -0.785798245755898  LUMO = 2.62358474884453
  mo_energy =
[-3.27135780e+01 -1.89811222e+00 -7.85798246e-01 -7.85798246e-01
 -7.85798246e-01  2.62358475e+00  2.62358475e+00  2.62358475e+00
  2.63410320e+00  1.98254280e+01  1.98254280e+01  1.98254280e+01
  4.33650043e+01  3.17942511e+02  1.98364933e+03  7.27290044e+03]
E1 = -182.4562538775229  E_coul = 54.2590426573094
cycle= 5 E= -128.197211220213  delta_E= -1.84e-10  |g|= 1.65e-06  |ddm|= 1.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4562538775229  E_coul = 54.2590426573094
  HOMO = -0.785798073208357  LUMO = 2.62358491179393
  mo_energy =
[-3.27135776e+01 -1.89811246e+00 -7.85798073e-01 -7.85798073e-01
 -7.85798073e-01  2.62358491e+00  2.62358491e+00  2.62358491e+00
  2.63410299e+00  1.98254283e+01  1.98254283e+01  1.98254283e+01
  4.33650045e+01  3.17942512e+02  1.98364933e+03  7.27290044e+03]
E1 = -182.45625336914222  E_coul = 54.259042148928344
Extra cycle  E= -128.197211220214  delta_E= -3.98e-13  |g|= 3.21e-07  |ddm|= 9.5e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155.99240880351223
E1 = -182.45625336914222  E_coul = 54.259042148928344
init E= -128.197211220214
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785798090662848  LUMO = 2.6235848942768
  mo_energy =
[-3.27135777e+01 -1.89811256e+00 -7.85798091e-01 -7.85798091e-01
 -7.85798091e-01  2.62358489e+00  2.62358489e+00  2.62358489e+00
  2.63410291e+00  1.98254282e+01  1.98254282e+01  1.98254282e+01
  4.33650044e+01  3.17942512e+02  1.98364933e+03  7.27290044e+03]
E1 = -182.45625358703558  E_coul = 54.25904236682178
cycle= 1 E= -128.197211220214  delta_E= 8.53e-14  |g|= 6.14e-08  |ddm|= 1.89e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45625358703558  E_coul = 54.25904236682178
  HOMO = -0.785798072491207  LUMO = 2.62358491043191
  mo_energy =
[-3.27135777e+01 -1.89811255e+00 -7.85798072e-01 -7.85798072e-01
 -7.85798072e-01  2.62358491e+00  2.62358491e+00  2.62358491e+00
  2.63410291e+00  1.98254282e+01  1.98254282e+01  1.98254282e+01
  4.33650045e+01  3.17942512e+02  1.98364933e+03  7.27290044e+03]
E1 = -182.45625350386103  E_coul = 54.25904228364722
Extra cycle  E= -128.197211220214  delta_E= -2.84e-14  |g|= 1.6e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419792e+03 2.15728166e+02 1.42942183e+03 5.62876093e-01
 4.80345891e+01 1.29416688e+01 1.88876181e+00 2.77802633e+00
 1.33317773e+01 6.00442090e-01]
grad_E = [-7.74906893e-06 -2.05156680e-04  4.45071541e-05 -2.28437512e-03
 -5.61979372e-05 -3.09055903e-04  3.91356531e-04  7.51884799e-04
 -5.35734467e-05 -2.48134459e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19778138        1
[INPUT] 0    0    [1    /1   ]  215.722317808        1
[INPUT] 0    0    [1    /1   ]  1429.42270334        1
[INPUT] 0    0    [1    /1   ]  0.564283072983       1
[INPUT] 0    0    [1    /1   ]  48.0422487801        1
[INPUT] 0    0    [1    /1   ]  12.9492669857        1
[INPUT] 0    0    [1    /1   ]  1.89135278162        1
[INPUT] 1    0    [1    /1   ]  2.77778463305        1
[INPUT] 1    0    [1    /1   ]  13.3317978734        1
[INPUT] 1    0    [1    /1   ]  0.600555203125       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197781376776, 1.0]], [0, [215.72231780784503, 1.0]], [0, [1429.422703339025, 1.0]], [0, [0.5642830729826892, 1.0]], [0, [48.04224878007209, 1.0]], [0, [12.949266985744151, 1.0]], [0, [1.8913527816150715, 1.0]], [1, [2.777784633052133, 1.0]], [1, [13.331797873397093, 1.0]], [1, [0.6005552031251478, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19778138]
bas 1, expnt(s) = [215.72231781]
bas 2, expnt(s) = [1429.42270334]
bas 3, expnt(s) = [0.56428307]
bas 4, expnt(s) = [48.04224878]
bas 5, expnt(s) = [12.94926699]
bas 6, expnt(s) = [1.89135278]
bas 7, expnt(s) = [2.77778463]
bas 8, expnt(s) = [13.33179787]
bas 9, expnt(s) = [0.6005552]
CPU time:        44.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419778e+03 7.96092726e+02 2.15722318e+02 1.42212029e+02
 1.42942270e+03 5.87334526e+02 5.64283073e-01 1.64489353e+00
 4.80422488e+01 4.61033539e+01 1.29492670e+01 1.72464182e+01
 1.89135278e+00 4.07468866e+00 2.77778463e+00 1.04618287e+01
 1.33317979e+01 7.43182190e+01 6.00555203e-01 1.54232380e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965852342918762
cond(S) = 156.02410875739648
E1 = -183.13659230551076  E_coul = 55.01097065622117
init E= -128.12562164929
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74289797634977  LUMO = 2.65797958836133
  mo_energy =
[-3.25129495e+01 -1.85400920e+00 -7.42897976e-01 -7.42897976e-01
 -7.42897976e-01  2.65797959e+00  2.65797959e+00  2.65797959e+00
  2.67525467e+00  1.99610407e+01  1.99610407e+01  1.99610407e+01
  4.35731406e+01  3.18231697e+02  1.98397092e+03  7.27324066e+03]
E1 = -182.1257992891407  E_coul = 53.93053639082482
cycle= 1 E= -128.195262898316  delta_E= -0.0696  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262519
diis-c [-0.06891646  1.        ]
  HOMO = -0.80823572718249  LUMO = 2.60349367500158
  mo_energy =
[-3.27876600e+01 -1.92135830e+00 -8.08235727e-01 -8.08235727e-01
 -8.08235727e-01  2.60349368e+00  2.60349368e+00  2.60349368e+00
  2.62300065e+00  1.97694792e+01  1.97694792e+01  1.97694792e+01
  4.33392028e+01  3.17920715e+02  1.98360843e+03  7.27285260e+03]
E1 = -182.590135252977  E_coul = 54.39322892048296
cycle= 2 E= -128.196906332494  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102287
diis-c [-4.42202640e-04  2.76694814e-01  7.23305186e-01]
  HOMO = -0.785333842345122  LUMO = 2.62423610790256
  mo_energy =
[-3.27125057e+01 -1.89760573e+00 -7.85333842e-01 -7.85333842e-01
 -7.85333842e-01  2.62423611e+00  2.62423611e+00  2.62423611e+00
  2.64278995e+00  1.98259377e+01  1.98259377e+01  1.98259377e+01
  4.34051466e+01  3.18002659e+02  1.98369601e+03  7.27294168e+03]
E1 = -182.45710736307439  E_coul = 54.259893541582585
cycle= 3 E= -128.197213821492  delta_E= -0.000307  |g|= 0.000765  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103584
diis-c [-5.69796250e-08 -3.56780323e-03  7.53807222e-04  1.00281400e+00]
  HOMO = -0.785602436595904  LUMO = 2.62402775114606
  mo_energy =
[-3.27132805e+01 -1.89793361e+00 -7.85602437e-01 -7.85602437e-01
 -7.85602437e-01  2.62402775e+00  2.62402775e+00  2.62402775e+00
  2.64253717e+00  1.98253351e+01  1.98253351e+01  1.98253351e+01
  4.34044305e+01  3.18002022e+02  1.98369549e+03  7.27294119e+03]
E1 = -182.45858307091441  E_coul = 54.261369208861595
cycle= 4 E= -128.197213862053  delta_E= -4.06e-08  |g|= 4.26e-05  |ddm|= 0.000266
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.83754e-05
diis-c [-2.03749231e-10  4.49502186e-04 -1.05465678e-03 -1.58296839e-01
  1.15890199e+00]
  HOMO = -0.785590000327515  LUMO = 2.62403854969519
  mo_energy =
[-3.27132486e+01 -1.89793094e+00 -7.85590000e-01 -7.85590000e-01
 -7.85590000e-01  2.62403855e+00  2.62403855e+00  2.62403855e+00
  2.64253874e+00  1.98253599e+01  1.98253599e+01  1.98253599e+01
  4.34044562e+01  3.18002065e+02  1.98369554e+03  7.27294125e+03]
E1 = -182.45852974741243  E_coul = 54.26131588515337
cycle= 5 E= -128.197213862259  delta_E= -2.06e-10  |g|= 1.65e-06  |ddm|= 2.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45852974741243  E_coul = 54.26131588515337
  HOMO = -0.78558984850908  LUMO = 2.62403869426717
  mo_energy =
[-3.27132482e+01 -1.89793120e+00 -7.85589849e-01 -7.85589849e-01
 -7.85589849e-01  2.62403869e+00  2.62403869e+00  2.62403869e+00
  2.64253851e+00  1.98253601e+01  1.98253601e+01  1.98253601e+01
  4.34044564e+01  3.18002066e+02  1.98369554e+03  7.27294125e+03]
E1 = -182.4585293440612  E_coul = 54.26131548180182
Extra cycle  E= -128.197213862259  delta_E= -3.13e-13  |g|= 3.17e-07  |ddm|= 9.55e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419778e+03 2.15722318e+02 1.42942270e+03 5.64283073e-01
 4.80422488e+01 1.29492670e+01 1.89135278e+00 2.77778463e+00
 1.33317979e+01 6.00555203e-01]
E = -128.19721386225936
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19778138        1
[INPUT] 0    0    [1    /1   ]  215.722317808        1
[INPUT] 0    0    [1    /1   ]  1429.42270334        1
[INPUT] 0    0    [1    /1   ]  0.564283072983       1
[INPUT] 0    0    [1    /1   ]  48.0422487801        1
[INPUT] 0    0    [1    /1   ]  12.9492669857        1
[INPUT] 0    0    [1    /1   ]  1.89135278162        1
[INPUT] 1    0    [1    /1   ]  2.77778463305        1
[INPUT] 1    0    [1    /1   ]  13.3317978734        1
[INPUT] 1    0    [1    /1   ]  0.600555203125       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197781376776, 1.0]], [0, [215.72231780784503, 1.0]], [0, [1429.422703339025, 1.0]], [0, [0.5642830729826892, 1.0]], [0, [48.04224878007209, 1.0]], [0, [12.949266985744151, 1.0]], [0, [1.8913527816150715, 1.0]], [1, [2.777784633052133, 1.0]], [1, [13.331797873397093, 1.0]], [1, [0.6005552031251478, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19778138]
bas 1, expnt(s) = [215.72231781]
bas 2, expnt(s) = [1429.42270334]
bas 3, expnt(s) = [0.56428307]
bas 4, expnt(s) = [48.04224878]
bas 5, expnt(s) = [12.94926699]
bas 6, expnt(s) = [1.89135278]
bas 7, expnt(s) = [2.77778463]
bas 8, expnt(s) = [13.33179787]
bas 9, expnt(s) = [0.6005552]
CPU time:        44.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419778e+03 7.96092726e+02 2.15722318e+02 1.42212029e+02
 1.42942270e+03 5.87334526e+02 5.64283073e-01 1.64489353e+00
 4.80422488e+01 4.61033539e+01 1.29492670e+01 1.72464182e+01
 1.89135278e+00 4.07468866e+00 2.77778463e+00 1.04618287e+01
 1.33317979e+01 7.43182190e+01 6.00555203e-01 1.54232380e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965852342918762
cond(S) = 156.02410875739648
E1 = -183.13659230551076  E_coul = 55.01097065622117
init E= -128.12562164929
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74289797634977  LUMO = 2.65797958836133
  mo_energy =
[-3.25129495e+01 -1.85400920e+00 -7.42897976e-01 -7.42897976e-01
 -7.42897976e-01  2.65797959e+00  2.65797959e+00  2.65797959e+00
  2.67525467e+00  1.99610407e+01  1.99610407e+01  1.99610407e+01
  4.35731406e+01  3.18231697e+02  1.98397092e+03  7.27324066e+03]
E1 = -182.1257992891407  E_coul = 53.93053639082482
cycle= 1 E= -128.195262898316  delta_E= -0.0696  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262519
diis-c [-0.06891646  1.        ]
  HOMO = -0.80823572718249  LUMO = 2.60349367500158
  mo_energy =
[-3.27876600e+01 -1.92135830e+00 -8.08235727e-01 -8.08235727e-01
 -8.08235727e-01  2.60349368e+00  2.60349368e+00  2.60349368e+00
  2.62300065e+00  1.97694792e+01  1.97694792e+01  1.97694792e+01
  4.33392028e+01  3.17920715e+02  1.98360843e+03  7.27285260e+03]
E1 = -182.590135252977  E_coul = 54.39322892048296
cycle= 2 E= -128.196906332494  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102287
diis-c [-4.42202640e-04  2.76694814e-01  7.23305186e-01]
  HOMO = -0.785333842345122  LUMO = 2.62423610790256
  mo_energy =
[-3.27125057e+01 -1.89760573e+00 -7.85333842e-01 -7.85333842e-01
 -7.85333842e-01  2.62423611e+00  2.62423611e+00  2.62423611e+00
  2.64278995e+00  1.98259377e+01  1.98259377e+01  1.98259377e+01
  4.34051466e+01  3.18002659e+02  1.98369601e+03  7.27294168e+03]
E1 = -182.45710736307439  E_coul = 54.259893541582585
cycle= 3 E= -128.197213821492  delta_E= -0.000307  |g|= 0.000765  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103584
diis-c [-5.69796250e-08 -3.56780323e-03  7.53807222e-04  1.00281400e+00]
  HOMO = -0.785602436595904  LUMO = 2.62402775114606
  mo_energy =
[-3.27132805e+01 -1.89793361e+00 -7.85602437e-01 -7.85602437e-01
 -7.85602437e-01  2.62402775e+00  2.62402775e+00  2.62402775e+00
  2.64253717e+00  1.98253351e+01  1.98253351e+01  1.98253351e+01
  4.34044305e+01  3.18002022e+02  1.98369549e+03  7.27294119e+03]
E1 = -182.45858307091441  E_coul = 54.261369208861595
cycle= 4 E= -128.197213862053  delta_E= -4.06e-08  |g|= 4.26e-05  |ddm|= 0.000266
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.83754e-05
diis-c [-2.03749231e-10  4.49502186e-04 -1.05465678e-03 -1.58296839e-01
  1.15890199e+00]
  HOMO = -0.785590000327515  LUMO = 2.62403854969519
  mo_energy =
[-3.27132486e+01 -1.89793094e+00 -7.85590000e-01 -7.85590000e-01
 -7.85590000e-01  2.62403855e+00  2.62403855e+00  2.62403855e+00
  2.64253874e+00  1.98253599e+01  1.98253599e+01  1.98253599e+01
  4.34044562e+01  3.18002065e+02  1.98369554e+03  7.27294125e+03]
E1 = -182.45852974741243  E_coul = 54.26131588515337
cycle= 5 E= -128.197213862259  delta_E= -2.06e-10  |g|= 1.65e-06  |ddm|= 2.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45852974741243  E_coul = 54.26131588515337
  HOMO = -0.78558984850908  LUMO = 2.62403869426717
  mo_energy =
[-3.27132482e+01 -1.89793120e+00 -7.85589849e-01 -7.85589849e-01
 -7.85589849e-01  2.62403869e+00  2.62403869e+00  2.62403869e+00
  2.64253851e+00  1.98253601e+01  1.98253601e+01  1.98253601e+01
  4.34044564e+01  3.18002066e+02  1.98369554e+03  7.27294125e+03]
E1 = -182.4585293440612  E_coul = 54.26131548180182
Extra cycle  E= -128.197213862259  delta_E= -3.13e-13  |g|= 3.17e-07  |ddm|= 9.55e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.02410875739648
E1 = -182.4585293440612  E_coul = 54.26131548180182
init E= -128.197213862259
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785589858882609  LUMO = 2.62403868315524
  mo_energy =
[-3.27132483e+01 -1.89793129e+00 -7.85589859e-01 -7.85589859e-01
 -7.85589859e-01  2.62403868e+00  2.62403868e+00  2.62403868e+00
  2.64253844e+00  1.98253600e+01  1.98253600e+01  1.98253600e+01
  4.34044563e+01  3.18002066e+02  1.98369554e+03  7.27294125e+03]
E1 = -182.45852951937434  E_coul = 54.26131565711506
cycle= 1 E= -128.197213862259  delta_E= 8.53e-14  |g|= 5.92e-08  |ddm|= 1.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45852951937434  E_coul = 54.26131565711506
  HOMO = -0.785589843638463  LUMO = 2.62403869665974
  mo_energy =
[-3.27132483e+01 -1.89793129e+00 -7.85589844e-01 -7.85589844e-01
 -7.85589844e-01  2.62403870e+00  2.62403870e+00  2.62403870e+00
  2.64253844e+00  1.98253601e+01  1.98253601e+01  1.98253601e+01
  4.34044563e+01  3.18002066e+02  1.98369554e+03  7.27294125e+03]
E1 = -182.45852945304048  E_coul = 54.261315590781095
Extra cycle  E= -128.197213862259  delta_E= -1.14e-13  |g|= 1.43e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419778e+03 2.15722318e+02 1.42942270e+03 5.64283073e-01
 4.80422488e+01 1.29492670e+01 1.89135278e+00 2.77778463e+00
 1.33317979e+01 6.00555203e-01]
grad_E = [-7.74889558e-06 -2.03935658e-04  4.45070583e-05 -5.69354647e-04
 -9.94810640e-05 -1.05916217e-04  6.60652766e-05  2.33853845e-04
 -2.05723363e-05 -5.36720850e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19780427        1
[INPUT] 0    0    [1    /1   ]  215.723290782        1
[INPUT] 0    0    [1    /1   ]  1429.42256285        1
[INPUT] 0    0    [1    /1   ]  0.564844823858       1
[INPUT] 0    0    [1    /1   ]  48.0403562773        1
[INPUT] 0    0    [1    /1   ]  12.9508901979        1
[INPUT] 0    0    [1    /1   ]  1.89259468037        1
[INPUT] 1    0    [1    /1   ]  2.77759855047        1
[INPUT] 1    0    [1    /1   ]  13.3318166269        1
[INPUT] 1    0    [1    /1   ]  0.600561700692       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197804273081, 1.0]], [0, [215.72329078152816, 1.0]], [0, [1429.422562851542, 1.0]], [0, [0.5648448238576728, 1.0]], [0, [48.04035627729542, 1.0]], [0, [12.950890197862215, 1.0]], [0, [1.8925946803693876, 1.0]], [1, [2.7775985504721628, 1.0]], [1, [13.331816626873884, 1.0]], [1, [0.6005617006917111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19780427]
bas 1, expnt(s) = [215.72329078]
bas 2, expnt(s) = [1429.42256285]
bas 3, expnt(s) = [0.56484482]
bas 4, expnt(s) = [48.04035628]
bas 5, expnt(s) = [12.9508902]
bas 6, expnt(s) = [1.89259468]
bas 7, expnt(s) = [2.77759855]
bas 8, expnt(s) = [13.33181663]
bas 9, expnt(s) = [0.6005617]
CPU time:        46.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419780e+03 7.96092733e+02 2.15723291e+02 1.42212510e+02
 1.42942256e+03 5.87334482e+02 5.64844824e-01 1.64612151e+00
 4.80403563e+01 4.61019918e+01 1.29508902e+01 1.72480396e+01
 1.89259468e+00 4.07669514e+00 2.77759855e+00 1.04609527e+01
 1.33318166e+01 7.43183496e+01 6.00561701e-01 1.54234466e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965844170798896
cond(S) = 156.0345327578612
E1 = -183.13658768753248  E_coul = 55.010959733648825
init E= -128.125627953884
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895577220956  LUMO = 2.65790739962794
  mo_energy =
[-3.25129749e+01 -1.85399331e+00 -7.42895577e-01 -7.42895577e-01
 -7.42895577e-01  2.65790740e+00  2.65790740e+00  2.65790740e+00
  2.67882884e+00  1.99604861e+01  1.99604861e+01  1.99604861e+01
  4.35836762e+01  3.18239224e+02  1.98397754e+03  7.27324704e+03]
E1 = -182.12666782210195  E_coul = 53.9314019547684
cycle= 1 E= -128.195265867334  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262308
diis-c [-0.06880546  1.        ]
  HOMO = -0.80815915004896  LUMO = 2.60349165441294
  mo_energy =
[-3.27875259e+01 -1.92128890e+00 -8.08159150e-01 -8.08159150e-01
 -8.08159150e-01  2.60349165e+00  2.60349165e+00  2.60349165e+00
  2.62656028e+00  1.97690668e+01  1.97690668e+01  1.97690668e+01
  4.33498876e+01  3.17928417e+02  1.98361523e+03  7.27285916e+03]
E1 = -182.59064322587645  E_coul = 54.393736138275806
cycle= 2 E= -128.196907087601  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102209
diis-c [-4.42359847e-04  2.76696549e-01  7.23303451e-01]
  HOMO = -0.785275375369092  LUMO = 2.62421663381847
  mo_energy =
[-3.27124284e+01 -1.89755560e+00 -7.85275375e-01 -7.85275375e-01
 -7.85275375e-01  2.62421663e+00  2.62421663e+00  2.62421663e+00
  2.64635033e+00  1.98254820e+01  1.98254820e+01  1.98254820e+01
  4.34157811e+01  3.18010302e+02  1.98370274e+03  7.27294818e+03]
E1 = -182.45773308929174  E_coul = 54.26051901167013
cycle= 3 E= -128.197214077622  delta_E= -0.000307  |g|= 0.000765  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103118
diis-c [-5.90142302e-08 -3.58613156e-03  6.55438329e-04  1.00293069e+00]
  HOMO = -0.785542876230261  LUMO = 2.62400920768954
  mo_energy =
[-3.27132006e+01 -1.89788361e+00 -7.85542876e-01 -7.85542876e-01
 -7.85542876e-01  2.62400921e+00  2.62400921e+00  2.62400921e+00
  2.64609717e+00  1.98248814e+01  1.98248814e+01  1.98248814e+01
  4.34150671e+01  3.18009668e+02  1.98370223e+03  7.27294770e+03]
E1 = -182.45920439958283  E_coul = 54.261990281433775
cycle= 4 E= -128.197214118149  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.97566e-05
diis-c [-2.07703441e-10  4.54022300e-04 -1.06069070e-03 -1.59549338e-01
  1.16015601e+00]
  HOMO = -0.785530198505598  LUMO = 2.6240202164046
  mo_energy =
[-3.27131680e+01 -1.89788094e+00 -7.85530199e-01 -7.85530199e-01
 -7.85530199e-01  2.62402022e+00  2.62402022e+00  2.62402022e+00
  2.64609873e+00  1.98249067e+01  1.98249067e+01  1.98249067e+01
  4.34150933e+01  3.18009713e+02  1.98370229e+03  7.27294776e+03]
E1 = -182.45915005301322  E_coul = 54.26193593464907
cycle= 5 E= -128.197214118364  delta_E= -2.15e-10  |g|= 1.65e-06  |ddm|= 2.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45915005301322  E_coul = 54.26193593464907
  HOMO = -0.785530054683699  LUMO = 2.62402035392132
  mo_energy =
[-3.27131677e+01 -1.89788121e+00 -7.85530055e-01 -7.85530055e-01
 -7.85530055e-01  2.62402035e+00  2.62402035e+00  2.62402035e+00
  2.64609850e+00  1.98249069e+01  1.98249069e+01  1.98249069e+01
  4.34150934e+01  3.18009713e+02  1.98370229e+03  7.27294776e+03]
E1 = -182.45914968949907  E_coul = 54.26193557113436
Extra cycle  E= -128.197214118365  delta_E= -5.68e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419780e+03 2.15723291e+02 1.42942256e+03 5.64844824e-01
 4.80403563e+01 1.29508902e+01 1.89259468e+00 2.77759855e+00
 1.33318166e+01 6.00561701e-01]
E = -128.1972141183647
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19780427        1
[INPUT] 0    0    [1    /1   ]  215.723290782        1
[INPUT] 0    0    [1    /1   ]  1429.42256285        1
[INPUT] 0    0    [1    /1   ]  0.564844823858       1
[INPUT] 0    0    [1    /1   ]  48.0403562773        1
[INPUT] 0    0    [1    /1   ]  12.9508901979        1
[INPUT] 0    0    [1    /1   ]  1.89259468037        1
[INPUT] 1    0    [1    /1   ]  2.77759855047        1
[INPUT] 1    0    [1    /1   ]  13.3318166269        1
[INPUT] 1    0    [1    /1   ]  0.600561700692       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197804273081, 1.0]], [0, [215.72329078152816, 1.0]], [0, [1429.422562851542, 1.0]], [0, [0.5648448238576728, 1.0]], [0, [48.04035627729542, 1.0]], [0, [12.950890197862215, 1.0]], [0, [1.8925946803693876, 1.0]], [1, [2.7775985504721628, 1.0]], [1, [13.331816626873884, 1.0]], [1, [0.6005617006917111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19780427]
bas 1, expnt(s) = [215.72329078]
bas 2, expnt(s) = [1429.42256285]
bas 3, expnt(s) = [0.56484482]
bas 4, expnt(s) = [48.04035628]
bas 5, expnt(s) = [12.9508902]
bas 6, expnt(s) = [1.89259468]
bas 7, expnt(s) = [2.77759855]
bas 8, expnt(s) = [13.33181663]
bas 9, expnt(s) = [0.6005617]
CPU time:        47.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419780e+03 7.96092733e+02 2.15723291e+02 1.42212510e+02
 1.42942256e+03 5.87334482e+02 5.64844824e-01 1.64612151e+00
 4.80403563e+01 4.61019918e+01 1.29508902e+01 1.72480396e+01
 1.89259468e+00 4.07669514e+00 2.77759855e+00 1.04609527e+01
 1.33318166e+01 7.43183496e+01 6.00561701e-01 1.54234466e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965844170798896
cond(S) = 156.0345327578612
E1 = -183.13658768753248  E_coul = 55.010959733648825
init E= -128.125627953884
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895577220956  LUMO = 2.65790739962794
  mo_energy =
[-3.25129749e+01 -1.85399331e+00 -7.42895577e-01 -7.42895577e-01
 -7.42895577e-01  2.65790740e+00  2.65790740e+00  2.65790740e+00
  2.67882884e+00  1.99604861e+01  1.99604861e+01  1.99604861e+01
  4.35836762e+01  3.18239224e+02  1.98397754e+03  7.27324704e+03]
E1 = -182.12666782210195  E_coul = 53.9314019547684
cycle= 1 E= -128.195265867334  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262308
diis-c [-0.06880546  1.        ]
  HOMO = -0.80815915004896  LUMO = 2.60349165441294
  mo_energy =
[-3.27875259e+01 -1.92128890e+00 -8.08159150e-01 -8.08159150e-01
 -8.08159150e-01  2.60349165e+00  2.60349165e+00  2.60349165e+00
  2.62656028e+00  1.97690668e+01  1.97690668e+01  1.97690668e+01
  4.33498876e+01  3.17928417e+02  1.98361523e+03  7.27285916e+03]
E1 = -182.59064322587645  E_coul = 54.393736138275806
cycle= 2 E= -128.196907087601  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102209
diis-c [-4.42359847e-04  2.76696549e-01  7.23303451e-01]
  HOMO = -0.785275375369092  LUMO = 2.62421663381847
  mo_energy =
[-3.27124284e+01 -1.89755560e+00 -7.85275375e-01 -7.85275375e-01
 -7.85275375e-01  2.62421663e+00  2.62421663e+00  2.62421663e+00
  2.64635033e+00  1.98254820e+01  1.98254820e+01  1.98254820e+01
  4.34157811e+01  3.18010302e+02  1.98370274e+03  7.27294818e+03]
E1 = -182.45773308929174  E_coul = 54.26051901167013
cycle= 3 E= -128.197214077622  delta_E= -0.000307  |g|= 0.000765  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103118
diis-c [-5.90142302e-08 -3.58613156e-03  6.55438329e-04  1.00293069e+00]
  HOMO = -0.785542876230261  LUMO = 2.62400920768954
  mo_energy =
[-3.27132006e+01 -1.89788361e+00 -7.85542876e-01 -7.85542876e-01
 -7.85542876e-01  2.62400921e+00  2.62400921e+00  2.62400921e+00
  2.64609717e+00  1.98248814e+01  1.98248814e+01  1.98248814e+01
  4.34150671e+01  3.18009668e+02  1.98370223e+03  7.27294770e+03]
E1 = -182.45920439958283  E_coul = 54.261990281433775
cycle= 4 E= -128.197214118149  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.97566e-05
diis-c [-2.07703441e-10  4.54022300e-04 -1.06069070e-03 -1.59549338e-01
  1.16015601e+00]
  HOMO = -0.785530198505598  LUMO = 2.6240202164046
  mo_energy =
[-3.27131680e+01 -1.89788094e+00 -7.85530199e-01 -7.85530199e-01
 -7.85530199e-01  2.62402022e+00  2.62402022e+00  2.62402022e+00
  2.64609873e+00  1.98249067e+01  1.98249067e+01  1.98249067e+01
  4.34150933e+01  3.18009713e+02  1.98370229e+03  7.27294776e+03]
E1 = -182.45915005301322  E_coul = 54.26193593464907
cycle= 5 E= -128.197214118364  delta_E= -2.15e-10  |g|= 1.65e-06  |ddm|= 2.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45915005301322  E_coul = 54.26193593464907
  HOMO = -0.785530054683699  LUMO = 2.62402035392132
  mo_energy =
[-3.27131677e+01 -1.89788121e+00 -7.85530055e-01 -7.85530055e-01
 -7.85530055e-01  2.62402035e+00  2.62402035e+00  2.62402035e+00
  2.64609850e+00  1.98249069e+01  1.98249069e+01  1.98249069e+01
  4.34150934e+01  3.18009713e+02  1.98370229e+03  7.27294776e+03]
E1 = -182.45914968949907  E_coul = 54.26193557113436
Extra cycle  E= -128.197214118365  delta_E= -5.68e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.0345327578612
E1 = -182.45914968949907  E_coul = 54.26193557113436
init E= -128.197214118365
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785530062388555  LUMO = 2.62402034522479
  mo_energy =
[-3.27131678e+01 -1.89788129e+00 -7.85530062e-01 -7.85530062e-01
 -7.85530062e-01  2.62402035e+00  2.62402035e+00  2.62402035e+00
  2.64609843e+00  1.98249068e+01  1.98249068e+01  1.98249068e+01
  4.34150933e+01  3.18009713e+02  1.98370229e+03  7.27294776e+03]
E1 = -182.45914984862148  E_coul = 54.261935730256816
cycle= 1 E= -128.197214118365  delta_E= 5.68e-14  |g|= 5.85e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45914984862148  E_coul = 54.261935730256816
  HOMO = -0.785530048260602  LUMO = 2.62402035771845
  mo_energy =
[-3.27131678e+01 -1.89788129e+00 -7.85530048e-01 -7.85530048e-01
 -7.85530048e-01  2.62402036e+00  2.62402036e+00  2.62402036e+00
  2.64609843e+00  1.98249069e+01  1.98249069e+01  1.98249069e+01
  4.34150934e+01  3.18009713e+02  1.98370229e+03  7.27294776e+03]
E1 = -182.45914978867492  E_coul = 54.261935670310216
Extra cycle  E= -128.197214118365  delta_E= -5.68e-14  |g|= 1.37e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419780e+03 2.15723291e+02 1.42942256e+03 5.64844824e-01
 4.80403563e+01 1.29508902e+01 1.89259468e+00 2.77759855e+00
 1.33318166e+01 6.00561701e-01]
grad_E = [-7.75213231e-06 -2.02041214e-04  4.44886426e-05  4.32202590e-05
 -1.23369176e-04 -3.51309772e-05 -2.40149194e-05  3.40681160e-05
 -3.53923298e-06 -1.34822253e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19781723        1
[INPUT] 0    0    [1    /1   ]  215.723758875        1
[INPUT] 0    0    [1    /1   ]  1429.42248526        1
[INPUT] 0    0    [1    /1   ]  0.564879060706       1
[INPUT] 0    0    [1    /1   ]  48.0398646139        1
[INPUT] 0    0    [1    /1   ]  12.9510011594        1
[INPUT] 0    0    [1    /1   ]  1.89271373236        1
[INPUT] 1    0    [1    /1   ]  2.77752000458        1
[INPUT] 1    0    [1    /1   ]  13.3318264325        1
[INPUT] 1    0    [1    /1   ]  0.600546610827       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197817233803, 1.0]], [0, [215.72375887492984, 1.0]], [0, [1429.4224852583272, 1.0]], [0, [0.5648790607063824, 1.0]], [0, [48.0398646138812, 1.0]], [0, [12.951001159434288, 1.0]], [0, [1.8927137323593468, 1.0]], [1, [2.7775200045810737, 1.0]], [1, [13.331826432532704, 1.0]], [1, [0.6005466108270823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19781723]
bas 1, expnt(s) = [215.72375887]
bas 2, expnt(s) = [1429.42248526]
bas 3, expnt(s) = [0.56487906]
bas 4, expnt(s) = [48.03986461]
bas 5, expnt(s) = [12.95100116]
bas 6, expnt(s) = [1.89271373]
bas 7, expnt(s) = [2.77752]
bas 8, expnt(s) = [13.33182643]
bas 9, expnt(s) = [0.60054661]
CPU time:        49.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419782e+03 7.96092736e+02 2.15723759e+02 1.42212741e+02
 1.42942249e+03 5.87334458e+02 5.64879061e-01 1.64619634e+00
 4.80398646e+01 4.61016379e+01 1.29510012e+01 1.72481504e+01
 1.89271373e+00 4.07688747e+00 2.77752000e+00 1.04605829e+01
 1.33318264e+01 7.43184180e+01 6.00546611e-01 1.54229622e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965846654213482
cond(S) = 156.03525248042598
E1 = -183.13658690684503  E_coul = 55.01095853515505
init E= -128.12562837169
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895911577874  LUMO = 2.65781421541831
  mo_energy =
[-3.25129758e+01 -1.85399229e+00 -7.42895912e-01 -7.42895912e-01
 -7.42895912e-01  2.65781422e+00  2.65781422e+00  2.65781422e+00
  2.67909885e+00  1.99602051e+01  1.99602051e+01  1.99602051e+01
  4.35843353e+01  3.18239137e+02  1.98397800e+03  7.27324763e+03]
E1 = -182.12660768604437  E_coul = 53.93134197490413
cycle= 1 E= -128.19526571114  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262315
diis-c [-0.06880898  1.        ]
  HOMO = -0.808163122029324  LUMO = 2.6033968368086
  mo_energy =
[-3.27875392e+01 -1.92129374e+00 -8.08163122e-01 -8.08163122e-01
 -8.08163122e-01  2.60339684e+00  2.60339684e+00  2.60339684e+00
  2.62682012e+00  1.97687773e+01  1.97687773e+01  1.97687773e+01
  4.33505356e+01  3.17928319e+02  1.98361567e+03  7.27285974e+03]
E1 = -182.5906092692834  E_coul = 54.39370217471935
cycle= 2 E= -128.196907094564  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102215
diis-c [-4.42395223e-04  2.76702627e-01  7.23297373e-01]
  HOMO = -0.785278227464774  LUMO = 2.62412223207555
  mo_energy =
[-3.27124383e+01 -1.89755924e+00 -7.85278227e-01 -7.85278227e-01
 -7.85278227e-01  2.62412223e+00  2.62412223e+00  2.62412223e+00
  2.64661258e+00  1.98251952e+01  1.98251952e+01  1.98251952e+01
  4.34164321e+01  3.18010207e+02  1.98370319e+03  7.27294877e+03]
E1 = -182.45769187945098  E_coul = 54.26047775960623
cycle= 3 E= -128.197214119845  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103057
diis-c [-5.91660088e-08 -3.58781277e-03  6.43696683e-04  1.00294412e+00]
  HOMO = -0.78554558273037  LUMO = 2.62391494620409
  mo_energy =
[-3.27132100e+01 -1.89788718e+00 -7.85545583e-01 -7.85545583e-01
 -7.85545583e-01  2.62391495e+00  2.62391495e+00  2.62391495e+00
  2.64635946e+00  1.98245949e+01  1.98245949e+01  1.98245949e+01
  4.34157184e+01  3.18009574e+02  1.98370267e+03  7.27294828e+03]
E1 = -182.45916250438725  E_coul = 54.261948344036924
cycle= 4 E= -128.19721416035  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.98514e-05
diis-c [-2.08029116e-10  4.54282042e-04 -1.06023186e-03 -1.59606969e-01
  1.16021292e+00]
  HOMO = -0.785532888570207  LUMO = 2.62392596879636
  mo_energy =
[-3.27131774e+01 -1.89788451e+00 -7.85532889e-01 -7.85532889e-01
 -7.85532889e-01  2.62392597e+00  2.62392597e+00  2.62392597e+00
  2.64636102e+00  1.98246202e+01  1.98246202e+01  1.98246202e+01
  4.34157447e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.4591080861111  E_coul = 54.26189392554478
cycle= 5 E= -128.197214160566  delta_E= -2.16e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4591080861111  E_coul = 54.26189392554478
  HOMO = -0.785532745081767  LUMO = 2.62392610602785
  mo_energy =
[-3.27131771e+01 -1.89788478e+00 -7.85532745e-01 -7.85532745e-01
 -7.85532745e-01  2.62392611e+00  2.62392611e+00  2.62392611e+00
  2.64636078e+00  1.98246204e+01  1.98246204e+01  1.98246204e+01
  4.34157448e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.45910772420856  E_coul = 54.26189356364199
Extra cycle  E= -128.197214160567  delta_E= -2.56e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419782e+03 2.15723759e+02 1.42942249e+03 5.64879061e-01
 4.80398646e+01 1.29510012e+01 1.89271373e+00 2.77752000e+00
 1.33318264e+01 6.00546611e-01]
E = -128.19721416056657
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19781723        1
[INPUT] 0    0    [1    /1   ]  215.723758875        1
[INPUT] 0    0    [1    /1   ]  1429.42248526        1
[INPUT] 0    0    [1    /1   ]  0.564879060706       1
[INPUT] 0    0    [1    /1   ]  48.0398646139        1
[INPUT] 0    0    [1    /1   ]  12.9510011594        1
[INPUT] 0    0    [1    /1   ]  1.89271373236        1
[INPUT] 1    0    [1    /1   ]  2.77752000458        1
[INPUT] 1    0    [1    /1   ]  13.3318264325        1
[INPUT] 1    0    [1    /1   ]  0.600546610827       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197817233803, 1.0]], [0, [215.72375887492984, 1.0]], [0, [1429.4224852583272, 1.0]], [0, [0.5648790607063824, 1.0]], [0, [48.0398646138812, 1.0]], [0, [12.951001159434288, 1.0]], [0, [1.8927137323593468, 1.0]], [1, [2.7775200045810737, 1.0]], [1, [13.331826432532704, 1.0]], [1, [0.6005466108270823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19781723]
bas 1, expnt(s) = [215.72375887]
bas 2, expnt(s) = [1429.42248526]
bas 3, expnt(s) = [0.56487906]
bas 4, expnt(s) = [48.03986461]
bas 5, expnt(s) = [12.95100116]
bas 6, expnt(s) = [1.89271373]
bas 7, expnt(s) = [2.77752]
bas 8, expnt(s) = [13.33182643]
bas 9, expnt(s) = [0.60054661]
CPU time:        49.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419782e+03 7.96092736e+02 2.15723759e+02 1.42212741e+02
 1.42942249e+03 5.87334458e+02 5.64879061e-01 1.64619634e+00
 4.80398646e+01 4.61016379e+01 1.29510012e+01 1.72481504e+01
 1.89271373e+00 4.07688747e+00 2.77752000e+00 1.04605829e+01
 1.33318264e+01 7.43184180e+01 6.00546611e-01 1.54229622e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965846654213482
cond(S) = 156.03525248042598
E1 = -183.13658690684503  E_coul = 55.01095853515505
init E= -128.12562837169
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895911577874  LUMO = 2.65781421541831
  mo_energy =
[-3.25129758e+01 -1.85399229e+00 -7.42895912e-01 -7.42895912e-01
 -7.42895912e-01  2.65781422e+00  2.65781422e+00  2.65781422e+00
  2.67909885e+00  1.99602051e+01  1.99602051e+01  1.99602051e+01
  4.35843353e+01  3.18239137e+02  1.98397800e+03  7.27324763e+03]
E1 = -182.12660768604437  E_coul = 53.93134197490413
cycle= 1 E= -128.19526571114  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262315
diis-c [-0.06880898  1.        ]
  HOMO = -0.808163122029324  LUMO = 2.6033968368086
  mo_energy =
[-3.27875392e+01 -1.92129374e+00 -8.08163122e-01 -8.08163122e-01
 -8.08163122e-01  2.60339684e+00  2.60339684e+00  2.60339684e+00
  2.62682012e+00  1.97687773e+01  1.97687773e+01  1.97687773e+01
  4.33505356e+01  3.17928319e+02  1.98361567e+03  7.27285974e+03]
E1 = -182.5906092692834  E_coul = 54.39370217471935
cycle= 2 E= -128.196907094564  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102215
diis-c [-4.42395223e-04  2.76702627e-01  7.23297373e-01]
  HOMO = -0.785278227464774  LUMO = 2.62412223207555
  mo_energy =
[-3.27124383e+01 -1.89755924e+00 -7.85278227e-01 -7.85278227e-01
 -7.85278227e-01  2.62412223e+00  2.62412223e+00  2.62412223e+00
  2.64661258e+00  1.98251952e+01  1.98251952e+01  1.98251952e+01
  4.34164321e+01  3.18010207e+02  1.98370319e+03  7.27294877e+03]
E1 = -182.45769187945098  E_coul = 54.26047775960623
cycle= 3 E= -128.197214119845  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103057
diis-c [-5.91660088e-08 -3.58781277e-03  6.43696683e-04  1.00294412e+00]
  HOMO = -0.78554558273037  LUMO = 2.62391494620409
  mo_energy =
[-3.27132100e+01 -1.89788718e+00 -7.85545583e-01 -7.85545583e-01
 -7.85545583e-01  2.62391495e+00  2.62391495e+00  2.62391495e+00
  2.64635946e+00  1.98245949e+01  1.98245949e+01  1.98245949e+01
  4.34157184e+01  3.18009574e+02  1.98370267e+03  7.27294828e+03]
E1 = -182.45916250438725  E_coul = 54.261948344036924
cycle= 4 E= -128.19721416035  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.98514e-05
diis-c [-2.08029116e-10  4.54282042e-04 -1.06023186e-03 -1.59606969e-01
  1.16021292e+00]
  HOMO = -0.785532888570207  LUMO = 2.62392596879636
  mo_energy =
[-3.27131774e+01 -1.89788451e+00 -7.85532889e-01 -7.85532889e-01
 -7.85532889e-01  2.62392597e+00  2.62392597e+00  2.62392597e+00
  2.64636102e+00  1.98246202e+01  1.98246202e+01  1.98246202e+01
  4.34157447e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.4591080861111  E_coul = 54.26189392554478
cycle= 5 E= -128.197214160566  delta_E= -2.16e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4591080861111  E_coul = 54.26189392554478
  HOMO = -0.785532745081767  LUMO = 2.62392610602785
  mo_energy =
[-3.27131771e+01 -1.89788478e+00 -7.85532745e-01 -7.85532745e-01
 -7.85532745e-01  2.62392611e+00  2.62392611e+00  2.62392611e+00
  2.64636078e+00  1.98246204e+01  1.98246204e+01  1.98246204e+01
  4.34157448e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.45910772420856  E_coul = 54.26189356364199
Extra cycle  E= -128.197214160567  delta_E= -2.56e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.03525248042598
E1 = -182.45910772420856  E_coul = 54.26189356364199
init E= -128.197214160567
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785532752673383  LUMO = 2.62392609743335
  mo_energy =
[-3.27131772e+01 -1.89788486e+00 -7.85532753e-01 -7.85532753e-01
 -7.85532753e-01  2.62392610e+00  2.62392610e+00  2.62392610e+00
  2.64636071e+00  1.98246204e+01  1.98246204e+01  1.98246204e+01
  4.34157447e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.459107882664  E_coul = 54.26189372209745
cycle= 1 E= -128.197214160567  delta_E= 2.84e-14  |g|= 5.85e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.459107882664  E_coul = 54.26189372209745
  HOMO = -0.785532738590376  LUMO = 2.62392610988585
  mo_energy =
[-3.27131771e+01 -1.89788486e+00 -7.85532739e-01 -7.85532739e-01
 -7.85532739e-01  2.62392611e+00  2.62392611e+00  2.62392611e+00
  2.64636071e+00  1.98246204e+01  1.98246204e+01  1.98246204e+01
  4.34157448e+01  3.18009620e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.45910782297844  E_coul = 54.26189366241178
Extra cycle  E= -128.197214160567  delta_E= -1.14e-13  |g|= 1.37e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419782e+03 2.15723759e+02 1.42942249e+03 5.64879061e-01
 4.80398646e+01 1.29510012e+01 1.89271373e+00 2.77752000e+00
 1.33318264e+01 6.00546611e-01]
grad_E = [-7.75276101e-06 -2.01720338e-04  4.44851359e-05  5.50371913e-05
 -1.26782350e-04 -2.57360112e-05 -2.22441958e-05 -6.03184516e-06
  1.78505260e-06  1.29393603e-05]
  message: CONVERGENCE: REL_REDUCTION_OF_F_<=_FACTR*EPSMCH
  success: True
   status: 0
      fun: -128.19721416056657
        x: [ 2.144e+03  2.157e+02  1.429e+03  5.649e-01  4.804e+01
             1.295e+01  1.893e+00  2.778e+00  1.333e+01  6.005e-01]
      nit: 20
      jac: [-7.753e-06 -2.017e-04  4.449e-05  5.504e-05 -1.268e-04
            -2.574e-05 -2.224e-05 -6.032e-06  1.785e-06  1.294e-05]
     nfev: 21
     njev: 21
 hess_inv: <10x10 LbfgsInvHessProduct with dtype=float64>
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="L-BFGS-B",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:43:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19781723        1
[INPUT] 0    0    [1    /1   ]  215.723758875        1
[INPUT] 0    0    [1    /1   ]  1429.42248526        1
[INPUT] 0    0    [1    /1   ]  0.564879060706       1
[INPUT] 0    0    [1    /1   ]  48.0398646139        1
[INPUT] 0    0    [1    /1   ]  12.9510011594        1
[INPUT] 0    0    [1    /1   ]  1.89271373236        1
[INPUT] 1    0    [1    /1   ]  2.77752000458        1
[INPUT] 1    0    [1    /1   ]  13.3318264325        1
[INPUT] 1    0    [1    /1   ]  0.600546610827       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197817233803, 1.0]], [0, [215.72375887492984, 1.0]], [0, [1429.4224852583272, 1.0]], [0, [0.5648790607063824, 1.0]], [0, [48.0398646138812, 1.0]], [0, [12.951001159434288, 1.0]], [0, [1.8927137323593468, 1.0]], [1, [2.7775200045810737, 1.0]], [1, [13.331826432532704, 1.0]], [1, [0.6005466108270823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19781723]
bas 1, expnt(s) = [215.72375887]
bas 2, expnt(s) = [1429.42248526]
bas 3, expnt(s) = [0.56487906]
bas 4, expnt(s) = [48.03986461]
bas 5, expnt(s) = [12.95100116]
bas 6, expnt(s) = [1.89271373]
bas 7, expnt(s) = [2.77752]
bas 8, expnt(s) = [13.33182643]
bas 9, expnt(s) = [0.60054661]
CPU time:        52.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419782e+03 7.96092736e+02 2.15723759e+02 1.42212741e+02
 1.42942249e+03 5.87334458e+02 5.64879061e-01 1.64619634e+00
 4.80398646e+01 4.61016379e+01 1.29510012e+01 1.72481504e+01
 1.89271373e+00 4.07688747e+00 2.77752000e+00 1.04605829e+01
 1.33318264e+01 7.43184180e+01 6.00546611e-01 1.54229622e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965846654213482
cond(S) = 156.03525248042598
E1 = -183.13658690684503  E_coul = 55.01095853515505
init E= -128.12562837169
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895911577874  LUMO = 2.65781421541831
  mo_energy =
[-3.25129758e+01 -1.85399229e+00 -7.42895912e-01 -7.42895912e-01
 -7.42895912e-01  2.65781422e+00  2.65781422e+00  2.65781422e+00
  2.67909885e+00  1.99602051e+01  1.99602051e+01  1.99602051e+01
  4.35843353e+01  3.18239137e+02  1.98397800e+03  7.27324763e+03]
E1 = -182.12660768604437  E_coul = 53.93134197490413
cycle= 1 E= -128.19526571114  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262315
diis-c [-0.06880898  1.        ]
  HOMO = -0.808163122029324  LUMO = 2.6033968368086
  mo_energy =
[-3.27875392e+01 -1.92129374e+00 -8.08163122e-01 -8.08163122e-01
 -8.08163122e-01  2.60339684e+00  2.60339684e+00  2.60339684e+00
  2.62682012e+00  1.97687773e+01  1.97687773e+01  1.97687773e+01
  4.33505356e+01  3.17928319e+02  1.98361567e+03  7.27285974e+03]
E1 = -182.5906092692834  E_coul = 54.39370217471935
cycle= 2 E= -128.196907094564  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102215
diis-c [-4.42395223e-04  2.76702627e-01  7.23297373e-01]
  HOMO = -0.785278227464774  LUMO = 2.62412223207555
  mo_energy =
[-3.27124383e+01 -1.89755924e+00 -7.85278227e-01 -7.85278227e-01
 -7.85278227e-01  2.62412223e+00  2.62412223e+00  2.62412223e+00
  2.64661258e+00  1.98251952e+01  1.98251952e+01  1.98251952e+01
  4.34164321e+01  3.18010207e+02  1.98370319e+03  7.27294877e+03]
E1 = -182.45769187945098  E_coul = 54.26047775960623
cycle= 3 E= -128.197214119845  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103057
diis-c [-5.91660088e-08 -3.58781277e-03  6.43696683e-04  1.00294412e+00]
  HOMO = -0.78554558273037  LUMO = 2.62391494620409
  mo_energy =
[-3.27132100e+01 -1.89788718e+00 -7.85545583e-01 -7.85545583e-01
 -7.85545583e-01  2.62391495e+00  2.62391495e+00  2.62391495e+00
  2.64635946e+00  1.98245949e+01  1.98245949e+01  1.98245949e+01
  4.34157184e+01  3.18009574e+02  1.98370267e+03  7.27294828e+03]
E1 = -182.45916250438725  E_coul = 54.261948344036924
cycle= 4 E= -128.19721416035  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.98514e-05
diis-c [-2.08029116e-10  4.54282042e-04 -1.06023186e-03 -1.59606969e-01
  1.16021292e+00]
  HOMO = -0.785532888570207  LUMO = 2.62392596879636
  mo_energy =
[-3.27131774e+01 -1.89788451e+00 -7.85532889e-01 -7.85532889e-01
 -7.85532889e-01  2.62392597e+00  2.62392597e+00  2.62392597e+00
  2.64636102e+00  1.98246202e+01  1.98246202e+01  1.98246202e+01
  4.34157447e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.4591080861111  E_coul = 54.26189392554478
cycle= 5 E= -128.197214160566  delta_E= -2.16e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4591080861111  E_coul = 54.26189392554478
  HOMO = -0.785532745081767  LUMO = 2.62392610602785
  mo_energy =
[-3.27131771e+01 -1.89788478e+00 -7.85532745e-01 -7.85532745e-01
 -7.85532745e-01  2.62392611e+00  2.62392611e+00  2.62392611e+00
  2.64636078e+00  1.98246204e+01  1.98246204e+01  1.98246204e+01
  4.34157448e+01  3.18009619e+02  1.98370273e+03  7.27294835e+03]
E1 = -182.45910772420856  E_coul = 54.26189356364199
Extra cycle  E= -128.197214160567  delta_E= -2.56e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419782e+03 2.15723759e+02 1.42942249e+03 5.64879061e-01
 4.80398646e+01 1.29510012e+01 1.89271373e+00 2.77752000e+00
 1.33318264e+01 6.00546611e-01]
E = -128.19721416056657
E = -128.19721416056657
exp = [2.1441978172338031e+03,2.1572375887492984e+02,1.4294224852583272e+03,5.6487906070638239e-01,4.8039864613881200e+01,1.2951001159434288e+01,1.8927137323593468e+00,2.7775200045810737e+00,1.3331826432532704e+01,6.0054661082708227e-01]
