#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["10s4p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742953        1
[INPUT] 0    0    [1    /1   ]  76.4809664129        1
[INPUT] 0    0    [1    /1   ]  10.1220668477        1
[INPUT] 0    0    [1    /1   ]  27.1465493937        1
[INPUT] 0    0    [1    /1   ]  0.392075179555       1
[INPUT] 0    0    [1    /1   ]  3.0080524478         1
[INPUT] 0    0    [1    /1   ]  1.15985827445        1
[INPUT] 1    0    [1    /1   ]  1.69053462533        1
[INPUT] 1    0    [1    /1   ]  6.25567861837        1
[INPUT] 1    0    [1    /1   ]  28.3301405079        1
[INPUT] 1    0    [1    /1   ]  0.43062835423        1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068444, 1.0]], [0, [833.272434290846, 1.0]], [0, [235.72174295291873, 1.0]], [0, [76.48096641291934, 1.0]], [0, [10.122066847702175, 1.0]], [0, [27.146549393661314, 1.0]], [0, [0.3920751795551184, 1.0]], [0, [3.0080524478046877, 1.0]], [0, [1.159858274452712, 1.0]], [1, [1.6905346253349034, 1.0]], [1, [6.255678618373655, 1.0]], [1, [28.330140507915555, 1.0]], [1, [0.4306283542298902, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096641]
bas 5, expnt(s) = [10.12206685]
bas 6, expnt(s) = [27.14654939]
bas 7, expnt(s) = [0.39207518]
bas 8, expnt(s) = [3.00805245]
bas 9, expnt(s) = [1.15985827]
bas 10, expnt(s) = [1.69053463]
bas 11, expnt(s) = [6.25567862]
bas 12, expnt(s) = [28.33014051]
bas 13, expnt(s) = [0.43062835]
bas 14, expnt(s) = [0.5]
CPU time:         1.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809664e+01 6.53401383e+01 1.01220668e+01 1.43372852e+01
 2.71465494e+01 3.00469919e+01 3.92075180e-01 1.25182043e+00
 3.00805245e+00 5.77070771e+00 1.15985827e+00 2.82370107e+00
 1.69053463e+00 5.62360075e+00 6.25567862e+00 2.88620669e+01
 2.83301405e+01 1.90675680e+02 4.30628354e-01 1.01768335e+00
 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99326100777983
cond(S) = 1248.7354080516968
E1 = -183.51671815625426  E_coul = 55.065768029253775
init E= -128.450950127
    CPU time for initialize scf      0.12 sec, wall time      0.12 sec
  HOMO = -0.76823404109308  LUMO = 0.953240422577555
  mo_energy =
[-3.25575090e+01 -1.85396419e+00 -7.68234041e-01 -7.68234041e-01
 -7.68234041e-01  9.53240423e-01  9.53240423e-01  9.53240423e-01
  1.27463070e+00  3.26288542e+00  3.26288542e+00  3.26288542e+00
  7.73389259e+00  1.10260211e+01  1.10260211e+01  1.10260211e+01
  3.56606541e+01  5.40673120e+01  5.40673120e+01  5.40673120e+01
  1.40184996e+02  5.04458183e+02  1.87204620e+03  8.00157011e+03
  4.77690186e+04]
E1 = -182.1678235820121  E_coul = 53.67850505002003
cycle= 1 E= -128.489318531992  delta_E= -0.0384  |g|= 0.193  |ddm|= 0.365
    CPU time for cycle= 1      0.25 sec, wall time      0.26 sec
diis-norm(errvec)=0.47121
diis-c [-0.22203858  1.        ]
  HOMO = -0.863818781540761  LUMO = 0.934761405977969
  mo_energy =
[-3.28631158e+01 -1.95308094e+00 -8.63818782e-01 -8.63818782e-01
 -8.63818782e-01  9.34761406e-01  9.34761406e-01  9.34761406e-01
  1.23813935e+00  3.20346572e+00  3.20346572e+00  3.20346572e+00
  7.61430303e+00  1.08697013e+01  1.08697013e+01  1.08697013e+01
  3.54313494e+01  5.37913768e+01  5.37913768e+01  5.37913768e+01
  1.39884526e+02  5.04112608e+02  1.87166418e+03  8.00115900e+03
  4.77685887e+04]
E1 = -182.84994889099931  E_coul = 54.35829504488344
cycle= 2 E= -128.491653846116  delta_E= -0.00234  |g|= 0.0924  |ddm|= 0.253
    CPU time for cycle= 2      0.08 sec, wall time      0.08 sec
diis-norm(errvec)=0.228685
diis-c [-5.10361195e-04  3.25916778e-01  6.74083222e-01]
  HOMO = -0.831500011645712  LUMO = 0.942253117601649
  mo_energy =
[-3.27644016e+01 -1.91914319e+00 -8.31500012e-01 -8.31500012e-01
 -8.31500012e-01  9.42253118e-01  9.42253118e-01  9.42253118e-01
  1.25194331e+00  3.22443261e+00  3.22443261e+00  3.22443261e+00
  7.65448921e+00  1.09218796e+01  1.09218796e+01  1.09218796e+01
  3.55069158e+01  5.38811808e+01  5.38811808e+01  5.38811808e+01
  1.39981435e+02  5.04219627e+02  1.87177622e+03  8.00127342e+03
  4.77687040e+04]
E1 = -182.63086544842  E_coul = 54.13850891809176
cycle= 3 E= -128.492356530328  delta_E= -0.000703  |g|= 0.000887  |ddm|= 0.0489
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000623697
diis-c [-2.84338856e-07 -1.50108385e-03 -4.40883424e-03  1.00590992e+00]
  HOMO = -0.831347247047  LUMO = 0.942380216270758
  mo_energy =
[-3.27641587e+01 -1.91886140e+00 -8.31347247e-01 -8.31347247e-01
 -8.31347247e-01  9.42380216e-01  9.42380216e-01  9.42380216e-01
  1.25220054e+00  3.22464236e+00  3.22464236e+00  3.22464236e+00
  7.65474996e+00  1.09221406e+01  1.09221406e+01  1.09221406e+01
  3.55071714e+01  5.38814345e+01  5.38814345e+01  5.38814345e+01
  1.39981686e+02  5.04219855e+02  1.87177640e+03  8.00127356e+03
  4.77687041e+04]
E1 = -182.63093772089192  E_coul = 54.138581054762724
cycle= 4 E= -128.492356666129  delta_E= -1.36e-07  |g|= 0.000139  |ddm|= 0.00459
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138772
diis-c [-3.95438390e-09  5.27297354e-04  1.45124503e-03 -3.06172968e-01
  1.30419443e+00]
  HOMO = -0.831312363163055  LUMO = 0.942398197791445
  mo_energy =
[-3.27641105e+01 -1.91879146e+00 -8.31312363e-01 -8.31312363e-01
 -8.31312363e-01  9.42398198e-01  9.42398198e-01  9.42398198e-01
  1.25225137e+00  3.22467827e+00  3.22467827e+00  3.22467827e+00
  7.65480567e+00  1.09221900e+01  1.09221900e+01  1.09221900e+01
  3.55072246e+01  5.38814850e+01  5.38814850e+01  5.38814850e+01
  1.39981734e+02  5.04219893e+02  1.87177643e+03  8.00127358e+03
  4.77687041e+04]
E1 = -182.63098660387558  E_coul = 54.13862993391541
cycle= 5 E= -128.49235666996  delta_E= -3.83e-09  |g|= 1.24e-05  |ddm|= 0.000852
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.2551e-05
diis-c [-9.96745815e-12 -1.81752630e-05 -5.87175645e-06  1.83175485e-02
 -7.77222160e-02  1.05942871e+00]
  HOMO = -0.831315815050741  LUMO = 0.942396563301978
  mo_energy =
[-3.27641165e+01 -1.91879505e+00 -8.31315815e-01 -8.31315815e-01
 -8.31315815e-01  9.42396563e-01  9.42396563e-01  9.42396563e-01
  1.25224838e+00  3.22467511e+00  3.22467511e+00  3.22467511e+00
  7.65480217e+00  1.09221854e+01  1.09221854e+01  1.09221854e+01
  3.55072199e+01  5.38814794e+01  5.38814794e+01  5.38814794e+01
  1.39981728e+02  5.04219885e+02  1.87177642e+03  8.00127357e+03
  4.77687041e+04]
E1 = -182.6309856840137  E_coul = 54.13862901403004
cycle= 6 E= -128.492356669984  delta_E= -2.35e-11  |g|= 1.41e-06  |ddm|= 6.99e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.6309856840137  E_coul = 54.13862901403004
  HOMO = -0.831316591932735  LUMO = 0.942396317774115
  mo_energy =
[-3.27641181e+01 -1.91879593e+00 -8.31316592e-01 -8.31316592e-01
 -8.31316592e-01  9.42396318e-01  9.42396318e-01  9.42396318e-01
  1.25224787e+00  3.22467451e+00  3.22467451e+00  3.22467451e+00
  7.65480122e+00  1.09221843e+01  1.09221843e+01  1.09221843e+01
  3.55072185e+01  5.38814779e+01  5.38814779e+01  5.38814779e+01
  1.39981726e+02  5.04219883e+02  1.87177642e+03  8.00127357e+03
  4.77687041e+04]
E1 = -182.63098830578713  E_coul = 54.138631635803144
Extra cycle  E= -128.492356669984  delta_E= -3.41e-13  |g|= 4.07e-07  |ddm|= 4.66e-06
    CPU time for scf_cycle      0.51 sec, wall time      0.51 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809664e+01 1.01220668e+01 2.71465494e+01 3.92075180e-01
 3.00805245e+00 1.15985827e+00 1.69053463e+00 6.25567862e+00
 2.83301405e+01 4.30628354e-01 5.00000000e-01]
E = -128.492356669984
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["10s4p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742953        1
[INPUT] 0    0    [1    /1   ]  76.4809664129        1
[INPUT] 0    0    [1    /1   ]  10.1220668477        1
[INPUT] 0    0    [1    /1   ]  27.1465493937        1
[INPUT] 0    0    [1    /1   ]  0.392075179555       1
[INPUT] 0    0    [1    /1   ]  3.0080524478         1
[INPUT] 0    0    [1    /1   ]  1.15985827445        1
[INPUT] 1    0    [1    /1   ]  1.69053462533        1
[INPUT] 1    0    [1    /1   ]  6.25567861837        1
[INPUT] 1    0    [1    /1   ]  28.3301405079        1
[INPUT] 1    0    [1    /1   ]  0.43062835423        1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068444, 1.0]], [0, [833.272434290846, 1.0]], [0, [235.72174295291873, 1.0]], [0, [76.48096641291934, 1.0]], [0, [10.122066847702175, 1.0]], [0, [27.146549393661314, 1.0]], [0, [0.3920751795551184, 1.0]], [0, [3.0080524478046877, 1.0]], [0, [1.159858274452712, 1.0]], [1, [1.6905346253349034, 1.0]], [1, [6.255678618373655, 1.0]], [1, [28.330140507915555, 1.0]], [1, [0.4306283542298902, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096641]
bas 5, expnt(s) = [10.12206685]
bas 6, expnt(s) = [27.14654939]
bas 7, expnt(s) = [0.39207518]
bas 8, expnt(s) = [3.00805245]
bas 9, expnt(s) = [1.15985827]
bas 10, expnt(s) = [1.69053463]
bas 11, expnt(s) = [6.25567862]
bas 12, expnt(s) = [28.33014051]
bas 13, expnt(s) = [0.43062835]
bas 14, expnt(s) = [0.5]
CPU time:         2.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809664e+01 6.53401383e+01 1.01220668e+01 1.43372852e+01
 2.71465494e+01 3.00469919e+01 3.92075180e-01 1.25182043e+00
 3.00805245e+00 5.77070771e+00 1.15985827e+00 2.82370107e+00
 1.69053463e+00 5.62360075e+00 6.25567862e+00 2.88620669e+01
 2.83301405e+01 1.90675680e+02 4.30628354e-01 1.01768335e+00
 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99326100777983
cond(S) = 1248.7354080516968
E1 = -183.51671815625426  E_coul = 55.065768029253775
init E= -128.450950127
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.76823404109308  LUMO = 0.953240422577555
  mo_energy =
[-3.25575090e+01 -1.85396419e+00 -7.68234041e-01 -7.68234041e-01
 -7.68234041e-01  9.53240423e-01  9.53240423e-01  9.53240423e-01
  1.27463070e+00  3.26288542e+00  3.26288542e+00  3.26288542e+00
  7.73389259e+00  1.10260211e+01  1.10260211e+01  1.10260211e+01
  3.56606541e+01  5.40673120e+01  5.40673120e+01  5.40673120e+01
  1.40184996e+02  5.04458183e+02  1.87204620e+03  8.00157011e+03
  4.77690186e+04]
E1 = -182.1678235820121  E_coul = 53.67850505002003
cycle= 1 E= -128.489318531992  delta_E= -0.0384  |g|= 0.193  |ddm|= 0.365
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.47121
diis-c [-0.22203858  1.        ]
  HOMO = -0.863818781540761  LUMO = 0.934761405977969
  mo_energy =
[-3.28631158e+01 -1.95308094e+00 -8.63818782e-01 -8.63818782e-01
 -8.63818782e-01  9.34761406e-01  9.34761406e-01  9.34761406e-01
  1.23813935e+00  3.20346572e+00  3.20346572e+00  3.20346572e+00
  7.61430303e+00  1.08697013e+01  1.08697013e+01  1.08697013e+01
  3.54313494e+01  5.37913768e+01  5.37913768e+01  5.37913768e+01
  1.39884526e+02  5.04112608e+02  1.87166418e+03  8.00115900e+03
  4.77685887e+04]
E1 = -182.84994889099931  E_coul = 54.35829504488344
cycle= 2 E= -128.491653846116  delta_E= -0.00234  |g|= 0.0924  |ddm|= 0.253
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.228685
diis-c [-5.10361195e-04  3.25916778e-01  6.74083222e-01]
  HOMO = -0.831500011645712  LUMO = 0.942253117601649
  mo_energy =
[-3.27644016e+01 -1.91914319e+00 -8.31500012e-01 -8.31500012e-01
 -8.31500012e-01  9.42253118e-01  9.42253118e-01  9.42253118e-01
  1.25194331e+00  3.22443261e+00  3.22443261e+00  3.22443261e+00
  7.65448921e+00  1.09218796e+01  1.09218796e+01  1.09218796e+01
  3.55069158e+01  5.38811808e+01  5.38811808e+01  5.38811808e+01
  1.39981435e+02  5.04219627e+02  1.87177622e+03  8.00127342e+03
  4.77687040e+04]
E1 = -182.63086544842  E_coul = 54.13850891809176
cycle= 3 E= -128.492356530328  delta_E= -0.000703  |g|= 0.000887  |ddm|= 0.0489
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000623697
diis-c [-2.84338856e-07 -1.50108385e-03 -4.40883424e-03  1.00590992e+00]
  HOMO = -0.831347247047  LUMO = 0.942380216270758
  mo_energy =
[-3.27641587e+01 -1.91886140e+00 -8.31347247e-01 -8.31347247e-01
 -8.31347247e-01  9.42380216e-01  9.42380216e-01  9.42380216e-01
  1.25220054e+00  3.22464236e+00  3.22464236e+00  3.22464236e+00
  7.65474996e+00  1.09221406e+01  1.09221406e+01  1.09221406e+01
  3.55071714e+01  5.38814345e+01  5.38814345e+01  5.38814345e+01
  1.39981686e+02  5.04219855e+02  1.87177640e+03  8.00127356e+03
  4.77687041e+04]
E1 = -182.63093772089192  E_coul = 54.138581054762724
cycle= 4 E= -128.492356666129  delta_E= -1.36e-07  |g|= 0.000139  |ddm|= 0.00459
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138772
diis-c [-3.95438390e-09  5.27297354e-04  1.45124503e-03 -3.06172968e-01
  1.30419443e+00]
  HOMO = -0.831312363163055  LUMO = 0.942398197791445
  mo_energy =
[-3.27641105e+01 -1.91879146e+00 -8.31312363e-01 -8.31312363e-01
 -8.31312363e-01  9.42398198e-01  9.42398198e-01  9.42398198e-01
  1.25225137e+00  3.22467827e+00  3.22467827e+00  3.22467827e+00
  7.65480567e+00  1.09221900e+01  1.09221900e+01  1.09221900e+01
  3.55072246e+01  5.38814850e+01  5.38814850e+01  5.38814850e+01
  1.39981734e+02  5.04219893e+02  1.87177643e+03  8.00127358e+03
  4.77687041e+04]
E1 = -182.63098660387558  E_coul = 54.13862993391541
cycle= 5 E= -128.49235666996  delta_E= -3.83e-09  |g|= 1.24e-05  |ddm|= 0.000852
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.2551e-05
diis-c [-9.96745815e-12 -1.81752630e-05 -5.87175645e-06  1.83175485e-02
 -7.77222160e-02  1.05942871e+00]
  HOMO = -0.831315815050741  LUMO = 0.942396563301978
  mo_energy =
[-3.27641165e+01 -1.91879505e+00 -8.31315815e-01 -8.31315815e-01
 -8.31315815e-01  9.42396563e-01  9.42396563e-01  9.42396563e-01
  1.25224838e+00  3.22467511e+00  3.22467511e+00  3.22467511e+00
  7.65480217e+00  1.09221854e+01  1.09221854e+01  1.09221854e+01
  3.55072199e+01  5.38814794e+01  5.38814794e+01  5.38814794e+01
  1.39981728e+02  5.04219885e+02  1.87177642e+03  8.00127357e+03
  4.77687041e+04]
E1 = -182.6309856840137  E_coul = 54.13862901403004
cycle= 6 E= -128.492356669984  delta_E= -2.35e-11  |g|= 1.41e-06  |ddm|= 6.99e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.6309856840137  E_coul = 54.13862901403004
  HOMO = -0.831316591932735  LUMO = 0.942396317774115
  mo_energy =
[-3.27641181e+01 -1.91879593e+00 -8.31316592e-01 -8.31316592e-01
 -8.31316592e-01  9.42396318e-01  9.42396318e-01  9.42396318e-01
  1.25224787e+00  3.22467451e+00  3.22467451e+00  3.22467451e+00
  7.65480122e+00  1.09221843e+01  1.09221843e+01  1.09221843e+01
  3.55072185e+01  5.38814779e+01  5.38814779e+01  5.38814779e+01
  1.39981726e+02  5.04219883e+02  1.87177642e+03  8.00127357e+03
  4.77687041e+04]
E1 = -182.63098830578713  E_coul = 54.138631635803144
Extra cycle  E= -128.492356669984  delta_E= -3.41e-13  |g|= 4.07e-07  |ddm|= 4.66e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1248.7354080516968
E1 = -182.63098830578713  E_coul = 54.138631635803144
init E= -128.492356669984
    CPU time for initialize scf      0.42 sec, wall time      0.42 sec
  HOMO = -0.831316417716911  LUMO = 0.942396347889594
  mo_energy =
[-3.27641175e+01 -1.91879576e+00 -8.31316418e-01 -8.31316418e-01
 -8.31316418e-01  9.42396348e-01  9.42396348e-01  9.42396348e-01
  1.25224791e+00  3.22467461e+00  3.22467461e+00  3.22467461e+00
  7.65480143e+00  1.09221846e+01  1.09221846e+01  1.09221846e+01
  3.55072190e+01  5.38814785e+01  5.38814785e+01  5.38814785e+01
  1.39981727e+02  5.04219884e+02  1.87177642e+03  8.00127357e+03
  4.77687041e+04]
E1 = -182.63098675558723  E_coul = 54.138630085603225
cycle= 1 E= -128.492356669984  delta_E= -2.84e-14  |g|= 2.09e-07  |ddm|= 1.14e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.63098675558723  E_coul = 54.138630085603225
  HOMO = -0.83131652765228  LUMO = 0.942396321460135
  mo_energy =
[-3.27641178e+01 -1.91879588e+00 -8.31316528e-01 -8.31316528e-01
 -8.31316528e-01  9.42396321e-01  9.42396321e-01  9.42396321e-01
  1.25224786e+00  3.22467454e+00  3.22467454e+00  3.22467454e+00
  7.65480129e+00  1.09221844e+01  1.09221844e+01  1.09221844e+01
  3.55072187e+01  5.38814782e+01  5.38814782e+01  5.38814782e+01
  1.39981726e+02  5.04219884e+02  1.87177642e+03  8.00127357e+03
  4.77687041e+04]
E1 = -182.6309874647937  E_coul = 54.13863079480945
Extra cycle  E= -128.492356669984  delta_E= -2.27e-13  |g|= 9.67e-08  |ddm|= 9.19e-08
    CPU time for scf_cycle      1.24 sec, wall time      1.25 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809664e+01 1.01220668e+01 2.71465494e+01 3.92075180e-01
 3.00805245e+00 1.15985827e+00 1.69053463e+00 6.25567862e+00
 2.83301405e+01 4.30628354e-01 5.00000000e-01]
grad_E = [ 1.10825893e-12  1.79132250e-11 -3.36412544e-10  4.06564902e-09
 -4.20793671e-08 -1.96321154e-06  3.51847654e-07 -2.53765674e-04
 -8.56336049e-06  8.67396056e-05 -1.17512994e-02  1.28604076e-03
 -4.47911625e-05  3.99710579e-02 -2.02893317e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742949        1
[INPUT] 0    0    [1    /1   ]  76.480966455         1
[INPUT] 0    0    [1    /1   ]  10.1220688109        1
[INPUT] 0    0    [1    /1   ]  27.1465490418        1
[INPUT] 0    0    [1    /1   ]  0.392328945229       1
[INPUT] 0    0    [1    /1   ]  3.00806101117        1
[INPUT] 0    0    [1    /1   ]  1.15977153485        1
[INPUT] 1    0    [1    /1   ]  1.7022859247         1
[INPUT] 1    0    [1    /1   ]  6.25439257761        1
[INPUT] 1    0    [1    /1   ]  28.3301852991        1
[INPUT] 1    0    [1    /1   ]  0.39065729635        1
[INPUT] 1    0    [1    /1   ]  0.50202893317        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068426, 1.0]], [0, [833.2724342911824, 1.0]], [0, [235.7217429488531, 1.0]], [0, [76.48096645499871, 1.0]], [0, [10.122068810913717, 1.0]], [0, [27.14654904181366, 1.0]], [0, [0.39232894522869877, 1.0]], [0, [3.008061011165179, 1.0]], [0, [1.1597715348471551, 1.0]], [1, [1.7022859247003392, 1.0]], [1, [6.254392577613995, 1.0]], [1, [28.330185299078096, 1.0]], [1, [0.39065729635013635, 1.0]], [1, [0.5020289331701373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096645]
bas 5, expnt(s) = [10.12206881]
bas 6, expnt(s) = [27.14654904]
bas 7, expnt(s) = [0.39232895]
bas 8, expnt(s) = [3.00806101]
bas 9, expnt(s) = [1.15977153]
bas 10, expnt(s) = [1.70228592]
bas 11, expnt(s) = [6.25439258]
bas 12, expnt(s) = [28.3301853]
bas 13, expnt(s) = [0.3906573]
bas 14, expnt(s) = [0.50202893]
CPU time:         7.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401383e+01 1.01220688e+01 1.43372873e+01
 2.71465490e+01 3.00469916e+01 3.92328945e-01 1.25242805e+00
 3.00806101e+00 5.77072003e+00 1.15977153e+00 2.82354269e+00
 1.70228592e+00 5.67250683e+00 6.25439258e+00 2.88546503e+01
 2.83301853e+01 1.90676057e+02 3.90657296e-01 9.01009391e-01
 5.02028933e-01 1.23280767e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.993976609284548
cond(S) = 431.52109740383605
E1 = -183.51886684046184  E_coul = 55.06578287609348
init E= -128.453083964368
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.768569643838668  LUMO = 0.899244766647594
  mo_energy =
[-3.25575748e+01 -1.85393621e+00 -7.68569644e-01 -7.68569644e-01
 -7.68569644e-01  8.99244767e-01  8.99244767e-01  8.99244767e-01
  1.27526589e+00  3.14805833e+00  3.14805833e+00  3.14805833e+00
  7.73481088e+00  1.09201977e+01  1.09201977e+01  1.09201977e+01
  3.56614077e+01  5.40029868e+01  5.40029868e+01  5.40029868e+01
  1.40185608e+02  5.04458768e+02  1.87204676e+03  8.00157061e+03
  4.77690190e+04]
E1 = -182.136689805068  E_coul = 53.645621556231006
cycle= 1 E= -128.491068248837  delta_E= -0.038  |g|= 0.197  |ddm|= 0.224
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.478097
diis-c [-0.22857655  1.        ]
  HOMO = -0.866746223383377  LUMO = 0.881189075073582
  mo_energy =
[-3.28687910e+01 -1.95604551e+00 -8.66746223e-01 -8.66746223e-01
 -8.66746223e-01  8.81189075e-01  8.81189075e-01  8.81189075e-01
  1.23705641e+00  3.08721624e+00  3.08721624e+00  3.08721624e+00
  7.61191864e+00  1.07594229e+01  1.07594229e+01  1.07594229e+01
  3.54272928e+01  5.37216746e+01  5.37216746e+01  5.37216746e+01
  1.39879609e+02  5.04107355e+02  1.87165880e+03  8.00115354e+03
  4.77685831e+04]
E1 = -182.83801176686225  E_coul = 54.344518410930625
cycle= 2 E= -128.493493355932  delta_E= -0.00243  |g|= 0.095  |ddm|= 0.129
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23391
diis-c [-5.16908550e-04  3.27725823e-01  6.72274177e-01]
  HOMO = -0.833578103029477  LUMO = 0.88842351034649
  mo_energy =
[-3.27677044e+01 -1.92119558e+00 -8.33578103e-01 -8.33578103e-01
 -8.33578103e-01  8.88423510e-01  8.88423510e-01  8.88423510e-01
  1.25126842e+00  3.10856454e+00  3.10856454e+00  3.10856454e+00
  7.65316916e+00  1.08131597e+01  1.08131597e+01  1.08131597e+01
  3.55047371e+01  5.38136941e+01  5.38136941e+01  5.38136941e+01
  1.39978847e+02  5.04216901e+02  1.87177346e+03  8.00127062e+03
  4.77687011e+04]
E1 = -182.6115679580676  E_coul = 54.11732871791422
cycle= 3 E= -128.494239240153  delta_E= -0.000746  |g|= 0.000879  |ddm|= 0.0288
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000619428
diis-c [-2.53467005e-07 -1.45645330e-03 -4.43684106e-03  1.00589329e+00]
  HOMO = -0.833417595063103  LUMO = 0.888549915873159
  mo_energy =
[-3.27674464e+01 -1.92091533e+00 -8.33417595e-01 -8.33417595e-01
 -8.33417595e-01  8.88549916e-01  8.88549916e-01  8.88549916e-01
  1.25152642e+00  3.10878177e+00  3.10878177e+00  3.10878177e+00
  7.65343674e+00  1.08134328e+01  1.08134328e+01  1.08134328e+01
  3.55050052e+01  5.38139621e+01  5.38139621e+01  5.38139621e+01
  1.39979113e+02  5.04217148e+02  1.87177366e+03  8.00127079e+03
  4.77687013e+04]
E1 = -182.61161233643492  E_coul = 54.11737296017832
cycle= 4 E= -128.494239376257  delta_E= -1.36e-07  |g|= 0.000137  |ddm|= 0.00238
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013036
diis-c [-4.29968919e-09  4.97032572e-04  1.38552785e-03 -2.91821124e-01
  1.28993856e+00]
  HOMO = -0.833381192850041  LUMO = 0.888567740907249
  mo_energy =
[-3.27673968e+01 -1.92084667e+00 -8.33381193e-01 -8.33381193e-01
 -8.33381193e-01  8.88567741e-01  8.88567741e-01  8.88567741e-01
  1.25157691e+00  3.10881869e+00  3.10881869e+00  3.10881869e+00
  7.65349263e+00  1.08134835e+01  1.08134835e+01  1.08134835e+01
  3.55050592e+01  5.38140138e+01  5.38140138e+01  5.38140138e+01
  1.39979162e+02  5.04217189e+02  1.87177370e+03  8.00127082e+03
  4.77687013e+04]
E1 = -182.6116665914764  E_coul = 54.117427211390314
cycle= 5 E= -128.494239380086  delta_E= -3.83e-09  |g|= 1.09e-05  |ddm|= 0.000449
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.11487e-05
diis-c [-1.35388376e-11 -1.72100531e-05 -1.71195521e-05  1.96956687e-02
 -9.58695014e-02  1.07620816e+00]
  HOMO = -0.833383916676515  LUMO = 0.888566446271239
  mo_energy =
[-3.27674016e+01 -1.92084901e+00 -8.33383917e-01 -8.33383917e-01
 -8.33383917e-01  8.88566446e-01  8.88566446e-01  8.88566446e-01
  1.25157472e+00  3.10881617e+00  3.10881617e+00  3.10881617e+00
  7.65349022e+00  1.08134800e+01  1.08134800e+01  1.08134800e+01
  3.55050557e+01  5.38140095e+01  5.38140095e+01  5.38140095e+01
  1.39979157e+02  5.04217182e+02  1.87177369e+03  8.00127081e+03
  4.77687013e+04]
E1 = -182.61166426744867  E_coul = 54.11742488734448
cycle= 6 E= -128.494239380104  delta_E= -1.81e-11  |g|= 1.41e-06  |ddm|= 3.12e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.61166426744867  E_coul = 54.11742488734448
  HOMO = -0.833384717885585  LUMO = 0.888566207791192
  mo_energy =
[-3.27674032e+01 -1.92084990e+00 -8.33384718e-01 -8.33384718e-01
 -8.33384718e-01  8.88566208e-01  8.88566208e-01  8.88566208e-01
  1.25157421e+00  3.10881556e+00  3.10881556e+00  3.10881556e+00
  7.65348925e+00  1.08134789e+01  1.08134789e+01  1.08134789e+01
  3.55050542e+01  5.38140079e+01  5.38140079e+01  5.38140079e+01
  1.39979156e+02  5.04217181e+02  1.87177369e+03  8.00127080e+03
  4.77687013e+04]
E1 = -182.61166699233652  E_coul = 54.11742761223214
Extra cycle  E= -128.494239380104  delta_E= -1.71e-13  |g|= 4.21e-07  |ddm|= 2.42e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220688e+01 2.71465490e+01 3.92328945e-01
 3.00806101e+00 1.15977153e+00 1.70228592e+00 6.25439258e+00
 2.83301853e+01 3.90657296e-01 5.02028933e-01]
E = -128.49423938010437
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742949        1
[INPUT] 0    0    [1    /1   ]  76.480966455         1
[INPUT] 0    0    [1    /1   ]  10.1220688109        1
[INPUT] 0    0    [1    /1   ]  27.1465490418        1
[INPUT] 0    0    [1    /1   ]  0.392328945229       1
[INPUT] 0    0    [1    /1   ]  3.00806101117        1
[INPUT] 0    0    [1    /1   ]  1.15977153485        1
[INPUT] 1    0    [1    /1   ]  1.7022859247         1
[INPUT] 1    0    [1    /1   ]  6.25439257761        1
[INPUT] 1    0    [1    /1   ]  28.3301852991        1
[INPUT] 1    0    [1    /1   ]  0.39065729635        1
[INPUT] 1    0    [1    /1   ]  0.50202893317        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068426, 1.0]], [0, [833.2724342911824, 1.0]], [0, [235.7217429488531, 1.0]], [0, [76.48096645499871, 1.0]], [0, [10.122068810913717, 1.0]], [0, [27.14654904181366, 1.0]], [0, [0.39232894522869877, 1.0]], [0, [3.008061011165179, 1.0]], [0, [1.1597715348471551, 1.0]], [1, [1.7022859247003392, 1.0]], [1, [6.254392577613995, 1.0]], [1, [28.330185299078096, 1.0]], [1, [0.39065729635013635, 1.0]], [1, [0.5020289331701373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096645]
bas 5, expnt(s) = [10.12206881]
bas 6, expnt(s) = [27.14654904]
bas 7, expnt(s) = [0.39232895]
bas 8, expnt(s) = [3.00806101]
bas 9, expnt(s) = [1.15977153]
bas 10, expnt(s) = [1.70228592]
bas 11, expnt(s) = [6.25439258]
bas 12, expnt(s) = [28.3301853]
bas 13, expnt(s) = [0.3906573]
bas 14, expnt(s) = [0.50202893]
CPU time:         7.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401383e+01 1.01220688e+01 1.43372873e+01
 2.71465490e+01 3.00469916e+01 3.92328945e-01 1.25242805e+00
 3.00806101e+00 5.77072003e+00 1.15977153e+00 2.82354269e+00
 1.70228592e+00 5.67250683e+00 6.25439258e+00 2.88546503e+01
 2.83301853e+01 1.90676057e+02 3.90657296e-01 9.01009391e-01
 5.02028933e-01 1.23280767e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.993976609284548
cond(S) = 431.52109740383605
E1 = -183.51886684046184  E_coul = 55.06578287609348
init E= -128.453083964368
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.768569643838668  LUMO = 0.899244766647594
  mo_energy =
[-3.25575748e+01 -1.85393621e+00 -7.68569644e-01 -7.68569644e-01
 -7.68569644e-01  8.99244767e-01  8.99244767e-01  8.99244767e-01
  1.27526589e+00  3.14805833e+00  3.14805833e+00  3.14805833e+00
  7.73481088e+00  1.09201977e+01  1.09201977e+01  1.09201977e+01
  3.56614077e+01  5.40029868e+01  5.40029868e+01  5.40029868e+01
  1.40185608e+02  5.04458768e+02  1.87204676e+03  8.00157061e+03
  4.77690190e+04]
E1 = -182.136689805068  E_coul = 53.645621556231006
cycle= 1 E= -128.491068248837  delta_E= -0.038  |g|= 0.197  |ddm|= 0.224
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.478097
diis-c [-0.22857655  1.        ]
  HOMO = -0.866746223383377  LUMO = 0.881189075073582
  mo_energy =
[-3.28687910e+01 -1.95604551e+00 -8.66746223e-01 -8.66746223e-01
 -8.66746223e-01  8.81189075e-01  8.81189075e-01  8.81189075e-01
  1.23705641e+00  3.08721624e+00  3.08721624e+00  3.08721624e+00
  7.61191864e+00  1.07594229e+01  1.07594229e+01  1.07594229e+01
  3.54272928e+01  5.37216746e+01  5.37216746e+01  5.37216746e+01
  1.39879609e+02  5.04107355e+02  1.87165880e+03  8.00115354e+03
  4.77685831e+04]
E1 = -182.83801176686225  E_coul = 54.344518410930625
cycle= 2 E= -128.493493355932  delta_E= -0.00243  |g|= 0.095  |ddm|= 0.129
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23391
diis-c [-5.16908550e-04  3.27725823e-01  6.72274177e-01]
  HOMO = -0.833578103029477  LUMO = 0.88842351034649
  mo_energy =
[-3.27677044e+01 -1.92119558e+00 -8.33578103e-01 -8.33578103e-01
 -8.33578103e-01  8.88423510e-01  8.88423510e-01  8.88423510e-01
  1.25126842e+00  3.10856454e+00  3.10856454e+00  3.10856454e+00
  7.65316916e+00  1.08131597e+01  1.08131597e+01  1.08131597e+01
  3.55047371e+01  5.38136941e+01  5.38136941e+01  5.38136941e+01
  1.39978847e+02  5.04216901e+02  1.87177346e+03  8.00127062e+03
  4.77687011e+04]
E1 = -182.6115679580676  E_coul = 54.11732871791422
cycle= 3 E= -128.494239240153  delta_E= -0.000746  |g|= 0.000879  |ddm|= 0.0288
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000619428
diis-c [-2.53467005e-07 -1.45645330e-03 -4.43684106e-03  1.00589329e+00]
  HOMO = -0.833417595063103  LUMO = 0.888549915873159
  mo_energy =
[-3.27674464e+01 -1.92091533e+00 -8.33417595e-01 -8.33417595e-01
 -8.33417595e-01  8.88549916e-01  8.88549916e-01  8.88549916e-01
  1.25152642e+00  3.10878177e+00  3.10878177e+00  3.10878177e+00
  7.65343674e+00  1.08134328e+01  1.08134328e+01  1.08134328e+01
  3.55050052e+01  5.38139621e+01  5.38139621e+01  5.38139621e+01
  1.39979113e+02  5.04217148e+02  1.87177366e+03  8.00127079e+03
  4.77687013e+04]
E1 = -182.61161233643492  E_coul = 54.11737296017832
cycle= 4 E= -128.494239376257  delta_E= -1.36e-07  |g|= 0.000137  |ddm|= 0.00238
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013036
diis-c [-4.29968919e-09  4.97032572e-04  1.38552785e-03 -2.91821124e-01
  1.28993856e+00]
  HOMO = -0.833381192850041  LUMO = 0.888567740907249
  mo_energy =
[-3.27673968e+01 -1.92084667e+00 -8.33381193e-01 -8.33381193e-01
 -8.33381193e-01  8.88567741e-01  8.88567741e-01  8.88567741e-01
  1.25157691e+00  3.10881869e+00  3.10881869e+00  3.10881869e+00
  7.65349263e+00  1.08134835e+01  1.08134835e+01  1.08134835e+01
  3.55050592e+01  5.38140138e+01  5.38140138e+01  5.38140138e+01
  1.39979162e+02  5.04217189e+02  1.87177370e+03  8.00127082e+03
  4.77687013e+04]
E1 = -182.6116665914764  E_coul = 54.117427211390314
cycle= 5 E= -128.494239380086  delta_E= -3.83e-09  |g|= 1.09e-05  |ddm|= 0.000449
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.11487e-05
diis-c [-1.35388376e-11 -1.72100531e-05 -1.71195521e-05  1.96956687e-02
 -9.58695014e-02  1.07620816e+00]
  HOMO = -0.833383916676515  LUMO = 0.888566446271239
  mo_energy =
[-3.27674016e+01 -1.92084901e+00 -8.33383917e-01 -8.33383917e-01
 -8.33383917e-01  8.88566446e-01  8.88566446e-01  8.88566446e-01
  1.25157472e+00  3.10881617e+00  3.10881617e+00  3.10881617e+00
  7.65349022e+00  1.08134800e+01  1.08134800e+01  1.08134800e+01
  3.55050557e+01  5.38140095e+01  5.38140095e+01  5.38140095e+01
  1.39979157e+02  5.04217182e+02  1.87177369e+03  8.00127081e+03
  4.77687013e+04]
E1 = -182.61166426744867  E_coul = 54.11742488734448
cycle= 6 E= -128.494239380104  delta_E= -1.81e-11  |g|= 1.41e-06  |ddm|= 3.12e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.61166426744867  E_coul = 54.11742488734448
  HOMO = -0.833384717885585  LUMO = 0.888566207791192
  mo_energy =
[-3.27674032e+01 -1.92084990e+00 -8.33384718e-01 -8.33384718e-01
 -8.33384718e-01  8.88566208e-01  8.88566208e-01  8.88566208e-01
  1.25157421e+00  3.10881556e+00  3.10881556e+00  3.10881556e+00
  7.65348925e+00  1.08134789e+01  1.08134789e+01  1.08134789e+01
  3.55050542e+01  5.38140079e+01  5.38140079e+01  5.38140079e+01
  1.39979156e+02  5.04217181e+02  1.87177369e+03  8.00127080e+03
  4.77687013e+04]
E1 = -182.61166699233652  E_coul = 54.11742761223214
Extra cycle  E= -128.494239380104  delta_E= -1.71e-13  |g|= 4.21e-07  |ddm|= 2.42e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 431.52109740383605
E1 = -182.61166699233652  E_coul = 54.11742761223214
init E= -128.494239380104
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.833384537308537  LUMO = 0.888566236938703
  mo_energy =
[-3.27674025e+01 -1.92084972e+00 -8.33384537e-01 -8.33384537e-01
 -8.33384537e-01  8.88566237e-01  8.88566237e-01  8.88566237e-01
  1.25157425e+00  3.10881567e+00  3.10881567e+00  3.10881567e+00
  7.65348947e+00  1.08134792e+01  1.08134792e+01  1.08134792e+01
  3.55050547e+01  5.38140085e+01  5.38140085e+01  5.38140085e+01
  1.39979156e+02  5.04217181e+02  1.87177369e+03  8.00127081e+03
  4.77687013e+04]
E1 = -182.611665368922  E_coul = 54.11742598881741
cycle= 1 E= -128.494239380105  delta_E= -1.99e-13  |g|= 2.19e-07  |ddm|= 5.87e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.611665368922  E_coul = 54.11742598881741
  HOMO = -0.833384652699573  LUMO = 0.888566210798237
  mo_energy =
[-3.27674029e+01 -1.92084985e+00 -8.33384653e-01 -8.33384653e-01
 -8.33384653e-01  8.88566211e-01  8.88566211e-01  8.88566211e-01
  1.25157420e+00  3.10881559e+00  3.10881559e+00  3.10881559e+00
  7.65348932e+00  1.08134790e+01  1.08134790e+01  1.08134790e+01
  3.55050545e+01  5.38140082e+01  5.38140082e+01  5.38140082e+01
  1.39979156e+02  5.04217181e+02  1.87177369e+03  8.00127081e+03
  4.77687013e+04]
E1 = -182.6116661172363  E_coul = 54.11742673713159
Extra cycle  E= -128.494239380105  delta_E= -1.42e-13  |g|= 1.02e-07  |ddm|= 7.46e-08
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220688e+01 2.71465490e+01 3.92328945e-01
 3.00806101e+00 1.15977153e+00 1.70228592e+00 6.25439258e+00
 2.83301853e+01 3.90657296e-01 5.02028933e-01]
grad_E = [ 1.88642787e-12 -2.33251741e-11  5.00442294e-10 -6.73693959e-09
  5.91934874e-08  1.85157562e-06 -4.30072533e-07  2.10940521e-04
  5.13441520e-06 -5.15056785e-05 -5.64075932e-03 -3.51999387e-04
  3.16860450e-05  4.79237974e-02 -2.40421116e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.72174296         1
[INPUT] 0    0    [1    /1   ]  76.4809663907        1
[INPUT] 0    0    [1    /1   ]  10.1220698235        1
[INPUT] 0    0    [1    /1   ]  27.1465492935        1
[INPUT] 0    0    [1    /1   ]  0.392585034654       1
[INPUT] 0    0    [1    /1   ]  3.00807840031        1
[INPUT] 0    0    [1    /1   ]  1.15959318572        1
[INPUT] 1    0    [1    /1   ]  1.78208881303        1
[INPUT] 1    0    [1    /1   ]  6.24993317897        1
[INPUT] 1    0    [1    /1   ]  28.3302549559        1
[INPUT] 1    0    [1    /1   ]  1.00000002723e-09      1
[INPUT] 1    0    [1    /1   ]  0.617524108147       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141171, 1.0]], [0, [3661.4543980684452, 1.0]], [0, [833.2724342905483, 1.0]], [0, [235.72174295955432, 1.0]], [0, [76.48096639068832, 1.0]], [0, [10.122069823478276, 1.0]], [0, [27.146549293486117, 1.0]], [0, [0.3925850346535269, 1.0]], [0, [3.0080784003097927, 1.0]], [0, [1.1595931857168116, 1.0]], [1, [1.7820888130263324, 1.0]], [1, [6.249933178966749, 1.0]], [1, [28.330254955857708, 1.0]], [1, [1.0000000272292198e-09, 1.0]], [1, [0.6175241081467149, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174296]
bas 4, expnt(s) = [76.48096639]
bas 5, expnt(s) = [10.12206982]
bas 6, expnt(s) = [27.14654929]
bas 7, expnt(s) = [0.39258503]
bas 8, expnt(s) = [3.0080784]
bas 9, expnt(s) = [1.15959319]
bas 10, expnt(s) = [1.78208881]
bas 11, expnt(s) = [6.24993318]
bas 12, expnt(s) = [28.33025496]
bas 13, expnt(s) = [1.00000003e-09]
bas 14, expnt(s) = [0.61752411]
CPU time:         9.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809664e+01 6.53401383e+01 1.01220698e+01 1.43372884e+01
 2.71465493e+01 3.00469918e+01 3.92585035e-01 1.25304114e+00
 3.00807840e+00 5.77074505e+00 1.15959319e+00 2.82321703e+00
 1.78208881e+00 6.00684012e+00 6.24993318e+00 2.88289357e+01
 2.83302550e+01 1.90676643e+02 1.00000003e-09 1.64053087e-11
 6.17524108e-01 1.59698850e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.953926513169552
cond(S) = 360.41965444112367
E1 = -183.3056418858278  E_coul = 55.00583751777403
init E= -128.299804368054
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.758753810326974  LUMO = -0.000336415174189018
  mo_energy =
[-3.25609514e+01 -1.86124342e+00 -7.58753810e-01 -7.58753810e-01
 -7.58753810e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.27427170e+00  2.22538880e+00  2.22538880e+00  2.22538880e+00
  7.72433654e+00  1.04214973e+01  1.04214973e+01  1.04214973e+01
  3.56547666e+01  5.37912990e+01  5.37912990e+01  5.37912990e+01
  1.40181589e+02  5.04452038e+02  1.87203799e+03  8.00156121e+03
  4.77690095e+04]
E1 = -183.33931806284653  E_coul = 54.9359260636892
cycle= 1 E= -128.403391999157  delta_E= -0.104  |g|= 0.071  |ddm|= 0.222
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.131646
diis-c [-0.01733064  1.        ]
  HOMO = -0.749476860576874  LUMO = -0.000336415174182855
  mo_energy =
[-3.26432084e+01 -1.84227366e+00 -7.49476861e-01 -7.49476861e-01
 -7.49476861e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.30052891e+00  2.24444235e+00  2.24444235e+00  2.24444235e+00
  7.73753952e+00  1.04163985e+01  1.04163985e+01  1.04163985e+01
  3.56189861e+01  5.37250319e+01  5.37250319e+01  5.37250319e+01
  1.40101616e+02  5.04339795e+02  1.87189423e+03  8.00138975e+03
  4.77688195e+04]
E1 = -183.47294256011745  E_coul = 55.06925227488125
cycle= 2 E= -128.403690285236  delta_E= -0.000298  |g|= 0.0191  |ddm|= 0.0274
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0360611
diis-c [-5.45086722e-04  1.75004058e-01  8.24995942e-01]
  HOMO = -0.74200166812402  LUMO = -0.000336415174185589
  mo_energy =
[-3.26192419e+01 -1.83365622e+00 -7.42001668e-01 -7.42001668e-01
 -7.42001668e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.30387834e+00  2.24933393e+00  2.24933393e+00  2.24933393e+00
  7.74731237e+00  1.04292422e+01  1.04292422e+01  1.04292422e+01
  3.56372750e+01  5.37468717e+01  5.37468717e+01  5.37468717e+01
  1.40125261e+02  5.04365999e+02  1.87192158e+03  8.00141755e+03
  4.77688475e+04]
E1 = -183.43003544836088  E_coul = 55.026317839907364
cycle= 3 E= -128.403717608454  delta_E= -2.73e-05  |g|= 0.00309  |ddm|= 0.00634
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00647251
diis-c [-8.57239972e-06 -1.90672476e-02  9.39087086e-02  9.25158539e-01]
  HOMO = -0.7430469751694  LUMO = -0.000336415174201684
  mo_energy =
[-3.26224711e+01 -1.83421089e+00 -7.43046975e-01 -7.43046975e-01
 -7.43046975e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.30374476e+00  2.24865388e+00  2.24865388e+00  2.24865388e+00
  7.74631309e+00  1.04275982e+01  1.04275982e+01  1.04275982e+01
  3.56349725e+01  5.37439961e+01  5.37439961e+01  5.37439961e+01
  1.40122111e+02  5.04362337e+02  1.87191754e+03  8.00141329e+03
  4.77688431e+04]
E1 = -183.43552324990196  E_coul = 55.03180455202451
cycle= 4 E= -128.403718697877  delta_E= -1.09e-06  |g|= 0.000349  |ddm|= 0.00135
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000556653
diis-c [-1.48761544e-08  1.14729142e-03 -2.21156169e-02 -1.81401511e-01
  1.20236984e+00]
  HOMO = -0.743094238512246  LUMO = -0.000336415174194475
  mo_energy =
[-3.26225038e+01 -1.83414194e+00 -7.43094239e-01 -7.43094239e-01
 -7.43094239e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.30377815e+00  2.24861889e+00  2.24861889e+00  2.24861889e+00
  7.74632613e+00  1.04275617e+01  1.04275617e+01  1.04275617e+01
  3.56349623e+01  5.37439717e+01  5.37439717e+01  5.37439717e+01
  1.40122070e+02  5.04362231e+02  1.87191737e+03  8.00141307e+03
  4.77688429e+04]
E1 = -183.43547906648627  E_coul = 55.03176034886361
cycle= 5 E= -128.403718717623  delta_E= -1.97e-08  |g|= 1.4e-05  |ddm|= 0.000282
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.82804e-05
diis-c [-1.66133599e-11 -6.16119029e-05  2.08908150e-03  1.06507748e-02
 -7.99483840e-02  1.06727014e+00]
  HOMO = -0.743100507863976  LUMO = -0.000336415174183591
  mo_energy =
[-3.26225179e+01 -1.83414844e+00 -7.43100508e-01 -7.43100508e-01
 -7.43100508e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.30377533e+00  2.24861468e+00  2.24861468e+00  2.24861468e+00
  7.74631863e+00  1.04275520e+01  1.04275520e+01  1.04275520e+01
  3.56349503e+01  5.37439583e+01  5.37439583e+01  5.37439583e+01
  1.40122055e+02  5.04362214e+02  1.87191735e+03  8.00141305e+03
  4.77688428e+04]
E1 = -183.43550416128625  E_coul = 55.031785443651415
cycle= 6 E= -128.403718717635  delta_E= -1.22e-11  |g|= 3.19e-07  |ddm|= 3.35e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.43550416128625  E_coul = 55.031785443651415
  HOMO = -0.743100323204222  LUMO = -0.000336415174184375
  mo_energy =
[-3.26225174e+01 -1.83414826e+00 -7.43100323e-01 -7.43100323e-01
 -7.43100323e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.30377541e+00  2.24861481e+00  2.24861481e+00  2.24861481e+00
  7.74631885e+00  1.04275522e+01  1.04275522e+01  1.04275522e+01
  3.56349507e+01  5.37439587e+01  5.37439587e+01  5.37439587e+01
  1.40122056e+02  5.04362215e+02  1.87191735e+03  8.00141305e+03
  4.77688428e+04]
E1 = -183.4355033363009  E_coul = 55.031784618666116
Extra cycle  E= -128.403718717635  delta_E= 2.84e-14  |g|= 1.12e-07  |ddm|= 9.64e-08
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809664e+01 1.01220698e+01 2.71465493e+01 3.92585035e-01
 3.00807840e+00 1.15959319e+00 1.78208881e+00 6.24993318e+00
 2.83302550e+01 1.00000003e-09 6.17524108e-01]
E = -128.4037187176348
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.72174295         1
[INPUT] 0    0    [1    /1   ]  76.4809664486        1
[INPUT] 0    0    [1    /1   ]  10.1220689122        1
[INPUT] 0    0    [1    /1   ]  27.146549067         1
[INPUT] 0    0    [1    /1   ]  0.392354554171       1
[INPUT] 0    0    [1    /1   ]  3.00806275008        1
[INPUT] 0    0    [1    /1   ]  1.15975369993        1
[INPUT] 1    0    [1    /1   ]  1.71026621353        1
[INPUT] 1    0    [1    /1   ]  6.25394663775        1
[INPUT] 1    0    [1    /1   ]  28.3301922648        1
[INPUT] 1    0    [1    /1   ]  0.351591566815       1
[INPUT] 1    0    [1    /1   ]  0.513578450668       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068428, 1.0]], [0, [833.272434291119, 1.0]], [0, [235.72174294992323, 1.0]], [0, [76.48096644856767, 1.0]], [0, [10.122068912170173, 1.0]], [0, [27.146549066980906, 1.0]], [0, [0.3923545541711816, 1.0]], [0, [3.0080627500796404, 1.0]], [0, [1.1597536999341207, 1.0]], [1, [1.7102662135329385, 1.0]], [1, [6.25394663774927, 1.0]], [1, [28.330192264756057, 1.0]], [1, [0.3515915668151227, 1.0]], [1, [0.5135784506677951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096645]
bas 5, expnt(s) = [10.12206891]
bas 6, expnt(s) = [27.14654907]
bas 7, expnt(s) = [0.39235455]
bas 8, expnt(s) = [3.00806275]
bas 9, expnt(s) = [1.1597537]
bas 10, expnt(s) = [1.71026621]
bas 11, expnt(s) = [6.25394664]
bas 12, expnt(s) = [28.33019226]
bas 13, expnt(s) = [0.35159157]
bas 14, expnt(s) = [0.51357845]
CPU time:        10.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809664e+01 6.53401383e+01 1.01220689e+01 1.43372874e+01
 2.71465491e+01 3.00469916e+01 3.92354554e-01 1.25248937e+00
 3.00806275e+00 5.77072253e+00 1.15975370e+00 2.82351012e+00
 1.71026621e+00 5.70576707e+00 6.25394664e+00 2.88520786e+01
 2.83301923e+01 1.90676115e+02 3.51591567e-01 7.89827871e-01
 5.13578451e-01 1.26836101e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99497204634584
cond(S) = 360.38086152658644
E1 = -183.5231669194719  E_coul = 55.06641710877141
init E= -128.4567498107
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.768997470350472  LUMO = 0.848578045065419
  mo_energy =
[-3.25575034e+01 -1.85385637e+00 -7.68997470e-01 -7.68997470e-01
 -7.68997470e-01  8.48578045e-01  8.48578045e-01  8.48578045e-01
  1.27551409e+00  3.05523352e+00  3.05523352e+00  3.05523352e+00
  7.73490391e+00  1.08428317e+01  1.08428317e+01  1.08428317e+01
  3.56614956e+01  5.39587145e+01  5.39587145e+01  5.39587145e+01
  1.40185707e+02  5.04458837e+02  1.87204681e+03  8.00157065e+03
  4.77690191e+04]
E1 = -182.09721745488002  E_coul = 53.60376985764662
cycle= 1 E= -128.493447597233  delta_E= -0.0367  |g|= 0.201  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.48695
diis-c [-0.23711999  1.        ]
  HOMO = -0.870457280885624  LUMO = 0.830493476826354
  mo_energy =
[-3.28761823e+01 -1.95977283e+00 -8.70457281e-01 -8.70457281e-01
 -8.70457281e-01  8.30493477e-01  8.30493477e-01  8.30493477e-01
  1.23508747e+00  2.99206804e+00  2.99206804e+00  2.99206804e+00
  7.60781761e+00  1.06765816e+01  1.06765816e+01  1.06765816e+01
  3.54210547e+01  5.36702778e+01  5.36702778e+01  5.36702778e+01
  1.39872380e+02  5.04099794e+02  1.87165114e+03  8.00114586e+03
  4.77685754e+04]
E1 = -182.82214967577724  E_coul = 54.326161758546654
cycle= 2 E= -128.495987917231  delta_E= -0.00254  |g|= 0.0982  |ddm|= 0.0921
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.240261
diis-c [-5.28989000e-04  3.29616203e-01  6.70383797e-01]
  HOMO = -0.83624364020195  LUMO = 0.837555345622324
  mo_energy =
[-3.27721058e+01 -1.92380182e+00 -8.36243640e-01 -8.36243640e-01
 -8.36243640e-01  8.37555346e-01  8.37555346e-01  8.37555346e-01
  1.24977986e+00  3.01402203e+00  3.01402203e+00  3.01402203e+00
  7.65038497e+00  1.07321784e+01  1.07321784e+01  1.07321784e+01
  3.55008532e+01  5.37650675e+01  5.37650675e+01  5.37650675e+01
  1.39974550e+02  5.04212531e+02  1.87176912e+03  8.00126632e+03
  4.77686968e+04]
E1 = -182.58658805675424  E_coul = 54.08979889013322
cycle= 3 E= -128.496789166621  delta_E= -0.000801  |g|= 0.000801  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00060024
diis-c [-2.09940458e-07 -1.48860058e-03 -4.55175372e-03  1.00604035e+00]
  HOMO = -0.836089681951363  LUMO = 0.837673869771755
  mo_energy =
[-3.27718562e+01 -1.92354471e+00 -8.36089682e-01 -8.36089682e-01
 -8.36089682e-01  8.37673870e-01  8.37673870e-01  8.37673870e-01
  1.25002124e+00  3.01423345e+00  3.01423345e+00  3.01423345e+00
  7.65064070e+00  1.07324453e+01  1.07324453e+01  1.07324453e+01
  3.55011129e+01  5.37653268e+01  5.37653268e+01  5.37653268e+01
  1.39974808e+02  5.04212772e+02  1.87176932e+03  8.00126649e+03
  4.77686970e+04]
E1 = -182.5865681452778  E_coul = 54.08977886472887
cycle= 4 E= -128.496789280549  delta_E= -1.14e-07  |g|= 0.000122  |ddm|= 0.00147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000113102
diis-c [-4.23831360e-09  4.26083793e-04  1.21219467e-03 -2.56470141e-01
  1.25483186e+00]
  HOMO = -0.836056873638911  LUMO = 0.837689467195648
  mo_energy =
[-3.27718125e+01 -1.92348532e+00 -8.36056874e-01 -8.36056874e-01
 -8.36056874e-01  8.37689467e-01  8.37689467e-01  8.37689467e-01
  1.25006566e+00  3.01426678e+00  3.01426678e+00  3.01426678e+00
  7.65068949e+00  1.07324904e+01  1.07324904e+01  1.07324904e+01
  3.55011600e+01  5.37653722e+01  5.37653722e+01  5.37653722e+01
  1.39974852e+02  5.04212810e+02  1.87176936e+03  8.00126652e+03
  4.77686970e+04]
E1 = -182.5866251004461  E_coul = 54.089835816716544
cycle= 5 E= -128.49678928373  delta_E= -3.18e-09  |g|= 7.81e-06  |ddm|= 0.000277
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.7318e-06
diis-c [-1.70164548e-11 -1.40444705e-05 -3.12759670e-05  2.10360619e-02
 -1.30049589e-01  1.10905885e+00]
  HOMO = -0.836057960205283  LUMO = 0.837688867258555
  mo_energy =
[-3.27718146e+01 -1.92348521e+00 -8.36057960e-01 -8.36057960e-01
 -8.36057960e-01  8.37688867e-01  8.37688867e-01  8.37688867e-01
  1.25006518e+00  3.01426573e+00  3.01426573e+00  3.01426573e+00
  7.65068932e+00  1.07324892e+01  1.07324892e+01  1.07324892e+01
  3.55011591e+01  5.37653705e+01  5.37653705e+01  5.37653705e+01
  1.39974849e+02  5.04212806e+02  1.87176935e+03  8.00126651e+03
  4.77686970e+04]
E1 = -182.58662185477382  E_coul = 54.089832571036126
cycle= 6 E= -128.496789283738  delta_E= -8.16e-12  |g|= 1.29e-06  |ddm|= 1.2e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.58662185477382  E_coul = 54.089832571036126
  HOMO = -0.836058722122324  LUMO = 0.837688655966367
  mo_energy =
[-3.27718162e+01 -1.92348603e+00 -8.36058722e-01 -8.36058722e-01
 -8.36058722e-01  8.37688656e-01  8.37688656e-01  8.37688656e-01
  1.25006471e+00  3.01426516e+00  3.01426516e+00  3.01426516e+00
  7.65068840e+00  1.07324881e+01  1.07324881e+01  1.07324881e+01
  3.55011577e+01  5.37653690e+01  5.37653690e+01  5.37653690e+01
  1.39974848e+02  5.04212804e+02  1.87176935e+03  8.00126651e+03
  4.77686970e+04]
E1 = -182.58662459551974  E_coul = 54.089835311781954
Extra cycle  E= -128.496789283738  delta_E= -5.68e-14  |g|= 4.15e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809664e+01 1.01220689e+01 2.71465491e+01 3.92354554e-01
 3.00806275e+00 1.15975370e+00 1.71026621e+00 6.25394664e+00
 2.83301923e+01 3.51591567e-01 5.13578451e-01]
E = -128.49678928373777
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "10s5p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.72174295         1
[INPUT] 0    0    [1    /1   ]  76.4809664486        1
[INPUT] 0    0    [1    /1   ]  10.1220689122        1
[INPUT] 0    0    [1    /1   ]  27.146549067         1
[INPUT] 0    0    [1    /1   ]  0.392354554171       1
[INPUT] 0    0    [1    /1   ]  3.00806275008        1
[INPUT] 0    0    [1    /1   ]  1.15975369993        1
[INPUT] 1    0    [1    /1   ]  1.71026621353        1
[INPUT] 1    0    [1    /1   ]  6.25394663775        1
[INPUT] 1    0    [1    /1   ]  28.3301922648        1
[INPUT] 1    0    [1    /1   ]  0.351591566815       1
[INPUT] 1    0    [1    /1   ]  0.513578450668       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068428, 1.0]], [0, [833.272434291119, 1.0]], [0, [235.72174294992323, 1.0]], [0, [76.48096644856767, 1.0]], [0, [10.122068912170173, 1.0]], [0, [27.146549066980906, 1.0]], [0, [0.3923545541711816, 1.0]], [0, [3.0080627500796404, 1.0]], [0, [1.1597536999341207, 1.0]], [1, [1.7102662135329385, 1.0]], [1, [6.25394663774927, 1.0]], [1, [28.330192264756057, 1.0]], [1, [0.3515915668151227, 1.0]], [1, [0.5135784506677951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096645]
bas 5, expnt(s) = [10.12206891]
bas 6, expnt(s) = [27.14654907]
bas 7, expnt(s) = [0.39235455]
bas 8, expnt(s) = [3.00806275]
bas 9, expnt(s) = [1.1597537]
bas 10, expnt(s) = [1.71026621]
bas 11, expnt(s) = [6.25394664]
bas 12, expnt(s) = [28.33019226]
bas 13, expnt(s) = [0.35159157]
bas 14, expnt(s) = [0.51357845]
CPU time:        10.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809664e+01 6.53401383e+01 1.01220689e+01 1.43372874e+01
 2.71465491e+01 3.00469916e+01 3.92354554e-01 1.25248937e+00
 3.00806275e+00 5.77072253e+00 1.15975370e+00 2.82351012e+00
 1.71026621e+00 5.70576707e+00 6.25394664e+00 2.88520786e+01
 2.83301923e+01 1.90676115e+02 3.51591567e-01 7.89827871e-01
 5.13578451e-01 1.26836101e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99497204634584
cond(S) = 360.38086152658644
E1 = -183.5231669194719  E_coul = 55.06641710877141
init E= -128.4567498107
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.768997470350472  LUMO = 0.848578045065419
  mo_energy =
[-3.25575034e+01 -1.85385637e+00 -7.68997470e-01 -7.68997470e-01
 -7.68997470e-01  8.48578045e-01  8.48578045e-01  8.48578045e-01
  1.27551409e+00  3.05523352e+00  3.05523352e+00  3.05523352e+00
  7.73490391e+00  1.08428317e+01  1.08428317e+01  1.08428317e+01
  3.56614956e+01  5.39587145e+01  5.39587145e+01  5.39587145e+01
  1.40185707e+02  5.04458837e+02  1.87204681e+03  8.00157065e+03
  4.77690191e+04]
E1 = -182.09721745488002  E_coul = 53.60376985764662
cycle= 1 E= -128.493447597233  delta_E= -0.0367  |g|= 0.201  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.48695
diis-c [-0.23711999  1.        ]
  HOMO = -0.870457280885624  LUMO = 0.830493476826354
  mo_energy =
[-3.28761823e+01 -1.95977283e+00 -8.70457281e-01 -8.70457281e-01
 -8.70457281e-01  8.30493477e-01  8.30493477e-01  8.30493477e-01
  1.23508747e+00  2.99206804e+00  2.99206804e+00  2.99206804e+00
  7.60781761e+00  1.06765816e+01  1.06765816e+01  1.06765816e+01
  3.54210547e+01  5.36702778e+01  5.36702778e+01  5.36702778e+01
  1.39872380e+02  5.04099794e+02  1.87165114e+03  8.00114586e+03
  4.77685754e+04]
E1 = -182.82214967577724  E_coul = 54.326161758546654
cycle= 2 E= -128.495987917231  delta_E= -0.00254  |g|= 0.0982  |ddm|= 0.0921
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.240261
diis-c [-5.28989000e-04  3.29616203e-01  6.70383797e-01]
  HOMO = -0.83624364020195  LUMO = 0.837555345622324
  mo_energy =
[-3.27721058e+01 -1.92380182e+00 -8.36243640e-01 -8.36243640e-01
 -8.36243640e-01  8.37555346e-01  8.37555346e-01  8.37555346e-01
  1.24977986e+00  3.01402203e+00  3.01402203e+00  3.01402203e+00
  7.65038497e+00  1.07321784e+01  1.07321784e+01  1.07321784e+01
  3.55008532e+01  5.37650675e+01  5.37650675e+01  5.37650675e+01
  1.39974550e+02  5.04212531e+02  1.87176912e+03  8.00126632e+03
  4.77686968e+04]
E1 = -182.58658805675424  E_coul = 54.08979889013322
cycle= 3 E= -128.496789166621  delta_E= -0.000801  |g|= 0.000801  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00060024
diis-c [-2.09940458e-07 -1.48860058e-03 -4.55175372e-03  1.00604035e+00]
  HOMO = -0.836089681951363  LUMO = 0.837673869771755
  mo_energy =
[-3.27718562e+01 -1.92354471e+00 -8.36089682e-01 -8.36089682e-01
 -8.36089682e-01  8.37673870e-01  8.37673870e-01  8.37673870e-01
  1.25002124e+00  3.01423345e+00  3.01423345e+00  3.01423345e+00
  7.65064070e+00  1.07324453e+01  1.07324453e+01  1.07324453e+01
  3.55011129e+01  5.37653268e+01  5.37653268e+01  5.37653268e+01
  1.39974808e+02  5.04212772e+02  1.87176932e+03  8.00126649e+03
  4.77686970e+04]
E1 = -182.5865681452778  E_coul = 54.08977886472887
cycle= 4 E= -128.496789280549  delta_E= -1.14e-07  |g|= 0.000122  |ddm|= 0.00147
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000113102
diis-c [-4.23831360e-09  4.26083793e-04  1.21219467e-03 -2.56470141e-01
  1.25483186e+00]
  HOMO = -0.836056873638911  LUMO = 0.837689467195648
  mo_energy =
[-3.27718125e+01 -1.92348532e+00 -8.36056874e-01 -8.36056874e-01
 -8.36056874e-01  8.37689467e-01  8.37689467e-01  8.37689467e-01
  1.25006566e+00  3.01426678e+00  3.01426678e+00  3.01426678e+00
  7.65068949e+00  1.07324904e+01  1.07324904e+01  1.07324904e+01
  3.55011600e+01  5.37653722e+01  5.37653722e+01  5.37653722e+01
  1.39974852e+02  5.04212810e+02  1.87176936e+03  8.00126652e+03
  4.77686970e+04]
E1 = -182.5866251004461  E_coul = 54.089835816716544
cycle= 5 E= -128.49678928373  delta_E= -3.18e-09  |g|= 7.81e-06  |ddm|= 0.000277
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.7318e-06
diis-c [-1.70164548e-11 -1.40444705e-05 -3.12759670e-05  2.10360619e-02
 -1.30049589e-01  1.10905885e+00]
  HOMO = -0.836057960205283  LUMO = 0.837688867258555
  mo_energy =
[-3.27718146e+01 -1.92348521e+00 -8.36057960e-01 -8.36057960e-01
 -8.36057960e-01  8.37688867e-01  8.37688867e-01  8.37688867e-01
  1.25006518e+00  3.01426573e+00  3.01426573e+00  3.01426573e+00
  7.65068932e+00  1.07324892e+01  1.07324892e+01  1.07324892e+01
  3.55011591e+01  5.37653705e+01  5.37653705e+01  5.37653705e+01
  1.39974849e+02  5.04212806e+02  1.87176935e+03  8.00126651e+03
  4.77686970e+04]
E1 = -182.58662185477382  E_coul = 54.089832571036126
cycle= 6 E= -128.496789283738  delta_E= -8.16e-12  |g|= 1.29e-06  |ddm|= 1.2e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.58662185477382  E_coul = 54.089832571036126
  HOMO = -0.836058722122324  LUMO = 0.837688655966367
  mo_energy =
[-3.27718162e+01 -1.92348603e+00 -8.36058722e-01 -8.36058722e-01
 -8.36058722e-01  8.37688656e-01  8.37688656e-01  8.37688656e-01
  1.25006471e+00  3.01426516e+00  3.01426516e+00  3.01426516e+00
  7.65068840e+00  1.07324881e+01  1.07324881e+01  1.07324881e+01
  3.55011577e+01  5.37653690e+01  5.37653690e+01  5.37653690e+01
  1.39974848e+02  5.04212804e+02  1.87176935e+03  8.00126651e+03
  4.77686970e+04]
E1 = -182.58662459551974  E_coul = 54.089835311781954
Extra cycle  E= -128.496789283738  delta_E= -5.68e-14  |g|= 4.15e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 360.38086152658644
E1 = -182.58662459551974  E_coul = 54.089835311781954
init E= -128.496789283738
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.836058539975555  LUMO = 0.837688684743172
  mo_energy =
[-3.27718155e+01 -1.92348585e+00 -8.36058540e-01 -8.36058540e-01
 -8.36058540e-01  8.37688685e-01  8.37688685e-01  8.37688685e-01
  1.25006476e+00  3.01426527e+00  3.01426527e+00  3.01426527e+00
  7.65068862e+00  1.07324884e+01  1.07324884e+01  1.07324884e+01
  3.55011582e+01  5.37653696e+01  5.37653696e+01  5.37653696e+01
  1.39974849e+02  5.04212805e+02  1.87176935e+03  8.00126651e+03
  4.77686970e+04]
E1 = -182.58662298344433  E_coul = 54.08983369970614
cycle= 1 E= -128.496789283738  delta_E= -4.26e-13  |g|= 2.16e-07  |ddm|= 3.58e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58662298344433  E_coul = 54.08983369970614
  HOMO = -0.836058654723814  LUMO = 0.83768866021757
  mo_energy =
[-3.27718158e+01 -1.92348598e+00 -8.36058655e-01 -8.36058655e-01
 -8.36058655e-01  8.37688660e-01  8.37688660e-01  8.37688660e-01
  1.25006471e+00  3.01426519e+00  3.01426519e+00  3.01426519e+00
  7.65068848e+00  1.07324882e+01  1.07324882e+01  1.07324882e+01
  3.55011579e+01  5.37653693e+01  5.37653693e+01  5.37653693e+01
  1.39974848e+02  5.04212805e+02  1.87176935e+03  8.00126651e+03
  4.77686970e+04]
E1 = -182.58662373720014  E_coul = 54.08983445346201
Extra cycle  E= -128.496789283738  delta_E= 5.68e-14  |g|= 1.03e-07  |ddm|= 7.11e-08
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809664e+01 1.01220689e+01 2.71465491e+01 3.92354554e-01
 3.00806275e+00 1.15975370e+00 1.71026621e+00 6.25394664e+00
 2.83301923e+01 3.51591567e-01 5.13578451e-01]
grad_E = [ 1.83031213e-12 -2.04387873e-11  4.43012692e-10 -6.16971072e-09
  5.76614287e-08  2.40383688e-06 -4.82625810e-07  4.56137307e-04
  8.10273941e-06 -8.98010542e-05 -6.68653844e-03 -6.68063670e-04
  5.29720618e-05  6.02307526e-02 -4.20758986e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.72174295         1
[INPUT] 0    0    [1    /1   ]  76.4809664724        1
[INPUT] 0    0    [1    /1   ]  10.1220717798        1
[INPUT] 0    0    [1    /1   ]  27.1465487926        1
[INPUT] 0    0    [1    /1   ]  0.392411968076       1
[INPUT] 0    0    [1    /1   ]  3.00808441501        1
[INPUT] 0    0    [1    /1   ]  1.1595520882         1
[INPUT] 1    0    [1    /1   ]  1.79744238313        1
[INPUT] 1    0    [1    /1   ]  6.248889296          1
[INPUT] 1    0    [1    /1   ]  28.3302746243        1
[INPUT] 1    0    [1    /1   ]  1.00000030478e-09      1
[INPUT] 1    0    [1    /1   ]  0.653463099493       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411712, 1.0]], [0, [3661.4543980684057, 1.0]], [0, [833.27243429132, 1.0]], [0, [235.72174295025383, 1.0]], [0, [76.4809664723593, 1.0]], [0, [10.122071779838809, 1.0]], [0, [27.146548792598164, 1.0]], [0, [0.39241196807574574, 1.0]], [0, [3.008084415008319, 1.0]], [0, [1.1595520881969779, 1.0]], [1, [1.7974423831315807, 1.0]], [1, [6.248889295999769, 1.0]], [1, [28.330274624348682, 1.0]], [1, [1.000000304784976e-09, 1.0]], [1, [0.6534630994927758, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096647]
bas 5, expnt(s) = [10.12207178]
bas 6, expnt(s) = [27.14654879]
bas 7, expnt(s) = [0.39241197]
bas 8, expnt(s) = [3.00808442]
bas 9, expnt(s) = [1.15955209]
bas 10, expnt(s) = [1.79744238]
bas 11, expnt(s) = [6.2488893]
bas 12, expnt(s) = [28.33027462]
bas 13, expnt(s) = [1.0000003e-09]
bas 14, expnt(s) = [0.6534631]
CPU time:        12.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401384e+01 1.01220718e+01 1.43372905e+01
 2.71465488e+01 3.00469914e+01 3.92411968e-01 1.25262682e+00
 3.00808442e+00 5.77075370e+00 1.15955209e+00 2.82314199e+00
 1.79744238e+00 6.07159948e+00 6.24888930e+00 2.88229170e+01
 2.83302746e+01 1.90676808e+02 1.00000030e-09 1.64053144e-11
 6.53463099e-01 1.71399965e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.942343116274735
cond(S) = 360.36144208474064
E1 = -183.21969646882064  E_coul = 54.97697905594341
init E= -128.242717412877
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.756335790024224  LUMO = -0.000336415220885899
  mo_energy =
[-3.25634170e+01 -1.86451130e+00 -7.56335790e-01 -7.56335790e-01
 -7.56335790e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.27109702e+00  2.33078997e+00  2.33078997e+00  2.33078997e+00
  7.71923077e+00  1.05920895e+01  1.05920895e+01  1.05920895e+01
  3.56506979e+01  5.39300501e+01  5.39300501e+01  5.39300501e+01
  1.40178147e+02  5.04448324e+02  1.87203406e+03  8.00155727e+03
  4.77690056e+04]
E1 = -183.54920945570194  E_coul = 55.176907292844966
cycle= 1 E= -128.372302162857  delta_E= -0.13  |g|= 0.0689  |ddm|= 0.276
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.106038
diis-c [-0.01124398  1.        ]
  HOMO = -0.72564055387156  LUMO = -0.000336415220869647
  mo_energy =
[-3.25990263e+01 -1.82186701e+00 -7.25640554e-01 -7.25640554e-01
 -7.25640554e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.31023695e+00  2.36733800e+00  2.36733800e+00  2.36733800e+00
  7.75917777e+00  1.06188824e+01  1.06188824e+01  1.06188824e+01
  3.56547045e+01  5.39076446e+01  5.39076446e+01  5.39076446e+01
  1.40144157e+02  5.04384749e+02  1.87193993e+03  8.00143570e+03
  4.77688656e+04]
E1 = -183.59617803082762  E_coul = 55.22361952485759
cycle= 2 E= -128.37255850597  delta_E= -0.000256  |g|= 0.00932  |ddm|= 0.0263
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0145873
diis-c [-2.10618501e-04  1.38343930e-02  9.86165607e-01]
  HOMO = -0.722691551131223  LUMO = -0.000336415220876685
  mo_energy =
[-3.25894013e+01 -1.81732106e+00 -7.22691551e-01 -7.22691551e-01
 -7.22691551e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.31213998e+00  2.36930640e+00  2.36930640e+00  2.36930640e+00
  7.76367955e+00  1.06241910e+01  1.06241910e+01  1.06241910e+01
  3.56623169e+01  5.39165228e+01  5.39165228e+01  5.39165228e+01
  1.40153765e+02  5.04395239e+02  1.87195062e+03  8.00144636e+03
  4.77688762e+04]
E1 = -183.57900737480324  E_coul = 55.20643988364625
cycle= 3 E= -128.372567491157  delta_E= -8.99e-06  |g|= 0.00249  |ddm|= 0.00497
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0052842
diis-c [-1.05748964e-05 -2.10799036e-02  1.90510007e-01  8.30569897e-01]
  HOMO = -0.72364418822581  LUMO = -0.00033641522086999
  mo_energy =
[-3.25922577e+01 -1.81792649e+00 -7.23644188e-01 -7.23644188e-01
 -7.23644188e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.31195532e+00  2.36866396e+00  2.36866396e+00  2.36866396e+00
  7.76271813e+00  1.06226921e+01  1.06226921e+01  1.06226921e+01
  3.56602439e+01  5.39139647e+01  5.39139647e+01  5.39139647e+01
  1.40150955e+02  5.04391964e+02  1.87194702e+03  8.00144256e+03
  4.77688723e+04]
E1 = -183.58366219931992  E_coul = 55.21109406613849
cycle= 4 E= -128.372568133181  delta_E= -6.42e-07  |g|= 0.00038  |ddm|= 0.000969
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000556479
diis-c [-1.70805987e-08  1.24346829e-03 -4.90709696e-02 -8.99142330e-02
  1.13774173e+00]
  HOMO = -0.723642763862268  LUMO = -0.000336415220869893
  mo_energy =
[-3.25921182e+01 -1.81780992e+00 -7.23642764e-01 -7.23642764e-01
 -7.23642764e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.31200385e+00  2.36865929e+00  2.36865929e+00  2.36865929e+00
  7.76279093e+00  1.06227406e+01  1.06227406e+01  1.06227406e+01
  3.56603599e+01  5.39140949e+01  5.39140949e+01  5.39140949e+01
  1.40151081e+02  5.04392042e+02  1.87194703e+03  8.00144253e+03
  4.77688723e+04]
E1 = -183.58330434179985  E_coul = 55.2107361878952
cycle= 5 E= -128.372568153905  delta_E= -2.07e-08  |g|= 1.63e-05  |ddm|= 0.000289
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.3069e-05
diis-c [-2.23094032e-11 -6.52454057e-05  3.96283003e-03  7.91699931e-04
 -6.55812213e-02  1.06089194e+00]
  HOMO = -0.723650072126457  LUMO = -0.000336415220876424
  mo_energy =
[-3.25921351e+01 -1.81781750e+00 -7.23650072e-01 -7.23650072e-01
 -7.23650072e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.31200067e+00  2.36865432e+00  2.36865432e+00  2.36865432e+00
  7.76278215e+00  1.06227292e+01  1.06227292e+01  1.06227292e+01
  3.56603456e+01  5.39140788e+01  5.39140788e+01  5.39140788e+01
  1.40151064e+02  5.04392022e+02  1.87194701e+03  8.00144251e+03
  4.77688722e+04]
E1 = -183.58333375431437  E_coul = 55.21076560039305
cycle= 6 E= -128.372568153921  delta_E= -1.67e-11  |g|= 4.04e-07  |ddm|= 3.94e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.58333375431437  E_coul = 55.21076560039305
  HOMO = -0.723649840059678  LUMO = -0.00033641522087291
  mo_energy =
[-3.25921345e+01 -1.81781726e+00 -7.23649840e-01 -7.23649840e-01
 -7.23649840e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  1.31200076e+00  2.36865447e+00  2.36865447e+00  2.36865447e+00
  7.76278243e+00  1.06227296e+01  1.06227296e+01  1.06227296e+01
  3.56603461e+01  5.39140793e+01  5.39140793e+01  5.39140793e+01
  1.40151064e+02  5.04392023e+02  1.87194701e+03  8.00144251e+03
  4.77688722e+04]
E1 = -183.58333271770854  E_coul = 55.21076456378706
Extra cycle  E= -128.372568153921  delta_E= -1.71e-13  |g|= 1.41e-07  |ddm|= 1.26e-07
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220718e+01 2.71465488e+01 3.92411968e-01
 3.00808442e+00 1.15955209e+00 1.79744238e+00 6.24888930e+00
 2.83302746e+01 1.00000030e-09 6.53463099e-01]
E = -128.3725681539215
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.72174295         1
[INPUT] 0    0    [1    /1   ]  76.4809664509        1
[INPUT] 0    0    [1    /1   ]  10.1220691989        1
[INPUT] 0    0    [1    /1   ]  27.1465490395        1
[INPUT] 0    0    [1    /1   ]  0.392360295562       1
[INPUT] 0    0    [1    /1   ]  3.00806491657        1
[INPUT] 0    0    [1    /1   ]  1.15973353876        1
[INPUT] 1    0    [1    /1   ]  1.71898383049        1
[INPUT] 1    0    [1    /1   ]  6.25344090357        1
[INPUT] 1    0    [1    /1   ]  28.3302005007        1
[INPUT] 1    0    [1    /1   ]  0.316432410234       1
[INPUT] 1    0    [1    /1   ]  0.52756691555        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.4543980684257, 1.0]], [0, [833.2724342911391, 1.0]], [0, [235.72174294995628, 1.0]], [0, [76.48096645094684, 1.0]], [0, [10.122069198937035, 1.0]], [0, [27.14654903954263, 1.0]], [0, [0.392360295561638, 1.0]], [0, [3.008064916572508, 1.0]], [0, [1.1597335387604064, 1.0]], [1, [1.7189838304928027, 1.0]], [1, [6.253440903574321, 1.0]], [1, [28.33020050071532, 1.0]], [1, [0.31643241023361046, 1.0]], [1, [0.5275669155502931, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096645]
bas 5, expnt(s) = [10.1220692]
bas 6, expnt(s) = [27.14654904]
bas 7, expnt(s) = [0.3923603]
bas 8, expnt(s) = [3.00806492]
bas 9, expnt(s) = [1.15973354]
bas 10, expnt(s) = [1.71898383]
bas 11, expnt(s) = [6.2534409]
bas 12, expnt(s) = [28.3302005]
bas 13, expnt(s) = [0.31643241]
bas 14, expnt(s) = [0.52756692]
CPU time:        12.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401383e+01 1.01220692e+01 1.43372877e+01
 2.71465490e+01 3.00469916e+01 3.92360296e-01 1.25250311e+00
 3.00806492e+00 5.77072565e+00 1.15973354e+00 2.82347331e+00
 1.71898383e+00 5.74214469e+00 6.25344090e+00 2.88491622e+01
 2.83302005e+01 1.90676184e+02 3.16432410e-01 6.92365775e-01
 5.27566916e-01 1.31169038e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.996123618608745
cond(S) = 360.3789189180247
E1 = -183.52878486131183  E_coul = 55.06746877142831
init E= -128.461316089884
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.769484907691201  LUMO = 0.798379915329124
  mo_energy =
[-3.25573575e+01 -1.85373735e+00 -7.69484908e-01 -7.69484908e-01
 -7.69484908e-01  7.98379915e-01  7.98379915e-01  7.98379915e-01
  1.27583312e+00  2.97712407e+00  2.97712407e+00  2.97712407e+00
  7.73490639e+00  1.07912256e+01  1.07912256e+01  1.07912256e+01
  3.56615259e+01  5.39343500e+01  5.39343500e+01  5.39343500e+01
  1.40185787e+02  5.04458861e+02  1.87204679e+03  8.00157063e+03
  4.77690191e+04]
E1 = -182.05428045332457  E_coul = 53.557983573288475
cycle= 1 E= -128.496296880036  delta_E= -0.035  |g|= 0.206  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.496058
diis-c [-0.24607388  1.        ]
  HOMO = -0.874539663131771  LUMO = 0.780083304058868
  mo_energy =
[-3.28843434e+01 -1.96383609e+00 -8.74539663e-01 -8.74539663e-01
 -8.74539663e-01  7.80083304e-01  7.80083304e-01  7.80083304e-01
  1.23292517e+00  2.91102311e+00  2.91102311e+00  2.91102311e+00
  7.60322225e+00  1.06190173e+01  1.06190173e+01  1.06190173e+01
  3.54140809e+01  5.36380073e+01  5.36380073e+01  5.36380073e+01
  1.39864313e+02  5.04091370e+02  1.87164263e+03  8.00113733e+03
  4.77685669e+04]
E1 = -182.80499950132332  E_coul = 54.30603428335867
cycle= 2 E= -128.498965217965  delta_E= -0.00267  |g|= 0.102  |ddm|= 0.0782
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.246945
diis-c [-5.43549803e-04  3.31613026e-01  6.68386974e-01]
  HOMO = -0.83919048004808  LUMO = 0.786998207725377
  mo_energy =
[-3.27770015e+01 -1.92664611e+00 -8.39190480e-01 -8.39190480e-01
 -8.39190480e-01  7.86998208e-01  7.86998208e-01  7.86998208e-01
  1.24813294e+00  2.93374213e+00  2.93374213e+00  2.93374213e+00
  7.64722377e+00  1.06766234e+01  1.06766234e+01  1.06766234e+01
  3.54964495e+01  5.37358120e+01  5.37358120e+01  5.37358120e+01
  1.39969687e+02  5.04207593e+02  1.87176422e+03  8.00126147e+03
  4.77686920e+04]
E1 = -182.55931415759775  E_coul = 54.0594843237727
cycle= 3 E= -128.499829833825  delta_E= -0.000865  |g|= 0.000677  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000575963
diis-c [-1.59371319e-07 -1.53143460e-03 -4.68058296e-03  1.00621202e+00]
  HOMO = -0.839053990283789  LUMO = 0.787103684323991
  mo_energy =
[-3.27767747e+01 -1.92642759e+00 -8.39053990e-01 -8.39053990e-01
 -8.39053990e-01  7.87103684e-01  7.87103684e-01  7.87103684e-01
  1.24834479e+00  2.93393741e+00  2.93393741e+00  2.93393741e+00
  7.64745382e+00  1.06768706e+01  1.06768706e+01  1.06768706e+01
  3.54966870e+01  5.37360482e+01  5.37360482e+01  5.37360482e+01
  1.39969922e+02  5.04207814e+02  1.87176441e+03  8.00126163e+03
  4.77686922e+04]
E1 = -182.55919270154234  E_coul = 54.059362787792644
cycle= 4 E= -128.49982991375  delta_E= -7.99e-08  |g|= 9.89e-05  |ddm|= 0.000955
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.95437e-05
diis-c [-3.48799602e-09  3.19375806e-04  9.52743250e-04 -2.06410377e-01
  1.20513826e+00]
  HOMO = -0.839028328358849  LUMO = 0.787115771839367
  mo_energy =
[-3.27767414e+01 -1.92638260e+00 -8.39028328e-01 -8.39028328e-01
 -8.39028328e-01  7.87115772e-01  7.87115772e-01  7.87115772e-01
  1.24837933e+00  2.93396392e+00  2.93396392e+00  2.93396392e+00
  7.64749072e+00  1.06769055e+01  1.06769055e+01  1.06769055e+01
  3.54967222e+01  5.37360827e+01  5.37360827e+01  5.37360827e+01
  1.39969956e+02  5.04207845e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924866734657  E_coul = 54.05941875141959
cycle= 5 E= -128.499829915927  delta_E= -2.18e-09  |g|= 6.27e-06  |ddm|= 0.000175
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.50082e-06
diis-c [-1.93053723e-11 -7.27345646e-06 -3.90551739e-05  2.03916258e-02
 -1.69570970e-01  1.14922567e+00]
  HOMO = -0.83902754627772  LUMO = 0.787115919678174
  mo_energy =
[-3.27767405e+01 -1.92637997e+00 -8.39027546e-01 -8.39027546e-01
 -8.39027546e-01  7.87115920e-01  7.87115920e-01  7.87115920e-01
  1.24838068e+00  2.93396457e+00  2.93396457e+00  2.93396457e+00
  7.64749291e+00  1.06769068e+01  1.06769068e+01  1.06769068e+01
  3.54967241e+01  5.37360839e+01  5.37360839e+01  5.37360839e+01
  1.39969956e+02  5.04207844e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924509972817  E_coul = 54.05941518379644
cycle= 6 E= -128.499829915932  delta_E= -4.77e-12  |g|= 1.13e-06  |ddm|= 3.65e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.55924509972817  E_coul = 54.05941518379644
  HOMO = -0.839028234241245  LUMO = 0.787115741669664
  mo_energy =
[-3.27767420e+01 -1.92638069e+00 -8.39028234e-01 -8.39028234e-01
 -8.39028234e-01  7.87115742e-01  7.87115742e-01  7.87115742e-01
  1.24838028e+00  2.93396406e+00  2.93396406e+00  2.93396406e+00
  7.64749209e+00  1.06769058e+01  1.06769058e+01  1.06769058e+01
  3.54967229e+01  5.37360825e+01  5.37360825e+01  5.37360825e+01
  1.39969955e+02  5.04207843e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924774574092  E_coul = 54.05941782980886
Extra cycle  E= -128.499829915932  delta_E= -3.13e-13  |g|= 3.94e-07  |ddm|= 8.96e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220692e+01 2.71465490e+01 3.92360296e-01
 3.00806492e+00 1.15973354e+00 1.71898383e+00 6.25344090e+00
 2.83302005e+01 3.16432410e-01 5.27566916e-01]
E = -128.49982991593205
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.72174295         1
[INPUT] 0    0    [1    /1   ]  76.4809664509        1
[INPUT] 0    0    [1    /1   ]  10.1220691989        1
[INPUT] 0    0    [1    /1   ]  27.1465490395        1
[INPUT] 0    0    [1    /1   ]  0.392360295562       1
[INPUT] 0    0    [1    /1   ]  3.00806491657        1
[INPUT] 0    0    [1    /1   ]  1.15973353876        1
[INPUT] 1    0    [1    /1   ]  1.71898383049        1
[INPUT] 1    0    [1    /1   ]  6.25344090357        1
[INPUT] 1    0    [1    /1   ]  28.3302005007        1
[INPUT] 1    0    [1    /1   ]  0.316432410234       1
[INPUT] 1    0    [1    /1   ]  0.52756691555        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.4543980684257, 1.0]], [0, [833.2724342911391, 1.0]], [0, [235.72174294995628, 1.0]], [0, [76.48096645094684, 1.0]], [0, [10.122069198937035, 1.0]], [0, [27.14654903954263, 1.0]], [0, [0.392360295561638, 1.0]], [0, [3.008064916572508, 1.0]], [0, [1.1597335387604064, 1.0]], [1, [1.7189838304928027, 1.0]], [1, [6.253440903574321, 1.0]], [1, [28.33020050071532, 1.0]], [1, [0.31643241023361046, 1.0]], [1, [0.5275669155502931, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096645]
bas 5, expnt(s) = [10.1220692]
bas 6, expnt(s) = [27.14654904]
bas 7, expnt(s) = [0.3923603]
bas 8, expnt(s) = [3.00806492]
bas 9, expnt(s) = [1.15973354]
bas 10, expnt(s) = [1.71898383]
bas 11, expnt(s) = [6.2534409]
bas 12, expnt(s) = [28.3302005]
bas 13, expnt(s) = [0.31643241]
bas 14, expnt(s) = [0.52756692]
CPU time:        13.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401383e+01 1.01220692e+01 1.43372877e+01
 2.71465490e+01 3.00469916e+01 3.92360296e-01 1.25250311e+00
 3.00806492e+00 5.77072565e+00 1.15973354e+00 2.82347331e+00
 1.71898383e+00 5.74214469e+00 6.25344090e+00 2.88491622e+01
 2.83302005e+01 1.90676184e+02 3.16432410e-01 6.92365775e-01
 5.27566916e-01 1.31169038e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.996123618608745
cond(S) = 360.3789189180247
E1 = -183.52878486131183  E_coul = 55.06746877142831
init E= -128.461316089884
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.769484907691201  LUMO = 0.798379915329124
  mo_energy =
[-3.25573575e+01 -1.85373735e+00 -7.69484908e-01 -7.69484908e-01
 -7.69484908e-01  7.98379915e-01  7.98379915e-01  7.98379915e-01
  1.27583312e+00  2.97712407e+00  2.97712407e+00  2.97712407e+00
  7.73490639e+00  1.07912256e+01  1.07912256e+01  1.07912256e+01
  3.56615259e+01  5.39343500e+01  5.39343500e+01  5.39343500e+01
  1.40185787e+02  5.04458861e+02  1.87204679e+03  8.00157063e+03
  4.77690191e+04]
E1 = -182.05428045332457  E_coul = 53.557983573288475
cycle= 1 E= -128.496296880036  delta_E= -0.035  |g|= 0.206  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.496058
diis-c [-0.24607388  1.        ]
  HOMO = -0.874539663131771  LUMO = 0.780083304058868
  mo_energy =
[-3.28843434e+01 -1.96383609e+00 -8.74539663e-01 -8.74539663e-01
 -8.74539663e-01  7.80083304e-01  7.80083304e-01  7.80083304e-01
  1.23292517e+00  2.91102311e+00  2.91102311e+00  2.91102311e+00
  7.60322225e+00  1.06190173e+01  1.06190173e+01  1.06190173e+01
  3.54140809e+01  5.36380073e+01  5.36380073e+01  5.36380073e+01
  1.39864313e+02  5.04091370e+02  1.87164263e+03  8.00113733e+03
  4.77685669e+04]
E1 = -182.80499950132332  E_coul = 54.30603428335867
cycle= 2 E= -128.498965217965  delta_E= -0.00267  |g|= 0.102  |ddm|= 0.0782
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.246945
diis-c [-5.43549803e-04  3.31613026e-01  6.68386974e-01]
  HOMO = -0.83919048004808  LUMO = 0.786998207725377
  mo_energy =
[-3.27770015e+01 -1.92664611e+00 -8.39190480e-01 -8.39190480e-01
 -8.39190480e-01  7.86998208e-01  7.86998208e-01  7.86998208e-01
  1.24813294e+00  2.93374213e+00  2.93374213e+00  2.93374213e+00
  7.64722377e+00  1.06766234e+01  1.06766234e+01  1.06766234e+01
  3.54964495e+01  5.37358120e+01  5.37358120e+01  5.37358120e+01
  1.39969687e+02  5.04207593e+02  1.87176422e+03  8.00126147e+03
  4.77686920e+04]
E1 = -182.55931415759775  E_coul = 54.0594843237727
cycle= 3 E= -128.499829833825  delta_E= -0.000865  |g|= 0.000677  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000575963
diis-c [-1.59371319e-07 -1.53143460e-03 -4.68058296e-03  1.00621202e+00]
  HOMO = -0.839053990283789  LUMO = 0.787103684323991
  mo_energy =
[-3.27767747e+01 -1.92642759e+00 -8.39053990e-01 -8.39053990e-01
 -8.39053990e-01  7.87103684e-01  7.87103684e-01  7.87103684e-01
  1.24834479e+00  2.93393741e+00  2.93393741e+00  2.93393741e+00
  7.64745382e+00  1.06768706e+01  1.06768706e+01  1.06768706e+01
  3.54966870e+01  5.37360482e+01  5.37360482e+01  5.37360482e+01
  1.39969922e+02  5.04207814e+02  1.87176441e+03  8.00126163e+03
  4.77686922e+04]
E1 = -182.55919270154234  E_coul = 54.059362787792644
cycle= 4 E= -128.49982991375  delta_E= -7.99e-08  |g|= 9.89e-05  |ddm|= 0.000955
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.95437e-05
diis-c [-3.48799602e-09  3.19375806e-04  9.52743250e-04 -2.06410377e-01
  1.20513826e+00]
  HOMO = -0.839028328358849  LUMO = 0.787115771839367
  mo_energy =
[-3.27767414e+01 -1.92638260e+00 -8.39028328e-01 -8.39028328e-01
 -8.39028328e-01  7.87115772e-01  7.87115772e-01  7.87115772e-01
  1.24837933e+00  2.93396392e+00  2.93396392e+00  2.93396392e+00
  7.64749072e+00  1.06769055e+01  1.06769055e+01  1.06769055e+01
  3.54967222e+01  5.37360827e+01  5.37360827e+01  5.37360827e+01
  1.39969956e+02  5.04207845e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924866734657  E_coul = 54.05941875141959
cycle= 5 E= -128.499829915927  delta_E= -2.18e-09  |g|= 6.27e-06  |ddm|= 0.000175
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.50082e-06
diis-c [-1.93053723e-11 -7.27345646e-06 -3.90551739e-05  2.03916258e-02
 -1.69570970e-01  1.14922567e+00]
  HOMO = -0.83902754627772  LUMO = 0.787115919678174
  mo_energy =
[-3.27767405e+01 -1.92637997e+00 -8.39027546e-01 -8.39027546e-01
 -8.39027546e-01  7.87115920e-01  7.87115920e-01  7.87115920e-01
  1.24838068e+00  2.93396457e+00  2.93396457e+00  2.93396457e+00
  7.64749291e+00  1.06769068e+01  1.06769068e+01  1.06769068e+01
  3.54967241e+01  5.37360839e+01  5.37360839e+01  5.37360839e+01
  1.39969956e+02  5.04207844e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924509972817  E_coul = 54.05941518379644
cycle= 6 E= -128.499829915932  delta_E= -4.77e-12  |g|= 1.13e-06  |ddm|= 3.65e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.55924509972817  E_coul = 54.05941518379644
  HOMO = -0.839028234241245  LUMO = 0.787115741669664
  mo_energy =
[-3.27767420e+01 -1.92638069e+00 -8.39028234e-01 -8.39028234e-01
 -8.39028234e-01  7.87115742e-01  7.87115742e-01  7.87115742e-01
  1.24838028e+00  2.93396406e+00  2.93396406e+00  2.93396406e+00
  7.64749209e+00  1.06769058e+01  1.06769058e+01  1.06769058e+01
  3.54967229e+01  5.37360825e+01  5.37360825e+01  5.37360825e+01
  1.39969955e+02  5.04207843e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924774574092  E_coul = 54.05941782980886
Extra cycle  E= -128.499829915932  delta_E= -3.13e-13  |g|= 3.94e-07  |ddm|= 8.96e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 360.3789189180247
E1 = -182.55924774574092  E_coul = 54.05941782980886
init E= -128.499829915932
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.839028057792876  LUMO = 0.787115769058889
  mo_energy =
[-3.27767414e+01 -1.92638051e+00 -8.39028058e-01 -8.39028058e-01
 -8.39028058e-01  7.87115769e-01  7.87115769e-01  7.87115769e-01
  1.24838034e+00  2.93396416e+00  2.93396416e+00  2.93396416e+00
  7.64749231e+00  1.06769061e+01  1.06769061e+01  1.06769061e+01
  3.54967233e+01  5.37360831e+01  5.37360831e+01  5.37360831e+01
  1.39969955e+02  5.04207843e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924621179065  E_coul = 54.059416295858966
cycle= 1 E= -128.499829915932  delta_E= 3.69e-13  |g|= 2.06e-07  |ddm|= 2.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55924621179065  E_coul = 54.059416295858966
  HOMO = -0.839028167125762  LUMO = 0.787115746978596
  mo_energy =
[-3.27767417e+01 -1.92638062e+00 -8.39028167e-01 -8.39028167e-01
 -8.39028167e-01  7.87115747e-01  7.87115747e-01  7.87115747e-01
  1.24838029e+00  2.93396409e+00  2.93396409e+00  2.93396409e+00
  7.64749218e+00  1.06769060e+01  1.06769060e+01  1.06769060e+01
  3.54967231e+01  5.37360828e+01  5.37360828e+01  5.37360828e+01
  1.39969955e+02  5.04207843e+02  1.87176444e+03  8.00126165e+03
  4.77686922e+04]
E1 = -182.55924694036537  E_coul = 54.059417024433486
Extra cycle  E= -128.499829915932  delta_E= -1.99e-13  |g|= 9.93e-08  |ddm|= 6.65e-08
    CPU time for scf_cycle      0.27 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220692e+01 2.71465490e+01 3.92360296e-01
 3.00806492e+00 1.15973354e+00 1.71898383e+00 6.25344090e+00
 2.83302005e+01 3.16432410e-01 5.27566916e-01]
grad_E = [ 1.59351794e-12 -7.98526573e-12  1.91407346e-10 -3.10854537e-09
  3.31015613e-08  2.13971356e-06 -3.64199415e-07  6.70533403e-04
  8.08810789e-06 -1.01438571e-04 -1.15561039e-02 -5.38318339e-04
  5.92085462e-05  6.98312748e-02 -5.11207706e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434292        1
[INPUT] 0    0    [1    /1   ]  235.721742942        1
[INPUT] 0    0    [1    /1   ]  76.4809665389        1
[INPUT] 0    0    [1    /1   ]  10.1220731864        1
[INPUT] 0    0    [1    /1   ]  27.146548398         1
[INPUT] 0    0    [1    /1   ]  0.392158858513       1
[INPUT] 0    0    [1    /1   ]  3.00808797589        1
[INPUT] 0    0    [1    /1   ]  1.15953648112        1
[INPUT] 1    0    [1    /1   ]  1.80797217682        1
[INPUT] 1    0    [1    /1   ]  6.2482220158         1
[INPUT] 1    0    [1    /1   ]  28.3302834879        1
[INPUT] 1    0    [1    /1   ]  1.00000430159e-09      1
[INPUT] 1    0    [1    /1   ]  0.663128783143       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411712, 1.0]], [0, [3661.4543980683743, 1.0]], [0, [833.2724342919521, 1.0]], [0, [235.72174294242396, 1.0]], [0, [76.48096653894041, 1.0]], [0, [10.122073186431342, 1.0]], [0, [27.146548398031804, 1.0]], [0, [0.3921588585125136, 1.0]], [0, [3.0080879758878387, 1.0]], [0, [1.1595364811242221, 1.0]], [1, [1.807972176823701, 1.0]], [1, [6.248222015798722, 1.0]], [1, [28.330283487907515, 1.0]], [1, [1.0000043015878646e-09, 1.0]], [1, [0.6631287831427084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174294]
bas 4, expnt(s) = [76.48096654]
bas 5, expnt(s) = [10.12207319]
bas 6, expnt(s) = [27.1465484]
bas 7, expnt(s) = [0.39215886]
bas 8, expnt(s) = [3.00808798]
bas 9, expnt(s) = [1.15953648]
bas 10, expnt(s) = [1.80797218]
bas 11, expnt(s) = [6.24822202]
bas 12, expnt(s) = [28.33028349]
bas 13, expnt(s) = [1.0000043e-09]
bas 14, expnt(s) = [0.66312878]
CPU time:        15.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401384e+01 1.01220732e+01 1.43372920e+01
 2.71465484e+01 3.00469911e+01 3.92158859e-01 1.25202081e+00
 3.00808798e+00 5.77075883e+00 1.15953648e+00 2.82311349e+00
 1.80797218e+00 6.11609287e+00 6.24822202e+00 2.88190698e+01
 2.83302835e+01 1.90676883e+02 1.00000430e-09 1.64053964e-11
 6.63128783e-01 1.74574876e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.939346492079238
cond(S) = 360.2843586994518
E1 = -183.20055192404487  E_coul = 54.971031441614116
init E= -128.229520482431
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.755680328812351  LUMO = -0.000336415893164244
  mo_energy =
[-3.25639122e+01 -1.86519617e+00 -7.55680329e-01 -7.55680329e-01
 -7.55680329e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.26974580e+00  2.36294792e+00  2.36294792e+00  2.36294792e+00
  7.71717698e+00  1.06561699e+01  1.06561699e+01  1.06561699e+01
  3.56489274e+01  5.39864995e+01  5.39864995e+01  5.39864995e+01
  1.40176612e+02  5.04446856e+02  1.87203265e+03  8.00155594e+03
  4.77690044e+04]
E1 = -183.60337281576167  E_coul = 55.23849731355024
cycle= 1 E= -128.364875502211  delta_E= -0.135  |g|= 0.07  |ddm|= 0.288
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103112
diis-c [-0.0106321  1.       ]
  HOMO = -0.719657939180449  LUMO = -0.000336415893157245
  mo_energy =
[-3.25876368e+01 -1.81669430e+00 -7.19657939e-01 -7.19657939e-01
 -7.19657939e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.31202752e+00  2.40394875e+00  2.40394875e+00  2.40394875e+00
  7.76375897e+00  1.06909159e+01  1.06909159e+01  1.06909159e+01
  3.56629991e+01  5.39752727e+01  5.39752727e+01  5.39752727e+01
  1.40154317e+02  5.04395613e+02  1.87195106e+03  8.00144697e+03
  4.77688770e+04]
E1 = -183.62836668198625  E_coul = 55.26322891930349
cycle= 2 E= -128.365137762683  delta_E= -0.000262  |g|= 0.00771  |ddm|= 0.0267
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0110641
diis-c [-1.13878855e-04 -2.93205400e-02  1.02932054e+00]
  HOMO = -0.718172213904188  LUMO = -0.000336415893177122
  mo_energy =
[-3.25826153e+01 -1.81346404e+00 -7.18172214e-01 -7.18172214e-01
 -7.18172214e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.31346480e+00  2.40494475e+00  2.40494475e+00  2.40494475e+00
  7.76655840e+00  1.06938079e+01  1.06938079e+01  1.06938079e+01
  3.56671796e+01  5.39799923e+01  5.39799923e+01  5.39799923e+01
  1.40159417e+02  5.04401058e+02  1.87195641e+03  8.00145212e+03
  4.77688820e+04]
E1 = -183.61907069474336  E_coul = 55.253925027590796
cycle= 3 E= -128.365145667153  delta_E= -7.9e-06  |g|= 0.0017  |ddm|= 0.00491
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00352409
diis-c [-8.92397638e-06 -1.66912165e-02  1.11458053e-01  9.05233164e-01]
  HOMO = -0.718856533861134  LUMO = -0.000336415893159628
  mo_energy =
[-3.25845637e+01 -1.81383026e+00 -7.18856534e-01 -7.18856534e-01
 -7.18856534e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.31335784e+00  2.40447436e+00  2.40447436e+00  2.40447436e+00
  7.76591131e+00  1.06927639e+01  1.06927639e+01  1.06927639e+01
  3.56657727e+01  5.39782501e+01  5.39782501e+01  5.39782501e+01
  1.40157490e+02  5.04398758e+02  1.87195382e+03  8.00144937e+03
  4.77688792e+04]
E1 = -183.62211275761024  E_coul = 55.25696674993848
cycle= 4 E= -128.365146007672  delta_E= -3.41e-07  |g|= 0.000382  |ddm|= 0.000811
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000595663
diis-c [-1.68438782e-08  1.24005787e-03 -5.40466518e-02  4.18417620e-02
  1.01096483e+00]
  HOMO = -0.718796757344082  LUMO = -0.000336415893160691
  mo_energy =
[-3.25842595e+01 -1.81368416e+00 -7.18796757e-01 -7.18796757e-01
 -7.18796757e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.31341459e+00  2.40450973e+00  2.40450973e+00  2.40450973e+00
  7.76603820e+00  1.06929009e+01  1.06929009e+01  1.06929009e+01
  3.56660070e+01  5.39785272e+01  5.39785272e+01  5.39785272e+01
  1.40157779e+02  5.04399032e+02  1.87195406e+03  8.00144958e+03
  4.77688794e+04]
E1 = -183.6215000177782  E_coul = 55.25635399398314
cycle= 5 E= -128.365146023795  delta_E= -1.61e-08  |g|= 1.69e-05  |ddm|= 0.000236
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.43719e-05
diis-c [-2.34594875e-11 -6.48963415e-05  4.24888789e-03 -1.04114086e-02
 -4.57226948e-02  1.05195011e+00]
  HOMO = -0.718804296806941  LUMO = -0.000336415893156278
  mo_energy =
[-3.25842773e+01 -1.81369196e+00 -7.18804297e-01 -7.18804297e-01
 -7.18804297e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.31341135e+00  2.40450457e+00  2.40450457e+00  2.40450457e+00
  7.76602913e+00  1.06928891e+01  1.06928891e+01  1.06928891e+01
  3.56659920e+01  5.39785103e+01  5.39785103e+01  5.39785103e+01
  1.40157761e+02  5.04399012e+02  1.87195404e+03  8.00144956e+03
  4.77688794e+04]
E1 = -183.6215308137307  E_coul = 55.256384789917206
cycle= 6 E= -128.365146023813  delta_E= -1.84e-11  |g|= 4.21e-07  |ddm|= 4.12e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.6215308137307  E_coul = 55.256384789917206
  HOMO = -0.718804055327926  LUMO = -0.000336415893159525
  mo_energy =
[-3.25842767e+01 -1.81369172e+00 -7.18804055e-01 -7.18804055e-01
 -7.18804055e-01 -3.36415893e-04 -3.36415893e-04 -3.36415893e-04
  1.31341145e+00  2.40450473e+00  2.40450473e+00  2.40450473e+00
  7.76602942e+00  1.06928895e+01  1.06928895e+01  1.06928895e+01
  3.56659925e+01  5.39785108e+01  5.39785108e+01  5.39785108e+01
  1.40157761e+02  5.04399012e+02  1.87195404e+03  8.00144956e+03
  4.77688794e+04]
E1 = -183.62152973668157  E_coul = 55.256383712868086
Extra cycle  E= -128.365146023813  delta_E=    0  |g|= 1.46e-07  |ddm|= 1.31e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220732e+01 2.71465484e+01 3.92158859e-01
 3.00808798e+00 1.15953648e+00 1.80797218e+00 6.24822202e+00
 2.83302835e+01 1.00000430e-09 6.63128783e-01]
E = -128.36514602381348
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742949        1
[INPUT] 0    0    [1    /1   ]  76.4809664597        1
[INPUT] 0    0    [1    /1   ]  10.1220695977        1
[INPUT] 0    0    [1    /1   ]  27.1465489754        1
[INPUT] 0    0    [1    /1   ]  0.392340151857       1
[INPUT] 0    0    [1    /1   ]  3.0080672225         1
[INPUT] 0    0    [1    /1   ]  1.159713833          1
[INPUT] 1    0    [1    /1   ]  1.72788266513        1
[INPUT] 1    0    [1    /1   ]  6.2529190148         1
[INPUT] 1    0    [1    /1   ]  28.3302087994        1
[INPUT] 1    0    [1    /1   ]  0.28478916931        1
[INPUT] 1    0    [1    /1   ]  0.54112310231        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.4543980684207, 1.0]], [0, [833.2724342912204, 1.0]], [0, [235.72174294920305, 1.0]], [0, [76.4809664597462, 1.0]], [0, [10.122069597686465, 1.0]], [0, [27.146548975391546, 1.0]], [0, [0.39234015185672555, 1.0]], [0, [3.008067222504041, 1.0]], [0, [1.159713832996788, 1.0]], [1, [1.7278826651258925, 1.0]], [1, [6.252919014796761, 1.0]], [1, [28.33020879943454, 1.0]], [1, [0.28478916931024983, 1.0]], [1, [0.5411231023095346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096646]
bas 5, expnt(s) = [10.1220696]
bas 6, expnt(s) = [27.14654898]
bas 7, expnt(s) = [0.39234015]
bas 8, expnt(s) = [3.00806722]
bas 9, expnt(s) = [1.15971383]
bas 10, expnt(s) = [1.72788267]
bas 11, expnt(s) = [6.25291901]
bas 12, expnt(s) = [28.3302088]
bas 13, expnt(s) = [0.28478917]
bas 14, expnt(s) = [0.5411231]
CPU time:        15.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401384e+01 1.01220696e+01 1.43372881e+01
 2.71465490e+01 3.00469915e+01 3.92340152e-01 1.25245489e+00
 3.00806722e+00 5.77072897e+00 1.15971383e+00 2.82343733e+00
 1.72788267e+00 5.77932612e+00 6.25291901e+00 2.88461527e+01
 2.83302088e+01 1.90676254e+02 2.84789169e-01 6.06930173e-01
 5.41123102e-01 1.35395580e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99728861684753
cond(S) = 360.3694586933373
E1 = -183.53465952629278  E_coul = 55.06862948125662
init E= -128.466030045036
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.769979002182051  LUMO = 0.746943659506669
  mo_energy =
[-3.25571705e+01 -1.85361363e+00 -7.69979002e-01 -7.69979002e-01
 -7.69979002e-01  7.46943660e-01  7.46943660e-01  7.46943660e-01
  1.27615465e+00  2.90559810e+00  2.90559810e+00  2.90559810e+00
  7.73476868e+00  1.07521737e+01  1.07521737e+01  1.07521737e+01
  3.56614535e+01  5.39196121e+01  5.39196121e+01  5.39196121e+01
  1.40185803e+02  5.04458801e+02  1.87204668e+03  8.00157051e+03
  4.77690190e+04]
E1 = -182.01111761332393  E_coul = 53.51192365148091
cycle= 1 E= -128.499193961843  delta_E= -0.0332  |g|= 0.212  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.504231
diis-c [-0.25424885  1.        ]
  HOMO = -0.878647829956456  LUMO = 0.728464652588194
  mo_energy =
[-3.28925676e+01 -1.96792532e+00 -8.78647830e-01 -8.78647830e-01
 -8.78647830e-01  7.28464653e-01  7.28464653e-01  7.28464653e-01
  1.23069628e+00  2.83628608e+00  2.83628608e+00  2.83628608e+00
  7.59846545e+00  1.05739669e+01  1.05739669e+01  1.05739669e+01
  3.54069392e+01  5.36152642e+01  5.36152642e+01  5.36152642e+01
  1.39856087e+02  5.04082802e+02  1.87163398e+03  8.00112868e+03
  4.77685583e+04]
E1 = -182.78784489538074  E_coul = 54.285852181675516
cycle= 2 E= -128.501992713705  delta_E= -0.0028  |g|= 0.105  |ddm|= 0.0729
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253284
diis-c [-5.59292139e-04  3.33632329e-01  6.66367671e-01]
  HOMO = -0.842161161275922  LUMO = 0.735210552070761
  mo_energy =
[-3.27819560e+01 -1.92951201e+00 -8.42161161e-01 -8.42161161e-01
 -8.42161161e-01  7.35210552e-01  7.35210552e-01  7.35210552e-01
  1.24641813e+00  2.85983876e+00  2.85983876e+00  2.85983876e+00
  7.64390710e+00  1.06335911e+01  1.06335911e+01  1.06335911e+01
  3.54918842e+01  5.37160852e+01  5.37160852e+01  5.37160852e+01
  1.39964669e+02  5.04202512e+02  1.87175919e+03  8.00125650e+03
  4.77686871e+04]
E1 = -182.53170258358838  E_coul = 54.02877816646228
cycle= 3 E= -128.502924417126  delta_E= -0.000932  |g|= 0.000518  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000542378
diis-c [-1.04925103e-07 -1.54691213e-03 -4.72296861e-03  1.00626988e+00]
  HOMO = -0.8420544368803  LUMO = 0.735297945638298
  mo_energy =
[-3.27817680e+01 -1.92934748e+00 -8.42054437e-01 -8.42054437e-01
 -8.42054437e-01  7.35297946e-01  7.35297946e-01  7.35297946e-01
  1.24658783e+00  2.86000614e+00  2.86000614e+00  2.86000614e+00
  7.64409640e+00  1.06338034e+01  1.06338034e+01  1.06338034e+01
  3.54920837e+01  5.37162823e+01  5.37162823e+01  5.37162823e+01
  1.39964866e+02  5.04202698e+02  1.87175935e+03  8.00125663e+03
  4.77686872e+04]
E1 = -182.53145236598309  E_coul = 54.028527905234924
cycle= 4 E= -128.502924460748  delta_E= -4.36e-08  |g|= 6.88e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.04866e-05
diis-c [-2.09950362e-09  1.79274550e-04  6.00546991e-04 -1.40480459e-01
  1.13970064e+00]
  HOMO = -0.842038721228903  LUMO = 0.735305652659095
  mo_energy =
[-3.27817485e+01 -1.92932046e+00 -8.42038721e-01 -8.42038721e-01
 -8.42038721e-01  7.35305653e-01  7.35305653e-01  7.35305653e-01
  1.24660973e+00  2.86002317e+00  2.86002317e+00  2.86002317e+00
  7.64411789e+00  1.06338244e+01  1.06338244e+01  1.06338244e+01
  3.54921036e+01  5.37163023e+01  5.37163023e+01  5.37163023e+01
  1.39964887e+02  5.04202719e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150333871787  E_coul = 54.028578876864714
cycle= 5 E= -128.502924461853  delta_E= -1.11e-09  |g|= 6.69e-06  |ddm|= 0.000102
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.26901e-06
diis-c [-1.89474567e-11  2.41908699e-06 -3.60058765e-05  1.65655855e-02
 -2.09033848e-01  1.19250185e+00]
  HOMO = -0.842036499999981  LUMO = 0.735306348685124
  mo_energy =
[-3.27817453e+01 -1.92931629e+00 -8.42036500e-01 -8.42036500e-01
 -8.42036500e-01  7.35306349e-01  7.35306349e-01  7.35306349e-01
  1.24661231e+00  2.86002514e+00  2.86002514e+00  2.86002514e+00
  7.64412162e+00  1.06338277e+01  1.06338277e+01  1.06338277e+01
  3.54921075e+01  5.37163058e+01  5.37163058e+01  5.37163058e+01
  1.39964890e+02  5.04202721e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150002326257  E_coul = 54.02857556140289
cycle= 6 E= -128.50292446186  delta_E= -6.51e-12  |g|= 8.99e-07  |ddm|= 6.57e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.53150002326257  E_coul = 54.02857556140289
  HOMO = -0.84203705053637  LUMO = 0.735306216306838
  mo_energy =
[-3.27817465e+01 -1.92931683e+00 -8.42037051e-01 -8.42037051e-01
 -8.42037051e-01  7.35306216e-01  7.35306216e-01  7.35306216e-01
  1.24661202e+00  2.86002473e+00  2.86002473e+00  2.86002473e+00
  7.64412098e+00  1.06338269e+01  1.06338269e+01  1.06338269e+01
  3.54921065e+01  5.37163046e+01  5.37163046e+01  5.37163046e+01
  1.39964888e+02  5.04202719e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150232750826  E_coul = 54.02857786564859
Extra cycle  E= -128.50292446186  delta_E=    0  |g|= 3.39e-07  |ddm|= 5.47e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220696e+01 2.71465490e+01 3.92340152e-01
 3.00806722e+00 1.15971383e+00 1.72788267e+00 6.25291901e+00
 2.83302088e+01 2.84789169e-01 5.41123102e-01]
E = -128.50292446185966
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:51:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742949        1
[INPUT] 0    0    [1    /1   ]  76.4809664597        1
[INPUT] 0    0    [1    /1   ]  10.1220695977        1
[INPUT] 0    0    [1    /1   ]  27.1465489754        1
[INPUT] 0    0    [1    /1   ]  0.392340151857       1
[INPUT] 0    0    [1    /1   ]  3.0080672225         1
[INPUT] 0    0    [1    /1   ]  1.159713833          1
[INPUT] 1    0    [1    /1   ]  1.72788266513        1
[INPUT] 1    0    [1    /1   ]  6.2529190148         1
[INPUT] 1    0    [1    /1   ]  28.3302087994        1
[INPUT] 1    0    [1    /1   ]  0.28478916931        1
[INPUT] 1    0    [1    /1   ]  0.54112310231        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.4543980684207, 1.0]], [0, [833.2724342912204, 1.0]], [0, [235.72174294920305, 1.0]], [0, [76.4809664597462, 1.0]], [0, [10.122069597686465, 1.0]], [0, [27.146548975391546, 1.0]], [0, [0.39234015185672555, 1.0]], [0, [3.008067222504041, 1.0]], [0, [1.159713832996788, 1.0]], [1, [1.7278826651258925, 1.0]], [1, [6.252919014796761, 1.0]], [1, [28.33020879943454, 1.0]], [1, [0.28478916931024983, 1.0]], [1, [0.5411231023095346, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096646]
bas 5, expnt(s) = [10.1220696]
bas 6, expnt(s) = [27.14654898]
bas 7, expnt(s) = [0.39234015]
bas 8, expnt(s) = [3.00806722]
bas 9, expnt(s) = [1.15971383]
bas 10, expnt(s) = [1.72788267]
bas 11, expnt(s) = [6.25291901]
bas 12, expnt(s) = [28.3302088]
bas 13, expnt(s) = [0.28478917]
bas 14, expnt(s) = [0.5411231]
CPU time:        16.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401384e+01 1.01220696e+01 1.43372881e+01
 2.71465490e+01 3.00469915e+01 3.92340152e-01 1.25245489e+00
 3.00806722e+00 5.77072897e+00 1.15971383e+00 2.82343733e+00
 1.72788267e+00 5.77932612e+00 6.25291901e+00 2.88461527e+01
 2.83302088e+01 1.90676254e+02 2.84789169e-01 6.06930173e-01
 5.41123102e-01 1.35395580e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99728861684753
cond(S) = 360.3694586933373
E1 = -183.53465952629278  E_coul = 55.06862948125662
init E= -128.466030045036
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.769979002182051  LUMO = 0.746943659506669
  mo_energy =
[-3.25571705e+01 -1.85361363e+00 -7.69979002e-01 -7.69979002e-01
 -7.69979002e-01  7.46943660e-01  7.46943660e-01  7.46943660e-01
  1.27615465e+00  2.90559810e+00  2.90559810e+00  2.90559810e+00
  7.73476868e+00  1.07521737e+01  1.07521737e+01  1.07521737e+01
  3.56614535e+01  5.39196121e+01  5.39196121e+01  5.39196121e+01
  1.40185803e+02  5.04458801e+02  1.87204668e+03  8.00157051e+03
  4.77690190e+04]
E1 = -182.01111761332393  E_coul = 53.51192365148091
cycle= 1 E= -128.499193961843  delta_E= -0.0332  |g|= 0.212  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.504231
diis-c [-0.25424885  1.        ]
  HOMO = -0.878647829956456  LUMO = 0.728464652588194
  mo_energy =
[-3.28925676e+01 -1.96792532e+00 -8.78647830e-01 -8.78647830e-01
 -8.78647830e-01  7.28464653e-01  7.28464653e-01  7.28464653e-01
  1.23069628e+00  2.83628608e+00  2.83628608e+00  2.83628608e+00
  7.59846545e+00  1.05739669e+01  1.05739669e+01  1.05739669e+01
  3.54069392e+01  5.36152642e+01  5.36152642e+01  5.36152642e+01
  1.39856087e+02  5.04082802e+02  1.87163398e+03  8.00112868e+03
  4.77685583e+04]
E1 = -182.78784489538074  E_coul = 54.285852181675516
cycle= 2 E= -128.501992713705  delta_E= -0.0028  |g|= 0.105  |ddm|= 0.0729
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253284
diis-c [-5.59292139e-04  3.33632329e-01  6.66367671e-01]
  HOMO = -0.842161161275922  LUMO = 0.735210552070761
  mo_energy =
[-3.27819560e+01 -1.92951201e+00 -8.42161161e-01 -8.42161161e-01
 -8.42161161e-01  7.35210552e-01  7.35210552e-01  7.35210552e-01
  1.24641813e+00  2.85983876e+00  2.85983876e+00  2.85983876e+00
  7.64390710e+00  1.06335911e+01  1.06335911e+01  1.06335911e+01
  3.54918842e+01  5.37160852e+01  5.37160852e+01  5.37160852e+01
  1.39964669e+02  5.04202512e+02  1.87175919e+03  8.00125650e+03
  4.77686871e+04]
E1 = -182.53170258358838  E_coul = 54.02877816646228
cycle= 3 E= -128.502924417126  delta_E= -0.000932  |g|= 0.000518  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000542378
diis-c [-1.04925103e-07 -1.54691213e-03 -4.72296861e-03  1.00626988e+00]
  HOMO = -0.8420544368803  LUMO = 0.735297945638298
  mo_energy =
[-3.27817680e+01 -1.92934748e+00 -8.42054437e-01 -8.42054437e-01
 -8.42054437e-01  7.35297946e-01  7.35297946e-01  7.35297946e-01
  1.24658783e+00  2.86000614e+00  2.86000614e+00  2.86000614e+00
  7.64409640e+00  1.06338034e+01  1.06338034e+01  1.06338034e+01
  3.54920837e+01  5.37162823e+01  5.37162823e+01  5.37162823e+01
  1.39964866e+02  5.04202698e+02  1.87175935e+03  8.00125663e+03
  4.77686872e+04]
E1 = -182.53145236598309  E_coul = 54.028527905234924
cycle= 4 E= -128.502924460748  delta_E= -4.36e-08  |g|= 6.88e-05  |ddm|= 0.000585
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.04866e-05
diis-c [-2.09950362e-09  1.79274550e-04  6.00546991e-04 -1.40480459e-01
  1.13970064e+00]
  HOMO = -0.842038721228903  LUMO = 0.735305652659095
  mo_energy =
[-3.27817485e+01 -1.92932046e+00 -8.42038721e-01 -8.42038721e-01
 -8.42038721e-01  7.35305653e-01  7.35305653e-01  7.35305653e-01
  1.24660973e+00  2.86002317e+00  2.86002317e+00  2.86002317e+00
  7.64411789e+00  1.06338244e+01  1.06338244e+01  1.06338244e+01
  3.54921036e+01  5.37163023e+01  5.37163023e+01  5.37163023e+01
  1.39964887e+02  5.04202719e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150333871787  E_coul = 54.028578876864714
cycle= 5 E= -128.502924461853  delta_E= -1.11e-09  |g|= 6.69e-06  |ddm|= 0.000102
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.26901e-06
diis-c [-1.89474567e-11  2.41908699e-06 -3.60058765e-05  1.65655855e-02
 -2.09033848e-01  1.19250185e+00]
  HOMO = -0.842036499999981  LUMO = 0.735306348685124
  mo_energy =
[-3.27817453e+01 -1.92931629e+00 -8.42036500e-01 -8.42036500e-01
 -8.42036500e-01  7.35306349e-01  7.35306349e-01  7.35306349e-01
  1.24661231e+00  2.86002514e+00  2.86002514e+00  2.86002514e+00
  7.64412162e+00  1.06338277e+01  1.06338277e+01  1.06338277e+01
  3.54921075e+01  5.37163058e+01  5.37163058e+01  5.37163058e+01
  1.39964890e+02  5.04202721e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150002326257  E_coul = 54.02857556140289
cycle= 6 E= -128.50292446186  delta_E= -6.51e-12  |g|= 8.99e-07  |ddm|= 6.57e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.02 sec
E1 = -182.53150002326257  E_coul = 54.02857556140289
  HOMO = -0.84203705053637  LUMO = 0.735306216306838
  mo_energy =
[-3.27817465e+01 -1.92931683e+00 -8.42037051e-01 -8.42037051e-01
 -8.42037051e-01  7.35306216e-01  7.35306216e-01  7.35306216e-01
  1.24661202e+00  2.86002473e+00  2.86002473e+00  2.86002473e+00
  7.64412098e+00  1.06338269e+01  1.06338269e+01  1.06338269e+01
  3.54921065e+01  5.37163046e+01  5.37163046e+01  5.37163046e+01
  1.39964888e+02  5.04202719e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150232750826  E_coul = 54.02857786564859
Extra cycle  E= -128.50292446186  delta_E=    0  |g|= 3.39e-07  |ddm|= 5.47e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.14 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 360.3694586933373
E1 = -182.53150232750826  E_coul = 54.02857786564859
init E= -128.50292446186
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.84203689644709  LUMO = 0.735306239806124
  mo_energy =
[-3.27817459e+01 -1.92931667e+00 -8.42036896e-01 -8.42036896e-01
 -8.42036896e-01  7.35306240e-01  7.35306240e-01  7.35306240e-01
  1.24661207e+00  2.86002483e+00  2.86002483e+00  2.86002483e+00
  7.64412118e+00  1.06338271e+01  1.06338271e+01  1.06338271e+01
  3.54921069e+01  5.37163051e+01  5.37163051e+01  5.37163051e+01
  1.39964889e+02  5.04202720e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150101561505  E_coul = 54.02857655375487
cycle= 1 E= -128.50292446186  delta_E= -5.12e-13  |g|= 1.75e-07  |ddm|= 1.67e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53150101561505  E_coul = 54.02857655375487
  HOMO = -0.842036990119901  LUMO = 0.735306221990888
  mo_energy =
[-3.27817462e+01 -1.92931677e+00 -8.42036990e-01 -8.42036990e-01
 -8.42036990e-01  7.35306222e-01  7.35306222e-01  7.35306222e-01
  1.24661203e+00  2.86002477e+00  2.86002477e+00  2.86002477e+00
  7.64412107e+00  1.06338270e+01  1.06338270e+01  1.06338270e+01
  3.54921067e+01  5.37163049e+01  5.37163049e+01  5.37163049e+01
  1.39964889e+02  5.04202720e+02  1.87175937e+03  8.00125665e+03
  4.77686872e+04]
E1 = -182.53150164962017  E_coul = 54.028577187760405
Extra cycle  E= -128.50292446186  delta_E= 3.98e-13  |g|= 8.64e-08  |ddm|= 5.62e-08
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220696e+01 2.71465490e+01 3.92340152e-01
 3.00806722e+00 1.15971383e+00 1.72788267e+00 6.25291901e+00
 2.83302088e+01 2.84789169e-01 5.41123102e-01]
grad_E = [ 1.16149047e-12  1.48057441e-11 -2.69887140e-10  2.64265213e-09
 -1.63026300e-08  9.73333293e-07 -5.95430829e-08  8.29534902e-04
  4.70529258e-06 -8.14848339e-05 -1.94244007e-02 -9.21861445e-06
  5.11797201e-05  7.16898895e-02 -4.94821042e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434293        1
[INPUT] 0    0    [1    /1   ]  235.721742931        1
[INPUT] 0    0    [1    /1   ]  76.4809666372        1
[INPUT] 0    0    [1    /1   ]  10.122075171         1
[INPUT] 0    0    [1    /1   ]  27.1465478288        1
[INPUT] 0    0    [1    /1   ]  0.39166166974        1
[INPUT] 0    0    [1    /1   ]  3.00809308545        1
[INPUT] 0    0    [1    /1   ]  1.15951975443        1
[INPUT] 1    0    [1    /1   ]  1.82578977836        1
[INPUT] 1    0    [1    /1   ]  6.24730237432        1
[INPUT] 1    0    [1    /1   ]  28.3302857281        1
[INPUT] 1    0    [1    /1   ]  1.00000002723e-09      1
[INPUT] 1    0    [1    /1   ]  0.664914356824       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411716, 1.0]], [0, [3661.454398068328, 1.0]], [0, [833.272434292895, 1.0]], [0, [235.7217429307528, 1.0]], [0, [76.4809666372138, 1.0]], [0, [10.12207517096874, 1.0]], [0, [27.146547828823124, 1.0]], [0, [0.3916616697399818, 1.0]], [0, [3.0080930854532997, 1.0]], [0, [1.1595197544295281, 1.0]], [1, [1.825789778358222, 1.0]], [1, [6.247302374316166, 1.0]], [1, [28.330285728110326, 1.0]], [1, [1.0000000272292198e-09, 1.0]], [1, [0.6649143568239713, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174293]
bas 4, expnt(s) = [76.48096664]
bas 5, expnt(s) = [10.12207517]
bas 6, expnt(s) = [27.14654783]
bas 7, expnt(s) = [0.39166167]
bas 8, expnt(s) = [3.00809309]
bas 9, expnt(s) = [1.15951975]
bas 10, expnt(s) = [1.82578978]
bas 11, expnt(s) = [6.24730237]
bas 12, expnt(s) = [28.33028573]
bas 13, expnt(s) = [1.00000003e-09]
bas 14, expnt(s) = [0.66491436]
CPU time:        18.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809666e+01 6.53401385e+01 1.01220752e+01 1.43372941e+01
 2.71465478e+01 3.00469906e+01 3.91661670e-01 1.25083011e+00
 3.00809309e+00 5.77076618e+00 1.15951975e+00 2.82308294e+00
 1.82578978e+00 6.19152822e+00 6.24730237e+00 2.88137677e+01
 2.83302857e+01 1.90676901e+02 1.00000003e-09 1.64053087e-11
 6.64914357e-01 1.75162659e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.939361241051433
cond(S) = 360.135670382187
E1 = -183.21009636102158  E_coul = 54.97562974536825
init E= -128.234466615653
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.755581980187607  LUMO = -0.000336415174183054
  mo_energy =
[-3.25634621e+01 -1.86471229e+00 -7.55581980e-01 -7.55581980e-01
 -7.55581980e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.26861181e+00  2.37927497e+00  2.37927497e+00  2.37927497e+00
  7.71552273e+00  1.07132537e+01  1.07132537e+01  1.07132537e+01
  3.56473018e+01  5.40443476e+01  5.40443476e+01  5.40443476e+01
  1.40175166e+02  5.04445730e+02  1.87203179e+03  8.00155528e+03
  4.77690040e+04]
E1 = -183.61007205386377  E_coul = 55.24315024826725
cycle= 1 E= -128.366921805597  delta_E= -0.132  |g|= 0.0688  |ddm|= 0.283
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102029
diis-c [-0.01040993  1.        ]
  HOMO = -0.719655149804539  LUMO = -0.000336415174189142
  mo_energy =
[-3.25867070e+01 -1.81632638e+00 -7.19655150e-01 -7.19655150e-01
 -7.19655150e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.31071179e+00  2.42018988e+00  2.42018988e+00  2.42018988e+00
  7.76199544e+00  1.07479931e+01  1.07479931e+01  1.07479931e+01
  3.56616497e+01  5.40336116e+01  5.40336116e+01  5.40336116e+01
  1.40153297e+02  5.04394809e+02  1.87195043e+03  8.00144652e+03
  4.77688768e+04]
E1 = -183.6325349642742  E_coul = 55.265356256351794
cycle= 2 E= -128.367178707922  delta_E= -0.000257  |g|= 0.00754  |ddm|= 0.0265
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0107795
diis-c [-1.06019979e-04 -3.24486770e-02  1.03244868e+00]
  HOMO = -0.718362769649008  LUMO = -0.000336415174183899
  mo_energy =
[-3.25821840e+01 -1.81328277e+00 -7.18362770e-01 -7.18362770e-01
 -7.18362770e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.31207288e+00  2.42105905e+00  2.42105905e+00  2.42105905e+00
  7.76456532e+00  1.07505896e+01  1.07505896e+01  1.07505896e+01
  3.56654294e+01  5.40378707e+01  5.40378707e+01  5.40378707e+01
  1.40157908e+02  5.04399729e+02  1.87195525e+03  8.00145114e+03
  4.77688813e+04]
E1 = -183.6240273961316  E_coul = 55.2568408996891
cycle= 3 E= -128.367186496442  delta_E= -7.79e-06  |g|= 0.00161  |ddm|= 0.0049
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00331664
diis-c [-8.35725340e-06 -1.57781965e-02  8.99277571e-02  9.25850439e-01]
  HOMO = -0.719015842051753  LUMO = -0.00033641517418327
  mo_energy =
[-3.25840185e+01 -1.81361638e+00 -7.19015842e-01 -7.19015842e-01
 -7.19015842e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.31197691e+00  2.42060586e+00  2.42060586e+00  2.42060586e+00
  7.76395766e+00  1.07496003e+01  1.07496003e+01  1.07496003e+01
  3.56641057e+01  5.40362310e+01  5.40362310e+01  5.40362310e+01
  1.40156091e+02  5.04397551e+02  1.87195279e+03  8.00144851e+03
  4.77688786e+04]
E1 = -183.62686076215596  E_coul = 55.25967395078672
cycle= 4 E= -128.367186811369  delta_E= -3.15e-07  |g|= 0.000376  |ddm|= 0.000804
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000598916
diis-c [-1.61701273e-08  1.23370220e-03 -5.41247020e-02  6.57365056e-02
  9.87154494e-01]
  HOMO = -0.718948703013158  LUMO = -0.000336415174188216
  mo_energy =
[-3.25836974e+01 -1.81347007e+00 -7.18948703e-01 -7.18948703e-01
 -7.18948703e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.31203315e+00  2.42064679e+00  2.42064679e+00  2.42064679e+00
  7.76408920e+00  1.07497474e+01  1.07497474e+01  1.07497474e+01
  3.56643518e+01  5.40365229e+01  5.40365229e+01  5.40365229e+01
  1.40156397e+02  5.04397847e+02  1.87195305e+03  8.00144875e+03
  4.77688788e+04]
E1 = -183.6262256921764  E_coul = 55.25903886591796
cycle= 5 E= -128.367186826258  delta_E= -1.49e-08  |g|= 1.65e-05  |ddm|= 0.000221
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.35268e-05
diis-c [-2.24992336e-11 -6.27353644e-05  4.19619260e-03 -1.19157753e-02
 -4.17890626e-02  1.04957138e+00]
  HOMO = -0.718955998832362  LUMO = -0.000336415174189586
  mo_energy =
[-3.25837147e+01 -1.81347766e+00 -7.18955999e-01 -7.18955999e-01
 -7.18955999e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.31203002e+00  2.42064176e+00  2.42064176e+00  2.42064176e+00
  7.76408041e+00  1.07497359e+01  1.07497359e+01  1.07497359e+01
  3.56643372e+01  5.40365064e+01  5.40365064e+01  5.40365064e+01
  1.40156379e+02  5.04397827e+02  1.87195303e+03  8.00144873e+03
  4.77688788e+04]
E1 = -183.62625589837688  E_coul = 55.25906907210132
cycle= 6 E= -128.367186826276  delta_E= -1.71e-11  |g|= 4.06e-07  |ddm|= 4.14e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.62625589837688  E_coul = 55.25906907210132
  HOMO = -0.718955764949067  LUMO = -0.000336415174184415
  mo_energy =
[-3.25837142e+01 -1.81347743e+00 -7.18955765e-01 -7.18955765e-01
 -7.18955765e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  1.31203011e+00  2.42064192e+00  2.42064192e+00  2.42064192e+00
  7.76408070e+00  1.07497363e+01  1.07497363e+01  1.07497363e+01
  3.56643377e+01  5.40365069e+01  5.40365069e+01  5.40365069e+01
  1.40156380e+02  5.04397828e+02  1.87195303e+03  8.00144873e+03
  4.77688788e+04]
E1 = -183.62625485868372  E_coul = 55.259068032407676
Extra cycle  E= -128.367186826276  delta_E= -4.83e-13  |g|= 1.41e-07  |ddm|= 1.24e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809666e+01 1.01220752e+01 2.71465478e+01 3.91661670e-01
 3.00809309e+00 1.15951975e+00 1.82578978e+00 6.24730237e+00
 2.83302857e+01 1.00000003e-09 6.64914357e-01]
E = -128.36718682627605
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742947        1
[INPUT] 0    0    [1    /1   ]  76.4809664775        1
[INPUT] 0    0    [1    /1   ]  10.122070155         1
[INPUT] 0    0    [1    /1   ]  27.1465488607        1
[INPUT] 0    0    [1    /1   ]  0.392272303645       1
[INPUT] 0    0    [1    /1   ]  3.0080698088         1
[INPUT] 0    0    [1    /1   ]  1.15969442514        1
[INPUT] 1    0    [1    /1   ]  1.73767337645        1
[INPUT] 1    0    [1    /1   ]  6.25235735075        1
[INPUT] 1    0    [1    /1   ]  28.3302164923        1
[INPUT] 1    0    [1    /1   ]  0.256310252479       1
[INPUT] 1    0    [1    /1   ]  0.553502227761       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.4543980684116, 1.0]], [0, [833.2724342913879, 1.0]], [0, [235.72174294735802, 1.0]], [0, [76.48096647749296, 1.0]], [0, [10.122070155014693, 1.0]], [0, [27.146548860734704, 1.0]], [0, [0.39227230364505117, 1.0]], [0, [3.008069808798967, 1.0]], [0, [1.159694425140062, 1.0]], [1, [1.7376733764491255, 1.0]], [1, [6.252357350748701, 1.0]], [1, [28.33021649230212, 1.0]], [1, [0.25631025247922484, 1.0]], [1, [0.5535022277609783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096648]
bas 5, expnt(s) = [10.12207016]
bas 6, expnt(s) = [27.14654886]
bas 7, expnt(s) = [0.3922723]
bas 8, expnt(s) = [3.00806981]
bas 9, expnt(s) = [1.15969443]
bas 10, expnt(s) = [1.73767338]
bas 11, expnt(s) = [6.25235735]
bas 12, expnt(s) = [28.33021649]
bas 13, expnt(s) = [0.25631025]
bas 14, expnt(s) = [0.55350223]
CPU time:        18.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401384e+01 1.01220702e+01 1.43372887e+01
 2.71465489e+01 3.00469915e+01 3.92272304e-01 1.25229244e+00
 3.00806981e+00 5.77073269e+00 1.15969443e+00 2.82340189e+00
 1.73767338e+00 5.82028936e+00 6.25235735e+00 2.88429138e+01
 2.83302165e+01 1.90676319e+02 2.56310252e-01 5.32037036e-01
 5.53502228e-01 1.39278349e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998308698552073
cond(S) = 360.3460486038569
E1 = -183.53975875467293  E_coul = 55.06962514124561
init E= -128.470133613427
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.770421226660424  LUMO = 0.694689264752566
  mo_energy =
[-3.25569837e+01 -1.85351335e+00 -7.70421227e-01 -7.70421227e-01
 -7.70421227e-01  6.94689265e-01  6.94689265e-01  6.94689265e-01
  1.27636332e+00  2.83929141e+00  2.83929141e+00  2.83929141e+00
  7.73437684e+00  1.07238008e+01  1.07238008e+01  1.07238008e+01
  3.56611558e+01  5.39135495e+01  5.39135495e+01  5.39135495e+01
  1.40185635e+02  5.04458561e+02  1.87204639e+03  8.00157023e+03
  4.77690187e+04]
E1 = -181.97239627456847  E_coul = 53.470653721334536
cycle= 1 E= -128.501742553234  delta_E= -0.0316  |g|= 0.216  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509989
diis-c [-0.26008925  1.        ]
  HOMO = -0.88232818119452  LUMO = 0.67622242830543
  mo_energy =
[-3.28999042e+01 -1.97160309e+00 -8.82328181e-01 -8.82328181e-01
 -8.82328181e-01  6.76222428e-01  6.76222428e-01  6.76222428e-01
  1.22854960e+00  2.76683059e+00  2.76683059e+00  2.76683059e+00
  7.59394736e+00  1.05401708e+01  1.05401708e+01  1.05401708e+01
  3.54003334e+01  5.36020342e+01  5.36020342e+01  5.36020342e+01
  1.39848554e+02  5.04074991e+02  1.87162612e+03  8.00112083e+03
  4.77685505e+04]
E1 = -182.77248375652232  E_coul = 54.26782585428623
cycle= 2 E= -128.504657902236  delta_E= -0.00292  |g|= 0.108  |ddm|= 0.0716
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258361
diis-c [-5.7451458e-04  3.3553695e-01  6.6446305e-01]
  HOMO = -0.844829510254779  LUMO = 0.68274770104608
  mo_energy =
[-3.27863983e+01 -1.93209916e+00 -8.44829510e-01 -8.44829510e-01
 -8.44829510e-01  6.82747701e-01  6.82747701e-01  6.82747701e-01
  1.24472775e+00  2.79119365e+00  2.79119365e+00  2.79119365e+00
  7.64067335e+00  1.06016150e+01  1.06016150e+01  1.06016150e+01
  3.54875651e+01  5.37055255e+01  5.37055255e+01  5.37055255e+01
  1.39959975e+02  5.04197785e+02  1.87175453e+03  8.00125190e+03
  4.77686826e+04]
E1 = -182.5065878357866  E_coul = 54.00093483249929
cycle= 3 E= -128.505653003287  delta_E= -0.000995  |g|= 0.000349  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000503615
diis-c [-6.41035926e-08 -1.55150854e-03 -4.67348760e-03  1.00622500e+00]
  HOMO = -0.844766297276631  LUMO = 0.68281256461776
  mo_energy =
[-3.27862673e+01 -1.93200343e+00 -8.44766297e-01 -8.44766297e-01
 -8.44766297e-01  6.82812565e-01  6.82812565e-01  6.82812565e-01
  1.24484352e+00  2.79131995e+00  2.79131995e+00  2.79131995e+00
  7.64080558e+00  1.06017747e+01  1.06017747e+01  1.06017747e+01
  3.54877085e+01  5.37056653e+01  5.37056653e+01  5.37056653e+01
  1.39960116e+02  5.04197917e+02  1.87175464e+03  8.00125199e+03
  4.77686826e+04]
E1 = -182.50619878178034  E_coul = 54.00054576277744
cycle= 4 E= -128.505653019003  delta_E= -1.57e-08  |g|= 3.62e-05  |ddm|= 0.000298
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.1458e-05
diis-c [-5.89750909e-10  2.57517016e-05  2.05011703e-04 -6.47036155e-02
  1.06447285e+00]
  HOMO = -0.844762211665363  LUMO = 0.682815578511644
  mo_energy =
[-3.27862632e+01 -1.93199581e+00 -8.44762212e-01 -8.44762212e-01
 -8.44762212e-01  6.82815579e-01  6.82815579e-01  6.82815579e-01
  1.24485149e+00  2.79132580e+00  2.79132580e+00  2.79132580e+00
  7.64080994e+00  1.06017799e+01  1.06017799e+01  1.06017799e+01
  3.54877114e+01  5.37056692e+01  5.37056692e+01  5.37056692e+01
  1.39960121e+02  5.04197926e+02  1.87175465e+03  8.00125200e+03
  4.77686826e+04]
E1 = -182.50624148912698  E_coul = 54.00058846982614
cycle= 5 E= -128.505653019301  delta_E= -2.98e-10  |g|= 5.26e-06  |ddm|= 4.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.50624148912698  E_coul = 54.00058846982614
  HOMO = -0.844760060216347  LUMO = 0.682816203247551
  mo_energy =
[-3.27862594e+01 -1.93199273e+00 -8.44760060e-01 -8.44760060e-01
 -8.44760060e-01  6.82816203e-01  6.82816203e-01  6.82816203e-01
  1.24485341e+00  2.79132762e+00  2.79132762e+00  2.79132762e+00
  7.64081292e+00  1.06017831e+01  1.06017831e+01  1.06017831e+01
  3.54877151e+01  5.37056730e+01  5.37056730e+01  5.37056730e+01
  1.39960125e+02  5.04197930e+02  1.87175466e+03  8.00125200e+03
  4.77686826e+04]
E1 = -182.50623662246002  E_coul = 54.00058360315432
Extra cycle  E= -128.505653019306  delta_E= -4.86e-12  |g|= 1.15e-06  |ddm|= 4.67e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220702e+01 2.71465489e+01 3.92272304e-01
 3.00806981e+00 1.15969443e+00 1.73767338e+00 6.25235735e+00
 2.83302165e+01 2.56310252e-01 5.53502228e-01]
E = -128.5056530193057
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434291        1
[INPUT] 0    0    [1    /1   ]  235.721742947        1
[INPUT] 0    0    [1    /1   ]  76.4809664775        1
[INPUT] 0    0    [1    /1   ]  10.122070155         1
[INPUT] 0    0    [1    /1   ]  27.1465488607        1
[INPUT] 0    0    [1    /1   ]  0.392272303645       1
[INPUT] 0    0    [1    /1   ]  3.0080698088         1
[INPUT] 0    0    [1    /1   ]  1.15969442514        1
[INPUT] 1    0    [1    /1   ]  1.73767337645        1
[INPUT] 1    0    [1    /1   ]  6.25235735075        1
[INPUT] 1    0    [1    /1   ]  28.3302164923        1
[INPUT] 1    0    [1    /1   ]  0.256310252479       1
[INPUT] 1    0    [1    /1   ]  0.553502227761       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.4543980684116, 1.0]], [0, [833.2724342913879, 1.0]], [0, [235.72174294735802, 1.0]], [0, [76.48096647749296, 1.0]], [0, [10.122070155014693, 1.0]], [0, [27.146548860734704, 1.0]], [0, [0.39227230364505117, 1.0]], [0, [3.008069808798967, 1.0]], [0, [1.159694425140062, 1.0]], [1, [1.7376733764491255, 1.0]], [1, [6.252357350748701, 1.0]], [1, [28.33021649230212, 1.0]], [1, [0.25631025247922484, 1.0]], [1, [0.5535022277609783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243429]
bas 3, expnt(s) = [235.72174295]
bas 4, expnt(s) = [76.48096648]
bas 5, expnt(s) = [10.12207016]
bas 6, expnt(s) = [27.14654886]
bas 7, expnt(s) = [0.3922723]
bas 8, expnt(s) = [3.00806981]
bas 9, expnt(s) = [1.15969443]
bas 10, expnt(s) = [1.73767338]
bas 11, expnt(s) = [6.25235735]
bas 12, expnt(s) = [28.33021649]
bas 13, expnt(s) = [0.25631025]
bas 14, expnt(s) = [0.55350223]
CPU time:        18.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809665e+01 6.53401384e+01 1.01220702e+01 1.43372887e+01
 2.71465489e+01 3.00469915e+01 3.92272304e-01 1.25229244e+00
 3.00806981e+00 5.77073269e+00 1.15969443e+00 2.82340189e+00
 1.73767338e+00 5.82028936e+00 6.25235735e+00 2.88429138e+01
 2.83302165e+01 1.90676319e+02 2.56310252e-01 5.32037036e-01
 5.53502228e-01 1.39278349e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998308698552073
cond(S) = 360.3460486038569
E1 = -183.53975875467293  E_coul = 55.06962514124561
init E= -128.470133613427
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770421226660424  LUMO = 0.694689264752566
  mo_energy =
[-3.25569837e+01 -1.85351335e+00 -7.70421227e-01 -7.70421227e-01
 -7.70421227e-01  6.94689265e-01  6.94689265e-01  6.94689265e-01
  1.27636332e+00  2.83929141e+00  2.83929141e+00  2.83929141e+00
  7.73437684e+00  1.07238008e+01  1.07238008e+01  1.07238008e+01
  3.56611558e+01  5.39135495e+01  5.39135495e+01  5.39135495e+01
  1.40185635e+02  5.04458561e+02  1.87204639e+03  8.00157023e+03
  4.77690187e+04]
E1 = -181.97239627456847  E_coul = 53.470653721334536
cycle= 1 E= -128.501742553234  delta_E= -0.0316  |g|= 0.216  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.509989
diis-c [-0.26008925  1.        ]
  HOMO = -0.88232818119452  LUMO = 0.67622242830543
  mo_energy =
[-3.28999042e+01 -1.97160309e+00 -8.82328181e-01 -8.82328181e-01
 -8.82328181e-01  6.76222428e-01  6.76222428e-01  6.76222428e-01
  1.22854960e+00  2.76683059e+00  2.76683059e+00  2.76683059e+00
  7.59394736e+00  1.05401708e+01  1.05401708e+01  1.05401708e+01
  3.54003334e+01  5.36020342e+01  5.36020342e+01  5.36020342e+01
  1.39848554e+02  5.04074991e+02  1.87162612e+03  8.00112083e+03
  4.77685505e+04]
E1 = -182.77248375652232  E_coul = 54.26782585428623
cycle= 2 E= -128.504657902236  delta_E= -0.00292  |g|= 0.108  |ddm|= 0.0716
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258361
diis-c [-5.7451458e-04  3.3553695e-01  6.6446305e-01]
  HOMO = -0.844829510254779  LUMO = 0.68274770104608
  mo_energy =
[-3.27863983e+01 -1.93209916e+00 -8.44829510e-01 -8.44829510e-01
 -8.44829510e-01  6.82747701e-01  6.82747701e-01  6.82747701e-01
  1.24472775e+00  2.79119365e+00  2.79119365e+00  2.79119365e+00
  7.64067335e+00  1.06016150e+01  1.06016150e+01  1.06016150e+01
  3.54875651e+01  5.37055255e+01  5.37055255e+01  5.37055255e+01
  1.39959975e+02  5.04197785e+02  1.87175453e+03  8.00125190e+03
  4.77686826e+04]
E1 = -182.5065878357866  E_coul = 54.00093483249929
cycle= 3 E= -128.505653003287  delta_E= -0.000995  |g|= 0.000349  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000503615
diis-c [-6.41035926e-08 -1.55150854e-03 -4.67348760e-03  1.00622500e+00]
  HOMO = -0.844766297276631  LUMO = 0.68281256461776
  mo_energy =
[-3.27862673e+01 -1.93200343e+00 -8.44766297e-01 -8.44766297e-01
 -8.44766297e-01  6.82812565e-01  6.82812565e-01  6.82812565e-01
  1.24484352e+00  2.79131995e+00  2.79131995e+00  2.79131995e+00
  7.64080558e+00  1.06017747e+01  1.06017747e+01  1.06017747e+01
  3.54877085e+01  5.37056653e+01  5.37056653e+01  5.37056653e+01
  1.39960116e+02  5.04197917e+02  1.87175464e+03  8.00125199e+03
  4.77686826e+04]
E1 = -182.50619878178034  E_coul = 54.00054576277744
cycle= 4 E= -128.505653019003  delta_E= -1.57e-08  |g|= 3.62e-05  |ddm|= 0.000298
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.1458e-05
diis-c [-5.89750909e-10  2.57517016e-05  2.05011703e-04 -6.47036155e-02
  1.06447285e+00]
  HOMO = -0.844762211665363  LUMO = 0.682815578511644
  mo_energy =
[-3.27862632e+01 -1.93199581e+00 -8.44762212e-01 -8.44762212e-01
 -8.44762212e-01  6.82815579e-01  6.82815579e-01  6.82815579e-01
  1.24485149e+00  2.79132580e+00  2.79132580e+00  2.79132580e+00
  7.64080994e+00  1.06017799e+01  1.06017799e+01  1.06017799e+01
  3.54877114e+01  5.37056692e+01  5.37056692e+01  5.37056692e+01
  1.39960121e+02  5.04197926e+02  1.87175465e+03  8.00125200e+03
  4.77686826e+04]
E1 = -182.50624148912698  E_coul = 54.00058846982614
cycle= 5 E= -128.505653019301  delta_E= -2.98e-10  |g|= 5.26e-06  |ddm|= 4.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.50624148912698  E_coul = 54.00058846982614
  HOMO = -0.844760060216347  LUMO = 0.682816203247551
  mo_energy =
[-3.27862594e+01 -1.93199273e+00 -8.44760060e-01 -8.44760060e-01
 -8.44760060e-01  6.82816203e-01  6.82816203e-01  6.82816203e-01
  1.24485341e+00  2.79132762e+00  2.79132762e+00  2.79132762e+00
  7.64081292e+00  1.06017831e+01  1.06017831e+01  1.06017831e+01
  3.54877151e+01  5.37056730e+01  5.37056730e+01  5.37056730e+01
  1.39960125e+02  5.04197930e+02  1.87175466e+03  8.00125200e+03
  4.77686826e+04]
E1 = -182.50623662246002  E_coul = 54.00058360315432
Extra cycle  E= -128.505653019306  delta_E= -4.86e-12  |g|= 1.15e-06  |ddm|= 4.67e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 360.3460486038569
E1 = -182.50623662246002  E_coul = 54.00058360315432
init E= -128.505653019306
    CPU time for initialize scf      0.19 sec, wall time      0.18 sec
  HOMO = -0.844760384604959  LUMO = 0.682816189264917
  mo_energy =
[-3.27862607e+01 -1.93199288e+00 -8.44760385e-01 -8.44760385e-01
 -8.44760385e-01  6.82816189e-01  6.82816189e-01  6.82816189e-01
  1.24485347e+00  2.79132748e+00  2.79132748e+00  2.79132748e+00
  7.64081260e+00  1.06017825e+01  1.06017825e+01  1.06017825e+01
  3.54877142e+01  5.37056719e+01  5.37056719e+01  5.37056719e+01
  1.39960124e+02  5.04197928e+02  1.87175465e+03  8.00125200e+03
  4.77686826e+04]
E1 = -182.506240545221  E_coul = 54.00058752591519
cycle= 1 E= -128.505653019306  delta_E= -1.14e-13  |g|= 5.57e-07  |ddm|= 9.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.506240545221  E_coul = 54.00058752591519
  HOMO = -0.844760107189485  LUMO = 0.682816244536293
  mo_energy =
[-3.27862599e+01 -1.93199254e+00 -8.44760107e-01 -8.44760107e-01
 -8.44760107e-01  6.82816245e-01  6.82816245e-01  6.82816245e-01
  1.24485363e+00  2.79132767e+00  2.79132767e+00  2.79132767e+00
  7.64081297e+00  1.06017829e+01  1.06017829e+01  1.06017829e+01
  3.54877148e+01  5.37056726e+01  5.37056726e+01  5.37056726e+01
  1.39960125e+02  5.04197929e+02  1.87175466e+03  8.00125200e+03
  4.77686826e+04]
E1 = -182.50623881814388  E_coul = 54.00058579883772
Extra cycle  E= -128.505653019306  delta_E= -3.69e-13  |g|= 2.38e-07  |ddm|= 2.38e-07
    CPU time for scf_cycle      0.24 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809665e+01 1.01220702e+01 2.71465489e+01 3.92272304e-01
 3.00806981e+00 1.15969443e+00 1.73767338e+00 6.25235735e+00
 2.83302165e+01 2.56310252e-01 5.53502228e-01]
grad_E = [ 5.02906816e-13  4.95759619e-11 -9.73487801e-10  1.14575573e-08
 -9.32167305e-08 -1.15010583e-06  4.44001254e-07  8.85942257e-04
 -2.51389906e-06 -2.10011386e-05 -2.87254837e-02  6.56686683e-04
  3.95046003e-05  6.25919441e-02 -3.73060378e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434331        1
[INPUT] 0    0    [1    /1   ]  235.721742464        1
[INPUT] 0    0    [1    /1   ]  76.4809705885        1
[INPUT] 0    0    [1    /1   ]  10.1221567258        1
[INPUT] 0    0    [1    /1   ]  27.1465248072        1
[INPUT] 0    0    [1    /1   ]  0.372338603049       1
[INPUT] 0    0    [1    /1   ]  3.00831036539        1
[INPUT] 0    0    [1    /1   ]  1.15871587543        1
[INPUT] 1    0    [1    /1   ]  2.5873754296         1
[INPUT] 1    0    [1    /1   ]  6.20636216822        1
[INPUT] 1    0    [1    /1   ]  28.3305063091        1
[INPUT] 1    0    [1    /1   ]  1.00000041581e-09      1
[INPUT] 1    0    [1    /1   ]  0.93732278525        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141174, 1.0]], [0, [3661.454398066448, 1.0]], [0, [833.2724343307465, 1.0]], [0, [235.7217424642204, 1.0]], [0, [76.4809705885456, 1.0]], [0, [10.122156725815978, 1.0]], [0, [27.146524807171303, 1.0]], [0, [0.3723386030494935, 1.0]], [0, [3.008310365385321, 1.0]], [0, [1.1587158754288882, 1.0]], [1, [2.587375429596606, 1.0]], [1, [6.206362168222453, 1.0]], [1, [28.33050630905717, 1.0]], [1, [1.0000004158072784e-09, 1.0]], [1, [0.9373227852501984, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243433]
bas 3, expnt(s) = [235.72174246]
bas 4, expnt(s) = [76.48097059]
bas 5, expnt(s) = [10.12215673]
bas 6, expnt(s) = [27.14652481]
bas 7, expnt(s) = [0.3723386]
bas 8, expnt(s) = [3.00831037]
bas 9, expnt(s) = [1.15871588]
bas 10, expnt(s) = [2.58737543]
bas 11, expnt(s) = [6.20636217]
bas 12, expnt(s) = [28.33050631]
bas 13, expnt(s) = [1.00000042e-09]
bas 14, expnt(s) = [0.93732279]
CPU time:        21.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721742e+02 1.51989909e+02
 7.64809706e+01 6.53401410e+01 1.01221567e+01 1.43373807e+01
 2.71465248e+01 3.00469715e+01 3.72338603e-01 1.20425532e+00
 3.00831037e+00 5.77107880e+00 1.15871588e+00 2.82161491e+00
 2.58737543e+00 9.57323466e+00 6.20636217e+00 2.85779312e+01
 2.83305063e+01 1.90678757e+02 1.00000042e-09 1.64053167e-11
 9.37322785e-01 2.69057970e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.841851927344113
cond(S) = 354.5713104851527
E1 = -182.68601576977832  E_coul = 54.828350763392436
init E= -127.857665006386
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.732700069296629  LUMO = -0.000336415239545704
  mo_energy =
[-3.25747536e+01 -1.88218045e+00 -7.32700069e-01 -7.32700069e-01
 -7.32700069e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.19107451e+00  3.58525706e+00  3.58525706e+00  3.58525706e+00
  7.60385746e+00  1.36919550e+01  1.36919550e+01  1.36919550e+01
  3.55475022e+01  5.71529568e+01  5.71529568e+01  5.71529568e+01
  1.40087831e+02  5.04366927e+02  1.87196000e+03  8.00149062e+03
  4.77689483e+04]
E1 = -185.02632572370908  E_coul = 56.89936408524976
cycle= 1 E= -128.126961638459  delta_E= -0.269  |g|= 0.214  |ddm|= 0.628
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.361481
diis-c [-0.13066886  1.        ]
  HOMO = -0.552898178510406  LUMO = -0.000336415239561849
  mo_energy =
[-3.22763492e+01 -1.68084036e+00 -5.52898179e-01 -5.52898179e-01
 -5.52898179e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.31483812e+00  3.77209812e+00  3.77209812e+00  3.77209812e+00
  7.82552364e+00  1.39419272e+01  1.39419272e+01  1.39419272e+01
  3.58313827e+01  5.74427546e+01  5.74427546e+01  5.74427546e+01
  1.40381913e+02  5.04648398e+02  1.87221593e+03  8.00172036e+03
  4.77691598e+04]
E1 = -184.54881384270652  E_coul = 56.41857343438822
cycle= 2 E= -128.130240408318  delta_E= -0.00328  |g|= 0.0633  |ddm|= 0.0916
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.129492
diis-c [-0.00284039  0.24816822  0.75183178]
  HOMO = -0.578976488117449  LUMO = -0.000336415239544815
  mo_energy =
[-3.23572507e+01 -1.70220326e+00 -5.78976488e-01 -5.78976488e-01
 -5.78976488e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.30810252e+00  3.74890379e+00  3.74890379e+00  3.74890379e+00
  7.79651319e+00  1.38985837e+01  1.38985837e+01  1.38985837e+01
  3.57717016e+01  5.73707273e+01  5.73707273e+01  5.73707273e+01
  1.40302600e+02  5.04558866e+02  1.87212053e+03  8.00162184e+03
  4.77690601e+04]
E1 = -184.65353565786108  E_coul = 56.52302293203621
cycle= 3 E= -128.130512725825  delta_E= -0.000272  |g|= 0.00579  |ddm|= 0.0168
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00963718
diis-c [-3.26052120e-05 -3.30800516e-02 -1.26444227e-01  1.15952428e+00]
  HOMO = -0.580585537472387  LUMO = -0.000336415239543849
  mo_energy =
[-3.23595142e+01 -1.70208788e+00 -5.80585537e-01 -5.80585537e-01
 -5.80585537e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.30822972e+00  3.74739010e+00  3.74739010e+00  3.74739010e+00
  7.79567140e+00  1.38968077e+01  1.38968077e+01  1.38968077e+01
  3.57698881e+01  5.73686490e+01  5.73686490e+01  5.73686490e+01
  1.40300418e+02  5.04556261e+02  1.87211740e+03  8.00161834e+03
  4.77690564e+04]
E1 = -184.65367952561425  E_coul = 56.52316128682587
cycle= 4 E= -128.130518238788  delta_E= -5.51e-06  |g|= 0.000524  |ddm|= 0.00454
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000835404
diis-c [-2.68624188e-08  1.17808249e-03  5.21605890e-03 -1.27208461e-01
  1.12081432e+00]
  HOMO = -0.580696055532215  LUMO = -0.000336415239544148
  mo_energy =
[-3.23596093e+01 -1.70202384e+00 -5.80696056e-01 -5.80696056e-01
 -5.80696056e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.30824231e+00  3.74727082e+00  3.74727082e+00  3.74727082e+00
  7.79563843e+00  1.38967053e+01  1.38967053e+01  1.38967053e+01
  3.57698258e+01  5.73685608e+01  5.73685608e+01  5.73685608e+01
  1.40300291e+02  5.04555988e+02  1.87211697e+03  8.00161781e+03
  4.77690558e+04]
E1 = -184.65348476006446  E_coul = 56.52296648061811
cycle= 5 E= -128.130518279446  delta_E= -4.07e-08  |g|= 1.54e-05  |ddm|= 0.000412
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.1175e-05
diis-c [-2.96625617e-11 -1.27318914e-05 -3.73282998e-04  5.48002785e-03
 -4.62487353e-02  1.04115472e+00]
  HOMO = -0.580702083116869  LUMO = -0.000336415239551966
  mo_energy =
[-3.23596266e+01 -1.70203028e+00 -5.80702083e-01 -5.80702083e-01
 -5.80702083e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.30824048e+00  3.74726573e+00  3.74726573e+00  3.74726573e+00
  7.79563138e+00  1.38966949e+01  1.38966949e+01  1.38966949e+01
  3.57698121e+01  5.73685449e+01  5.73685449e+01  5.73685449e+01
  1.40300274e+02  5.04555968e+02  1.87211695e+03  8.00161778e+03
  4.77690558e+04]
E1 = -184.65351136182107  E_coul = 56.52299308235848
cycle= 6 E= -128.130518279463  delta_E= -1.63e-11  |g|= 2.56e-07  |ddm|= 5.87e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -184.65351136182107  E_coul = 56.52299308235848
  HOMO = -0.580701976123054  LUMO = -0.000336415239558838
  mo_energy =
[-3.23596264e+01 -1.70203024e+00 -5.80701976e-01 -5.80701976e-01
 -5.80701976e-01 -3.36415240e-04 -3.36415240e-04 -3.36415240e-04
  1.30824050e+00  3.74726583e+00  3.74726583e+00  3.74726583e+00
  7.79563148e+00  1.38966951e+01  1.38966951e+01  1.38966951e+01
  3.57698123e+01  5.73685450e+01  5.73685450e+01  5.73685450e+01
  1.40300274e+02  5.04555968e+02  1.87211695e+03  8.00161778e+03
  4.77690558e+04]
E1 = -184.6535112345743  E_coul = 56.522992955111704
Extra cycle  E= -128.130518279463  delta_E=    0  |g|= 4.91e-08  |ddm|= 2.12e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721742e+02
 7.64809706e+01 1.01221567e+01 2.71465248e+01 3.72338603e-01
 3.00831037e+00 1.15871588e+00 2.58737543e+00 6.20636217e+00
 2.83305063e+01 1.00000042e-09 9.37322785e-01]
E = -128.1305182794626
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434295        1
[INPUT] 0    0    [1    /1   ]  235.721742899        1
[INPUT] 0    0    [1    /1   ]  76.4809668886        1
[INPUT] 0    0    [1    /1   ]  10.1220788121        1
[INPUT] 0    0    [1    /1   ]  27.1465464554        1
[INPUT] 0    0    [1    /1   ]  0.390278933585       1
[INPUT] 0    0    [1    /1   ]  3.00809386446        1
[INPUT] 0    0    [1    /1   ]  1.15959657017        1
[INPUT] 1    0    [1    /1   ]  1.82264358176        1
[INPUT] 1    0    [1    /1   ]  6.2477578325         1
[INPUT] 1    0    [1    /1   ]  28.330245474         1
[INPUT] 1    0    [1    /1   ]  0.230679227331       1
[INPUT] 1    0    [1    /1   ]  0.59188428351        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068215, 1.0]], [0, [833.2724342953237, 1.0]], [0, [235.72174289904427, 1.0]], [0, [76.48096688859822, 1.0]], [0, [10.122078812094822, 1.0]], [0, [27.146546455378363, 1.0]], [0, [0.3902789335854954, 1.0]], [0, [3.008093864457602, 1.0]], [0, [1.1595965701689446, 1.0]], [1, [1.8226435817638735, 1.0]], [1, [6.2477578324960765, 1.0]], [1, [28.330245473977627, 1.0]], [1, [0.2306792273313024, 1.0]], [1, [0.5918842835099003, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.2724343]
bas 3, expnt(s) = [235.7217429]
bas 4, expnt(s) = [76.48096689]
bas 5, expnt(s) = [10.12207881]
bas 6, expnt(s) = [27.14654646]
bas 7, expnt(s) = [0.39027893]
bas 8, expnt(s) = [3.00809386]
bas 9, expnt(s) = [1.15959657]
bas 10, expnt(s) = [1.82264358]
bas 11, expnt(s) = [6.24775783]
bas 12, expnt(s) = [28.33024547]
bas 13, expnt(s) = [0.23067923]
bas 14, expnt(s) = [0.59188428]
CPU time:        21.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809669e+01 6.53401386e+01 1.01220788e+01 1.43372979e+01
 2.71465465e+01 3.00469895e+01 3.90278934e-01 1.24751667e+00
 3.00809386e+00 5.77076730e+00 1.15959657e+00 2.82322321e+00
 1.82264358e+00 6.17819456e+00 6.24775783e+00 2.88163936e+01
 2.83302455e+01 1.90676563e+02 2.30679227e-01 4.66385460e-01
 5.91884284e-01 1.51453880e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999251426830693
cond(S) = 359.7459736003662
E1 = -183.54669439394837  E_coul = 55.07191633229858
init E= -128.47477806165
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770854884072019  LUMO = 0.652061735292122
  mo_energy =
[-3.25570909e+01 -1.85316401e+00 -7.70854884e-01 -7.70854884e-01
 -7.70854884e-01  6.52061735e-01  6.52061735e-01  6.52061735e-01
  1.27134190e+00  2.88928069e+00  2.88928069e+00  2.88928069e+00
  7.72568747e+00  1.10071404e+01  1.10071404e+01  1.10071404e+01
  3.56522891e+01  5.42027448e+01  5.42027448e+01  5.42027448e+01
  1.40177739e+02  5.04451833e+02  1.87204060e+03  8.00156525e+03
  4.77690147e+04]
E1 = -181.94989548757806  E_coul = 53.443961269706236
cycle= 1 E= -128.505934217872  delta_E= -0.0312  |g|= 0.219  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508942
diis-c [-0.2590222  1.       ]
  HOMO = -0.885158589248412  LUMO = 0.633231727337196
  mo_energy =
[-3.29045425e+01 -1.97400477e+00 -8.85158589e-01 -8.85158589e-01
 -8.85158589e-01  6.33231727e-01  6.33231727e-01  6.33231727e-01
  1.22170244e+00  2.81088606e+00  2.81088606e+00  2.81088606e+00
  7.58219778e+00  1.08190394e+01  1.08190394e+01  1.08190394e+01
  3.53876547e+01  5.38874175e+01  5.38874175e+01  5.38874175e+01
  1.39836139e+02  5.04063155e+02  1.87161496e+03  8.00111040e+03
  4.77685410e+04]
E1 = -182.76520538656848  E_coul = 54.256300119434606
cycle= 2 E= -128.508905267134  delta_E= -0.00297  |g|= 0.11  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260454
diis-c [-5.67674520e-04  3.37822442e-01  6.62177558e-01]
  HOMO = -0.847054447799347  LUMO = 0.639676686847307
  mo_energy =
[-3.27893734e+01 -1.93384736e+00 -8.47054448e-01 -8.47054448e-01
 -8.47054448e-01  6.39676687e-01  6.39676687e-01  6.39676687e-01
  1.23811082e+00  2.83688755e+00  2.83688755e+00  2.83688755e+00
  7.62968849e+00  1.08818908e+01  1.08818908e+01  1.08818908e+01
  3.54762311e+01  5.39923468e+01  5.39923468e+01  5.39923468e+01
  1.39949197e+02  5.04187720e+02  1.87174522e+03  8.00124336e+03
  4.77686750e+04]
E1 = -182.49178107390267  E_coul = 53.981832904437034
cycle= 3 E= -128.509948169466  delta_E= -0.00104  |g|= 0.000264  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00048771
diis-c [-6.00037436e-08 -1.71434959e-03 -4.88086837e-03  1.00659522e+00]
  HOMO = -0.847050024336874  LUMO = 0.639719916446334
  mo_energy =
[-3.27892869e+01 -1.93382741e+00 -8.47050024e-01 -8.47050024e-01
 -8.47050024e-01  6.39719916e-01  6.39719916e-01  6.39719916e-01
  1.23816847e+00  2.83696254e+00  2.83696254e+00  2.83696254e+00
  7.62974749e+00  1.08819843e+01  1.08819843e+01  1.08819843e+01
  3.54763125e+01  5.39924370e+01  5.39924370e+01  5.39924370e+01
  1.39949295e+02  5.04187832e+02  1.87174533e+03  8.00124345e+03
  4.77686750e+04]
E1 = -182.49126353276887  E_coul = 53.98131535715993
cycle= 4 E= -128.509948175609  delta_E= -6.14e-09  |g|= 2.38e-05  |ddm|= 0.000151
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.27152e-05
diis-c [-2.39684788e-10 -3.16120287e-05  1.15685051e-04 -4.79295413e-02
  1.04784547e+00]
  HOMO = -0.847057161949635  LUMO = 0.639719036235098
  mo_energy =
[-3.27892970e+01 -1.93383597e+00 -8.47057162e-01 -8.47057162e-01
 -8.47057162e-01  6.39719036e-01  6.39719036e-01  6.39719036e-01
  1.23816486e+00  2.83695768e+00  2.83695768e+00  2.83695768e+00
  7.62973639e+00  1.08819747e+01  1.08819747e+01  1.08819747e+01
  3.54762998e+01  5.39924262e+01  5.39924262e+01  5.39924262e+01
  1.39949286e+02  5.04187829e+02  1.87174533e+03  8.00124346e+03
  4.77686750e+04]
E1 = -182.4913030749724  E_coul = 53.98135489932296
cycle= 5 E= -128.509948175649  delta_E= -4.05e-11  |g|= 2.1e-06  |ddm|= 1.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4913030749724  E_coul = 53.98135489932296
  HOMO = -0.847055945746208  LUMO = 0.639719296059572
  mo_energy =
[-3.27892941e+01 -1.93383472e+00 -8.47055946e-01 -8.47055946e-01
 -8.47055946e-01  6.39719296e-01  6.39719296e-01  6.39719296e-01
  1.23816550e+00  2.83695859e+00  2.83695859e+00  2.83695859e+00
  7.62973779e+00  1.08819766e+01  1.08819766e+01  1.08819766e+01
  3.54763022e+01  5.39924289e+01  5.39924289e+01  5.39924289e+01
  1.39949289e+02  5.04187832e+02  1.87174533e+03  8.00124346e+03
  4.77686750e+04]
E1 = -182.49129687205846  E_coul = 53.981348696408844
Extra cycle  E= -128.50994817565  delta_E= -1.71e-13  |g|= 8.85e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809669e+01 1.01220788e+01 2.71465465e+01 3.90278934e-01
 3.00809386e+00 1.15959657e+00 1.82264358e+00 6.24775783e+00
 2.83302455e+01 2.30679227e-01 5.91884284e-01]
E = -128.5099481756496
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434295        1
[INPUT] 0    0    [1    /1   ]  235.721742899        1
[INPUT] 0    0    [1    /1   ]  76.4809668886        1
[INPUT] 0    0    [1    /1   ]  10.1220788121        1
[INPUT] 0    0    [1    /1   ]  27.1465464554        1
[INPUT] 0    0    [1    /1   ]  0.390278933585       1
[INPUT] 0    0    [1    /1   ]  3.00809386446        1
[INPUT] 0    0    [1    /1   ]  1.15959657017        1
[INPUT] 1    0    [1    /1   ]  1.82264358176        1
[INPUT] 1    0    [1    /1   ]  6.2477578325         1
[INPUT] 1    0    [1    /1   ]  28.330245474         1
[INPUT] 1    0    [1    /1   ]  0.230679227331       1
[INPUT] 1    0    [1    /1   ]  0.59188428351        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068215, 1.0]], [0, [833.2724342953237, 1.0]], [0, [235.72174289904427, 1.0]], [0, [76.48096688859822, 1.0]], [0, [10.122078812094822, 1.0]], [0, [27.146546455378363, 1.0]], [0, [0.3902789335854954, 1.0]], [0, [3.008093864457602, 1.0]], [0, [1.1595965701689446, 1.0]], [1, [1.8226435817638735, 1.0]], [1, [6.2477578324960765, 1.0]], [1, [28.330245473977627, 1.0]], [1, [0.2306792273313024, 1.0]], [1, [0.5918842835099003, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.2724343]
bas 3, expnt(s) = [235.7217429]
bas 4, expnt(s) = [76.48096689]
bas 5, expnt(s) = [10.12207881]
bas 6, expnt(s) = [27.14654646]
bas 7, expnt(s) = [0.39027893]
bas 8, expnt(s) = [3.00809386]
bas 9, expnt(s) = [1.15959657]
bas 10, expnt(s) = [1.82264358]
bas 11, expnt(s) = [6.24775783]
bas 12, expnt(s) = [28.33024547]
bas 13, expnt(s) = [0.23067923]
bas 14, expnt(s) = [0.59188428]
CPU time:        21.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809669e+01 6.53401386e+01 1.01220788e+01 1.43372979e+01
 2.71465465e+01 3.00469895e+01 3.90278934e-01 1.24751667e+00
 3.00809386e+00 5.77076730e+00 1.15959657e+00 2.82322321e+00
 1.82264358e+00 6.17819456e+00 6.24775783e+00 2.88163936e+01
 2.83302455e+01 1.90676563e+02 2.30679227e-01 4.66385460e-01
 5.91884284e-01 1.51453880e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999251426830693
cond(S) = 359.7459736003662
E1 = -183.54669439394837  E_coul = 55.07191633229858
init E= -128.47477806165
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770854884072019  LUMO = 0.652061735292122
  mo_energy =
[-3.25570909e+01 -1.85316401e+00 -7.70854884e-01 -7.70854884e-01
 -7.70854884e-01  6.52061735e-01  6.52061735e-01  6.52061735e-01
  1.27134190e+00  2.88928069e+00  2.88928069e+00  2.88928069e+00
  7.72568747e+00  1.10071404e+01  1.10071404e+01  1.10071404e+01
  3.56522891e+01  5.42027448e+01  5.42027448e+01  5.42027448e+01
  1.40177739e+02  5.04451833e+02  1.87204060e+03  8.00156525e+03
  4.77690147e+04]
E1 = -181.94989548757806  E_coul = 53.443961269706236
cycle= 1 E= -128.505934217872  delta_E= -0.0312  |g|= 0.219  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.508942
diis-c [-0.2590222  1.       ]
  HOMO = -0.885158589248412  LUMO = 0.633231727337196
  mo_energy =
[-3.29045425e+01 -1.97400477e+00 -8.85158589e-01 -8.85158589e-01
 -8.85158589e-01  6.33231727e-01  6.33231727e-01  6.33231727e-01
  1.22170244e+00  2.81088606e+00  2.81088606e+00  2.81088606e+00
  7.58219778e+00  1.08190394e+01  1.08190394e+01  1.08190394e+01
  3.53876547e+01  5.38874175e+01  5.38874175e+01  5.38874175e+01
  1.39836139e+02  5.04063155e+02  1.87161496e+03  8.00111040e+03
  4.77685410e+04]
E1 = -182.76520538656848  E_coul = 54.256300119434606
cycle= 2 E= -128.508905267134  delta_E= -0.00297  |g|= 0.11  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260454
diis-c [-5.67674520e-04  3.37822442e-01  6.62177558e-01]
  HOMO = -0.847054447799347  LUMO = 0.639676686847307
  mo_energy =
[-3.27893734e+01 -1.93384736e+00 -8.47054448e-01 -8.47054448e-01
 -8.47054448e-01  6.39676687e-01  6.39676687e-01  6.39676687e-01
  1.23811082e+00  2.83688755e+00  2.83688755e+00  2.83688755e+00
  7.62968849e+00  1.08818908e+01  1.08818908e+01  1.08818908e+01
  3.54762311e+01  5.39923468e+01  5.39923468e+01  5.39923468e+01
  1.39949197e+02  5.04187720e+02  1.87174522e+03  8.00124336e+03
  4.77686750e+04]
E1 = -182.49178107390267  E_coul = 53.981832904437034
cycle= 3 E= -128.509948169466  delta_E= -0.00104  |g|= 0.000264  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00048771
diis-c [-6.00037436e-08 -1.71434959e-03 -4.88086837e-03  1.00659522e+00]
  HOMO = -0.847050024336874  LUMO = 0.639719916446334
  mo_energy =
[-3.27892869e+01 -1.93382741e+00 -8.47050024e-01 -8.47050024e-01
 -8.47050024e-01  6.39719916e-01  6.39719916e-01  6.39719916e-01
  1.23816847e+00  2.83696254e+00  2.83696254e+00  2.83696254e+00
  7.62974749e+00  1.08819843e+01  1.08819843e+01  1.08819843e+01
  3.54763125e+01  5.39924370e+01  5.39924370e+01  5.39924370e+01
  1.39949295e+02  5.04187832e+02  1.87174533e+03  8.00124345e+03
  4.77686750e+04]
E1 = -182.49126353276887  E_coul = 53.98131535715993
cycle= 4 E= -128.509948175609  delta_E= -6.14e-09  |g|= 2.38e-05  |ddm|= 0.000151
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.27152e-05
diis-c [-2.39684788e-10 -3.16120287e-05  1.15685051e-04 -4.79295413e-02
  1.04784547e+00]
  HOMO = -0.847057161949635  LUMO = 0.639719036235098
  mo_energy =
[-3.27892970e+01 -1.93383597e+00 -8.47057162e-01 -8.47057162e-01
 -8.47057162e-01  6.39719036e-01  6.39719036e-01  6.39719036e-01
  1.23816486e+00  2.83695768e+00  2.83695768e+00  2.83695768e+00
  7.62973639e+00  1.08819747e+01  1.08819747e+01  1.08819747e+01
  3.54762998e+01  5.39924262e+01  5.39924262e+01  5.39924262e+01
  1.39949286e+02  5.04187829e+02  1.87174533e+03  8.00124346e+03
  4.77686750e+04]
E1 = -182.4913030749724  E_coul = 53.98135489932296
cycle= 5 E= -128.509948175649  delta_E= -4.05e-11  |g|= 2.1e-06  |ddm|= 1.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4913030749724  E_coul = 53.98135489932296
  HOMO = -0.847055945746208  LUMO = 0.639719296059572
  mo_energy =
[-3.27892941e+01 -1.93383472e+00 -8.47055946e-01 -8.47055946e-01
 -8.47055946e-01  6.39719296e-01  6.39719296e-01  6.39719296e-01
  1.23816550e+00  2.83695859e+00  2.83695859e+00  2.83695859e+00
  7.62973779e+00  1.08819766e+01  1.08819766e+01  1.08819766e+01
  3.54763022e+01  5.39924289e+01  5.39924289e+01  5.39924289e+01
  1.39949289e+02  5.04187832e+02  1.87174533e+03  8.00124346e+03
  4.77686750e+04]
E1 = -182.49129687205846  E_coul = 53.981348696408844
Extra cycle  E= -128.50994817565  delta_E= -1.71e-13  |g|= 8.85e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 359.7459736003662
E1 = -182.49129687205846  E_coul = 53.981348696408844
init E= -128.50994817565
    CPU time for initialize scf      0.19 sec, wall time      0.18 sec
  HOMO = -0.84705637221792  LUMO = 0.639719232849158
  mo_energy =
[-3.27892955e+01 -1.93383517e+00 -8.47056372e-01 -8.47056372e-01
 -8.47056372e-01  6.39719233e-01  6.39719233e-01  6.39719233e-01
  1.23816534e+00  2.83695831e+00  2.83695831e+00  2.83695831e+00
  7.62973725e+00  1.08819759e+01  1.08819759e+01  1.08819759e+01
  3.54763011e+01  5.39924276e+01  5.39924276e+01  5.39924276e+01
  1.39949288e+02  5.04187830e+02  1.87174533e+03  8.00124346e+03
  4.77686750e+04]
E1 = -182.49130032632758  E_coul = 53.98135215067784
cycle= 1 E= -128.50994817565  delta_E= -1.14e-13  |g|= 4.64e-07  |ddm|= 3.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.49130032632758  E_coul = 53.98135215067784
  HOMO = -0.847056126409159  LUMO = 0.639719275623492
  mo_energy =
[-3.27892947e+01 -1.93383491e+00 -8.47056126e-01 -8.47056126e-01
 -8.47056126e-01  6.39719276e-01  6.39719276e-01  6.39719276e-01
  1.23816545e+00  2.83695848e+00  2.83695848e+00  2.83695848e+00
  7.62973756e+00  1.08819763e+01  1.08819763e+01  1.08819763e+01
  3.54763017e+01  5.39924283e+01  5.39924283e+01  5.39924283e+01
  1.39949289e+02  5.04187831e+02  1.87174533e+03  8.00124346e+03
  4.77686750e+04]
E1 = -182.4912986076645  E_coul = 53.98135043201428
Extra cycle  E= -128.50994817565  delta_E= -4.83e-13  |g|= 2.34e-07  |ddm|= 1.53e-07
    CPU time for scf_cycle      0.24 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809669e+01 1.01220788e+01 2.71465465e+01 3.90278934e-01
 3.00809386e+00 1.15959657e+00 1.82264358e+00 6.24775783e+00
 2.83302455e+01 2.30679227e-01 5.91884284e-01]
grad_E = [-4.50383283e-12  3.13158245e-10 -6.27946981e-09  7.60095384e-08
 -6.22809069e-07 -1.36510692e-05  3.56036825e-06 -1.13252557e-03
 -5.61150872e-05  6.72409778e-04 -7.16970434e-03 -8.38651328e-03
  5.04950552e-04  4.80036385e-02 -3.23434997e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434312        1
[INPUT] 0    0    [1    /1   ]  235.721742702        1
[INPUT] 0    0    [1    /1   ]  76.4809685238        1
[INPUT] 0    0    [1    /1   ]  10.1221172689        1
[INPUT] 0    0    [1    /1   ]  27.146536795         1
[INPUT] 0    0    [1    /1   ]  0.393015491957       1
[INPUT] 0    0    [1    /1   ]  3.0082497428         1
[INPUT] 0    0    [1    /1   ]  1.15781657284        1
[INPUT] 1    0    [1    /1   ]  1.88298574645        1
[INPUT] 1    0    [1    /1   ]  6.26285240551        1
[INPUT] 1    0    [1    /1   ]  28.3292085482        1
[INPUT] 1    0    [1    /1   ]  0.118892379626       1
[INPUT] 1    0    [1    /1   ]  0.642760363525       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.454398067406, 1.0]], [0, [833.2724343115174, 1.0]], [0, [235.72174270249084, 1.0]], [0, [76.48096852381732, 1.0]], [0, [10.122117268933863, 1.0]], [0, [27.14653679501051, 1.0]], [0, [0.39301549195737717, 1.0]], [0, [3.0082497428047863, 1.0]], [0, [1.1578165728426983, 1.0]], [1, [1.8829857464457092, 1.0]], [1, [6.262852405511367, 1.0]], [1, [28.329208548190582, 1.0]], [1, [0.11889237962585132, 1.0]], [1, [0.6427603635247529, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243431]
bas 3, expnt(s) = [235.7217427]
bas 4, expnt(s) = [76.48096852]
bas 5, expnt(s) = [10.12211727]
bas 6, expnt(s) = [27.1465368]
bas 7, expnt(s) = [0.39301549]
bas 8, expnt(s) = [3.00824974]
bas 9, expnt(s) = [1.15781657]
bas 10, expnt(s) = [1.88298575]
bas 11, expnt(s) = [6.26285241]
bas 12, expnt(s) = [28.32920855]
bas 13, expnt(s) = [0.11889238]
bas 14, expnt(s) = [0.64276036]
CPU time:        23.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809685e+01 6.53401397e+01 1.01221173e+01 1.43373388e+01
 2.71465368e+01 3.00469814e+01 3.93015492e-01 1.25407144e+00
 3.00824974e+00 5.77099158e+00 1.15781657e+00 2.81997232e+00
 1.88298575e+00 6.43492046e+00 6.26285241e+00 2.89034453e+01
 2.83292085e+01 1.90667839e+02 1.18892380e-01 2.03669931e-01
 6.42760364e-01 1.67898089e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.991469298778297
cond(S) = 360.22662550258633
E1 = -183.50088110209774  E_coul = 55.0584092496681
init E= -128.44247185243
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.768523962631916  LUMO = 0.355780676524055
  mo_energy =
[-3.25571679e+01 -1.85503270e+00 -7.68523963e-01 -7.68523963e-01
 -7.68523963e-01  3.55780677e-01  3.55780677e-01  3.55780677e-01
  1.27792194e+00  2.63044556e+00  2.63044556e+00  2.63044556e+00
  7.72922926e+00  1.10148689e+01  1.10148689e+01  1.10148689e+01
  3.56557716e+01  5.43397917e+01  5.43397917e+01  5.43397917e+01
  1.40181386e+02  5.04453831e+02  1.87204136e+03  8.00156536e+03
  4.77690143e+04]
E1 = -182.12442361513632  E_coul = 53.638079678072096
cycle= 1 E= -128.486343937064  delta_E= -0.0439  |g|= 0.192  |ddm|= 0.188
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.409754
diis-c [-0.16789852  1.        ]
  HOMO = -0.86726206024915  LUMO = 0.347324599901437
  mo_energy =
[-3.28668447e+01 -1.95775900e+00 -8.67262060e-01 -8.67262060e-01
 -8.67262060e-01  3.47324600e-01  3.47324600e-01  3.47324600e-01
  1.23521522e+00  2.55809567e+00  2.55809567e+00  2.55809567e+00
  7.60677818e+00  1.08494452e+01  1.08494452e+01  1.08494452e+01
  3.54234516e+01  5.40593161e+01  5.40593161e+01  5.40593161e+01
  1.39877170e+02  5.04105825e+02  1.87165786e+03  8.00115310e+03
  4.77685832e+04]
E1 = -182.81193629905593  E_coul = 54.32330626325769
cycle= 2 E= -128.488630035798  delta_E= -0.00229  |g|= 0.0931  |ddm|= 0.069
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.204623
diis-c [-0.00070789  0.3316341   0.6683659 ]
  HOMO = -0.834899207948303  LUMO = 0.350456054445805
  mo_energy =
[-3.27684106e+01 -1.92380161e+00 -8.34899208e-01 -8.34899208e-01
 -8.34899208e-01  3.50456054e-01  3.50456054e-01  3.50456054e-01
  1.24888499e+00  2.58129764e+00  2.58129764e+00  2.58129764e+00
  7.64709358e+00  1.09036415e+01  1.09036415e+01  1.09036415e+01
  3.54989984e+01  5.41489405e+01  5.41489405e+01  5.41489405e+01
  1.39973816e+02  5.04212417e+02  1.87176938e+03  8.00126694e+03
  4.77686980e+04]
E1 = -182.57101211988643  E_coul = 54.081621251743336
cycle= 3 E= -128.489390868143  delta_E= -0.000761  |g|= 0.00205  |ddm|= 0.0227
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00302347
diis-c [-3.64403701e-06 -1.16535318e-02 -1.20697330e-02  1.02372326e+00]
  HOMO = -0.835934254103249  LUMO = 0.35024831089588
  mo_energy =
[-3.27700179e+01 -1.92493152e+00 -8.35934254e-01 -8.35934254e-01
 -8.35934254e-01  3.50248311e-01  3.50248311e-01  3.50248311e-01
  1.24810447e+00  2.58035096e+00  2.58035096e+00  2.58035096e+00
  7.64589918e+00  1.09023190e+01  1.09023190e+01  1.09023190e+01
  3.54975221e+01  5.41473839e+01  5.41473839e+01  5.41473839e+01
  1.39972246e+02  5.04210825e+02  1.87176776e+03  8.00126530e+03
  4.77686963e+04]
E1 = -182.57166046485227  E_coul = 54.0822687862304
cycle= 4 E= -128.489391678622  delta_E= -8.1e-07  |g|= 0.000275  |ddm|= 0.00138
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000381663
diis-c [-1.24100986e-08  5.42120038e-04  1.36868859e-04 -1.86784593e-01
  1.18610560e+00]
  HOMO = -0.836088549670743  LUMO = 0.350212019448713
  mo_energy =
[-3.27702155e+01 -1.92512405e+00 -8.36088550e-01 -8.36088550e-01
 -8.36088550e-01  3.50212019e-01  3.50212019e-01  3.50212019e-01
  1.24796024e+00  2.58019141e+00  2.58019141e+00  2.58019141e+00
  7.64570310e+00  1.09021175e+01  1.09021175e+01  1.09021175e+01
  3.54973163e+01  5.41471825e+01  5.41471825e+01  5.41471825e+01
  1.39972048e+02  5.04210636e+02  1.87176758e+03  8.00126512e+03
  4.77686961e+04]
E1 = -182.5716176050822  E_coul = 54.08222590813643
cycle= 5 E= -128.489391696946  delta_E= -1.83e-08  |g|= 1.5e-05  |ddm|= 0.000249
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.77038e-05
diis-c [-1.29942786e-10 -9.16022231e-05 -9.72972833e-05  3.73923740e-02
 -2.43321771e-01  1.20611830e+00]
  HOMO = -0.836085219608731  LUMO = 0.350212381547572
  mo_energy =
[-3.27702097e+01 -1.92512538e+00 -8.36085220e-01 -8.36085220e-01
 -8.36085220e-01  3.50212382e-01  3.50212382e-01  3.50212382e-01
  1.24795947e+00  2.58019383e+00  2.58019383e+00  2.58019383e+00
  7.64570454e+00  1.09021212e+01  1.09021212e+01  1.09021212e+01
  3.54973203e+01  5.41471875e+01  5.41471875e+01  5.41471875e+01
  1.39972054e+02  5.04210643e+02  1.87176759e+03  8.00126513e+03
  4.77686961e+04]
E1 = -182.57160309142793  E_coul = 54.082211394441416
cycle= 6 E= -128.489391696987  delta_E= -4.07e-11  |g|= 7.83e-07  |ddm|= 1.23e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.57160309142793  E_coul = 54.082211394441416
  HOMO = -0.836085102564209  LUMO = 0.35021238260537
  mo_energy =
[-3.27702094e+01 -1.92512543e+00 -8.36085103e-01 -8.36085103e-01
 -8.36085103e-01  3.50212383e-01  3.50212383e-01  3.50212383e-01
  1.24795942e+00  2.58019389e+00  2.58019389e+00  2.58019389e+00
  7.64570456e+00  1.09021214e+01  1.09021214e+01  1.09021214e+01
  3.54973204e+01  5.41471878e+01  5.41471878e+01  5.41471878e+01
  1.39972054e+02  5.04210644e+02  1.87176759e+03  8.00126513e+03
  4.77686961e+04]
E1 = -182.5716022574327  E_coul = 54.08221056044598
Extra cycle  E= -128.489391696987  delta_E= -1.99e-13  |g|= 1.81e-07  |ddm|= 3.07e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809685e+01 1.01221173e+01 2.71465368e+01 3.93015492e-01
 3.00824974e+00 1.15781657e+00 1.88298575e+00 6.26285241e+00
 2.83292085e+01 1.18892380e-01 6.42760364e-01]
E = -128.4893916969867
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434298        1
[INPUT] 0    0    [1    /1   ]  235.721742873        1
[INPUT] 0    0    [1    /1   ]  76.4809671088        1
[INPUT] 0    0    [1    /1   ]  10.1220839901        1
[INPUT] 0    0    [1    /1   ]  27.1465451547        1
[INPUT] 0    0    [1    /1   ]  0.390647398253       1
[INPUT] 0    0    [1    /1   ]  3.00811485274        1
[INPUT] 0    0    [1    /1   ]  1.15935690193        1
[INPUT] 1    0    [1    /1   ]  1.83076836941        1
[INPUT] 1    0    [1    /1   ]  6.2497902455         1
[INPUT] 1    0    [1    /1   ]  28.3301058568        1
[INPUT] 1    0    [1    /1   ]  0.215627655949       1
[INPUT] 1    0    [1    /1   ]  0.598734507536       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068106, 1.0]], [0, [833.2724342975041, 1.0]], [0, [235.72174287257928, 1.0]], [0, [76.48096710877275, 1.0]], [0, [10.122083990126672, 1.0]], [0, [27.14654515465543, 1.0]], [0, [0.390647398253042, 1.0]], [0, [3.0081148527412664, 1.0]], [0, [1.15935690193099, 1.0]], [1, [1.8307683694084531, 1.0]], [1, [6.249790245502496, 1.0]], [1, [28.330105856814946, 1.0]], [1, [0.21562765594912506, 1.0]], [1, [0.5987345075363139, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.2724343]
bas 3, expnt(s) = [235.72174287]
bas 4, expnt(s) = [76.48096711]
bas 5, expnt(s) = [10.12208399]
bas 6, expnt(s) = [27.14654515]
bas 7, expnt(s) = [0.3906474]
bas 8, expnt(s) = [3.00811485]
bas 9, expnt(s) = [1.1593569]
bas 10, expnt(s) = [1.83076837]
bas 11, expnt(s) = [6.24979025]
bas 12, expnt(s) = [28.33010586]
bas 13, expnt(s) = [0.21562766]
bas 14, expnt(s) = [0.59873451]
CPU time:        24.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809671e+01 6.53401388e+01 1.01220840e+01 1.43373034e+01
 2.71465452e+01 3.00469884e+01 3.90647398e-01 1.24839990e+00
 3.00811485e+00 5.77079750e+00 1.15935690e+00 2.82278557e+00
 1.83076837e+00 6.21263935e+00 6.24979025e+00 2.88281116e+01
 2.83301059e+01 1.90675388e+02 2.15627656e-01 4.28661984e-01
 5.98734508e-01 1.53648121e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999522708982752
cond(S) = 359.810217207213
E1 = -183.5484838834466  E_coul = 55.07234117611018
init E= -128.476142707336
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.770984394556113  LUMO = 0.618035286488581
  mo_energy =
[-3.25569419e+01 -1.85314304e+00 -7.70984395e-01 -7.70984395e-01
 -7.70984395e-01  6.18035286e-01  6.18035286e-01  6.18035286e-01
  1.27243737e+00  2.85419099e+00  2.85419099e+00  2.85419099e+00
  7.72651638e+00  1.10049413e+01  1.10049413e+01  1.10049413e+01
  3.56529928e+01  5.42184457e+01  5.42184457e+01  5.42184457e+01
  1.40178410e+02  5.04452333e+02  1.87204097e+03  8.00156554e+03
  4.77690149e+04]
E1 = -181.93557427050732  E_coul = 53.42891742079414
cycle= 1 E= -128.506656849713  delta_E= -0.0305  |g|= 0.22  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50832
diis-c [-0.25838945  1.        ]
  HOMO = -0.886495112156077  LUMO = 0.599562599574056
  mo_energy =
[-3.29070755e+01 -1.97539491e+00 -8.86495112e-01 -8.86495112e-01
 -8.86495112e-01  5.99562600e-01  5.99562600e-01  5.99562600e-01
  1.22174456e+00  2.77412024e+00  2.77412024e+00  2.77412024e+00
  7.58154087e+00  1.08146897e+01  1.08146897e+01  1.08146897e+01
  3.53861130e+01  5.39005269e+01  5.39005269e+01  5.39005269e+01
  1.39834197e+02  5.04061058e+02  1.87161279e+03  8.00110817e+03
  4.77685387e+04]
E1 = -182.7588557871187  E_coul = 54.24919288282538
cycle= 2 E= -128.509662904293  delta_E= -0.00301  |g|= 0.112  |ddm|= 0.0719
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261092
diis-c [-5.75784205e-04  3.38639453e-01  6.61360547e-01]
  HOMO = -0.848055143364615  LUMO = 0.605782912728858
  mo_energy =
[-3.27909707e+01 -1.93487597e+00 -8.48055143e-01 -8.48055143e-01
 -8.48055143e-01  6.05782913e-01  6.05782913e-01  6.05782913e-01
  1.23830686e+00  2.80051939e+00  2.80051939e+00  2.80051939e+00
  7.62945969e+00  1.08782109e+01  1.08782109e+01  1.08782109e+01
  3.54754369e+01  5.40063207e+01  5.40063207e+01  5.40063207e+01
  1.39948173e+02  5.04186614e+02  1.87174407e+03  8.00124217e+03
  4.77686737e+04]
E1 = -182.48135714084762  E_coul = 53.970626776404615
cycle= 3 E= -128.510730364443  delta_E= -0.00107  |g|= 0.000247  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000467973
diis-c [-9.59985598e-08 -1.86016856e-03 -4.84187259e-03  1.00670204e+00]
  HOMO = -0.848107596755913  LUMO = 0.605804030639855
  mo_energy =
[-3.27909662e+01 -1.93493118e+00 -8.48107597e-01 -8.48107597e-01
 -8.48107597e-01  6.05804031e-01  6.05804031e-01  6.05804031e-01
  1.23830750e+00  2.80053947e+00  2.80053947e+00  2.80053947e+00
  7.62944708e+00  1.08782306e+01  1.08782306e+01  1.08782306e+01
  3.54754394e+01  5.40063295e+01  5.40063295e+01  5.40063295e+01
  1.39948191e+02  5.04186646e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48078526186922  E_coul = 53.970054889041364
cycle= 4 E= -128.510730372828  delta_E= -8.38e-09  |g|= 4.12e-05  |ddm|= 0.000156
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.77105e-05
diis-c [-9.13112348e-10  3.67462705e-05  3.66406909e-04 -1.11741116e-01
  1.11133796e+00]
  HOMO = -0.848126551744335  LUMO = 0.60579924602405
  mo_energy =
[-3.27909918e+01 -1.93495711e+00 -8.48126552e-01 -8.48126552e-01
 -8.48126552e-01  6.05799246e-01  6.05799246e-01  6.05799246e-01
  1.23829148e+00  2.80052298e+00  2.80052298e+00  2.80052298e+00
  7.62941956e+00  1.08782052e+01  1.08782052e+01  1.08782052e+01
  3.54754098e+01  5.40063026e+01  5.40063026e+01  5.40063026e+01
  1.39948167e+02  5.04186630e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48082130621134  E_coul = 53.970090933206016
cycle= 5 E= -128.510730373005  delta_E= -1.77e-10  |g|= 3.72e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48082130621134  E_coul = 53.970090933206016
  HOMO = -0.848125138665843  LUMO = 0.605799379621849
  mo_energy =
[-3.27909880e+01 -1.93495633e+00 -8.48125139e-01 -8.48125139e-01
 -8.48125139e-01  6.05799380e-01  6.05799380e-01  6.05799380e-01
  1.23829155e+00  2.80052379e+00  2.80052379e+00  2.80052379e+00
  7.62942097e+00  1.08782074e+01  1.08782074e+01  1.08782074e+01
  3.54754128e+01  5.40063061e+01  5.40063061e+01  5.40063061e+01
  1.39948170e+02  5.04186634e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48080910601843  E_coul = 53.97007873301055
Extra cycle  E= -128.510730373008  delta_E= -2.56e-12  |g|= 1.77e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809671e+01 1.01220840e+01 2.71465452e+01 3.90647398e-01
 3.00811485e+00 1.15935690e+00 1.83076837e+00 6.24979025e+00
 2.83301059e+01 2.15627656e-01 5.98734508e-01]
E = -128.51073037300787
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434298        1
[INPUT] 0    0    [1    /1   ]  235.721742873        1
[INPUT] 0    0    [1    /1   ]  76.4809671088        1
[INPUT] 0    0    [1    /1   ]  10.1220839901        1
[INPUT] 0    0    [1    /1   ]  27.1465451547        1
[INPUT] 0    0    [1    /1   ]  0.390647398253       1
[INPUT] 0    0    [1    /1   ]  3.00811485274        1
[INPUT] 0    0    [1    /1   ]  1.15935690193        1
[INPUT] 1    0    [1    /1   ]  1.83076836941        1
[INPUT] 1    0    [1    /1   ]  6.2497902455         1
[INPUT] 1    0    [1    /1   ]  28.3301058568        1
[INPUT] 1    0    [1    /1   ]  0.215627655949       1
[INPUT] 1    0    [1    /1   ]  0.598734507536       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411723, 1.0]], [0, [3661.454398068106, 1.0]], [0, [833.2724342975041, 1.0]], [0, [235.72174287257928, 1.0]], [0, [76.48096710877275, 1.0]], [0, [10.122083990126672, 1.0]], [0, [27.14654515465543, 1.0]], [0, [0.390647398253042, 1.0]], [0, [3.0081148527412664, 1.0]], [0, [1.15935690193099, 1.0]], [1, [1.8307683694084531, 1.0]], [1, [6.249790245502496, 1.0]], [1, [28.330105856814946, 1.0]], [1, [0.21562765594912506, 1.0]], [1, [0.5987345075363139, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.2724343]
bas 3, expnt(s) = [235.72174287]
bas 4, expnt(s) = [76.48096711]
bas 5, expnt(s) = [10.12208399]
bas 6, expnt(s) = [27.14654515]
bas 7, expnt(s) = [0.3906474]
bas 8, expnt(s) = [3.00811485]
bas 9, expnt(s) = [1.1593569]
bas 10, expnt(s) = [1.83076837]
bas 11, expnt(s) = [6.24979025]
bas 12, expnt(s) = [28.33010586]
bas 13, expnt(s) = [0.21562766]
bas 14, expnt(s) = [0.59873451]
CPU time:        24.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809671e+01 6.53401388e+01 1.01220840e+01 1.43373034e+01
 2.71465452e+01 3.00469884e+01 3.90647398e-01 1.24839990e+00
 3.00811485e+00 5.77079750e+00 1.15935690e+00 2.82278557e+00
 1.83076837e+00 6.21263935e+00 6.24979025e+00 2.88281116e+01
 2.83301059e+01 1.90675388e+02 2.15627656e-01 4.28661984e-01
 5.98734508e-01 1.53648121e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999522708982752
cond(S) = 359.810217207213
E1 = -183.5484838834466  E_coul = 55.07234117611018
init E= -128.476142707336
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770984394556113  LUMO = 0.618035286488581
  mo_energy =
[-3.25569419e+01 -1.85314304e+00 -7.70984395e-01 -7.70984395e-01
 -7.70984395e-01  6.18035286e-01  6.18035286e-01  6.18035286e-01
  1.27243737e+00  2.85419099e+00  2.85419099e+00  2.85419099e+00
  7.72651638e+00  1.10049413e+01  1.10049413e+01  1.10049413e+01
  3.56529928e+01  5.42184457e+01  5.42184457e+01  5.42184457e+01
  1.40178410e+02  5.04452333e+02  1.87204097e+03  8.00156554e+03
  4.77690149e+04]
E1 = -181.93557427050732  E_coul = 53.42891742079414
cycle= 1 E= -128.506656849713  delta_E= -0.0305  |g|= 0.22  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50832
diis-c [-0.25838945  1.        ]
  HOMO = -0.886495112156077  LUMO = 0.599562599574056
  mo_energy =
[-3.29070755e+01 -1.97539491e+00 -8.86495112e-01 -8.86495112e-01
 -8.86495112e-01  5.99562600e-01  5.99562600e-01  5.99562600e-01
  1.22174456e+00  2.77412024e+00  2.77412024e+00  2.77412024e+00
  7.58154087e+00  1.08146897e+01  1.08146897e+01  1.08146897e+01
  3.53861130e+01  5.39005269e+01  5.39005269e+01  5.39005269e+01
  1.39834197e+02  5.04061058e+02  1.87161279e+03  8.00110817e+03
  4.77685387e+04]
E1 = -182.7588557871187  E_coul = 54.24919288282538
cycle= 2 E= -128.509662904293  delta_E= -0.00301  |g|= 0.112  |ddm|= 0.0719
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261092
diis-c [-5.75784205e-04  3.38639453e-01  6.61360547e-01]
  HOMO = -0.848055143364615  LUMO = 0.605782912728858
  mo_energy =
[-3.27909707e+01 -1.93487597e+00 -8.48055143e-01 -8.48055143e-01
 -8.48055143e-01  6.05782913e-01  6.05782913e-01  6.05782913e-01
  1.23830686e+00  2.80051939e+00  2.80051939e+00  2.80051939e+00
  7.62945969e+00  1.08782109e+01  1.08782109e+01  1.08782109e+01
  3.54754369e+01  5.40063207e+01  5.40063207e+01  5.40063207e+01
  1.39948173e+02  5.04186614e+02  1.87174407e+03  8.00124217e+03
  4.77686737e+04]
E1 = -182.48135714084762  E_coul = 53.970626776404615
cycle= 3 E= -128.510730364443  delta_E= -0.00107  |g|= 0.000247  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000467973
diis-c [-9.59985598e-08 -1.86016856e-03 -4.84187259e-03  1.00670204e+00]
  HOMO = -0.848107596755913  LUMO = 0.605804030639855
  mo_energy =
[-3.27909662e+01 -1.93493118e+00 -8.48107597e-01 -8.48107597e-01
 -8.48107597e-01  6.05804031e-01  6.05804031e-01  6.05804031e-01
  1.23830750e+00  2.80053947e+00  2.80053947e+00  2.80053947e+00
  7.62944708e+00  1.08782306e+01  1.08782306e+01  1.08782306e+01
  3.54754394e+01  5.40063295e+01  5.40063295e+01  5.40063295e+01
  1.39948191e+02  5.04186646e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48078526186922  E_coul = 53.970054889041364
cycle= 4 E= -128.510730372828  delta_E= -8.38e-09  |g|= 4.12e-05  |ddm|= 0.000156
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.77105e-05
diis-c [-9.13112348e-10  3.67462705e-05  3.66406909e-04 -1.11741116e-01
  1.11133796e+00]
  HOMO = -0.848126551744335  LUMO = 0.60579924602405
  mo_energy =
[-3.27909918e+01 -1.93495711e+00 -8.48126552e-01 -8.48126552e-01
 -8.48126552e-01  6.05799246e-01  6.05799246e-01  6.05799246e-01
  1.23829148e+00  2.80052298e+00  2.80052298e+00  2.80052298e+00
  7.62941956e+00  1.08782052e+01  1.08782052e+01  1.08782052e+01
  3.54754098e+01  5.40063026e+01  5.40063026e+01  5.40063026e+01
  1.39948167e+02  5.04186630e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48082130621134  E_coul = 53.970090933206016
cycle= 5 E= -128.510730373005  delta_E= -1.77e-10  |g|= 3.72e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48082130621134  E_coul = 53.970090933206016
  HOMO = -0.848125138665843  LUMO = 0.605799379621849
  mo_energy =
[-3.27909880e+01 -1.93495633e+00 -8.48125139e-01 -8.48125139e-01
 -8.48125139e-01  6.05799380e-01  6.05799380e-01  6.05799380e-01
  1.23829155e+00  2.80052379e+00  2.80052379e+00  2.80052379e+00
  7.62942097e+00  1.08782074e+01  1.08782074e+01  1.08782074e+01
  3.54754128e+01  5.40063061e+01  5.40063061e+01  5.40063061e+01
  1.39948170e+02  5.04186634e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48080910601843  E_coul = 53.97007873301055
Extra cycle  E= -128.510730373008  delta_E= -2.56e-12  |g|= 1.77e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 359.810217207213
E1 = -182.48080910601843  E_coul = 53.97007873301055
init E= -128.510730373008
    CPU time for initialize scf      0.19 sec, wall time      0.18 sec
  HOMO = -0.848125990134606  LUMO = 0.605799222212749
  mo_energy =
[-3.27909905e+01 -1.93495739e+00 -8.48125990e-01 -8.48125990e-01
 -8.48125990e-01  6.05799222e-01  6.05799222e-01  6.05799222e-01
  1.23829106e+00  2.80052317e+00  2.80052317e+00  2.80052317e+00
  7.62941983e+00  1.08782059e+01  1.08782059e+01  1.08782059e+01
  3.54754108e+01  5.40063038e+01  5.40063038e+01  5.40063038e+01
  1.39948168e+02  5.04186632e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.480814681112  E_coul = 53.97008430810379
cycle= 1 E= -128.510730373008  delta_E= -3.41e-13  |g|= 7.65e-07  |ddm|= 7.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.480814681112  E_coul = 53.97008430810379
  HOMO = -0.848125593023599  LUMO = 0.605799282597815
  mo_energy =
[-3.27909892e+01 -1.93495701e+00 -8.48125593e-01 -8.48125593e-01
 -8.48125593e-01  6.05799283e-01  6.05799283e-01  6.05799283e-01
  1.23829120e+00  2.80052344e+00  2.80052344e+00  2.80052344e+00
  7.62942030e+00  1.08782066e+01  1.08782066e+01  1.08782066e+01
  3.54754117e+01  5.40063049e+01  5.40063049e+01  5.40063049e+01
  1.39948169e+02  5.04186633e+02  1.87174410e+03  8.00124219e+03
  4.77686737e+04]
E1 = -182.48081167797622  E_coul = 53.97008130496816
Extra cycle  E= -128.510730373008  delta_E= 1.42e-13  |g|= 4.09e-07  |ddm|= 2.6e-07
    CPU time for scf_cycle      0.24 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809671e+01 1.01220840e+01 2.71465452e+01 3.90647398e-01
 3.00811485e+00 1.15935690e+00 1.83076837e+00 6.24979025e+00
 2.83301059e+01 2.15627656e-01 5.98734508e-01]
grad_E = [-3.57350066e-12  2.64128379e-10 -5.29061717e-09  6.38427809e-08
 -5.20206720e-07 -1.12237506e-05  2.92854661e-06 -6.98670337e-04
 -4.88982918e-05  5.80689621e-04 -1.45018009e-02 -7.62090841e-03
  4.77909466e-04  2.03970652e-02 -1.07276535e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434313        1
[INPUT] 0    0    [1    /1   ]  235.721742683        1
[INPUT] 0    0    [1    /1   ]  76.4809686681        1
[INPUT] 0    0    [1    /1   ]  10.1221180162        1
[INPUT] 0    0    [1    /1   ]  27.1465362119        1
[INPUT] 0    0    [1    /1   ]  0.390962992946       1
[INPUT] 0    0    [1    /1   ]  3.00824945515        1
[INPUT] 0    0    [1    /1   ]  1.15790967285        1
[INPUT] 1    0    [1    /1   ]  1.92379040622        1
[INPUT] 1    0    [1    /1   ]  6.26318117259        1
[INPUT] 1    0    [1    /1   ]  28.3290750379        1
[INPUT] 1    0    [1    /1   ]  0.201870731015       1
[INPUT] 1    0    [1    /1   ]  0.63602133198        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.45439806733, 1.0]], [0, [833.272434313075, 1.0]], [0, [235.72174268342036, 1.0]], [0, [76.48096866807195, 1.0]], [0, [10.12211801616749, 1.0]], [0, [27.146536211877127, 1.0]], [0, [0.3909629929464033, 1.0]], [0, [3.008249455147419, 1.0]], [0, [1.1579096728511413, 1.0]], [1, [1.9237904062246471, 1.0]], [1, [6.263181172587972, 1.0]], [1, [28.32907503791139, 1.0]], [1, [0.20187073101486203, 1.0]], [1, [0.63602133198019, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243431]
bas 3, expnt(s) = [235.72174268]
bas 4, expnt(s) = [76.48096867]
bas 5, expnt(s) = [10.12211802]
bas 6, expnt(s) = [27.14653621]
bas 7, expnt(s) = [0.39096299]
bas 8, expnt(s) = [3.00824946]
bas 9, expnt(s) = [1.15790967]
bas 10, expnt(s) = [1.92379041]
bas 11, expnt(s) = [6.26318117]
bas 12, expnt(s) = [28.32907504]
bas 13, expnt(s) = [0.20187073]
bas 14, expnt(s) = [0.63602133]
CPU time:        26.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809687e+01 6.53401398e+01 1.01221180e+01 1.43373396e+01
 2.71465362e+01 3.00469810e+01 3.90962993e-01 1.24915624e+00
 3.00824946e+00 5.77099116e+00 1.15790967e+00 2.82014238e+00
 1.92379041e+00 6.60969753e+00 6.26318117e+00 2.89053419e+01
 2.83290750e+01 1.90666716e+02 2.01870731e-01 3.94753589e-01
 6.36021332e-01 1.65700567e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999567749528207
cond(S) = 359.6424581660966
E1 = -183.54993979559563  E_coul = 55.07322932460438
init E= -128.476710470991
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.770977393189379  LUMO = 0.593540223188725
  mo_energy =
[-3.25570563e+01 -1.85299671e+00 -7.70977393e-01 -7.70977393e-01
 -7.70977393e-01  5.93540223e-01  5.93540223e-01  5.93540223e-01
  1.27267671e+00  2.94896299e+00  2.94896299e+00  2.94896299e+00
  7.72377275e+00  1.13608082e+01  1.13608082e+01  1.13608082e+01
  3.56487535e+01  5.46174916e+01  5.46174916e+01  5.46174916e+01
  1.40174437e+02  5.04448954e+02  1.87203808e+03  8.00156306e+03
  4.77690129e+04]
E1 = -181.92862507646424  E_coul = 53.42111215783199
cycle= 1 E= -128.507512918632  delta_E= -0.0308  |g|= 0.221  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503564
diis-c [-0.25357696  1.        ]
  HOMO = -0.887304817877365  LUMO = 0.574827134508499
  mo_energy =
[-3.29081872e+01 -1.97619441e+00 -8.87304818e-01 -8.87304818e-01
 -8.87304818e-01  5.74827135e-01  5.74827135e-01  5.74827135e-01
  1.22107366e+00  2.86375586e+00  2.86375586e+00  2.86375586e+00
  7.57783607e+00  1.11682555e+01  1.11682555e+01  1.11682555e+01
  3.53810259e+01  5.42990659e+01  5.42990659e+01  5.42990659e+01
  1.39829202e+02  5.04056371e+02  1.87160845e+03  8.00110421e+03
  4.77685352e+04]
E1 = -182.7543466667262  E_coul = 54.24383455314686
cycle= 2 E= -128.510512113579  delta_E= -0.003  |g|= 0.112  |ddm|= 0.0721
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259821
diis-c [-5.71850939e-04  3.39652189e-01  6.60347811e-01]
  HOMO = -0.848799695152762  LUMO = 0.581025318446807
  mo_energy =
[-3.27919494e+01 -1.93560824e+00 -8.48799695e-01 -8.48799695e-01
 -8.48799695e-01  5.81025318e-01  5.81025318e-01  5.81025318e-01
  1.23765178e+00  2.89157707e+00  2.89157707e+00  2.89157707e+00
  7.62582847e+00  1.12323609e+01  1.12323609e+01  1.12323609e+01
  3.54704778e+01  5.44048743e+01  5.44048743e+01  5.44048743e+01
  1.39943312e+02  5.04182069e+02  1.87173989e+03  8.00123837e+03
  4.77686704e+04]
E1 = -182.47405757132557  E_coul = 53.96246474087059
cycle= 3 E= -128.511592830455  delta_E= -0.00108  |g|= 0.000363  |ddm|= 0.0248
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000515341
diis-c [-2.09023592e-07 -2.39901478e-03 -5.26139983e-03  1.00766041e+00]
  HOMO = -0.848941304783296  LUMO = 0.581018682937459
  mo_energy =
[-3.27920550e+01 -1.93577336e+00 -8.48941305e-01 -8.48941305e-01
 -8.48941305e-01  5.81018683e-01  5.81018683e-01  5.81018683e-01
  1.23757321e+00  2.89151168e+00  2.89151168e+00  2.89151168e+00
  7.62570407e+00  1.12322656e+01  1.12322656e+01  1.12322656e+01
  3.54703617e+01  5.44047708e+01  5.44047708e+01  5.44047708e+01
  1.39943222e+02  5.04182010e+02  1.87173985e+03  8.00123833e+03
  4.77686703e+04]
E1 = -182.4734834155661  E_coul = 53.96189055934444
cycle= 4 E= -128.511592856222  delta_E= -2.58e-08  |g|= 7.23e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.68283e-05
diis-c [-1.79413723e-09  1.29783006e-04  6.03025541e-04 -1.71782963e-01
  1.17105015e+00]
  HOMO = -0.848976011410077  LUMO = 0.581008859235731
  mo_energy =
[-3.27921011e+01 -1.93582160e+00 -8.48976011e-01 -8.48976011e-01
 -8.48976011e-01  5.81008859e-01  5.81008859e-01  5.81008859e-01
  1.23754128e+00  2.89147873e+00  2.89147873e+00  2.89147873e+00
  7.62565497e+00  1.12322189e+01  1.12322189e+01  1.12322189e+01
  3.54703099e+01  5.44047227e+01  5.44047227e+01  5.44047227e+01
  1.39943178e+02  5.04181977e+02  1.87173983e+03  8.00123831e+03
  4.77686703e+04]
E1 = -182.47351810525123  E_coul = 53.96192524824257
cycle= 5 E= -128.511592857009  delta_E= -7.87e-10  |g|= 5.74e-06  |ddm|= 5.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47351810525123  E_coul = 53.96192524824257
  HOMO = -0.848973184371277  LUMO = 0.581009261808668
  mo_energy =
[-3.27920946e+01 -1.93581967e+00 -8.48973184e-01 -8.48973184e-01
 -8.48973184e-01  5.81009262e-01  5.81009262e-01  5.81009262e-01
  1.23754195e+00  2.89148070e+00  2.89148070e+00  2.89148070e+00
  7.62565800e+00  1.12322230e+01  1.12322230e+01  1.12322230e+01
  3.54703153e+01  5.44047288e+01  5.44047288e+01  5.44047288e+01
  1.39943184e+02  5.04181983e+02  1.87173984e+03  8.00123832e+03
  4.77686703e+04]
E1 = -182.47349956496677  E_coul = 53.96190670795359
Extra cycle  E= -128.511592857013  delta_E= -4.52e-12  |g|= 2.7e-06  |ddm|= 3.26e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809687e+01 1.01221180e+01 2.71465362e+01 3.90962993e-01
 3.00824946e+00 1.15790967e+00 1.92379041e+00 6.26318117e+00
 2.83290750e+01 2.01870731e-01 6.36021332e-01]
E = -128.51159285701317
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434313        1
[INPUT] 0    0    [1    /1   ]  235.721742683        1
[INPUT] 0    0    [1    /1   ]  76.4809686681        1
[INPUT] 0    0    [1    /1   ]  10.1221180162        1
[INPUT] 0    0    [1    /1   ]  27.1465362119        1
[INPUT] 0    0    [1    /1   ]  0.390962992946       1
[INPUT] 0    0    [1    /1   ]  3.00824945515        1
[INPUT] 0    0    [1    /1   ]  1.15790967285        1
[INPUT] 1    0    [1    /1   ]  1.92379040622        1
[INPUT] 1    0    [1    /1   ]  6.26318117259        1
[INPUT] 1    0    [1    /1   ]  28.3290750379        1
[INPUT] 1    0    [1    /1   ]  0.201870731015       1
[INPUT] 1    0    [1    /1   ]  0.63602133198        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.45439806733, 1.0]], [0, [833.272434313075, 1.0]], [0, [235.72174268342036, 1.0]], [0, [76.48096866807195, 1.0]], [0, [10.12211801616749, 1.0]], [0, [27.146536211877127, 1.0]], [0, [0.3909629929464033, 1.0]], [0, [3.008249455147419, 1.0]], [0, [1.1579096728511413, 1.0]], [1, [1.9237904062246471, 1.0]], [1, [6.263181172587972, 1.0]], [1, [28.32907503791139, 1.0]], [1, [0.20187073101486203, 1.0]], [1, [0.63602133198019, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243431]
bas 3, expnt(s) = [235.72174268]
bas 4, expnt(s) = [76.48096867]
bas 5, expnt(s) = [10.12211802]
bas 6, expnt(s) = [27.14653621]
bas 7, expnt(s) = [0.39096299]
bas 8, expnt(s) = [3.00824946]
bas 9, expnt(s) = [1.15790967]
bas 10, expnt(s) = [1.92379041]
bas 11, expnt(s) = [6.26318117]
bas 12, expnt(s) = [28.32907504]
bas 13, expnt(s) = [0.20187073]
bas 14, expnt(s) = [0.63602133]
CPU time:        26.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809687e+01 6.53401398e+01 1.01221180e+01 1.43373396e+01
 2.71465362e+01 3.00469810e+01 3.90962993e-01 1.24915624e+00
 3.00824946e+00 5.77099116e+00 1.15790967e+00 2.82014238e+00
 1.92379041e+00 6.60969753e+00 6.26318117e+00 2.89053419e+01
 2.83290750e+01 1.90666716e+02 2.01870731e-01 3.94753589e-01
 6.36021332e-01 1.65700567e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999567749528207
cond(S) = 359.6424581660966
E1 = -183.54993979559563  E_coul = 55.07322932460438
init E= -128.476710470991
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.770977393189379  LUMO = 0.593540223188725
  mo_energy =
[-3.25570563e+01 -1.85299671e+00 -7.70977393e-01 -7.70977393e-01
 -7.70977393e-01  5.93540223e-01  5.93540223e-01  5.93540223e-01
  1.27267671e+00  2.94896299e+00  2.94896299e+00  2.94896299e+00
  7.72377275e+00  1.13608082e+01  1.13608082e+01  1.13608082e+01
  3.56487535e+01  5.46174916e+01  5.46174916e+01  5.46174916e+01
  1.40174437e+02  5.04448954e+02  1.87203808e+03  8.00156306e+03
  4.77690129e+04]
E1 = -181.92862507646424  E_coul = 53.42111215783199
cycle= 1 E= -128.507512918632  delta_E= -0.0308  |g|= 0.221  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503564
diis-c [-0.25357696  1.        ]
  HOMO = -0.887304817877365  LUMO = 0.574827134508499
  mo_energy =
[-3.29081872e+01 -1.97619441e+00 -8.87304818e-01 -8.87304818e-01
 -8.87304818e-01  5.74827135e-01  5.74827135e-01  5.74827135e-01
  1.22107366e+00  2.86375586e+00  2.86375586e+00  2.86375586e+00
  7.57783607e+00  1.11682555e+01  1.11682555e+01  1.11682555e+01
  3.53810259e+01  5.42990659e+01  5.42990659e+01  5.42990659e+01
  1.39829202e+02  5.04056371e+02  1.87160845e+03  8.00110421e+03
  4.77685352e+04]
E1 = -182.7543466667262  E_coul = 54.24383455314686
cycle= 2 E= -128.510512113579  delta_E= -0.003  |g|= 0.112  |ddm|= 0.0721
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259821
diis-c [-5.71850939e-04  3.39652189e-01  6.60347811e-01]
  HOMO = -0.848799695152762  LUMO = 0.581025318446807
  mo_energy =
[-3.27919494e+01 -1.93560824e+00 -8.48799695e-01 -8.48799695e-01
 -8.48799695e-01  5.81025318e-01  5.81025318e-01  5.81025318e-01
  1.23765178e+00  2.89157707e+00  2.89157707e+00  2.89157707e+00
  7.62582847e+00  1.12323609e+01  1.12323609e+01  1.12323609e+01
  3.54704778e+01  5.44048743e+01  5.44048743e+01  5.44048743e+01
  1.39943312e+02  5.04182069e+02  1.87173989e+03  8.00123837e+03
  4.77686704e+04]
E1 = -182.47405757132557  E_coul = 53.96246474087059
cycle= 3 E= -128.511592830455  delta_E= -0.00108  |g|= 0.000363  |ddm|= 0.0248
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000515341
diis-c [-2.09023592e-07 -2.39901478e-03 -5.26139983e-03  1.00766041e+00]
  HOMO = -0.848941304783296  LUMO = 0.581018682937459
  mo_energy =
[-3.27920550e+01 -1.93577336e+00 -8.48941305e-01 -8.48941305e-01
 -8.48941305e-01  5.81018683e-01  5.81018683e-01  5.81018683e-01
  1.23757321e+00  2.89151168e+00  2.89151168e+00  2.89151168e+00
  7.62570407e+00  1.12322656e+01  1.12322656e+01  1.12322656e+01
  3.54703617e+01  5.44047708e+01  5.44047708e+01  5.44047708e+01
  1.39943222e+02  5.04182010e+02  1.87173985e+03  8.00123833e+03
  4.77686703e+04]
E1 = -182.4734834155661  E_coul = 53.96189055934444
cycle= 4 E= -128.511592856222  delta_E= -2.58e-08  |g|= 7.23e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.68283e-05
diis-c [-1.79413723e-09  1.29783006e-04  6.03025541e-04 -1.71782963e-01
  1.17105015e+00]
  HOMO = -0.848976011410077  LUMO = 0.581008859235731
  mo_energy =
[-3.27921011e+01 -1.93582160e+00 -8.48976011e-01 -8.48976011e-01
 -8.48976011e-01  5.81008859e-01  5.81008859e-01  5.81008859e-01
  1.23754128e+00  2.89147873e+00  2.89147873e+00  2.89147873e+00
  7.62565497e+00  1.12322189e+01  1.12322189e+01  1.12322189e+01
  3.54703099e+01  5.44047227e+01  5.44047227e+01  5.44047227e+01
  1.39943178e+02  5.04181977e+02  1.87173983e+03  8.00123831e+03
  4.77686703e+04]
E1 = -182.47351810525123  E_coul = 53.96192524824257
cycle= 5 E= -128.511592857009  delta_E= -7.87e-10  |g|= 5.74e-06  |ddm|= 5.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47351810525123  E_coul = 53.96192524824257
  HOMO = -0.848973184371277  LUMO = 0.581009261808668
  mo_energy =
[-3.27920946e+01 -1.93581967e+00 -8.48973184e-01 -8.48973184e-01
 -8.48973184e-01  5.81009262e-01  5.81009262e-01  5.81009262e-01
  1.23754195e+00  2.89148070e+00  2.89148070e+00  2.89148070e+00
  7.62565800e+00  1.12322230e+01  1.12322230e+01  1.12322230e+01
  3.54703153e+01  5.44047288e+01  5.44047288e+01  5.44047288e+01
  1.39943184e+02  5.04181983e+02  1.87173984e+03  8.00123832e+03
  4.77686703e+04]
E1 = -182.47349956496677  E_coul = 53.96190670795359
Extra cycle  E= -128.511592857013  delta_E= -4.52e-12  |g|= 2.7e-06  |ddm|= 3.26e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 359.6424581660966
E1 = -182.47349956496677  E_coul = 53.96190670795359
init E= -128.511592857013
    CPU time for initialize scf      0.19 sec, wall time      0.18 sec
  HOMO = -0.848974456761705  LUMO = 0.581009039122379
  mo_energy =
[-3.27920985e+01 -1.93582125e+00 -8.48974457e-01 -8.48974457e-01
 -8.48974457e-01  5.81009039e-01  5.81009039e-01  5.81009039e-01
  1.23754125e+00  2.89147975e+00  2.89147975e+00  2.89147975e+00
  7.62565628e+00  1.12322208e+01  1.12322208e+01  1.12322208e+01
  3.54703123e+01  5.44047252e+01  5.44047252e+01  5.44047252e+01
  1.39943181e+02  5.04181979e+02  1.87173983e+03  8.00123832e+03
  4.77686703e+04]
E1 = -182.47350862476893  E_coul = 53.96191576775527
cycle= 1 E= -128.511592857014  delta_E= -4.83e-13  |g|= 1.23e-06  |ddm|= 1.17e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.47350862476893  E_coul = 53.96191576775527
  HOMO = -0.848973808172367  LUMO = 0.581009140092531
  mo_energy =
[-3.27920965e+01 -1.93582061e+00 -8.48973808e-01 -8.48973808e-01
 -8.48973808e-01  5.81009140e-01  5.81009140e-01  5.81009140e-01
  1.23754150e+00  2.89148021e+00  2.89148021e+00  2.89148021e+00
  7.62565707e+00  1.12322219e+01  1.12322219e+01  1.12322219e+01
  3.54703138e+01  5.44047270e+01  5.44047270e+01  5.44047270e+01
  1.39943182e+02  5.04181981e+02  1.87173983e+03  8.00123832e+03
  4.77686703e+04]
E1 = -182.4735038085329  E_coul = 53.96191095151901
Extra cycle  E= -128.511592857014  delta_E= -2.56e-13  |g|= 6.55e-07  |ddm|= 4.08e-07
    CPU time for scf_cycle      0.24 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809687e+01 1.01221180e+01 2.71465362e+01 3.90962993e-01
 3.00824946e+00 1.15790967e+00 1.92379041e+00 6.26318117e+00
 2.83290750e+01 2.01870731e-01 6.36021332e-01]
grad_E = [-5.05793639e-14  7.78694544e-11 -1.51333032e-09  1.58423534e-08
 -8.58296857e-08  1.33222645e-06 -1.04835411e-07 -1.50594571e-04
 -2.11343055e-05  3.89010956e-04  8.88573154e-04 -1.41583827e-02
  8.25536079e-04 -2.49393226e-02  5.20145774e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434315        1
[INPUT] 0    0    [1    /1   ]  235.721742658        1
[INPUT] 0    0    [1    /1   ]  76.4809688457        1
[INPUT] 0    0    [1    /1   ]  10.1221193968        1
[INPUT] 0    0    [1    /1   ]  27.1465356487        1
[INPUT] 0    0    [1    /1   ]  0.391150816778       1
[INPUT] 0    0    [1    /1   ]  3.00827463635        1
[INPUT] 0    0    [1    /1   ]  1.1575122295         1
[INPUT] 1    0    [1    /1   ]  1.92649230719        1
[INPUT] 1    0    [1    /1   ]  6.27501387954        1
[INPUT] 1    0    [1    /1   ]  28.3283730908        1
[INPUT] 1    0    [1    /1   ]  0.210551432697       1
[INPUT] 1    0    [1    /1   ]  0.636068769039       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.4543980672156, 1.0]], [0, [833.2724343153461, 1.0]], [0, [235.72174265767123, 1.0]], [0, [76.48096884568596, 1.0]], [0, [10.122119396792714, 1.0]], [0, [27.146535648739157, 1.0]], [0, [0.39115081677834695, 1.0]], [0, [3.008274636345659, 1.0]], [0, [1.1575122295040083, 1.0]], [1, [1.9264923071884985, 1.0]], [1, [6.275013879535142, 1.0]], [1, [28.32837309076126, 1.0]], [1, [0.2105514326972529, 1.0]], [1, [0.6360687690393478, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243432]
bas 3, expnt(s) = [235.72174266]
bas 4, expnt(s) = [76.48096885]
bas 5, expnt(s) = [10.1221194]
bas 6, expnt(s) = [27.14653565]
bas 7, expnt(s) = [0.39115082]
bas 8, expnt(s) = [3.00827464]
bas 9, expnt(s) = [1.15751223]
bas 10, expnt(s) = [1.92649231]
bas 11, expnt(s) = [6.27501388]
bas 12, expnt(s) = [28.32837309]
bas 13, expnt(s) = [0.21055143]
bas 14, expnt(s) = [0.63606877]
CPU time:        29.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809688e+01 6.53401399e+01 1.01221194e+01 1.43373410e+01
 2.71465356e+01 3.00469805e+01 3.91150817e-01 1.24960630e+00
 3.00827464e+00 5.77102739e+00 1.15751223e+00 2.81941636e+00
 1.92649231e+00 6.62130345e+00 6.27501388e+00 2.89736197e+01
 2.83283731e+01 1.90660810e+02 2.10551433e-01 4.16085081e-01
 6.36068769e-01 1.65716016e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999623240893483
cond(S) = 359.6254138246787
E1 = -183.55010516230712  E_coul = 55.07324299086189
init E= -128.476862171445
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771007335687809  LUMO = 0.616203667007183
  mo_energy =
[-3.25571222e+01 -1.85297741e+00 -7.71007336e-01 -7.71007336e-01
 -7.71007336e-01  6.16203667e-01  6.16203667e-01  6.16203667e-01
  1.27285116e+00  2.98345428e+00  2.98345428e+00  2.98345428e+00
  7.72349670e+00  1.14070276e+01  1.14070276e+01  1.14070276e+01
  3.56479620e+01  5.46809409e+01  5.46809409e+01  5.46809409e+01
  1.40173630e+02  5.04448277e+02  1.87203751e+03  8.00156258e+03
  4.77690125e+04]
E1 = -181.93322166997723  E_coul = 53.42542815193199
cycle= 1 E= -128.507793518045  delta_E= -0.0309  |g|= 0.22  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505648
diis-c [-0.25567965  1.        ]
  HOMO = -0.886987753711298  LUMO = 0.596991717210279
  mo_energy =
[-3.29075271e+01 -1.97577925e+00 -8.86987754e-01 -8.86987754e-01
 -8.86987754e-01  5.96991717e-01  5.96991717e-01  5.96991717e-01
  1.22162937e+00  2.89862868e+00  2.89862868e+00  2.89862868e+00
  7.57796652e+00  1.12149151e+01  1.12149151e+01  1.12149151e+01
  3.53808165e+01  5.43632550e+01  5.43632550e+01  5.43632550e+01
  1.39829096e+02  5.04056361e+02  1.87160852e+03  8.00110435e+03
  4.77685354e+04]
E1 = -182.75735061133295  E_coul = 54.24656146917712
cycle= 2 E= -128.510789142156  delta_E= -0.003  |g|= 0.112  |ddm|= 0.0718
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260575
diis-c [-5.67924032e-04  3.39384877e-01  6.60615123e-01]
  HOMO = -0.848546372521161  LUMO = 0.603395729924498
  mo_energy =
[-3.27914479e+01 -1.93526036e+00 -8.48546373e-01 -8.48546373e-01
 -8.48546373e-01  6.03395730e-01  6.03395730e-01  6.03395730e-01
  1.23818219e+00  2.92641550e+00  2.92641550e+00  2.92641550e+00
  7.62587296e+00  1.12789316e+01  1.12789316e+01  1.12789316e+01
  3.54701355e+01  5.44689056e+01  5.44689056e+01  5.44689056e+01
  1.39943050e+02  5.04181892e+02  1.87173979e+03  8.00123834e+03
  4.77686704e+04]
E1 = -182.47842557438432  E_coul = 53.96656197067546
cycle= 3 E= -128.511863603709  delta_E= -0.00107  |g|= 0.000291  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000478719
diis-c [-1.40453600e-07 -2.16665072e-03 -5.15793203e-03  1.00732458e+00]
  HOMO = -0.848642790740184  LUMO = 0.603404363129581
  mo_energy =
[-3.27914860e+01 -1.93536985e+00 -8.48642791e-01 -8.48642791e-01
 -8.48642791e-01  6.03404363e-01  6.03404363e-01  6.03404363e-01
  1.23814455e+00  2.92639424e+00  2.92639424e+00  2.92639424e+00
  7.62580482e+00  1.12788961e+01  1.12788961e+01  1.12788961e+01
  3.54700841e+01  5.44688687e+01  5.44688687e+01  5.44688687e+01
  1.39943027e+02  5.04181899e+02  1.87173981e+03  8.00123836e+03
  4.77686704e+04]
E1 = -182.47785060273543  E_coul = 53.96598698496546
cycle= 4 E= -128.51186361777  delta_E= -1.41e-08  |g|= 5.49e-05  |ddm|= 0.0002
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.55019e-05
diis-c [-1.32702553e-09  8.71190283e-05  5.05722451e-04 -1.44051661e-01
  1.14345882e+00]
  HOMO = -0.848668697810481  LUMO = 0.603397238354964
  mo_energy =
[-3.27915206e+01 -1.93540579e+00 -8.48668698e-01 -8.48668698e-01
 -8.48668698e-01  6.03397238e-01  6.03397238e-01  6.03397238e-01
  1.23812150e+00  2.92637020e+00  2.92637020e+00  2.92637020e+00
  7.62576762e+00  1.12788612e+01  1.12788612e+01  1.12788612e+01
  3.54700446e+01  5.44688325e+01  5.44688325e+01  5.44688325e+01
  1.39942994e+02  5.04181876e+02  1.87173979e+03  8.00123835e+03
  4.77686704e+04]
E1 = -182.47788743579434  E_coul = 53.96602381763883
cycle= 5 E= -128.511863618156  delta_E= -3.86e-10  |g|= 4.72e-06  |ddm|= 3.44e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47788743579434  E_coul = 53.96602381763883
  HOMO = -0.848666629200838  LUMO = 0.603397496609013
  mo_energy =
[-3.27915155e+01 -1.93540450e+00 -8.48666629e-01 -8.48666629e-01
 -8.48666629e-01  6.03397497e-01  6.03397497e-01  6.03397497e-01
  1.23812182e+00  2.92637157e+00  2.92637157e+00  2.92637157e+00
  7.62576978e+00  1.12788643e+01  1.12788643e+01  1.12788643e+01
  3.54700487e+01  5.44688372e+01  5.44688372e+01  5.44688372e+01
  1.39942999e+02  5.04181881e+02  1.87173980e+03  8.00123835e+03
  4.77686704e+04]
E1 = -182.47787203747438  E_coul = 53.9660084193154
Extra cycle  E= -128.511863618159  delta_E= -3.47e-12  |g|= 2.24e-06  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809688e+01 1.01221194e+01 2.71465356e+01 3.91150817e-01
 3.00827464e+00 1.15751223e+00 1.92649231e+00 6.27501388e+00
 2.83283731e+01 2.10551433e-01 6.36068769e-01]
E = -128.511863618159
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

exps[1:, 0] = basis_sets["9s5p"][:]
exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434315        1
[INPUT] 0    0    [1    /1   ]  235.721742658        1
[INPUT] 0    0    [1    /1   ]  76.4809688457        1
[INPUT] 0    0    [1    /1   ]  10.1221193968        1
[INPUT] 0    0    [1    /1   ]  27.1465356487        1
[INPUT] 0    0    [1    /1   ]  0.391150816778       1
[INPUT] 0    0    [1    /1   ]  3.00827463635        1
[INPUT] 0    0    [1    /1   ]  1.1575122295         1
[INPUT] 1    0    [1    /1   ]  1.92649230719        1
[INPUT] 1    0    [1    /1   ]  6.27501387954        1
[INPUT] 1    0    [1    /1   ]  28.3283730908        1
[INPUT] 1    0    [1    /1   ]  0.210551432697       1
[INPUT] 1    0    [1    /1   ]  0.636068769039       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.4543980672156, 1.0]], [0, [833.2724343153461, 1.0]], [0, [235.72174265767123, 1.0]], [0, [76.48096884568596, 1.0]], [0, [10.122119396792714, 1.0]], [0, [27.146535648739157, 1.0]], [0, [0.39115081677834695, 1.0]], [0, [3.008274636345659, 1.0]], [0, [1.1575122295040083, 1.0]], [1, [1.9264923071884985, 1.0]], [1, [6.275013879535142, 1.0]], [1, [28.32837309076126, 1.0]], [1, [0.2105514326972529, 1.0]], [1, [0.6360687690393478, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243432]
bas 3, expnt(s) = [235.72174266]
bas 4, expnt(s) = [76.48096885]
bas 5, expnt(s) = [10.1221194]
bas 6, expnt(s) = [27.14653565]
bas 7, expnt(s) = [0.39115082]
bas 8, expnt(s) = [3.00827464]
bas 9, expnt(s) = [1.15751223]
bas 10, expnt(s) = [1.92649231]
bas 11, expnt(s) = [6.27501388]
bas 12, expnt(s) = [28.32837309]
bas 13, expnt(s) = [0.21055143]
bas 14, expnt(s) = [0.63606877]
CPU time:        29.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809688e+01 6.53401399e+01 1.01221194e+01 1.43373410e+01
 2.71465356e+01 3.00469805e+01 3.91150817e-01 1.24960630e+00
 3.00827464e+00 5.77102739e+00 1.15751223e+00 2.81941636e+00
 1.92649231e+00 6.62130345e+00 6.27501388e+00 2.89736197e+01
 2.83283731e+01 1.90660810e+02 2.10551433e-01 4.16085081e-01
 6.36068769e-01 1.65716016e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999623240893483
cond(S) = 359.6254138246787
E1 = -183.55010516230712  E_coul = 55.07324299086189
init E= -128.476862171445
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771007335687809  LUMO = 0.616203667007183
  mo_energy =
[-3.25571222e+01 -1.85297741e+00 -7.71007336e-01 -7.71007336e-01
 -7.71007336e-01  6.16203667e-01  6.16203667e-01  6.16203667e-01
  1.27285116e+00  2.98345428e+00  2.98345428e+00  2.98345428e+00
  7.72349670e+00  1.14070276e+01  1.14070276e+01  1.14070276e+01
  3.56479620e+01  5.46809409e+01  5.46809409e+01  5.46809409e+01
  1.40173630e+02  5.04448277e+02  1.87203751e+03  8.00156258e+03
  4.77690125e+04]
E1 = -181.93322166997723  E_coul = 53.42542815193199
cycle= 1 E= -128.507793518045  delta_E= -0.0309  |g|= 0.22  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505648
diis-c [-0.25567965  1.        ]
  HOMO = -0.886987753711298  LUMO = 0.596991717210279
  mo_energy =
[-3.29075271e+01 -1.97577925e+00 -8.86987754e-01 -8.86987754e-01
 -8.86987754e-01  5.96991717e-01  5.96991717e-01  5.96991717e-01
  1.22162937e+00  2.89862868e+00  2.89862868e+00  2.89862868e+00
  7.57796652e+00  1.12149151e+01  1.12149151e+01  1.12149151e+01
  3.53808165e+01  5.43632550e+01  5.43632550e+01  5.43632550e+01
  1.39829096e+02  5.04056361e+02  1.87160852e+03  8.00110435e+03
  4.77685354e+04]
E1 = -182.75735061133295  E_coul = 54.24656146917712
cycle= 2 E= -128.510789142156  delta_E= -0.003  |g|= 0.112  |ddm|= 0.0718
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260575
diis-c [-5.67924032e-04  3.39384877e-01  6.60615123e-01]
  HOMO = -0.848546372521161  LUMO = 0.603395729924498
  mo_energy =
[-3.27914479e+01 -1.93526036e+00 -8.48546373e-01 -8.48546373e-01
 -8.48546373e-01  6.03395730e-01  6.03395730e-01  6.03395730e-01
  1.23818219e+00  2.92641550e+00  2.92641550e+00  2.92641550e+00
  7.62587296e+00  1.12789316e+01  1.12789316e+01  1.12789316e+01
  3.54701355e+01  5.44689056e+01  5.44689056e+01  5.44689056e+01
  1.39943050e+02  5.04181892e+02  1.87173979e+03  8.00123834e+03
  4.77686704e+04]
E1 = -182.47842557438432  E_coul = 53.96656197067546
cycle= 3 E= -128.511863603709  delta_E= -0.00107  |g|= 0.000291  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000478719
diis-c [-1.40453600e-07 -2.16665072e-03 -5.15793203e-03  1.00732458e+00]
  HOMO = -0.848642790740184  LUMO = 0.603404363129581
  mo_energy =
[-3.27914860e+01 -1.93536985e+00 -8.48642791e-01 -8.48642791e-01
 -8.48642791e-01  6.03404363e-01  6.03404363e-01  6.03404363e-01
  1.23814455e+00  2.92639424e+00  2.92639424e+00  2.92639424e+00
  7.62580482e+00  1.12788961e+01  1.12788961e+01  1.12788961e+01
  3.54700841e+01  5.44688687e+01  5.44688687e+01  5.44688687e+01
  1.39943027e+02  5.04181899e+02  1.87173981e+03  8.00123836e+03
  4.77686704e+04]
E1 = -182.47785060273543  E_coul = 53.96598698496546
cycle= 4 E= -128.51186361777  delta_E= -1.41e-08  |g|= 5.49e-05  |ddm|= 0.0002
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.55019e-05
diis-c [-1.32702553e-09  8.71190283e-05  5.05722451e-04 -1.44051661e-01
  1.14345882e+00]
  HOMO = -0.848668697810481  LUMO = 0.603397238354964
  mo_energy =
[-3.27915206e+01 -1.93540579e+00 -8.48668698e-01 -8.48668698e-01
 -8.48668698e-01  6.03397238e-01  6.03397238e-01  6.03397238e-01
  1.23812150e+00  2.92637020e+00  2.92637020e+00  2.92637020e+00
  7.62576762e+00  1.12788612e+01  1.12788612e+01  1.12788612e+01
  3.54700446e+01  5.44688325e+01  5.44688325e+01  5.44688325e+01
  1.39942994e+02  5.04181876e+02  1.87173979e+03  8.00123835e+03
  4.77686704e+04]
E1 = -182.47788743579434  E_coul = 53.96602381763883
cycle= 5 E= -128.511863618156  delta_E= -3.86e-10  |g|= 4.72e-06  |ddm|= 3.44e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47788743579434  E_coul = 53.96602381763883
  HOMO = -0.848666629200838  LUMO = 0.603397496609013
  mo_energy =
[-3.27915155e+01 -1.93540450e+00 -8.48666629e-01 -8.48666629e-01
 -8.48666629e-01  6.03397497e-01  6.03397497e-01  6.03397497e-01
  1.23812182e+00  2.92637157e+00  2.92637157e+00  2.92637157e+00
  7.62576978e+00  1.12788643e+01  1.12788643e+01  1.12788643e+01
  3.54700487e+01  5.44688372e+01  5.44688372e+01  5.44688372e+01
  1.39942999e+02  5.04181881e+02  1.87173980e+03  8.00123835e+03
  4.77686704e+04]
E1 = -182.47787203747438  E_coul = 53.9660084193154
Extra cycle  E= -128.511863618159  delta_E= -3.47e-12  |g|= 2.24e-06  |ddm|= 2.87e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 359.6254138246787
E1 = -182.47787203747438  E_coul = 53.9660084193154
init E= -128.511863618159
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.848667694979497  LUMO = 0.60339729849895
  mo_energy =
[-3.27915187e+01 -1.93540583e+00 -8.48667695e-01 -8.48667695e-01
 -8.48667695e-01  6.03397298e-01  6.03397298e-01  6.03397298e-01
  1.23812121e+00  2.92637076e+00  2.92637076e+00  2.92637076e+00
  7.62576835e+00  1.12788625e+01  1.12788625e+01  1.12788625e+01
  3.54700462e+01  5.44688343e+01  5.44688343e+01  5.44688343e+01
  1.39942996e+02  5.04181877e+02  1.87173980e+03  8.00123835e+03
  4.77686704e+04]
E1 = -182.4778793102351  E_coul = 53.96601569207583
cycle= 1 E= -128.511863618159  delta_E= -2.84e-13  |g|= 9.93e-07  |ddm|= 9.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4778793102351  E_coul = 53.96601569207583
  HOMO = -0.848667175547115  LUMO = 0.603397381034826
  mo_energy =
[-3.27915171e+01 -1.93540532e+00 -8.48667176e-01 -8.48667176e-01
 -8.48667176e-01  6.03397381e-01  6.03397381e-01  6.03397381e-01
  1.23812141e+00  2.92637113e+00  2.92637113e+00  2.92637113e+00
  7.62576897e+00  1.12788633e+01  1.12788633e+01  1.12788633e+01
  3.54700474e+01  5.44688357e+01  5.44688357e+01  5.44688357e+01
  1.39942997e+02  5.04181879e+02  1.87173980e+03  8.00123835e+03
  4.77686704e+04]
E1 = -182.47787541379932  E_coul = 53.966011795640014
Extra cycle  E= -128.511863618159  delta_E= -2.84e-14  |g|= 5.3e-07  |ddm|= 3.33e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809688e+01 1.01221194e+01 2.71465356e+01 3.91150817e-01
 3.00827464e+00 1.15751223e+00 1.92649231e+00 6.27501388e+00
 2.83283731e+01 2.10551433e-01 6.36068769e-01]
grad_E = [ 1.73017887e-12 -1.60617394e-11  3.85157549e-10 -7.76986498e-09
  1.18800207e-07  6.99378037e-06 -1.44674700e-06  1.79916764e-04
 -3.48799759e-06  2.26301653e-04  5.09111596e-03 -1.44665471e-02
  8.07235719e-04 -6.20296845e-04 -1.03669165e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.27243432         1
[INPUT] 0    0    [1    /1   ]  235.721742612        1
[INPUT] 0    0    [1    /1   ]  76.4809690831        1
[INPUT] 0    0    [1    /1   ]  10.1221140056        1
[INPUT] 0    0    [1    /1   ]  27.1465361771        1
[INPUT] 0    0    [1    /1   ]  0.391042758068       1
[INPUT] 0    0    [1    /1   ]  3.0083338111         1
[INPUT] 0    0    [1    /1   ]  1.15639203689        1
[INPUT] 1    0    [1    /1   ]  1.94009036158        1
[INPUT] 1    0    [1    /1   ]  6.31672227923        1
[INPUT] 1    0    [1    /1   ]  28.3259362494        1
[INPUT] 1    0    [1    /1   ]  0.219478236877       1
[INPUT] 1    0    [1    /1   ]  0.642341404005       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.45439806699, 1.0]], [0, [833.2724343197258, 1.0]], [0, [235.72174261209787, 1.0]], [0, [76.48096908313201, 1.0]], [0, [10.122114005552351, 1.0]], [0, [27.146536177081124, 1.0]], [0, [0.39104275806809874, 1.0]], [0, [3.0083338110971294, 1.0]], [0, [1.156392036886418, 1.0]], [1, [1.9400903615839886, 1.0]], [1, [6.316722279233596, 1.0]], [1, [28.325936249449462, 1.0]], [1, [0.21947823687737755, 1.0]], [1, [0.6423414040048118, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243432]
bas 3, expnt(s) = [235.72174261]
bas 4, expnt(s) = [76.48096908]
bas 5, expnt(s) = [10.12211401]
bas 6, expnt(s) = [27.14653618]
bas 7, expnt(s) = [0.39104276]
bas 8, expnt(s) = [3.00833381]
bas 9, expnt(s) = [1.15639204]
bas 10, expnt(s) = [1.94009036]
bas 11, expnt(s) = [6.31672228]
bas 12, expnt(s) = [28.32593625]
bas 13, expnt(s) = [0.21947824]
bas 14, expnt(s) = [0.6423414]
CPU time:        31.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809691e+01 6.53401400e+01 1.01221140e+01 1.43373353e+01
 2.71465362e+01 3.00469809e+01 3.91042758e-01 1.24934738e+00
 3.00833381e+00 5.77111253e+00 1.15639204e+00 2.81736973e+00
 1.94009036e+00 6.67977509e+00 6.31672228e+00 2.92145446e+01
 2.83259362e+01 1.90640309e+02 2.19478237e-01 4.38251813e-01
 6.42341404e-01 1.67761302e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999620084983539
cond(S) = 359.3911625971311
E1 = -183.55085146073532  E_coul = 55.073428447385716
init E= -128.47742301335
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771076292439739  LUMO = 0.641103186011322
  mo_energy =
[-3.25570920e+01 -1.85296290e+00 -7.71076292e-01 -7.71076292e-01
 -7.71076292e-01  6.41103186e-01  6.41103186e-01  6.41103186e-01
  1.27185315e+00  3.04015806e+00  3.04015806e+00  3.04015806e+00
  7.71963633e+00  1.15314944e+01  1.15314944e+01  1.15314944e+01
  3.56429303e+01  5.48865177e+01  5.48865177e+01  5.48865177e+01
  1.40169018e+02  5.04444139e+02  1.87203380e+03  8.00155931e+03
  4.77690098e+04]
E1 = -181.94127301201345  E_coul = 53.43291952823014
cycle= 1 E= -128.508353483783  delta_E= -0.0309  |g|= 0.22  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506817
diis-c [-0.25686357  1.        ]
  HOMO = -0.886513596549068  LUMO = 0.62125268437878
  mo_energy =
[-3.29061169e+01 -1.97512474e+00 -8.86513597e-01 -8.86513597e-01
 -8.86513597e-01  6.21252684e-01  6.21252684e-01  6.21252684e-01
  1.22111502e+00  2.95526298e+00  2.95526298e+00  2.95526298e+00
  7.57482075e+00  1.13396693e+01  1.13396693e+01  1.13396693e+01
  3.53768479e+01  5.45701473e+01  5.45701473e+01  5.45701473e+01
  1.39825835e+02  5.04053696e+02  1.87160631e+03  8.00110259e+03
  4.77685342e+04]
E1 = -182.76195366830981  E_coul = 54.25062016572912
cycle= 2 E= -128.511333502581  delta_E= -0.00298  |g|= 0.111  |ddm|= 0.0715
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26077
diis-c [-5.66936190e-04  3.39036517e-01  6.60963483e-01]
  HOMO = -0.848219157495578  LUMO = 0.627898616434761
  mo_energy =
[-3.27904361e+01 -1.93476322e+00 -8.48219157e-01 -8.48219157e-01
 -8.48219157e-01  6.27898616e-01  6.27898616e-01  6.27898616e-01
  1.23758899e+00  2.98313877e+00  2.98313877e+00  2.98313877e+00
  7.62253398e+00  1.14036245e+01  1.14036245e+01  1.14036245e+01
  3.54658469e+01  5.46754100e+01  5.46754100e+01  5.46754100e+01
  1.39939397e+02  5.04178798e+02  1.87173713e+03  8.00123612e+03
  4.77686688e+04]
E1 = -182.48481296156677  E_coul = 53.97241561152319
cycle= 3 E= -128.512397350044  delta_E= -0.00106  |g|= 0.000253  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000450578
diis-c [-9.99143074e-08 -1.98884557e-03 -4.94774991e-03  1.00693660e+00]
  HOMO = -0.848288285622073  LUMO = 0.62791704881829
  mo_energy =
[-3.27904391e+01 -1.93483642e+00 -8.48288286e-01 -8.48288286e-01
 -8.48288286e-01  6.27917049e-01  6.27917049e-01  6.27917049e-01
  1.23757796e+00  2.98314403e+00  2.98314403e+00  2.98314403e+00
  7.62250102e+00  1.14036238e+01  1.14036238e+01  1.14036238e+01
  3.54658324e+01  5.46754087e+01  5.46754087e+01  5.46754087e+01
  1.39939407e+02  5.04178833e+02  1.87173718e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.4842596892468  E_coul = 53.971862330510454
cycle= 4 E= -128.512397358736  delta_E= -8.69e-09  |g|= 4.35e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.19026e-05
diis-c [-9.38804567e-10  4.72112018e-05  3.96188601e-04 -1.15726850e-01
  1.11528345e+00]
  HOMO = -0.848308733030507  LUMO = 0.627911611640186
  mo_energy =
[-3.27904668e+01 -1.93486410e+00 -8.48308733e-01 -8.48308733e-01
 -8.48308733e-01  6.27911612e-01  6.27911612e-01  6.27911612e-01
  1.23756084e+00  2.98312552e+00  2.98312552e+00  2.98312552e+00
  7.62247160e+00  1.14035962e+01  1.14035962e+01  1.14035962e+01
  3.54658006e+01  5.46753797e+01  5.46753797e+01  5.46753797e+01
  1.39939381e+02  5.04178815e+02  1.87173717e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.48429915803854  E_coul = 53.97190179910768
cycle= 5 E= -128.512397358931  delta_E= -1.94e-10  |g|= 3.79e-06  |ddm|= 2.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48429915803854  E_coul = 53.97190179910768
  HOMO = -0.848307224371035  LUMO = 0.627911782922704
  mo_energy =
[-3.27904629e+01 -1.93486324e+00 -8.48307224e-01 -8.48307224e-01
 -8.48307224e-01  6.27911783e-01  6.27911783e-01  6.27911783e-01
  1.23756097e+00  2.98312647e+00  2.98312647e+00  2.98312647e+00
  7.62247313e+00  1.14035985e+01  1.14035985e+01  1.14035985e+01
  3.54658037e+01  5.46753833e+01  5.46753833e+01  5.46753833e+01
  1.39939385e+02  5.04178819e+02  1.87173717e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.484286734236  E_coul = 53.97188937530276
Extra cycle  E= -128.512397358933  delta_E= -2.39e-12  |g|= 1.81e-06  |ddm|= 2.35e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809691e+01 1.01221140e+01 2.71465362e+01 3.91042758e-01
 3.00833381e+00 1.15639204e+00 1.94009036e+00 6.31672228e+00
 2.83259362e+01 2.19478237e-01 6.42341404e-01]
E = -128.51239735893324
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
# exps[:-1, 0] = basis_sets["10s4p"][:]
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.27243432         1
[INPUT] 0    0    [1    /1   ]  235.721742612        1
[INPUT] 0    0    [1    /1   ]  76.4809690831        1
[INPUT] 0    0    [1    /1   ]  10.1221140056        1
[INPUT] 0    0    [1    /1   ]  27.1465361771        1
[INPUT] 0    0    [1    /1   ]  0.391042758068       1
[INPUT] 0    0    [1    /1   ]  3.0083338111         1
[INPUT] 0    0    [1    /1   ]  1.15639203689        1
[INPUT] 1    0    [1    /1   ]  1.94009036158        1
[INPUT] 1    0    [1    /1   ]  6.31672227923        1
[INPUT] 1    0    [1    /1   ]  28.3259362494        1
[INPUT] 1    0    [1    /1   ]  0.219478236877       1
[INPUT] 1    0    [1    /1   ]  0.642341404005       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411734, 1.0]], [0, [3661.45439806699, 1.0]], [0, [833.2724343197258, 1.0]], [0, [235.72174261209787, 1.0]], [0, [76.48096908313201, 1.0]], [0, [10.122114005552351, 1.0]], [0, [27.146536177081124, 1.0]], [0, [0.39104275806809874, 1.0]], [0, [3.0083338110971294, 1.0]], [0, [1.156392036886418, 1.0]], [1, [1.9400903615839886, 1.0]], [1, [6.316722279233596, 1.0]], [1, [28.325936249449462, 1.0]], [1, [0.21947823687737755, 1.0]], [1, [0.6423414040048118, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243432]
bas 3, expnt(s) = [235.72174261]
bas 4, expnt(s) = [76.48096908]
bas 5, expnt(s) = [10.12211401]
bas 6, expnt(s) = [27.14653618]
bas 7, expnt(s) = [0.39104276]
bas 8, expnt(s) = [3.00833381]
bas 9, expnt(s) = [1.15639204]
bas 10, expnt(s) = [1.94009036]
bas 11, expnt(s) = [6.31672228]
bas 12, expnt(s) = [28.32593625]
bas 13, expnt(s) = [0.21947824]
bas 14, expnt(s) = [0.6423414]
CPU time:        32.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809691e+01 6.53401400e+01 1.01221140e+01 1.43373353e+01
 2.71465362e+01 3.00469809e+01 3.91042758e-01 1.24934738e+00
 3.00833381e+00 5.77111253e+00 1.15639204e+00 2.81736973e+00
 1.94009036e+00 6.67977509e+00 6.31672228e+00 2.92145446e+01
 2.83259362e+01 1.90640309e+02 2.19478237e-01 4.38251813e-01
 6.42341404e-01 1.67761302e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999620084983539
cond(S) = 359.3911625971311
E1 = -183.55085146073532  E_coul = 55.073428447385716
init E= -128.47742301335
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771076292439739  LUMO = 0.641103186011322
  mo_energy =
[-3.25570920e+01 -1.85296290e+00 -7.71076292e-01 -7.71076292e-01
 -7.71076292e-01  6.41103186e-01  6.41103186e-01  6.41103186e-01
  1.27185315e+00  3.04015806e+00  3.04015806e+00  3.04015806e+00
  7.71963633e+00  1.15314944e+01  1.15314944e+01  1.15314944e+01
  3.56429303e+01  5.48865177e+01  5.48865177e+01  5.48865177e+01
  1.40169018e+02  5.04444139e+02  1.87203380e+03  8.00155931e+03
  4.77690098e+04]
E1 = -181.94127301201345  E_coul = 53.43291952823014
cycle= 1 E= -128.508353483783  delta_E= -0.0309  |g|= 0.22  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506817
diis-c [-0.25686357  1.        ]
  HOMO = -0.886513596549068  LUMO = 0.62125268437878
  mo_energy =
[-3.29061169e+01 -1.97512474e+00 -8.86513597e-01 -8.86513597e-01
 -8.86513597e-01  6.21252684e-01  6.21252684e-01  6.21252684e-01
  1.22111502e+00  2.95526298e+00  2.95526298e+00  2.95526298e+00
  7.57482075e+00  1.13396693e+01  1.13396693e+01  1.13396693e+01
  3.53768479e+01  5.45701473e+01  5.45701473e+01  5.45701473e+01
  1.39825835e+02  5.04053696e+02  1.87160631e+03  8.00110259e+03
  4.77685342e+04]
E1 = -182.76195366830981  E_coul = 54.25062016572912
cycle= 2 E= -128.511333502581  delta_E= -0.00298  |g|= 0.111  |ddm|= 0.0715
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26077
diis-c [-5.66936190e-04  3.39036517e-01  6.60963483e-01]
  HOMO = -0.848219157495578  LUMO = 0.627898616434761
  mo_energy =
[-3.27904361e+01 -1.93476322e+00 -8.48219157e-01 -8.48219157e-01
 -8.48219157e-01  6.27898616e-01  6.27898616e-01  6.27898616e-01
  1.23758899e+00  2.98313877e+00  2.98313877e+00  2.98313877e+00
  7.62253398e+00  1.14036245e+01  1.14036245e+01  1.14036245e+01
  3.54658469e+01  5.46754100e+01  5.46754100e+01  5.46754100e+01
  1.39939397e+02  5.04178798e+02  1.87173713e+03  8.00123612e+03
  4.77686688e+04]
E1 = -182.48481296156677  E_coul = 53.97241561152319
cycle= 3 E= -128.512397350044  delta_E= -0.00106  |g|= 0.000253  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000450578
diis-c [-9.99143074e-08 -1.98884557e-03 -4.94774991e-03  1.00693660e+00]
  HOMO = -0.848288285622073  LUMO = 0.62791704881829
  mo_energy =
[-3.27904391e+01 -1.93483642e+00 -8.48288286e-01 -8.48288286e-01
 -8.48288286e-01  6.27917049e-01  6.27917049e-01  6.27917049e-01
  1.23757796e+00  2.98314403e+00  2.98314403e+00  2.98314403e+00
  7.62250102e+00  1.14036238e+01  1.14036238e+01  1.14036238e+01
  3.54658324e+01  5.46754087e+01  5.46754087e+01  5.46754087e+01
  1.39939407e+02  5.04178833e+02  1.87173718e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.4842596892468  E_coul = 53.971862330510454
cycle= 4 E= -128.512397358736  delta_E= -8.69e-09  |g|= 4.35e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.19026e-05
diis-c [-9.38804567e-10  4.72112018e-05  3.96188601e-04 -1.15726850e-01
  1.11528345e+00]
  HOMO = -0.848308733030507  LUMO = 0.627911611640186
  mo_energy =
[-3.27904668e+01 -1.93486410e+00 -8.48308733e-01 -8.48308733e-01
 -8.48308733e-01  6.27911612e-01  6.27911612e-01  6.27911612e-01
  1.23756084e+00  2.98312552e+00  2.98312552e+00  2.98312552e+00
  7.62247160e+00  1.14035962e+01  1.14035962e+01  1.14035962e+01
  3.54658006e+01  5.46753797e+01  5.46753797e+01  5.46753797e+01
  1.39939381e+02  5.04178815e+02  1.87173717e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.48429915803854  E_coul = 53.97190179910768
cycle= 5 E= -128.512397358931  delta_E= -1.94e-10  |g|= 3.79e-06  |ddm|= 2.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48429915803854  E_coul = 53.97190179910768
  HOMO = -0.848307224371035  LUMO = 0.627911782922704
  mo_energy =
[-3.27904629e+01 -1.93486324e+00 -8.48307224e-01 -8.48307224e-01
 -8.48307224e-01  6.27911783e-01  6.27911783e-01  6.27911783e-01
  1.23756097e+00  2.98312647e+00  2.98312647e+00  2.98312647e+00
  7.62247313e+00  1.14035985e+01  1.14035985e+01  1.14035985e+01
  3.54658037e+01  5.46753833e+01  5.46753833e+01  5.46753833e+01
  1.39939385e+02  5.04178819e+02  1.87173717e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.484286734236  E_coul = 53.97188937530276
Extra cycle  E= -128.512397358933  delta_E= -2.39e-12  |g|= 1.81e-06  |ddm|= 2.35e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 359.3911625971311
E1 = -182.484286734236  E_coul = 53.97188937530276
init E= -128.512397358933
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.848308089122076  LUMO = 0.627911613863826
  mo_energy =
[-3.27904654e+01 -1.93486432e+00 -8.48308089e-01 -8.48308089e-01
 -8.48308089e-01  6.27911614e-01  6.27911614e-01  6.27911614e-01
  1.23756047e+00  2.98312581e+00  2.98312581e+00  2.98312581e+00
  7.62247197e+00  1.14035971e+01  1.14035971e+01  1.14035971e+01
  3.54658017e+01  5.46753809e+01  5.46753809e+01  5.46753809e+01
  1.39939382e+02  5.04178816e+02  1.87173717e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.48429248555186  E_coul = 53.97189512661858
cycle= 1 E= -128.512397358933  delta_E= -5.68e-14  |g|= 7.87e-07  |ddm|= 7.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.48429248555186  E_coul = 53.97189512661858
  HOMO = -0.84830767899457  LUMO = 0.627911681349488
  mo_energy =
[-3.27904642e+01 -1.93486392e+00 -8.48307679e-01 -8.48307679e-01
 -8.48307679e-01  6.27911681e-01  6.27911681e-01  6.27911681e-01
  1.23756062e+00  2.98312610e+00  2.98312610e+00  2.98312610e+00
  7.62247246e+00  1.14035977e+01  1.14035977e+01  1.14035977e+01
  3.54658027e+01  5.46753821e+01  5.46753821e+01  5.46753821e+01
  1.39939384e+02  5.04178818e+02  1.87173717e+03  8.00123616e+03
  4.77686688e+04]
E1 = -182.4842893953014  E_coul = 53.971892036367734
Extra cycle  E= -128.512397358934  delta_E= -3.69e-13  |g|= 4.21e-07  |ddm|= 2.66e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809691e+01 1.01221140e+01 2.71465362e+01 3.91042758e-01
 3.00833381e+00 1.15639204e+00 1.94009036e+00 6.31672228e+00
 2.83259362e+01 2.19478237e-01 6.42341404e-01]
grad_E = [ 4.55823096e-12 -1.65023572e-10  3.39148252e-09 -4.47127528e-08
  4.30833324e-07  1.45909905e-05 -3.37755606e-06  4.59073872e-04
  1.64106554e-05  6.56044917e-05  6.19566941e-03 -1.35245428e-02
  6.61260572e-04  1.50805676e-02 -1.82847304e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["10s4p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434334        1
[INPUT] 0    0    [1    /1   ]  235.721742479        1
[INPUT] 0    0    [1    /1   ]  76.4809694175        1
[INPUT] 0    0    [1    /1   ]  10.1220625557        1
[INPUT] 0    0    [1    /1   ]  27.1465448392        1
[INPUT] 0    0    [1    /1   ]  0.389532764293       1
[INPUT] 0    0    [1    /1   ]  3.00860221544        1
[INPUT] 0    0    [1    /1   ]  1.15071787608        1
[INPUT] 1    0    [1    /1   ]  2.0296425101         1
[INPUT] 1    0    [1    /1   ]  6.53798203541        1
[INPUT] 1    0    [1    /1   ]  28.3133037237        1
[INPUT] 1    0    [1    /1   ]  0.250490308008       1
[INPUT] 1    0    [1    /1   ]  0.684645331502       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411727, 1.0]], [0, [3661.4543980662274, 1.0]], [0, [833.272434334182, 1.0]], [0, [235.72174247887324, 1.0]], [0, [76.48096941747595, 1.0]], [0, [10.122062555659333, 1.0]], [0, [27.146544839226856, 1.0]], [0, [0.3895327642932482, 1.0]], [0, [3.008602215438198, 1.0]], [0, [1.1507178760794547, 1.0]], [1, [2.0296425100967883, 1.0]], [1, [6.53798203540605, 1.0]], [1, [28.31330372374814, 1.0]], [1, [0.250490308008398, 1.0]], [1, [0.6846453315023261, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243433]
bas 3, expnt(s) = [235.72174248]
bas 4, expnt(s) = [76.48096942]
bas 5, expnt(s) = [10.12206256]
bas 6, expnt(s) = [27.14654484]
bas 7, expnt(s) = [0.38953276]
bas 8, expnt(s) = [3.00860222]
bas 9, expnt(s) = [1.15071788]
bas 10, expnt(s) = [2.02964251]
bas 11, expnt(s) = [6.53798204]
bas 12, expnt(s) = [28.31330372]
bas 13, expnt(s) = [0.25049031]
bas 14, expnt(s) = [0.68464533]
CPU time:        34.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721742e+02 1.51989909e+02
 7.64809694e+01 6.53401402e+01 1.01220626e+01 1.43372807e+01
 2.71465448e+01 3.00469881e+01 3.89532764e-01 1.24572741e+00
 3.00860222e+00 5.77149870e+00 1.15071788e+00 2.80699519e+00
 2.02964251e+00 7.06738630e+00 6.53798204e+00 3.04992420e+01
 2.83133037e+01 1.90534040e+02 2.50490308e-01 5.16979177e-01
 6.84645332e-01 1.81683905e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99941272585693
cond(S) = 357.93448086747327
E1 = -183.55392909305635  E_coul = 55.07434617738719
init E= -128.479582915669
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771301679529357  LUMO = 0.73379176696574
  mo_energy =
[-3.25568714e+01 -1.85291045e+00 -7.71301680e-01 -7.71301680e-01
 -7.71301680e-01  7.33791767e-01  7.33791767e-01  7.33791767e-01
  1.26439614e+00  3.31141985e+00  3.31141985e+00  3.31141985e+00
  7.69559290e+00  1.22200937e+01  1.22200937e+01  1.22200937e+01
  3.56130756e+01  5.60241880e+01  5.60241880e+01  5.60241880e+01
  1.40141839e+02  5.04419738e+02  1.87201188e+03  8.00153999e+03
  4.77689938e+04]
E1 = -181.97926441233346  E_coul = 53.46885301774726
cycle= 1 E= -128.510411394586  delta_E= -0.0308  |g|= 0.216  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506789
diis-c [-0.25683536  1.        ]
  HOMO = -0.884161180368589  LUMO = 0.711464769583427
  mo_energy =
[-3.28992300e+01 -1.97201699e+00 -8.84161180e-01 -8.84161180e-01
 -8.84161180e-01  7.11464770e-01  7.11464770e-01  7.11464770e-01
  1.21577659e+00  3.22494796e+00  3.22494796e+00  3.22494796e+00
  7.55423692e+00  1.20291159e+01  1.20291159e+01  1.20291159e+01
  3.53521893e+01  5.57141677e+01  5.57141677e+01  5.57141677e+01
  1.39805200e+02  5.04036497e+02  1.87159183e+03  8.00109076e+03
  4.77685257e+04]
E1 = -182.78178595626815  E_coul = 54.2684844997712
cycle= 2 E= -128.513301456497  delta_E= -0.00289  |g|= 0.109  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258965
diis-c [-5.66676901e-04  3.37481123e-01  6.62518877e-01]
  HOMO = -0.846653334241052  LUMO = 0.719029348028762
  mo_energy =
[-3.27857201e+01 -1.93250167e+00 -8.46653334e-01 -8.46653334e-01
 -8.46653334e-01  7.19029348e-01  7.19029348e-01  7.19029348e-01
  1.23180258e+00  3.25352095e+00  3.25352095e+00  3.25352095e+00
  7.60092445e+00  1.20928375e+01  1.20928375e+01  1.20928375e+01
  3.54394622e+01  5.58173276e+01  5.58173276e+01  5.58173276e+01
  1.39916626e+02  5.04159256e+02  1.87172018e+03  8.00122177e+03
  4.77686577e+04]
E1 = -182.51259907253922  E_coul = 53.998285085549625
cycle= 3 E= -128.51431398699  delta_E= -0.00101  |g|= 0.000219  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000364013
diis-c [-3.66902398e-08 -1.57925900e-03 -4.18404203e-03  1.00576330e+00]
  HOMO = -0.846667240254064  LUMO = 0.719070987129923
  mo_energy =
[-3.27856675e+01 -1.93249069e+00 -8.46667240e-01 -8.46667240e-01
 -8.46667240e-01  7.19070987e-01  7.19070987e-01  7.19070987e-01
  1.23185262e+00  3.25358077e+00  3.25358077e+00  3.25358077e+00
  7.60096679e+00  1.20929035e+01  1.20929035e+01  1.20929035e+01
  3.54395163e+01  5.58173855e+01  5.58173855e+01  5.58173855e+01
  1.39916688e+02  5.04159318e+02  1.87172023e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.51215994633856  E_coul = 53.99784595517069
cycle= 4 E= -128.514313991168  delta_E= -4.18e-09  |g|= 2.41e-05  |ddm|= 0.000143
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.37842e-05
diis-c [-1.27087709e-10 -6.05155982e-05  6.53035451e-05 -1.66770808e-02
  1.01667229e+00]
  HOMO = -0.846676829945144  LUMO = 0.719069139974866
  mo_energy =
[-3.27856826e+01 -1.93249971e+00 -8.46676830e-01 -8.46676830e-01
 -8.46676830e-01  7.19069140e-01  7.19069140e-01  7.19069140e-01
  1.23184861e+00  3.25357331e+00  3.25357331e+00  3.25357331e+00
  7.60095421e+00  1.20928904e+01  1.20928904e+01  1.20928904e+01
  3.54395002e+01  5.58173703e+01  5.58173703e+01  5.58173703e+01
  1.39916674e+02  5.04159307e+02  1.87172022e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.5122063634538  E_coul = 53.99789237223817
cycle= 5 E= -128.514313991216  delta_E= -4.78e-11  |g|= 1.48e-06  |ddm|= 1.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5122063634538  E_coul = 53.99789237223817
  HOMO = -0.846676603859737  LUMO = 0.719069225020559
  mo_energy =
[-3.27856818e+01 -1.93249917e+00 -8.46676604e-01 -8.46676604e-01
 -8.46676604e-01  7.19069225e-01  7.19069225e-01  7.19069225e-01
  1.23184891e+00  3.25357354e+00  3.25357354e+00  3.25357354e+00
  7.60095457e+00  1.20928909e+01  1.20928909e+01  1.20928909e+01
  3.54395008e+01  5.58173710e+01  5.58173710e+01  5.58173710e+01
  1.39916675e+02  5.04159308e+02  1.87172022e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.5122050331869  E_coul = 53.99789104197113
Extra cycle  E= -128.514313991216  delta_E= -1.42e-13  |g|= 3.19e-07  |ddm|= 1.44e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721742e+02
 7.64809694e+01 1.01220626e+01 2.71465448e+01 3.89532764e-01
 3.00860222e+00 1.15071788e+00 2.02964251e+00 6.53798204e+00
 2.83133037e+01 2.50490308e-01 6.84645332e-01]
E = -128.51431399121577
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["10s4p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434334        1
[INPUT] 0    0    [1    /1   ]  235.721742479        1
[INPUT] 0    0    [1    /1   ]  76.4809694175        1
[INPUT] 0    0    [1    /1   ]  10.1220625557        1
[INPUT] 0    0    [1    /1   ]  27.1465448392        1
[INPUT] 0    0    [1    /1   ]  0.389532764293       1
[INPUT] 0    0    [1    /1   ]  3.00860221544        1
[INPUT] 0    0    [1    /1   ]  1.15071787608        1
[INPUT] 1    0    [1    /1   ]  2.0296425101         1
[INPUT] 1    0    [1    /1   ]  6.53798203541        1
[INPUT] 1    0    [1    /1   ]  28.3133037237        1
[INPUT] 1    0    [1    /1   ]  0.250490308008       1
[INPUT] 1    0    [1    /1   ]  0.684645331502       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411727, 1.0]], [0, [3661.4543980662274, 1.0]], [0, [833.272434334182, 1.0]], [0, [235.72174247887324, 1.0]], [0, [76.48096941747595, 1.0]], [0, [10.122062555659333, 1.0]], [0, [27.146544839226856, 1.0]], [0, [0.3895327642932482, 1.0]], [0, [3.008602215438198, 1.0]], [0, [1.1507178760794547, 1.0]], [1, [2.0296425100967883, 1.0]], [1, [6.53798203540605, 1.0]], [1, [28.31330372374814, 1.0]], [1, [0.250490308008398, 1.0]], [1, [0.6846453315023261, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243433]
bas 3, expnt(s) = [235.72174248]
bas 4, expnt(s) = [76.48096942]
bas 5, expnt(s) = [10.12206256]
bas 6, expnt(s) = [27.14654484]
bas 7, expnt(s) = [0.38953276]
bas 8, expnt(s) = [3.00860222]
bas 9, expnt(s) = [1.15071788]
bas 10, expnt(s) = [2.02964251]
bas 11, expnt(s) = [6.53798204]
bas 12, expnt(s) = [28.31330372]
bas 13, expnt(s) = [0.25049031]
bas 14, expnt(s) = [0.68464533]
CPU time:        35.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721742e+02 1.51989909e+02
 7.64809694e+01 6.53401402e+01 1.01220626e+01 1.43372807e+01
 2.71465448e+01 3.00469881e+01 3.89532764e-01 1.24572741e+00
 3.00860222e+00 5.77149870e+00 1.15071788e+00 2.80699519e+00
 2.02964251e+00 7.06738630e+00 6.53798204e+00 3.04992420e+01
 2.83133037e+01 1.90534040e+02 2.50490308e-01 5.16979177e-01
 6.84645332e-01 1.81683905e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99941272585693
cond(S) = 357.93448086747327
E1 = -183.55392909305635  E_coul = 55.07434617738719
init E= -128.479582915669
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771301679529357  LUMO = 0.73379176696574
  mo_energy =
[-3.25568714e+01 -1.85291045e+00 -7.71301680e-01 -7.71301680e-01
 -7.71301680e-01  7.33791767e-01  7.33791767e-01  7.33791767e-01
  1.26439614e+00  3.31141985e+00  3.31141985e+00  3.31141985e+00
  7.69559290e+00  1.22200937e+01  1.22200937e+01  1.22200937e+01
  3.56130756e+01  5.60241880e+01  5.60241880e+01  5.60241880e+01
  1.40141839e+02  5.04419738e+02  1.87201188e+03  8.00153999e+03
  4.77689938e+04]
E1 = -181.97926441233346  E_coul = 53.46885301774726
cycle= 1 E= -128.510411394586  delta_E= -0.0308  |g|= 0.216  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506789
diis-c [-0.25683536  1.        ]
  HOMO = -0.884161180368589  LUMO = 0.711464769583427
  mo_energy =
[-3.28992300e+01 -1.97201699e+00 -8.84161180e-01 -8.84161180e-01
 -8.84161180e-01  7.11464770e-01  7.11464770e-01  7.11464770e-01
  1.21577659e+00  3.22494796e+00  3.22494796e+00  3.22494796e+00
  7.55423692e+00  1.20291159e+01  1.20291159e+01  1.20291159e+01
  3.53521893e+01  5.57141677e+01  5.57141677e+01  5.57141677e+01
  1.39805200e+02  5.04036497e+02  1.87159183e+03  8.00109076e+03
  4.77685257e+04]
E1 = -182.78178595626815  E_coul = 54.2684844997712
cycle= 2 E= -128.513301456497  delta_E= -0.00289  |g|= 0.109  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258965
diis-c [-5.66676901e-04  3.37481123e-01  6.62518877e-01]
  HOMO = -0.846653334241052  LUMO = 0.719029348028762
  mo_energy =
[-3.27857201e+01 -1.93250167e+00 -8.46653334e-01 -8.46653334e-01
 -8.46653334e-01  7.19029348e-01  7.19029348e-01  7.19029348e-01
  1.23180258e+00  3.25352095e+00  3.25352095e+00  3.25352095e+00
  7.60092445e+00  1.20928375e+01  1.20928375e+01  1.20928375e+01
  3.54394622e+01  5.58173276e+01  5.58173276e+01  5.58173276e+01
  1.39916626e+02  5.04159256e+02  1.87172018e+03  8.00122177e+03
  4.77686577e+04]
E1 = -182.51259907253922  E_coul = 53.998285085549625
cycle= 3 E= -128.51431398699  delta_E= -0.00101  |g|= 0.000219  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000364013
diis-c [-3.66902398e-08 -1.57925900e-03 -4.18404203e-03  1.00576330e+00]
  HOMO = -0.846667240254064  LUMO = 0.719070987129923
  mo_energy =
[-3.27856675e+01 -1.93249069e+00 -8.46667240e-01 -8.46667240e-01
 -8.46667240e-01  7.19070987e-01  7.19070987e-01  7.19070987e-01
  1.23185262e+00  3.25358077e+00  3.25358077e+00  3.25358077e+00
  7.60096679e+00  1.20929035e+01  1.20929035e+01  1.20929035e+01
  3.54395163e+01  5.58173855e+01  5.58173855e+01  5.58173855e+01
  1.39916688e+02  5.04159318e+02  1.87172023e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.51215994633856  E_coul = 53.99784595517069
cycle= 4 E= -128.514313991168  delta_E= -4.18e-09  |g|= 2.41e-05  |ddm|= 0.000143
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.37842e-05
diis-c [-1.27087709e-10 -6.05155982e-05  6.53035451e-05 -1.66770808e-02
  1.01667229e+00]
  HOMO = -0.846676829945144  LUMO = 0.719069139974866
  mo_energy =
[-3.27856826e+01 -1.93249971e+00 -8.46676830e-01 -8.46676830e-01
 -8.46676830e-01  7.19069140e-01  7.19069140e-01  7.19069140e-01
  1.23184861e+00  3.25357331e+00  3.25357331e+00  3.25357331e+00
  7.60095421e+00  1.20928904e+01  1.20928904e+01  1.20928904e+01
  3.54395002e+01  5.58173703e+01  5.58173703e+01  5.58173703e+01
  1.39916674e+02  5.04159307e+02  1.87172022e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.5122063634538  E_coul = 53.99789237223817
cycle= 5 E= -128.514313991216  delta_E= -4.78e-11  |g|= 1.48e-06  |ddm|= 1.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5122063634538  E_coul = 53.99789237223817
  HOMO = -0.846676603859737  LUMO = 0.719069225020559
  mo_energy =
[-3.27856818e+01 -1.93249917e+00 -8.46676604e-01 -8.46676604e-01
 -8.46676604e-01  7.19069225e-01  7.19069225e-01  7.19069225e-01
  1.23184891e+00  3.25357354e+00  3.25357354e+00  3.25357354e+00
  7.60095457e+00  1.20928909e+01  1.20928909e+01  1.20928909e+01
  3.54395008e+01  5.58173710e+01  5.58173710e+01  5.58173710e+01
  1.39916675e+02  5.04159308e+02  1.87172022e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.5122050331869  E_coul = 53.99789104197113
Extra cycle  E= -128.514313991216  delta_E= -1.42e-13  |g|= 3.19e-07  |ddm|= 1.44e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 357.93448086747327
E1 = -182.5122050331869  E_coul = 53.99789104197113
init E= -128.514313991216
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.846676708174555  LUMO = 0.719069211953523
  mo_energy =
[-3.27856821e+01 -1.93249921e+00 -8.46676708e-01 -8.46676708e-01
 -8.46676708e-01  7.19069212e-01  7.19069212e-01  7.19069212e-01
  1.23184892e+00  3.25357347e+00  3.25357347e+00  3.25357347e+00
  7.60095448e+00  1.20928908e+01  1.20928908e+01  1.20928908e+01
  3.54395006e+01  5.58173707e+01  5.58173707e+01  5.58173707e+01
  1.39916674e+02  5.04159308e+02  1.87172022e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.51220591472207  E_coul = 53.99789192350604
cycle= 1 E= -128.514313991216  delta_E= -2.56e-13  |g|= 1.35e-07  |ddm|= 2.31e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51220591472207  E_coul = 53.99789192350604
  HOMO = -0.84667664795002  LUMO = 0.719069225571097
  mo_energy =
[-3.27856820e+01 -1.93249913e+00 -8.46676648e-01 -8.46676648e-01
 -8.46676648e-01  7.19069226e-01  7.19069226e-01  7.19069226e-01
  1.23184895e+00  3.25357352e+00  3.25357352e+00  3.25357352e+00
  7.60095456e+00  1.20928909e+01  1.20928909e+01  1.20928909e+01
  3.54395007e+01  5.58173709e+01  5.58173709e+01  5.58173709e+01
  1.39916675e+02  5.04159308e+02  1.87172022e+03  8.00122179e+03
  4.77686577e+04]
E1 = -182.51220550924754  E_coul = 53.99789151803165
Extra cycle  E= -128.514313991216  delta_E= 1.42e-13  |g|= 5.59e-08  |ddm|= 6.42e-08
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721742e+02
 7.64809694e+01 1.01220626e+01 2.71465448e+01 3.89532764e-01
 3.00860222e+00 1.15071788e+00 2.02964251e+00 6.53798204e+00
 2.83133037e+01 2.50490308e-01 6.84645332e-01]
grad_E = [ 1.57769489e-11 -7.55597620e-10  1.53120215e-08 -1.90749870e-07
  1.65914462e-06  4.33653577e-05 -1.08712215e-05  8.25691213e-04
  8.14271020e-05 -3.50165283e-04  6.82430907e-03 -9.12748615e-03
 -2.46394195e-05  5.21183787e-02 -3.08204546e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434333        1
[INPUT] 0    0    [1    /1   ]  235.721742543        1
[INPUT] 0    0    [1    /1   ]  76.4809680769        1
[INPUT] 0    0    [1    /1   ]  10.1219710035        1
[INPUT] 0    0    [1    /1   ]  27.14656395          1
[INPUT] 0    0    [1    /1   ]  0.387700236895       1
[INPUT] 0    0    [1    /1   ]  3.00879689766        1
[INPUT] 0    0    [1    /1   ]  1.14534778633        1
[INPUT] 1    0    [1    /1   ]  2.12889854103        1
[INPUT] 1    0    [1    /1   ]  6.75875454827        1
[INPUT] 1    0    [1    /1   ]  28.3013197109        1
[INPUT] 1    0    [1    /1   ]  0.267718009463       1
[INPUT] 1    0    [1    /1   ]  0.731403072458       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.7941314117, 1.0]], [0, [3661.454398066255, 1.0]], [0, [833.272434332643, 1.0]], [0, [235.72174254273858, 1.0]], [0, [76.48096807689656, 1.0]], [0, [10.121971003452073, 1.0]], [0, [27.14656395002591, 1.0]], [0, [0.38770023689512223, 1.0]], [0, [3.008796897660096, 1.0]], [0, [1.1453477863329442, 1.0]], [1, [2.128898541034843, 1.0]], [1, [6.758754548265384, 1.0]], [1, [28.301319710859616, 1.0]], [1, [0.2677180094629153, 1.0]], [1, [0.7314030724578159, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243433]
bas 3, expnt(s) = [235.72174254]
bas 4, expnt(s) = [76.48096808]
bas 5, expnt(s) = [10.121971]
bas 6, expnt(s) = [27.14656395]
bas 7, expnt(s) = [0.38770024]
bas 8, expnt(s) = [3.0087969]
bas 9, expnt(s) = [1.14534779]
bas 10, expnt(s) = [2.12889854]
bas 11, expnt(s) = [6.75875455]
bas 12, expnt(s) = [28.30131971]
bas 13, expnt(s) = [0.26771801]
bas 14, expnt(s) = [0.73140307]
CPU time:        37.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809681e+01 6.53401394e+01 1.01219710e+01 1.43371834e+01
 2.71465640e+01 3.00470040e+01 3.87700237e-01 1.24132949e+00
 3.00879690e+00 5.77177880e+00 1.14534779e+00 2.79716484e+00
 2.12889854e+00 7.50201793e+00 6.75875455e+00 3.17919917e+01
 2.83013197e+01 1.90433238e+02 2.67718009e-01 5.61799537e-01
 7.31403072e-01 1.97324208e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999283961415607
cond(S) = 356.45696872756156
E1 = -183.55675718052078  E_coul = 55.075250649880985
init E= -128.48150653064
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771462163653573  LUMO = 0.794256707494943
  mo_energy =
[-3.25566418e+01 -1.85285964e+00 -7.71462164e-01 -7.71462164e-01
 -7.71462164e-01  7.94256707e-01  7.94256707e-01  7.94256707e-01
  1.25641525e+00  3.54761124e+00  3.54761124e+00  3.54761124e+00
  7.67083070e+00  1.29072705e+01  1.29072705e+01  1.29072705e+01
  3.55827434e+01  5.71776179e+01  5.71776179e+01  5.71776179e+01
  1.40114229e+02  5.04394905e+02  1.87198954e+03  8.00152028e+03
  4.77689774e+04]
E1 = -182.00317257743527  E_coul = 53.491227842544205
cycle= 1 E= -128.511944734891  delta_E= -0.0304  |g|= 0.213  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505109
diis-c [-0.25513514  1.        ]
  HOMO = -0.882771312644814  LUMO = 0.769978903883218
  mo_energy =
[-3.28948098e+01 -1.97011200e+00 -8.82771313e-01 -8.82771313e-01
 -8.82771313e-01  7.69978904e-01  7.69978904e-01  7.69978904e-01
  1.20904980e+00  3.45837338e+00  3.45837338e+00  3.45837338e+00
  7.53164384e+00  1.27154891e+01  1.27154891e+01  1.27154891e+01
  3.53250815e+01  5.68715850e+01  5.68715850e+01  5.68715850e+01
  1.39781716e+02  5.04016342e+02  1.87157439e+03  8.00107602e+03
  4.77685143e+04]
E1 = -182.7936820871667  E_coul = 54.27890852742752
cycle= 2 E= -128.514773559739  delta_E= -0.00283  |g|= 0.107  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.256962
diis-c [-5.71903886e-04  3.36468478e-01  6.63531522e-01]
  HOMO = -0.845788112923433  LUMO = 0.778208790917398
  mo_energy =
[-3.27827376e+01 -1.93116248e+00 -8.45788113e-01 -8.45788113e-01
 -8.45788113e-01  7.78208791e-01  7.78208791e-01  7.78208791e-01
  1.22473854e+00  3.48789136e+00  3.48789136e+00  3.48789136e+00
  7.57764264e+00  1.27794427e+01  1.27794427e+01  1.27794427e+01
  3.54112140e+01  5.69733358e+01  5.69733358e+01  5.69733358e+01
  1.39891728e+02  5.04137544e+02  1.87170110e+03  8.00120534e+03
  4.77686446e+04]
E1 = -182.5291857235182  E_coul = 54.013431167977444
cycle= 3 E= -128.515754555541  delta_E= -0.000981  |g|= 0.000203  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000278932
diis-c [-2.85868076e-08 -1.46488488e-03 -3.61937539e-03  1.00508426e+00]
  HOMO = -0.845802977180439  LUMO = 0.778252530015621
  mo_energy =
[-3.27827085e+01 -1.93114062e+00 -8.45802977e-01 -8.45802977e-01
 -8.45802977e-01  7.78252530e-01  7.78252530e-01  7.78252530e-01
  1.22479597e+00  3.48795101e+00  3.48795101e+00  3.48795101e+00
  7.57768886e+00  1.27795018e+01  1.27795018e+01  1.27795018e+01
  3.54112582e+01  5.69733742e+01  5.69733742e+01  5.69733742e+01
  1.39891764e+02  5.04137562e+02  1.87170108e+03  8.00120529e+03
  4.77686445e+04]
E1 = -182.52883645762998  E_coul = 54.013081898058
cycle= 4 E= -128.515754559572  delta_E= -4.03e-09  |g|= 2.69e-05  |ddm|= 0.000156
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.58551e-05
diis-c [-3.38769895e-10 -4.10969094e-05  1.40526593e-04 -1.68986782e-02
  1.01679925e+00]
  HOMO = -0.845812558127902  LUMO = 0.778250704591529
  mo_energy =
[-3.27827253e+01 -1.93114693e+00 -8.45812558e-01 -8.45812558e-01
 -8.45812558e-01  7.78250705e-01  7.78250705e-01  7.78250705e-01
  1.22479385e+00  3.48794373e+00  3.48794373e+00  3.48794373e+00
  7.57767787e+00  1.27794887e+01  1.27794887e+01  1.27794887e+01
  3.54112420e+01  5.69733578e+01  5.69733578e+01  5.69733578e+01
  1.39891749e+02  5.04137547e+02  1.87170107e+03  8.00120528e+03
  4.77686445e+04]
E1 = -182.5288895908296  E_coul = 54.013135031163074
cycle= 5 E= -128.515754559667  delta_E= -9.46e-11  |g|= 3.1e-06  |ddm|= 1.78e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5288895908296  E_coul = 54.013135031163074
  HOMO = -0.845812672393906  LUMO = 0.778250758329923
  mo_energy =
[-3.27827255e+01 -1.93114622e+00 -8.45812672e-01 -8.45812672e-01
 -8.45812672e-01  7.78250758e-01  7.78250758e-01  7.78250758e-01
  1.22479435e+00  3.48794377e+00  3.48794377e+00  3.48794377e+00
  7.57767812e+00  1.27794887e+01  1.27794887e+01  1.27794887e+01
  3.54112420e+01  5.69733577e+01  5.69733577e+01  5.69733577e+01
  1.39891748e+02  5.04137547e+02  1.87170107e+03  8.00120527e+03
  4.77686445e+04]
E1 = -182.52889130573195  E_coul = 54.01313674606366
Extra cycle  E= -128.515754559668  delta_E= -1.76e-12  |g|= 7.28e-07  |ddm|= 2.61e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809681e+01 1.01219710e+01 2.71465640e+01 3.87700237e-01
 3.00879690e+00 1.14534779e+00 2.12889854e+00 6.75875455e+00
 2.83013197e+01 2.67718009e-01 7.31403072e-01]
E = -128.5157545596683
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434333        1
[INPUT] 0    0    [1    /1   ]  235.721742543        1
[INPUT] 0    0    [1    /1   ]  76.4809680769        1
[INPUT] 0    0    [1    /1   ]  10.1219710035        1
[INPUT] 0    0    [1    /1   ]  27.14656395          1
[INPUT] 0    0    [1    /1   ]  0.387700236895       1
[INPUT] 0    0    [1    /1   ]  3.00879689766        1
[INPUT] 0    0    [1    /1   ]  1.14534778633        1
[INPUT] 1    0    [1    /1   ]  2.12889854103        1
[INPUT] 1    0    [1    /1   ]  6.75875454827        1
[INPUT] 1    0    [1    /1   ]  28.3013197109        1
[INPUT] 1    0    [1    /1   ]  0.267718009463       1
[INPUT] 1    0    [1    /1   ]  0.731403072458       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.7941314117, 1.0]], [0, [3661.454398066255, 1.0]], [0, [833.272434332643, 1.0]], [0, [235.72174254273858, 1.0]], [0, [76.48096807689656, 1.0]], [0, [10.121971003452073, 1.0]], [0, [27.14656395002591, 1.0]], [0, [0.38770023689512223, 1.0]], [0, [3.008796897660096, 1.0]], [0, [1.1453477863329442, 1.0]], [1, [2.128898541034843, 1.0]], [1, [6.758754548265384, 1.0]], [1, [28.301319710859616, 1.0]], [1, [0.2677180094629153, 1.0]], [1, [0.7314030724578159, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243433]
bas 3, expnt(s) = [235.72174254]
bas 4, expnt(s) = [76.48096808]
bas 5, expnt(s) = [10.121971]
bas 6, expnt(s) = [27.14656395]
bas 7, expnt(s) = [0.38770024]
bas 8, expnt(s) = [3.0087969]
bas 9, expnt(s) = [1.14534779]
bas 10, expnt(s) = [2.12889854]
bas 11, expnt(s) = [6.75875455]
bas 12, expnt(s) = [28.30131971]
bas 13, expnt(s) = [0.26771801]
bas 14, expnt(s) = [0.73140307]
CPU time:        38.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809681e+01 6.53401394e+01 1.01219710e+01 1.43371834e+01
 2.71465640e+01 3.00470040e+01 3.87700237e-01 1.24132949e+00
 3.00879690e+00 5.77177880e+00 1.14534779e+00 2.79716484e+00
 2.12889854e+00 7.50201793e+00 6.75875455e+00 3.17919917e+01
 2.83013197e+01 1.90433238e+02 2.67718009e-01 5.61799537e-01
 7.31403072e-01 1.97324208e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999283961415607
cond(S) = 356.45696872756156
E1 = -183.55675718052078  E_coul = 55.075250649880985
init E= -128.48150653064
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771462163653573  LUMO = 0.794256707494943
  mo_energy =
[-3.25566418e+01 -1.85285964e+00 -7.71462164e-01 -7.71462164e-01
 -7.71462164e-01  7.94256707e-01  7.94256707e-01  7.94256707e-01
  1.25641525e+00  3.54761124e+00  3.54761124e+00  3.54761124e+00
  7.67083070e+00  1.29072705e+01  1.29072705e+01  1.29072705e+01
  3.55827434e+01  5.71776179e+01  5.71776179e+01  5.71776179e+01
  1.40114229e+02  5.04394905e+02  1.87198954e+03  8.00152028e+03
  4.77689774e+04]
E1 = -182.00317257743527  E_coul = 53.491227842544205
cycle= 1 E= -128.511944734891  delta_E= -0.0304  |g|= 0.213  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505109
diis-c [-0.25513514  1.        ]
  HOMO = -0.882771312644814  LUMO = 0.769978903883218
  mo_energy =
[-3.28948098e+01 -1.97011200e+00 -8.82771313e-01 -8.82771313e-01
 -8.82771313e-01  7.69978904e-01  7.69978904e-01  7.69978904e-01
  1.20904980e+00  3.45837338e+00  3.45837338e+00  3.45837338e+00
  7.53164384e+00  1.27154891e+01  1.27154891e+01  1.27154891e+01
  3.53250815e+01  5.68715850e+01  5.68715850e+01  5.68715850e+01
  1.39781716e+02  5.04016342e+02  1.87157439e+03  8.00107602e+03
  4.77685143e+04]
E1 = -182.7936820871667  E_coul = 54.27890852742752
cycle= 2 E= -128.514773559739  delta_E= -0.00283  |g|= 0.107  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.256962
diis-c [-5.71903886e-04  3.36468478e-01  6.63531522e-01]
  HOMO = -0.845788112923433  LUMO = 0.778208790917398
  mo_energy =
[-3.27827376e+01 -1.93116248e+00 -8.45788113e-01 -8.45788113e-01
 -8.45788113e-01  7.78208791e-01  7.78208791e-01  7.78208791e-01
  1.22473854e+00  3.48789136e+00  3.48789136e+00  3.48789136e+00
  7.57764264e+00  1.27794427e+01  1.27794427e+01  1.27794427e+01
  3.54112140e+01  5.69733358e+01  5.69733358e+01  5.69733358e+01
  1.39891728e+02  5.04137544e+02  1.87170110e+03  8.00120534e+03
  4.77686446e+04]
E1 = -182.5291857235182  E_coul = 54.013431167977444
cycle= 3 E= -128.515754555541  delta_E= -0.000981  |g|= 0.000203  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000278932
diis-c [-2.85868076e-08 -1.46488488e-03 -3.61937539e-03  1.00508426e+00]
  HOMO = -0.845802977180439  LUMO = 0.778252530015621
  mo_energy =
[-3.27827085e+01 -1.93114062e+00 -8.45802977e-01 -8.45802977e-01
 -8.45802977e-01  7.78252530e-01  7.78252530e-01  7.78252530e-01
  1.22479597e+00  3.48795101e+00  3.48795101e+00  3.48795101e+00
  7.57768886e+00  1.27795018e+01  1.27795018e+01  1.27795018e+01
  3.54112582e+01  5.69733742e+01  5.69733742e+01  5.69733742e+01
  1.39891764e+02  5.04137562e+02  1.87170108e+03  8.00120529e+03
  4.77686445e+04]
E1 = -182.52883645762998  E_coul = 54.013081898058
cycle= 4 E= -128.515754559572  delta_E= -4.03e-09  |g|= 2.69e-05  |ddm|= 0.000156
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=5.58551e-05
diis-c [-3.38769895e-10 -4.10969094e-05  1.40526593e-04 -1.68986782e-02
  1.01679925e+00]
  HOMO = -0.845812558127902  LUMO = 0.778250704591529
  mo_energy =
[-3.27827253e+01 -1.93114693e+00 -8.45812558e-01 -8.45812558e-01
 -8.45812558e-01  7.78250705e-01  7.78250705e-01  7.78250705e-01
  1.22479385e+00  3.48794373e+00  3.48794373e+00  3.48794373e+00
  7.57767787e+00  1.27794887e+01  1.27794887e+01  1.27794887e+01
  3.54112420e+01  5.69733578e+01  5.69733578e+01  5.69733578e+01
  1.39891749e+02  5.04137547e+02  1.87170107e+03  8.00120528e+03
  4.77686445e+04]
E1 = -182.5288895908296  E_coul = 54.013135031163074
cycle= 5 E= -128.515754559667  delta_E= -9.46e-11  |g|= 3.1e-06  |ddm|= 1.78e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5288895908296  E_coul = 54.013135031163074
  HOMO = -0.845812672393906  LUMO = 0.778250758329923
  mo_energy =
[-3.27827255e+01 -1.93114622e+00 -8.45812672e-01 -8.45812672e-01
 -8.45812672e-01  7.78250758e-01  7.78250758e-01  7.78250758e-01
  1.22479435e+00  3.48794377e+00  3.48794377e+00  3.48794377e+00
  7.57767812e+00  1.27794887e+01  1.27794887e+01  1.27794887e+01
  3.54112420e+01  5.69733577e+01  5.69733577e+01  5.69733577e+01
  1.39891748e+02  5.04137547e+02  1.87170107e+03  8.00120527e+03
  4.77686445e+04]
E1 = -182.52889130573195  E_coul = 54.01313674606366
Extra cycle  E= -128.515754559668  delta_E= -1.76e-12  |g|= 7.28e-07  |ddm|= 2.61e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 356.45696872756156
E1 = -182.52889130573195  E_coul = 54.01313674606366
init E= -128.515754559668
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845812579209407  LUMO = 0.778250794251813
  mo_energy =
[-3.27827252e+01 -1.93114594e+00 -8.45812579e-01 -8.45812579e-01
 -8.45812579e-01  7.78250794e-01  7.78250794e-01  7.78250794e-01
  1.22479450e+00  3.48794387e+00  3.48794387e+00  3.48794387e+00
  7.57767833e+00  1.27794889e+01  1.27794889e+01  1.27794889e+01
  3.54112423e+01  5.69733580e+01  5.69733580e+01  5.69733580e+01
  1.39891749e+02  5.04137547e+02  1.87170107e+03  8.00120527e+03
  4.77686445e+04]
E1 = -182.5288908522087  E_coul = 54.01313629254006
cycle= 1 E= -128.515754559669  delta_E= -3.41e-13  |g|= 1.56e-07  |ddm|= 5.18e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5288908522087  E_coul = 54.01313629254006
  HOMO = -0.845812617145566  LUMO = 0.778250788860899
  mo_energy =
[-3.27827253e+01 -1.93114594e+00 -8.45812617e-01 -8.45812617e-01
 -8.45812617e-01  7.78250789e-01  7.78250789e-01  7.78250789e-01
  1.22479451e+00  3.48794385e+00  3.48794385e+00  3.48794385e+00
  7.57767830e+00  1.27794888e+01  1.27794888e+01  1.27794888e+01
  3.54112422e+01  5.69733579e+01  5.69733579e+01  5.69733579e+01
  1.39891748e+02  5.04137547e+02  1.87170107e+03  8.00120527e+03
  4.77686445e+04]
E1 = -182.5288911716879  E_coul = 54.01313661201934
Extra cycle  E= -128.515754559669  delta_E= 8.53e-14  |g|= 5.54e-08  |ddm|= 1e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809681e+01 1.01219710e+01 2.71465640e+01 3.87700237e-01
 3.00879690e+00 1.14534779e+00 2.12889854e+00 6.75875455e+00
 2.83013197e+01 2.67718009e-01 7.31403072e-01]
grad_E = [ 2.45560173e-11 -1.21754708e-09  2.46426973e-08 -3.04990201e-07
  2.62282179e-06  6.60000318e-05 -1.67655405e-05  8.00270087e-04
  1.27626236e-04 -5.77369337e-04  3.64640749e-03 -5.41149823e-03
 -6.07619168e-04  6.12207469e-02 -2.68764249e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.2724343          1
[INPUT] 0    0    [1    /1   ]  235.721743005        1
[INPUT] 0    0    [1    /1   ]  76.480963022         1
[INPUT] 0    0    [1    /1   ]  10.1217655265        1
[INPUT] 0    0    [1    /1   ]  27.1466106589        1
[INPUT] 0    0    [1    /1   ]  0.384914049807       1
[INPUT] 0    0    [1    /1   ]  3.00892905628        1
[INPUT] 0    0    [1    /1   ]  1.13833987615        1
[INPUT] 1    0    [1    /1   ]  2.28346587279        1
[INPUT] 1    0    [1    /1   ]  7.06717387698        1
[INPUT] 1    0    [1    /1   ]  28.2857924092        1
[INPUT] 1    0    [1    /1   ]  0.276773786402       1
[INPUT] 1    0    [1    /1   ]  0.801840676891       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411636, 1.0]], [0, [3661.4543980677877, 1.0]], [0, [833.2724343002626, 1.0]], [0, [235.721743004692, 1.0]], [0, [76.48096302195032, 1.0]], [0, [10.12176552652118, 1.0]], [0, [27.14661065893902, 1.0]], [0, [0.38491404980697297, 1.0]], [0, [3.008929056282915, 1.0]], [0, [1.138339876146715, 1.0]], [1, [2.28346587278616, 1.0]], [1, [7.067173876978849, 1.0]], [1, [28.285792409197526, 1.0]], [1, [0.27677378640162476, 1.0]], [1, [0.8018406768910662, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.2724343]
bas 3, expnt(s) = [235.721743]
bas 4, expnt(s) = [76.48096302]
bas 5, expnt(s) = [10.12176553]
bas 6, expnt(s) = [27.14661066]
bas 7, expnt(s) = [0.38491405]
bas 8, expnt(s) = [3.00892906]
bas 9, expnt(s) = [1.13833988]
bas 10, expnt(s) = [2.28346587]
bas 11, expnt(s) = [7.06717388]
bas 12, expnt(s) = [28.28579241]
bas 13, expnt(s) = [0.27677379]
bas 14, expnt(s) = [0.80184068]
CPU time:        40.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809630e+01 6.53401361e+01 1.01217655e+01 1.43369651e+01
 2.71466107e+01 3.00470428e+01 3.84914050e-01 1.23463290e+00
 3.00892906e+00 5.77196894e+00 1.13833988e+00 2.78431897e+00
 2.28346587e+00 8.18893736e+00 7.06717388e+00 3.36156577e+01
 2.82857924e+01 1.90302647e+02 2.76773786e-01 5.85653289e-01
 8.01840677e-01 2.21357631e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999364233689027
cond(S) = 354.44331754201795
E1 = -183.56033347799334  E_coul = 55.07633449460638
init E= -128.483998983387
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771667103799908  LUMO = 0.843457290443476
  mo_energy =
[-3.25563809e+01 -1.85279491e+00 -7.71667104e-01 -7.71667104e-01
 -7.71667104e-01  8.43457290e-01  8.43457290e-01  8.43457290e-01
  1.24510271e+00  3.84428323e+00  3.84428323e+00  3.84428323e+00
  7.63638931e+00  1.38817455e+01  1.38817455e+01  1.38817455e+01
  3.55407718e+01  5.88270155e+01  5.88270155e+01  5.88270155e+01
  1.40075909e+02  5.04360344e+02  1.87195839e+03  8.00149276e+03
  4.77689545e+04]
E1 = -182.00817566556634  E_coul = 53.4944992403514
cycle= 1 E= -128.513676425215  delta_E= -0.0297  |g|= 0.212  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505143
diis-c [-0.25516974  1.        ]
  HOMO = -0.882967917627235  LUMO = 0.816504350410401
  mo_energy =
[-3.28935793e+01 -1.96996390e+00 -8.82967918e-01 -8.82967918e-01
 -8.82967918e-01  8.16504350e-01  8.16504350e-01  8.16504350e-01
  1.19784760e+00  3.74881917e+00  3.74881917e+00  3.74881917e+00
  7.49753698e+00  1.36854699e+01  1.36854699e+01  1.36854699e+01
  3.52835884e+01  5.85219097e+01  5.85219097e+01  5.85219097e+01
  1.39744374e+02  5.03983330e+02  1.87154507e+03  8.00105043e+03
  4.77684933e+04]
E1 = -182.79522474966805  E_coul = 54.278739279835754
cycle= 2 E= -128.516485469832  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.256634
diis-c [-5.89397144e-04  3.36143130e-01  6.63856870e-01]
  HOMO = -0.84614390888529  LUMO = 0.825503261410669
  mo_energy =
[-3.27818733e+01 -1.93118867e+00 -8.46143909e-01 -8.46143909e-01
 -8.46143909e-01  8.25503261e-01  8.25503261e-01  8.25503261e-01
  1.21331954e+00  3.78020600e+00  3.78020600e+00  3.78020600e+00
  7.54330303e+00  1.37507499e+01  1.37507499e+01  1.37507499e+01
  3.53694255e+01  5.86232195e+01  5.86232195e+01  5.86232195e+01
  1.39854024e+02  5.04104117e+02  1.87167133e+03  8.00117926e+03
  4.77686232e+04]
E1 = -182.53114494677158  E_coul = 54.013684020881186
cycle= 3 E= -128.51746092589  delta_E= -0.000975  |g|= 0.000175  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199363
diis-c [-2.62133996e-08 -1.56744043e-03 -2.93349301e-03  1.00450093e+00]
  HOMO = -0.846222951681241  LUMO = 0.825522481205341
  mo_energy =
[-3.27819618e+01 -1.93123818e+00 -8.46222952e-01 -8.46222952e-01
 -8.46222952e-01  8.25522481e-01  8.25522481e-01  8.25522481e-01
  1.21332670e+00  3.78020013e+00  3.78020013e+00  3.78020013e+00
  7.54327354e+00  1.37507159e+01  1.37507159e+01  1.37507159e+01
  3.53693689e+01  5.86231450e+01  5.86231450e+01  5.86231450e+01
  1.39853942e+02  5.04103998e+02  1.87167116e+03  8.00117905e+03
  4.77686229e+04]
E1 = -182.53090806241326  E_coul = 54.0134471334011
cycle= 4 E= -128.517460929012  delta_E= -3.12e-09  |g|= 3.65e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.72903e-05
diis-c [-2.62110615e-10 -4.19683453e-05  2.16099420e-04 -2.79751003e-02
  1.02780097e+00]
  HOMO = -0.84624120765152  LUMO = 0.825517016092939
  mo_energy =
[-3.27819919e+01 -1.93125510e+00 -8.46241208e-01 -8.46241208e-01
 -8.46241208e-01  8.25517016e-01  8.25517016e-01  8.25517016e-01
  1.21331740e+00  3.78018344e+00  3.78018344e+00  3.78018344e+00
  7.54325177e+00  1.37506905e+01  1.37506905e+01  1.37506905e+01
  3.53693400e+01  5.86231154e+01  5.86231154e+01  5.86231154e+01
  1.39853913e+02  5.04103970e+02  1.87167113e+03  8.00117902e+03
  4.77686229e+04]
E1 = -182.53097099345166  E_coul = 54.01351006433197
cycle= 5 E= -128.51746092912  delta_E= -1.08e-10  |g|= 1.98e-06  |ddm|= 1.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53097099345166  E_coul = 54.01351006433197
  HOMO = -0.846242128201319  LUMO = 0.825516728489177
  mo_energy =
[-3.27819934e+01 -1.93125566e+00 -8.46242128e-01 -8.46242128e-01
 -8.46242128e-01  8.25516728e-01  8.25516728e-01  8.25516728e-01
  1.21331704e+00  3.78018260e+00  3.78018260e+00  3.78018260e+00
  7.54325087e+00  1.37506893e+01  1.37506893e+01  1.37506893e+01
  3.53693387e+01  5.86231140e+01  5.86231140e+01  5.86231140e+01
  1.39853911e+02  5.04103968e+02  1.87167113e+03  8.00117902e+03
  4.77686229e+04]
E1 = -182.53097305637561  E_coul = 54.01351212725535
Extra cycle  E= -128.51746092912  delta_E= -5.68e-13  |g|= 4.69e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809630e+01 1.01217655e+01 2.71466107e+01 3.84914050e-01
 3.00892906e+00 1.13833988e+00 2.28346587e+00 7.06717388e+00
 2.82857924e+01 2.76773786e-01 8.01840677e-01]
E = -128.51746092912026
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.2724343          1
[INPUT] 0    0    [1    /1   ]  235.721743005        1
[INPUT] 0    0    [1    /1   ]  76.480963022         1
[INPUT] 0    0    [1    /1   ]  10.1217655265        1
[INPUT] 0    0    [1    /1   ]  27.1466106589        1
[INPUT] 0    0    [1    /1   ]  0.384914049807       1
[INPUT] 0    0    [1    /1   ]  3.00892905628        1
[INPUT] 0    0    [1    /1   ]  1.13833987615        1
[INPUT] 1    0    [1    /1   ]  2.28346587279        1
[INPUT] 1    0    [1    /1   ]  7.06717387698        1
[INPUT] 1    0    [1    /1   ]  28.2857924092        1
[INPUT] 1    0    [1    /1   ]  0.276773786402       1
[INPUT] 1    0    [1    /1   ]  0.801840676891       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411636, 1.0]], [0, [3661.4543980677877, 1.0]], [0, [833.2724343002626, 1.0]], [0, [235.721743004692, 1.0]], [0, [76.48096302195032, 1.0]], [0, [10.12176552652118, 1.0]], [0, [27.14661065893902, 1.0]], [0, [0.38491404980697297, 1.0]], [0, [3.008929056282915, 1.0]], [0, [1.138339876146715, 1.0]], [1, [2.28346587278616, 1.0]], [1, [7.067173876978849, 1.0]], [1, [28.285792409197526, 1.0]], [1, [0.27677378640162476, 1.0]], [1, [0.8018406768910662, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.2724343]
bas 3, expnt(s) = [235.721743]
bas 4, expnt(s) = [76.48096302]
bas 5, expnt(s) = [10.12176553]
bas 6, expnt(s) = [27.14661066]
bas 7, expnt(s) = [0.38491405]
bas 8, expnt(s) = [3.00892906]
bas 9, expnt(s) = [1.13833988]
bas 10, expnt(s) = [2.28346587]
bas 11, expnt(s) = [7.06717388]
bas 12, expnt(s) = [28.28579241]
bas 13, expnt(s) = [0.27677379]
bas 14, expnt(s) = [0.80184068]
CPU time:        41.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721743e+02 1.51989910e+02
 7.64809630e+01 6.53401361e+01 1.01217655e+01 1.43369651e+01
 2.71466107e+01 3.00470428e+01 3.84914050e-01 1.23463290e+00
 3.00892906e+00 5.77196894e+00 1.13833988e+00 2.78431897e+00
 2.28346587e+00 8.18893736e+00 7.06717388e+00 3.36156577e+01
 2.82857924e+01 1.90302647e+02 2.76773786e-01 5.85653289e-01
 8.01840677e-01 2.21357631e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999364233689027
cond(S) = 354.44331754201795
E1 = -183.56033347799334  E_coul = 55.07633449460638
init E= -128.483998983387
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771667103799908  LUMO = 0.843457290443476
  mo_energy =
[-3.25563809e+01 -1.85279491e+00 -7.71667104e-01 -7.71667104e-01
 -7.71667104e-01  8.43457290e-01  8.43457290e-01  8.43457290e-01
  1.24510271e+00  3.84428323e+00  3.84428323e+00  3.84428323e+00
  7.63638931e+00  1.38817455e+01  1.38817455e+01  1.38817455e+01
  3.55407718e+01  5.88270155e+01  5.88270155e+01  5.88270155e+01
  1.40075909e+02  5.04360344e+02  1.87195839e+03  8.00149276e+03
  4.77689545e+04]
E1 = -182.00817566556634  E_coul = 53.4944992403514
cycle= 1 E= -128.513676425215  delta_E= -0.0297  |g|= 0.212  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505143
diis-c [-0.25516974  1.        ]
  HOMO = -0.882967917627235  LUMO = 0.816504350410401
  mo_energy =
[-3.28935793e+01 -1.96996390e+00 -8.82967918e-01 -8.82967918e-01
 -8.82967918e-01  8.16504350e-01  8.16504350e-01  8.16504350e-01
  1.19784760e+00  3.74881917e+00  3.74881917e+00  3.74881917e+00
  7.49753698e+00  1.36854699e+01  1.36854699e+01  1.36854699e+01
  3.52835884e+01  5.85219097e+01  5.85219097e+01  5.85219097e+01
  1.39744374e+02  5.03983330e+02  1.87154507e+03  8.00105043e+03
  4.77684933e+04]
E1 = -182.79522474966805  E_coul = 54.278739279835754
cycle= 2 E= -128.516485469832  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.256634
diis-c [-5.89397144e-04  3.36143130e-01  6.63856870e-01]
  HOMO = -0.84614390888529  LUMO = 0.825503261410669
  mo_energy =
[-3.27818733e+01 -1.93118867e+00 -8.46143909e-01 -8.46143909e-01
 -8.46143909e-01  8.25503261e-01  8.25503261e-01  8.25503261e-01
  1.21331954e+00  3.78020600e+00  3.78020600e+00  3.78020600e+00
  7.54330303e+00  1.37507499e+01  1.37507499e+01  1.37507499e+01
  3.53694255e+01  5.86232195e+01  5.86232195e+01  5.86232195e+01
  1.39854024e+02  5.04104117e+02  1.87167133e+03  8.00117926e+03
  4.77686232e+04]
E1 = -182.53114494677158  E_coul = 54.013684020881186
cycle= 3 E= -128.51746092589  delta_E= -0.000975  |g|= 0.000175  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199363
diis-c [-2.62133996e-08 -1.56744043e-03 -2.93349301e-03  1.00450093e+00]
  HOMO = -0.846222951681241  LUMO = 0.825522481205341
  mo_energy =
[-3.27819618e+01 -1.93123818e+00 -8.46222952e-01 -8.46222952e-01
 -8.46222952e-01  8.25522481e-01  8.25522481e-01  8.25522481e-01
  1.21332670e+00  3.78020013e+00  3.78020013e+00  3.78020013e+00
  7.54327354e+00  1.37507159e+01  1.37507159e+01  1.37507159e+01
  3.53693689e+01  5.86231450e+01  5.86231450e+01  5.86231450e+01
  1.39853942e+02  5.04103998e+02  1.87167116e+03  8.00117905e+03
  4.77686229e+04]
E1 = -182.53090806241326  E_coul = 54.0134471334011
cycle= 4 E= -128.517460929012  delta_E= -3.12e-09  |g|= 3.65e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.72903e-05
diis-c [-2.62110615e-10 -4.19683453e-05  2.16099420e-04 -2.79751003e-02
  1.02780097e+00]
  HOMO = -0.84624120765152  LUMO = 0.825517016092939
  mo_energy =
[-3.27819919e+01 -1.93125510e+00 -8.46241208e-01 -8.46241208e-01
 -8.46241208e-01  8.25517016e-01  8.25517016e-01  8.25517016e-01
  1.21331740e+00  3.78018344e+00  3.78018344e+00  3.78018344e+00
  7.54325177e+00  1.37506905e+01  1.37506905e+01  1.37506905e+01
  3.53693400e+01  5.86231154e+01  5.86231154e+01  5.86231154e+01
  1.39853913e+02  5.04103970e+02  1.87167113e+03  8.00117902e+03
  4.77686229e+04]
E1 = -182.53097099345166  E_coul = 54.01351006433197
cycle= 5 E= -128.51746092912  delta_E= -1.08e-10  |g|= 1.98e-06  |ddm|= 1.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53097099345166  E_coul = 54.01351006433197
  HOMO = -0.846242128201319  LUMO = 0.825516728489177
  mo_energy =
[-3.27819934e+01 -1.93125566e+00 -8.46242128e-01 -8.46242128e-01
 -8.46242128e-01  8.25516728e-01  8.25516728e-01  8.25516728e-01
  1.21331704e+00  3.78018260e+00  3.78018260e+00  3.78018260e+00
  7.54325087e+00  1.37506893e+01  1.37506893e+01  1.37506893e+01
  3.53693387e+01  5.86231140e+01  5.86231140e+01  5.86231140e+01
  1.39853911e+02  5.04103968e+02  1.87167113e+03  8.00117902e+03
  4.77686229e+04]
E1 = -182.53097305637561  E_coul = 54.01351212725535
Extra cycle  E= -128.51746092912  delta_E= -5.68e-13  |g|= 4.69e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 354.44331754201795
E1 = -182.53097305637561  E_coul = 54.01351212725535
init E= -128.51746092912
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.846242019768432  LUMO = 0.825516749249617
  mo_energy =
[-3.27819929e+01 -1.93125547e+00 -8.46242020e-01 -8.46242020e-01
 -8.46242020e-01  8.25516749e-01  8.25516749e-01  8.25516749e-01
  1.21331710e+00  3.78018269e+00  3.78018269e+00  3.78018269e+00
  7.54325105e+00  1.37506896e+01  1.37506896e+01  1.37506896e+01
  3.53693391e+01  5.86231145e+01  5.86231145e+01  5.86231145e+01
  1.39853912e+02  5.04103969e+02  1.87167113e+03  8.00117902e+03
  4.77686229e+04]
E1 = -182.53097173676562  E_coul = 54.0135108076454
cycle= 1 E= -128.51746092912  delta_E= 5.68e-14  |g|= 1.8e-07  |ddm|= 2.96e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53097173676562  E_coul = 54.0135108076454
  HOMO = -0.846242118485699  LUMO = 0.825516724869412
  mo_energy =
[-3.27819932e+01 -1.93125555e+00 -8.46242118e-01 -8.46242118e-01
 -8.46242118e-01  8.25516725e-01  8.25516725e-01  8.25516725e-01
  1.21331707e+00  3.78018261e+00  3.78018261e+00  3.78018261e+00
  7.54325094e+00  1.37506894e+01  1.37506894e+01  1.37506894e+01
  3.53693389e+01  5.86231142e+01  5.86231142e+01  5.86231142e+01
  1.39853911e+02  5.04103969e+02  1.87167113e+03  8.00117902e+03
  4.77686229e+04]
E1 = -182.53097238932767  E_coul = 54.013511460207425
Extra cycle  E= -128.51746092912  delta_E= -5.68e-14  |g|= 9.12e-08  |ddm|= 5.98e-08
    CPU time for scf_cycle      0.26 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721743e+02
 7.64809630e+01 1.01217655e+01 2.71466107e+01 3.84914050e-01
 3.00892906e+00 1.13833988e+00 2.28346587e+00 7.06717388e+00
 2.82857924e+01 2.76773786e-01 8.01840677e-01]
grad_E = [ 3.37798314e-11 -1.70278729e-09  3.44545378e-08 -4.25328080e-07
  3.64744293e-06  9.09811911e-05 -2.31468703e-05  6.15591117e-04
  1.75041964e-04 -7.55189410e-04 -3.88798083e-03 -1.24654794e-03
 -1.27462862e-03  3.70617470e-02 -5.53362539e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434238        1
[INPUT] 0    0    [1    /1   ]  235.721743809        1
[INPUT] 0    0    [1    /1   ]  76.4809554179        1
[INPUT] 0    0    [1    /1   ]  10.1215242665        1
[INPUT] 0    0    [1    /1   ]  27.1466684212        1
[INPUT] 0    0    [1    /1   ]  0.382685689658       1
[INPUT] 0    0    [1    /1   ]  3.00881602217        1
[INPUT] 0    0    [1    /1   ]  1.13452303312        1
[INPUT] 1    0    [1    /1   ]  2.4041290658         1
[INPUT] 1    0    [1    /1   ]  7.26697938438        1
[INPUT] 1    0    [1    /1   ]  28.2774147047        1
[INPUT] 1    0    [1    /1   ]  0.276601464437       1
[INPUT] 1    0    [1    /1   ]  0.852551381765       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411552, 1.0]], [0, [3661.4543980708004, 1.0]], [0, [833.2724342383972, 1.0]], [0, [235.72174380858826, 1.0]], [0, [76.48095541787762, 1.0]], [0, [10.121524266486249, 1.0]], [0, [27.146668421228167, 1.0]], [0, [0.3826856896581926, 1.0]], [0, [3.0088160221734643, 1.0]], [0, [1.134523033121805, 1.0]], [1, [2.4041290657971905, 1.0]], [1, [7.2669793843785815, 1.0]], [1, [28.277414704710615, 1.0]], [1, [0.27660146443720895, 1.0]], [1, [0.852551381764696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243424]
bas 3, expnt(s) = [235.72174381]
bas 4, expnt(s) = [76.48095542]
bas 5, expnt(s) = [10.12152427]
bas 6, expnt(s) = [27.14666842]
bas 7, expnt(s) = [0.38268569]
bas 8, expnt(s) = [3.00881602]
bas 9, expnt(s) = [1.13452303]
bas 10, expnt(s) = [2.40412907]
bas 11, expnt(s) = [7.26697938]
bas 12, expnt(s) = [28.2774147]
bas 13, expnt(s) = [0.27660146]
bas 14, expnt(s) = [0.85255138]
CPU time:        43.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721744e+02 1.51989910e+02
 7.64809554e+01 6.53401313e+01 1.01215243e+01 1.43367088e+01
 2.71466684e+01 3.00470907e+01 3.82685690e-01 1.22926832e+00
 3.00881602e+00 5.77180632e+00 1.13452303e+00 2.77731418e+00
 2.40412907e+00 8.73336510e+00 7.26697938e+00 3.48078183e+01
 2.82774147e+01 1.90232195e+02 2.76601464e-01 5.85197533e-01
 8.52551382e-01 2.38992953e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999404886345475
cond(S) = 353.15671634994106
E1 = -183.56095256351023  E_coul = 55.07644033469497
init E= -128.484512228815
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771754457596073  LUMO = 0.860631173081371
  mo_energy =
[-3.25563204e+01 -1.85280572e+00 -7.71754458e-01 -7.71754458e-01
 -7.71754458e-01  8.60631173e-01  8.60631173e-01  8.60631173e-01
  1.23703905e+00  4.03961069e+00  4.03961069e+00  4.03961069e+00
  7.61403098e+00  1.45685722e+01  1.45685722e+01  1.45685722e+01
  3.55138300e+01  5.99685909e+01  5.99685909e+01  5.99685909e+01
  1.40051121e+02  5.04337924e+02  1.87193816e+03  8.00147487e+03
  4.77689396e+04]
E1 = -181.99603578714553  E_coul = 53.48185990476067
cycle= 1 E= -128.514175882385  delta_E= -0.0297  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50655
diis-c [-0.25659322  1.        ]
  HOMO = -0.88419521738087  LUMO = 0.831782980784258
  mo_energy =
[-3.28952284e+01 -1.97123044e+00 -8.84195217e-01 -8.84195217e-01
 -8.84195217e-01  8.31782981e-01  8.31782981e-01  8.31782981e-01
  1.18900933e+00  3.93843130e+00  3.93843130e+00  3.93843130e+00
  7.47398773e+00  1.43675714e+01  1.43675714e+01  1.43675714e+01
  3.52549904e+01  5.96618864e+01  5.96618864e+01  5.96618864e+01
  1.39717923e+02  5.03959511e+02  1.87152360e+03  8.00103135e+03
  4.77684773e+04]
E1 = -182.7873127308675  E_coul = 54.270309856198494
cycle= 2 E= -128.517002874669  delta_E= -0.00283  |g|= 0.108  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257841
diis-c [-6.06972317e-04  3.36555340e-01  6.63444660e-01]
  HOMO = -0.847200094191649  LUMO = 0.841262329850295
  mo_energy =
[-3.27829760e+01 -1.93227312e+00 -8.47200094e-01 -8.47200094e-01
 -8.47200094e-01  8.41262330e-01  8.41262330e-01  8.41262330e-01
  1.20446028e+00  3.97144055e+00  3.97144055e+00  3.97144055e+00
  7.51995231e+00  1.44342307e+01  1.44342307e+01  1.44342307e+01
  3.53412553e+01  5.97636289e+01  5.97636289e+01  5.97636289e+01
  1.39828108e+02  5.04080867e+02  1.87165044e+03  8.00116077e+03
  4.77686077e+04]
E1 = -182.52034157656092  E_coul = 54.00234764458652
cycle= 3 E= -128.517993931974  delta_E= -0.000991  |g|= 0.000307  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000376558
diis-c [-5.87718491e-08 -1.86954923e-03 -2.64423831e-03  1.00451379e+00]
  HOMO = -0.847359251012588  LUMO = 0.841248885317927
  mo_energy =
[-3.27831919e+01 -1.93241956e+00 -8.47359251e-01 -8.47359251e-01
 -8.47359251e-01  8.41248885e-01  8.41248885e-01  8.41248885e-01
  1.20440167e+00  3.97134942e+00  3.97134942e+00  3.97134942e+00
  7.51982441e+00  1.44340839e+01  1.44340839e+01  1.44340839e+01
  3.53410801e+01  5.97634292e+01  5.97634292e+01  5.97634292e+01
  1.39827899e+02  5.04080615e+02  1.87165013e+03  8.00116041e+03
  4.77686073e+04]
E1 = -182.52020972653975  E_coul = 54.00221578470949
cycle= 4 E= -128.51799394183  delta_E= -9.86e-09  |g|= 5.47e-05  |ddm|= 0.000196
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.8357e-05
diis-c [-4.92235135e-10  5.11627650e-05  3.95364582e-04 -1.01745069e-01
  1.10129854e+00]
  HOMO = -0.847388717792475  LUMO = 0.841238613157369
  mo_energy =
[-3.27832381e+01 -1.93245193e+00 -8.47388718e-01 -8.47388718e-01
 -8.47388718e-01  8.41238613e-01  8.41238613e-01  8.41238613e-01
  1.20438218e+00  3.97132008e+00  3.97132008e+00  3.97132008e+00
  7.51978750e+00  1.44340425e+01  1.44340425e+01  1.44340425e+01
  3.53410345e+01  5.97633832e+01  5.97633832e+01  5.97633832e+01
  1.39827854e+02  5.04080572e+02  1.87165009e+03  8.00116038e+03
  4.77686072e+04]
E1 = -182.52028547398214  E_coul = 54.002291531915155
cycle= 5 E= -128.517993942067  delta_E= -2.37e-10  |g|= 1.95e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52028547398214  E_coul = 54.002291531915155
  HOMO = -0.847387973336936  LUMO = 0.841238746831666
  mo_energy =
[-3.27832359e+01 -1.93245142e+00 -8.47387973e-01 -8.47387973e-01
 -8.47387973e-01  8.41238747e-01  8.41238747e-01  8.41238747e-01
  1.20438223e+00  3.97132067e+00  3.97132067e+00  3.97132067e+00
  7.51978831e+00  1.44340438e+01  1.44340438e+01  1.44340438e+01
  3.53410363e+01  5.97633852e+01  5.97633852e+01  5.97633852e+01
  1.39827856e+02  5.04080575e+02  1.87165009e+03  8.00116038e+03
  4.77686072e+04]
E1 = -182.52027830557066  E_coul = 54.00228436350336
Extra cycle  E= -128.517993942067  delta_E= -3.13e-13  |g|= 1e-06  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721744e+02
 7.64809554e+01 1.01215243e+01 2.71466684e+01 3.82685690e-01
 3.00881602e+00 1.13452303e+00 2.40412907e+00 7.26697938e+00
 2.82774147e+01 2.76601464e-01 8.52551382e-01]
E = -128.5179939420673
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434238        1
[INPUT] 0    0    [1    /1   ]  235.721743809        1
[INPUT] 0    0    [1    /1   ]  76.4809554179        1
[INPUT] 0    0    [1    /1   ]  10.1215242665        1
[INPUT] 0    0    [1    /1   ]  27.1466684212        1
[INPUT] 0    0    [1    /1   ]  0.382685689658       1
[INPUT] 0    0    [1    /1   ]  3.00881602217        1
[INPUT] 0    0    [1    /1   ]  1.13452303312        1
[INPUT] 1    0    [1    /1   ]  2.4041290658         1
[INPUT] 1    0    [1    /1   ]  7.26697938438        1
[INPUT] 1    0    [1    /1   ]  28.2774147047        1
[INPUT] 1    0    [1    /1   ]  0.276601464437       1
[INPUT] 1    0    [1    /1   ]  0.852551381765       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411552, 1.0]], [0, [3661.4543980708004, 1.0]], [0, [833.2724342383972, 1.0]], [0, [235.72174380858826, 1.0]], [0, [76.48095541787762, 1.0]], [0, [10.121524266486249, 1.0]], [0, [27.146668421228167, 1.0]], [0, [0.3826856896581926, 1.0]], [0, [3.0088160221734643, 1.0]], [0, [1.134523033121805, 1.0]], [1, [2.4041290657971905, 1.0]], [1, [7.2669793843785815, 1.0]], [1, [28.277414704710615, 1.0]], [1, [0.27660146443720895, 1.0]], [1, [0.852551381764696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243424]
bas 3, expnt(s) = [235.72174381]
bas 4, expnt(s) = [76.48095542]
bas 5, expnt(s) = [10.12152427]
bas 6, expnt(s) = [27.14666842]
bas 7, expnt(s) = [0.38268569]
bas 8, expnt(s) = [3.00881602]
bas 9, expnt(s) = [1.13452303]
bas 10, expnt(s) = [2.40412907]
bas 11, expnt(s) = [7.26697938]
bas 12, expnt(s) = [28.2774147]
bas 13, expnt(s) = [0.27660146]
bas 14, expnt(s) = [0.85255138]
CPU time:        43.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721744e+02 1.51989910e+02
 7.64809554e+01 6.53401313e+01 1.01215243e+01 1.43367088e+01
 2.71466684e+01 3.00470907e+01 3.82685690e-01 1.22926832e+00
 3.00881602e+00 5.77180632e+00 1.13452303e+00 2.77731418e+00
 2.40412907e+00 8.73336510e+00 7.26697938e+00 3.48078183e+01
 2.82774147e+01 1.90232195e+02 2.76601464e-01 5.85197533e-01
 8.52551382e-01 2.38992953e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999404886345475
cond(S) = 353.15671634994106
E1 = -183.56095256351023  E_coul = 55.07644033469497
init E= -128.484512228815
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771754457596073  LUMO = 0.860631173081371
  mo_energy =
[-3.25563204e+01 -1.85280572e+00 -7.71754458e-01 -7.71754458e-01
 -7.71754458e-01  8.60631173e-01  8.60631173e-01  8.60631173e-01
  1.23703905e+00  4.03961069e+00  4.03961069e+00  4.03961069e+00
  7.61403098e+00  1.45685722e+01  1.45685722e+01  1.45685722e+01
  3.55138300e+01  5.99685909e+01  5.99685909e+01  5.99685909e+01
  1.40051121e+02  5.04337924e+02  1.87193816e+03  8.00147487e+03
  4.77689396e+04]
E1 = -181.99603578714553  E_coul = 53.48185990476067
cycle= 1 E= -128.514175882385  delta_E= -0.0297  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50655
diis-c [-0.25659322  1.        ]
  HOMO = -0.88419521738087  LUMO = 0.831782980784258
  mo_energy =
[-3.28952284e+01 -1.97123044e+00 -8.84195217e-01 -8.84195217e-01
 -8.84195217e-01  8.31782981e-01  8.31782981e-01  8.31782981e-01
  1.18900933e+00  3.93843130e+00  3.93843130e+00  3.93843130e+00
  7.47398773e+00  1.43675714e+01  1.43675714e+01  1.43675714e+01
  3.52549904e+01  5.96618864e+01  5.96618864e+01  5.96618864e+01
  1.39717923e+02  5.03959511e+02  1.87152360e+03  8.00103135e+03
  4.77684773e+04]
E1 = -182.7873127308675  E_coul = 54.270309856198494
cycle= 2 E= -128.517002874669  delta_E= -0.00283  |g|= 0.108  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257841
diis-c [-6.06972317e-04  3.36555340e-01  6.63444660e-01]
  HOMO = -0.847200094191649  LUMO = 0.841262329850295
  mo_energy =
[-3.27829760e+01 -1.93227312e+00 -8.47200094e-01 -8.47200094e-01
 -8.47200094e-01  8.41262330e-01  8.41262330e-01  8.41262330e-01
  1.20446028e+00  3.97144055e+00  3.97144055e+00  3.97144055e+00
  7.51995231e+00  1.44342307e+01  1.44342307e+01  1.44342307e+01
  3.53412553e+01  5.97636289e+01  5.97636289e+01  5.97636289e+01
  1.39828108e+02  5.04080867e+02  1.87165044e+03  8.00116077e+03
  4.77686077e+04]
E1 = -182.52034157656092  E_coul = 54.00234764458652
cycle= 3 E= -128.517993931974  delta_E= -0.000991  |g|= 0.000307  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000376558
diis-c [-5.87718491e-08 -1.86954923e-03 -2.64423831e-03  1.00451379e+00]
  HOMO = -0.847359251012588  LUMO = 0.841248885317927
  mo_energy =
[-3.27831919e+01 -1.93241956e+00 -8.47359251e-01 -8.47359251e-01
 -8.47359251e-01  8.41248885e-01  8.41248885e-01  8.41248885e-01
  1.20440167e+00  3.97134942e+00  3.97134942e+00  3.97134942e+00
  7.51982441e+00  1.44340839e+01  1.44340839e+01  1.44340839e+01
  3.53410801e+01  5.97634292e+01  5.97634292e+01  5.97634292e+01
  1.39827899e+02  5.04080615e+02  1.87165013e+03  8.00116041e+03
  4.77686073e+04]
E1 = -182.52020972653975  E_coul = 54.00221578470949
cycle= 4 E= -128.51799394183  delta_E= -9.86e-09  |g|= 5.47e-05  |ddm|= 0.000196
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.8357e-05
diis-c [-4.92235135e-10  5.11627650e-05  3.95364582e-04 -1.01745069e-01
  1.10129854e+00]
  HOMO = -0.847388717792475  LUMO = 0.841238613157369
  mo_energy =
[-3.27832381e+01 -1.93245193e+00 -8.47388718e-01 -8.47388718e-01
 -8.47388718e-01  8.41238613e-01  8.41238613e-01  8.41238613e-01
  1.20438218e+00  3.97132008e+00  3.97132008e+00  3.97132008e+00
  7.51978750e+00  1.44340425e+01  1.44340425e+01  1.44340425e+01
  3.53410345e+01  5.97633832e+01  5.97633832e+01  5.97633832e+01
  1.39827854e+02  5.04080572e+02  1.87165009e+03  8.00116038e+03
  4.77686072e+04]
E1 = -182.52028547398214  E_coul = 54.002291531915155
cycle= 5 E= -128.517993942067  delta_E= -2.37e-10  |g|= 1.95e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52028547398214  E_coul = 54.002291531915155
  HOMO = -0.847387973336936  LUMO = 0.841238746831666
  mo_energy =
[-3.27832359e+01 -1.93245142e+00 -8.47387973e-01 -8.47387973e-01
 -8.47387973e-01  8.41238747e-01  8.41238747e-01  8.41238747e-01
  1.20438223e+00  3.97132067e+00  3.97132067e+00  3.97132067e+00
  7.51978831e+00  1.44340438e+01  1.44340438e+01  1.44340438e+01
  3.53410363e+01  5.97633852e+01  5.97633852e+01  5.97633852e+01
  1.39827856e+02  5.04080575e+02  1.87165009e+03  8.00116038e+03
  4.77686072e+04]
E1 = -182.52027830557066  E_coul = 54.00228436350336
Extra cycle  E= -128.517993942067  delta_E= -3.13e-13  |g|= 1e-06  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 353.15671634994106
E1 = -182.52027830557066  E_coul = 54.00228436350336
init E= -128.517993942067
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.847388479801389  LUMO = 0.841238606507615
  mo_energy =
[-3.27832373e+01 -1.93245202e+00 -8.47388480e-01 -8.47388480e-01
 -8.47388480e-01  8.41238607e-01  8.41238607e-01  8.41238607e-01
  1.20438197e+00  3.97132020e+00  3.97132020e+00  3.97132020e+00
  7.51978765e+00  1.44340429e+01  1.44340429e+01  1.44340429e+01
  3.53410352e+01  5.97633839e+01  5.97633839e+01  5.97633839e+01
  1.39827854e+02  5.04080573e+02  1.87165009e+03  8.00116038e+03
  4.77686072e+04]
E1 = -182.5202816534366  E_coul = 54.00228771136904
cycle= 1 E= -128.517993942068  delta_E= -2.56e-13  |g|= 4.56e-07  |ddm|= 3.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5202816534366  E_coul = 54.00228771136904
  HOMO = -0.847388242206269  LUMO = 0.84123866590554
  mo_energy =
[-3.27832366e+01 -1.93245179e+00 -8.47388242e-01 -8.47388242e-01
 -8.47388242e-01  8.41238666e-01  8.41238666e-01  8.41238666e-01
  1.20438206e+00  3.97132041e+00  3.97132041e+00  3.97132041e+00
  7.51978794e+00  1.44340434e+01  1.44340434e+01  1.44340434e+01
  3.53410357e+01  5.97633846e+01  5.97633846e+01  5.97633846e+01
  1.39827855e+02  5.04080574e+02  1.87165009e+03  8.00116038e+03
  4.77686072e+04]
E1 = -182.52027989275078  E_coul = 54.00228595068327
Extra cycle  E= -128.517993942068  delta_E= 5.68e-14  |g|= 2.4e-07  |ddm|= 1.56e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721744e+02
 7.64809554e+01 1.01215243e+01 2.71466684e+01 3.82685690e-01
 3.00881602e+00 1.13452303e+00 2.40412907e+00 7.26697938e+00
 2.82774147e+01 2.76601464e-01 8.52551382e-01]
grad_E = [ 3.58805664e-11 -1.81333978e-09  3.66975070e-08 -4.53166249e-07
  3.89476642e-06  9.79124440e-05 -2.48304558e-05  2.76123987e-05
  1.78817575e-04 -6.33046068e-04 -8.29955579e-03  4.69529953e-04
 -1.59344094e-03 -6.06709504e-03  1.65850138e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434195        1
[INPUT] 0    0    [1    /1   ]  235.721744356        1
[INPUT] 0    0    [1    /1   ]  76.4809505854        1
[INPUT] 0    0    [1    /1   ]  10.1213931309        1
[INPUT] 0    0    [1    /1   ]  27.1467009736        1
[INPUT] 0    0    [1    /1   ]  0.382245888134       1
[INPUT] 0    0    [1    /1   ]  3.00863604672        1
[INPUT] 0    0    [1    /1   ]  1.1343857354         1
[INPUT] 1    0    [1    /1   ]  2.43495426407        1
[INPUT] 1    0    [1    /1   ]  7.30254312771        1
[INPUT] 1    0    [1    /1   ]  28.2773541271        1
[INPUT] 1    0    [1    /1   ]  0.278980331704       1
[INPUT] 1    0    [1    /1   ]  0.862822810555       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411505, 1.0]], [0, [3661.4543980729527, 1.0]], [0, [833.2724341946762, 1.0]], [0, [235.72174435582812, 1.0]], [0, [76.4809505854006, 1.0]], [0, [10.12139313088083, 1.0]], [0, [27.14670097360755, 1.0]], [0, [0.3822458881337635, 1.0]], [0, [3.0086360467236664, 1.0]], [0, [1.134385735400883, 1.0]], [1, [2.4349542640713087, 1.0]], [1, [7.302543127710573, 1.0]], [1, [28.27735412714463, 1.0]], [1, [0.2789803317037797, 1.0]], [1, [0.8628228105554465, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243419]
bas 3, expnt(s) = [235.72174436]
bas 4, expnt(s) = [76.48095059]
bas 5, expnt(s) = [10.12139313]
bas 6, expnt(s) = [27.14670097]
bas 7, expnt(s) = [0.38224589]
bas 8, expnt(s) = [3.00863605]
bas 9, expnt(s) = [1.13438574]
bas 10, expnt(s) = [2.43495426]
bas 11, expnt(s) = [7.30254313]
bas 12, expnt(s) = [28.27735413]
bas 13, expnt(s) = [0.27898033]
bas 14, expnt(s) = [0.86282281]
CPU time:        46.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721744e+02 1.51989910e+02
 7.64809506e+01 6.53401282e+01 1.01213931e+01 1.43365695e+01
 2.71467010e+01 3.00471177e+01 3.82245888e-01 1.22820862e+00
 3.00863605e+00 5.77154738e+00 1.13438574e+00 2.77706210e+00
 2.43495426e+00 8.87356026e+00 7.30254313e+00 3.50208801e+01
 2.82773541e+01 1.90231686e+02 2.78980332e-01 5.91495405e-01
 8.62822811e-01 2.42597553e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999383760942491
cond(S) = 353.00217376740966
E1 = -183.56111955959454  E_coul = 55.076531761162
init E= -128.484587798433
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771750841407676  LUMO = 0.870448988428936
  mo_energy =
[-3.25563266e+01 -1.85279208e+00 -7.71750841e-01 -7.71750841e-01
 -7.71750841e-01  8.70448988e-01  8.70448988e-01  8.70448988e-01
  1.23577062e+00  4.09237187e+00  4.09237187e+00  4.09237187e+00
  7.61140967e+00  1.47288158e+01  1.47288158e+01  1.47288158e+01
  3.55104596e+01  6.02142880e+01  6.02142880e+01  6.02142880e+01
  1.40047790e+02  5.04334914e+02  1.87193548e+03  8.00147252e+03
  4.77689376e+04]
E1 = -181.99860279305747  E_coul = 53.48434694486832
cycle= 1 E= -128.514255848189  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506208
diis-c [-0.25624632  1.        ]
  HOMO = -0.884017115989927  LUMO = 0.841236155070792
  mo_energy =
[-3.28947745e+01 -1.97100613e+00 -8.84017116e-01 -8.84017116e-01
 -8.84017116e-01  8.41236155e-01  8.41236155e-01  8.41236155e-01
  1.18790442e+00  3.99038159e+00  3.99038159e+00  3.99038159e+00
  7.47158994e+00  1.45275148e+01  1.45275148e+01  1.45275148e+01
  3.52519920e+01  5.99080765e+01  5.99080765e+01  5.99080765e+01
  1.39715036e+02  5.03956944e+02  1.87152135e+03  8.00102943e+03
  4.77684758e+04]
E1 = -182.78836689864173  E_coul = 54.27129131204335
cycle= 2 E= -128.517075586598  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25752
diis-c [-6.04900660e-04  3.36429064e-01  6.63570936e-01]
  HOMO = -0.847089115595333  LUMO = 0.850840363066226
  mo_energy =
[-3.27827000e+01 -1.93212143e+00 -8.47089116e-01 -8.47089116e-01
 -8.47089116e-01  8.50840363e-01  8.50840363e-01  8.50840363e-01
  1.20331287e+00  4.02365842e+00  4.02365842e+00  4.02365842e+00
  7.51746803e+00  1.45942629e+01  1.45942629e+01  1.45942629e+01
  3.53381143e+01  6.00096365e+01  6.00096365e+01  6.00096365e+01
  1.39825047e+02  5.04078111e+02  1.87164799e+03  8.00115864e+03
  4.77686060e+04]
E1 = -182.52203153468776  E_coul = 54.003968809557705
cycle= 3 E= -128.51806272513  delta_E= -0.000987  |g|= 0.000299  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000371901
diis-c [-5.41347440e-08 -1.85463318e-03 -2.60479650e-03  1.00445943e+00]
  HOMO = -0.847245608314261  LUMO = 0.850828248176073
  mo_energy =
[-3.27829119e+01 -1.93226294e+00 -8.47245608e-01 -8.47245608e-01
 -8.47245608e-01  8.50828248e-01  8.50828248e-01  8.50828248e-01
  1.20325813e+00  4.02356977e+00  4.02356977e+00  4.02356977e+00
  7.51734383e+00  1.45941192e+01  1.45941192e+01  1.45941192e+01
  3.53379429e+01  6.00094408e+01  6.00094408e+01  6.00094408e+01
  1.39824841e+02  5.04077863e+02  1.87164769e+03  8.00115829e+03
  4.77686056e+04]
E1 = -182.52190929896432  E_coul = 54.0038465648099
cycle= 4 E= -128.518062734154  delta_E= -9.02e-09  |g|= 5.33e-05  |ddm|= 0.000191
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.79448e-05
diis-c [-4.45993728e-10  4.36506110e-05  3.85218784e-04 -9.56910845e-02
  1.09526222e+00]
  HOMO = -0.847274290775745  LUMO = 0.850818234590915
  mo_energy =
[-3.27829571e+01 -1.93229387e+00 -8.47274291e-01 -8.47274291e-01
 -8.47274291e-01  8.50818235e-01  8.50818235e-01  8.50818235e-01
  1.20323965e+00  4.02354118e+00  4.02354118e+00  4.02354118e+00
  7.51730815e+00  1.45940789e+01  1.45940789e+01  1.45940789e+01
  3.53378985e+01  6.00093959e+01  6.00093959e+01  6.00093959e+01
  1.39824797e+02  5.04077821e+02  1.87164765e+03  8.00115825e+03
  4.77686055e+04]
E1 = -182.5219854142967  E_coul = 54.003922679923235
cycle= 5 E= -128.518062734373  delta_E= -2.19e-10  |g|= 1.64e-06  |ddm|= 2.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5219854142967  E_coul = 54.003922679923235
  HOMO = -0.847273745752326  LUMO = 0.850818316955194
  mo_energy =
[-3.27829553e+01 -1.93229350e+00 -8.47273746e-01 -8.47273746e-01
 -8.47273746e-01  8.50818317e-01  8.50818317e-01  8.50818317e-01
  1.20323965e+00  4.02354159e+00  4.02354159e+00  4.02354159e+00
  7.51730876e+00  1.45940800e+01  1.45940800e+01  1.45940800e+01
  3.53378999e+01  6.00093975e+01  6.00093975e+01  6.00093975e+01
  1.39824799e+02  5.04077823e+02  1.87164765e+03  8.00115826e+03
  4.77686055e+04]
E1 = -182.52197931552507  E_coul = 54.003916581151245
Extra cycle  E= -128.518062734374  delta_E= -3.41e-13  |g|= 8.41e-07  |ddm|= 9.51e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721744e+02
 7.64809506e+01 1.01213931e+01 2.71467010e+01 3.82245888e-01
 3.00863605e+00 1.13438574e+00 2.43495426e+00 7.30254313e+00
 2.82773541e+01 2.78980332e-01 8.62822811e-01]
E = -128.5180627343738
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439807        1
[INPUT] 0    0    [1    /1   ]  833.272434195        1
[INPUT] 0    0    [1    /1   ]  235.721744356        1
[INPUT] 0    0    [1    /1   ]  76.4809505854        1
[INPUT] 0    0    [1    /1   ]  10.1213931309        1
[INPUT] 0    0    [1    /1   ]  27.1467009736        1
[INPUT] 0    0    [1    /1   ]  0.382245888134       1
[INPUT] 0    0    [1    /1   ]  3.00863604672        1
[INPUT] 0    0    [1    /1   ]  1.1343857354         1
[INPUT] 1    0    [1    /1   ]  2.43495426407        1
[INPUT] 1    0    [1    /1   ]  7.30254312771        1
[INPUT] 1    0    [1    /1   ]  28.2773541271        1
[INPUT] 1    0    [1    /1   ]  0.278980331704       1
[INPUT] 1    0    [1    /1   ]  0.862822810555       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411505, 1.0]], [0, [3661.4543980729527, 1.0]], [0, [833.2724341946762, 1.0]], [0, [235.72174435582812, 1.0]], [0, [76.4809505854006, 1.0]], [0, [10.12139313088083, 1.0]], [0, [27.14670097360755, 1.0]], [0, [0.3822458881337635, 1.0]], [0, [3.0086360467236664, 1.0]], [0, [1.134385735400883, 1.0]], [1, [2.4349542640713087, 1.0]], [1, [7.302543127710573, 1.0]], [1, [28.27735412714463, 1.0]], [1, [0.2789803317037797, 1.0]], [1, [0.8628228105554465, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439807]
bas 2, expnt(s) = [833.27243419]
bas 3, expnt(s) = [235.72174436]
bas 4, expnt(s) = [76.48095059]
bas 5, expnt(s) = [10.12139313]
bas 6, expnt(s) = [27.14670097]
bas 7, expnt(s) = [0.38224589]
bas 8, expnt(s) = [3.00863605]
bas 9, expnt(s) = [1.13438574]
bas 10, expnt(s) = [2.43495426]
bas 11, expnt(s) = [7.30254313]
bas 12, expnt(s) = [28.27735413]
bas 13, expnt(s) = [0.27898033]
bas 14, expnt(s) = [0.86282281]
CPU time:        46.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721744e+02 1.51989910e+02
 7.64809506e+01 6.53401282e+01 1.01213931e+01 1.43365695e+01
 2.71467010e+01 3.00471177e+01 3.82245888e-01 1.22820862e+00
 3.00863605e+00 5.77154738e+00 1.13438574e+00 2.77706210e+00
 2.43495426e+00 8.87356026e+00 7.30254313e+00 3.50208801e+01
 2.82773541e+01 1.90231686e+02 2.78980332e-01 5.91495405e-01
 8.62822811e-01 2.42597553e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999383760942491
cond(S) = 353.00217376740966
E1 = -183.56111955959454  E_coul = 55.076531761162
init E= -128.484587798433
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771750841407676  LUMO = 0.870448988428936
  mo_energy =
[-3.25563266e+01 -1.85279208e+00 -7.71750841e-01 -7.71750841e-01
 -7.71750841e-01  8.70448988e-01  8.70448988e-01  8.70448988e-01
  1.23577062e+00  4.09237187e+00  4.09237187e+00  4.09237187e+00
  7.61140967e+00  1.47288158e+01  1.47288158e+01  1.47288158e+01
  3.55104596e+01  6.02142880e+01  6.02142880e+01  6.02142880e+01
  1.40047790e+02  5.04334914e+02  1.87193548e+03  8.00147252e+03
  4.77689376e+04]
E1 = -181.99860279305747  E_coul = 53.48434694486832
cycle= 1 E= -128.514255848189  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506208
diis-c [-0.25624632  1.        ]
  HOMO = -0.884017115989927  LUMO = 0.841236155070792
  mo_energy =
[-3.28947745e+01 -1.97100613e+00 -8.84017116e-01 -8.84017116e-01
 -8.84017116e-01  8.41236155e-01  8.41236155e-01  8.41236155e-01
  1.18790442e+00  3.99038159e+00  3.99038159e+00  3.99038159e+00
  7.47158994e+00  1.45275148e+01  1.45275148e+01  1.45275148e+01
  3.52519920e+01  5.99080765e+01  5.99080765e+01  5.99080765e+01
  1.39715036e+02  5.03956944e+02  1.87152135e+03  8.00102943e+03
  4.77684758e+04]
E1 = -182.78836689864173  E_coul = 54.27129131204335
cycle= 2 E= -128.517075586598  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25752
diis-c [-6.04900660e-04  3.36429064e-01  6.63570936e-01]
  HOMO = -0.847089115595333  LUMO = 0.850840363066226
  mo_energy =
[-3.27827000e+01 -1.93212143e+00 -8.47089116e-01 -8.47089116e-01
 -8.47089116e-01  8.50840363e-01  8.50840363e-01  8.50840363e-01
  1.20331287e+00  4.02365842e+00  4.02365842e+00  4.02365842e+00
  7.51746803e+00  1.45942629e+01  1.45942629e+01  1.45942629e+01
  3.53381143e+01  6.00096365e+01  6.00096365e+01  6.00096365e+01
  1.39825047e+02  5.04078111e+02  1.87164799e+03  8.00115864e+03
  4.77686060e+04]
E1 = -182.52203153468776  E_coul = 54.003968809557705
cycle= 3 E= -128.51806272513  delta_E= -0.000987  |g|= 0.000299  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000371901
diis-c [-5.41347440e-08 -1.85463318e-03 -2.60479650e-03  1.00445943e+00]
  HOMO = -0.847245608314261  LUMO = 0.850828248176073
  mo_energy =
[-3.27829119e+01 -1.93226294e+00 -8.47245608e-01 -8.47245608e-01
 -8.47245608e-01  8.50828248e-01  8.50828248e-01  8.50828248e-01
  1.20325813e+00  4.02356977e+00  4.02356977e+00  4.02356977e+00
  7.51734383e+00  1.45941192e+01  1.45941192e+01  1.45941192e+01
  3.53379429e+01  6.00094408e+01  6.00094408e+01  6.00094408e+01
  1.39824841e+02  5.04077863e+02  1.87164769e+03  8.00115829e+03
  4.77686056e+04]
E1 = -182.52190929896432  E_coul = 54.0038465648099
cycle= 4 E= -128.518062734154  delta_E= -9.02e-09  |g|= 5.33e-05  |ddm|= 0.000191
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.79448e-05
diis-c [-4.45993728e-10  4.36506110e-05  3.85218784e-04 -9.56910845e-02
  1.09526222e+00]
  HOMO = -0.847274290775745  LUMO = 0.850818234590915
  mo_energy =
[-3.27829571e+01 -1.93229387e+00 -8.47274291e-01 -8.47274291e-01
 -8.47274291e-01  8.50818235e-01  8.50818235e-01  8.50818235e-01
  1.20323965e+00  4.02354118e+00  4.02354118e+00  4.02354118e+00
  7.51730815e+00  1.45940789e+01  1.45940789e+01  1.45940789e+01
  3.53378985e+01  6.00093959e+01  6.00093959e+01  6.00093959e+01
  1.39824797e+02  5.04077821e+02  1.87164765e+03  8.00115825e+03
  4.77686055e+04]
E1 = -182.5219854142967  E_coul = 54.003922679923235
cycle= 5 E= -128.518062734373  delta_E= -2.19e-10  |g|= 1.64e-06  |ddm|= 2.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5219854142967  E_coul = 54.003922679923235
  HOMO = -0.847273745752326  LUMO = 0.850818316955194
  mo_energy =
[-3.27829553e+01 -1.93229350e+00 -8.47273746e-01 -8.47273746e-01
 -8.47273746e-01  8.50818317e-01  8.50818317e-01  8.50818317e-01
  1.20323965e+00  4.02354159e+00  4.02354159e+00  4.02354159e+00
  7.51730876e+00  1.45940800e+01  1.45940800e+01  1.45940800e+01
  3.53378999e+01  6.00093975e+01  6.00093975e+01  6.00093975e+01
  1.39824799e+02  5.04077823e+02  1.87164765e+03  8.00115826e+03
  4.77686055e+04]
E1 = -182.52197931552507  E_coul = 54.003916581151245
Extra cycle  E= -128.518062734374  delta_E= -3.41e-13  |g|= 8.41e-07  |ddm|= 9.51e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 353.00217376740966
E1 = -182.52197931552507  E_coul = 54.003916581151245
init E= -128.518062734374
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.847274181095427  LUMO = 0.850818193627158
  mo_energy =
[-3.27829565e+01 -1.93229401e+00 -8.47274181e-01 -8.47274181e-01
 -8.47274181e-01  8.50818194e-01  8.50818194e-01  8.50818194e-01
  1.20323942e+00  4.02354119e+00  4.02354119e+00  4.02354119e+00
  7.51730819e+00  1.45940792e+01  1.45940792e+01  1.45940792e+01
  3.53378989e+01  6.00093964e+01  6.00093964e+01  6.00093964e+01
  1.39824798e+02  5.04077822e+02  1.87164765e+03  8.00115825e+03
  4.77686055e+04]
E1 = -182.52198211743288  E_coul = 54.00391938305909
cycle= 1 E= -128.518062734374  delta_E= 2.84e-14  |g|= 3.83e-07  |ddm|= 3.08e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52198211743288  E_coul = 54.00391938305909
  HOMO = -0.847273982849749  LUMO = 0.850818243829717
  mo_energy =
[-3.27829559e+01 -1.93229381e+00 -8.47273983e-01 -8.47273983e-01
 -8.47273983e-01  8.50818244e-01  8.50818244e-01  8.50818244e-01
  1.20323950e+00  4.02354136e+00  4.02354136e+00  4.02354136e+00
  7.51730843e+00  1.45940796e+01  1.45940796e+01  1.45940796e+01
  3.53378994e+01  6.00093969e+01  6.00093969e+01  6.00093969e+01
  1.39824798e+02  5.04077822e+02  1.87164765e+03  8.00115825e+03
  4.77686055e+04]
E1 = -182.52198064028204  E_coul = 54.00391790590806
Extra cycle  E= -128.518062734374  delta_E= -1.99e-13  |g|= 2.01e-07  |ddm|= 1.32e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721744e+02
 7.64809506e+01 1.01213931e+01 2.71467010e+01 3.82245888e-01
 3.00863605e+00 1.13438574e+00 2.43495426e+00 7.30254313e+00
 2.82773541e+01 2.78980332e-01 8.62822811e-01]
grad_E = [ 3.42429215e-11 -1.72730564e-09  3.49654573e-08 -4.32358486e-07
  3.72854263e-06  9.49212026e-05 -2.39473524e-05 -3.79397067e-04
  1.67322380e-04 -4.94793675e-04 -6.40690022e-03  1.01606734e-04
 -1.59776363e-03 -3.62355525e-03  1.43360007e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439808        1
[INPUT] 0    0    [1    /1   ]  833.272434063        1
[INPUT] 0    0    [1    /1   ]  235.721745998        1
[INPUT] 0    0    [1    /1   ]  76.4809362398        1
[INPUT] 0    0    [1    /1   ]  10.1210138872        1
[INPUT] 0    0    [1    /1   ]  27.1467956443        1
[INPUT] 0    0    [1    /1   ]  0.3826312109         1
[INPUT] 0    0    [1    /1   ]  3.00804850491        1
[INPUT] 0    0    [1    /1   ]  1.13503651464        1
[INPUT] 1    0    [1    /1   ]  2.48782866575        1
[INPUT] 1    0    [1    /1   ]  7.35741674418        1
[INPUT] 1    0    [1    /1   ]  28.2803002717        1
[INPUT] 1    0    [1    /1   ]  0.281809679079       1
[INPUT] 1    0    [1    /1   ]  0.876946684672       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141137, 1.0]], [0, [3661.4543980794556, 1.0]], [0, [833.2724340627875, 1.0]], [0, [235.72174599757255, 1.0]], [0, [76.48093623983998, 1.0]], [0, [10.121013887208838, 1.0]], [0, [27.146795644292997, 1.0]], [0, [0.3826312109001024, 1.0]], [0, [3.0080485049077006, 1.0]], [0, [1.13503651464185, 1.0]], [1, [2.487828665750814, 1.0]], [1, [7.357416744179345, 1.0]], [1, [28.280300271666217, 1.0]], [1, [0.2818096790788759, 1.0]], [1, [0.8769466846715528, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439808]
bas 2, expnt(s) = [833.27243406]
bas 3, expnt(s) = [235.721746]
bas 4, expnt(s) = [76.48093624]
bas 5, expnt(s) = [10.12101389]
bas 6, expnt(s) = [27.14679564]
bas 7, expnt(s) = [0.38263121]
bas 8, expnt(s) = [3.0080485]
bas 9, expnt(s) = [1.13503651]
bas 10, expnt(s) = [2.48782867]
bas 11, expnt(s) = [7.35741674]
bas 12, expnt(s) = [28.28030027]
bas 13, expnt(s) = [0.28180968]
bas 14, expnt(s) = [0.87694668]
CPU time:        49.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721746e+02 1.51989911e+02
 7.64809362e+01 6.53401190e+01 1.01210139e+01 1.43361666e+01
 2.71467956e+01 3.00471963e+01 3.82631211e-01 1.22913707e+00
 3.00804850e+00 5.77070203e+00 1.13503651e+00 2.77825688e+00
 2.48782867e+00 9.11506935e+00 7.35741674e+00 3.53501359e+01
 2.82803003e+01 1.90256461e+02 2.81809679e-01 5.99003382e-01
 8.76946685e-01 2.47571633e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999358701096234
cond(S) = 353.18796359444696
E1 = -183.56134838299957  E_coul = 55.07666482911476
init E= -128.484683553885
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771743690729169  LUMO = 0.882735035626432
  mo_energy =
[-3.25563425e+01 -1.85277094e+00 -7.71743691e-01 -7.71743691e-01
 -7.71743691e-01  8.82735036e-01  8.82735036e-01  8.82735036e-01
  1.23714881e+00  4.16953680e+00  4.16953680e+00  4.16953680e+00
  7.61444753e+00  1.49812869e+01  1.49812869e+01  1.49812869e+01
  3.55121684e+01  6.06081668e+01  6.06081668e+01  6.06081668e+01
  1.40048345e+02  5.04335249e+02  1.87193578e+03  8.00147279e+03
  4.77689379e+04]
E1 = -182.0023766952326  E_coul = 53.48801133135081
cycle= 1 E= -128.514365363882  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505694
diis-c [-0.2557265  1.       ]
  HOMO = -0.883745650317846  LUMO = 0.85307302496457
  mo_energy =
[-3.28941244e+01 -1.97068139e+00 -8.83745650e-01 -8.83745650e-01
 -8.83745650e-01  8.53073025e-01  8.53073025e-01  8.53073025e-01
  1.18945545e+00  4.06625890e+00  4.06625890e+00  4.06625890e+00
  7.47493913e+00  1.47794382e+01  1.47794382e+01  1.47794382e+01
  3.52542470e+01  6.03026791e+01  6.03026791e+01  6.03026791e+01
  1.39716233e+02  5.03957882e+02  1.87152222e+03  8.00103025e+03
  4.77684766e+04]
E1 = -182.79019714990488  E_coul = 54.27302168620881
cycle= 2 E= -128.517175463696  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257089
diis-c [-6.00249517e-04  3.36284621e-01  6.63715379e-01]
  HOMO = -0.846904289505983  LUMO = 0.862841703858592
  mo_energy =
[-3.27822844e+01 -1.93188997e+00 -8.46904290e-01 -8.46904290e-01
 -8.46904290e-01  8.62841704e-01  8.62841704e-01  8.62841704e-01
  1.20483739e+00  4.09997710e+00  4.09997710e+00  4.09997710e+00
  7.52070757e+00  1.48463731e+01  1.48463731e+01  1.48463731e+01
  3.53401796e+01  6.04039975e+01  6.04039975e+01  6.04039975e+01
  1.39826013e+02  5.04078801e+02  1.87164860e+03  8.00115922e+03
  4.77686065e+04]
E1 = -182.5247500056311  E_coul = 54.00659263879307
cycle= 3 E= -128.518157366838  delta_E= -0.000982  |g|= 0.000277  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000349655
diis-c [-4.61086992e-08 -1.81335671e-03 -2.58098696e-03  1.00439434e+00]
  HOMO = -0.847051401249107  LUMO = 0.862833892282928
  mo_energy =
[-3.27824812e+01 -1.93201897e+00 -8.47051401e-01 -8.47051401e-01
 -8.47051401e-01  8.62833892e-01  8.62833892e-01  8.62833892e-01
  1.20479196e+00  4.09989774e+00  4.09989774e+00  4.09989774e+00
  7.52059503e+00  1.48462416e+01  1.48462416e+01  1.48462416e+01
  3.53400216e+01  6.04038165e+01  6.04038165e+01  6.04038165e+01
  1.39825823e+02  5.04078569e+02  1.87164831e+03  8.00115888e+03
  4.77686061e+04]
E1 = -182.52463175577307  E_coul = 54.00647438156143
cycle= 4 E= -128.518157374212  delta_E= -7.37e-09  |g|= 5.01e-05  |ddm|= 0.000179
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.53508e-05
diis-c [-3.83683189e-10  2.93201743e-05  3.62707127e-04 -8.47614611e-02
  1.08436943e+00]
  HOMO = -0.847078227409971  LUMO = 0.862824553197955
  mo_energy =
[-3.27825240e+01 -1.93204717e+00 -8.47078227e-01 -8.47078227e-01
 -8.47078227e-01  8.62824553e-01  8.62824553e-01  8.62824553e-01
  1.20477535e+00  4.09987095e+00  4.09987095e+00  4.09987095e+00
  7.52056193e+00  1.48462038e+01  1.48462038e+01  1.48462038e+01
  3.53399799e+01  6.04037741e+01  6.04037741e+01  6.04037741e+01
  1.39825781e+02  5.04078528e+02  1.87164828e+03  8.00115884e+03
  4.77686061e+04]
E1 = -182.52470706807037  E_coul = 54.00654969367089
cycle= 5 E= -128.518157374399  delta_E= -1.88e-10  |g|= 1.25e-06  |ddm|= 1.83e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52470706807037  E_coul = 54.00654969367089
  HOMO = -0.847077991212861  LUMO = 0.862824553066486
  mo_energy =
[-3.27825229e+01 -1.93204700e+00 -8.47077991e-01 -8.47077991e-01
 -8.47077991e-01  8.62824553e-01  8.62824553e-01  8.62824553e-01
  1.20477526e+00  4.09987109e+00  4.09987109e+00  4.09987109e+00
  7.52056222e+00  1.48462044e+01  1.48462044e+01  1.48462044e+01
  3.53399807e+01  6.04037751e+01  6.04037751e+01  6.04037751e+01
  1.39825782e+02  5.04078529e+02  1.87164828e+03  8.00115884e+03
  4.77686061e+04]
E1 = -182.52470263078249  E_coul = 54.00654525638273
Extra cycle  E= -128.5181573744  delta_E= -2.56e-13  |g|= 5.95e-07  |ddm|= 7.97e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721746e+02
 7.64809362e+01 1.01210139e+01 2.71467956e+01 3.82631211e-01
 3.00804850e+00 1.13503651e+00 2.48782867e+00 7.35741674e+00
 2.82803003e+01 2.81809679e-01 8.76946685e-01]
E = -128.51815737439975
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439808        1
[INPUT] 0    0    [1    /1   ]  833.272434063        1
[INPUT] 0    0    [1    /1   ]  235.721745998        1
[INPUT] 0    0    [1    /1   ]  76.4809362398        1
[INPUT] 0    0    [1    /1   ]  10.1210138872        1
[INPUT] 0    0    [1    /1   ]  27.1467956443        1
[INPUT] 0    0    [1    /1   ]  0.3826312109         1
[INPUT] 0    0    [1    /1   ]  3.00804850491        1
[INPUT] 0    0    [1    /1   ]  1.13503651464        1
[INPUT] 1    0    [1    /1   ]  2.48782866575        1
[INPUT] 1    0    [1    /1   ]  7.35741674418        1
[INPUT] 1    0    [1    /1   ]  28.2803002717        1
[INPUT] 1    0    [1    /1   ]  0.281809679079       1
[INPUT] 1    0    [1    /1   ]  0.876946684672       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141137, 1.0]], [0, [3661.4543980794556, 1.0]], [0, [833.2724340627875, 1.0]], [0, [235.72174599757255, 1.0]], [0, [76.48093623983998, 1.0]], [0, [10.121013887208838, 1.0]], [0, [27.146795644292997, 1.0]], [0, [0.3826312109001024, 1.0]], [0, [3.0080485049077006, 1.0]], [0, [1.13503651464185, 1.0]], [1, [2.487828665750814, 1.0]], [1, [7.357416744179345, 1.0]], [1, [28.280300271666217, 1.0]], [1, [0.2818096790788759, 1.0]], [1, [0.8769466846715528, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439808]
bas 2, expnt(s) = [833.27243406]
bas 3, expnt(s) = [235.721746]
bas 4, expnt(s) = [76.48093624]
bas 5, expnt(s) = [10.12101389]
bas 6, expnt(s) = [27.14679564]
bas 7, expnt(s) = [0.38263121]
bas 8, expnt(s) = [3.0080485]
bas 9, expnt(s) = [1.13503651]
bas 10, expnt(s) = [2.48782867]
bas 11, expnt(s) = [7.35741674]
bas 12, expnt(s) = [28.28030027]
bas 13, expnt(s) = [0.28180968]
bas 14, expnt(s) = [0.87694668]
CPU time:        49.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721746e+02 1.51989911e+02
 7.64809362e+01 6.53401190e+01 1.01210139e+01 1.43361666e+01
 2.71467956e+01 3.00471963e+01 3.82631211e-01 1.22913707e+00
 3.00804850e+00 5.77070203e+00 1.13503651e+00 2.77825688e+00
 2.48782867e+00 9.11506935e+00 7.35741674e+00 3.53501359e+01
 2.82803003e+01 1.90256461e+02 2.81809679e-01 5.99003382e-01
 8.76946685e-01 2.47571633e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999358701096234
cond(S) = 353.18796359444696
E1 = -183.56134838299957  E_coul = 55.07666482911476
init E= -128.484683553885
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771743690729169  LUMO = 0.882735035626432
  mo_energy =
[-3.25563425e+01 -1.85277094e+00 -7.71743691e-01 -7.71743691e-01
 -7.71743691e-01  8.82735036e-01  8.82735036e-01  8.82735036e-01
  1.23714881e+00  4.16953680e+00  4.16953680e+00  4.16953680e+00
  7.61444753e+00  1.49812869e+01  1.49812869e+01  1.49812869e+01
  3.55121684e+01  6.06081668e+01  6.06081668e+01  6.06081668e+01
  1.40048345e+02  5.04335249e+02  1.87193578e+03  8.00147279e+03
  4.77689379e+04]
E1 = -182.0023766952326  E_coul = 53.48801133135081
cycle= 1 E= -128.514365363882  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505694
diis-c [-0.2557265  1.       ]
  HOMO = -0.883745650317846  LUMO = 0.85307302496457
  mo_energy =
[-3.28941244e+01 -1.97068139e+00 -8.83745650e-01 -8.83745650e-01
 -8.83745650e-01  8.53073025e-01  8.53073025e-01  8.53073025e-01
  1.18945545e+00  4.06625890e+00  4.06625890e+00  4.06625890e+00
  7.47493913e+00  1.47794382e+01  1.47794382e+01  1.47794382e+01
  3.52542470e+01  6.03026791e+01  6.03026791e+01  6.03026791e+01
  1.39716233e+02  5.03957882e+02  1.87152222e+03  8.00103025e+03
  4.77684766e+04]
E1 = -182.79019714990488  E_coul = 54.27302168620881
cycle= 2 E= -128.517175463696  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257089
diis-c [-6.00249517e-04  3.36284621e-01  6.63715379e-01]
  HOMO = -0.846904289505983  LUMO = 0.862841703858592
  mo_energy =
[-3.27822844e+01 -1.93188997e+00 -8.46904290e-01 -8.46904290e-01
 -8.46904290e-01  8.62841704e-01  8.62841704e-01  8.62841704e-01
  1.20483739e+00  4.09997710e+00  4.09997710e+00  4.09997710e+00
  7.52070757e+00  1.48463731e+01  1.48463731e+01  1.48463731e+01
  3.53401796e+01  6.04039975e+01  6.04039975e+01  6.04039975e+01
  1.39826013e+02  5.04078801e+02  1.87164860e+03  8.00115922e+03
  4.77686065e+04]
E1 = -182.5247500056311  E_coul = 54.00659263879307
cycle= 3 E= -128.518157366838  delta_E= -0.000982  |g|= 0.000277  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000349655
diis-c [-4.61086992e-08 -1.81335671e-03 -2.58098696e-03  1.00439434e+00]
  HOMO = -0.847051401249107  LUMO = 0.862833892282928
  mo_energy =
[-3.27824812e+01 -1.93201897e+00 -8.47051401e-01 -8.47051401e-01
 -8.47051401e-01  8.62833892e-01  8.62833892e-01  8.62833892e-01
  1.20479196e+00  4.09989774e+00  4.09989774e+00  4.09989774e+00
  7.52059503e+00  1.48462416e+01  1.48462416e+01  1.48462416e+01
  3.53400216e+01  6.04038165e+01  6.04038165e+01  6.04038165e+01
  1.39825823e+02  5.04078569e+02  1.87164831e+03  8.00115888e+03
  4.77686061e+04]
E1 = -182.52463175577307  E_coul = 54.00647438156143
cycle= 4 E= -128.518157374212  delta_E= -7.37e-09  |g|= 5.01e-05  |ddm|= 0.000179
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.53508e-05
diis-c [-3.83683189e-10  2.93201743e-05  3.62707127e-04 -8.47614611e-02
  1.08436943e+00]
  HOMO = -0.847078227409971  LUMO = 0.862824553197955
  mo_energy =
[-3.27825240e+01 -1.93204717e+00 -8.47078227e-01 -8.47078227e-01
 -8.47078227e-01  8.62824553e-01  8.62824553e-01  8.62824553e-01
  1.20477535e+00  4.09987095e+00  4.09987095e+00  4.09987095e+00
  7.52056193e+00  1.48462038e+01  1.48462038e+01  1.48462038e+01
  3.53399799e+01  6.04037741e+01  6.04037741e+01  6.04037741e+01
  1.39825781e+02  5.04078528e+02  1.87164828e+03  8.00115884e+03
  4.77686061e+04]
E1 = -182.52470706807037  E_coul = 54.00654969367089
cycle= 5 E= -128.518157374399  delta_E= -1.88e-10  |g|= 1.25e-06  |ddm|= 1.83e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52470706807037  E_coul = 54.00654969367089
  HOMO = -0.847077991212861  LUMO = 0.862824553066486
  mo_energy =
[-3.27825229e+01 -1.93204700e+00 -8.47077991e-01 -8.47077991e-01
 -8.47077991e-01  8.62824553e-01  8.62824553e-01  8.62824553e-01
  1.20477526e+00  4.09987109e+00  4.09987109e+00  4.09987109e+00
  7.52056222e+00  1.48462044e+01  1.48462044e+01  1.48462044e+01
  3.53399807e+01  6.04037751e+01  6.04037751e+01  6.04037751e+01
  1.39825782e+02  5.04078529e+02  1.87164828e+03  8.00115884e+03
  4.77686061e+04]
E1 = -182.52470263078249  E_coul = 54.00654525638273
Extra cycle  E= -128.5181573744  delta_E= -2.56e-13  |g|= 5.95e-07  |ddm|= 7.97e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 353.18796359444696
E1 = -182.52470263078249  E_coul = 54.00654525638273
init E= -128.5181573744
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.84707831591025  LUMO = 0.862824457592558
  mo_energy =
[-3.27825237e+01 -1.93204737e+00 -8.47078316e-01 -8.47078316e-01
 -8.47078316e-01  8.62824458e-01  8.62824458e-01  8.62824458e-01
  1.20477509e+00  4.09987079e+00  4.09987079e+00  4.09987079e+00
  7.52056181e+00  1.48462038e+01  1.48462038e+01  1.48462038e+01
  3.53399800e+01  6.04037743e+01  6.04037743e+01  6.04037743e+01
  1.39825781e+02  5.04078528e+02  1.87164828e+03  8.00115884e+03
  4.77686061e+04]
E1 = -182.5247045851758  E_coul = 54.00654721077571
cycle= 1 E= -128.5181573744  delta_E= -3.69e-13  |g|= 2.69e-07  |ddm|= 1.99e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5247045851758  E_coul = 54.00654721077571
  HOMO = -0.847078178709646  LUMO = 0.862824492804269
  mo_energy =
[-3.27825233e+01 -1.93204723e+00 -8.47078179e-01 -8.47078179e-01
 -8.47078179e-01  8.62824493e-01  8.62824493e-01  8.62824493e-01
  1.20477514e+00  4.09987091e+00  4.09987091e+00  4.09987091e+00
  7.52056197e+00  1.48462041e+01  1.48462041e+01  1.48462041e+01
  3.53399803e+01  6.04037747e+01  6.04037747e+01  6.04037747e+01
  1.39825781e+02  5.04078529e+02  1.87164828e+03  8.00115884e+03
  4.77686061e+04]
E1 = -182.5247035469989  E_coul = 54.00654617259918
Extra cycle  E= -128.5181573744  delta_E= 3.98e-13  |g|= 1.41e-07  |ddm|= 9.43e-08
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721746e+02
 7.64809362e+01 1.01210139e+01 2.71467956e+01 3.82631211e-01
 3.00804850e+00 1.13503651e+00 2.48782867e+00 7.35741674e+00
 2.82803003e+01 2.81809679e-01 8.76946685e-01]
grad_E = [ 3.05731739e-11 -1.53470318e-09  3.11011651e-08 -3.86639072e-07
  3.37997653e-06  9.13227416e-05 -2.23496223e-05 -3.31639644e-04
  1.63304697e-04 -4.78000029e-04 -2.34969753e-03 -7.77621612e-04
 -1.57399117e-03  1.91031777e-03  8.55179892e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439809        1
[INPUT] 0    0    [1    /1   ]  833.272433949        1
[INPUT] 0    0    [1    /1   ]  235.72174741         1
[INPUT] 0    0    [1    /1   ]  76.4809239199        1
[INPUT] 0    0    [1    /1   ]  10.1206873471        1
[INPUT] 0    0    [1    /1   ]  27.146876643         1
[INPUT] 0    0    [1    /1   ]  0.383155328432       1
[INPUT] 0    0    [1    /1   ]  3.00749457917        1
[INPUT] 0    0    [1    /1   ]  1.13633897718        1
[INPUT] 1    0    [1    /1   ]  2.50853020844        1
[INPUT] 1    0    [1    /1   ]  7.38104122909        1
[INPUT] 1    0    [1    /1   ]  28.2843814214        1
[INPUT] 1    0    [1    /1   ]  0.281204340837       1
[INPUT] 1    0    [1    /1   ]  0.879382204825       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411258, 1.0]], [0, [3661.4543980850635, 1.0]], [0, [833.2724339491143, 1.0]], [0, [235.7217474104384, 1.0]], [0, [76.48092391988635, 1.0]], [0, [10.120687347143832, 1.0]], [0, [27.14687664299386, 1.0]], [0, [0.3831553284316454, 1.0]], [0, [3.0074945791686165, 1.0]], [0, [1.1363389771849963, 1.0]], [1, [2.5085302084448937, 1.0]], [1, [7.381041229093053, 1.0]], [1, [28.284381421369496, 1.0]], [1, [0.28120434083728546, 1.0]], [1, [0.8793822048250566, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439809]
bas 2, expnt(s) = [833.27243395]
bas 3, expnt(s) = [235.72174741]
bas 4, expnt(s) = [76.48092392]
bas 5, expnt(s) = [10.12068735]
bas 6, expnt(s) = [27.14687664]
bas 7, expnt(s) = [0.38315533]
bas 8, expnt(s) = [3.00749458]
bas 9, expnt(s) = [1.13633898]
bas 10, expnt(s) = [2.50853021]
bas 11, expnt(s) = [7.38104123]
bas 12, expnt(s) = [28.28438142]
bas 13, expnt(s) = [0.28120434]
bas 14, expnt(s) = [0.8793822]
CPU time:        51.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721747e+02 1.51989912e+02
 7.64809239e+01 6.53401111e+01 1.01206873e+01 1.43358197e+01
 2.71468766e+01 3.00472636e+01 3.83155328e-01 1.23039959e+00
 3.00749458e+00 5.76990502e+00 1.13633898e+00 2.78064759e+00
 2.50853021e+00 9.20997734e+00 7.38104123e+00 3.54920783e+01
 2.82843814e+01 1.90290781e+02 2.81204341e-01 5.97395460e-01
 8.79382205e-01 2.48431398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999364431326859
cond(S) = 353.52773830000297
E1 = -183.56137925951825  E_coul = 55.07667279399253
init E= -128.484706465526
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771747801920409  LUMO = 0.881854545113156
  mo_energy =
[-3.25563541e+01 -1.85276705e+00 -7.71747802e-01 -7.71747802e-01
 -7.71747802e-01  8.81854545e-01  8.81854545e-01  8.81854545e-01
  1.23928190e+00  4.18542920e+00  4.18542920e+00  4.18542920e+00
  7.62017092e+00  1.50652213e+01  1.50652213e+01  1.50652213e+01
  3.55174664e+01  6.07594991e+01  6.07594991e+01  6.07594991e+01
  1.40052300e+02  5.04338606e+02  1.87193875e+03  8.00147541e+03
  4.77689401e+04]
E1 = -182.00167691315573  E_coul = 53.487271601892594
cycle= 1 E= -128.514405311263  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505817
diis-c [-0.25585055  1.        ]
  HOMO = -0.88381685808772  LUMO = 0.8521517969962
  mo_energy =
[-3.28942281e+01 -1.97075677e+00 -8.83816858e-01 -8.83816858e-01
 -8.83816858e-01  8.52151797e-01  8.52151797e-01  8.52151797e-01
  1.19149301e+00  4.08156313e+00  4.08156313e+00  4.08156313e+00
  7.48055208e+00  1.48628310e+01  1.48628310e+01  1.48628310e+01
  3.52594569e+01  6.04539352e+01  6.04539352e+01  6.04539352e+01
  1.39720093e+02  5.03961111e+02  1.87152505e+03  8.00103272e+03
  4.77684786e+04]
E1 = -182.79003339941767  E_coul = 54.27281610043297
cycle= 2 E= -128.517217298985  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257229
diis-c [-5.99054575e-04  3.36354101e-01  6.63645899e-01]
  HOMO = -0.846953247151273  LUMO = 0.861937269121605
  mo_energy =
[-3.27823287e+01 -1.93194081e+00 -8.46953247e-01 -8.46953247e-01
 -8.46953247e-01  8.61937269e-01  8.61937269e-01  8.61937269e-01
  1.20690820e+00  4.11547723e+00  4.11547723e+00  4.11547723e+00
  7.52635311e+00  1.49299575e+01  1.49299575e+01  1.49299575e+01
  3.53454343e+01  6.05553065e+01  6.05553065e+01  6.05553065e+01
  1.39829930e+02  5.04082093e+02  1.87165150e+03  8.00116174e+03
  4.77686086e+04]
E1 = -182.52438063875093  E_coul = 54.006180011830715
cycle= 3 E= -128.51820062692  delta_E= -0.000983  |g|= 0.000272  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000344132
diis-c [-4.50845294e-08 -1.80702700e-03 -2.58975442e-03  1.00439678e+00]
  HOMO = -0.847098494967317  LUMO = 0.861930554469119
  mo_energy =
[-3.27825217e+01 -1.93206793e+00 -8.47098495e-01 -8.47098495e-01
 -8.47098495e-01  8.61930554e-01  8.61930554e-01  8.61930554e-01
  1.20686437e+00  4.11539973e+00  4.11539973e+00  4.11539973e+00
  7.52624259e+00  1.49298284e+01  1.49298284e+01  1.49298284e+01
  3.53452792e+01  6.05551290e+01  6.05551290e+01  6.05551290e+01
  1.39829744e+02  5.04081865e+02  1.87165121e+03  8.00116141e+03
  4.77686082e+04]
E1 = -182.524260894485  E_coul = 54.006060260508285
cycle= 4 E= -128.518200633977  delta_E= -7.06e-09  |g|= 4.95e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.44852e-05
diis-c [-3.76560771e-10  2.69393126e-05  3.57185176e-04 -8.34083536e-02
  1.08302423e+00]
  HOMO = -0.847124961614501  LUMO = 0.861921364178132
  mo_energy =
[-3.27825640e+01 -1.93209575e+00 -8.47124962e-01 -8.47124962e-01
 -8.47124962e-01  8.61921364e-01  8.61921364e-01  8.61921364e-01
  1.20684802e+00  4.11537323e+00  4.11537323e+00  4.11537323e+00
  7.52620990e+00  1.49297910e+01  1.49297910e+01  1.49297910e+01
  3.53452379e+01  6.05550871e+01  6.05550871e+01  6.05550871e+01
  1.39829702e+02  5.04081826e+02  1.87165118e+03  8.00116138e+03
  4.77686082e+04]
E1 = -182.52433592628375  E_coul = 54.006135292124476
cycle= 5 E= -128.518200634159  delta_E= -1.83e-10  |g|= 1.23e-06  |ddm|= 1.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52433592628375  E_coul = 54.006135292124476
  HOMO = -0.847124737701297  LUMO = 0.861921360933397
  mo_energy =
[-3.27825629e+01 -1.93209559e+00 -8.47124738e-01 -8.47124738e-01
 -8.47124738e-01  8.61921361e-01  8.61921361e-01  8.61921361e-01
  1.20684793e+00  4.11537337e+00  4.11537337e+00  4.11537337e+00
  7.52621017e+00  1.49297916e+01  1.49297916e+01  1.49297916e+01
  3.53452388e+01  6.05550881e+01  6.05550881e+01  6.05550881e+01
  1.39829703e+02  5.04081827e+02  1.87165118e+03  8.00116138e+03
  4.77686082e+04]
E1 = -182.52433156171932  E_coul = 54.006130927559894
Extra cycle  E= -128.518200634159  delta_E= -1.42e-13  |g|= 5.85e-07  |ddm|= 7.89e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721747e+02
 7.64809239e+01 1.01206873e+01 2.71468766e+01 3.83155328e-01
 3.00749458e+00 1.13633898e+00 2.50853021e+00 7.38104123e+00
 2.82843814e+01 2.81204341e-01 8.79382205e-01]
E = -128.51820063415943
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439809        1
[INPUT] 0    0    [1    /1   ]  833.272433949        1
[INPUT] 0    0    [1    /1   ]  235.72174741         1
[INPUT] 0    0    [1    /1   ]  76.4809239199        1
[INPUT] 0    0    [1    /1   ]  10.1206873471        1
[INPUT] 0    0    [1    /1   ]  27.146876643         1
[INPUT] 0    0    [1    /1   ]  0.383155328432       1
[INPUT] 0    0    [1    /1   ]  3.00749457917        1
[INPUT] 0    0    [1    /1   ]  1.13633897718        1
[INPUT] 1    0    [1    /1   ]  2.50853020844        1
[INPUT] 1    0    [1    /1   ]  7.38104122909        1
[INPUT] 1    0    [1    /1   ]  28.2843814214        1
[INPUT] 1    0    [1    /1   ]  0.281204340837       1
[INPUT] 1    0    [1    /1   ]  0.879382204825       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411258, 1.0]], [0, [3661.4543980850635, 1.0]], [0, [833.2724339491143, 1.0]], [0, [235.7217474104384, 1.0]], [0, [76.48092391988635, 1.0]], [0, [10.120687347143832, 1.0]], [0, [27.14687664299386, 1.0]], [0, [0.3831553284316454, 1.0]], [0, [3.0074945791686165, 1.0]], [0, [1.1363389771849963, 1.0]], [1, [2.5085302084448937, 1.0]], [1, [7.381041229093053, 1.0]], [1, [28.284381421369496, 1.0]], [1, [0.28120434083728546, 1.0]], [1, [0.8793822048250566, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439809]
bas 2, expnt(s) = [833.27243395]
bas 3, expnt(s) = [235.72174741]
bas 4, expnt(s) = [76.48092392]
bas 5, expnt(s) = [10.12068735]
bas 6, expnt(s) = [27.14687664]
bas 7, expnt(s) = [0.38315533]
bas 8, expnt(s) = [3.00749458]
bas 9, expnt(s) = [1.13633898]
bas 10, expnt(s) = [2.50853021]
bas 11, expnt(s) = [7.38104123]
bas 12, expnt(s) = [28.28438142]
bas 13, expnt(s) = [0.28120434]
bas 14, expnt(s) = [0.8793822]
CPU time:        52.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721747e+02 1.51989912e+02
 7.64809239e+01 6.53401111e+01 1.01206873e+01 1.43358197e+01
 2.71468766e+01 3.00472636e+01 3.83155328e-01 1.23039959e+00
 3.00749458e+00 5.76990502e+00 1.13633898e+00 2.78064759e+00
 2.50853021e+00 9.20997734e+00 7.38104123e+00 3.54920783e+01
 2.82843814e+01 1.90290781e+02 2.81204341e-01 5.97395460e-01
 8.79382205e-01 2.48431398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999364431326859
cond(S) = 353.52773830000297
E1 = -183.56137925951825  E_coul = 55.07667279399253
init E= -128.484706465526
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771747801920409  LUMO = 0.881854545113156
  mo_energy =
[-3.25563541e+01 -1.85276705e+00 -7.71747802e-01 -7.71747802e-01
 -7.71747802e-01  8.81854545e-01  8.81854545e-01  8.81854545e-01
  1.23928190e+00  4.18542920e+00  4.18542920e+00  4.18542920e+00
  7.62017092e+00  1.50652213e+01  1.50652213e+01  1.50652213e+01
  3.55174664e+01  6.07594991e+01  6.07594991e+01  6.07594991e+01
  1.40052300e+02  5.04338606e+02  1.87193875e+03  8.00147541e+03
  4.77689401e+04]
E1 = -182.00167691315573  E_coul = 53.487271601892594
cycle= 1 E= -128.514405311263  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505817
diis-c [-0.25585055  1.        ]
  HOMO = -0.88381685808772  LUMO = 0.8521517969962
  mo_energy =
[-3.28942281e+01 -1.97075677e+00 -8.83816858e-01 -8.83816858e-01
 -8.83816858e-01  8.52151797e-01  8.52151797e-01  8.52151797e-01
  1.19149301e+00  4.08156313e+00  4.08156313e+00  4.08156313e+00
  7.48055208e+00  1.48628310e+01  1.48628310e+01  1.48628310e+01
  3.52594569e+01  6.04539352e+01  6.04539352e+01  6.04539352e+01
  1.39720093e+02  5.03961111e+02  1.87152505e+03  8.00103272e+03
  4.77684786e+04]
E1 = -182.79003339941767  E_coul = 54.27281610043297
cycle= 2 E= -128.517217298985  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257229
diis-c [-5.99054575e-04  3.36354101e-01  6.63645899e-01]
  HOMO = -0.846953247151273  LUMO = 0.861937269121605
  mo_energy =
[-3.27823287e+01 -1.93194081e+00 -8.46953247e-01 -8.46953247e-01
 -8.46953247e-01  8.61937269e-01  8.61937269e-01  8.61937269e-01
  1.20690820e+00  4.11547723e+00  4.11547723e+00  4.11547723e+00
  7.52635311e+00  1.49299575e+01  1.49299575e+01  1.49299575e+01
  3.53454343e+01  6.05553065e+01  6.05553065e+01  6.05553065e+01
  1.39829930e+02  5.04082093e+02  1.87165150e+03  8.00116174e+03
  4.77686086e+04]
E1 = -182.52438063875093  E_coul = 54.006180011830715
cycle= 3 E= -128.51820062692  delta_E= -0.000983  |g|= 0.000272  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000344132
diis-c [-4.50845294e-08 -1.80702700e-03 -2.58975442e-03  1.00439678e+00]
  HOMO = -0.847098494967317  LUMO = 0.861930554469119
  mo_energy =
[-3.27825217e+01 -1.93206793e+00 -8.47098495e-01 -8.47098495e-01
 -8.47098495e-01  8.61930554e-01  8.61930554e-01  8.61930554e-01
  1.20686437e+00  4.11539973e+00  4.11539973e+00  4.11539973e+00
  7.52624259e+00  1.49298284e+01  1.49298284e+01  1.49298284e+01
  3.53452792e+01  6.05551290e+01  6.05551290e+01  6.05551290e+01
  1.39829744e+02  5.04081865e+02  1.87165121e+03  8.00116141e+03
  4.77686082e+04]
E1 = -182.524260894485  E_coul = 54.006060260508285
cycle= 4 E= -128.518200633977  delta_E= -7.06e-09  |g|= 4.95e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.44852e-05
diis-c [-3.76560771e-10  2.69393126e-05  3.57185176e-04 -8.34083536e-02
  1.08302423e+00]
  HOMO = -0.847124961614501  LUMO = 0.861921364178132
  mo_energy =
[-3.27825640e+01 -1.93209575e+00 -8.47124962e-01 -8.47124962e-01
 -8.47124962e-01  8.61921364e-01  8.61921364e-01  8.61921364e-01
  1.20684802e+00  4.11537323e+00  4.11537323e+00  4.11537323e+00
  7.52620990e+00  1.49297910e+01  1.49297910e+01  1.49297910e+01
  3.53452379e+01  6.05550871e+01  6.05550871e+01  6.05550871e+01
  1.39829702e+02  5.04081826e+02  1.87165118e+03  8.00116138e+03
  4.77686082e+04]
E1 = -182.52433592628375  E_coul = 54.006135292124476
cycle= 5 E= -128.518200634159  delta_E= -1.83e-10  |g|= 1.23e-06  |ddm|= 1.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52433592628375  E_coul = 54.006135292124476
  HOMO = -0.847124737701297  LUMO = 0.861921360933397
  mo_energy =
[-3.27825629e+01 -1.93209559e+00 -8.47124738e-01 -8.47124738e-01
 -8.47124738e-01  8.61921361e-01  8.61921361e-01  8.61921361e-01
  1.20684793e+00  4.11537337e+00  4.11537337e+00  4.11537337e+00
  7.52621017e+00  1.49297916e+01  1.49297916e+01  1.49297916e+01
  3.53452388e+01  6.05550881e+01  6.05550881e+01  6.05550881e+01
  1.39829703e+02  5.04081827e+02  1.87165118e+03  8.00116138e+03
  4.77686082e+04]
E1 = -182.52433156171932  E_coul = 54.006130927559894
Extra cycle  E= -128.518200634159  delta_E= -1.42e-13  |g|= 5.85e-07  |ddm|= 7.89e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 353.52773830000297
E1 = -182.52433156171932  E_coul = 54.006130927559894
init E= -128.518200634159
    CPU time for initialize scf      0.19 sec, wall time      0.18 sec
  HOMO = -0.847125057459677  LUMO = 0.861921266768347
  mo_energy =
[-3.27825637e+01 -1.93209595e+00 -8.47125057e-01 -8.47125057e-01
 -8.47125057e-01  8.61921267e-01  8.61921267e-01  8.61921267e-01
  1.20684776e+00  4.11537306e+00  4.11537306e+00  4.11537306e+00
  7.52620977e+00  1.49297910e+01  1.49297910e+01  1.49297910e+01
  3.53452381e+01  6.05550873e+01  6.05550873e+01  6.05550873e+01
  1.39829702e+02  5.04081826e+02  1.87165118e+03  8.00116138e+03
  4.77686082e+04]
E1 = -182.52433348038366  E_coul = 54.00613284622422
cycle= 1 E= -128.518200634159  delta_E=    0  |g|= 2.64e-07  |ddm|= 1.94e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52433348038366  E_coul = 54.00613284622422
  HOMO = -0.847124922815946  LUMO = 0.861921301354693
  mo_energy =
[-3.27825633e+01 -1.93209581e+00 -8.47124923e-01 -8.47124923e-01
 -8.47124923e-01  8.61921301e-01  8.61921301e-01  8.61921301e-01
  1.20684781e+00  4.11537318e+00  4.11537318e+00  4.11537318e+00
  7.52620993e+00  1.49297913e+01  1.49297913e+01  1.49297913e+01
  3.53452384e+01  6.05550877e+01  6.05550877e+01  6.05550877e+01
  1.39829703e+02  5.04081826e+02  1.87165118e+03  8.00116138e+03
  4.77686082e+04]
E1 = -182.52433246047215  E_coul = 54.00613182631278
Extra cycle  E= -128.518200634159  delta_E= 5.68e-14  |g|= 1.39e-07  |ddm|= 9.28e-08
    CPU time for scf_cycle      0.24 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721747e+02
 7.64809239e+01 1.01206873e+01 2.71468766e+01 3.83155328e-01
 3.00749458e+00 1.13633898e+00 2.50853021e+00 7.38104123e+00
 2.82843814e+01 2.81204341e-01 8.79382205e-01]
grad_E = [ 2.60241062e-11 -1.29573637e-09  2.62911573e-08 -3.28911364e-07
  2.92030374e-06  8.43267178e-05 -1.99642075e-05 -3.19205177e-04
  1.51835342e-04 -4.17521820e-04 -5.09510726e-04 -1.16118153e-03
 -1.56091952e-03  2.27582297e-03  6.00001538e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.4543981         1
[INPUT] 0    0    [1    /1   ]  833.272433713        1
[INPUT] 0    0    [1    /1   ]  235.721750353        1
[INPUT] 0    0    [1    /1   ]  76.4808981951        1
[INPUT] 0    0    [1    /1   ]  10.1199946752        1
[INPUT] 0    0    [1    /1   ]  27.1470467827        1
[INPUT] 0    0    [1    /1   ]  0.384459533783       1
[INPUT] 0    0    [1    /1   ]  3.006280893          1
[INPUT] 0    0    [1    /1   ]  1.13962210087        1
[INPUT] 1    0    [1    /1   ]  2.52790877426        1
[INPUT] 1    0    [1    /1   ]  7.41447200328        1
[INPUT] 1    0    [1    /1   ]  28.2944022748        1
[INPUT] 1    0    [1    /1   ]  0.278066233447       1
[INPUT] 1    0    [1    /1   ]  0.875508922602       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141102, 1.0]], [0, [3661.454398096734, 1.0]], [0, [833.2724337125493, 1.0]], [0, [235.72175035312327, 1.0]], [0, [76.48089819508196, 1.0]], [0, [10.11999467520361, 1.0]], [0, [27.147046782663423, 1.0]], [0, [0.3844595337833787, 1.0]], [0, [3.006280892999881, 1.0]], [0, [1.1396221008681706, 1.0]], [1, [2.5279087742576434, 1.0]], [1, [7.41447200327541, 1.0]], [1, [28.29440227481934, 1.0]], [1, [0.278066233447477, 1.0]], [1, [0.8755089226020044, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.4543981]
bas 2, expnt(s) = [833.27243371]
bas 3, expnt(s) = [235.72175035]
bas 4, expnt(s) = [76.4808982]
bas 5, expnt(s) = [10.11999468]
bas 6, expnt(s) = [27.14704678]
bas 7, expnt(s) = [0.38445953]
bas 8, expnt(s) = [3.00628089]
bas 9, expnt(s) = [1.1396221]
bas 10, expnt(s) = [2.52790877]
bas 11, expnt(s) = [7.414472]
bas 12, expnt(s) = [28.29440227]
bas 13, expnt(s) = [0.27806623]
bas 14, expnt(s) = [0.87550892]
CPU time:        54.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721750e+02 1.51989913e+02
 7.64808982e+01 6.53400946e+01 1.01199947e+01 1.43350838e+01
 2.71470468e+01 3.00474048e+01 3.84459534e-01 1.23353933e+00
 3.00628089e+00 5.76815858e+00 1.13962210e+00 2.78667083e+00
 2.52790877e+00 9.29899768e+00 7.41447200e+00 3.56931338e+01
 2.82944023e+01 1.90375057e+02 2.78066233e-01 5.89073804e-01
 8.75508923e-01 2.47064367e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999392848908705
cond(S) = 354.3964594748284
E1 = -183.561374491473  E_coul = 55.07663316423032
init E= -128.484741327243
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771763008112352  LUMO = 0.87198776970207
  mo_energy =
[-3.25563739e+01 -1.85276721e+00 -7.71763008e-01 -7.71763008e-01
 -7.71763008e-01  8.71987770e-01  8.71987770e-01  8.71987770e-01
  1.24462097e+00  4.17472314e+00  4.17472314e+00  4.17472314e+00
  7.63473868e+00  1.51235694e+01  1.51235694e+01  1.51235694e+01
  3.55316189e+01  6.09192539e+01  6.09192539e+01  6.09192539e+01
  1.40063328e+02  5.04348048e+02  1.87194712e+03  8.00148275e+03
  4.77689461e+04]
E1 = -181.9985223244912  E_coul = 53.484061429943495
cycle= 1 E= -128.514460894548  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506357
diis-c [-0.25639737  1.        ]
  HOMO = -0.884093096511955  LUMO = 0.842516951461238
  mo_energy =
[-3.28947377e+01 -1.97106356e+00 -8.84093097e-01 -8.84093097e-01
 -8.84093097e-01  8.42516951e-01  8.42516951e-01  8.42516951e-01
  1.19652108e+00  4.07028161e+00  4.07028161e+00  4.07028161e+00
  7.49472849e+00  1.49201709e+01  1.49201709e+01  1.49201709e+01
  3.52731776e+01  6.06131802e+01  6.06131802e+01  6.06131802e+01
  1.39730635e+02  5.03970013e+02  1.87153284e+03  8.00103948e+03
  4.77684841e+04]
E1 = -182.78909780855562  E_coul = 54.27181587065714
cycle= 2 E= -128.517281937898  delta_E= -0.00282  |g|= 0.108  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257766
diis-c [-5.98406186e-04  3.36586518e-01  6.63413482e-01]
  HOMO = -0.84713378414629  LUMO = 0.852231667599306
  mo_energy =
[-3.27825855e+01 -1.93214277e+00 -8.47133784e-01 -8.47133784e-01
 -8.47133784e-01  8.52231668e-01  8.52231668e-01  8.52231668e-01
  1.21203889e+00  4.10439387e+00  4.10439387e+00  4.10439387e+00
  7.54066334e+00  1.49876694e+01  1.49876694e+01  1.49876694e+01
  3.53593512e+01  6.07148014e+01  6.07148014e+01  6.07148014e+01
  1.39840719e+02  5.04091262e+02  1.87165957e+03  8.00116879e+03
  4.77686144e+04]
E1 = -182.52256877010748  E_coul = 54.00429775838721
cycle= 3 E= -128.51827101172  delta_E= -0.000989  |g|= 0.000265  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000333761
diis-c [-4.46562789e-08 -1.79744535e-03 -2.62355639e-03  1.00442100e+00]
  HOMO = -0.847276053797309  LUMO = 0.852226792235369
  mo_energy =
[-3.27827725e+01 -1.93226776e+00 -8.47276054e-01 -8.47276054e-01
 -8.47276054e-01  8.52226792e-01  8.52226792e-01  8.52226792e-01
  1.21199690e+00  4.10431969e+00  4.10431969e+00  4.10431969e+00
  7.54055584e+00  1.49875445e+01  1.49875445e+01  1.49875445e+01
  3.53592007e+01  6.07146294e+01  6.07146294e+01  6.07146294e+01
  1.39840538e+02  5.04091041e+02  1.87165929e+03  8.00116847e+03
  4.77686140e+04]
E1 = -182.52243997077966  E_coul = 54.00416895234078
cycle= 4 E= -128.518271018439  delta_E= -6.72e-09  |g|= 4.89e-05  |ddm|= 0.000172
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.29143e-05
diis-c [-3.78687786e-10  2.50518653e-05  3.50457133e-04 -8.33435064e-02
  1.08296800e+00]
  HOMO = -0.84730216089262  LUMO = 0.852217816906168
  mo_energy =
[-3.27828142e+01 -1.93229545e+00 -8.47302161e-01 -8.47302161e-01
 -8.47302161e-01  8.52217817e-01  8.52217817e-01  8.52217817e-01
  1.21198062e+00  4.10429347e+00  4.10429347e+00  4.10429347e+00
  7.54052341e+00  1.49875074e+01  1.49875074e+01  1.49875074e+01
  3.53591599e+01  6.07145881e+01  6.07145881e+01  6.07145881e+01
  1.39840497e+02  5.04091003e+02  1.87165926e+03  8.00116843e+03
  4.77686140e+04]
E1 = -182.52251434241188  E_coul = 54.004243323795855
cycle= 5 E= -128.518271018616  delta_E= -1.77e-10  |g|= 1.3e-06  |ddm|= 1.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52251434241188  E_coul = 54.004243323795855
  HOMO = -0.847301883882995  LUMO = 0.852217826172199
  mo_energy =
[-3.27828129e+01 -1.93229527e+00 -8.47301884e-01 -8.47301884e-01
 -8.47301884e-01  8.52217826e-01  8.52217826e-01  8.52217826e-01
  1.21198054e+00  4.10429366e+00  4.10429366e+00  4.10429366e+00
  7.54052373e+00  1.49875081e+01  1.49875081e+01  1.49875081e+01
  3.53591608e+01  6.07145892e+01  6.07145892e+01  6.07145892e+01
  1.39840498e+02  5.04091004e+02  1.87165926e+03  8.00116843e+03
  4.77686140e+04]
E1 = -182.5225096469265  E_coul = 54.004238628309814
Extra cycle  E= -128.518271018617  delta_E= -6.54e-13  |g|= 6.35e-07  |ddm|= 8.17e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721750e+02
 7.64808982e+01 1.01199947e+01 2.71470468e+01 3.84459534e-01
 3.00628089e+00 1.13962210e+00 2.52790877e+00 7.41447200e+00
 2.82944023e+01 2.78066233e-01 8.75508923e-01]
E = -128.51827101861667
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.4543981         1
[INPUT] 0    0    [1    /1   ]  833.272433713        1
[INPUT] 0    0    [1    /1   ]  235.721750353        1
[INPUT] 0    0    [1    /1   ]  76.4808981951        1
[INPUT] 0    0    [1    /1   ]  10.1199946752        1
[INPUT] 0    0    [1    /1   ]  27.1470467827        1
[INPUT] 0    0    [1    /1   ]  0.384459533783       1
[INPUT] 0    0    [1    /1   ]  3.006280893          1
[INPUT] 0    0    [1    /1   ]  1.13962210087        1
[INPUT] 1    0    [1    /1   ]  2.52790877426        1
[INPUT] 1    0    [1    /1   ]  7.41447200328        1
[INPUT] 1    0    [1    /1   ]  28.2944022748        1
[INPUT] 1    0    [1    /1   ]  0.278066233447       1
[INPUT] 1    0    [1    /1   ]  0.875508922602       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141102, 1.0]], [0, [3661.454398096734, 1.0]], [0, [833.2724337125493, 1.0]], [0, [235.72175035312327, 1.0]], [0, [76.48089819508196, 1.0]], [0, [10.11999467520361, 1.0]], [0, [27.147046782663423, 1.0]], [0, [0.3844595337833787, 1.0]], [0, [3.006280892999881, 1.0]], [0, [1.1396221008681706, 1.0]], [1, [2.5279087742576434, 1.0]], [1, [7.41447200327541, 1.0]], [1, [28.29440227481934, 1.0]], [1, [0.278066233447477, 1.0]], [1, [0.8755089226020044, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.4543981]
bas 2, expnt(s) = [833.27243371]
bas 3, expnt(s) = [235.72175035]
bas 4, expnt(s) = [76.4808982]
bas 5, expnt(s) = [10.11999468]
bas 6, expnt(s) = [27.14704678]
bas 7, expnt(s) = [0.38445953]
bas 8, expnt(s) = [3.00628089]
bas 9, expnt(s) = [1.1396221]
bas 10, expnt(s) = [2.52790877]
bas 11, expnt(s) = [7.414472]
bas 12, expnt(s) = [28.29440227]
bas 13, expnt(s) = [0.27806623]
bas 14, expnt(s) = [0.87550892]
CPU time:        55.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721750e+02 1.51989913e+02
 7.64808982e+01 6.53400946e+01 1.01199947e+01 1.43350838e+01
 2.71470468e+01 3.00474048e+01 3.84459534e-01 1.23353933e+00
 3.00628089e+00 5.76815858e+00 1.13962210e+00 2.78667083e+00
 2.52790877e+00 9.29899768e+00 7.41447200e+00 3.56931338e+01
 2.82944023e+01 1.90375057e+02 2.78066233e-01 5.89073804e-01
 8.75508923e-01 2.47064367e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999392848908705
cond(S) = 354.3964594748284
E1 = -183.561374491473  E_coul = 55.07663316423032
init E= -128.484741327243
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771763008112352  LUMO = 0.87198776970207
  mo_energy =
[-3.25563739e+01 -1.85276721e+00 -7.71763008e-01 -7.71763008e-01
 -7.71763008e-01  8.71987770e-01  8.71987770e-01  8.71987770e-01
  1.24462097e+00  4.17472314e+00  4.17472314e+00  4.17472314e+00
  7.63473868e+00  1.51235694e+01  1.51235694e+01  1.51235694e+01
  3.55316189e+01  6.09192539e+01  6.09192539e+01  6.09192539e+01
  1.40063328e+02  5.04348048e+02  1.87194712e+03  8.00148275e+03
  4.77689461e+04]
E1 = -181.9985223244912  E_coul = 53.484061429943495
cycle= 1 E= -128.514460894548  delta_E= -0.0297  |g|= 0.213  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506357
diis-c [-0.25639737  1.        ]
  HOMO = -0.884093096511955  LUMO = 0.842516951461238
  mo_energy =
[-3.28947377e+01 -1.97106356e+00 -8.84093097e-01 -8.84093097e-01
 -8.84093097e-01  8.42516951e-01  8.42516951e-01  8.42516951e-01
  1.19652108e+00  4.07028161e+00  4.07028161e+00  4.07028161e+00
  7.49472849e+00  1.49201709e+01  1.49201709e+01  1.49201709e+01
  3.52731776e+01  6.06131802e+01  6.06131802e+01  6.06131802e+01
  1.39730635e+02  5.03970013e+02  1.87153284e+03  8.00103948e+03
  4.77684841e+04]
E1 = -182.78909780855562  E_coul = 54.27181587065714
cycle= 2 E= -128.517281937898  delta_E= -0.00282  |g|= 0.108  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257766
diis-c [-5.98406186e-04  3.36586518e-01  6.63413482e-01]
  HOMO = -0.84713378414629  LUMO = 0.852231667599306
  mo_energy =
[-3.27825855e+01 -1.93214277e+00 -8.47133784e-01 -8.47133784e-01
 -8.47133784e-01  8.52231668e-01  8.52231668e-01  8.52231668e-01
  1.21203889e+00  4.10439387e+00  4.10439387e+00  4.10439387e+00
  7.54066334e+00  1.49876694e+01  1.49876694e+01  1.49876694e+01
  3.53593512e+01  6.07148014e+01  6.07148014e+01  6.07148014e+01
  1.39840719e+02  5.04091262e+02  1.87165957e+03  8.00116879e+03
  4.77686144e+04]
E1 = -182.52256877010748  E_coul = 54.00429775838721
cycle= 3 E= -128.51827101172  delta_E= -0.000989  |g|= 0.000265  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000333761
diis-c [-4.46562789e-08 -1.79744535e-03 -2.62355639e-03  1.00442100e+00]
  HOMO = -0.847276053797309  LUMO = 0.852226792235369
  mo_energy =
[-3.27827725e+01 -1.93226776e+00 -8.47276054e-01 -8.47276054e-01
 -8.47276054e-01  8.52226792e-01  8.52226792e-01  8.52226792e-01
  1.21199690e+00  4.10431969e+00  4.10431969e+00  4.10431969e+00
  7.54055584e+00  1.49875445e+01  1.49875445e+01  1.49875445e+01
  3.53592007e+01  6.07146294e+01  6.07146294e+01  6.07146294e+01
  1.39840538e+02  5.04091041e+02  1.87165929e+03  8.00116847e+03
  4.77686140e+04]
E1 = -182.52243997077966  E_coul = 54.00416895234078
cycle= 4 E= -128.518271018439  delta_E= -6.72e-09  |g|= 4.89e-05  |ddm|= 0.000172
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.29143e-05
diis-c [-3.78687786e-10  2.50518653e-05  3.50457133e-04 -8.33435064e-02
  1.08296800e+00]
  HOMO = -0.84730216089262  LUMO = 0.852217816906168
  mo_energy =
[-3.27828142e+01 -1.93229545e+00 -8.47302161e-01 -8.47302161e-01
 -8.47302161e-01  8.52217817e-01  8.52217817e-01  8.52217817e-01
  1.21198062e+00  4.10429347e+00  4.10429347e+00  4.10429347e+00
  7.54052341e+00  1.49875074e+01  1.49875074e+01  1.49875074e+01
  3.53591599e+01  6.07145881e+01  6.07145881e+01  6.07145881e+01
  1.39840497e+02  5.04091003e+02  1.87165926e+03  8.00116843e+03
  4.77686140e+04]
E1 = -182.52251434241188  E_coul = 54.004243323795855
cycle= 5 E= -128.518271018616  delta_E= -1.77e-10  |g|= 1.3e-06  |ddm|= 1.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52251434241188  E_coul = 54.004243323795855
  HOMO = -0.847301883882995  LUMO = 0.852217826172199
  mo_energy =
[-3.27828129e+01 -1.93229527e+00 -8.47301884e-01 -8.47301884e-01
 -8.47301884e-01  8.52217826e-01  8.52217826e-01  8.52217826e-01
  1.21198054e+00  4.10429366e+00  4.10429366e+00  4.10429366e+00
  7.54052373e+00  1.49875081e+01  1.49875081e+01  1.49875081e+01
  3.53591608e+01  6.07145892e+01  6.07145892e+01  6.07145892e+01
  1.39840498e+02  5.04091004e+02  1.87165926e+03  8.00116843e+03
  4.77686140e+04]
E1 = -182.5225096469265  E_coul = 54.004238628309814
Extra cycle  E= -128.518271018617  delta_E= -6.54e-13  |g|= 6.35e-07  |ddm|= 8.17e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 354.3964594748284
E1 = -182.5225096469265  E_coul = 54.004238628309814
init E= -128.518271018617
    CPU time for initialize scf      0.21 sec, wall time      0.23 sec
  HOMO = -0.847302225693044  LUMO = 0.852217726754484
  mo_energy =
[-3.27828139e+01 -1.93229566e+00 -8.47302226e-01 -8.47302226e-01
 -8.47302226e-01  8.52217727e-01  8.52217727e-01  8.52217727e-01
  1.21198036e+00  4.10429333e+00  4.10429333e+00  4.10429333e+00
  7.54052329e+00  1.49875075e+01  1.49875075e+01  1.49875075e+01
  3.53591601e+01  6.07145883e+01  6.07145883e+01  6.07145883e+01
  1.39840497e+02  5.04091003e+02  1.87165926e+03  8.00116843e+03
  4.77686140e+04]
E1 = -182.5225117278886  E_coul = 54.00424070927212
cycle= 1 E= -128.518271018616  delta_E= 1.99e-13  |g|= 2.86e-07  |ddm|= 2.17e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5225117278886  E_coul = 54.00424070927212
  HOMO = -0.847302079322034  LUMO = 0.852217763996236
  mo_energy =
[-3.27828134e+01 -1.93229551e+00 -8.47302079e-01 -8.47302079e-01
 -8.47302079e-01  8.52217764e-01  8.52217764e-01  8.52217764e-01
  1.21198041e+00  4.10429347e+00  4.10429347e+00  4.10429347e+00
  7.54052347e+00  1.49875078e+01  1.49875078e+01  1.49875078e+01
  3.53591604e+01  6.07145887e+01  6.07145887e+01  6.07145887e+01
  1.39840498e+02  5.04091003e+02  1.87165926e+03  8.00116843e+03
  4.77686140e+04]
E1 = -182.5225106217104  E_coul = 54.00423960309412
Extra cycle  E= -128.518271018616  delta_E= 1.71e-13  |g|= 1.5e-07  |ddm|= 1e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.29 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721750e+02
 7.64808982e+01 1.01199947e+01 2.71470468e+01 3.84459534e-01
 3.00628089e+00 1.13962210e+00 2.52790877e+00 7.41447200e+00
 2.82944023e+01 2.78066233e-01 8.75508923e-01]
grad_E = [ 1.56294795e-11 -7.49548044e-10  1.52921085e-08 -1.96523831e-07
  1.85841157e-06  6.74785222e-05 -1.43508091e-05 -2.60691190e-04
  1.24984775e-04 -2.84274352e-04  2.01416146e-03 -1.56129084e-03
 -1.55469726e-03  2.18828940e-03  1.64373294e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439811        1
[INPUT] 0    0    [1    /1   ]  833.272433445        1
[INPUT] 0    0    [1    /1   ]  235.721753691        1
[INPUT] 0    0    [1    /1   ]  76.4808688257        1
[INPUT] 0    0    [1    /1   ]  10.1191793143        1
[INPUT] 0    0    [1    /1   ]  27.147243811         1
[INPUT] 0    0    [1    /1   ]  0.386088575571       1
[INPUT] 0    0    [1    /1   ]  3.00482529156        1
[INPUT] 0    0    [1    /1   ]  1.1437139647         1
[INPUT] 1    0    [1    /1   ]  2.53007105174        1
[INPUT] 1    0    [1    /1   ]  7.44668188096        1
[INPUT] 1    0    [1    /1   ]  28.307295894         1
[INPUT] 1    0    [1    /1   ]  0.273197255065       1
[INPUT] 1    0    [1    /1   ]  0.86410456473        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410756, 1.0]], [0, [3661.4543981099337, 1.0]], [0, [833.2724334448703, 1.0]], [0, [235.72175369120018, 1.0]], [0, [76.48086882567402, 1.0]], [0, [10.119179314258425, 1.0]], [0, [27.147243811021205, 1.0]], [0, [0.38608857557116627, 1.0]], [0, [3.004825291557187, 1.0]], [0, [1.1437139647036623, 1.0]], [1, [2.530071051736481, 1.0]], [1, [7.4466818809564845, 1.0]], [1, [28.30729589397891, 1.0]], [1, [0.2731972550654865, 1.0]], [1, [0.8641045647304305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439811]
bas 2, expnt(s) = [833.27243344]
bas 3, expnt(s) = [235.72175369]
bas 4, expnt(s) = [76.48086883]
bas 5, expnt(s) = [10.11917931]
bas 6, expnt(s) = [27.14724381]
bas 7, expnt(s) = [0.38608858]
bas 8, expnt(s) = [3.00482529]
bas 9, expnt(s) = [1.14371396]
bas 10, expnt(s) = [2.53007105]
bas 11, expnt(s) = [7.44668188]
bas 12, expnt(s) = [28.30729589]
bas 13, expnt(s) = [0.27319726]
bas 14, expnt(s) = [0.86410456]
CPU time:        57.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721754e+02 1.51989915e+02
 7.64808688e+01 6.53400758e+01 1.01191793e+01 1.43342176e+01
 2.71472438e+01 3.00475684e+01 3.86088576e-01 1.23745734e+00
 3.00482529e+00 5.76606380e+00 1.14371396e+00 2.79417172e+00
 2.53007105e+00 9.30894125e+00 7.44668188e+00 3.58870611e+01
 2.83072959e+01 1.90483505e+02 2.73197255e-01 5.76208694e-01
 8.64104565e-01 2.43048120e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999432373230881
cond(S) = 355.4970525995603
E1 = -183.5613489328778  E_coul = 55.07655798135893
init E= -128.484790951519
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771785523151017  LUMO = 0.855007343604315
  mo_energy =
[-3.25563882e+01 -1.85277334e+00 -7.71785523e-01 -7.71785523e-01
 -7.71785523e-01  8.55007344e-01  8.55007344e-01  8.55007344e-01
  1.25128609e+00  4.12786610e+00  4.12786610e+00  4.12786610e+00
  7.65295327e+00  1.51019446e+01  1.51019446e+01  1.51019446e+01
  3.55495490e+01  6.09957913e+01  6.09957913e+01  6.09957913e+01
  1.40077460e+02  5.04360152e+02  1.87195782e+03  8.00149213e+03
  4.77689539e+04]
E1 = -181.9941692801314  E_coul = 53.479657852671444
cycle= 1 E= -128.51451142746  delta_E= -0.0297  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.507077
diis-c [-0.25712733  1.        ]
  HOMO = -0.884466687947576  LUMO = 0.826054170681985
  mo_energy =
[-3.28954436e+01 -1.97148103e+00 -8.84466688e-01 -8.84466688e-01
 -8.84466688e-01  8.26054171e-01  8.26054171e-01  8.26054171e-01
  1.20277428e+00  4.02334873e+00  4.02334873e+00  4.02334873e+00
  7.51242875e+00  1.48975007e+01  1.48975007e+01  1.48975007e+01
  3.52905003e+01  6.06889393e+01  6.06889393e+01  6.06889393e+01
  1.39744087e+02  5.03981404e+02  1.87154282e+03  8.00104813e+03
  4.77684911e+04]
E1 = -182.7878317524834  E_coul = 54.27048637067944
cycle= 2 E= -128.517345381804  delta_E= -0.00283  |g|= 0.108  |ddm|= 0.0709
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.258476
diis-c [-5.99552507e-04  3.36886523e-01  6.63113477e-01]
  HOMO = -0.847372644137887  LUMO = 0.835604156915998
  mo_energy =
[-3.27829379e+01 -1.93241273e+00 -8.47372644e-01 -8.47372644e-01
 -8.47372644e-01  8.35604157e-01  8.35604157e-01  8.35604157e-01
  1.21842763e+00  4.05750057e+00  4.05750057e+00  4.05750057e+00
  7.55855103e+00  1.49653981e+01  1.49653981e+01  1.49653981e+01
  3.53769498e+01  6.07909253e+01  6.07909253e+01  6.07909253e+01
  1.39854516e+02  5.04103026e+02  1.87166993e+03  8.00117783e+03
  4.77686218e+04]
E1 = -182.52007676917702  E_coul = 54.00173439057482
cycle= 3 E= -128.518342378602  delta_E= -0.000997  |g|= 0.00026  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000324476
diis-c [-4.52908363e-08 -1.78786880e-03 -2.66189751e-03  1.00444977e+00]
  HOMO = -0.847512227473084  LUMO = 0.83560097626162
  mo_energy =
[-3.27831203e+01 -1.93253641e+00 -8.47512227e-01 -8.47512227e-01
 -8.47512227e-01  8.35600976e-01  8.35600976e-01  8.35600976e-01
  1.21838675e+00  4.05742976e+00  4.05742976e+00  4.05742976e+00
  7.55844613e+00  1.49652768e+01  1.49652768e+01  1.49652768e+01
  3.53768033e+01  6.07907576e+01  6.07907576e+01  6.07907576e+01
  1.39854339e+02  5.04102809e+02  1.87166966e+03  8.00117751e+03
  4.77686214e+04]
E1 = -182.5199353682504  E_coul = 54.00159298307941
cycle= 4 E= -128.518342385171  delta_E= -6.57e-09  |g|= 4.87e-05  |ddm|= 0.000169
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.14984e-05
diis-c [-3.95234409e-10  2.56854181e-05  3.47668195e-04 -8.54698482e-02
  1.08509649e+00]
  HOMO = -0.847538222082269  LUMO = 0.83559217669181
  mo_energy =
[-3.27831617e+01 -1.93256440e+00 -8.47538222e-01 -8.47538222e-01
 -8.47538222e-01  8.35592177e-01  8.35592177e-01  8.35592177e-01
  1.21837024e+00  4.05740364e+00  4.05740364e+00  4.05740364e+00
  7.55841360e+00  1.49652398e+01  1.49652398e+01  1.49652398e+01
  3.53767625e+01  6.07907164e+01  6.07907164e+01  6.07907164e+01
  1.39854299e+02  5.04102771e+02  1.87166962e+03  8.00117748e+03
  4.77686214e+04]
E1 = -182.52000905246734  E_coul = 54.0016666671199
cycle= 5 E= -128.518342385347  delta_E= -1.76e-10  |g|= 1.47e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52000905246734  E_coul = 54.0016666671199
  HOMO = -0.847537830510329  LUMO = 0.835592212635232
  mo_energy =
[-3.27831602e+01 -1.93256415e+00 -8.47537831e-01 -8.47537831e-01
 -8.47537831e-01  8.35592213e-01  8.35592213e-01  8.35592213e-01
  1.21837017e+00  4.05740393e+00  4.05740393e+00  4.05740393e+00
  7.55841403e+00  1.49652406e+01  1.49652406e+01  1.49652406e+01
  3.53767637e+01  6.07907177e+01  6.07907177e+01  6.07907177e+01
  1.39854300e+02  5.04102772e+02  1.87166962e+03  8.00117748e+03
  4.77686214e+04]
E1 = -182.5200036515635  E_coul = 54.0016612662162
Extra cycle  E= -128.518342385347  delta_E= 1.42e-13  |g|= 7.4e-07  |ddm|= 8.93e-07
    CPU time for scf_cycle      0.13 sec, wall time      0.15 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721754e+02
 7.64808688e+01 1.01191793e+01 2.71472438e+01 3.86088576e-01
 3.00482529e+00 1.14371396e+00 2.53007105e+00 7.44668188e+00
 2.83072959e+01 2.73197255e-01 8.64104565e-01]
E = -128.5183423853473
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439811        1
[INPUT] 0    0    [1    /1   ]  833.272433445        1
[INPUT] 0    0    [1    /1   ]  235.721753691        1
[INPUT] 0    0    [1    /1   ]  76.4808688257        1
[INPUT] 0    0    [1    /1   ]  10.1191793143        1
[INPUT] 0    0    [1    /1   ]  27.147243811         1
[INPUT] 0    0    [1    /1   ]  0.386088575571       1
[INPUT] 0    0    [1    /1   ]  3.00482529156        1
[INPUT] 0    0    [1    /1   ]  1.1437139647         1
[INPUT] 1    0    [1    /1   ]  2.53007105174        1
[INPUT] 1    0    [1    /1   ]  7.44668188096        1
[INPUT] 1    0    [1    /1   ]  28.307295894         1
[INPUT] 1    0    [1    /1   ]  0.273197255065       1
[INPUT] 1    0    [1    /1   ]  0.86410456473        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410756, 1.0]], [0, [3661.4543981099337, 1.0]], [0, [833.2724334448703, 1.0]], [0, [235.72175369120018, 1.0]], [0, [76.48086882567402, 1.0]], [0, [10.119179314258425, 1.0]], [0, [27.147243811021205, 1.0]], [0, [0.38608857557116627, 1.0]], [0, [3.004825291557187, 1.0]], [0, [1.1437139647036623, 1.0]], [1, [2.530071051736481, 1.0]], [1, [7.4466818809564845, 1.0]], [1, [28.30729589397891, 1.0]], [1, [0.2731972550654865, 1.0]], [1, [0.8641045647304305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439811]
bas 2, expnt(s) = [833.27243344]
bas 3, expnt(s) = [235.72175369]
bas 4, expnt(s) = [76.48086883]
bas 5, expnt(s) = [10.11917931]
bas 6, expnt(s) = [27.14724381]
bas 7, expnt(s) = [0.38608858]
bas 8, expnt(s) = [3.00482529]
bas 9, expnt(s) = [1.14371396]
bas 10, expnt(s) = [2.53007105]
bas 11, expnt(s) = [7.44668188]
bas 12, expnt(s) = [28.30729589]
bas 13, expnt(s) = [0.27319726]
bas 14, expnt(s) = [0.86410456]
CPU time:        58.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721754e+02 1.51989915e+02
 7.64808688e+01 6.53400758e+01 1.01191793e+01 1.43342176e+01
 2.71472438e+01 3.00475684e+01 3.86088576e-01 1.23745734e+00
 3.00482529e+00 5.76606380e+00 1.14371396e+00 2.79417172e+00
 2.53007105e+00 9.30894125e+00 7.44668188e+00 3.58870611e+01
 2.83072959e+01 1.90483505e+02 2.73197255e-01 5.76208694e-01
 8.64104565e-01 2.43048120e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999432373230881
cond(S) = 355.4970525995603
E1 = -183.5613489328778  E_coul = 55.07655798135893
init E= -128.484790951519
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.771785523151017  LUMO = 0.855007343604315
  mo_energy =
[-3.25563882e+01 -1.85277334e+00 -7.71785523e-01 -7.71785523e-01
 -7.71785523e-01  8.55007344e-01  8.55007344e-01  8.55007344e-01
  1.25128609e+00  4.12786610e+00  4.12786610e+00  4.12786610e+00
  7.65295327e+00  1.51019446e+01  1.51019446e+01  1.51019446e+01
  3.55495490e+01  6.09957913e+01  6.09957913e+01  6.09957913e+01
  1.40077460e+02  5.04360152e+02  1.87195782e+03  8.00149213e+03
  4.77689539e+04]
E1 = -181.9941692801314  E_coul = 53.479657852671444
cycle= 1 E= -128.51451142746  delta_E= -0.0297  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507077
diis-c [-0.25712733  1.        ]
  HOMO = -0.884466687947576  LUMO = 0.826054170681985
  mo_energy =
[-3.28954436e+01 -1.97148103e+00 -8.84466688e-01 -8.84466688e-01
 -8.84466688e-01  8.26054171e-01  8.26054171e-01  8.26054171e-01
  1.20277428e+00  4.02334873e+00  4.02334873e+00  4.02334873e+00
  7.51242875e+00  1.48975007e+01  1.48975007e+01  1.48975007e+01
  3.52905003e+01  6.06889393e+01  6.06889393e+01  6.06889393e+01
  1.39744087e+02  5.03981404e+02  1.87154282e+03  8.00104813e+03
  4.77684911e+04]
E1 = -182.7878317524834  E_coul = 54.27048637067944
cycle= 2 E= -128.517345381804  delta_E= -0.00283  |g|= 0.108  |ddm|= 0.0709
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258476
diis-c [-5.99552507e-04  3.36886523e-01  6.63113477e-01]
  HOMO = -0.847372644137887  LUMO = 0.835604156915998
  mo_energy =
[-3.27829379e+01 -1.93241273e+00 -8.47372644e-01 -8.47372644e-01
 -8.47372644e-01  8.35604157e-01  8.35604157e-01  8.35604157e-01
  1.21842763e+00  4.05750057e+00  4.05750057e+00  4.05750057e+00
  7.55855103e+00  1.49653981e+01  1.49653981e+01  1.49653981e+01
  3.53769498e+01  6.07909253e+01  6.07909253e+01  6.07909253e+01
  1.39854516e+02  5.04103026e+02  1.87166993e+03  8.00117783e+03
  4.77686218e+04]
E1 = -182.52007676917702  E_coul = 54.00173439057482
cycle= 3 E= -128.518342378602  delta_E= -0.000997  |g|= 0.00026  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000324476
diis-c [-4.52908363e-08 -1.78786880e-03 -2.66189751e-03  1.00444977e+00]
  HOMO = -0.847512227473084  LUMO = 0.83560097626162
  mo_energy =
[-3.27831203e+01 -1.93253641e+00 -8.47512227e-01 -8.47512227e-01
 -8.47512227e-01  8.35600976e-01  8.35600976e-01  8.35600976e-01
  1.21838675e+00  4.05742976e+00  4.05742976e+00  4.05742976e+00
  7.55844613e+00  1.49652768e+01  1.49652768e+01  1.49652768e+01
  3.53768033e+01  6.07907576e+01  6.07907576e+01  6.07907576e+01
  1.39854339e+02  5.04102809e+02  1.87166966e+03  8.00117751e+03
  4.77686214e+04]
E1 = -182.5199353682504  E_coul = 54.00159298307941
cycle= 4 E= -128.518342385171  delta_E= -6.57e-09  |g|= 4.87e-05  |ddm|= 0.000169
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.14984e-05
diis-c [-3.95234409e-10  2.56854181e-05  3.47668195e-04 -8.54698482e-02
  1.08509649e+00]
  HOMO = -0.847538222082269  LUMO = 0.83559217669181
  mo_energy =
[-3.27831617e+01 -1.93256440e+00 -8.47538222e-01 -8.47538222e-01
 -8.47538222e-01  8.35592177e-01  8.35592177e-01  8.35592177e-01
  1.21837024e+00  4.05740364e+00  4.05740364e+00  4.05740364e+00
  7.55841360e+00  1.49652398e+01  1.49652398e+01  1.49652398e+01
  3.53767625e+01  6.07907164e+01  6.07907164e+01  6.07907164e+01
  1.39854299e+02  5.04102771e+02  1.87166962e+03  8.00117748e+03
  4.77686214e+04]
E1 = -182.52000905246734  E_coul = 54.0016666671199
cycle= 5 E= -128.518342385347  delta_E= -1.76e-10  |g|= 1.47e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52000905246734  E_coul = 54.0016666671199
  HOMO = -0.847537830510329  LUMO = 0.835592212635232
  mo_energy =
[-3.27831602e+01 -1.93256415e+00 -8.47537831e-01 -8.47537831e-01
 -8.47537831e-01  8.35592213e-01  8.35592213e-01  8.35592213e-01
  1.21837017e+00  4.05740393e+00  4.05740393e+00  4.05740393e+00
  7.55841403e+00  1.49652406e+01  1.49652406e+01  1.49652406e+01
  3.53767637e+01  6.07907177e+01  6.07907177e+01  6.07907177e+01
  1.39854300e+02  5.04102772e+02  1.87166962e+03  8.00117748e+03
  4.77686214e+04]
E1 = -182.5200036515635  E_coul = 54.0016612662162
Extra cycle  E= -128.518342385347  delta_E= 1.42e-13  |g|= 7.4e-07  |ddm|= 8.93e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 355.4970525995603
E1 = -182.5200036515635  E_coul = 54.0016612662162
init E= -128.518342385347
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.847538219706933  LUMO = 0.83559210225511
  mo_energy =
[-3.27831613e+01 -1.93256460e+00 -8.47538220e-01 -8.47538220e-01
 -8.47538220e-01  8.35592102e-01  8.35592102e-01  8.35592102e-01
  1.21836997e+00  4.05740355e+00  4.05740355e+00  4.05740355e+00
  7.55841353e+00  1.49652400e+01  1.49652400e+01  1.49652400e+01
  3.53767628e+01  6.07907167e+01  6.07907167e+01  6.07907167e+01
  1.39854299e+02  5.04102771e+02  1.87166962e+03  8.00117748e+03
  4.77686214e+04]
E1 = -182.52000608020288  E_coul = 54.00166369485555
cycle= 1 E= -128.518342385347  delta_E= -2.84e-14  |g|= 3.33e-07  |ddm|= 2.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52000608020288  E_coul = 54.00166369485555
  HOMO = -0.847538048301011  LUMO = 0.835592145003541
  mo_energy =
[-3.27831608e+01 -1.93256443e+00 -8.47538048e-01 -8.47538048e-01
 -8.47538048e-01  8.35592145e-01  8.35592145e-01  8.35592145e-01
  1.21837003e+00  4.05740371e+00  4.05740371e+00  4.05740371e+00
  7.55841373e+00  1.49652403e+01  1.49652403e+01  1.49652403e+01
  3.53767632e+01  6.07907172e+01  6.07907172e+01  6.07907172e+01
  1.39854300e+02  5.04102772e+02  1.87166962e+03  8.00117748e+03
  4.77686214e+04]
E1 = -182.52000479015499  E_coul = 54.0016624048075
Extra cycle  E= -128.518342385347  delta_E= -1.71e-13  |g|= 1.76e-07  |ddm|= 1.16e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721754e+02
 7.64808688e+01 1.01191793e+01 2.71472438e+01 3.86088576e-01
 3.00482529e+00 1.14371396e+00 2.53007105e+00 7.44668188e+00
 2.83072959e+01 2.73197255e-01 8.64104565e-01]
grad_E = [ 3.22114415e-12 -9.73834349e-11  2.15844327e-09 -3.81947849e-08
  5.85166180e-07  4.71704226e-05 -7.57767103e-06 -1.49250855e-04
  9.45464735e-05 -1.43357306e-04  3.57311570e-03 -1.54083035e-03
 -1.58565194e-03  1.72195447e-03 -2.38058603e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433203        1
[INPUT] 0    0    [1    /1   ]  235.721756728        1
[INPUT] 0    0    [1    /1   ]  76.4808417347        1
[INPUT] 0    0    [1    /1   ]  10.118380475         1
[INPUT] 0    0    [1    /1   ]  27.1474309887        1
[INPUT] 0    0    [1    /1   ]  0.387698546151       1
[INPUT] 0    0    [1    /1   ]  3.00336935427        1
[INPUT] 0    0    [1    /1   ]  1.14780948366        1
[INPUT] 1    0    [1    /1   ]  2.51178892727        1
[INPUT] 1    0    [1    /1   ]  7.47474393001        1
[INPUT] 1    0    [1    /1   ]  28.3213512168        1
[INPUT] 1    0    [1    /1   ]  0.267490731953       1
[INPUT] 1    0    [1    /1   ]  0.846841150238       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410512, 1.0]], [0, [3661.454398121863, 1.0]], [0, [833.2724332026797, 1.0]], [0, [235.72175672815803, 1.0]], [0, [76.48084173468796, 1.0]], [0, [10.118380474969861, 1.0]], [0, [27.147430988699274, 1.0]], [0, [0.38769854615065186, 1.0]], [0, [3.0033693542743456, 1.0]], [0, [1.1478094836578987, 1.0]], [1, [2.51178892727258, 1.0]], [1, [7.4747439300055385, 1.0]], [1, [28.321351216845898, 1.0]], [1, [0.2674907319533913, 1.0]], [1, [0.8468411502377022, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.2724332]
bas 3, expnt(s) = [235.72175673]
bas 4, expnt(s) = [76.48084173]
bas 5, expnt(s) = [10.11838047]
bas 6, expnt(s) = [27.14743099]
bas 7, expnt(s) = [0.38769855]
bas 8, expnt(s) = [3.00336935]
bas 9, expnt(s) = [1.14780948]
bas 10, expnt(s) = [2.51178893]
bas 11, expnt(s) = [7.47474393]
bas 12, expnt(s) = [28.32135122]
bas 13, expnt(s) = [0.26749073]
bas 14, expnt(s) = [0.84684115]
CPU time:        61.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721757e+02 1.51989916e+02
 7.64808417e+01 6.53400584e+01 1.01183805e+01 1.43333689e+01
 2.71474310e+01 3.00477237e+01 3.87698546e-01 1.24132543e+00
 3.00336935e+00 5.76396829e+00 1.14780948e+00 2.80167259e+00
 2.51178893e+00 9.22493510e+00 7.47474393e+00 3.60561865e+01
 2.83213512e+01 1.90601737e+02 2.67490732e-01 5.61203430e-01
 8.46841150e-01 2.36993718e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999474558246714
cond(S) = 356.60849951520163
E1 = -183.56135777767457  E_coul = 55.07647933915088
init E= -128.484878438524
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771811495146171  LUMO = 0.83399659033227
  mo_energy =
[-3.25563886e+01 -1.85278364e+00 -7.71811495e-01 -7.71811495e-01
 -7.71811495e-01  8.33996590e-01  8.33996590e-01  8.33996590e-01
  1.25790156e+00  4.05059374e+00  4.05059374e+00  4.05059374e+00
  7.67105714e+00  1.49977381e+01  1.49977381e+01  1.49977381e+01
  3.55674239e+01  6.09747410e+01  6.09747410e+01  6.09747410e+01
  1.40091581e+02  5.04372207e+02  1.87196845e+03  8.00150143e+03
  4.77689616e+04]
E1 = -181.989742693091  E_coul = 53.47518507490499
cycle= 1 E= -128.514557618186  delta_E= -0.0297  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507749
diis-c [-0.25780925  1.        ]
  HOMO = -0.884845862438893  LUMO = 0.805769795681327
  mo_energy =
[-3.28961607e+01 -1.97190364e+00 -8.84845862e-01 -8.84845862e-01
 -8.84845862e-01  8.05769796e-01  8.05769796e-01  8.05769796e-01
  1.20896878e+00  3.94662664e+00  3.94662664e+00  3.94662664e+00
  7.53002513e+00  1.47924267e+01  1.47924267e+01  1.47924267e+01
  3.53077450e+01  6.06670141e+01  6.06670141e+01  6.06670141e+01
  1.39757510e+02  5.03992775e+02  1.87155277e+03  8.00105676e+03
  4.77684981e+04]
E1 = -182.78661850771002  E_coul = 54.26921331690562
cycle= 2 E= -128.517405190804  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259155
diis-c [-6.02993926e-04  3.37176869e-01  6.62823131e-01]
  HOMO = -0.84760997771845  LUMO = 0.815084283097357
  mo_energy =
[-3.27832860e+01 -1.93267996e+00 -8.47609978e-01 -8.47609978e-01
 -8.47609978e-01  8.15084283e-01  8.15084283e-01  8.15084283e-01
  1.22476050e+00  3.98061504e+00  3.98061504e+00  3.98061504e+00
  7.57634490e+00  1.48606668e+01  1.48606668e+01  1.48606668e+01
  3.53944832e+01  6.07693982e+01  6.07693982e+01  6.07693982e+01
  1.39868298e+02  5.04114784e+02  1.87168028e+03  8.00118686e+03
  4.77686292e+04]
E1 = -182.51757595471534  E_coul = 53.99916557678442
cycle= 3 E= -128.518410377931  delta_E= -0.00101  |g|= 0.000258  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000320653
diis-c [-4.72018770e-08 -1.78179627e-03 -2.68901394e-03  1.00447081e+00]
  HOMO = -0.847748364323049  LUMO = 0.81508198472732
  mo_energy =
[-3.27834679e+01 -1.93280407e+00 -8.47748364e-01 -8.47748364e-01
 -8.47748364e-01  8.15081985e-01  8.15081985e-01  8.15081985e-01
  1.22471930e+00  3.98054628e+00  3.98054628e+00  3.98054628e+00
  7.57624097e+00  1.48605469e+01  1.48605469e+01  1.48605469e+01
  3.53943379e+01  6.07692311e+01  6.07692311e+01  6.07692311e+01
  1.39868122e+02  5.04114566e+02  1.87168001e+03  8.00118654e+03
  4.77686288e+04]
E1 = -182.51742243276377  E_coul = 53.999012048103175
cycle= 4 E= -128.518410384661  delta_E= -6.73e-09  |g|= 4.92e-05  |ddm|= 0.000168
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.08723e-05
diis-c [-4.28383698e-10  2.97886254e-05  3.51719017e-04 -9.00255536e-02
  1.08964405e+00]
  HOMO = -0.847774646080845  LUMO = 0.815073245444716
  mo_energy =
[-3.27835097e+01 -1.93283285e+00 -8.47774646e-01 -8.47774646e-01
 -8.47774646e-01  8.15073245e-01  8.15073245e-01  8.15073245e-01
  1.22470220e+00  3.98051993e+00  3.98051993e+00  3.98051993e+00
  7.57620782e+00  1.48605095e+01  1.48605095e+01  1.48605095e+01
  3.53942967e+01  6.07691894e+01  6.07691894e+01  6.07691894e+01
  1.39868081e+02  5.04114528e+02  1.87167998e+03  8.00118651e+03
  4.77686288e+04]
E1 = -182.51749567013258  E_coul = 53.99908528528923
cycle= 5 E= -128.518410384843  delta_E= -1.83e-10  |g|= 1.73e-06  |ddm|= 1.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51749567013258  E_coul = 53.99908528528923
  HOMO = -0.847774091488499  LUMO = 0.815073318173762
  mo_energy =
[-3.27835078e+01 -1.93283250e+00 -8.47774091e-01 -8.47774091e-01
 -8.47774091e-01  8.15073318e-01  8.15073318e-01  8.15073318e-01
  1.22470217e+00  3.98052036e+00  3.98052036e+00  3.98052036e+00
  7.57620842e+00  1.48605106e+01  1.48605106e+01  1.48605106e+01
  3.53942981e+01  6.07691911e+01  6.07691911e+01  6.07691911e+01
  1.39868083e+02  5.04114530e+02  1.87167998e+03  8.00118651e+03
  4.77686288e+04]
E1 = -182.51748927584376  E_coul = 53.99907889100008
Extra cycle  E= -128.518410384844  delta_E= -3.13e-13  |g|= 8.87e-07  |ddm|= 1.02e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721757e+02
 7.64808417e+01 1.01183805e+01 2.71474310e+01 3.87698546e-01
 3.00336935e+00 1.14780948e+00 2.51178893e+00 7.47474393e+00
 2.83213512e+01 2.67490732e-01 8.46841150e-01]
E = -128.51841038484366
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433203        1
[INPUT] 0    0    [1    /1   ]  235.721756728        1
[INPUT] 0    0    [1    /1   ]  76.4808417347        1
[INPUT] 0    0    [1    /1   ]  10.118380475         1
[INPUT] 0    0    [1    /1   ]  27.1474309887        1
[INPUT] 0    0    [1    /1   ]  0.387698546151       1
[INPUT] 0    0    [1    /1   ]  3.00336935427        1
[INPUT] 0    0    [1    /1   ]  1.14780948366        1
[INPUT] 1    0    [1    /1   ]  2.51178892727        1
[INPUT] 1    0    [1    /1   ]  7.47474393001        1
[INPUT] 1    0    [1    /1   ]  28.3213512168        1
[INPUT] 1    0    [1    /1   ]  0.267490731953       1
[INPUT] 1    0    [1    /1   ]  0.846841150238       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410512, 1.0]], [0, [3661.454398121863, 1.0]], [0, [833.2724332026797, 1.0]], [0, [235.72175672815803, 1.0]], [0, [76.48084173468796, 1.0]], [0, [10.118380474969861, 1.0]], [0, [27.147430988699274, 1.0]], [0, [0.38769854615065186, 1.0]], [0, [3.0033693542743456, 1.0]], [0, [1.1478094836578987, 1.0]], [1, [2.51178892727258, 1.0]], [1, [7.4747439300055385, 1.0]], [1, [28.321351216845898, 1.0]], [1, [0.2674907319533913, 1.0]], [1, [0.8468411502377022, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.2724332]
bas 3, expnt(s) = [235.72175673]
bas 4, expnt(s) = [76.48084173]
bas 5, expnt(s) = [10.11838047]
bas 6, expnt(s) = [27.14743099]
bas 7, expnt(s) = [0.38769855]
bas 8, expnt(s) = [3.00336935]
bas 9, expnt(s) = [1.14780948]
bas 10, expnt(s) = [2.51178893]
bas 11, expnt(s) = [7.47474393]
bas 12, expnt(s) = [28.32135122]
bas 13, expnt(s) = [0.26749073]
bas 14, expnt(s) = [0.84684115]
CPU time:        61.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721757e+02 1.51989916e+02
 7.64808417e+01 6.53400584e+01 1.01183805e+01 1.43333689e+01
 2.71474310e+01 3.00477237e+01 3.87698546e-01 1.24132543e+00
 3.00336935e+00 5.76396829e+00 1.14780948e+00 2.80167259e+00
 2.51178893e+00 9.22493510e+00 7.47474393e+00 3.60561865e+01
 2.83213512e+01 1.90601737e+02 2.67490732e-01 5.61203430e-01
 8.46841150e-01 2.36993718e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999474558246714
cond(S) = 356.60849951520163
E1 = -183.56135777767457  E_coul = 55.07647933915088
init E= -128.484878438524
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771811495146171  LUMO = 0.83399659033227
  mo_energy =
[-3.25563886e+01 -1.85278364e+00 -7.71811495e-01 -7.71811495e-01
 -7.71811495e-01  8.33996590e-01  8.33996590e-01  8.33996590e-01
  1.25790156e+00  4.05059374e+00  4.05059374e+00  4.05059374e+00
  7.67105714e+00  1.49977381e+01  1.49977381e+01  1.49977381e+01
  3.55674239e+01  6.09747410e+01  6.09747410e+01  6.09747410e+01
  1.40091581e+02  5.04372207e+02  1.87196845e+03  8.00150143e+03
  4.77689616e+04]
E1 = -181.989742693091  E_coul = 53.47518507490499
cycle= 1 E= -128.514557618186  delta_E= -0.0297  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507749
diis-c [-0.25780925  1.        ]
  HOMO = -0.884845862438893  LUMO = 0.805769795681327
  mo_energy =
[-3.28961607e+01 -1.97190364e+00 -8.84845862e-01 -8.84845862e-01
 -8.84845862e-01  8.05769796e-01  8.05769796e-01  8.05769796e-01
  1.20896878e+00  3.94662664e+00  3.94662664e+00  3.94662664e+00
  7.53002513e+00  1.47924267e+01  1.47924267e+01  1.47924267e+01
  3.53077450e+01  6.06670141e+01  6.06670141e+01  6.06670141e+01
  1.39757510e+02  5.03992775e+02  1.87155277e+03  8.00105676e+03
  4.77684981e+04]
E1 = -182.78661850771002  E_coul = 54.26921331690562
cycle= 2 E= -128.517405190804  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259155
diis-c [-6.02993926e-04  3.37176869e-01  6.62823131e-01]
  HOMO = -0.84760997771845  LUMO = 0.815084283097357
  mo_energy =
[-3.27832860e+01 -1.93267996e+00 -8.47609978e-01 -8.47609978e-01
 -8.47609978e-01  8.15084283e-01  8.15084283e-01  8.15084283e-01
  1.22476050e+00  3.98061504e+00  3.98061504e+00  3.98061504e+00
  7.57634490e+00  1.48606668e+01  1.48606668e+01  1.48606668e+01
  3.53944832e+01  6.07693982e+01  6.07693982e+01  6.07693982e+01
  1.39868298e+02  5.04114784e+02  1.87168028e+03  8.00118686e+03
  4.77686292e+04]
E1 = -182.51757595471534  E_coul = 53.99916557678442
cycle= 3 E= -128.518410377931  delta_E= -0.00101  |g|= 0.000258  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000320653
diis-c [-4.72018770e-08 -1.78179627e-03 -2.68901394e-03  1.00447081e+00]
  HOMO = -0.847748364323049  LUMO = 0.81508198472732
  mo_energy =
[-3.27834679e+01 -1.93280407e+00 -8.47748364e-01 -8.47748364e-01
 -8.47748364e-01  8.15081985e-01  8.15081985e-01  8.15081985e-01
  1.22471930e+00  3.98054628e+00  3.98054628e+00  3.98054628e+00
  7.57624097e+00  1.48605469e+01  1.48605469e+01  1.48605469e+01
  3.53943379e+01  6.07692311e+01  6.07692311e+01  6.07692311e+01
  1.39868122e+02  5.04114566e+02  1.87168001e+03  8.00118654e+03
  4.77686288e+04]
E1 = -182.51742243276377  E_coul = 53.999012048103175
cycle= 4 E= -128.518410384661  delta_E= -6.73e-09  |g|= 4.92e-05  |ddm|= 0.000168
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.08723e-05
diis-c [-4.28383698e-10  2.97886254e-05  3.51719017e-04 -9.00255536e-02
  1.08964405e+00]
  HOMO = -0.847774646080845  LUMO = 0.815073245444716
  mo_energy =
[-3.27835097e+01 -1.93283285e+00 -8.47774646e-01 -8.47774646e-01
 -8.47774646e-01  8.15073245e-01  8.15073245e-01  8.15073245e-01
  1.22470220e+00  3.98051993e+00  3.98051993e+00  3.98051993e+00
  7.57620782e+00  1.48605095e+01  1.48605095e+01  1.48605095e+01
  3.53942967e+01  6.07691894e+01  6.07691894e+01  6.07691894e+01
  1.39868081e+02  5.04114528e+02  1.87167998e+03  8.00118651e+03
  4.77686288e+04]
E1 = -182.51749567013258  E_coul = 53.99908528528923
cycle= 5 E= -128.518410384843  delta_E= -1.83e-10  |g|= 1.73e-06  |ddm|= 1.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51749567013258  E_coul = 53.99908528528923
  HOMO = -0.847774091488499  LUMO = 0.815073318173762
  mo_energy =
[-3.27835078e+01 -1.93283250e+00 -8.47774091e-01 -8.47774091e-01
 -8.47774091e-01  8.15073318e-01  8.15073318e-01  8.15073318e-01
  1.22470217e+00  3.98052036e+00  3.98052036e+00  3.98052036e+00
  7.57620842e+00  1.48605106e+01  1.48605106e+01  1.48605106e+01
  3.53942981e+01  6.07691911e+01  6.07691911e+01  6.07691911e+01
  1.39868083e+02  5.04114530e+02  1.87167998e+03  8.00118651e+03
  4.77686288e+04]
E1 = -182.51748927584376  E_coul = 53.99907889100008
Extra cycle  E= -128.518410384844  delta_E= -3.13e-13  |g|= 8.87e-07  |ddm|= 1.02e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 356.60849951520163
E1 = -182.51748927584376  E_coul = 53.99907889100008
init E= -128.518410384844
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.84777454781419  LUMO = 0.815073193057833
  mo_energy =
[-3.27835091e+01 -1.93283303e+00 -8.47774548e-01 -8.47774548e-01
 -8.47774548e-01  8.15073193e-01  8.15073193e-01  8.15073193e-01
  1.22470193e+00  3.98051992e+00  3.98051992e+00  3.98051992e+00
  7.57620783e+00  1.48605098e+01  1.48605098e+01  1.48605098e+01
  3.53942971e+01  6.07691899e+01  6.07691899e+01  6.07691899e+01
  1.39868082e+02  5.04114528e+02  1.87167998e+03  8.00118651e+03
  4.77686288e+04]
E1 = -182.51749219708424  E_coul = 53.999081812240775
cycle= 1 E= -128.518410384843  delta_E= 1.99e-13  |g|= 4e-07  |ddm|= 3.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51749219708424  E_coul = 53.999081812240775
  HOMO = -0.847774341025085  LUMO = 0.815073243216749
  mo_energy =
[-3.27835084e+01 -1.93283283e+00 -8.47774341e-01 -8.47774341e-01
 -8.47774341e-01  8.15073243e-01  8.15073243e-01  8.15073243e-01
  1.22470200e+00  3.98052011e+00  3.98052011e+00  3.98052011e+00
  7.57620808e+00  1.48605101e+01  1.48605101e+01  1.48605101e+01
  3.53942976e+01  6.07691905e+01  6.07691905e+01  6.07691905e+01
  1.39868082e+02  5.04114529e+02  1.87167998e+03  8.00118651e+03
  4.77686288e+04]
E1 = -182.51749064704362  E_coul = 53.99908026219999
Extra cycle  E= -128.518410384844  delta_E= -1.71e-13  |g|= 2.11e-07  |ddm|= 1.39e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721757e+02
 7.64808417e+01 1.01183805e+01 2.71474310e+01 3.87698546e-01
 3.00336935e+00 1.14780948e+00 2.51178893e+00 7.47474393e+00
 2.83213512e+01 2.67490732e-01 8.46841150e-01]
grad_E = [-8.90464189e-12  5.40113722e-10 -1.06801803e-08  1.16841768e-07
 -6.64721841e-07  2.72175463e-05 -8.92258745e-07 -1.66342492e-05
  6.66435906e-05 -2.19985979e-05  3.27195398e-03 -8.96385074e-04
 -1.66878387e-03  9.02756249e-04 -4.60062663e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433155        1
[INPUT] 0    0    [1    /1   ]  235.721757347        1
[INPUT] 0    0    [1    /1   ]  76.4808356234        1
[INPUT] 0    0    [1    /1   ]  10.1181269697        1
[INPUT] 0    0    [1    /1   ]  27.1474817664        1
[INPUT] 0    0    [1    /1   ]  0.388163078532       1
[INPUT] 0    0    [1    /1   ]  3.00287234062        1
[INPUT] 0    0    [1    /1   ]  1.14906765491        1
[INPUT] 1    0    [1    /1   ]  2.48976887946        1
[INPUT] 1    0    [1    /1   ]  7.48189608397        1
[INPUT] 1    0    [1    /1   ]  28.3277355448        1
[INPUT] 1    0    [1    /1   ]  0.265108470025       1
[INPUT] 1    0    [1    /1   ]  0.837157678526       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141046, 1.0]], [0, [3661.4543981241677, 1.0]], [0, [833.2724331554562, 1.0]], [0, [235.7217573470389, 1.0]], [0, [76.48083562339686, 1.0]], [0, [10.118126969688387, 1.0]], [0, [27.147481766428317, 1.0]], [0, [0.3881630785315813, 1.0]], [0, [3.0028723406152418, 1.0]], [0, [1.149067654909373, 1.0]], [1, [2.4897688794638806, 1.0]], [1, [7.481896083972967, 1.0]], [1, [28.327735544816264, 1.0]], [1, [0.2651084700247064, 1.0]], [1, [0.8371576785262925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.27243316]
bas 3, expnt(s) = [235.72175735]
bas 4, expnt(s) = [76.48083562]
bas 5, expnt(s) = [10.11812697]
bas 6, expnt(s) = [27.14748177]
bas 7, expnt(s) = [0.38816308]
bas 8, expnt(s) = [3.00287234]
bas 9, expnt(s) = [1.14906765]
bas 10, expnt(s) = [2.48976888]
bas 11, expnt(s) = [7.48189608]
bas 12, expnt(s) = [28.32773554]
bas 13, expnt(s) = [0.26510847]
bas 14, expnt(s) = [0.83715768]
CPU time:        64.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721757e+02 1.51989917e+02
 7.64808356e+01 6.53400545e+01 1.01181270e+01 1.43330996e+01
 2.71474818e+01 3.00477659e+01 3.88163079e-01 1.24244076e+00
 3.00287234e+00 5.76325289e+00 1.14906765e+00 2.80397556e+00
 2.48976888e+00 9.12395607e+00 7.48189608e+00 3.60993168e+01
 2.83277355e+01 1.90655447e+02 2.65108470e-01 5.54962831e-01
 8.37157679e-01 2.33611100e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999493815932826
cond(S) = 356.9423294850137
E1 = -183.5614144439869  E_coul = 55.07645970001853
init E= -128.484954743968
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771823371746967  LUMO = 0.824559531904528
  mo_energy =
[-3.25563754e+01 -1.85279016e+00 -7.71823372e-01 -7.71823372e-01
 -7.71823372e-01  8.24559532e-01  8.24559532e-01  8.24559532e-01
  1.25985529e+00  4.00354617e+00  4.00354617e+00  4.00354617e+00
  7.67639822e+00  1.49021704e+01  1.49021704e+01  1.49021704e+01
  3.55725751e+01  6.08982510e+01  6.08982510e+01  6.08982510e+01
  1.40095567e+02  5.04375536e+02  1.87197135e+03  8.00150394e+03
  4.77689636e+04]
E1 = -181.98812310026364  E_coul = 53.47354566034915
cycle= 1 E= -128.514577439914  delta_E= -0.0296  |g|= 0.215  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507971
diis-c [-0.25803467  1.        ]
  HOMO = -0.884984784541653  LUMO = 0.796694558072374
  mo_energy =
[-3.28964271e+01 -1.97205666e+00 -8.84984785e-01 -8.84984785e-01
 -8.84984785e-01  7.96694558e-01  7.96694558e-01  7.96694558e-01
  1.21076850e+00  3.90022260e+00  3.90022260e+00  3.90022260e+00
  7.53520010e+00  1.46966923e+01  1.46966923e+01  1.46966923e+01
  3.53126529e+01  6.05901324e+01  6.05901324e+01  6.05901324e+01
  1.39761233e+02  5.03995893e+02  1.87155549e+03  8.00105911e+03
  4.77685000e+04]
E1 = -182.78615720994756  E_coul = 54.268727086457
cycle= 2 E= -128.517430123491  delta_E= -0.00285  |g|= 0.109  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259372
diis-c [-6.06608829e-04  3.37263725e-01  6.62736275e-01]
  HOMO = -0.847696521090983  LUMO = 0.805886056244188
  mo_energy =
[-3.27834176e+01 -1.93277569e+00 -8.47696521e-01 -8.47696521e-01
 -8.47696521e-01  8.05886056e-01  8.05886056e-01  8.05886056e-01
  1.22660522e+00  3.93400263e+00  3.93400263e+00  3.93400263e+00
  7.58159237e+00  1.47650030e+01  1.47650030e+01  1.47650030e+01
  3.53994972e+01  6.06926751e+01  6.06926751e+01  6.06926751e+01
  1.39872152e+02  5.04118041e+02  1.87168314e+03  8.00118935e+03
  4.77686312e+04]
E1 = -182.51661797721493  E_coul = 53.998179705959885
cycle= 3 E= -128.518438271255  delta_E= -0.00101  |g|= 0.000264  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000328002
diis-c [-4.99465817e-08 -1.79059478e-03 -2.68802278e-03  1.00447862e+00]
  HOMO = -0.847837525043399  LUMO = 0.805882613100213
  mo_energy =
[-3.27836055e+01 -1.93290352e+00 -8.47837525e-01 -8.47837525e-01
 -8.47837525e-01  8.05882613e-01  8.05882613e-01  8.05882613e-01
  1.22656114e+00  3.93393148e+00  3.93393148e+00  3.93393148e+00
  7.58148522e+00  1.47648792e+01  1.47648792e+01  1.47648792e+01
  3.53993476e+01  6.06925023e+01  6.06925023e+01  6.06925023e+01
  1.39871969e+02  5.04117815e+02  1.87168286e+03  8.00118902e+03
  4.77686309e+04]
E1 = -182.51646215311575  E_coul = 53.99802387458767
cycle= 4 E= -128.518438278528  delta_E= -7.27e-09  |g|= 5.03e-05  |ddm|= 0.000172
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.18457e-05
diis-c [-4.60759349e-10  3.60328894e-05  3.61991956e-04 -9.49391179e-02
  1.09454109e+00]
  HOMO = -0.847864516497836  LUMO = 0.805873676385182
  mo_energy =
[-3.27836482e+01 -1.93293336e+00 -8.47864516e-01 -8.47864516e-01
 -8.47864516e-01  8.05873676e-01  8.05873676e-01  8.05873676e-01
  1.22654328e+00  3.93390447e+00  3.93390447e+00  3.93390447e+00
  7.58145108e+00  1.47648408e+01  1.47648408e+01  1.47648408e+01
  3.53993053e+01  6.06924597e+01  6.06924597e+01  6.06924597e+01
  1.39871928e+02  5.04117776e+02  1.87168282e+03  8.00118898e+03
  4.77686308e+04]
E1 = -182.51653566386594  E_coul = 53.998097385141506
cycle= 5 E= -128.518438278724  delta_E= -1.96e-10  |g|= 1.94e-06  |ddm|= 1.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51653566386594  E_coul = 53.998097385141506
  HOMO = -0.847863828510844  LUMO = 0.805873780839999
  mo_energy =
[-3.27836460e+01 -1.93293292e+00 -8.47863829e-01 -8.47863829e-01
 -8.47863829e-01  8.05873781e-01  8.05873781e-01  8.05873781e-01
  1.22654329e+00  3.93390500e+00  3.93390500e+00  3.93390500e+00
  7.58145182e+00  1.47648421e+01  1.47648421e+01  1.47648421e+01
  3.53993070e+01  6.06924617e+01  6.06924617e+01  6.06924617e+01
  1.39871930e+02  5.04117778e+02  1.87168282e+03  8.00118899e+03
  4.77686308e+04]
E1 = -182.51652851199407  E_coul = 53.998090233269664
Extra cycle  E= -128.518438278724  delta_E= 2.84e-14  |g|= 9.98e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721757e+02
 7.64808356e+01 1.01181270e+01 2.71474818e+01 3.88163079e-01
 3.00287234e+00 1.14906765e+00 2.48976888e+00 7.48189608e+00
 2.83277355e+01 2.65108470e-01 8.37157679e-01]
E = -128.5184382787244
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433155        1
[INPUT] 0    0    [1    /1   ]  235.721757347        1
[INPUT] 0    0    [1    /1   ]  76.4808356234        1
[INPUT] 0    0    [1    /1   ]  10.1181269697        1
[INPUT] 0    0    [1    /1   ]  27.1474817664        1
[INPUT] 0    0    [1    /1   ]  0.388163078532       1
[INPUT] 0    0    [1    /1   ]  3.00287234062        1
[INPUT] 0    0    [1    /1   ]  1.14906765491        1
[INPUT] 1    0    [1    /1   ]  2.48976887946        1
[INPUT] 1    0    [1    /1   ]  7.48189608397        1
[INPUT] 1    0    [1    /1   ]  28.3277355448        1
[INPUT] 1    0    [1    /1   ]  0.265108470025       1
[INPUT] 1    0    [1    /1   ]  0.837157678526       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141046, 1.0]], [0, [3661.4543981241677, 1.0]], [0, [833.2724331554562, 1.0]], [0, [235.7217573470389, 1.0]], [0, [76.48083562339686, 1.0]], [0, [10.118126969688387, 1.0]], [0, [27.147481766428317, 1.0]], [0, [0.3881630785315813, 1.0]], [0, [3.0028723406152418, 1.0]], [0, [1.149067654909373, 1.0]], [1, [2.4897688794638806, 1.0]], [1, [7.481896083972967, 1.0]], [1, [28.327735544816264, 1.0]], [1, [0.2651084700247064, 1.0]], [1, [0.8371576785262925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.27243316]
bas 3, expnt(s) = [235.72175735]
bas 4, expnt(s) = [76.48083562]
bas 5, expnt(s) = [10.11812697]
bas 6, expnt(s) = [27.14748177]
bas 7, expnt(s) = [0.38816308]
bas 8, expnt(s) = [3.00287234]
bas 9, expnt(s) = [1.14906765]
bas 10, expnt(s) = [2.48976888]
bas 11, expnt(s) = [7.48189608]
bas 12, expnt(s) = [28.32773554]
bas 13, expnt(s) = [0.26510847]
bas 14, expnt(s) = [0.83715768]
CPU time:        64.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721757e+02 1.51989917e+02
 7.64808356e+01 6.53400545e+01 1.01181270e+01 1.43330996e+01
 2.71474818e+01 3.00477659e+01 3.88163079e-01 1.24244076e+00
 3.00287234e+00 5.76325289e+00 1.14906765e+00 2.80397556e+00
 2.48976888e+00 9.12395607e+00 7.48189608e+00 3.60993168e+01
 2.83277355e+01 1.90655447e+02 2.65108470e-01 5.54962831e-01
 8.37157679e-01 2.33611100e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999493815932826
cond(S) = 356.9423294850137
E1 = -183.5614144439869  E_coul = 55.07645970001853
init E= -128.484954743968
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771823371746967  LUMO = 0.824559531904528
  mo_energy =
[-3.25563754e+01 -1.85279016e+00 -7.71823372e-01 -7.71823372e-01
 -7.71823372e-01  8.24559532e-01  8.24559532e-01  8.24559532e-01
  1.25985529e+00  4.00354617e+00  4.00354617e+00  4.00354617e+00
  7.67639822e+00  1.49021704e+01  1.49021704e+01  1.49021704e+01
  3.55725751e+01  6.08982510e+01  6.08982510e+01  6.08982510e+01
  1.40095567e+02  5.04375536e+02  1.87197135e+03  8.00150394e+03
  4.77689636e+04]
E1 = -181.98812310026364  E_coul = 53.47354566034915
cycle= 1 E= -128.514577439914  delta_E= -0.0296  |g|= 0.215  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507971
diis-c [-0.25803467  1.        ]
  HOMO = -0.884984784541653  LUMO = 0.796694558072374
  mo_energy =
[-3.28964271e+01 -1.97205666e+00 -8.84984785e-01 -8.84984785e-01
 -8.84984785e-01  7.96694558e-01  7.96694558e-01  7.96694558e-01
  1.21076850e+00  3.90022260e+00  3.90022260e+00  3.90022260e+00
  7.53520010e+00  1.46966923e+01  1.46966923e+01  1.46966923e+01
  3.53126529e+01  6.05901324e+01  6.05901324e+01  6.05901324e+01
  1.39761233e+02  5.03995893e+02  1.87155549e+03  8.00105911e+03
  4.77685000e+04]
E1 = -182.78615720994756  E_coul = 54.268727086457
cycle= 2 E= -128.517430123491  delta_E= -0.00285  |g|= 0.109  |ddm|= 0.0712
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.259372
diis-c [-6.06608829e-04  3.37263725e-01  6.62736275e-01]
  HOMO = -0.847696521090983  LUMO = 0.805886056244188
  mo_energy =
[-3.27834176e+01 -1.93277569e+00 -8.47696521e-01 -8.47696521e-01
 -8.47696521e-01  8.05886056e-01  8.05886056e-01  8.05886056e-01
  1.22660522e+00  3.93400263e+00  3.93400263e+00  3.93400263e+00
  7.58159237e+00  1.47650030e+01  1.47650030e+01  1.47650030e+01
  3.53994972e+01  6.06926751e+01  6.06926751e+01  6.06926751e+01
  1.39872152e+02  5.04118041e+02  1.87168314e+03  8.00118935e+03
  4.77686312e+04]
E1 = -182.51661797721493  E_coul = 53.998179705959885
cycle= 3 E= -128.518438271255  delta_E= -0.00101  |g|= 0.000264  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000328002
diis-c [-4.99465817e-08 -1.79059478e-03 -2.68802278e-03  1.00447862e+00]
  HOMO = -0.847837525043399  LUMO = 0.805882613100213
  mo_energy =
[-3.27836055e+01 -1.93290352e+00 -8.47837525e-01 -8.47837525e-01
 -8.47837525e-01  8.05882613e-01  8.05882613e-01  8.05882613e-01
  1.22656114e+00  3.93393148e+00  3.93393148e+00  3.93393148e+00
  7.58148522e+00  1.47648792e+01  1.47648792e+01  1.47648792e+01
  3.53993476e+01  6.06925023e+01  6.06925023e+01  6.06925023e+01
  1.39871969e+02  5.04117815e+02  1.87168286e+03  8.00118902e+03
  4.77686309e+04]
E1 = -182.51646215311575  E_coul = 53.99802387458767
cycle= 4 E= -128.518438278528  delta_E= -7.27e-09  |g|= 5.03e-05  |ddm|= 0.000172
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.18457e-05
diis-c [-4.60759349e-10  3.60328894e-05  3.61991956e-04 -9.49391179e-02
  1.09454109e+00]
  HOMO = -0.847864516497836  LUMO = 0.805873676385182
  mo_energy =
[-3.27836482e+01 -1.93293336e+00 -8.47864516e-01 -8.47864516e-01
 -8.47864516e-01  8.05873676e-01  8.05873676e-01  8.05873676e-01
  1.22654328e+00  3.93390447e+00  3.93390447e+00  3.93390447e+00
  7.58145108e+00  1.47648408e+01  1.47648408e+01  1.47648408e+01
  3.53993053e+01  6.06924597e+01  6.06924597e+01  6.06924597e+01
  1.39871928e+02  5.04117776e+02  1.87168282e+03  8.00118898e+03
  4.77686308e+04]
E1 = -182.51653566386594  E_coul = 53.998097385141506
cycle= 5 E= -128.518438278724  delta_E= -1.96e-10  |g|= 1.94e-06  |ddm|= 1.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51653566386594  E_coul = 53.998097385141506
  HOMO = -0.847863828510844  LUMO = 0.805873780839999
  mo_energy =
[-3.27836460e+01 -1.93293292e+00 -8.47863829e-01 -8.47863829e-01
 -8.47863829e-01  8.05873781e-01  8.05873781e-01  8.05873781e-01
  1.22654329e+00  3.93390500e+00  3.93390500e+00  3.93390500e+00
  7.58145182e+00  1.47648421e+01  1.47648421e+01  1.47648421e+01
  3.53993070e+01  6.06924617e+01  6.06924617e+01  6.06924617e+01
  1.39871930e+02  5.04117778e+02  1.87168282e+03  8.00118899e+03
  4.77686308e+04]
E1 = -182.51652851199407  E_coul = 53.998090233269664
Extra cycle  E= -128.518438278724  delta_E= 2.84e-14  |g|= 9.98e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 356.9423294850137
E1 = -182.51652851199407  E_coul = 53.998090233269664
init E= -128.518438278724
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.847864335977537  LUMO = 0.805873644395216
  mo_energy =
[-3.27836475e+01 -1.93293352e+00 -8.47864336e-01 -8.47864336e-01
 -8.47864336e-01  8.05873644e-01  8.05873644e-01  8.05873644e-01
  1.22654302e+00  3.93390453e+00  3.93390453e+00  3.93390453e+00
  7.58145116e+00  1.47648412e+01  1.47648412e+01  1.47648412e+01
  3.53993058e+01  6.06924604e+01  6.06924604e+01  6.06924604e+01
  1.39871928e+02  5.04117777e+02  1.87168282e+03  8.00118898e+03
  4.77686308e+04]
E1 = -182.51653181729517  E_coul = 53.99809353857048
cycle= 1 E= -128.518438278725  delta_E= -2.84e-13  |g|= 4.51e-07  |ddm|= 3.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51653181729517  E_coul = 53.99809353857048
  HOMO = -0.847864101626873  LUMO = 0.805873700497608
  mo_energy =
[-3.27836468e+01 -1.93293329e+00 -8.47864102e-01 -8.47864102e-01
 -8.47864102e-01  8.05873700e-01  8.05873700e-01  8.05873700e-01
  1.22654311e+00  3.93390474e+00  3.93390474e+00  3.93390474e+00
  7.58145144e+00  1.47648416e+01  1.47648416e+01  1.47648416e+01
  3.53993063e+01  6.06924610e+01  6.06924610e+01  6.06924610e+01
  1.39871929e+02  5.04117778e+02  1.87168282e+03  8.00118898e+03
  4.77686308e+04]
E1 = -182.51653006663324  E_coul = 53.998091787908415
Extra cycle  E= -128.518438278725  delta_E= -1.42e-13  |g|= 2.38e-07  |ddm|= 1.56e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721757e+02
 7.64808356e+01 1.01181270e+01 2.71474818e+01 3.88163079e-01
 3.00287234e+00 1.14906765e+00 2.48976888e+00 7.48189608e+00
 2.83277355e+01 2.65108470e-01 8.37157679e-01]
grad_E = [-1.26270239e-11  7.35908251e-10 -1.46267259e-08  1.64732478e-07
 -1.05476801e-06  2.08790633e-05  1.23095705e-06  3.24885553e-05
  5.87502764e-05  7.83453902e-06  1.09752172e-03 -6.70659261e-05
 -1.74606144e-03 -5.23841260e-04 -2.70283934e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433192        1
[INPUT] 0    0    [1    /1   ]  235.721756923        1
[INPUT] 0    0    [1    /1   ]  76.4808387897        1
[INPUT] 0    0    [1    /1   ]  10.1181434973        1
[INPUT] 0    0    [1    /1   ]  27.147468871         1
[INPUT] 0    0    [1    /1   ]  0.388043773311       1
[INPUT] 0    0    [1    /1   ]  3.00287261535        1
[INPUT] 0    0    [1    /1   ]  1.14881352453        1
[INPUT] 1    0    [1    /1   ]  2.48525316841        1
[INPUT] 1    0    [1    /1   ]  7.48123318916        1
[INPUT] 1    0    [1    /1   ]  28.3293956986        1
[INPUT] 1    0    [1    /1   ]  0.265526876356       1
[INPUT] 1    0    [1    /1   ]  0.837080043835       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410494, 1.0]], [0, [3661.454398122369, 1.0]], [0, [833.272433191504, 1.0]], [0, [235.72175692289983, 1.0]], [0, [76.48083878970758, 1.0]], [0, [10.118143497327628, 1.0]], [0, [27.147468870999862, 1.0]], [0, [0.3880437733106584, 1.0]], [0, [3.0028726153498937, 1.0]], [0, [1.1488135245315754, 1.0]], [1, [2.4852531684110266, 1.0]], [1, [7.481233189156799, 1.0]], [1, [28.329395698637754, 1.0]], [1, [0.26552687635577193, 1.0]], [1, [0.8370800438347614, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.27243319]
bas 3, expnt(s) = [235.72175692]
bas 4, expnt(s) = [76.48083879]
bas 5, expnt(s) = [10.1181435]
bas 6, expnt(s) = [27.14746887]
bas 7, expnt(s) = [0.38804377]
bas 8, expnt(s) = [3.00287262]
bas 9, expnt(s) = [1.14881352]
bas 10, expnt(s) = [2.48525317]
bas 11, expnt(s) = [7.48123319]
bas 12, expnt(s) = [28.3293957]
bas 13, expnt(s) = [0.26552688]
bas 14, expnt(s) = [0.83708004]
CPU time:        67.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721757e+02 1.51989916e+02
 7.64808388e+01 6.53400565e+01 1.01181435e+01 1.43331171e+01
 2.71474689e+01 3.00477552e+01 3.88043773e-01 1.24215435e+00
 3.00287262e+00 5.76325328e+00 1.14881352e+00 2.80351045e+00
 2.48525317e+00 9.10327553e+00 7.48123319e+00 3.60953188e+01
 2.83293957e+01 1.90669414e+02 2.65526876e-01 5.56057881e-01
 8.37080044e-01 2.33584020e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999493162067374
cond(S) = 356.8628954965642
E1 = -183.56144935201485  E_coul = 55.07647098017602
init E= -128.484978371839
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771823869997828  LUMO = 0.825721903152508
  mo_energy =
[-3.25563695e+01 -1.85279039e+00 -7.71823870e-01 -7.71823870e-01
 -7.71823870e-01  8.25721903e-01  8.25721903e-01  8.25721903e-01
  1.25939151e+00  4.00230153e+00  4.00230153e+00  4.00230153e+00
  7.67506245e+00  1.48903825e+01  1.48903825e+01  1.48903825e+01
  3.55709899e+01  6.08843167e+01  6.08843167e+01  6.08843167e+01
  1.40094140e+02  5.04374246e+02  1.87197018e+03  8.00150291e+03
  4.77689628e+04]
E1 = -181.98860254278932  E_coul = 53.47401701153614
cycle= 1 E= -128.514585531253  delta_E= -0.0296  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50792
diis-c [-0.25798285  1.        ]
  HOMO = -0.88494721766179  LUMO = 0.797835173288612
  mo_energy =
[-3.28963512e+01 -1.97201198e+00 -8.84947218e-01 -8.84947218e-01
 -8.84947218e-01  7.97835173e-01  7.97835173e-01  7.97835173e-01
  1.21033776e+00  3.89911630e+00  3.89911630e+00  3.89911630e+00
  7.53392315e+00  1.46850187e+01  1.46850187e+01  1.46850187e+01
  3.53111298e+01  6.05762490e+01  6.05762490e+01  6.05762490e+01
  1.39759877e+02  5.03994696e+02  1.87155443e+03  8.00105819e+03
  4.77684993e+04]
E1 = -182.78632912786043  E_coul = 54.26889214341296
cycle= 2 E= -128.517436984447  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259307
diis-c [-6.07360667e-04  3.37228249e-01  6.62771751e-01]
  HOMO = -0.847671908173862  LUMO = 0.807031969216382
  mo_energy =
[-3.27833765e+01 -1.93274514e+00 -8.47671908e-01 -8.47671908e-01
 -8.47671908e-01  8.07031969e-01  8.07031969e-01  8.07031969e-01
  1.22616272e+00  3.93284974e+00  3.93284974e+00  3.93284974e+00
  7.58029779e+00  1.47532863e+01  1.47532863e+01  1.47532863e+01
  3.53979468e+01  6.06787628e+01  6.06787628e+01  6.06787628e+01
  1.39870762e+02  5.04116807e+02  1.87168204e+03  8.00118839e+03
  4.77686304e+04]
E1 = -182.51690610368814  E_coul = 53.99846178494161
cycle= 3 E= -128.518444318747  delta_E= -0.00101  |g|= 0.000267  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000330797
diis-c [-5.02817618e-08 -1.79347556e-03 -2.68031475e-03  1.00447379e+00]
  HOMO = -0.84781383583751  LUMO = 0.807028022647692
  mo_energy =
[-3.27835664e+01 -1.93287386e+00 -8.47813836e-01 -8.47813836e-01
 -8.47813836e-01  8.07028023e-01  8.07028023e-01  8.07028023e-01
  1.22611790e+00  3.93277759e+00  3.93277759e+00  3.93277759e+00
  7.58018964e+00  1.47531612e+01  1.47531612e+01  1.47531612e+01
  3.53977956e+01  6.06785882e+01  6.06785882e+01  6.06785882e+01
  1.39870577e+02  5.04116579e+02  1.87168176e+03  8.00118805e+03
  4.77686301e+04]
E1 = -182.51675195399002  E_coul = 53.99830762783562
cycle= 4 E= -128.518444326154  delta_E= -7.41e-09  |g|= 5.06e-05  |ddm|= 0.000173
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.2283e-05
diis-c [-4.62876294e-10  3.68759395e-05  3.64019086e-04 -9.53273504e-02
  1.09492646e+00]
  HOMO = -0.847840985308736  LUMO = 0.807019015719168
  mo_energy =
[-3.27836094e+01 -1.93290385e+00 -8.47840985e-01 -8.47840985e-01
 -8.47840985e-01  8.07019016e-01  8.07019016e-01  8.07019016e-01
  1.22609993e+00  3.93275043e+00  3.93275043e+00  3.93275043e+00
  7.58015533e+00  1.47531226e+01  1.47531226e+01  1.47531226e+01
  3.53977531e+01  6.06785453e+01  6.06785453e+01  6.06785453e+01
  1.39870535e+02  5.04116539e+02  1.87168172e+03  8.00118802e+03
  4.77686300e+04]
E1 = -182.51682564734  E_coul = 53.998381320986866
cycle= 5 E= -128.518444326353  delta_E= -1.99e-10  |g|= 1.94e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.51682564734  E_coul = 53.998381320986866
  HOMO = -0.847840296286846  LUMO = 0.807019120721281
  mo_energy =
[-3.27836072e+01 -1.93290340e+00 -8.47840296e-01 -8.47840296e-01
 -8.47840296e-01  8.07019121e-01  8.07019121e-01  8.07019121e-01
  1.22609995e+00  3.93275097e+00  3.93275097e+00  3.93275097e+00
  7.58015607e+00  1.47531239e+01  1.47531239e+01  1.47531239e+01
  3.53977548e+01  6.06785473e+01  6.06785473e+01  6.06785473e+01
  1.39870537e+02  5.04116541e+02  1.87168172e+03  8.00118802e+03
  4.77686300e+04]
E1 = -182.5168184919498  E_coul = 53.998374165596644
Extra cycle  E= -128.518444326353  delta_E= -5.68e-14  |g|= 9.99e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721757e+02
 7.64808388e+01 1.01181435e+01 2.71474689e+01 3.88043773e-01
 3.00287262e+00 1.14881352e+00 2.48525317e+00 7.48123319e+00
 2.83293957e+01 2.65526876e-01 8.37080044e-01]
E = -128.51844432635318
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433192        1
[INPUT] 0    0    [1    /1   ]  235.721756923        1
[INPUT] 0    0    [1    /1   ]  76.4808387897        1
[INPUT] 0    0    [1    /1   ]  10.1181434973        1
[INPUT] 0    0    [1    /1   ]  27.147468871         1
[INPUT] 0    0    [1    /1   ]  0.388043773311       1
[INPUT] 0    0    [1    /1   ]  3.00287261535        1
[INPUT] 0    0    [1    /1   ]  1.14881352453        1
[INPUT] 1    0    [1    /1   ]  2.48525316841        1
[INPUT] 1    0    [1    /1   ]  7.48123318916        1
[INPUT] 1    0    [1    /1   ]  28.3293956986        1
[INPUT] 1    0    [1    /1   ]  0.265526876356       1
[INPUT] 1    0    [1    /1   ]  0.837080043835       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410494, 1.0]], [0, [3661.454398122369, 1.0]], [0, [833.272433191504, 1.0]], [0, [235.72175692289983, 1.0]], [0, [76.48083878970758, 1.0]], [0, [10.118143497327628, 1.0]], [0, [27.147468870999862, 1.0]], [0, [0.3880437733106584, 1.0]], [0, [3.0028726153498937, 1.0]], [0, [1.1488135245315754, 1.0]], [1, [2.4852531684110266, 1.0]], [1, [7.481233189156799, 1.0]], [1, [28.329395698637754, 1.0]], [1, [0.26552687635577193, 1.0]], [1, [0.8370800438347614, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.27243319]
bas 3, expnt(s) = [235.72175692]
bas 4, expnt(s) = [76.48083879]
bas 5, expnt(s) = [10.1181435]
bas 6, expnt(s) = [27.14746887]
bas 7, expnt(s) = [0.38804377]
bas 8, expnt(s) = [3.00287262]
bas 9, expnt(s) = [1.14881352]
bas 10, expnt(s) = [2.48525317]
bas 11, expnt(s) = [7.48123319]
bas 12, expnt(s) = [28.3293957]
bas 13, expnt(s) = [0.26552688]
bas 14, expnt(s) = [0.83708004]
CPU time:        68.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721757e+02 1.51989916e+02
 7.64808388e+01 6.53400565e+01 1.01181435e+01 1.43331171e+01
 2.71474689e+01 3.00477552e+01 3.88043773e-01 1.24215435e+00
 3.00287262e+00 5.76325328e+00 1.14881352e+00 2.80351045e+00
 2.48525317e+00 9.10327553e+00 7.48123319e+00 3.60953188e+01
 2.83293957e+01 1.90669414e+02 2.65526876e-01 5.56057881e-01
 8.37080044e-01 2.33584020e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999493162067374
cond(S) = 356.8628954965642
E1 = -183.56144935201485  E_coul = 55.07647098017602
init E= -128.484978371839
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771823869997828  LUMO = 0.825721903152508
  mo_energy =
[-3.25563695e+01 -1.85279039e+00 -7.71823870e-01 -7.71823870e-01
 -7.71823870e-01  8.25721903e-01  8.25721903e-01  8.25721903e-01
  1.25939151e+00  4.00230153e+00  4.00230153e+00  4.00230153e+00
  7.67506245e+00  1.48903825e+01  1.48903825e+01  1.48903825e+01
  3.55709899e+01  6.08843167e+01  6.08843167e+01  6.08843167e+01
  1.40094140e+02  5.04374246e+02  1.87197018e+03  8.00150291e+03
  4.77689628e+04]
E1 = -181.98860254278932  E_coul = 53.47401701153614
cycle= 1 E= -128.514585531253  delta_E= -0.0296  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50792
diis-c [-0.25798285  1.        ]
  HOMO = -0.88494721766179  LUMO = 0.797835173288612
  mo_energy =
[-3.28963512e+01 -1.97201198e+00 -8.84947218e-01 -8.84947218e-01
 -8.84947218e-01  7.97835173e-01  7.97835173e-01  7.97835173e-01
  1.21033776e+00  3.89911630e+00  3.89911630e+00  3.89911630e+00
  7.53392315e+00  1.46850187e+01  1.46850187e+01  1.46850187e+01
  3.53111298e+01  6.05762490e+01  6.05762490e+01  6.05762490e+01
  1.39759877e+02  5.03994696e+02  1.87155443e+03  8.00105819e+03
  4.77684993e+04]
E1 = -182.78632912786043  E_coul = 54.26889214341296
cycle= 2 E= -128.517436984447  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259307
diis-c [-6.07360667e-04  3.37228249e-01  6.62771751e-01]
  HOMO = -0.847671908173862  LUMO = 0.807031969216382
  mo_energy =
[-3.27833765e+01 -1.93274514e+00 -8.47671908e-01 -8.47671908e-01
 -8.47671908e-01  8.07031969e-01  8.07031969e-01  8.07031969e-01
  1.22616272e+00  3.93284974e+00  3.93284974e+00  3.93284974e+00
  7.58029779e+00  1.47532863e+01  1.47532863e+01  1.47532863e+01
  3.53979468e+01  6.06787628e+01  6.06787628e+01  6.06787628e+01
  1.39870762e+02  5.04116807e+02  1.87168204e+03  8.00118839e+03
  4.77686304e+04]
E1 = -182.51690610368814  E_coul = 53.99846178494161
cycle= 3 E= -128.518444318747  delta_E= -0.00101  |g|= 0.000267  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000330797
diis-c [-5.02817618e-08 -1.79347556e-03 -2.68031475e-03  1.00447379e+00]
  HOMO = -0.84781383583751  LUMO = 0.807028022647692
  mo_energy =
[-3.27835664e+01 -1.93287386e+00 -8.47813836e-01 -8.47813836e-01
 -8.47813836e-01  8.07028023e-01  8.07028023e-01  8.07028023e-01
  1.22611790e+00  3.93277759e+00  3.93277759e+00  3.93277759e+00
  7.58018964e+00  1.47531612e+01  1.47531612e+01  1.47531612e+01
  3.53977956e+01  6.06785882e+01  6.06785882e+01  6.06785882e+01
  1.39870577e+02  5.04116579e+02  1.87168176e+03  8.00118805e+03
  4.77686301e+04]
E1 = -182.51675195399002  E_coul = 53.99830762783562
cycle= 4 E= -128.518444326154  delta_E= -7.41e-09  |g|= 5.06e-05  |ddm|= 0.000173
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.2283e-05
diis-c [-4.62876294e-10  3.68759395e-05  3.64019086e-04 -9.53273504e-02
  1.09492646e+00]
  HOMO = -0.847840985308736  LUMO = 0.807019015719168
  mo_energy =
[-3.27836094e+01 -1.93290385e+00 -8.47840985e-01 -8.47840985e-01
 -8.47840985e-01  8.07019016e-01  8.07019016e-01  8.07019016e-01
  1.22609993e+00  3.93275043e+00  3.93275043e+00  3.93275043e+00
  7.58015533e+00  1.47531226e+01  1.47531226e+01  1.47531226e+01
  3.53977531e+01  6.06785453e+01  6.06785453e+01  6.06785453e+01
  1.39870535e+02  5.04116539e+02  1.87168172e+03  8.00118802e+03
  4.77686300e+04]
E1 = -182.51682564734  E_coul = 53.998381320986866
cycle= 5 E= -128.518444326353  delta_E= -1.99e-10  |g|= 1.94e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.51682564734  E_coul = 53.998381320986866
  HOMO = -0.847840296286846  LUMO = 0.807019120721281
  mo_energy =
[-3.27836072e+01 -1.93290340e+00 -8.47840296e-01 -8.47840296e-01
 -8.47840296e-01  8.07019121e-01  8.07019121e-01  8.07019121e-01
  1.22609995e+00  3.93275097e+00  3.93275097e+00  3.93275097e+00
  7.58015607e+00  1.47531239e+01  1.47531239e+01  1.47531239e+01
  3.53977548e+01  6.06785473e+01  6.06785473e+01  6.06785473e+01
  1.39870537e+02  5.04116541e+02  1.87168172e+03  8.00118802e+03
  4.77686300e+04]
E1 = -182.5168184919498  E_coul = 53.998374165596644
Extra cycle  E= -128.518444326353  delta_E= -5.68e-14  |g|= 9.99e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 356.8628954965642
E1 = -182.5168184919498  E_coul = 53.998374165596644
init E= -128.518444326353
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.847840803986812  LUMO = 0.80701898410435
  mo_energy =
[-3.27836087e+01 -1.93290401e+00 -8.47840804e-01 -8.47840804e-01
 -8.47840804e-01  8.07018984e-01  8.07018984e-01  8.07018984e-01
  1.22609967e+00  3.93275049e+00  3.93275049e+00  3.93275049e+00
  7.58015541e+00  1.47531230e+01  1.47531230e+01  1.47531230e+01
  3.53977536e+01  6.06785459e+01  6.06785459e+01  6.06785459e+01
  1.39870536e+02  5.04116540e+02  1.87168172e+03  8.00118802e+03
  4.77686300e+04]
E1 = -182.51682179938825  E_coul = 53.998377473035056
cycle= 1 E= -128.518444326353  delta_E= -2.84e-14  |g|= 4.52e-07  |ddm|= 3.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51682179938825  E_coul = 53.998377473035056
  HOMO = -0.847840569484951  LUMO = 0.807019040301459
  mo_energy =
[-3.27836079e+01 -1.93290377e+00 -8.47840569e-01 -8.47840569e-01
 -8.47840569e-01  8.07019040e-01  8.07019040e-01  8.07019040e-01
  1.22609976e+00  3.93275070e+00  3.93275070e+00  3.93275070e+00
  7.58015569e+00  1.47531234e+01  1.47531234e+01  1.47531234e+01
  3.53977542e+01  6.06785466e+01  6.06785466e+01  6.06785466e+01
  1.39870537e+02  5.04116540e+02  1.87168172e+03  8.00118802e+03
  4.77686300e+04]
E1 = -182.5168200480032  E_coul = 53.99837572164967
Extra cycle  E= -128.518444326354  delta_E= -3.41e-13  |g|= 2.39e-07  |ddm|= 1.56e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721757e+02
 7.64808388e+01 1.01181435e+01 2.71474689e+01 3.88043773e-01
 3.00287262e+00 1.14881352e+00 2.48525317e+00 7.48123319e+00
 2.83293957e+01 2.65526876e-01 8.37080044e-01]
grad_E = [-1.20642295e-11  7.06342615e-10 -1.40330342e-08  1.57639797e-07
 -9.98850067e-07  2.17824552e-05  9.38572209e-07  1.71208143e-05
  6.01458076e-05  1.96126134e-06  2.40808348e-04  1.55697033e-04
 -1.76282392e-03 -6.31447225e-04 -1.49565331e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433259        1
[INPUT] 0    0    [1    /1   ]  235.721756154        1
[INPUT] 0    0    [1    /1   ]  76.4808439836        1
[INPUT] 0    0    [1    /1   ]  10.1180892956        1
[INPUT] 0    0    [1    /1   ]  27.1474572158        1
[INPUT] 0    0    [1    /1   ]  0.387917156229       1
[INPUT] 0    0    [1    /1   ]  3.00269827563        1
[INPUT] 0    0    [1    /1   ]  1.14853879589        1
[INPUT] 1    0    [1    /1   ]  2.48242350154        1
[INPUT] 1    0    [1    /1   ]  7.48331917418        1
[INPUT] 1    0    [1    /1   ]  28.3356357161        1
[INPUT] 1    0    [1    /1   ]  0.266583039404       1
[INPUT] 1    0    [1    /1   ]  0.838400089307       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410552, 1.0]], [0, [3661.4543981189945, 1.0]], [0, [833.272433258765, 1.0]], [0, [235.72175615443075, 1.0]], [0, [76.48084398363194, 1.0]], [0, [10.118089295571101, 1.0]], [0, [27.14745721576428, 1.0]], [0, [0.3879171562290062, 1.0]], [0, [3.0026982756318388, 1.0]], [0, [1.1485387958904376, 1.0]], [1, [2.482423501541193, 1.0]], [1, [7.483319174183697, 1.0]], [1, [28.33563571613118, 1.0]], [1, [0.26658303940377914, 1.0]], [1, [0.8384000893066297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.27243326]
bas 3, expnt(s) = [235.72175615]
bas 4, expnt(s) = [76.48084398]
bas 5, expnt(s) = [10.1180893]
bas 6, expnt(s) = [27.14745722]
bas 7, expnt(s) = [0.38791716]
bas 8, expnt(s) = [3.00269828]
bas 9, expnt(s) = [1.1485388]
bas 10, expnt(s) = [2.4824235]
bas 11, expnt(s) = [7.48331917]
bas 12, expnt(s) = [28.33563572]
bas 13, expnt(s) = [0.26658304]
bas 14, expnt(s) = [0.83840009]
CPU time:        71.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721756e+02 1.51989916e+02
 7.64808440e+01 6.53400599e+01 1.01180893e+01 1.43330595e+01
 2.71474572e+01 3.00477455e+01 3.87917156e-01 1.24185035e+00
 3.00269828e+00 5.76300233e+00 1.14853880e+00 2.80300761e+00
 2.48242350e+00 9.09032133e+00 7.48331917e+00 3.61078998e+01
 2.83356357e+01 1.90721913e+02 2.66583039e-01 5.58823983e-01
 8.38400089e-01 2.34044553e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999488653265386
cond(S) = 356.769511340886
E1 = -183.56150197404872  E_coul = 55.07649050829621
init E= -128.485011465753
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771824029176642  LUMO = 0.829079937729606
  mo_energy =
[-3.25563621e+01 -1.85278994e+00 -7.71824029e-01 -7.71824029e-01
 -7.71824029e-01  8.29079938e-01  8.29079938e-01  8.29079938e-01
  1.25889046e+00  4.00802139e+00  4.00802139e+00  4.00802139e+00
  7.67339286e+00  1.48926947e+01  1.48926947e+01  1.48926947e+01
  3.55685228e+01  6.08959171e+01  6.08959171e+01  6.08959171e+01
  1.40091659e+02  5.04371954e+02  1.87196811e+03  8.00150108e+03
  4.77689613e+04]
E1 = -181.98975205424568  E_coul = 53.4751503212956
cycle= 1 E= -128.51460173295  delta_E= -0.0296  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50779
diis-c [-0.25785101  1.        ]
  HOMO = -0.884857063367376  LUMO = 0.801106446043475
  mo_energy =
[-3.28961646e+01 -1.97190642e+00 -8.84857063e-01 -8.84857063e-01
 -8.84857063e-01  8.01106446e-01  8.01106446e-01  8.01106446e-01
  1.20990612e+00  3.90494710e+00  3.90494710e+00  3.90494710e+00
  7.53238299e+00  1.46875009e+01  1.46875009e+01  1.46875009e+01
  3.53088202e+01  6.05879998e+01  6.05879998e+01  6.05879998e+01
  1.39757576e+02  5.03992610e+02  1.87155258e+03  8.00105658e+03
  4.77684980e+04]
E1 = -182.7867650952941  E_coul = 54.26931487416955
cycle= 2 E= -128.517450221125  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0711
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259156
diis-c [-6.08000153e-04  3.37153367e-01  6.62846633e-01]
  HOMO = -0.847612340920095  LUMO = 0.810330504584523
  mo_energy =
[-3.27832716e+01 -1.93267284e+00 -8.47612341e-01 -8.47612341e-01
 -8.47612341e-01  8.10330505e-01  8.10330505e-01  8.10330505e-01
  1.22570979e+00  3.93864402e+00  3.93864402e+00  3.93864402e+00
  7.57871664e+00  1.47557036e+01  1.47557036e+01  1.47557036e+01
  3.53955718e+01  6.06904425e+01  6.06904425e+01  6.06904425e+01
  1.39868381e+02  5.04114633e+02  1.87168010e+03  8.00118669e+03
  4.77686290e+04]
E1 = -182.51763042860998  E_coul = 53.99917477416889
cycle= 3 E= -128.518455654441  delta_E= -0.00101  |g|= 0.000268  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000332759
diis-c [-4.99590640e-08 -1.79395498e-03 -2.66700414e-03  1.00446096e+00]
  HOMO = -0.847754730584921  LUMO = 0.810326185044189
  mo_energy =
[-3.27834632e+01 -1.93280165e+00 -8.47754731e-01 -8.47754731e-01
 -8.47754731e-01  8.10326185e-01  8.10326185e-01  8.10326185e-01
  1.22566476e+00  3.93857127e+00  3.93857127e+00  3.93857127e+00
  7.57860814e+00  1.47555777e+01  1.47555777e+01  1.47555777e+01
  3.53954197e+01  6.06902664e+01  6.06902664e+01  6.06902664e+01
  1.39868195e+02  5.04114403e+02  1.87167981e+03  8.00118635e+03
  4.77686287e+04]
E1 = -182.51747924670224  E_coul = 53.999023584804064
cycle= 4 E= -128.518455661898  delta_E= -7.46e-09  |g|= 5.07e-05  |ddm|= 0.000174
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.26398e-05
diis-c [-4.57981932e-10  3.65030559e-05  3.64313791e-04 -9.46331617e-02
  1.09423234e+00]
  HOMO = -0.847781921789834  LUMO = 0.810317136286498
  mo_energy =
[-3.27835063e+01 -1.93283159e+00 -8.47781922e-01 -8.47781922e-01
 -8.47781922e-01  8.10317136e-01  8.10317136e-01  8.10317136e-01
  1.22564682e+00  3.93854409e+00  3.93854409e+00  3.93854409e+00
  7.57857384e+00  1.47555390e+01  1.47555390e+01  1.47555390e+01
  3.53953771e+01  6.06902235e+01  6.06902235e+01  6.06902235e+01
  1.39868152e+02  5.04114364e+02  1.87167978e+03  8.00118632e+03
  4.77686286e+04]
E1 = -182.51755311349166  E_coul = 53.99909745139499
cycle= 5 E= -128.518455662097  delta_E= -1.98e-10  |g|= 1.89e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51755311349166  E_coul = 53.99909745139499
  HOMO = -0.847781266694837  LUMO = 0.81031723316552
  mo_energy =
[-3.27835041e+01 -1.93283116e+00 -8.47781267e-01 -8.47781267e-01
 -8.47781267e-01  8.10317233e-01  8.10317233e-01  8.10317233e-01
  1.22564683e+00  3.93854460e+00  3.93854460e+00  3.93854460e+00
  7.57857455e+00  1.47555403e+01  1.47555403e+01  1.47555403e+01
  3.53953788e+01  6.06902254e+01  6.06902254e+01  6.06902254e+01
  1.39868154e+02  5.04114366e+02  1.87167978e+03  8.00118632e+03
  4.77686286e+04]
E1 = -182.51754614120634  E_coul = 53.999090479109036
Extra cycle  E= -128.518455662097  delta_E= -6.25e-13  |g|= 9.72e-07  |ddm|= 1.1e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721756e+02
 7.64808440e+01 1.01180893e+01 2.71474572e+01 3.87917156e-01
 3.00269828e+00 1.14853880e+00 2.48242350e+00 7.48331917e+00
 2.83356357e+01 2.66583039e-01 8.38400089e-01]
E = -128.5184556620973
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439812        1
[INPUT] 0    0    [1    /1   ]  833.272433259        1
[INPUT] 0    0    [1    /1   ]  235.721756154        1
[INPUT] 0    0    [1    /1   ]  76.4808439836        1
[INPUT] 0    0    [1    /1   ]  10.1180892956        1
[INPUT] 0    0    [1    /1   ]  27.1474572158        1
[INPUT] 0    0    [1    /1   ]  0.387917156229       1
[INPUT] 0    0    [1    /1   ]  3.00269827563        1
[INPUT] 0    0    [1    /1   ]  1.14853879589        1
[INPUT] 1    0    [1    /1   ]  2.48242350154        1
[INPUT] 1    0    [1    /1   ]  7.48331917418        1
[INPUT] 1    0    [1    /1   ]  28.3356357161        1
[INPUT] 1    0    [1    /1   ]  0.266583039404       1
[INPUT] 1    0    [1    /1   ]  0.838400089307       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410552, 1.0]], [0, [3661.4543981189945, 1.0]], [0, [833.272433258765, 1.0]], [0, [235.72175615443075, 1.0]], [0, [76.48084398363194, 1.0]], [0, [10.118089295571101, 1.0]], [0, [27.14745721576428, 1.0]], [0, [0.3879171562290062, 1.0]], [0, [3.0026982756318388, 1.0]], [0, [1.1485387958904376, 1.0]], [1, [2.482423501541193, 1.0]], [1, [7.483319174183697, 1.0]], [1, [28.33563571613118, 1.0]], [1, [0.26658303940377914, 1.0]], [1, [0.8384000893066297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439812]
bas 2, expnt(s) = [833.27243326]
bas 3, expnt(s) = [235.72175615]
bas 4, expnt(s) = [76.48084398]
bas 5, expnt(s) = [10.1180893]
bas 6, expnt(s) = [27.14745722]
bas 7, expnt(s) = [0.38791716]
bas 8, expnt(s) = [3.00269828]
bas 9, expnt(s) = [1.1485388]
bas 10, expnt(s) = [2.4824235]
bas 11, expnt(s) = [7.48331917]
bas 12, expnt(s) = [28.33563572]
bas 13, expnt(s) = [0.26658304]
bas 14, expnt(s) = [0.83840009]
CPU time:        71.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721756e+02 1.51989916e+02
 7.64808440e+01 6.53400599e+01 1.01180893e+01 1.43330595e+01
 2.71474572e+01 3.00477455e+01 3.87917156e-01 1.24185035e+00
 3.00269828e+00 5.76300233e+00 1.14853880e+00 2.80300761e+00
 2.48242350e+00 9.09032133e+00 7.48331917e+00 3.61078998e+01
 2.83356357e+01 1.90721913e+02 2.66583039e-01 5.58823983e-01
 8.38400089e-01 2.34044553e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999488653265386
cond(S) = 356.769511340886
E1 = -183.56150197404872  E_coul = 55.07649050829621
init E= -128.485011465753
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771824029176642  LUMO = 0.829079937729606
  mo_energy =
[-3.25563621e+01 -1.85278994e+00 -7.71824029e-01 -7.71824029e-01
 -7.71824029e-01  8.29079938e-01  8.29079938e-01  8.29079938e-01
  1.25889046e+00  4.00802139e+00  4.00802139e+00  4.00802139e+00
  7.67339286e+00  1.48926947e+01  1.48926947e+01  1.48926947e+01
  3.55685228e+01  6.08959171e+01  6.08959171e+01  6.08959171e+01
  1.40091659e+02  5.04371954e+02  1.87196811e+03  8.00150108e+03
  4.77689613e+04]
E1 = -181.98975205424568  E_coul = 53.4751503212956
cycle= 1 E= -128.51460173295  delta_E= -0.0296  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50779
diis-c [-0.25785101  1.        ]
  HOMO = -0.884857063367376  LUMO = 0.801106446043475
  mo_energy =
[-3.28961646e+01 -1.97190642e+00 -8.84857063e-01 -8.84857063e-01
 -8.84857063e-01  8.01106446e-01  8.01106446e-01  8.01106446e-01
  1.20990612e+00  3.90494710e+00  3.90494710e+00  3.90494710e+00
  7.53238299e+00  1.46875009e+01  1.46875009e+01  1.46875009e+01
  3.53088202e+01  6.05879998e+01  6.05879998e+01  6.05879998e+01
  1.39757576e+02  5.03992610e+02  1.87155258e+03  8.00105658e+03
  4.77684980e+04]
E1 = -182.7867650952941  E_coul = 54.26931487416955
cycle= 2 E= -128.517450221125  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0711
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259156
diis-c [-6.08000153e-04  3.37153367e-01  6.62846633e-01]
  HOMO = -0.847612340920095  LUMO = 0.810330504584523
  mo_energy =
[-3.27832716e+01 -1.93267284e+00 -8.47612341e-01 -8.47612341e-01
 -8.47612341e-01  8.10330505e-01  8.10330505e-01  8.10330505e-01
  1.22570979e+00  3.93864402e+00  3.93864402e+00  3.93864402e+00
  7.57871664e+00  1.47557036e+01  1.47557036e+01  1.47557036e+01
  3.53955718e+01  6.06904425e+01  6.06904425e+01  6.06904425e+01
  1.39868381e+02  5.04114633e+02  1.87168010e+03  8.00118669e+03
  4.77686290e+04]
E1 = -182.51763042860998  E_coul = 53.99917477416889
cycle= 3 E= -128.518455654441  delta_E= -0.00101  |g|= 0.000268  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000332759
diis-c [-4.99590640e-08 -1.79395498e-03 -2.66700414e-03  1.00446096e+00]
  HOMO = -0.847754730584921  LUMO = 0.810326185044189
  mo_energy =
[-3.27834632e+01 -1.93280165e+00 -8.47754731e-01 -8.47754731e-01
 -8.47754731e-01  8.10326185e-01  8.10326185e-01  8.10326185e-01
  1.22566476e+00  3.93857127e+00  3.93857127e+00  3.93857127e+00
  7.57860814e+00  1.47555777e+01  1.47555777e+01  1.47555777e+01
  3.53954197e+01  6.06902664e+01  6.06902664e+01  6.06902664e+01
  1.39868195e+02  5.04114403e+02  1.87167981e+03  8.00118635e+03
  4.77686287e+04]
E1 = -182.51747924670224  E_coul = 53.999023584804064
cycle= 4 E= -128.518455661898  delta_E= -7.46e-09  |g|= 5.07e-05  |ddm|= 0.000174
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.26398e-05
diis-c [-4.57981932e-10  3.65030559e-05  3.64313791e-04 -9.46331617e-02
  1.09423234e+00]
  HOMO = -0.847781921789834  LUMO = 0.810317136286498
  mo_energy =
[-3.27835063e+01 -1.93283159e+00 -8.47781922e-01 -8.47781922e-01
 -8.47781922e-01  8.10317136e-01  8.10317136e-01  8.10317136e-01
  1.22564682e+00  3.93854409e+00  3.93854409e+00  3.93854409e+00
  7.57857384e+00  1.47555390e+01  1.47555390e+01  1.47555390e+01
  3.53953771e+01  6.06902235e+01  6.06902235e+01  6.06902235e+01
  1.39868152e+02  5.04114364e+02  1.87167978e+03  8.00118632e+03
  4.77686286e+04]
E1 = -182.51755311349166  E_coul = 53.99909745139499
cycle= 5 E= -128.518455662097  delta_E= -1.98e-10  |g|= 1.89e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51755311349166  E_coul = 53.99909745139499
  HOMO = -0.847781266694837  LUMO = 0.81031723316552
  mo_energy =
[-3.27835041e+01 -1.93283116e+00 -8.47781267e-01 -8.47781267e-01
 -8.47781267e-01  8.10317233e-01  8.10317233e-01  8.10317233e-01
  1.22564683e+00  3.93854460e+00  3.93854460e+00  3.93854460e+00
  7.57857455e+00  1.47555403e+01  1.47555403e+01  1.47555403e+01
  3.53953788e+01  6.06902254e+01  6.06902254e+01  6.06902254e+01
  1.39868154e+02  5.04114366e+02  1.87167978e+03  8.00118632e+03
  4.77686286e+04]
E1 = -182.51754614120634  E_coul = 53.999090479109036
Extra cycle  E= -128.518455662097  delta_E= -6.25e-13  |g|= 9.72e-07  |ddm|= 1.1e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 356.769511340886
E1 = -182.51754614120634  E_coul = 53.999090479109036
init E= -128.518455662097
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.847781762092681  LUMO = 0.81031709916867
  mo_energy =
[-3.27835056e+01 -1.93283175e+00 -8.47781762e-01 -8.47781762e-01
 -8.47781762e-01  8.10317099e-01  8.10317099e-01  8.10317099e-01
  1.22564656e+00  3.93854413e+00  3.93854413e+00  3.93854413e+00
  7.57857390e+00  1.47555394e+01  1.47555394e+01  1.47555394e+01
  3.53953777e+01  6.06902241e+01  6.06902241e+01  6.06902241e+01
  1.39868153e+02  5.04114364e+02  1.87167978e+03  8.00118632e+03
  4.77686286e+04]
E1 = -182.517549354472  E_coul = 53.999093692374544
cycle= 1 E= -128.518455662097  delta_E= -1.71e-13  |g|= 4.39e-07  |ddm|= 3.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.517549354472  E_coul = 53.999093692374544
  HOMO = -0.847781534357855  LUMO = 0.810317153929963
  mo_energy =
[-3.27835049e+01 -1.93283152e+00 -8.47781534e-01 -8.47781534e-01
 -8.47781534e-01  8.10317154e-01  8.10317154e-01  8.10317154e-01
  1.22564665e+00  3.93854434e+00  3.93854434e+00  3.93854434e+00
  7.57857417e+00  1.47555398e+01  1.47555398e+01  1.47555398e+01
  3.53953782e+01  6.06902247e+01  6.06902247e+01  6.06902247e+01
  1.39868154e+02  5.04114365e+02  1.87167978e+03  8.00118632e+03
  4.77686286e+04]
E1 = -182.5175476525632  E_coul = 53.999091990465736
Extra cycle  E= -128.518455662097  delta_E=    0  |g|= 2.32e-07  |ddm|= 1.52e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721756e+02
 7.64808440e+01 1.01180893e+01 2.71474572e+01 3.87917156e-01
 3.00269828e+00 1.14853880e+00 2.48242350e+00 7.48331917e+00
 2.83356357e+01 2.66583039e-01 8.38400089e-01]
grad_E = [-1.18310627e-11  6.94101184e-10 -1.37877309e-08  1.54713830e-07
 -9.75014683e-07  2.24180467e-05  7.90890758e-07 -2.37480802e-06
  6.11872905e-05 -2.28056388e-06 -7.29448583e-04  4.02277076e-04
 -1.78126195e-03 -2.35593439e-04 -1.49481937e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439811        1
[INPUT] 0    0    [1    /1   ]  833.272433409        1
[INPUT] 0    0    [1    /1   ]  235.721754498        1
[INPUT] 0    0    [1    /1   ]  76.4808536937        1
[INPUT] 0    0    [1    /1   ]  10.1177424279        1
[INPUT] 0    0    [1    /1   ]  27.1474640665        1
[INPUT] 0    0    [1    /1   ]  0.387913394469       1
[INPUT] 0    0    [1    /1   ]  3.00183720268        1
[INPUT] 0    0    [1    /1   ]  1.14858681896        1
[INPUT] 1    0    [1    /1   ]  2.48187031625        1
[INPUT] 1    0    [1    /1   ]  7.49430648392        1
[INPUT] 1    0    [1    /1   ]  28.3580263907        1
[INPUT] 1    0    [1    /1   ]  0.268748086834       1
[INPUT] 1    0    [1    /1   ]  0.842099503807       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410676, 1.0]], [0, [3661.4543981114043, 1.0]], [0, [833.2724334090344, 1.0]], [0, [235.72175449830553, 1.0]], [0, [76.48085369370844, 1.0]], [0, [10.117742427871116, 1.0]], [0, [27.14746406647652, 1.0]], [0, [0.3879133944685353, 1.0]], [0, [3.001837202675543, 1.0]], [0, [1.1485868189600492, 1.0]], [1, [2.481870316252063, 1.0]], [1, [7.494306483917083, 1.0]], [1, [28.358026390672624, 1.0]], [1, [0.268748086834176, 1.0]], [1, [0.8420995038074456, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439811]
bas 2, expnt(s) = [833.27243341]
bas 3, expnt(s) = [235.7217545]
bas 4, expnt(s) = [76.48085369]
bas 5, expnt(s) = [10.11774243]
bas 6, expnt(s) = [27.14746407]
bas 7, expnt(s) = [0.38791339]
bas 8, expnt(s) = [3.0018372]
bas 9, expnt(s) = [1.14858682]
bas 10, expnt(s) = [2.48187032]
bas 11, expnt(s) = [7.49430648]
bas 12, expnt(s) = [28.35802639]
bas 13, expnt(s) = [0.26874809]
bas 14, expnt(s) = [0.8420995]
CPU time:        74.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721754e+02 1.51989915e+02
 7.64808537e+01 6.53400661e+01 1.01177424e+01 1.43326910e+01
 2.71474641e+01 3.00477512e+01 3.87913394e-01 1.24184132e+00
 3.00183720e+00 5.76176281e+00 1.14858682e+00 2.80309551e+00
 2.48187032e+00 9.08778928e+00 7.49430648e+00 3.61741808e+01
 2.83580264e+01 1.90910316e+02 2.68748087e-01 5.64502824e-01
 8.42099504e-01 2.35336157e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999476186668856
cond(S) = 356.736559125542
E1 = -183.5615984662301  E_coul = 55.0765246873243
init E= -128.485073778906
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771825430062004  LUMO = 0.836266196056827
  mo_energy =
[-3.25563494e+01 -1.85278899e+00 -7.71825430e-01 -7.71825430e-01
 -7.71825430e-01  8.36266196e-01  8.36266196e-01  8.36266196e-01
  1.25888234e+00  4.02526600e+00  4.02526600e+00  4.02526600e+00
  7.67235256e+00  1.49212195e+01  1.49212195e+01  1.49212195e+01
  3.55649530e+01  6.09728885e+01  6.09728885e+01  6.09728885e+01
  1.40087192e+02  5.04367635e+02  1.87196418e+03  8.00149760e+03
  4.77689584e+04]
E1 = -181.99211772721927  E_coul = 53.477476750914306
cycle= 1 E= -128.514640976305  delta_E= -0.0296  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507487
diis-c [-0.25754294  1.        ]
  HOMO = -0.884674894152368  LUMO = 0.808092184660275
  mo_energy =
[-3.28957725e+01 -1.97169317e+00 -8.84674894e-01 -8.84674894e-01
 -8.84674894e-01  8.08092185e-01  8.08092185e-01  8.08092185e-01
  1.21001195e+00  3.92226899e+00  3.92226899e+00  3.92226899e+00
  7.53160092e+00  1.47162600e+01  1.47162600e+01  1.47162600e+01
  3.53055837e+01  6.06652774e+01  6.06652774e+01  6.06652774e+01
  1.39753487e+02  5.03988718e+02  1.87154910e+03  8.00105356e+03
  4.77684955e+04]
E1 = -182.7876652044859  E_coul = 54.27018196115027
cycle= 2 E= -128.517483243336  delta_E= -0.00284  |g|= 0.108  |ddm|= 0.071
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258832
diis-c [-6.08920150e-04  3.37004145e-01  6.62995855e-01]
  HOMO = -0.847493366610527  LUMO = 0.817380596730756
  mo_energy =
[-3.27830479e+01 -1.93252810e+00 -8.47493367e-01 -8.47493367e-01
 -8.47493367e-01  8.17380597e-01  8.17380597e-01  8.17380597e-01
  1.22578166e+00  3.95594050e+00  3.95594050e+00  3.95594050e+00
  7.57785072e+00  1.47843684e+01  1.47843684e+01  1.47843684e+01
  3.53921990e+01  6.07675782e+01  6.07675782e+01  6.07675782e+01
  1.39864126e+02  5.04110562e+02  1.87167643e+03  8.00118348e+03
  4.77686264e+04]
E1 = -182.51912356842612  E_coul = 54.00063877188882
cycle= 3 E= -128.518484796537  delta_E= -0.001  |g|= 0.00027  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000336137
diis-c [-4.90392094e-08 -1.79412455e-03 -2.63993542e-03  1.00443406e+00]
  HOMO = -0.84763634591943  LUMO = 0.817375726657358
  mo_energy =
[-3.27832421e+01 -1.93265676e+00 -8.47636346e-01 -8.47636346e-01
 -8.47636346e-01  8.17375727e-01  8.17375727e-01  8.17375727e-01
  1.22573653e+00  3.95586687e+00  3.95586687e+00  3.95586687e+00
  7.57774184e+00  1.47842413e+01  1.47842413e+01  1.47842413e+01
  3.53920455e+01  6.07673998e+01  6.07673998e+01  6.07673998e+01
  1.39863938e+02  5.04110328e+02  1.87167614e+03  8.00118314e+03
  4.77686260e+04]
E1 = -182.51897918984668  E_coul = 54.00049438583699
cycle= 4 E= -128.51848480401  delta_E= -7.47e-09  |g|= 5.06e-05  |ddm|= 0.000175
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.31268e-05
diis-c [-4.45862275e-10  3.54140030e-05  3.63682688e-04 -9.29863172e-02
  1.09258722e+00]
  HOMO = -0.847663517615702  LUMO = 0.817366628541627
  mo_energy =
[-3.27832852e+01 -1.93268647e+00 -8.47663518e-01 -8.47663518e-01
 -8.47663518e-01  8.17366629e-01  8.17366629e-01  8.17366629e-01
  1.22571874e+00  3.95583973e+00  3.95583973e+00  3.95583973e+00
  7.57770769e+00  1.47842026e+01  1.47842026e+01  1.47842026e+01
  3.53920030e+01  6.07673569e+01  6.07673569e+01  6.07673569e+01
  1.39863896e+02  5.04110289e+02  1.87167610e+03  8.00118310e+03
  4.77686260e+04]
E1 = -182.51905333796432  E_coul = 54.00056853375653
cycle= 5 E= -128.518484804208  delta_E= -1.98e-10  |g|= 1.79e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51905333796432  E_coul = 54.00056853375653
  HOMO = -0.847662931630049  LUMO = 0.8173667090994
  mo_energy =
[-3.27832832e+01 -1.93268610e+00 -8.47662932e-01 -8.47662932e-01
 -8.47662932e-01  8.17366709e-01  8.17366709e-01  8.17366709e-01
  1.22571872e+00  3.95584017e+00  3.95584017e+00  3.95584017e+00
  7.57770833e+00  1.47842038e+01  1.47842038e+01  1.47842038e+01
  3.53920045e+01  6.07673587e+01  6.07673587e+01  6.07673587e+01
  1.39863897e+02  5.04110290e+02  1.87167610e+03  8.00118310e+03
  4.77686260e+04]
E1 = -182.5190467488639  E_coul = 54.00056194465588
Extra cycle  E= -128.518484804208  delta_E= -2.27e-13  |g|= 9.15e-07  |ddm|= 1.05e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721754e+02
 7.64808537e+01 1.01177424e+01 2.71474641e+01 3.87913394e-01
 3.00183720e+00 1.14858682e+00 2.48187032e+00 7.49430648e+00
 2.83580264e+01 2.68748087e-01 8.42099504e-01]
E = -128.51848480420801
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439811        1
[INPUT] 0    0    [1    /1   ]  833.272433409        1
[INPUT] 0    0    [1    /1   ]  235.721754498        1
[INPUT] 0    0    [1    /1   ]  76.4808536937        1
[INPUT] 0    0    [1    /1   ]  10.1177424279        1
[INPUT] 0    0    [1    /1   ]  27.1474640665        1
[INPUT] 0    0    [1    /1   ]  0.387913394469       1
[INPUT] 0    0    [1    /1   ]  3.00183720268        1
[INPUT] 0    0    [1    /1   ]  1.14858681896        1
[INPUT] 1    0    [1    /1   ]  2.48187031625        1
[INPUT] 1    0    [1    /1   ]  7.49430648392        1
[INPUT] 1    0    [1    /1   ]  28.3580263907        1
[INPUT] 1    0    [1    /1   ]  0.268748086834       1
[INPUT] 1    0    [1    /1   ]  0.842099503807       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410676, 1.0]], [0, [3661.4543981114043, 1.0]], [0, [833.2724334090344, 1.0]], [0, [235.72175449830553, 1.0]], [0, [76.48085369370844, 1.0]], [0, [10.117742427871116, 1.0]], [0, [27.14746406647652, 1.0]], [0, [0.3879133944685353, 1.0]], [0, [3.001837202675543, 1.0]], [0, [1.1485868189600492, 1.0]], [1, [2.481870316252063, 1.0]], [1, [7.494306483917083, 1.0]], [1, [28.358026390672624, 1.0]], [1, [0.268748086834176, 1.0]], [1, [0.8420995038074456, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439811]
bas 2, expnt(s) = [833.27243341]
bas 3, expnt(s) = [235.7217545]
bas 4, expnt(s) = [76.48085369]
bas 5, expnt(s) = [10.11774243]
bas 6, expnt(s) = [27.14746407]
bas 7, expnt(s) = [0.38791339]
bas 8, expnt(s) = [3.0018372]
bas 9, expnt(s) = [1.14858682]
bas 10, expnt(s) = [2.48187032]
bas 11, expnt(s) = [7.49430648]
bas 12, expnt(s) = [28.35802639]
bas 13, expnt(s) = [0.26874809]
bas 14, expnt(s) = [0.8420995]
CPU time:        74.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272433e+02 3.91836858e+02 2.35721754e+02 1.51989915e+02
 7.64808537e+01 6.53400661e+01 1.01177424e+01 1.43326910e+01
 2.71474641e+01 3.00477512e+01 3.87913394e-01 1.24184132e+00
 3.00183720e+00 5.76176281e+00 1.14858682e+00 2.80309551e+00
 2.48187032e+00 9.08778928e+00 7.49430648e+00 3.61741808e+01
 2.83580264e+01 1.90910316e+02 2.68748087e-01 5.64502824e-01
 8.42099504e-01 2.35336157e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999476186668856
cond(S) = 356.736559125542
E1 = -183.5615984662301  E_coul = 55.0765246873243
init E= -128.485073778906
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771825430062004  LUMO = 0.836266196056827
  mo_energy =
[-3.25563494e+01 -1.85278899e+00 -7.71825430e-01 -7.71825430e-01
 -7.71825430e-01  8.36266196e-01  8.36266196e-01  8.36266196e-01
  1.25888234e+00  4.02526600e+00  4.02526600e+00  4.02526600e+00
  7.67235256e+00  1.49212195e+01  1.49212195e+01  1.49212195e+01
  3.55649530e+01  6.09728885e+01  6.09728885e+01  6.09728885e+01
  1.40087192e+02  5.04367635e+02  1.87196418e+03  8.00149760e+03
  4.77689584e+04]
E1 = -181.99211772721927  E_coul = 53.477476750914306
cycle= 1 E= -128.514640976305  delta_E= -0.0296  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.507487
diis-c [-0.25754294  1.        ]
  HOMO = -0.884674894152368  LUMO = 0.808092184660275
  mo_energy =
[-3.28957725e+01 -1.97169317e+00 -8.84674894e-01 -8.84674894e-01
 -8.84674894e-01  8.08092185e-01  8.08092185e-01  8.08092185e-01
  1.21001195e+00  3.92226899e+00  3.92226899e+00  3.92226899e+00
  7.53160092e+00  1.47162600e+01  1.47162600e+01  1.47162600e+01
  3.53055837e+01  6.06652774e+01  6.06652774e+01  6.06652774e+01
  1.39753487e+02  5.03988718e+02  1.87154910e+03  8.00105356e+03
  4.77684955e+04]
E1 = -182.7876652044859  E_coul = 54.27018196115027
cycle= 2 E= -128.517483243336  delta_E= -0.00284  |g|= 0.108  |ddm|= 0.071
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258832
diis-c [-6.08920150e-04  3.37004145e-01  6.62995855e-01]
  HOMO = -0.847493366610527  LUMO = 0.817380596730756
  mo_energy =
[-3.27830479e+01 -1.93252810e+00 -8.47493367e-01 -8.47493367e-01
 -8.47493367e-01  8.17380597e-01  8.17380597e-01  8.17380597e-01
  1.22578166e+00  3.95594050e+00  3.95594050e+00  3.95594050e+00
  7.57785072e+00  1.47843684e+01  1.47843684e+01  1.47843684e+01
  3.53921990e+01  6.07675782e+01  6.07675782e+01  6.07675782e+01
  1.39864126e+02  5.04110562e+02  1.87167643e+03  8.00118348e+03
  4.77686264e+04]
E1 = -182.51912356842612  E_coul = 54.00063877188882
cycle= 3 E= -128.518484796537  delta_E= -0.001  |g|= 0.00027  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000336137
diis-c [-4.90392094e-08 -1.79412455e-03 -2.63993542e-03  1.00443406e+00]
  HOMO = -0.84763634591943  LUMO = 0.817375726657358
  mo_energy =
[-3.27832421e+01 -1.93265676e+00 -8.47636346e-01 -8.47636346e-01
 -8.47636346e-01  8.17375727e-01  8.17375727e-01  8.17375727e-01
  1.22573653e+00  3.95586687e+00  3.95586687e+00  3.95586687e+00
  7.57774184e+00  1.47842413e+01  1.47842413e+01  1.47842413e+01
  3.53920455e+01  6.07673998e+01  6.07673998e+01  6.07673998e+01
  1.39863938e+02  5.04110328e+02  1.87167614e+03  8.00118314e+03
  4.77686260e+04]
E1 = -182.51897918984668  E_coul = 54.00049438583699
cycle= 4 E= -128.51848480401  delta_E= -7.47e-09  |g|= 5.06e-05  |ddm|= 0.000175
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.31268e-05
diis-c [-4.45862275e-10  3.54140030e-05  3.63682688e-04 -9.29863172e-02
  1.09258722e+00]
  HOMO = -0.847663517615702  LUMO = 0.817366628541627
  mo_energy =
[-3.27832852e+01 -1.93268647e+00 -8.47663518e-01 -8.47663518e-01
 -8.47663518e-01  8.17366629e-01  8.17366629e-01  8.17366629e-01
  1.22571874e+00  3.95583973e+00  3.95583973e+00  3.95583973e+00
  7.57770769e+00  1.47842026e+01  1.47842026e+01  1.47842026e+01
  3.53920030e+01  6.07673569e+01  6.07673569e+01  6.07673569e+01
  1.39863896e+02  5.04110289e+02  1.87167610e+03  8.00118310e+03
  4.77686260e+04]
E1 = -182.51905333796432  E_coul = 54.00056853375653
cycle= 5 E= -128.518484804208  delta_E= -1.98e-10  |g|= 1.79e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51905333796432  E_coul = 54.00056853375653
  HOMO = -0.847662931630049  LUMO = 0.8173667090994
  mo_energy =
[-3.27832832e+01 -1.93268610e+00 -8.47662932e-01 -8.47662932e-01
 -8.47662932e-01  8.17366709e-01  8.17366709e-01  8.17366709e-01
  1.22571872e+00  3.95584017e+00  3.95584017e+00  3.95584017e+00
  7.57770833e+00  1.47842038e+01  1.47842038e+01  1.47842038e+01
  3.53920045e+01  6.07673587e+01  6.07673587e+01  6.07673587e+01
  1.39863897e+02  5.04110290e+02  1.87167610e+03  8.00118310e+03
  4.77686260e+04]
E1 = -182.5190467488639  E_coul = 54.00056194465588
Extra cycle  E= -128.518484804208  delta_E= -2.27e-13  |g|= 9.15e-07  |ddm|= 1.05e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 356.736559125542
E1 = -182.5190467488639  E_coul = 54.00056194465588
init E= -128.518484804208
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.847663401258298  LUMO = 0.817366580631168
  mo_energy =
[-3.27832846e+01 -1.93268665e+00 -8.47663401e-01 -8.47663401e-01
 -8.47663401e-01  8.17366581e-01  8.17366581e-01  8.17366581e-01
  1.22571847e+00  3.95583973e+00  3.95583973e+00  3.95583973e+00
  7.57770771e+00  1.47842029e+01  1.47842029e+01  1.47842029e+01
  3.53920035e+01  6.07673574e+01  6.07673574e+01  6.07673574e+01
  1.39863896e+02  5.04110289e+02  1.87167610e+03  8.00118310e+03
  4.77686260e+04]
E1 = -182.51904976691017  E_coul = 54.00056496270225
cycle= 1 E= -128.518484804208  delta_E= 8.53e-14  |g|= 4.13e-07  |ddm|= 3.41e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51904976691017  E_coul = 54.00056496270225
  HOMO = -0.847663187554152  LUMO = 0.817366632428373
  mo_energy =
[-3.27832839e+01 -1.93268644e+00 -8.47663188e-01 -8.47663188e-01
 -8.47663188e-01  8.17366632e-01  8.17366632e-01  8.17366632e-01
  1.22571855e+00  3.95583992e+00  3.95583992e+00  3.95583992e+00
  7.57770797e+00  1.47842033e+01  1.47842033e+01  1.47842033e+01
  3.53920040e+01  6.07673580e+01  6.07673580e+01  6.07673580e+01
  1.39863897e+02  5.04110290e+02  1.87167610e+03  8.00118310e+03
  4.77686260e+04]
E1 = -182.51904816767515  E_coul = 54.000563363467194
Extra cycle  E= -128.518484804208  delta_E= -2.84e-14  |g|= 2.18e-07  |ddm|= 1.43e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272433e+02 2.35721754e+02
 7.64808537e+01 1.01177424e+01 2.71474641e+01 3.87913394e-01
 3.00183720e+00 1.14858682e+00 2.48187032e+00 7.49430648e+00
 2.83580264e+01 2.68748087e-01 8.42099504e-01]
grad_E = [-1.37419480e-11  7.94586081e-10 -1.58113536e-08  1.79102106e-07
 -1.16734166e-06  2.02918148e-05  1.72561471e-06 -2.25167440e-05
  5.83091301e-05  1.12310460e-05 -2.22214929e-03  7.97011969e-04
 -1.81146606e-03  6.34085505e-04  1.91759409e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439809        1
[INPUT] 0    0    [1    /1   ]  833.272433753        1
[INPUT] 0    0    [1    /1   ]  235.721750812        1
[INPUT] 0    0    [1    /1   ]  76.4808726566        1
[INPUT] 0    0    [1    /1   ]  10.1165577272        1
[INPUT] 0    0    [1    /1   ]  27.1475365077        1
[INPUT] 0    0    [1    /1   ]  0.388438133566       1
[INPUT] 0    0    [1    /1   ]  2.99904049557        1
[INPUT] 0    0    [1    /1   ]  1.15000442806        1
[INPUT] 1    0    [1    /1   ]  2.48728939849        1
[INPUT] 1    0    [1    /1   ]  7.52515489724        1
[INPUT] 1    0    [1    /1   ]  28.4241900961        1
[INPUT] 1    0    [1    /1   ]  0.272738420685       1
[INPUT] 1    0    [1    /1   ]  0.850122674474       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410952, 1.0]], [0, [3661.454398093944, 1.0]], [0, [833.2724337530033, 1.0]], [0, [235.72175081175124, 1.0]], [0, [76.4808726565565, 1.0]], [0, [10.116557727170248, 1.0]], [0, [27.14753650771735, 1.0]], [0, [0.3884381335662516, 1.0]], [0, [2.999040495572191, 1.0]], [0, [1.1500044280603983, 1.0]], [1, [2.487289398487784, 1.0]], [1, [7.52515489724428, 1.0]], [1, [28.424190096128825, 1.0]], [1, [0.2727384206854448, 1.0]], [1, [0.8501226744738063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439809]
bas 2, expnt(s) = [833.27243375]
bas 3, expnt(s) = [235.72175081]
bas 4, expnt(s) = [76.48087266]
bas 5, expnt(s) = [10.11655773]
bas 6, expnt(s) = [27.14753651]
bas 7, expnt(s) = [0.38843813]
bas 8, expnt(s) = [2.9990405]
bas 9, expnt(s) = [1.15000443]
bas 10, expnt(s) = [2.4872894]
bas 11, expnt(s) = [7.5251549]
bas 12, expnt(s) = [28.4241901]
bas 13, expnt(s) = [0.27273842]
bas 14, expnt(s) = [0.85012267]
CPU time:        77.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721751e+02 1.51989914e+02
 7.64808727e+01 6.53400782e+01 1.01165577e+01 1.43314323e+01
 2.71475365e+01 3.00478113e+01 3.88438134e-01 1.24310101e+00
 2.99904050e+00 5.75773631e+00 1.15000443e+00 2.80568983e+00
 2.48728940e+00 9.11259966e+00 7.52515490e+00 3.63604038e+01
 2.84241901e+01 1.91467257e+02 2.72738421e-01 5.74999271e-01
 8.50122674e-01 2.38142217e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999446478741927
cond(S) = 357.01021461577443
E1 = -183.56177284461364  E_coul = 55.07658103879874
init E= -128.485191805815
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771831275847165  LUMO = 0.849899452268791
  mo_energy =
[-3.25563280e+01 -1.85278721e+00 -7.71831276e-01 -7.71831276e-01
 -7.71831276e-01  8.49899452e-01  8.49899452e-01  8.49899452e-01
  1.26101390e+00  4.06375820e+00  4.06375820e+00  4.06375820e+00
  7.67534508e+00  1.50049342e+01  1.50049342e+01  1.50049342e+01
  3.55610208e+01  6.12044030e+01  6.12044030e+01  6.12044030e+01
  1.40079624e+02  5.04359855e+02  1.87195701e+03  8.00149125e+03
  4.77689531e+04]
E1 = -181.99668610111354  E_coul = 53.48195322195455
cycle= 1 E= -128.514732879159  delta_E= -0.0295  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506788
diis-c [-0.2568337  1.       ]
  HOMO = -0.884330420479556  LUMO = 0.821335027308808
  mo_energy =
[-3.28950017e+01 -1.97128900e+00 -8.84330420e-01 -8.84330420e-01
 -8.84330420e-01  8.21335027e-01  8.21335027e-01  8.21335027e-01
  1.21230094e+00  3.96073391e+00  3.96073391e+00  3.96073391e+00
  7.53507774e+00  1.48002656e+01  1.48002656e+01  1.48002656e+01
  3.53023126e+01  6.08973569e+01  6.08973569e+01  6.08973569e+01
  1.39746664e+02  5.03981765e+02  1.87154280e+03  8.00104808e+03
  4.77684911e+04]
E1 = -182.78941885409128  E_coul = 54.27185594883013
cycle= 2 E= -128.517562905261  delta_E= -0.00283  |g|= 0.108  |ddm|= 0.0708
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258161
diis-c [-6.10132082e-04  3.36725920e-01  6.63274080e-01]
  HOMO = -0.847270863304327  LUMO = 0.830750333864508
  mo_energy =
[-3.27826024e+01 -1.93225578e+00 -8.47270863e-01 -8.47270863e-01
 -8.47270863e-01  8.30750334e-01  8.30750334e-01  8.30750334e-01
  1.22802593e+00  3.99441437e+00  3.99441437e+00  3.99441437e+00
  7.58116734e+00  1.48682473e+01  1.48682473e+01  1.48682473e+01
  3.53886614e+01  6.09993978e+01  6.09993978e+01  6.09993978e+01
  1.39856983e+02  5.04103262e+02  1.87166977e+03  8.00117763e+03
  4.77686217e+04]
E1 = -182.52201269953838  E_coul = 54.00345564132043
cycle= 3 E= -128.518557058218  delta_E= -0.000994  |g|= 0.000272  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000342458
diis-c [-4.71029455e-08 -1.79414852e-03 -2.58825420e-03  1.00438240e+00]
  HOMO = -0.847414620797152  LUMO = 0.830744662853658
  mo_energy =
[-3.27828009e+01 -1.93238388e+00 -8.47414621e-01 -8.47414621e-01
 -8.47414621e-01  8.30744663e-01  8.30744663e-01  8.30744663e-01
  1.22798094e+00  3.99433941e+00  3.99433941e+00  3.99433941e+00
  7.58105802e+00  1.48681180e+01  1.48681180e+01  1.48681180e+01
  3.53885055e+01  6.09992157e+01  6.09992157e+01  6.09992157e+01
  1.39856790e+02  5.04103022e+02  1.87166947e+03  8.00117728e+03
  4.77686213e+04]
E1 = -182.52188266486684  E_coul = 54.00332559924234
cycle= 4 E= -128.518557065624  delta_E= -7.41e-09  |g|= 5.04e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.37174e-05
diis-c [-4.22208610e-10  3.33202472e-05  3.61308873e-04 -8.98458828e-02
  1.08945125e+00]
  HOMO = -0.847441628700282  LUMO = 0.830735519540893
  mo_energy =
[-3.27828439e+01 -1.93241305e+00 -8.47441629e-01 -8.47441629e-01
 -8.47441629e-01  8.30735520e-01  8.30735520e-01  8.30735520e-01
  1.22796349e+00  3.99431243e+00  3.99431243e+00  3.99431243e+00
  7.58102429e+00  1.48680797e+01  1.48680797e+01  1.48680797e+01
  3.53884633e+01  6.09991730e+01  6.09991730e+01  6.09991730e+01
  1.39856748e+02  5.04102982e+02  1.87166943e+03  8.00117724e+03
  4.77686212e+04]
E1 = -182.52195721796087  E_coul = 54.00340015214264
cycle= 5 E= -128.518557065818  delta_E= -1.94e-10  |g|= 1.6e-06  |ddm|= 1.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52195721796087  E_coul = 54.00340015214264
  HOMO = -0.847441164556275  LUMO = 0.830735571437
  mo_energy =
[-3.27828422e+01 -1.93241275e+00 -8.47441165e-01 -8.47441165e-01
 -8.47441165e-01  8.30735571e-01  8.30735571e-01  8.30735571e-01
  1.22796344e+00  3.99431277e+00  3.99431277e+00  3.99431277e+00
  7.58102480e+00  1.48680806e+01  1.48680806e+01  1.48680806e+01
  3.53884646e+01  6.09991745e+01  6.09991745e+01  6.09991745e+01
  1.39856750e+02  5.04102983e+02  1.87166943e+03  8.00117725e+03
  4.77686212e+04]
E1 = -182.52195132570097  E_coul = 54.003394259882256
Extra cycle  E= -128.518557065819  delta_E= -4.55e-13  |g|= 8.11e-07  |ddm|= 9.66e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721751e+02
 7.64808727e+01 1.01165577e+01 2.71475365e+01 3.88438134e-01
 2.99904050e+00 1.15000443e+00 2.48728940e+00 7.52515490e+00
 2.84241901e+01 2.72738421e-01 8.50122674e-01]
E = -128.5185570658187
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439809        1
[INPUT] 0    0    [1    /1   ]  833.272433753        1
[INPUT] 0    0    [1    /1   ]  235.721750812        1
[INPUT] 0    0    [1    /1   ]  76.4808726566        1
[INPUT] 0    0    [1    /1   ]  10.1165577272        1
[INPUT] 0    0    [1    /1   ]  27.1475365077        1
[INPUT] 0    0    [1    /1   ]  0.388438133566       1
[INPUT] 0    0    [1    /1   ]  2.99904049557        1
[INPUT] 0    0    [1    /1   ]  1.15000442806        1
[INPUT] 1    0    [1    /1   ]  2.48728939849        1
[INPUT] 1    0    [1    /1   ]  7.52515489724        1
[INPUT] 1    0    [1    /1   ]  28.4241900961        1
[INPUT] 1    0    [1    /1   ]  0.272738420685       1
[INPUT] 1    0    [1    /1   ]  0.850122674474       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131410952, 1.0]], [0, [3661.454398093944, 1.0]], [0, [833.2724337530033, 1.0]], [0, [235.72175081175124, 1.0]], [0, [76.4808726565565, 1.0]], [0, [10.116557727170248, 1.0]], [0, [27.14753650771735, 1.0]], [0, [0.3884381335662516, 1.0]], [0, [2.999040495572191, 1.0]], [0, [1.1500044280603983, 1.0]], [1, [2.487289398487784, 1.0]], [1, [7.52515489724428, 1.0]], [1, [28.424190096128825, 1.0]], [1, [0.2727384206854448, 1.0]], [1, [0.8501226744738063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439809]
bas 2, expnt(s) = [833.27243375]
bas 3, expnt(s) = [235.72175081]
bas 4, expnt(s) = [76.48087266]
bas 5, expnt(s) = [10.11655773]
bas 6, expnt(s) = [27.14753651]
bas 7, expnt(s) = [0.38843813]
bas 8, expnt(s) = [2.9990405]
bas 9, expnt(s) = [1.15000443]
bas 10, expnt(s) = [2.4872894]
bas 11, expnt(s) = [7.5251549]
bas 12, expnt(s) = [28.4241901]
bas 13, expnt(s) = [0.27273842]
bas 14, expnt(s) = [0.85012267]
CPU time:        78.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272434e+02 3.91836858e+02 2.35721751e+02 1.51989914e+02
 7.64808727e+01 6.53400782e+01 1.01165577e+01 1.43314323e+01
 2.71475365e+01 3.00478113e+01 3.88438134e-01 1.24310101e+00
 2.99904050e+00 5.75773631e+00 1.15000443e+00 2.80568983e+00
 2.48728940e+00 9.11259966e+00 7.52515490e+00 3.63604038e+01
 2.84241901e+01 1.91467257e+02 2.72738421e-01 5.74999271e-01
 8.50122674e-01 2.38142217e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999446478741927
cond(S) = 357.01021461577443
E1 = -183.56177284461364  E_coul = 55.07658103879874
init E= -128.485191805815
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771831275847165  LUMO = 0.849899452268791
  mo_energy =
[-3.25563280e+01 -1.85278721e+00 -7.71831276e-01 -7.71831276e-01
 -7.71831276e-01  8.49899452e-01  8.49899452e-01  8.49899452e-01
  1.26101390e+00  4.06375820e+00  4.06375820e+00  4.06375820e+00
  7.67534508e+00  1.50049342e+01  1.50049342e+01  1.50049342e+01
  3.55610208e+01  6.12044030e+01  6.12044030e+01  6.12044030e+01
  1.40079624e+02  5.04359855e+02  1.87195701e+03  8.00149125e+03
  4.77689531e+04]
E1 = -181.99668610111354  E_coul = 53.48195322195455
cycle= 1 E= -128.514732879159  delta_E= -0.0295  |g|= 0.214  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.506788
diis-c [-0.2568337  1.       ]
  HOMO = -0.884330420479556  LUMO = 0.821335027308808
  mo_energy =
[-3.28950017e+01 -1.97128900e+00 -8.84330420e-01 -8.84330420e-01
 -8.84330420e-01  8.21335027e-01  8.21335027e-01  8.21335027e-01
  1.21230094e+00  3.96073391e+00  3.96073391e+00  3.96073391e+00
  7.53507774e+00  1.48002656e+01  1.48002656e+01  1.48002656e+01
  3.53023126e+01  6.08973569e+01  6.08973569e+01  6.08973569e+01
  1.39746664e+02  5.03981765e+02  1.87154280e+03  8.00104808e+03
  4.77684911e+04]
E1 = -182.78941885409128  E_coul = 54.27185594883013
cycle= 2 E= -128.517562905261  delta_E= -0.00283  |g|= 0.108  |ddm|= 0.0708
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.258161
diis-c [-6.10132082e-04  3.36725920e-01  6.63274080e-01]
  HOMO = -0.847270863304327  LUMO = 0.830750333864508
  mo_energy =
[-3.27826024e+01 -1.93225578e+00 -8.47270863e-01 -8.47270863e-01
 -8.47270863e-01  8.30750334e-01  8.30750334e-01  8.30750334e-01
  1.22802593e+00  3.99441437e+00  3.99441437e+00  3.99441437e+00
  7.58116734e+00  1.48682473e+01  1.48682473e+01  1.48682473e+01
  3.53886614e+01  6.09993978e+01  6.09993978e+01  6.09993978e+01
  1.39856983e+02  5.04103262e+02  1.87166977e+03  8.00117763e+03
  4.77686217e+04]
E1 = -182.52201269953838  E_coul = 54.00345564132043
cycle= 3 E= -128.518557058218  delta_E= -0.000994  |g|= 0.000272  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000342458
diis-c [-4.71029455e-08 -1.79414852e-03 -2.58825420e-03  1.00438240e+00]
  HOMO = -0.847414620797152  LUMO = 0.830744662853658
  mo_energy =
[-3.27828009e+01 -1.93238388e+00 -8.47414621e-01 -8.47414621e-01
 -8.47414621e-01  8.30744663e-01  8.30744663e-01  8.30744663e-01
  1.22798094e+00  3.99433941e+00  3.99433941e+00  3.99433941e+00
  7.58105802e+00  1.48681180e+01  1.48681180e+01  1.48681180e+01
  3.53885055e+01  6.09992157e+01  6.09992157e+01  6.09992157e+01
  1.39856790e+02  5.04103022e+02  1.87166947e+03  8.00117728e+03
  4.77686213e+04]
E1 = -182.52188266486684  E_coul = 54.00332559924234
cycle= 4 E= -128.518557065624  delta_E= -7.41e-09  |g|= 5.04e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.37174e-05
diis-c [-4.22208610e-10  3.33202472e-05  3.61308873e-04 -8.98458828e-02
  1.08945125e+00]
  HOMO = -0.847441628700282  LUMO = 0.830735519540893
  mo_energy =
[-3.27828439e+01 -1.93241305e+00 -8.47441629e-01 -8.47441629e-01
 -8.47441629e-01  8.30735520e-01  8.30735520e-01  8.30735520e-01
  1.22796349e+00  3.99431243e+00  3.99431243e+00  3.99431243e+00
  7.58102429e+00  1.48680797e+01  1.48680797e+01  1.48680797e+01
  3.53884633e+01  6.09991730e+01  6.09991730e+01  6.09991730e+01
  1.39856748e+02  5.04102982e+02  1.87166943e+03  8.00117724e+03
  4.77686212e+04]
E1 = -182.52195721796087  E_coul = 54.00340015214264
cycle= 5 E= -128.518557065818  delta_E= -1.94e-10  |g|= 1.6e-06  |ddm|= 1.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52195721796087  E_coul = 54.00340015214264
  HOMO = -0.847441164556275  LUMO = 0.830735571437
  mo_energy =
[-3.27828422e+01 -1.93241275e+00 -8.47441165e-01 -8.47441165e-01
 -8.47441165e-01  8.30735571e-01  8.30735571e-01  8.30735571e-01
  1.22796344e+00  3.99431277e+00  3.99431277e+00  3.99431277e+00
  7.58102480e+00  1.48680806e+01  1.48680806e+01  1.48680806e+01
  3.53884646e+01  6.09991745e+01  6.09991745e+01  6.09991745e+01
  1.39856750e+02  5.04102983e+02  1.87166943e+03  8.00117725e+03
  4.77686212e+04]
E1 = -182.52195132570097  E_coul = 54.003394259882256
Extra cycle  E= -128.518557065819  delta_E= -4.55e-13  |g|= 8.11e-07  |ddm|= 9.66e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 357.01021461577443
E1 = -182.52195132570097  E_coul = 54.003394259882256
init E= -128.518557065819
    CPU time for initialize scf      0.21 sec, wall time      0.20 sec
  HOMO = -0.847441587320375  LUMO = 0.830735453278816
  mo_energy =
[-3.27828434e+01 -1.93241325e+00 -8.47441587e-01 -8.47441587e-01
 -8.47441587e-01  8.30735453e-01  8.30735453e-01  8.30735453e-01
  1.22796322e+00  3.99431237e+00  3.99431237e+00  3.99431237e+00
  7.58102425e+00  1.48680799e+01  1.48680799e+01  1.48680799e+01
  3.53884636e+01  6.09991734e+01  6.09991734e+01  6.09991734e+01
  1.39856749e+02  5.04102982e+02  1.87166943e+03  8.00117724e+03
  4.77686212e+04]
E1 = -182.52195399260944  E_coul = 54.003396926790884
cycle= 1 E= -128.518557065819  delta_E= 1.42e-13  |g|= 3.65e-07  |ddm|= 2.96e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52195399260944  E_coul = 54.003396926790884
  HOMO = -0.847441398866875  LUMO = 0.830735499677017
  mo_energy =
[-3.27828428e+01 -1.93241306e+00 -8.47441399e-01 -8.47441399e-01
 -8.47441399e-01  8.30735500e-01  8.30735500e-01  8.30735500e-01
  1.22796329e+00  3.99431254e+00  3.99431254e+00  3.99431254e+00
  7.58102448e+00  1.48680802e+01  1.48680802e+01  1.48680802e+01
  3.53884641e+01  6.09991739e+01  6.09991739e+01  6.09991739e+01
  1.39856749e+02  5.04102983e+02  1.87166943e+03  8.00117724e+03
  4.77686212e+04]
E1 = -182.5219525782905  E_coul = 54.0033955124719
Extra cycle  E= -128.518557065819  delta_E= -2.84e-14  |g|= 1.93e-07  |ddm|= 1.27e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272434e+02 2.35721751e+02
 7.64808727e+01 1.01165577e+01 2.71475365e+01 3.88438134e-01
 2.99904050e+00 1.15000443e+00 2.48728940e+00 7.52515490e+00
 2.84241901e+01 2.72738421e-01 8.50122674e-01]
grad_E = [-2.25900736e-11  1.25985155e-09 -2.51762477e-08  2.91941465e-07
 -2.06208124e-06  8.60829646e-06  6.23805304e-06 -3.41790261e-05
  4.14267216e-05  8.96593960e-05 -4.37791600e-03  1.39352155e-03
 -1.85498722e-03  2.33827408e-03  4.85326136e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439805        1
[INPUT] 0    0    [1    /1   ]  833.272434582        1
[INPUT] 0    0    [1    /1   ]  235.721742068        1
[INPUT] 0    0    [1    /1   ]  76.4809138013        1
[INPUT] 0    0    [1    /1   ]  10.1131499364        1
[INPUT] 0    0    [1    /1   ]  27.1477909588        1
[INPUT] 0    0    [1    /1   ]  0.390564561186       1
[INPUT] 0    0    [1    /1   ]  2.9911183595         1
[INPUT] 0    0    [1    /1   ]  1.15551955624        1
[INPUT] 1    0    [1    /1   ]  2.50659861739        1
[INPUT] 1    0    [1    /1   ]  7.59950543444        1
[INPUT] 1    0    [1    /1   ]  28.605124521         1
[INPUT] 1    0    [1    /1   ]  0.279833923259       1
[INPUT] 1    0    [1    /1   ]  0.866368376838       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411603, 1.0]], [0, [3661.4543980517233, 1.0]], [0, [833.2724345823673, 1.0]], [0, [235.72174206845918, 1.0]], [0, [76.48091380126391, 1.0]], [0, [10.11314993643752, 1.0]], [0, [27.147790958814788, 1.0]], [0, [0.39056456118622257, 1.0]], [0, [2.991118359502723, 1.0]], [0, [1.1555195562355474, 1.0]], [1, [2.506598617387366, 1.0]], [1, [7.599505434435812, 1.0]], [1, [28.60512452103833, 1.0]], [1, [0.2798339232590276, 1.0]], [1, [0.8663683768375059, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439805]
bas 2, expnt(s) = [833.27243458]
bas 3, expnt(s) = [235.72174207]
bas 4, expnt(s) = [76.4809138]
bas 5, expnt(s) = [10.11314994]
bas 6, expnt(s) = [27.14779096]
bas 7, expnt(s) = [0.39056456]
bas 8, expnt(s) = [2.99111836]
bas 9, expnt(s) = [1.15551956]
bas 10, expnt(s) = [2.50659862]
bas 11, expnt(s) = [7.59950543]
bas 12, expnt(s) = [28.60512452]
bas 13, expnt(s) = [0.27983392]
bas 14, expnt(s) = [0.86636838]
CPU time:        81.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272435e+02 3.91836858e+02 2.35721742e+02 1.51989909e+02
 7.64809138e+01 6.53401046e+01 1.01131499e+01 1.43278115e+01
 2.71477910e+01 3.00480226e+01 3.90564561e-01 1.24820136e+00
 2.99111836e+00 5.74632550e+00 1.15551956e+00 2.81577533e+00
 2.50659862e+00 9.20111349e+00 7.59950543e+00 3.68100201e+01
 2.86051245e+01 1.92991951e+02 2.79833923e-01 5.93758506e-01
 8.66368377e-01 2.43844314e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999377036170813
cond(S) = 358.266096758015
E1 = -183.56210325192887  E_coul = 55.0766786481243
init E= -128.485424603805
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.771849747597357  LUMO = 0.874844970926877
  mo_energy =
[-3.25562893e+01 -1.85278287e+00 -7.71849748e-01 -7.71849748e-01
 -7.71849748e-01  8.74844971e-01  8.74844971e-01  8.74844971e-01
  1.26961754e+00  4.14271877e+00  4.14271877e+00  4.14271877e+00
  7.69134793e+00  1.52042276e+01  1.52042276e+01  1.52042276e+01
  3.55590119e+01  6.17963329e+01  6.17963329e+01  6.17963329e+01
  1.40066484e+02  5.04345288e+02  1.87194343e+03  8.00147918e+03
  4.77689431e+04]
E1 = -182.00554035452348  E_coul = 53.49059157690579
cycle= 1 E= -128.514948777618  delta_E= -0.0295  |g|= 0.213  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505117
diis-c [-0.25514324  1.        ]
  HOMO = -0.883678524923349  LUMO = 0.845565626158368
  mo_energy =
[-3.28934830e+01 -1.97052104e+00 -8.83678525e-01 -8.83678525e-01
 -8.83678525e-01  8.45565626e-01  8.45565626e-01  8.45565626e-01
  1.22107778e+00  4.03942063e+00  4.03942063e+00  4.03942063e+00
  7.55199356e+00  1.49998852e+01  1.49998852e+01  1.49998852e+01
  3.53016201e+01  6.14903068e+01  6.14903068e+01  6.14903068e+01
  1.39734995e+02  5.03968806e+02  1.87153088e+03  8.00103770e+03
  4.77684828e+04]
E1 = -182.79285104521705  E_coul = 54.27509652079321
cycle= 2 E= -128.517754524424  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.256727
diis-c [-6.11508535e-04  3.36207859e-01  6.63792141e-01]
  HOMO = -0.846855129603393  LUMO = 0.855215413657143
  mo_energy =
[-3.27817151e+01 -1.93174229e+00 -8.46855130e-01 -8.46855130e-01
 -8.46855130e-01  8.55215414e-01  8.55215414e-01  8.55215414e-01
  1.23675852e+00  4.07318971e+00  4.07318971e+00  4.07318971e+00
  7.59777564e+00  1.50677015e+01  1.50677015e+01  1.50677015e+01
  3.53874441e+01  6.15918771e+01  6.15918771e+01  6.15918771e+01
  1.39844693e+02  5.04089631e+02  1.87165715e+03  8.00116654e+03
  4.77686126e+04]
E1 = -182.527612107474  E_coul = 54.00887753174525
cycle= 3 E= -128.518734575729  delta_E= -0.00098  |g|= 0.000275  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.03 sec
diis-norm(errvec)=0.000356935
diis-c [-4.37305793e-08 -1.79670865e-03 -2.48883170e-03  1.00428554e+00]
  HOMO = -0.847000424969397  LUMO = 0.85520837690701
  mo_energy =
[-3.27819217e+01 -1.93186968e+00 -8.47000425e-01 -8.47000425e-01
 -8.47000425e-01  8.55208377e-01  8.55208377e-01  8.55208377e-01
  1.23671377e+00  4.07311211e+00  4.07311211e+00  4.07311211e+00
  7.59766509e+00  1.50675679e+01  1.50675679e+01  1.50675679e+01
  3.53872835e+01  6.15916877e+01  6.15916877e+01  6.15916877e+01
  1.39844492e+02  5.04089379e+02  1.87165684e+03  8.00116617e+03
  4.77686122e+04]
E1 = -182.52751245763838  E_coul = 54.00877787468875
cycle= 4 E= -128.51873458295  delta_E= -7.22e-09  |g|= 4.97e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.43845e-05
diis-c [-3.83627685e-10  3.07108495e-05  3.56911368e-04 -8.48921426e-02
  1.08450452e+00]
  HOMO = -0.847027008621668  LUMO = 0.855199201760341
  mo_energy =
[-3.27819643e+01 -1.93189777e+00 -8.47027009e-01 -8.47027009e-01
 -8.47027009e-01  8.55199202e-01  8.55199202e-01  8.55199202e-01
  1.23669699e+00  4.07308552e+00  4.07308552e+00  4.07308552e+00
  7.59763222e+00  1.50675301e+01  1.50675301e+01  1.50675301e+01
  3.53872420e+01  6.15916454e+01  6.15916454e+01  6.15916454e+01
  1.39844450e+02  5.04089339e+02  1.87165680e+03  8.00116613e+03
  4.77686122e+04]
E1 = -182.52758755221666  E_coul = 54.008852969081296
cycle= 5 E= -128.518734583135  delta_E= -1.86e-10  |g|= 1.32e-06  |ddm|= 1.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52758755221666  E_coul = 54.008852969081296
  HOMO = -0.847026729757707  LUMO = 0.85519921061082
  mo_energy =
[-3.27819630e+01 -1.93189758e+00 -8.47026730e-01 -8.47026730e-01
 -8.47026730e-01  8.55199211e-01  8.55199211e-01  8.55199211e-01
  1.23669690e+00  4.07308570e+00  4.07308570e+00  4.07308570e+00
  7.59763255e+00  1.50675308e+01  1.50675308e+01  1.50675308e+01
  3.53872430e+01  6.15916466e+01  6.15916466e+01  6.15916466e+01
  1.39844451e+02  5.04089340e+02  1.87165680e+03  8.00116613e+03
  4.77686122e+04]
E1 = -182.52758278629432  E_coul = 54.008848203158536
Extra cycle  E= -128.518734583136  delta_E= -3.98e-13  |g|= 6.43e-07  |ddm|= 8.34e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272435e+02 2.35721742e+02
 7.64809138e+01 1.01131499e+01 2.71477910e+01 3.90564561e-01
 2.99111836e+00 1.15551956e+00 2.50659862e+00 7.59950543e+00
 2.86051245e+01 2.79833923e-01 8.66368377e-01]
E = -128.51873458313577
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439805        1
[INPUT] 0    0    [1    /1   ]  833.272434582        1
[INPUT] 0    0    [1    /1   ]  235.721742068        1
[INPUT] 0    0    [1    /1   ]  76.4809138013        1
[INPUT] 0    0    [1    /1   ]  10.1131499364        1
[INPUT] 0    0    [1    /1   ]  27.1477909588        1
[INPUT] 0    0    [1    /1   ]  0.390564561186       1
[INPUT] 0    0    [1    /1   ]  2.9911183595         1
[INPUT] 0    0    [1    /1   ]  1.15551955624        1
[INPUT] 1    0    [1    /1   ]  2.50659861739        1
[INPUT] 1    0    [1    /1   ]  7.59950543444        1
[INPUT] 1    0    [1    /1   ]  28.605124521         1
[INPUT] 1    0    [1    /1   ]  0.279833923259       1
[INPUT] 1    0    [1    /1   ]  0.866368376838       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131411603, 1.0]], [0, [3661.4543980517233, 1.0]], [0, [833.2724345823673, 1.0]], [0, [235.72174206845918, 1.0]], [0, [76.48091380126391, 1.0]], [0, [10.11314993643752, 1.0]], [0, [27.147790958814788, 1.0]], [0, [0.39056456118622257, 1.0]], [0, [2.991118359502723, 1.0]], [0, [1.1555195562355474, 1.0]], [1, [2.506598617387366, 1.0]], [1, [7.599505434435812, 1.0]], [1, [28.60512452103833, 1.0]], [1, [0.2798339232590276, 1.0]], [1, [0.8663683768375059, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439805]
bas 2, expnt(s) = [833.27243458]
bas 3, expnt(s) = [235.72174207]
bas 4, expnt(s) = [76.4809138]
bas 5, expnt(s) = [10.11314994]
bas 6, expnt(s) = [27.14779096]
bas 7, expnt(s) = [0.39056456]
bas 8, expnt(s) = [2.99111836]
bas 9, expnt(s) = [1.15551956]
bas 10, expnt(s) = [2.50659862]
bas 11, expnt(s) = [7.59950543]
bas 12, expnt(s) = [28.60512452]
bas 13, expnt(s) = [0.27983392]
bas 14, expnt(s) = [0.86636838]
CPU time:        82.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272435e+02 3.91836858e+02 2.35721742e+02 1.51989909e+02
 7.64809138e+01 6.53401046e+01 1.01131499e+01 1.43278115e+01
 2.71477910e+01 3.00480226e+01 3.90564561e-01 1.24820136e+00
 2.99111836e+00 5.74632550e+00 1.15551956e+00 2.81577533e+00
 2.50659862e+00 9.20111349e+00 7.59950543e+00 3.68100201e+01
 2.86051245e+01 1.92991951e+02 2.79833923e-01 5.93758506e-01
 8.66368377e-01 2.43844314e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999377036170813
cond(S) = 358.266096758015
E1 = -183.56210325192887  E_coul = 55.0766786481243
init E= -128.485424603805
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771849747597357  LUMO = 0.874844970926877
  mo_energy =
[-3.25562893e+01 -1.85278287e+00 -7.71849748e-01 -7.71849748e-01
 -7.71849748e-01  8.74844971e-01  8.74844971e-01  8.74844971e-01
  1.26961754e+00  4.14271877e+00  4.14271877e+00  4.14271877e+00
  7.69134793e+00  1.52042276e+01  1.52042276e+01  1.52042276e+01
  3.55590119e+01  6.17963329e+01  6.17963329e+01  6.17963329e+01
  1.40066484e+02  5.04345288e+02  1.87194343e+03  8.00147918e+03
  4.77689431e+04]
E1 = -182.00554035452348  E_coul = 53.49059157690579
cycle= 1 E= -128.514948777618  delta_E= -0.0295  |g|= 0.213  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505117
diis-c [-0.25514324  1.        ]
  HOMO = -0.883678524923349  LUMO = 0.845565626158368
  mo_energy =
[-3.28934830e+01 -1.97052104e+00 -8.83678525e-01 -8.83678525e-01
 -8.83678525e-01  8.45565626e-01  8.45565626e-01  8.45565626e-01
  1.22107778e+00  4.03942063e+00  4.03942063e+00  4.03942063e+00
  7.55199356e+00  1.49998852e+01  1.49998852e+01  1.49998852e+01
  3.53016201e+01  6.14903068e+01  6.14903068e+01  6.14903068e+01
  1.39734995e+02  5.03968806e+02  1.87153088e+03  8.00103770e+03
  4.77684828e+04]
E1 = -182.79285104521705  E_coul = 54.27509652079321
cycle= 2 E= -128.517754524424  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.256727
diis-c [-6.11508535e-04  3.36207859e-01  6.63792141e-01]
  HOMO = -0.846855129603393  LUMO = 0.855215413657143
  mo_energy =
[-3.27817151e+01 -1.93174229e+00 -8.46855130e-01 -8.46855130e-01
 -8.46855130e-01  8.55215414e-01  8.55215414e-01  8.55215414e-01
  1.23675852e+00  4.07318971e+00  4.07318971e+00  4.07318971e+00
  7.59777564e+00  1.50677015e+01  1.50677015e+01  1.50677015e+01
  3.53874441e+01  6.15918771e+01  6.15918771e+01  6.15918771e+01
  1.39844693e+02  5.04089631e+02  1.87165715e+03  8.00116654e+03
  4.77686126e+04]
E1 = -182.527612107474  E_coul = 54.00887753174525
cycle= 3 E= -128.518734575729  delta_E= -0.00098  |g|= 0.000275  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000356935
diis-c [-4.37305793e-08 -1.79670865e-03 -2.48883170e-03  1.00428554e+00]
  HOMO = -0.847000424969397  LUMO = 0.85520837690701
  mo_energy =
[-3.27819217e+01 -1.93186968e+00 -8.47000425e-01 -8.47000425e-01
 -8.47000425e-01  8.55208377e-01  8.55208377e-01  8.55208377e-01
  1.23671377e+00  4.07311211e+00  4.07311211e+00  4.07311211e+00
  7.59766509e+00  1.50675679e+01  1.50675679e+01  1.50675679e+01
  3.53872835e+01  6.15916877e+01  6.15916877e+01  6.15916877e+01
  1.39844492e+02  5.04089379e+02  1.87165684e+03  8.00116617e+03
  4.77686122e+04]
E1 = -182.52751245763838  E_coul = 54.00877787468875
cycle= 4 E= -128.51873458295  delta_E= -7.22e-09  |g|= 4.97e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.43845e-05
diis-c [-3.83627685e-10  3.07108495e-05  3.56911368e-04 -8.48921426e-02
  1.08450452e+00]
  HOMO = -0.847027008621668  LUMO = 0.855199201760341
  mo_energy =
[-3.27819643e+01 -1.93189777e+00 -8.47027009e-01 -8.47027009e-01
 -8.47027009e-01  8.55199202e-01  8.55199202e-01  8.55199202e-01
  1.23669699e+00  4.07308552e+00  4.07308552e+00  4.07308552e+00
  7.59763222e+00  1.50675301e+01  1.50675301e+01  1.50675301e+01
  3.53872420e+01  6.15916454e+01  6.15916454e+01  6.15916454e+01
  1.39844450e+02  5.04089339e+02  1.87165680e+03  8.00116613e+03
  4.77686122e+04]
E1 = -182.52758755221666  E_coul = 54.008852969081296
cycle= 5 E= -128.518734583135  delta_E= -1.86e-10  |g|= 1.32e-06  |ddm|= 1.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52758755221666  E_coul = 54.008852969081296
  HOMO = -0.847026729757707  LUMO = 0.85519921061082
  mo_energy =
[-3.27819630e+01 -1.93189758e+00 -8.47026730e-01 -8.47026730e-01
 -8.47026730e-01  8.55199211e-01  8.55199211e-01  8.55199211e-01
  1.23669690e+00  4.07308570e+00  4.07308570e+00  4.07308570e+00
  7.59763255e+00  1.50675308e+01  1.50675308e+01  1.50675308e+01
  3.53872430e+01  6.15916466e+01  6.15916466e+01  6.15916466e+01
  1.39844451e+02  5.04089340e+02  1.87165680e+03  8.00116613e+03
  4.77686122e+04]
E1 = -182.52758278629432  E_coul = 54.008848203158536
Extra cycle  E= -128.518734583136  delta_E= -3.98e-13  |g|= 6.43e-07  |ddm|= 8.34e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 358.266096758015
E1 = -182.52758278629432  E_coul = 54.008848203158536
init E= -128.518734583136
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.84702707677941  LUMO = 0.855199109887511
  mo_energy =
[-3.27819640e+01 -1.93189797e+00 -8.47027077e-01 -8.47027077e-01
 -8.47027077e-01  8.55199110e-01  8.55199110e-01  8.55199110e-01
  1.23669672e+00  4.07308537e+00  4.07308537e+00  4.07308537e+00
  7.59763211e+00  1.50675301e+01  1.50675301e+01  1.50675301e+01
  3.53872422e+01  6.15916457e+01  6.15916457e+01  6.15916457e+01
  1.39844450e+02  5.04089339e+02  1.87165680e+03  8.00116613e+03
  4.77686122e+04]
E1 = -182.5275848969519  E_coul = 54.008850313816154
cycle= 1 E= -128.518734583136  delta_E=    0  |g|= 2.9e-07  |ddm|= 2.21e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.5275848969519  E_coul = 54.008850313816154
  HOMO = -0.847026928369411  LUMO = 0.855199147524772
  mo_energy =
[-3.27819635e+01 -1.93189783e+00 -8.47026928e-01 -8.47026928e-01
 -8.47026928e-01  8.55199148e-01  8.55199148e-01  8.55199148e-01
  1.23669678e+00  4.07308551e+00  4.07308551e+00  4.07308551e+00
  7.59763229e+00  1.50675304e+01  1.50675304e+01  1.50675304e+01
  3.53872426e+01  6.15916461e+01  6.15916461e+01  6.15916461e+01
  1.39844450e+02  5.04089339e+02  1.87165680e+03  8.00116613e+03
  4.77686122e+04]
E1 = -182.52758377657577  E_coul = 54.00884919344011
Extra cycle  E= -128.518734583136  delta_E= 1.14e-13  |g|= 1.52e-07  |ddm|= 1.02e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272435e+02 2.35721742e+02
 7.64809138e+01 1.01131499e+01 2.71477910e+01 3.90564561e-01
 2.99111836e+00 1.15551956e+00 2.50659862e+00 7.59950543e+00
 2.86051245e+01 2.79833923e-01 8.66368377e-01]
grad_E = [-5.04975092e-11  2.72768423e-09 -5.47068299e-08  6.47955925e-07
 -4.88730504e-06 -2.96367006e-05  2.06389983e-05  1.80217140e-05
 -1.33258465e-05  3.37994138e-04 -7.35863055e-03  2.24918475e-03
 -1.90595519e-03  5.39364268e-03  8.88495998e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439795        1
[INPUT] 0    0    [1    /1   ]  833.272436539        1
[INPUT] 0    0    [1    /1   ]  235.721721598        1
[INPUT] 0    0    [1    /1   ]  76.4810058215        1
[INPUT] 0    0    [1    /1   ]  10.1044937422        1
[INPUT] 0    0    [1    /1   ]  27.1484797161        1
[INPUT] 0    0    [1    /1   ]  0.396713569086       1
[INPUT] 0    0    [1    /1   ]  2.97108238749        1
[INPUT] 0    0    [1    /1   ]  1.17140378163        1
[INPUT] 1    0    [1    /1   ]  2.55342696093        1
[INPUT] 1    0    [1    /1   ]  7.76045652248        1
[INPUT] 1    0    [1    /1   ]  29.0563506279        1
[INPUT] 1    0    [1    /1   ]  0.291237965745       1
[INPUT] 1    0    [1    /1   ]  0.895958980858       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141312, 1.0]], [0, [3661.4543979519767, 1.0]], [0, [833.272436539121, 1.0]], [0, [235.72172159832036, 1.0]], [0, [76.48100582146998, 1.0]], [0, [10.104493742161408, 1.0]], [0, [27.148479716079233, 1.0]], [0, [0.3967135690855225, 1.0]], [0, [2.971082387486662, 1.0]], [0, [1.171403781625321, 1.0]], [1, [2.5534269609299325, 1.0]], [1, [7.760456522483288, 1.0]], [1, [29.056350627866877, 1.0]], [1, [0.2912379657454277, 1.0]], [1, [0.8959589808582904, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439795]
bas 2, expnt(s) = [833.27243654]
bas 3, expnt(s) = [235.7217216]
bas 4, expnt(s) = [76.48100582]
bas 5, expnt(s) = [10.10449374]
bas 6, expnt(s) = [27.14847972]
bas 7, expnt(s) = [0.39671357]
bas 8, expnt(s) = [2.97108239]
bas 9, expnt(s) = [1.17140378]
bas 10, expnt(s) = [2.55342696]
bas 11, expnt(s) = [7.76045652]
bas 12, expnt(s) = [29.05635063]
bas 13, expnt(s) = [0.29123797]
bas 14, expnt(s) = [0.89595898]
CPU time:        85.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272437e+02 3.91836859e+02 2.35721722e+02 1.51989899e+02
 7.64810058e+01 6.53401636e+01 1.01044937e+01 1.43186128e+01
 2.71484797e+01 3.00485943e+01 3.96713569e-01 1.26291120e+00
 2.97108239e+00 5.71743249e+00 1.17140378e+00 2.84475579e+00
 2.55342696e+00 9.41648225e+00 7.76045652e+00 3.77870928e+01
 2.90563506e+01 1.96804818e+02 2.91237966e-01 6.24157766e-01
 8.95958981e-01 2.54298941e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999225733578363
cond(S) = 362.2645307881451
E1 = -183.56272731939052  E_coul = 55.076854087532745
init E= -128.485873231858
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771899645856378  LUMO = 0.916352659233295
  mo_energy =
[-3.25562176e+01 -1.85276782e+00 -7.71899646e-01 -7.71899646e-01
 -7.71899646e-01  9.16352659e-01  9.16352659e-01  9.16352659e-01
  1.29451232e+00  4.28754840e+00  4.28754840e+00  4.28754840e+00
  7.74088433e+00  1.56163587e+01  1.56163587e+01  1.56163587e+01
  3.55654386e+01  6.31484095e+01  6.31484095e+01  6.31484095e+01
  1.40043865e+02  5.04318036e+02  1.87191771e+03  8.00145627e+03
  4.77689241e+04]
E1 = -182.02187790367415  E_coul = 53.50645045421828
cycle= 1 E= -128.515427449456  delta_E= -0.0296  |g|= 0.211  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501299
diis-c [-0.2513004  1.       ]
  HOMO = -0.88250794935305  LUMO = 0.885917237554186
  mo_energy =
[-3.28906376e+01 -1.96913063e+00 -8.82507949e-01 -8.82507949e-01
 -8.82507949e-01  8.85917238e-01  8.85917238e-01  8.85917238e-01
  1.24603368e+00  4.18352484e+00  4.18352484e+00  4.18352484e+00
  7.60317078e+00  1.54122728e+01  1.54122728e+01  1.54122728e+01
  3.53105408e+01  6.28440829e+01  6.28440829e+01  6.28440829e+01
  1.39715129e+02  5.03944521e+02  1.87150821e+03  8.00101787e+03
  4.77684669e+04]
E1 = -182.79928682752896  E_coul = 54.28109946784715
cycle= 2 E= -128.518187359682  delta_E= -0.00276  |g|= 0.106  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253769
diis-c [-6.12461958e-04  3.35294360e-01  6.64705640e-01]
  HOMO = -0.846118079405188  LUMO = 0.89594939516993
  mo_energy =
[-3.27800349e+01 -1.93081713e+00 -8.46118079e-01 -8.46118079e-01
 -8.46118079e-01  8.95949395e-01  8.95949395e-01  8.95949395e-01
  1.26171457e+00  4.21752613e+00  4.21752613e+00  4.21752613e+00
  7.64839230e+00  1.54799004e+01  1.54799004e+01  1.54799004e+01
  3.53953832e+01  6.29448580e+01  6.29448580e+01  6.29448580e+01
  1.39823677e+02  5.04064105e+02  1.87163320e+03  8.00114539e+03
  4.77685954e+04]
E1 = -182.53794824289372  E_coul = 54.01880617492786
cycle= 3 E= -128.519142067966  delta_E= -0.000955  |g|= 0.000283  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000392145
diis-c [-3.91687994e-08 -1.80946353e-03 -2.30296848e-03  1.00411243e+00]
  HOMO = -0.846267256360919  LUMO = 0.895939692252789
  mo_energy =
[-3.27802579e+01 -1.93094526e+00 -8.46267256e-01 -8.46267256e-01
 -8.46267256e-01  8.95939692e-01  8.95939692e-01  8.95939692e-01
  1.26166927e+00  4.21744253e+00  4.21744253e+00  4.21744253e+00
  7.64827756e+00  1.54797565e+01  1.54797565e+01  1.54797565e+01
  3.53952120e+01  6.29446535e+01  6.29446535e+01  6.29446535e+01
  1.39823459e+02  5.04063831e+02  1.87163285e+03  8.00114499e+03
  4.77685949e+04]
E1 = -182.53790966719737  E_coul = 54.018767592253646
cycle= 4 E= -128.519142074944  delta_E= -6.98e-09  |g|= 4.84e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.49525e-05
diis-c [-3.37627574e-10  3.09982481e-05  3.52808265e-04 -7.96442728e-02
  1.07926047e+00]
  HOMO = -0.846293065063359  LUMO = 0.895930502367958
  mo_energy =
[-3.27802997e+01 -1.93097161e+00 -8.46293065e-01 -8.46293065e-01
 -8.46293065e-01  8.95930502e-01  8.95930502e-01  8.95930502e-01
  1.26165350e+00  4.21741660e+00  4.21741660e+00  4.21741660e+00
  7.64824615e+00  1.54797197e+01  1.54797197e+01  1.54797197e+01
  3.53951717e+01  6.29446122e+01  6.29446122e+01  6.29446122e+01
  1.39823418e+02  5.04063791e+02  1.87163281e+03  8.00114495e+03
  4.77685949e+04]
E1 = -182.53798535349546  E_coul = 54.01884327837728
cycle= 5 E= -128.519142075118  delta_E= -1.74e-10  |g|= 1.05e-06  |ddm|= 1.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53798535349546  E_coul = 54.01884327837728
  HOMO = -0.846292985453924  LUMO = 0.895930468510069
  mo_energy =
[-3.27802989e+01 -1.93097150e+00 -8.46292985e-01 -8.46292985e-01
 -8.46292985e-01  8.95930469e-01  8.95930469e-01  8.95930469e-01
  1.26165341e+00  4.21741662e+00  4.21741662e+00  4.21741662e+00
  7.64824630e+00  1.54797201e+01  1.54797201e+01  1.54797201e+01
  3.53951723e+01  6.29446129e+01  6.29446129e+01  6.29446129e+01
  1.39823419e+02  5.04063792e+02  1.87163281e+03  8.00114495e+03
  4.77685949e+04]
E1 = -182.53798199755596  E_coul = 54.01883992243759
Extra cycle  E= -128.519142075118  delta_E= -1.99e-13  |g|= 4.37e-07  |ddm|= 7.1e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272437e+02 2.35721722e+02
 7.64810058e+01 1.01044937e+01 2.71484797e+01 3.96713569e-01
 2.97108239e+00 1.17140378e+00 2.55342696e+00 7.76045652e+00
 2.90563506e+01 2.91237966e-01 8.95958981e-01]
E = -128.51914207511837
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439795        1
[INPUT] 0    0    [1    /1   ]  833.272436539        1
[INPUT] 0    0    [1    /1   ]  235.721721598        1
[INPUT] 0    0    [1    /1   ]  76.4810058215        1
[INPUT] 0    0    [1    /1   ]  10.1044937422        1
[INPUT] 0    0    [1    /1   ]  27.1484797161        1
[INPUT] 0    0    [1    /1   ]  0.396713569086       1
[INPUT] 0    0    [1    /1   ]  2.97108238749        1
[INPUT] 0    0    [1    /1   ]  1.17140378163        1
[INPUT] 1    0    [1    /1   ]  2.55342696093        1
[INPUT] 1    0    [1    /1   ]  7.76045652248        1
[INPUT] 1    0    [1    /1   ]  29.0563506279        1
[INPUT] 1    0    [1    /1   ]  0.291237965745       1
[INPUT] 1    0    [1    /1   ]  0.895958980858       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141312, 1.0]], [0, [3661.4543979519767, 1.0]], [0, [833.272436539121, 1.0]], [0, [235.72172159832036, 1.0]], [0, [76.48100582146998, 1.0]], [0, [10.104493742161408, 1.0]], [0, [27.148479716079233, 1.0]], [0, [0.3967135690855225, 1.0]], [0, [2.971082387486662, 1.0]], [0, [1.171403781625321, 1.0]], [1, [2.5534269609299325, 1.0]], [1, [7.760456522483288, 1.0]], [1, [29.056350627866877, 1.0]], [1, [0.2912379657454277, 1.0]], [1, [0.8959589808582904, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.45439795]
bas 2, expnt(s) = [833.27243654]
bas 3, expnt(s) = [235.7217216]
bas 4, expnt(s) = [76.48100582]
bas 5, expnt(s) = [10.10449374]
bas 6, expnt(s) = [27.14847972]
bas 7, expnt(s) = [0.39671357]
bas 8, expnt(s) = [2.97108239]
bas 9, expnt(s) = [1.17140378]
bas 10, expnt(s) = [2.55342696]
bas 11, expnt(s) = [7.76045652]
bas 12, expnt(s) = [29.05635063]
bas 13, expnt(s) = [0.29123797]
bas 14, expnt(s) = [0.89595898]
CPU time:        85.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272437e+02 3.91836859e+02 2.35721722e+02 1.51989899e+02
 7.64810058e+01 6.53401636e+01 1.01044937e+01 1.43186128e+01
 2.71484797e+01 3.00485943e+01 3.96713569e-01 1.26291120e+00
 2.97108239e+00 5.71743249e+00 1.17140378e+00 2.84475579e+00
 2.55342696e+00 9.41648225e+00 7.76045652e+00 3.77870928e+01
 2.90563506e+01 1.96804818e+02 2.91237966e-01 6.24157766e-01
 8.95958981e-01 2.54298941e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999225733578363
cond(S) = 362.2645307881451
E1 = -183.56272731939052  E_coul = 55.076854087532745
init E= -128.485873231858
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771899645856378  LUMO = 0.916352659233295
  mo_energy =
[-3.25562176e+01 -1.85276782e+00 -7.71899646e-01 -7.71899646e-01
 -7.71899646e-01  9.16352659e-01  9.16352659e-01  9.16352659e-01
  1.29451232e+00  4.28754840e+00  4.28754840e+00  4.28754840e+00
  7.74088433e+00  1.56163587e+01  1.56163587e+01  1.56163587e+01
  3.55654386e+01  6.31484095e+01  6.31484095e+01  6.31484095e+01
  1.40043865e+02  5.04318036e+02  1.87191771e+03  8.00145627e+03
  4.77689241e+04]
E1 = -182.02187790367415  E_coul = 53.50645045421828
cycle= 1 E= -128.515427449456  delta_E= -0.0296  |g|= 0.211  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501299
diis-c [-0.2513004  1.       ]
  HOMO = -0.88250794935305  LUMO = 0.885917237554186
  mo_energy =
[-3.28906376e+01 -1.96913063e+00 -8.82507949e-01 -8.82507949e-01
 -8.82507949e-01  8.85917238e-01  8.85917238e-01  8.85917238e-01
  1.24603368e+00  4.18352484e+00  4.18352484e+00  4.18352484e+00
  7.60317078e+00  1.54122728e+01  1.54122728e+01  1.54122728e+01
  3.53105408e+01  6.28440829e+01  6.28440829e+01  6.28440829e+01
  1.39715129e+02  5.03944521e+02  1.87150821e+03  8.00101787e+03
  4.77684669e+04]
E1 = -182.79928682752896  E_coul = 54.28109946784715
cycle= 2 E= -128.518187359682  delta_E= -0.00276  |g|= 0.106  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253769
diis-c [-6.12461958e-04  3.35294360e-01  6.64705640e-01]
  HOMO = -0.846118079405188  LUMO = 0.89594939516993
  mo_energy =
[-3.27800349e+01 -1.93081713e+00 -8.46118079e-01 -8.46118079e-01
 -8.46118079e-01  8.95949395e-01  8.95949395e-01  8.95949395e-01
  1.26171457e+00  4.21752613e+00  4.21752613e+00  4.21752613e+00
  7.64839230e+00  1.54799004e+01  1.54799004e+01  1.54799004e+01
  3.53953832e+01  6.29448580e+01  6.29448580e+01  6.29448580e+01
  1.39823677e+02  5.04064105e+02  1.87163320e+03  8.00114539e+03
  4.77685954e+04]
E1 = -182.53794824289372  E_coul = 54.01880617492786
cycle= 3 E= -128.519142067966  delta_E= -0.000955  |g|= 0.000283  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000392145
diis-c [-3.91687994e-08 -1.80946353e-03 -2.30296848e-03  1.00411243e+00]
  HOMO = -0.846267256360919  LUMO = 0.895939692252789
  mo_energy =
[-3.27802579e+01 -1.93094526e+00 -8.46267256e-01 -8.46267256e-01
 -8.46267256e-01  8.95939692e-01  8.95939692e-01  8.95939692e-01
  1.26166927e+00  4.21744253e+00  4.21744253e+00  4.21744253e+00
  7.64827756e+00  1.54797565e+01  1.54797565e+01  1.54797565e+01
  3.53952120e+01  6.29446535e+01  6.29446535e+01  6.29446535e+01
  1.39823459e+02  5.04063831e+02  1.87163285e+03  8.00114499e+03
  4.77685949e+04]
E1 = -182.53790966719737  E_coul = 54.018767592253646
cycle= 4 E= -128.519142074944  delta_E= -6.98e-09  |g|= 4.84e-05  |ddm|= 0.000176
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.49525e-05
diis-c [-3.37627574e-10  3.09982481e-05  3.52808265e-04 -7.96442728e-02
  1.07926047e+00]
  HOMO = -0.846293065063359  LUMO = 0.895930502367958
  mo_energy =
[-3.27802997e+01 -1.93097161e+00 -8.46293065e-01 -8.46293065e-01
 -8.46293065e-01  8.95930502e-01  8.95930502e-01  8.95930502e-01
  1.26165350e+00  4.21741660e+00  4.21741660e+00  4.21741660e+00
  7.64824615e+00  1.54797197e+01  1.54797197e+01  1.54797197e+01
  3.53951717e+01  6.29446122e+01  6.29446122e+01  6.29446122e+01
  1.39823418e+02  5.04063791e+02  1.87163281e+03  8.00114495e+03
  4.77685949e+04]
E1 = -182.53798535349546  E_coul = 54.01884327837728
cycle= 5 E= -128.519142075118  delta_E= -1.74e-10  |g|= 1.05e-06  |ddm|= 1.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53798535349546  E_coul = 54.01884327837728
  HOMO = -0.846292985453924  LUMO = 0.895930468510069
  mo_energy =
[-3.27802989e+01 -1.93097150e+00 -8.46292985e-01 -8.46292985e-01
 -8.46292985e-01  8.95930469e-01  8.95930469e-01  8.95930469e-01
  1.26165341e+00  4.21741662e+00  4.21741662e+00  4.21741662e+00
  7.64824630e+00  1.54797201e+01  1.54797201e+01  1.54797201e+01
  3.53951723e+01  6.29446129e+01  6.29446129e+01  6.29446129e+01
  1.39823419e+02  5.04063792e+02  1.87163281e+03  8.00114495e+03
  4.77685949e+04]
E1 = -182.53798199755596  E_coul = 54.01883992243759
Extra cycle  E= -128.519142075118  delta_E= -1.99e-13  |g|= 4.37e-07  |ddm|= 7.1e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 362.2645307881451
E1 = -182.53798199755596  E_coul = 54.01883992243759
init E= -128.519142075118
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.846293237596553  LUMO = 0.895930391297214
  mo_energy =
[-3.27802996e+01 -1.93097176e+00 -8.46293238e-01 -8.46293238e-01
 -8.46293238e-01  8.95930391e-01  8.95930391e-01  8.95930391e-01
  1.26165328e+00  4.21741638e+00  4.21741638e+00  4.21741638e+00
  7.64824599e+00  1.54797197e+01  1.54797197e+01  1.54797197e+01
  3.53951718e+01  6.29446123e+01  6.29446123e+01  6.29446123e+01
  1.39823418e+02  5.04063791e+02  1.87163281e+03  8.00114495e+03
  4.77685949e+04]
E1 = -182.53798344126315  E_coul = 54.018841366145
cycle= 1 E= -128.519142075118  delta_E= 1.99e-13  |g|= 2e-07  |ddm|= 1.3e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53798344126315  E_coul = 54.018841366145
  HOMO = -0.846293137312547  LUMO = 0.89593041810677
  mo_energy =
[-3.27802993e+01 -1.93097166e+00 -8.46293137e-01 -8.46293137e-01
 -8.46293137e-01  8.95930418e-01  8.95930418e-01  8.95930418e-01
  1.26165332e+00  4.21741647e+00  4.21741647e+00  4.21741647e+00
  7.64824611e+00  1.54797198e+01  1.54797198e+01  1.54797198e+01
  3.53951720e+01  6.29446125e+01  6.29446125e+01  6.29446125e+01
  1.39823418e+02  5.04063791e+02  1.87163281e+03  8.00114495e+03
  4.77685949e+04]
E1 = -182.5379826767545  E_coul = 54.018840601635986
Extra cycle  E= -128.519142075119  delta_E= -3.41e-13  |g|= 1.04e-07  |ddm|= 7.22e-08
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272437e+02 2.35721722e+02
 7.64810058e+01 1.01044937e+01 2.71484797e+01 3.96713569e-01
 2.97108239e+00 1.17140378e+00 2.55342696e+00 7.76045652e+00
 2.90563506e+01 2.91237966e-01 8.95958981e-01]
grad_E = [-1.23765091e-10  6.58397608e-09 -1.32203876e-07  1.58348984e-06
 -1.22966552e-05 -1.30238572e-04  5.86216484e-05  3.44402852e-04
 -1.48102875e-04  9.20814315e-04 -1.09977267e-02  3.31434739e-03
 -1.93273781e-03  1.01887118e-02  1.38818623e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439774        1
[INPUT] 0    0    [1    /1   ]  833.272440773        1
[INPUT] 0    0    [1    /1   ]  235.721677393        1
[INPUT] 0    0    [1    /1   ]  76.4812017197        1
[INPUT] 0    0    [1    /1   ]  10.0853489381        1
[INPUT] 0    0    [1    /1   ]  27.150027121         1
[INPUT] 0    0    [1    /1   ]  0.410922107501       1
[INPUT] 0    0    [1    /1   ]  2.92674491105        1
[INPUT] 0    0    [1    /1   ]  1.20909207312        1
[INPUT] 1    0    [1    /1   ]  2.64389631919        1
[INPUT] 1    0    [1    /1   ]  8.06965466341        1
[INPUT] 1    0    [1    /1   ]  30.0492880281        1
[INPUT] 1    0    [1    /1   ]  0.306129570068       1
[INPUT] 1    0    [1    /1   ]  0.941251374976       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131416395, 1.0]], [0, [3661.4543977360318, 1.0]], [0, [833.2724407734763, 1.0]], [0, [235.72167739253638, 1.0]], [0, [76.48120171973898, 1.0]], [0, [10.08534893812092, 1.0]], [0, [27.1500271210271, 1.0]], [0, [0.4109221075012464, 1.0]], [0, [2.926744911048122, 1.0]], [0, [1.2090920731162669, 1.0]], [1, [2.643896319193749, 1.0]], [1, [8.069654663414592, 1.0]], [1, [30.049288028113097, 1.0]], [1, [0.30612957006795277, 1.0]], [1, [0.9412513749757697, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413142]
bas 1, expnt(s) = [3661.45439774]
bas 2, expnt(s) = [833.27244077]
bas 3, expnt(s) = [235.72167739]
bas 4, expnt(s) = [76.48120172]
bas 5, expnt(s) = [10.08534894]
bas 6, expnt(s) = [27.15002712]
bas 7, expnt(s) = [0.41092211]
bas 8, expnt(s) = [2.92674491]
bas 9, expnt(s) = [1.20909207]
bas 10, expnt(s) = [2.64389632]
bas 11, expnt(s) = [8.06965466]
bas 12, expnt(s) = [30.04928803]
bas 13, expnt(s) = [0.30612957]
bas 14, expnt(s) = [0.94125137]
CPU time:        88.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272441e+02 3.91836860e+02 2.35721677e+02 1.51989878e+02
 7.64812017e+01 6.53402891e+01 1.00853489e+01 1.42982610e+01
 2.71500271e+01 3.00498788e+01 4.10922108e-01 1.29668550e+00
 2.92674491e+00 5.65332142e+00 1.20909207e+00 2.91312791e+00
 2.64389632e+00 9.83535223e+00 8.06965466e+00 3.96783021e+01
 3.00492880e+01 2.05247145e+02 3.06129570e-01 6.64302665e-01
 9.41251375e-01 2.70468332e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998951868794334
cond(S) = 373.37376874544356
E1 = -183.56381628387064  E_coul = 55.0771576675666
init E= -128.486658616304
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.7720200076541  LUMO = 0.973531751695386
  mo_energy =
[-3.25560898e+01 -1.85271030e+00 -7.72020008e-01 -7.72020008e-01
 -7.72020008e-01  9.73531752e-01  9.73531752e-01  9.73531752e-01
  1.35243647e+00  4.51102377e+00  4.51102377e+00  4.51102377e+00
  7.85847850e+00  1.63464256e+01  1.63464256e+01  1.63464256e+01
  3.55926158e+01  6.58712930e+01  6.58712930e+01  6.58712930e+01
  1.40006483e+02  5.04269326e+02  1.87187127e+03  8.00141482e+03
  4.77688897e+04]
E1 = -182.04769500745482  E_coul = 53.5313243278952
cycle= 1 E= -128.51637067956  delta_E= -0.0297  |g|= 0.208  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.493888
diis-c [-0.24392487  1.        ]
  HOMO = -0.880730248475739  LUMO = 0.941576856451712
  mo_energy =
[-3.28860730e+01 -1.96697314e+00 -8.80730248e-01 -8.80730248e-01
 -8.80730248e-01  9.41576856e-01  9.41576856e-01  9.41576856e-01
  1.30355471e+00  4.40559826e+00  4.40559826e+00  4.40559826e+00
  7.72329408e+00  1.61421244e+01  1.61421244e+01  1.61421244e+01
  3.53417727e+01  6.55692060e+01  6.55692060e+01  6.55692060e+01
  1.39682154e+02  5.03900511e+02  1.87146657e+03  8.00098125e+03
  4.77684373e+04]
E1 = -182.80969741267376  E_coul = 54.29064070066263
cycle= 2 E= -128.519056712011  delta_E= -0.00269  |g|= 0.104  |ddm|= 0.0693
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.248519
diis-c [-6.12442487e-04  3.33918939e-01  6.66081061e-01]
  HOMO = -0.845018821938061  LUMO = 0.952113334229163
  mo_energy =
[-3.27773064e+01 -1.92938317e+00 -8.45018822e-01 -8.45018822e-01
 -8.45018822e-01  9.52113334e-01  9.52113334e-01  9.52113334e-01
  1.31938767e+00  4.44004023e+00  4.44004023e+00  4.44004023e+00
  7.76764318e+00  1.62096586e+01  1.62096586e+01  1.62096586e+01
  3.54250418e+01  6.56688869e+01  6.56688869e+01  6.56688869e+01
  1.39788885e+02  5.04018140e+02  1.87158952e+03  8.00110671e+03
  4.77685637e+04]
E1 = -182.5542905108222  E_coul = 54.03431755385734
cycle= 3 E= -128.519972956965  delta_E= -0.000916  |g|= 0.000304  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000468876
diis-c [-3.54449500e-08 -1.84930447e-03 -1.98851484e-03  1.00383782e+00]
  HOMO = -0.845178144756092  LUMO = 0.95209784136543
  mo_energy =
[-3.27775624e+01 -1.92951924e+00 -8.45178145e-01 -8.45178145e-01
 -8.45178145e-01  9.52097841e-01  9.52097841e-01  9.52097841e-01
  1.31933719e+00  4.43994238e+00  4.43994238e+00  4.43994238e+00
  7.76751567e+00  1.62094912e+01  1.62094912e+01  1.62094912e+01
  3.54248464e+01  6.56686507e+01  6.56686507e+01  6.56686507e+01
  1.39788634e+02  5.04017826e+02  1.87158914e+03  8.00110626e+03
  4.77685632e+04]
E1 = -182.55435947915834  E_coul = 54.03438651508704
cycle= 4 E= -128.519972964071  delta_E= -7.11e-09  |g|= 4.69e-05  |ddm|= 0.000173
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.46241e-05
diis-c [-3.00639880e-10  4.15622889e-05  3.50285073e-04 -7.90348973e-02
  1.07864305e+00]
  HOMO = -0.845203034697435  LUMO = 0.952088565295766
  mo_energy =
[-3.27776032e+01 -1.92954383e+00 -8.45203035e-01 -8.45203035e-01
 -8.45203035e-01  9.52088565e-01  9.52088565e-01  9.52088565e-01
  1.31932228e+00  4.43991703e+00  4.43991703e+00  4.43991703e+00
  7.76748581e+00  1.62094554e+01  1.62094554e+01  1.62094554e+01
  3.54248075e+01  6.56686104e+01  6.56686104e+01  6.56686104e+01
  1.39788594e+02  5.04017786e+02  1.87158910e+03  8.00110622e+03
  4.77685632e+04]
E1 = -182.55443541873217  E_coul = 54.03446245449699
cycle= 5 E= -128.519972964235  delta_E= -1.64e-10  |g|= 1e-06  |ddm|= 1.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55443541873217  E_coul = 54.03446245449699
  HOMO = -0.845202992940996  LUMO = 0.952088540017226
  mo_energy =
[-3.27776026e+01 -1.92954365e+00 -8.45202993e-01 -8.45202993e-01
 -8.45202993e-01  9.52088540e-01  9.52088540e-01  9.52088540e-01
  1.31932226e+00  4.43991705e+00  4.43991705e+00  4.43991705e+00
  7.76748598e+00  1.62094557e+01  1.62094557e+01  1.62094557e+01
  3.54248080e+01  6.56686110e+01  6.56686110e+01  6.56686110e+01
  1.39788594e+02  5.04017787e+02  1.87158910e+03  8.00110622e+03
  4.77685632e+04]
E1 = -182.55443285001482  E_coul = 54.0344598857797
Extra cycle  E= -128.519972964235  delta_E= 5.68e-14  |g|= 3.37e-07  |ddm|= 6.8e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272441e+02 2.35721677e+02
 7.64812017e+01 1.00853489e+01 2.71500271e+01 4.10922108e-01
 2.92674491e+00 1.20909207e+00 2.64389632e+00 8.06965466e+00
 3.00492880e+01 3.06129570e-01 9.41251375e-01]
E = -128.51997296423514
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439774        1
[INPUT] 0    0    [1    /1   ]  833.272440773        1
[INPUT] 0    0    [1    /1   ]  235.721677393        1
[INPUT] 0    0    [1    /1   ]  76.4812017197        1
[INPUT] 0    0    [1    /1   ]  10.0853489381        1
[INPUT] 0    0    [1    /1   ]  27.150027121         1
[INPUT] 0    0    [1    /1   ]  0.410922107501       1
[INPUT] 0    0    [1    /1   ]  2.92674491105        1
[INPUT] 0    0    [1    /1   ]  1.20909207312        1
[INPUT] 1    0    [1    /1   ]  2.64389631919        1
[INPUT] 1    0    [1    /1   ]  8.06965466341        1
[INPUT] 1    0    [1    /1   ]  30.0492880281        1
[INPUT] 1    0    [1    /1   ]  0.306129570068       1
[INPUT] 1    0    [1    /1   ]  0.941251374976       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131416395, 1.0]], [0, [3661.4543977360318, 1.0]], [0, [833.2724407734763, 1.0]], [0, [235.72167739253638, 1.0]], [0, [76.48120171973898, 1.0]], [0, [10.08534893812092, 1.0]], [0, [27.1500271210271, 1.0]], [0, [0.4109221075012464, 1.0]], [0, [2.926744911048122, 1.0]], [0, [1.2090920731162669, 1.0]], [1, [2.643896319193749, 1.0]], [1, [8.069654663414592, 1.0]], [1, [30.049288028113097, 1.0]], [1, [0.30612957006795277, 1.0]], [1, [0.9412513749757697, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413142]
bas 1, expnt(s) = [3661.45439774]
bas 2, expnt(s) = [833.27244077]
bas 3, expnt(s) = [235.72167739]
bas 4, expnt(s) = [76.48120172]
bas 5, expnt(s) = [10.08534894]
bas 6, expnt(s) = [27.15002712]
bas 7, expnt(s) = [0.41092211]
bas 8, expnt(s) = [2.92674491]
bas 9, expnt(s) = [1.20909207]
bas 10, expnt(s) = [2.64389632]
bas 11, expnt(s) = [8.06965466]
bas 12, expnt(s) = [30.04928803]
bas 13, expnt(s) = [0.30612957]
bas 14, expnt(s) = [0.94125137]
CPU time:        89.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272441e+02 3.91836860e+02 2.35721677e+02 1.51989878e+02
 7.64812017e+01 6.53402891e+01 1.00853489e+01 1.42982610e+01
 2.71500271e+01 3.00498788e+01 4.10922108e-01 1.29668550e+00
 2.92674491e+00 5.65332142e+00 1.20909207e+00 2.91312791e+00
 2.64389632e+00 9.83535223e+00 8.06965466e+00 3.96783021e+01
 3.00492880e+01 2.05247145e+02 3.06129570e-01 6.64302665e-01
 9.41251375e-01 2.70468332e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998951868794334
cond(S) = 373.37376874544356
E1 = -183.56381628387064  E_coul = 55.0771576675666
init E= -128.486658616304
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.7720200076541  LUMO = 0.973531751695386
  mo_energy =
[-3.25560898e+01 -1.85271030e+00 -7.72020008e-01 -7.72020008e-01
 -7.72020008e-01  9.73531752e-01  9.73531752e-01  9.73531752e-01
  1.35243647e+00  4.51102377e+00  4.51102377e+00  4.51102377e+00
  7.85847850e+00  1.63464256e+01  1.63464256e+01  1.63464256e+01
  3.55926158e+01  6.58712930e+01  6.58712930e+01  6.58712930e+01
  1.40006483e+02  5.04269326e+02  1.87187127e+03  8.00141482e+03
  4.77688897e+04]
E1 = -182.04769500745482  E_coul = 53.5313243278952
cycle= 1 E= -128.51637067956  delta_E= -0.0297  |g|= 0.208  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.493888
diis-c [-0.24392487  1.        ]
  HOMO = -0.880730248475739  LUMO = 0.941576856451712
  mo_energy =
[-3.28860730e+01 -1.96697314e+00 -8.80730248e-01 -8.80730248e-01
 -8.80730248e-01  9.41576856e-01  9.41576856e-01  9.41576856e-01
  1.30355471e+00  4.40559826e+00  4.40559826e+00  4.40559826e+00
  7.72329408e+00  1.61421244e+01  1.61421244e+01  1.61421244e+01
  3.53417727e+01  6.55692060e+01  6.55692060e+01  6.55692060e+01
  1.39682154e+02  5.03900511e+02  1.87146657e+03  8.00098125e+03
  4.77684373e+04]
E1 = -182.80969741267376  E_coul = 54.29064070066263
cycle= 2 E= -128.519056712011  delta_E= -0.00269  |g|= 0.104  |ddm|= 0.0693
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.248519
diis-c [-6.12442487e-04  3.33918939e-01  6.66081061e-01]
  HOMO = -0.845018821938061  LUMO = 0.952113334229163
  mo_energy =
[-3.27773064e+01 -1.92938317e+00 -8.45018822e-01 -8.45018822e-01
 -8.45018822e-01  9.52113334e-01  9.52113334e-01  9.52113334e-01
  1.31938767e+00  4.44004023e+00  4.44004023e+00  4.44004023e+00
  7.76764318e+00  1.62096586e+01  1.62096586e+01  1.62096586e+01
  3.54250418e+01  6.56688869e+01  6.56688869e+01  6.56688869e+01
  1.39788885e+02  5.04018140e+02  1.87158952e+03  8.00110671e+03
  4.77685637e+04]
E1 = -182.5542905108222  E_coul = 54.03431755385734
cycle= 3 E= -128.519972956965  delta_E= -0.000916  |g|= 0.000304  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000468876
diis-c [-3.54449500e-08 -1.84930447e-03 -1.98851484e-03  1.00383782e+00]
  HOMO = -0.845178144756092  LUMO = 0.95209784136543
  mo_energy =
[-3.27775624e+01 -1.92951924e+00 -8.45178145e-01 -8.45178145e-01
 -8.45178145e-01  9.52097841e-01  9.52097841e-01  9.52097841e-01
  1.31933719e+00  4.43994238e+00  4.43994238e+00  4.43994238e+00
  7.76751567e+00  1.62094912e+01  1.62094912e+01  1.62094912e+01
  3.54248464e+01  6.56686507e+01  6.56686507e+01  6.56686507e+01
  1.39788634e+02  5.04017826e+02  1.87158914e+03  8.00110626e+03
  4.77685632e+04]
E1 = -182.55435947915834  E_coul = 54.03438651508704
cycle= 4 E= -128.519972964071  delta_E= -7.11e-09  |g|= 4.69e-05  |ddm|= 0.000173
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.46241e-05
diis-c [-3.00639880e-10  4.15622889e-05  3.50285073e-04 -7.90348973e-02
  1.07864305e+00]
  HOMO = -0.845203034697435  LUMO = 0.952088565295766
  mo_energy =
[-3.27776032e+01 -1.92954383e+00 -8.45203035e-01 -8.45203035e-01
 -8.45203035e-01  9.52088565e-01  9.52088565e-01  9.52088565e-01
  1.31932228e+00  4.43991703e+00  4.43991703e+00  4.43991703e+00
  7.76748581e+00  1.62094554e+01  1.62094554e+01  1.62094554e+01
  3.54248075e+01  6.56686104e+01  6.56686104e+01  6.56686104e+01
  1.39788594e+02  5.04017786e+02  1.87158910e+03  8.00110622e+03
  4.77685632e+04]
E1 = -182.55443541873217  E_coul = 54.03446245449699
cycle= 5 E= -128.519972964235  delta_E= -1.64e-10  |g|= 1e-06  |ddm|= 1.69e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.55443541873217  E_coul = 54.03446245449699
  HOMO = -0.845202992940996  LUMO = 0.952088540017226
  mo_energy =
[-3.27776026e+01 -1.92954365e+00 -8.45202993e-01 -8.45202993e-01
 -8.45202993e-01  9.52088540e-01  9.52088540e-01  9.52088540e-01
  1.31932226e+00  4.43991705e+00  4.43991705e+00  4.43991705e+00
  7.76748598e+00  1.62094557e+01  1.62094557e+01  1.62094557e+01
  3.54248080e+01  6.56686110e+01  6.56686110e+01  6.56686110e+01
  1.39788594e+02  5.04017787e+02  1.87158910e+03  8.00110622e+03
  4.77685632e+04]
E1 = -182.55443285001482  E_coul = 54.0344598857797
Extra cycle  E= -128.519972964235  delta_E= 5.68e-14  |g|= 3.37e-07  |ddm|= 6.8e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 373.37376874544356
E1 = -182.55443285001482  E_coul = 54.0344598857797
init E= -128.519972964235
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845203191063103  LUMO = 0.952088476804817
  mo_energy =
[-3.27776031e+01 -1.92954383e+00 -8.45203191e-01 -8.45203191e-01
 -8.45203191e-01  9.52088477e-01  9.52088477e-01  9.52088477e-01
  1.31932218e+00  4.43991685e+00  4.43991685e+00  4.43991685e+00
  7.76748575e+00  1.62094554e+01  1.62094554e+01  1.62094554e+01
  3.54248076e+01  6.56686105e+01  6.56686105e+01  6.56686105e+01
  1.39788594e+02  5.04017786e+02  1.87158909e+03  8.00110622e+03
  4.77685632e+04]
E1 = -182.55443397765615  E_coul = 54.034461013420795
cycle= 1 E= -128.519972964235  delta_E= -2.27e-13  |g|= 1.59e-07  |ddm|= 1.01e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.55443397765615  E_coul = 54.034461013420795
  HOMO = -0.845203113722152  LUMO = 0.95208849928368
  mo_energy =
[-3.27776029e+01 -1.92954375e+00 -8.45203114e-01 -8.45203114e-01
 -8.45203114e-01  9.52088499e-01  9.52088499e-01  9.52088499e-01
  1.31932221e+00  4.43991693e+00  4.43991693e+00  4.43991693e+00
  7.76748585e+00  1.62094555e+01  1.62094555e+01  1.62094555e+01
  3.54248078e+01  6.56686107e+01  6.56686107e+01  6.56686107e+01
  1.39788594e+02  5.04017786e+02  1.87158910e+03  8.00110622e+03
  4.77685632e+04]
E1 = -182.5544333919581  E_coul = 54.03446042772291
Extra cycle  E= -128.519972964235  delta_E= 1.71e-13  |g|= 7.91e-08  |ddm|= 6.01e-08
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272441e+02 2.35721677e+02
 7.64812017e+01 1.00853489e+01 2.71500271e+01 4.10922108e-01
 2.92674491e+00 1.20909207e+00 2.64389632e+00 8.06965466e+00
 3.00492880e+01 3.06129570e-01 9.41251375e-01]
grad_E = [-2.85820061e-10  1.51258357e-08 -3.03466640e-07  3.65630840e-06
 -2.86165925e-05 -3.46308708e-04  1.42615487e-04  1.62193602e-03
 -3.87864332e-04  1.85454006e-03 -1.46941235e-02  4.35119381e-03
 -1.86858856e-03  1.51555166e-02  1.95554987e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439733        1
[INPUT] 0    0    [1    /1   ]  833.272448675        1
[INPUT] 0    0    [1    /1   ]  235.721594753        1
[INPUT] 0    0    [1    /1   ]  76.4815705051        1
[INPUT] 0    0    [1    /1   ]  10.0499552229        1
[INPUT] 0    0    [1    /1   ]  27.1528579304        1
[INPUT] 0    0    [1    /1   ]  0.436270938241       1
[INPUT] 0    0    [1    /1   ]  2.84442526753        1
[INPUT] 0    0    [1    /1   ]  1.28255674081        1
[INPUT] 1    0    [1    /1   ]  2.7840192016         1
[INPUT] 1    0    [1    /1   ]  8.57618134722        1
[INPUT] 1    0    [1    /1   ]  31.8877745651        1
[INPUT] 1    0    [1    /1   ]  0.31889339354        1
[INPUT] 1    0    [1    /1   ]  0.99303859777        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131422525, 1.0]], [0, [3661.4543973330747, 1.0]], [0, [833.2724486751615, 1.0]], [0, [235.72159475349827, 1.0]], [0, [76.48157050512998, 1.0]], [0, [10.049955222868796, 1.0]], [0, [27.15285793038984, 1.0]], [0, [0.43627093824089513, 1.0]], [0, [2.844425267531678, 1.0]], [0, [1.2825567408097711, 1.0]], [1, [2.784019201601391, 1.0]], [1, [8.576181347219165, 1.0]], [1, [31.88777456510963, 1.0]], [1, [0.3188933935397973, 1.0]], [1, [0.9930385977701954, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413142]
bas 1, expnt(s) = [3661.45439733]
bas 2, expnt(s) = [833.27244868]
bas 3, expnt(s) = [235.72159475]
bas 4, expnt(s) = [76.48157051]
bas 5, expnt(s) = [10.04995522]
bas 6, expnt(s) = [27.15285793]
bas 7, expnt(s) = [0.43627094]
bas 8, expnt(s) = [2.84442527]
bas 9, expnt(s) = [1.28255674]
bas 10, expnt(s) = [2.7840192]
bas 11, expnt(s) = [8.57618135]
bas 12, expnt(s) = [31.88777457]
bas 13, expnt(s) = [0.31889339]
bas 14, expnt(s) = [0.9930386]
CPU time:        92.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272449e+02 3.91836863e+02 2.35721595e+02 1.51989838e+02
 7.64815705e+01 6.53405254e+01 1.00499552e+01 1.42606105e+01
 2.71528579e+01 3.00522287e+01 4.36270938e-01 1.35622653e+00
 2.84442527e+00 5.53364023e+00 1.28255674e+00 3.04489601e+00
 2.78401920e+00 1.04911881e+01 8.57618135e+00 4.28155806e+01
 3.18877746e+01 2.21062286e+02 3.18893394e-01 6.99103208e-01
 9.93038598e-01 2.89195848e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998621633957594
cond(S) = 402.57995725817955
E1 = -183.56547728194292  E_coul = 55.07761376103508
init E= -128.487863520908
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.772274829673038  LUMO = 1.02824137939406
  mo_energy =
[-3.25558956e+01 -1.85252943e+00 -7.72274830e-01 -7.72274830e-01
 -7.72274830e-01  1.02824138e+00  1.02824138e+00  1.02824138e+00
  1.45801844e+00  4.77397914e+00  4.77397914e+00  4.77397914e+00
  8.07285251e+00  1.74082566e+01  1.74082566e+01  1.74082566e+01
  3.56514217e+01  7.05223960e+01  7.05223960e+01  7.05223960e+01
  1.39948222e+02  5.04189672e+02  1.87179488e+03  8.00134657e+03
  4.77688331e+04]
E1 = -182.07654268442946  E_coul = 53.55860142696125
cycle= 1 E= -128.517941257468  delta_E= -0.0301  |g|= 0.204  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.483398
diis-c [-0.23367341  1.        ]
  HOMO = -0.878930920949786  LUMO = 0.99481592982118
  mo_energy =
[-3.28808654e+01 -1.96462686e+00 -8.78930921e-01 -8.78930921e-01
 -8.78930921e-01  9.94815930e-01  9.94815930e-01  9.94815930e-01
  1.40763109e+00  4.66615050e+00  4.66615050e+00  4.66615050e+00
  7.94039222e+00  1.72021040e+01  1.72021040e+01  1.72021040e+01
  3.54053181e+01  7.02216686e+01  7.02216686e+01  7.02216686e+01
  1.39628889e+02  5.03826160e+02  1.87139559e+03  8.00091845e+03
  4.77683862e+04]
E1 = -182.82172716606303  E_coul = 54.30118416469297
cycle= 2 E= -128.52054300137  delta_E= -0.0026  |g|= 0.102  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.241742
diis-c [-6.12832466e-04  3.32493498e-01  6.67506502e-01]
  HOMO = -0.843967344265698  LUMO = 1.00582934415297
  mo_energy =
[-3.27741354e+01 -1.92782357e+00 -8.43967344e-01 -8.43967344e-01
 -8.43967344e-01  1.00582934e+00  1.00582934e+00  1.00582934e+00
  1.42393626e+00  4.70132970e+00  4.70132970e+00  4.70132970e+00
  7.98378406e+00  1.72700541e+01  1.72700541e+01  1.72700541e+01
  3.54867771e+01  7.03205059e+01  7.03205059e+01  7.03205059e+01
  1.39733596e+02  5.03941618e+02  1.87151629e+03  8.00104161e+03
  4.77685103e+04]
E1 = -182.57252962817506  E_coul = 54.05111077010871
cycle= 3 E= -128.521418858066  delta_E= -0.000876  |g|= 0.000348  |ddm|= 0.0236
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000587725
diis-c [-3.51914136e-08 -1.93304024e-03 -1.58474384e-03  1.00351778e+00]
  HOMO = -0.844147626760934  LUMO = 1.0058026861212
  mo_energy =
[-3.27744467e+01 -1.92798526e+00 -8.44147627e-01 -8.44147627e-01
 -8.44147627e-01  1.00580269e+00  1.00580269e+00  1.00580269e+00
  1.42386798e+00  4.70120325e+00  4.70120325e+00  4.70120325e+00
  7.98362779e+00  1.72698420e+01  1.72698420e+01  1.72698420e+01
  3.54865373e+01  7.03202146e+01  7.03202146e+01  7.03202146e+01
  1.39733290e+02  5.03941243e+02  1.87151584e+03  8.00104110e+03
  4.77685097e+04]
E1 = -182.57274378129716  E_coul = 54.05132491489749
cycle= 4 E= -128.5214188664  delta_E= -8.33e-09  |g|= 4.58e-05  |ddm|= 0.000167
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.03259e-05
diis-c [-2.59153899e-10  5.76961553e-05  3.21446321e-04 -8.26743590e-02
  1.08229522e+00]
  HOMO = -0.844171884430128  LUMO = 1.00579308415725
  mo_energy =
[-3.27744867e+01 -1.92800995e+00 -8.44171884e-01 -8.44171884e-01
 -8.44171884e-01  1.00579308e+00  1.00579308e+00  1.00579308e+00
  1.42385239e+00  4.70117774e+00  4.70117774e+00  4.70117774e+00
  7.98359836e+00  1.72698065e+01  1.72698065e+01  1.72698065e+01
  3.54864993e+01  7.03201752e+01  7.03201752e+01  7.03201752e+01
  1.39733251e+02  5.03941204e+02  1.87151580e+03  8.00104106e+03
  4.77685097e+04]
E1 = -182.5728178156511  E_coul = 54.05139894910121
cycle= 5 E= -128.52141886655  delta_E= -1.5e-10  |g|= 9.66e-07  |ddm|= 1.57e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5728178156511  E_coul = 54.05139894910121
  HOMO = -0.844171596117517  LUMO = 1.005793146619
  mo_energy =
[-3.27744855e+01 -1.92800963e+00 -8.44171596e-01 -8.44171596e-01
 -8.44171596e-01  1.00579315e+00  1.00579315e+00  1.00579315e+00
  1.42385246e+00  4.70117801e+00  4.70117801e+00  4.70117801e+00
  7.98359876e+00  1.72698072e+01  1.72698072e+01  1.72698072e+01
  3.54865002e+01  7.03201762e+01  7.03201762e+01  7.03201762e+01
  1.39733252e+02  5.03941205e+02  1.87151580e+03  8.00104106e+03
  4.77685097e+04]
E1 = -182.57281421957137  E_coul = 54.051395353021505
Extra cycle  E= -128.52141886655  delta_E=    0  |g|= 4.75e-07  |ddm|= 5.36e-07
    CPU time for scf_cycle      0.14 sec, wall time      0.15 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272449e+02 2.35721595e+02
 7.64815705e+01 1.00499552e+01 2.71528579e+01 4.36270938e-01
 2.84442527e+00 1.28255674e+00 2.78401920e+00 8.57618135e+00
 3.18877746e+01 3.18893394e-01 9.93038598e-01]
E = -128.52141886654988
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439733        1
[INPUT] 0    0    [1    /1   ]  833.272448675        1
[INPUT] 0    0    [1    /1   ]  235.721594753        1
[INPUT] 0    0    [1    /1   ]  76.4815705051        1
[INPUT] 0    0    [1    /1   ]  10.0499552229        1
[INPUT] 0    0    [1    /1   ]  27.1528579304        1
[INPUT] 0    0    [1    /1   ]  0.436270938241       1
[INPUT] 0    0    [1    /1   ]  2.84442526753        1
[INPUT] 0    0    [1    /1   ]  1.28255674081        1
[INPUT] 1    0    [1    /1   ]  2.7840192016         1
[INPUT] 1    0    [1    /1   ]  8.57618134722        1
[INPUT] 1    0    [1    /1   ]  31.8877745651        1
[INPUT] 1    0    [1    /1   ]  0.31889339354        1
[INPUT] 1    0    [1    /1   ]  0.99303859777        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131422525, 1.0]], [0, [3661.4543973330747, 1.0]], [0, [833.2724486751615, 1.0]], [0, [235.72159475349827, 1.0]], [0, [76.48157050512998, 1.0]], [0, [10.049955222868796, 1.0]], [0, [27.15285793038984, 1.0]], [0, [0.43627093824089513, 1.0]], [0, [2.844425267531678, 1.0]], [0, [1.2825567408097711, 1.0]], [1, [2.784019201601391, 1.0]], [1, [8.576181347219165, 1.0]], [1, [31.88777456510963, 1.0]], [1, [0.3188933935397973, 1.0]], [1, [0.9930385977701954, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413142]
bas 1, expnt(s) = [3661.45439733]
bas 2, expnt(s) = [833.27244868]
bas 3, expnt(s) = [235.72159475]
bas 4, expnt(s) = [76.48157051]
bas 5, expnt(s) = [10.04995522]
bas 6, expnt(s) = [27.15285793]
bas 7, expnt(s) = [0.43627094]
bas 8, expnt(s) = [2.84442527]
bas 9, expnt(s) = [1.28255674]
bas 10, expnt(s) = [2.7840192]
bas 11, expnt(s) = [8.57618135]
bas 12, expnt(s) = [31.88777457]
bas 13, expnt(s) = [0.31889339]
bas 14, expnt(s) = [0.9930386]
CPU time:        93.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272449e+02 3.91836863e+02 2.35721595e+02 1.51989838e+02
 7.64815705e+01 6.53405254e+01 1.00499552e+01 1.42606105e+01
 2.71528579e+01 3.00522287e+01 4.36270938e-01 1.35622653e+00
 2.84442527e+00 5.53364023e+00 1.28255674e+00 3.04489601e+00
 2.78401920e+00 1.04911881e+01 8.57618135e+00 4.28155806e+01
 3.18877746e+01 2.21062286e+02 3.18893394e-01 6.99103208e-01
 9.93038598e-01 2.89195848e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998621633957594
cond(S) = 402.57995725817955
E1 = -183.56547728194292  E_coul = 55.07761376103508
init E= -128.487863520908
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.772274829673038  LUMO = 1.02824137939406
  mo_energy =
[-3.25558956e+01 -1.85252943e+00 -7.72274830e-01 -7.72274830e-01
 -7.72274830e-01  1.02824138e+00  1.02824138e+00  1.02824138e+00
  1.45801844e+00  4.77397914e+00  4.77397914e+00  4.77397914e+00
  8.07285251e+00  1.74082566e+01  1.74082566e+01  1.74082566e+01
  3.56514217e+01  7.05223960e+01  7.05223960e+01  7.05223960e+01
  1.39948222e+02  5.04189672e+02  1.87179488e+03  8.00134657e+03
  4.77688331e+04]
E1 = -182.07654268442946  E_coul = 53.55860142696125
cycle= 1 E= -128.517941257468  delta_E= -0.0301  |g|= 0.204  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.483398
diis-c [-0.23367341  1.        ]
  HOMO = -0.878930920949786  LUMO = 0.99481592982118
  mo_energy =
[-3.28808654e+01 -1.96462686e+00 -8.78930921e-01 -8.78930921e-01
 -8.78930921e-01  9.94815930e-01  9.94815930e-01  9.94815930e-01
  1.40763109e+00  4.66615050e+00  4.66615050e+00  4.66615050e+00
  7.94039222e+00  1.72021040e+01  1.72021040e+01  1.72021040e+01
  3.54053181e+01  7.02216686e+01  7.02216686e+01  7.02216686e+01
  1.39628889e+02  5.03826160e+02  1.87139559e+03  8.00091845e+03
  4.77683862e+04]
E1 = -182.82172716606303  E_coul = 54.30118416469297
cycle= 2 E= -128.52054300137  delta_E= -0.0026  |g|= 0.102  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.241742
diis-c [-6.12832466e-04  3.32493498e-01  6.67506502e-01]
  HOMO = -0.843967344265698  LUMO = 1.00582934415297
  mo_energy =
[-3.27741354e+01 -1.92782357e+00 -8.43967344e-01 -8.43967344e-01
 -8.43967344e-01  1.00582934e+00  1.00582934e+00  1.00582934e+00
  1.42393626e+00  4.70132970e+00  4.70132970e+00  4.70132970e+00
  7.98378406e+00  1.72700541e+01  1.72700541e+01  1.72700541e+01
  3.54867771e+01  7.03205059e+01  7.03205059e+01  7.03205059e+01
  1.39733596e+02  5.03941618e+02  1.87151629e+03  8.00104161e+03
  4.77685103e+04]
E1 = -182.57252962817506  E_coul = 54.05111077010871
cycle= 3 E= -128.521418858066  delta_E= -0.000876  |g|= 0.000348  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000587725
diis-c [-3.51914136e-08 -1.93304024e-03 -1.58474384e-03  1.00351778e+00]
  HOMO = -0.844147626760934  LUMO = 1.0058026861212
  mo_energy =
[-3.27744467e+01 -1.92798526e+00 -8.44147627e-01 -8.44147627e-01
 -8.44147627e-01  1.00580269e+00  1.00580269e+00  1.00580269e+00
  1.42386798e+00  4.70120325e+00  4.70120325e+00  4.70120325e+00
  7.98362779e+00  1.72698420e+01  1.72698420e+01  1.72698420e+01
  3.54865373e+01  7.03202146e+01  7.03202146e+01  7.03202146e+01
  1.39733290e+02  5.03941243e+02  1.87151584e+03  8.00104110e+03
  4.77685097e+04]
E1 = -182.57274378129716  E_coul = 54.05132491489749
cycle= 4 E= -128.5214188664  delta_E= -8.33e-09  |g|= 4.58e-05  |ddm|= 0.000167
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.03259e-05
diis-c [-2.59153899e-10  5.76961553e-05  3.21446321e-04 -8.26743590e-02
  1.08229522e+00]
  HOMO = -0.844171884430128  LUMO = 1.00579308415725
  mo_energy =
[-3.27744867e+01 -1.92800995e+00 -8.44171884e-01 -8.44171884e-01
 -8.44171884e-01  1.00579308e+00  1.00579308e+00  1.00579308e+00
  1.42385239e+00  4.70117774e+00  4.70117774e+00  4.70117774e+00
  7.98359836e+00  1.72698065e+01  1.72698065e+01  1.72698065e+01
  3.54864993e+01  7.03201752e+01  7.03201752e+01  7.03201752e+01
  1.39733251e+02  5.03941204e+02  1.87151580e+03  8.00104106e+03
  4.77685097e+04]
E1 = -182.5728178156511  E_coul = 54.05139894910121
cycle= 5 E= -128.52141886655  delta_E= -1.5e-10  |g|= 9.66e-07  |ddm|= 1.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5728178156511  E_coul = 54.05139894910121
  HOMO = -0.844171596117517  LUMO = 1.005793146619
  mo_energy =
[-3.27744855e+01 -1.92800963e+00 -8.44171596e-01 -8.44171596e-01
 -8.44171596e-01  1.00579315e+00  1.00579315e+00  1.00579315e+00
  1.42385246e+00  4.70117801e+00  4.70117801e+00  4.70117801e+00
  7.98359876e+00  1.72698072e+01  1.72698072e+01  1.72698072e+01
  3.54865002e+01  7.03201762e+01  7.03201762e+01  7.03201762e+01
  1.39733252e+02  5.03941205e+02  1.87151580e+03  8.00104106e+03
  4.77685097e+04]
E1 = -182.57281421957137  E_coul = 54.051395353021505
Extra cycle  E= -128.52141886655  delta_E=    0  |g|= 4.75e-07  |ddm|= 5.36e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 402.57995725817955
E1 = -182.57281421957137  E_coul = 54.051395353021505
init E= -128.52141886655
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844171858543822  LUMO = 1.00579305959569
  mo_energy =
[-3.27744863e+01 -1.92800990e+00 -8.44171859e-01 -8.44171859e-01
 -8.44171859e-01  1.00579306e+00  1.00579306e+00  1.00579306e+00
  1.42385233e+00  4.70117774e+00  4.70117774e+00  4.70117774e+00
  7.98359844e+00  1.72698067e+01  1.72698067e+01  1.72698067e+01
  3.54864996e+01  7.03201755e+01  7.03201755e+01  7.03201755e+01
  1.39733251e+02  5.03941204e+02  1.87151580e+03  8.00104106e+03
  4.77685097e+04]
E1 = -182.57281588932244  E_coul = 54.051397022772676
cycle= 1 E= -128.52141886655  delta_E= 1.14e-13  |g|= 2.29e-07  |ddm|= 1.51e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57281588932244  E_coul = 54.051397022772676
  HOMO = -0.844171741774702  LUMO = 1.00579309599609
  mo_energy =
[-3.27744859e+01 -1.92800978e+00 -8.44171742e-01 -8.44171742e-01
 -8.44171742e-01  1.00579310e+00  1.00579310e+00  1.00579310e+00
  1.42385238e+00  4.70117786e+00  4.70117786e+00  4.70117786e+00
  7.98359858e+00  1.72698069e+01  1.72698069e+01  1.72698069e+01
  3.54864999e+01  7.03201759e+01  7.03201759e+01  7.03201759e+01
  1.39733252e+02  5.03941205e+02  1.87151580e+03  8.00104106e+03
  4.77685097e+04]
E1 = -182.57281503413313  E_coul = 54.05139616758336
Extra cycle  E= -128.52141886655  delta_E=    0  |g|= 1.16e-07  |ddm|= 8.18e-08
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272449e+02 2.35721595e+02
 7.64815705e+01 1.00499552e+01 2.71528579e+01 4.36270938e-01
 2.84442527e+00 1.28255674e+00 2.78401920e+00 8.57618135e+00
 3.18877746e+01 3.18893394e-01 9.93038598e-01]
grad_E = [-5.78479661e-10  3.05869497e-08 -6.12334067e-07  7.40928107e-06
 -5.78686500e-05 -7.13177412e-04  2.93618666e-04  5.01741724e-03
 -6.43955792e-04  2.68186794e-03 -1.75627561e-02  4.97743644e-03
 -1.65396013e-03  1.39217950e-02  2.58486908e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439667        1
[INPUT] 0    0    [1    /1   ]  833.27246167         1
[INPUT] 0    0    [1    /1   ]  235.721458052        1
[INPUT] 0    0    [1    /1   ]  76.4821977597        1
[INPUT] 0    0    [1    /1   ]  9.99413792256        1
[INPUT] 0    0    [1    /1   ]  27.1571435553        1
[INPUT] 0    0    [1    /1   ]  0.47025027944        1
[INPUT] 0    0    [1    /1   ]  2.71332828428        1
[INPUT] 0    0    [1    /1   ]  1.40420563916        1
[INPUT] 1    0    [1    /1   ]  2.97020064435        1
[INPUT] 1    0    [1    /1   ]  9.29925104           1
[INPUT] 1    0    [1    /1   ]  34.810261237         1
[INPUT] 1    0    [1    /1   ]  0.322466647769       1
[INPUT] 1    0    [1    /1   ]  1.0325505766         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131432693, 1.0]], [0, [3661.454396670694, 1.0]], [0, [833.2724616695009, 1.0]], [0, [235.72145805249554, 1.0]], [0, [76.4821977596568, 1.0]], [0, [9.994137922563992, 1.0]], [0, [27.157143555317866, 1.0]], [0, [0.4702502794400974, 1.0]], [0, [2.7133282842781994, 1.0]], [0, [1.4042056391624165, 1.0]], [1, [2.970200644346181, 1.0]], [1, [9.29925103999551, 1.0]], [1, [34.81026123704927, 1.0]], [1, [0.32246664776937695, 1.0]], [1, [1.0325505766035283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413143]
bas 1, expnt(s) = [3661.45439667]
bas 2, expnt(s) = [833.27246167]
bas 3, expnt(s) = [235.72145805]
bas 4, expnt(s) = [76.48219776]
bas 5, expnt(s) = [9.99413792]
bas 6, expnt(s) = [27.15714356]
bas 7, expnt(s) = [0.47025028]
bas 8, expnt(s) = [2.71332828]
bas 9, expnt(s) = [1.40420564]
bas 10, expnt(s) = [2.97020064]
bas 11, expnt(s) = [9.29925104]
bas 12, expnt(s) = [34.81026124]
bas 13, expnt(s) = [0.32246665]
bas 14, expnt(s) = [1.03255058]
CPU time:        96.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272462e+02 3.91836868e+02 2.35721458e+02 1.51989772e+02
 7.64821978e+01 6.53409273e+01 9.99413792e+00 1.42011668e+01
 2.71571436e+01 3.00557860e+01 4.70250279e-01 1.43470239e+00
 2.71332828e+00 5.34123616e+00 1.40420564e+00 3.25902775e+00
 2.97020064e+00 1.13753987e+01 9.29925104e+00 4.73744693e+01
 3.48102612e+01 2.46671228e+02 3.22466648e-01 7.08908847e-01
 1.03255058e+00 3.03650192e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998412794409308
cond(S) = 485.1275257694075
E1 = -183.5679056306915  E_coul = 55.078289301234754
init E= -128.489616329457
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.772715064356221  LUMO = 1.05355633092948
  mo_energy =
[-3.25556498e+01 -1.85211290e+00 -7.72715064e-01 -7.72715064e-01
 -7.72715064e-01  1.05355633e+00  1.05355633e+00  1.05355633e+00
  1.60685139e+00  5.00201845e+00  5.00201845e+00  5.00201845e+00
  8.37255478e+00  1.87323513e+01  1.87323513e+01  1.87323513e+01
  3.57306560e+01  7.74593689e+01  7.74593689e+01  7.74593689e+01
  1.39852527e+02  5.04062439e+02  1.87167339e+03  8.00123815e+03
  4.77687432e+04]
E1 = -182.0961198314666  E_coul = 53.575941553251745
cycle= 1 E= -128.520178278215  delta_E= -0.0306  |g|= 0.202  |ddm|= 0.179
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.472749
diis-c [-0.22349159  1.        ]
  HOMO = -0.878127838116563  LUMO = 1.01920150866187
  mo_energy =
[-3.28771583e+01 -1.96312790e+00 -8.78127838e-01 -8.78127838e-01
 -8.78127838e-01  1.01920151e+00  1.01920151e+00  1.01920151e+00
  1.55347094e+00  4.89035106e+00  4.89035106e+00  4.89035106e+00
  8.24172371e+00  1.85212347e+01  1.85212347e+01  1.85212347e+01
  3.54881260e+01  7.71570928e+01  7.71570928e+01  7.71570928e+01
  1.39536676e+02  5.03702597e+02  1.87127784e+03  8.00081381e+03
  4.77683000e+04]
E1 = -182.8308642883808  E_coul = 54.30814330740409
cycle= 2 E= -128.522720980977  delta_E= -0.00254  |g|=  0.1  |ddm|= 0.0692
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.23573
diis-c [-6.14444035e-04  3.31798924e-01  6.68201076e-01]
  HOMO = -0.843641471905938  LUMO = 1.03049509391846
  mo_energy =
[-3.27717427e+01 -1.92680357e+00 -8.43641472e-01 -8.43641472e-01
 -8.43641472e-01  1.03049509e+00  1.03049509e+00  1.03049509e+00
  1.57066435e+00  4.92671259e+00  4.92671259e+00  4.92671259e+00
  8.28450678e+00  1.85906920e+01  1.85906920e+01  1.85906920e+01
  3.55682744e+01  7.72561891e+01  7.72561891e+01  7.72561891e+01
  1.39640059e+02  5.03816650e+02  1.87139708e+03  8.00093549e+03
  4.77684226e+04]
E1 = -182.58511779614363  E_coul = 54.06154444906841
cycle= 3 E= -128.523573347075  delta_E= -0.000852  |g|= 0.000409  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000705432
diis-c [-4.36224179e-08 -2.04613267e-03 -1.25808866e-03  1.00330422e+00]
  HOMO = -0.843848788525616  LUMO = 1.03045479940019
  mo_energy =
[-3.27721176e+01 -1.92700745e+00 -8.43848789e-01 -8.43848789e-01
 -8.43848789e-01  1.03045480e+00  1.03045480e+00  1.03045480e+00
  1.57056482e+00  4.92654798e+00  4.92654798e+00  4.92654798e+00
  8.28431042e+00  1.85904221e+01  1.85904221e+01  1.85904221e+01
  3.55679800e+01  7.72558315e+01  7.72558315e+01  7.72558315e+01
  1.39639690e+02  5.03816210e+02  1.87139656e+03  8.00093490e+03
  4.77684220e+04]
E1 = -182.58547127187538  E_coul = 54.061897913652565
cycle= 4 E= -128.523573358223  delta_E= -1.11e-08  |g|= 4.66e-05  |ddm|= 0.000157
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.11677e-05
diis-c [-3.86026183e-10  1.01669864e-04  2.67215267e-04 -1.03994354e-01
  1.10362547e+00]
  HOMO = -0.843872989495266  LUMO = 1.03044461357805
  mo_energy =
[-3.27721569e+01 -1.92703535e+00 -8.43872989e-01 -8.43872989e-01
 -8.43872989e-01  1.03044461e+00  1.03044461e+00  1.03044461e+00
  1.57054608e+00  4.92652124e+00  4.92652124e+00  4.92652124e+00
  8.28427948e+00  1.85903858e+01  1.85903858e+01  1.85903858e+01
  3.55679417e+01  7.72557924e+01  7.72557924e+01  7.72557924e+01
  1.39639651e+02  5.03816173e+02  1.87139653e+03  8.00093487e+03
  4.77684220e+04]
E1 = -182.58554050468848  E_coul = 54.06196714630876
cycle= 5 E= -128.52357335838  delta_E= -1.57e-10  |g|= 2.52e-06  |ddm|= 1.56e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58554050468848  E_coul = 54.06196714630876
  HOMO = -0.843871712944464  LUMO = 1.03044502026733
  mo_energy =
[-3.27721536e+01 -1.92703438e+00 -8.43871713e-01 -8.43871713e-01
 -8.43871713e-01  1.03044502e+00  1.03044502e+00  1.03044502e+00
  1.57054649e+00  4.92652254e+00  4.92652254e+00  4.92652254e+00
  8.28428087e+00  1.85903881e+01  1.85903881e+01  1.85903881e+01
  3.55679443e+01  7.72557955e+01  7.72557955e+01  7.72557955e+01
  1.39639655e+02  5.03816176e+02  1.87139653e+03  8.00093487e+03
  4.77684220e+04]
E1 = -182.58553182710273  E_coul = 54.06195846872202
Extra cycle  E= -128.523573358381  delta_E= -9.66e-13  |g|= 1.24e-06  |ddm|= 1.16e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272462e+02 2.35721458e+02
 7.64821978e+01 9.99413792e+00 2.71571436e+01 4.70250279e-01
 2.71332828e+00 1.40420564e+00 2.97020064e+00 9.29925104e+00
 3.48102612e+01 3.22466648e-01 1.03255058e+00]
E = -128.5235733583807
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439667        1
[INPUT] 0    0    [1    /1   ]  833.27246167         1
[INPUT] 0    0    [1    /1   ]  235.721458052        1
[INPUT] 0    0    [1    /1   ]  76.4821977597        1
[INPUT] 0    0    [1    /1   ]  9.99413792256        1
[INPUT] 0    0    [1    /1   ]  27.1571435553        1
[INPUT] 0    0    [1    /1   ]  0.47025027944        1
[INPUT] 0    0    [1    /1   ]  2.71332828428        1
[INPUT] 0    0    [1    /1   ]  1.40420563916        1
[INPUT] 1    0    [1    /1   ]  2.97020064435        1
[INPUT] 1    0    [1    /1   ]  9.29925104           1
[INPUT] 1    0    [1    /1   ]  34.810261237         1
[INPUT] 1    0    [1    /1   ]  0.322466647769       1
[INPUT] 1    0    [1    /1   ]  1.0325505766         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131432693, 1.0]], [0, [3661.454396670694, 1.0]], [0, [833.2724616695009, 1.0]], [0, [235.72145805249554, 1.0]], [0, [76.4821977596568, 1.0]], [0, [9.994137922563992, 1.0]], [0, [27.157143555317866, 1.0]], [0, [0.4702502794400974, 1.0]], [0, [2.7133282842781994, 1.0]], [0, [1.4042056391624165, 1.0]], [1, [2.970200644346181, 1.0]], [1, [9.29925103999551, 1.0]], [1, [34.81026123704927, 1.0]], [1, [0.32246664776937695, 1.0]], [1, [1.0325505766035283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413143]
bas 1, expnt(s) = [3661.45439667]
bas 2, expnt(s) = [833.27246167]
bas 3, expnt(s) = [235.72145805]
bas 4, expnt(s) = [76.48219776]
bas 5, expnt(s) = [9.99413792]
bas 6, expnt(s) = [27.15714356]
bas 7, expnt(s) = [0.47025028]
bas 8, expnt(s) = [2.71332828]
bas 9, expnt(s) = [1.40420564]
bas 10, expnt(s) = [2.97020064]
bas 11, expnt(s) = [9.29925104]
bas 12, expnt(s) = [34.81026124]
bas 13, expnt(s) = [0.32246665]
bas 14, expnt(s) = [1.03255058]
CPU time:        97.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272462e+02 3.91836868e+02 2.35721458e+02 1.51989772e+02
 7.64821978e+01 6.53409273e+01 9.99413792e+00 1.42011668e+01
 2.71571436e+01 3.00557860e+01 4.70250279e-01 1.43470239e+00
 2.71332828e+00 5.34123616e+00 1.40420564e+00 3.25902775e+00
 2.97020064e+00 1.13753987e+01 9.29925104e+00 4.73744693e+01
 3.48102612e+01 2.46671228e+02 3.22466648e-01 7.08908847e-01
 1.03255058e+00 3.03650192e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998412794409308
cond(S) = 485.1275257694075
E1 = -183.5679056306915  E_coul = 55.078289301234754
init E= -128.489616329457
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.772715064356221  LUMO = 1.05355633092948
  mo_energy =
[-3.25556498e+01 -1.85211290e+00 -7.72715064e-01 -7.72715064e-01
 -7.72715064e-01  1.05355633e+00  1.05355633e+00  1.05355633e+00
  1.60685139e+00  5.00201845e+00  5.00201845e+00  5.00201845e+00
  8.37255478e+00  1.87323513e+01  1.87323513e+01  1.87323513e+01
  3.57306560e+01  7.74593689e+01  7.74593689e+01  7.74593689e+01
  1.39852527e+02  5.04062439e+02  1.87167339e+03  8.00123815e+03
  4.77687432e+04]
E1 = -182.0961198314666  E_coul = 53.575941553251745
cycle= 1 E= -128.520178278215  delta_E= -0.0306  |g|= 0.202  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.472749
diis-c [-0.22349159  1.        ]
  HOMO = -0.878127838116563  LUMO = 1.01920150866187
  mo_energy =
[-3.28771583e+01 -1.96312790e+00 -8.78127838e-01 -8.78127838e-01
 -8.78127838e-01  1.01920151e+00  1.01920151e+00  1.01920151e+00
  1.55347094e+00  4.89035106e+00  4.89035106e+00  4.89035106e+00
  8.24172371e+00  1.85212347e+01  1.85212347e+01  1.85212347e+01
  3.54881260e+01  7.71570928e+01  7.71570928e+01  7.71570928e+01
  1.39536676e+02  5.03702597e+02  1.87127784e+03  8.00081381e+03
  4.77683000e+04]
E1 = -182.8308642883808  E_coul = 54.30814330740409
cycle= 2 E= -128.522720980977  delta_E= -0.00254  |g|=  0.1  |ddm|= 0.0692
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23573
diis-c [-6.14444035e-04  3.31798924e-01  6.68201076e-01]
  HOMO = -0.843641471905938  LUMO = 1.03049509391846
  mo_energy =
[-3.27717427e+01 -1.92680357e+00 -8.43641472e-01 -8.43641472e-01
 -8.43641472e-01  1.03049509e+00  1.03049509e+00  1.03049509e+00
  1.57066435e+00  4.92671259e+00  4.92671259e+00  4.92671259e+00
  8.28450678e+00  1.85906920e+01  1.85906920e+01  1.85906920e+01
  3.55682744e+01  7.72561891e+01  7.72561891e+01  7.72561891e+01
  1.39640059e+02  5.03816650e+02  1.87139708e+03  8.00093549e+03
  4.77684226e+04]
E1 = -182.58511779614363  E_coul = 54.06154444906841
cycle= 3 E= -128.523573347075  delta_E= -0.000852  |g|= 0.000409  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000705432
diis-c [-4.36224179e-08 -2.04613267e-03 -1.25808866e-03  1.00330422e+00]
  HOMO = -0.843848788525616  LUMO = 1.03045479940019
  mo_energy =
[-3.27721176e+01 -1.92700745e+00 -8.43848789e-01 -8.43848789e-01
 -8.43848789e-01  1.03045480e+00  1.03045480e+00  1.03045480e+00
  1.57056482e+00  4.92654798e+00  4.92654798e+00  4.92654798e+00
  8.28431042e+00  1.85904221e+01  1.85904221e+01  1.85904221e+01
  3.55679800e+01  7.72558315e+01  7.72558315e+01  7.72558315e+01
  1.39639690e+02  5.03816210e+02  1.87139656e+03  8.00093490e+03
  4.77684220e+04]
E1 = -182.58547127187538  E_coul = 54.061897913652565
cycle= 4 E= -128.523573358223  delta_E= -1.11e-08  |g|= 4.66e-05  |ddm|= 0.000157
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.11677e-05
diis-c [-3.86026183e-10  1.01669864e-04  2.67215267e-04 -1.03994354e-01
  1.10362547e+00]
  HOMO = -0.843872989495266  LUMO = 1.03044461357805
  mo_energy =
[-3.27721569e+01 -1.92703535e+00 -8.43872989e-01 -8.43872989e-01
 -8.43872989e-01  1.03044461e+00  1.03044461e+00  1.03044461e+00
  1.57054608e+00  4.92652124e+00  4.92652124e+00  4.92652124e+00
  8.28427948e+00  1.85903858e+01  1.85903858e+01  1.85903858e+01
  3.55679417e+01  7.72557924e+01  7.72557924e+01  7.72557924e+01
  1.39639651e+02  5.03816173e+02  1.87139653e+03  8.00093487e+03
  4.77684220e+04]
E1 = -182.58554050468848  E_coul = 54.06196714630876
cycle= 5 E= -128.52357335838  delta_E= -1.57e-10  |g|= 2.52e-06  |ddm|= 1.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58554050468848  E_coul = 54.06196714630876
  HOMO = -0.843871712944464  LUMO = 1.03044502026733
  mo_energy =
[-3.27721536e+01 -1.92703438e+00 -8.43871713e-01 -8.43871713e-01
 -8.43871713e-01  1.03044502e+00  1.03044502e+00  1.03044502e+00
  1.57054649e+00  4.92652254e+00  4.92652254e+00  4.92652254e+00
  8.28428087e+00  1.85903881e+01  1.85903881e+01  1.85903881e+01
  3.55679443e+01  7.72557955e+01  7.72557955e+01  7.72557955e+01
  1.39639655e+02  5.03816176e+02  1.87139653e+03  8.00093487e+03
  4.77684220e+04]
E1 = -182.58553182710273  E_coul = 54.06195846872202
Extra cycle  E= -128.523573358381  delta_E= -9.66e-13  |g|= 1.24e-06  |ddm|= 1.16e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 485.1275257694075
E1 = -182.58553182710273  E_coul = 54.06195846872202
init E= -128.523573358381
    CPU time for initialize scf      0.22 sec, wall time      0.24 sec
  HOMO = -0.843872310406224  LUMO = 1.03044481881471
  mo_energy =
[-3.27721554e+01 -1.92703509e+00 -8.43872310e-01 -8.43872310e-01
 -8.43872310e-01  1.03044482e+00  1.03044482e+00  1.03044482e+00
  1.57054614e+00  4.92652190e+00  4.92652190e+00  4.92652190e+00
  8.28428009e+00  1.85903869e+01  1.85903869e+01  1.85903869e+01
  3.55679429e+01  7.72557938e+01  7.72557938e+01  7.72557938e+01
  1.39639653e+02  5.03816174e+02  1.87139653e+03  8.00093487e+03
  4.77684220e+04]
E1 = -182.5855360597344  E_coul = 54.06196270135386
cycle= 1 E= -128.523573358381  delta_E= 1.71e-13  |g|= 5.74e-07  |ddm|= 5.07e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5855360597344  E_coul = 54.06196270135386
  HOMO = -0.843872009589214  LUMO = 1.03044491645715
  mo_energy =
[-3.27721545e+01 -1.92703479e+00 -8.43872010e-01 -8.43872010e-01
 -8.43872010e-01  1.03044492e+00  1.03044492e+00  1.03044492e+00
  1.57054628e+00  4.92652222e+00  4.92652222e+00  4.92652222e+00
  8.28428045e+00  1.85903875e+01  1.85903875e+01  1.85903875e+01
  3.55679436e+01  7.72557947e+01  7.72557947e+01  7.72557947e+01
  1.39639654e+02  5.03816175e+02  1.87139653e+03  8.00093487e+03
  4.77684220e+04]
E1 = -182.58553390558583  E_coul = 54.0619605472052
Extra cycle  E= -128.523573358381  delta_E= -1.14e-13  |g|= 2.95e-07  |ddm|= 2e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.30 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272462e+02 2.35721458e+02
 7.64821978e+01 9.99413792e+00 2.71571436e+01 4.70250279e-01
 2.71332828e+00 1.40420564e+00 2.97020064e+00 9.29925104e+00
 3.48102612e+01 3.22466648e-01 1.03255058e+00]
grad_E = [-1.02521834e-09  5.42519155e-08 -1.08307927e-06  1.31566862e-05
 -1.02140958e-04 -1.23251795e-03  5.23024842e-04  1.04212083e-02
 -7.31320017e-04  2.99999121e-03 -1.75070659e-02  4.71557009e-03
 -1.29288077e-03  2.70447547e-03  2.94994641e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439573        1
[INPUT] 0    0    [1    /1   ]  833.272480163        1
[INPUT] 0    0    [1    /1   ]  235.721261242        1
[INPUT] 0    0    [1    /1   ]  76.4831509909        1
[INPUT] 0    0    [1    /1   ]  9.92177604497        1
[INPUT] 0    0    [1    /1   ]  27.1621646878        1
[INPUT] 0    0    [1    /1   ]  0.500022566734       1
[INPUT] 0    0    [1    /1   ]  2.53997781432        1
[INPUT] 0    0    [1    /1   ]  1.56895997338        1
[INPUT] 1    0    [1    /1   ]  3.17658165103        1
[INPUT] 1    0    [1    /1   ]  10.1536406956        1
[INPUT] 1    0    [1    /1   ]  38.675231592         1
[INPUT] 1    0    [1    /1   ]  0.315221285021       1
[INPUT] 1    0    [1    /1   ]  1.04223839509        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131447394, 1.0]], [0, [3661.4543957289097, 1.0]], [0, [833.2724801630258, 1.0]], [0, [235.7212612420237, 1.0]], [0, [76.48315099093391, 1.0]], [0, [9.921776044970532, 1.0]], [0, [27.162164687782614, 1.0]], [0, [0.5000225667342515, 1.0]], [0, [2.5399778143222838, 1.0]], [0, [1.5689599733794808, 1.0]], [1, [3.1765816510325164, 1.0]], [1, [10.153640695644826, 1.0]], [1, [38.675231592003804, 1.0]], [1, [0.31522128502084795, 1.0]], [1, [1.0422383950921983, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439573]
bas 2, expnt(s) = [833.27248016]
bas 3, expnt(s) = [235.72126124]
bas 4, expnt(s) = [76.48315099]
bas 5, expnt(s) = [9.92177604]
bas 6, expnt(s) = [27.16216469]
bas 7, expnt(s) = [0.50002257]
bas 8, expnt(s) = [2.53997781]
bas 9, expnt(s) = [1.56895997]
bas 10, expnt(s) = [3.17658165]
bas 11, expnt(s) = [10.1536407]
bas 12, expnt(s) = [38.67523159]
bas 13, expnt(s) = [0.31522129]
bas 14, expnt(s) = [1.0422384]
CPU time:       100.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272480e+02 3.91836874e+02 2.35721261e+02 1.51989677e+02
 7.64831510e+01 6.53415381e+01 9.92177604e+00 1.41239798e+01
 2.71621647e+01 3.00599537e+01 5.00022567e-01 1.50230194e+00
 2.53997781e+00 5.08320315e+00 1.56895997e+00 3.54179909e+00
 3.17658165e+00 1.23718436e+01 1.01536407e+01 5.28763698e+01
 3.86752316e+01 2.81368546e+02 3.15221285e-01 6.89054878e-01
 1.04223840e+00 3.07215574e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998393636062062
cond(S) = 742.989841020378
E1 = -183.5704615223356  E_coul = 55.0788499071063
init E= -128.491611615229
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773259009707947  LUMO = 1.03665808699325
  mo_energy =
[-3.25554352e+01 -1.85155245e+00 -7.73259010e-01 -7.73259010e-01
 -7.73259010e-01  1.03665809e+00  1.03665809e+00  1.03665809e+00
  1.75224654e+00  5.12673710e+00  5.12673710e+00  5.12673710e+00
  8.66307930e+00  2.01195647e+01  2.01195647e+01  2.01195647e+01
  3.57722385e+01  8.61822569e+01  8.61822569e+01  8.61822569e+01
  1.39688542e+02  5.03865020e+02  1.87148767e+03  8.00107297e+03
  4.77686063e+04]
E1 = -182.10110483863377  E_coul = 53.57860514293547
cycle= 1 E= -128.522499695698  delta_E= -0.0309  |g|= 0.202  |ddm|= 0.195
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.465083
diis-c [-0.2163026  1.       ]
  HOMO = -0.87858677072523  LUMO = 1.00242095847538
  mo_energy =
[-3.28759582e+01 -1.96277277e+00 -8.78586771e-01 -8.78586771e-01
 -8.78586771e-01  1.00242096e+00  1.00242096e+00  1.00242096e+00
  1.69545984e+00  5.01042035e+00  5.01042035e+00  5.01042035e+00
  8.53234954e+00  1.99008060e+01  1.99008060e+01  1.99008060e+01
  3.55311200e+01  8.58754011e+01  8.58754011e+01  8.58754011e+01
  1.39373699e+02  5.03506128e+02  1.87109298e+03  8.00064949e+03
  4.77681640e+04]
E1 = -182.83578148865453  E_coul = 54.310752014142295
cycle= 2 E= -128.525029474512  delta_E= -0.00253  |g|=  0.1  |ddm|= 0.071
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.232181
diis-c [-6.11513117e-04  3.32036712e-01  6.67963288e-01]
  HOMO = -0.8441173347076  LUMO = 1.0136930215538
  mo_energy =
[-3.27706243e+01 -1.92642235e+00 -8.44117335e-01 -8.44117335e-01
 -8.44117335e-01  1.01369302e+00  1.01369302e+00  1.01369302e+00
  1.71373967e+00  5.04832017e+00  5.04832017e+00  5.04832017e+00
  8.57509938e+00  1.99728750e+01  1.99728750e+01  1.99728750e+01
  3.56109123e+01  8.59761126e+01  8.59761126e+01  8.59761126e+01
  1.39476965e+02  5.03620082e+02  1.87121212e+03  8.00077106e+03
  4.77682865e+04]
E1 = -182.58966662560462  E_coul = 54.063784249078374
cycle= 3 E= -128.525882376526  delta_E= -0.000853  |g|= 0.000429  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00076201
diis-c [-4.84075987e-08 -2.06981170e-03 -1.01120242e-03  1.00308101e+00]
  HOMO = -0.844332777033815  LUMO = 1.01365144837762
  mo_energy =
[-3.27710290e+01 -1.92664315e+00 -8.44332777e-01 -8.44332777e-01
 -8.44332777e-01  1.01365145e+00  1.01365145e+00  1.01365145e+00
  1.71362696e+00  5.04814011e+00  5.04814011e+00  5.04814011e+00
  8.57488858e+00  1.99725747e+01  1.99725747e+01  1.99725747e+01
  3.56105941e+01  8.59757201e+01  8.59757201e+01  8.59757201e+01
  1.39476566e+02  5.03619607e+02  1.87121156e+03  8.00077043e+03
  4.77682858e+04]
E1 = -182.59010555574915  E_coul = 54.06422316694061
cycle= 4 E= -128.525882388809  delta_E= -1.23e-08  |g|= 4.68e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.59245e-05
diis-c [-5.47470113e-10  1.35760227e-04  2.19796741e-04 -1.22419474e-01
  1.12206392e+00]
  HOMO = -0.8443562659249  LUMO = 1.01364151032727
  mo_energy =
[-3.27710675e+01 -1.92667238e+00 -8.44356266e-01 -8.44356266e-01
 -8.44356266e-01  1.01364151e+00  1.01364151e+00  1.01364151e+00
  1.71360656e+00  5.04811322e+00  5.04811322e+00  5.04811322e+00
  8.57485745e+00  1.99725383e+01  1.99725383e+01  1.99725383e+01
  3.56105561e+01  8.59756816e+01  8.59756816e+01  8.59756816e+01
  1.39476528e+02  5.03619571e+02  1.87121153e+03  8.00077040e+03
  4.77682858e+04]
E1 = -182.5901728172188  E_coul = 54.06429042823843
cycle= 5 E= -128.52588238898  delta_E= -1.72e-10  |g|= 3.74e-06  |ddm|= 1.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5901728172188  E_coul = 54.06429042823843
  HOMO = -0.84435423506489  LUMO = 1.01364218089702
  mo_energy =
[-3.27710625e+01 -1.92667078e+00 -8.44354235e-01 -8.44354235e-01
 -8.44354235e-01  1.01364218e+00  1.01364218e+00  1.01364218e+00
  1.71360737e+00  5.04811540e+00  5.04811540e+00  5.04811540e+00
  8.57485969e+00  1.99725420e+01  1.99725420e+01  1.99725420e+01
  3.56105601e+01  8.59756865e+01  8.59756865e+01  8.59756865e+01
  1.39476533e+02  5.03619576e+02  1.87121153e+03  8.00077041e+03
  4.77682858e+04]
E1 = -182.59016018741164  E_coul = 54.064277798429686
Extra cycle  E= -128.525882388982  delta_E= -1.59e-12  |g|= 1.81e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272480e+02 2.35721261e+02
 7.64831510e+01 9.92177604e+00 2.71621647e+01 5.00022567e-01
 2.53997781e+00 1.56895997e+00 3.17658165e+00 1.01536407e+01
 3.86752316e+01 3.15221285e-01 1.04223840e+00]
E = -128.52588238898196
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439573        1
[INPUT] 0    0    [1    /1   ]  833.272480163        1
[INPUT] 0    0    [1    /1   ]  235.721261242        1
[INPUT] 0    0    [1    /1   ]  76.4831509909        1
[INPUT] 0    0    [1    /1   ]  9.92177604497        1
[INPUT] 0    0    [1    /1   ]  27.1621646878        1
[INPUT] 0    0    [1    /1   ]  0.500022566734       1
[INPUT] 0    0    [1    /1   ]  2.53997781432        1
[INPUT] 0    0    [1    /1   ]  1.56895997338        1
[INPUT] 1    0    [1    /1   ]  3.17658165103        1
[INPUT] 1    0    [1    /1   ]  10.1536406956        1
[INPUT] 1    0    [1    /1   ]  38.675231592         1
[INPUT] 1    0    [1    /1   ]  0.315221285021       1
[INPUT] 1    0    [1    /1   ]  1.04223839509        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131447394, 1.0]], [0, [3661.4543957289097, 1.0]], [0, [833.2724801630258, 1.0]], [0, [235.7212612420237, 1.0]], [0, [76.48315099093391, 1.0]], [0, [9.921776044970532, 1.0]], [0, [27.162164687782614, 1.0]], [0, [0.5000225667342515, 1.0]], [0, [2.5399778143222838, 1.0]], [0, [1.5689599733794808, 1.0]], [1, [3.1765816510325164, 1.0]], [1, [10.153640695644826, 1.0]], [1, [38.675231592003804, 1.0]], [1, [0.31522128502084795, 1.0]], [1, [1.0422383950921983, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439573]
bas 2, expnt(s) = [833.27248016]
bas 3, expnt(s) = [235.72126124]
bas 4, expnt(s) = [76.48315099]
bas 5, expnt(s) = [9.92177604]
bas 6, expnt(s) = [27.16216469]
bas 7, expnt(s) = [0.50002257]
bas 8, expnt(s) = [2.53997781]
bas 9, expnt(s) = [1.56895997]
bas 10, expnt(s) = [3.17658165]
bas 11, expnt(s) = [10.1536407]
bas 12, expnt(s) = [38.67523159]
bas 13, expnt(s) = [0.31522129]
bas 14, expnt(s) = [1.0422384]
CPU time:       100.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272480e+02 3.91836874e+02 2.35721261e+02 1.51989677e+02
 7.64831510e+01 6.53415381e+01 9.92177604e+00 1.41239798e+01
 2.71621647e+01 3.00599537e+01 5.00022567e-01 1.50230194e+00
 2.53997781e+00 5.08320315e+00 1.56895997e+00 3.54179909e+00
 3.17658165e+00 1.23718436e+01 1.01536407e+01 5.28763698e+01
 3.86752316e+01 2.81368546e+02 3.15221285e-01 6.89054878e-01
 1.04223840e+00 3.07215574e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998393636062062
cond(S) = 742.989841020378
E1 = -183.5704615223356  E_coul = 55.0788499071063
init E= -128.491611615229
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773259009707947  LUMO = 1.03665808699325
  mo_energy =
[-3.25554352e+01 -1.85155245e+00 -7.73259010e-01 -7.73259010e-01
 -7.73259010e-01  1.03665809e+00  1.03665809e+00  1.03665809e+00
  1.75224654e+00  5.12673710e+00  5.12673710e+00  5.12673710e+00
  8.66307930e+00  2.01195647e+01  2.01195647e+01  2.01195647e+01
  3.57722385e+01  8.61822569e+01  8.61822569e+01  8.61822569e+01
  1.39688542e+02  5.03865020e+02  1.87148767e+03  8.00107297e+03
  4.77686063e+04]
E1 = -182.10110483863377  E_coul = 53.57860514293547
cycle= 1 E= -128.522499695698  delta_E= -0.0309  |g|= 0.202  |ddm|= 0.195
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.465083
diis-c [-0.2163026  1.       ]
  HOMO = -0.87858677072523  LUMO = 1.00242095847538
  mo_energy =
[-3.28759582e+01 -1.96277277e+00 -8.78586771e-01 -8.78586771e-01
 -8.78586771e-01  1.00242096e+00  1.00242096e+00  1.00242096e+00
  1.69545984e+00  5.01042035e+00  5.01042035e+00  5.01042035e+00
  8.53234954e+00  1.99008060e+01  1.99008060e+01  1.99008060e+01
  3.55311200e+01  8.58754011e+01  8.58754011e+01  8.58754011e+01
  1.39373699e+02  5.03506128e+02  1.87109298e+03  8.00064949e+03
  4.77681640e+04]
E1 = -182.83578148865453  E_coul = 54.310752014142295
cycle= 2 E= -128.525029474512  delta_E= -0.00253  |g|=  0.1  |ddm|= 0.071
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.232181
diis-c [-6.11513117e-04  3.32036712e-01  6.67963288e-01]
  HOMO = -0.8441173347076  LUMO = 1.0136930215538
  mo_energy =
[-3.27706243e+01 -1.92642235e+00 -8.44117335e-01 -8.44117335e-01
 -8.44117335e-01  1.01369302e+00  1.01369302e+00  1.01369302e+00
  1.71373967e+00  5.04832017e+00  5.04832017e+00  5.04832017e+00
  8.57509938e+00  1.99728750e+01  1.99728750e+01  1.99728750e+01
  3.56109123e+01  8.59761126e+01  8.59761126e+01  8.59761126e+01
  1.39476965e+02  5.03620082e+02  1.87121212e+03  8.00077106e+03
  4.77682865e+04]
E1 = -182.58966662560462  E_coul = 54.063784249078374
cycle= 3 E= -128.525882376526  delta_E= -0.000853  |g|= 0.000429  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00076201
diis-c [-4.84075987e-08 -2.06981170e-03 -1.01120242e-03  1.00308101e+00]
  HOMO = -0.844332777033815  LUMO = 1.01365144837762
  mo_energy =
[-3.27710290e+01 -1.92664315e+00 -8.44332777e-01 -8.44332777e-01
 -8.44332777e-01  1.01365145e+00  1.01365145e+00  1.01365145e+00
  1.71362696e+00  5.04814011e+00  5.04814011e+00  5.04814011e+00
  8.57488858e+00  1.99725747e+01  1.99725747e+01  1.99725747e+01
  3.56105941e+01  8.59757201e+01  8.59757201e+01  8.59757201e+01
  1.39476566e+02  5.03619607e+02  1.87121156e+03  8.00077043e+03
  4.77682858e+04]
E1 = -182.59010555574915  E_coul = 54.06422316694061
cycle= 4 E= -128.525882388809  delta_E= -1.23e-08  |g|= 4.68e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.59245e-05
diis-c [-5.47470113e-10  1.35760227e-04  2.19796741e-04 -1.22419474e-01
  1.12206392e+00]
  HOMO = -0.8443562659249  LUMO = 1.01364151032727
  mo_energy =
[-3.27710675e+01 -1.92667238e+00 -8.44356266e-01 -8.44356266e-01
 -8.44356266e-01  1.01364151e+00  1.01364151e+00  1.01364151e+00
  1.71360656e+00  5.04811322e+00  5.04811322e+00  5.04811322e+00
  8.57485745e+00  1.99725383e+01  1.99725383e+01  1.99725383e+01
  3.56105561e+01  8.59756816e+01  8.59756816e+01  8.59756816e+01
  1.39476528e+02  5.03619571e+02  1.87121153e+03  8.00077040e+03
  4.77682858e+04]
E1 = -182.5901728172188  E_coul = 54.06429042823843
cycle= 5 E= -128.52588238898  delta_E= -1.72e-10  |g|= 3.74e-06  |ddm|= 1.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5901728172188  E_coul = 54.06429042823843
  HOMO = -0.84435423506489  LUMO = 1.01364218089702
  mo_energy =
[-3.27710625e+01 -1.92667078e+00 -8.44354235e-01 -8.44354235e-01
 -8.44354235e-01  1.01364218e+00  1.01364218e+00  1.01364218e+00
  1.71360737e+00  5.04811540e+00  5.04811540e+00  5.04811540e+00
  8.57485969e+00  1.99725420e+01  1.99725420e+01  1.99725420e+01
  3.56105601e+01  8.59756865e+01  8.59756865e+01  8.59756865e+01
  1.39476533e+02  5.03619576e+02  1.87121153e+03  8.00077041e+03
  4.77682858e+04]
E1 = -182.59016018741164  E_coul = 54.064277798429686
Extra cycle  E= -128.525882388982  delta_E= -1.59e-12  |g|= 1.81e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 742.989841020378
E1 = -182.59016018741164  E_coul = 54.064277798429686
init E= -128.525882388982
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844355100241217  LUMO = 1.01364189222604
  mo_energy =
[-3.27710652e+01 -1.92667180e+00 -8.44355100e-01 -8.44355100e-01
 -8.44355100e-01  1.01364189e+00  1.01364189e+00  1.01364189e+00
  1.71360684e+00  5.04811444e+00  5.04811444e+00  5.04811444e+00
  8.57485856e+00  1.99725402e+01  1.99725402e+01  1.99725402e+01
  3.56105580e+01  8.59756839e+01  8.59756839e+01  8.59756839e+01
  1.39476530e+02  5.03619574e+02  1.87121153e+03  8.00077040e+03
  4.77682858e+04]
E1 = -182.5901664449785  E_coul = 54.0642840559961
cycle= 1 E= -128.525882388982  delta_E= -4.55e-13  |g|= 8.48e-07  |ddm|= 7.83e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5901664449785  E_coul = 54.0642840559961
  HOMO = -0.844354655573711  LUMO = 1.01364203664949
  mo_energy =
[-3.27710638e+01 -1.92667135e+00 -8.44354656e-01 -8.44354656e-01
 -8.44354656e-01  1.01364204e+00  1.01364204e+00  1.01364204e+00
  1.71360706e+00  5.04811492e+00  5.04811492e+00  5.04811492e+00
  8.57485910e+00  1.99725411e+01  1.99725411e+01  1.99725411e+01
  3.56105590e+01  8.59756852e+01  8.59756852e+01  8.59756852e+01
  1.39476531e+02  5.03619575e+02  1.87121153e+03  8.00077041e+03
  4.77682858e+04]
E1 = -182.59016326134176  E_coul = 54.064280872359774
Extra cycle  E= -128.525882388982  delta_E= 4.26e-13  |g|= 4.35e-07  |ddm|= 3.02e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272480e+02 2.35721261e+02
 7.64831510e+01 9.92177604e+00 2.71621647e+01 5.00022567e-01
 2.53997781e+00 1.56895997e+00 3.17658165e+00 1.01536407e+01
 3.86752316e+01 3.15221285e-01 1.04223840e+00]
grad_E = [-1.59369651e-09  8.44557195e-08 -1.68128463e-06  2.05057392e-05
 -1.58209294e-04 -1.86660553e-03  8.17386343e-04  1.29435496e-02
 -5.20674418e-04  3.11656001e-03 -9.65790808e-03  3.12646176e-03
 -8.66539995e-04 -1.79913137e-03  1.56489595e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439494        1
[INPUT] 0    0    [1    /1   ]  833.272495626        1
[INPUT] 0    0    [1    /1   ]  235.72109267         1
[INPUT] 0    0    [1    /1   ]  76.4840588031        1
[INPUT] 0    0    [1    /1   ]  9.87434365375        1
[INPUT] 0    0    [1    /1   ]  27.1643949012        1
[INPUT] 0    0    [1    /1   ]  0.504005814662       1
[INPUT] 0    0    [1    /1   ]  2.4202561388         1
[INPUT] 0    0    [1    /1   ]  1.67895261972        1
[INPUT] 1    0    [1    /1   ]  3.30704706586        1
[INPUT] 1    0    [1    /1   ]  10.6386309375        1
[INPUT] 1    0    [1    /1   ]  41.3764869642        1
[INPUT] 1    0    [1    /1   ]  0.311110002274       1
[INPUT] 1    0    [1    /1   ]  1.04754105876        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413146009, 1.0]], [0, [3661.45439494333, 1.0]], [0, [833.2724956263351, 1.0]], [0, [235.72109266990282, 1.0]], [0, [76.48405880312448, 1.0]], [0, [9.874343653745886, 1.0]], [0, [27.16439490119854, 1.0]], [0, [0.5040058146617691, 1.0]], [0, [2.4202561387978547, 1.0]], [0, [1.678952619715846, 1.0]], [1, [3.3070470658609055, 1.0]], [1, [10.6386309374508, 1.0]], [1, [41.37648696417276, 1.0]], [1, [0.3111100022740795, 1.0]], [1, [1.0475410587629528, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413146]
bas 1, expnt(s) = [3661.45439494]
bas 2, expnt(s) = [833.27249563]
bas 3, expnt(s) = [235.72109267]
bas 4, expnt(s) = [76.4840588]
bas 5, expnt(s) = [9.87434365]
bas 6, expnt(s) = [27.1643949]
bas 7, expnt(s) = [0.50400581]
bas 8, expnt(s) = [2.42025614]
bas 9, expnt(s) = [1.67895262]
bas 10, expnt(s) = [3.30704707]
bas 11, expnt(s) = [10.63863094]
bas 12, expnt(s) = [41.37648696]
bas 13, expnt(s) = [0.31111]
bas 14, expnt(s) = [1.04754106]
CPU time:       103.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272496e+02 3.91836880e+02 2.35721093e+02 1.51989595e+02
 7.64840588e+01 6.53421198e+01 9.87434365e+00 1.40733083e+01
 2.71643949e+01 3.00618048e+01 5.04005815e-01 1.51126869e+00
 2.42025614e+00 4.90242572e+00 1.67895262e+00 3.72643761e+00
 3.30704707e+00 1.30102266e+01 1.06386309e+01 5.60520591e+01
 4.13764870e+01 3.06144464e+02 3.11110002e-01 6.77839480e-01
 1.04754106e+00 3.09170615e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998412772671154
cond(S) = 1152.9028498335304
E1 = -183.5694020574886  E_coul = 55.07788204422679
init E= -128.491520013262
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773613910838024  LUMO = 1.02604052081897
  mo_energy =
[-3.25555147e+01 -1.85136978e+00 -7.73613911e-01 -7.73613911e-01
 -7.73613911e-01  1.02604052e+00  1.02604052e+00  1.02604052e+00
  1.79567966e+00  5.20622516e+00  5.20622516e+00  5.20622516e+00
  8.75074171e+00  2.09561380e+01  2.09561380e+01  2.09561380e+01
  3.57050877e+01  9.19729248e+01  9.19729248e+01  9.19729248e+01
  1.39502374e+02  5.03666453e+02  1.87130448e+03  8.00091077e+03
  4.77684720e+04]
E1 = -182.0951100520059  E_coul = 53.571720445632195
cycle= 1 E= -128.523389606374  delta_E= -0.0319  |g|= 0.203  |ddm|= 0.255
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463184
diis-c [-0.21453977  1.        ]
  HOMO = -0.879537665616717  LUMO = 0.991736790671449
  mo_energy =
[-3.28767612e+01 -1.96302553e+00 -8.79537666e-01 -8.79537666e-01
 -8.79537666e-01  9.91736791e-01  9.91736791e-01  9.91736791e-01
  1.73759791e+00  5.08645280e+00  5.08645280e+00  5.08645280e+00
  8.61947864e+00  2.07322204e+01  2.07322204e+01  2.07322204e+01
  3.54636299e+01  9.16620913e+01  9.16620913e+01  9.16620913e+01
  1.39186778e+02  5.03306583e+02  1.87090858e+03  8.00048598e+03
  4.77680283e+04]
E1 = -182.83367067583882  E_coul = 54.30773426915749
cycle= 2 E= -128.525936406681  delta_E= -0.00255  |g|= 0.101  |ddm|= 0.0722
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231332
diis-c [-6.05108913e-04  3.32135124e-01  6.67864876e-01]
  HOMO = -0.844890267427611  LUMO = 1.00305036104778
  mo_energy =
[-3.27709091e+01 -1.92646675e+00 -8.44890267e-01 -8.44890267e-01
 -8.44890267e-01  1.00305036e+00  1.00305036e+00  1.00305036e+00
  1.75635706e+00  5.12550375e+00  5.12550375e+00  5.12550375e+00
  8.66240712e+00  2.08060955e+01  2.08060955e+01  2.08060955e+01
  3.55436659e+01  9.17643038e+01  9.17643038e+01  9.17643038e+01
  1.39290535e+02  5.03421078e+02  1.87102827e+03  8.00060810e+03
  4.77681513e+04]
E1 = -182.58607554410057  E_coul = 54.05927709896219
cycle= 3 E= -128.526798445138  delta_E= -0.000862  |g|= 0.000429  |ddm|= 0.0251
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000841146
diis-c [-3.51471775e-08 -2.00842592e-03 -4.74774828e-04  1.00248320e+00]
  HOMO = -0.845109884539845  LUMO = 1.00301203336128
  mo_energy =
[-3.27713282e+01 -1.92667099e+00 -8.45109885e-01 -8.45109885e-01
 -8.45109885e-01  1.00301203e+00  1.00301203e+00  1.00301203e+00
  1.75625784e+00  5.12531984e+00  5.12531984e+00  5.12531984e+00
  8.66220029e+00  2.08057836e+01  2.08057836e+01  2.08057836e+01
  3.55433419e+01  9.17638934e+01  9.17638934e+01  9.17638934e+01
  1.39290119e+02  5.03420573e+02  1.87102767e+03  8.00060742e+03
  4.77681506e+04]
E1 = -182.58659489872824  E_coul = 54.05979644207945
cycle= 4 E= -128.526798456649  delta_E= -1.15e-08  |g|= 4.51e-05  |ddm|= 0.000237
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.92308e-05
diis-c [-2.18391657e-10  6.10402775e-05  2.41492096e-04 -8.14125791e-02
  1.08111005e+00]
  HOMO = -0.845133434970482  LUMO = 1.00300271309533
  mo_energy =
[-3.27713689e+01 -1.92669568e+00 -8.45133435e-01 -8.45133435e-01
 -8.45133435e-01  1.00300271e+00  1.00300271e+00  1.00300271e+00
  1.75624090e+00  5.12529313e+00  5.12529313e+00  5.12529313e+00
  8.66217133e+00  2.08057467e+01  2.08057467e+01  2.08057467e+01
  3.55433039e+01  9.17638530e+01  9.17638530e+01  9.17638530e+01
  1.39290079e+02  5.03420532e+02  1.87102762e+03  8.00060738e+03
  4.77681506e+04]
E1 = -182.5866755362596  E_coul = 54.05987707947029
cycle= 5 E= -128.526798456789  delta_E= -1.41e-10  |g|= 1.3e-06  |ddm|= 1.81e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5866755362596  E_coul = 54.05987707947029
  HOMO = -0.845132826689959  LUMO = 1.00300289188958
  mo_energy =
[-3.27713671e+01 -1.92669513e+00 -8.45132827e-01 -8.45132827e-01
 -8.45132827e-01  1.00300289e+00  1.00300289e+00  1.00300289e+00
  1.75624113e+00  5.12529380e+00  5.12529380e+00  5.12529380e+00
  8.66217206e+00  2.08057480e+01  2.08057480e+01  2.08057480e+01
  3.55433054e+01  9.17638547e+01  9.17638547e+01  9.17638547e+01
  1.39290081e+02  5.03420533e+02  1.87102763e+03  8.00060738e+03
  4.77681506e+04]
E1 = -182.58667039304763  E_coul = 54.05987193625812
Extra cycle  E= -128.526798456789  delta_E= -1.71e-13  |g|= 7.03e-07  |ddm|= 5.89e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272496e+02 2.35721093e+02
 7.64840588e+01 9.87434365e+00 2.71643949e+01 5.04005815e-01
 2.42025614e+00 1.67895262e+00 3.30704707e+00 1.06386309e+01
 4.13764870e+01 3.11110002e-01 1.04754106e+00]
E = -128.5267984567895
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439494        1
[INPUT] 0    0    [1    /1   ]  833.272495626        1
[INPUT] 0    0    [1    /1   ]  235.72109267         1
[INPUT] 0    0    [1    /1   ]  76.4840588031        1
[INPUT] 0    0    [1    /1   ]  9.87434365375        1
[INPUT] 0    0    [1    /1   ]  27.1643949012        1
[INPUT] 0    0    [1    /1   ]  0.504005814662       1
[INPUT] 0    0    [1    /1   ]  2.4202561388         1
[INPUT] 0    0    [1    /1   ]  1.67895261972        1
[INPUT] 1    0    [1    /1   ]  3.30704706586        1
[INPUT] 1    0    [1    /1   ]  10.6386309375        1
[INPUT] 1    0    [1    /1   ]  41.3764869642        1
[INPUT] 1    0    [1    /1   ]  0.311110002274       1
[INPUT] 1    0    [1    /1   ]  1.04754105876        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413146009, 1.0]], [0, [3661.45439494333, 1.0]], [0, [833.2724956263351, 1.0]], [0, [235.72109266990282, 1.0]], [0, [76.48405880312448, 1.0]], [0, [9.874343653745886, 1.0]], [0, [27.16439490119854, 1.0]], [0, [0.5040058146617691, 1.0]], [0, [2.4202561387978547, 1.0]], [0, [1.678952619715846, 1.0]], [1, [3.3070470658609055, 1.0]], [1, [10.6386309374508, 1.0]], [1, [41.37648696417276, 1.0]], [1, [0.3111100022740795, 1.0]], [1, [1.0475410587629528, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413146]
bas 1, expnt(s) = [3661.45439494]
bas 2, expnt(s) = [833.27249563]
bas 3, expnt(s) = [235.72109267]
bas 4, expnt(s) = [76.4840588]
bas 5, expnt(s) = [9.87434365]
bas 6, expnt(s) = [27.1643949]
bas 7, expnt(s) = [0.50400581]
bas 8, expnt(s) = [2.42025614]
bas 9, expnt(s) = [1.67895262]
bas 10, expnt(s) = [3.30704707]
bas 11, expnt(s) = [10.63863094]
bas 12, expnt(s) = [41.37648696]
bas 13, expnt(s) = [0.31111]
bas 14, expnt(s) = [1.04754106]
CPU time:       104.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272496e+02 3.91836880e+02 2.35721093e+02 1.51989595e+02
 7.64840588e+01 6.53421198e+01 9.87434365e+00 1.40733083e+01
 2.71643949e+01 3.00618048e+01 5.04005815e-01 1.51126869e+00
 2.42025614e+00 4.90242572e+00 1.67895262e+00 3.72643761e+00
 3.30704707e+00 1.30102266e+01 1.06386309e+01 5.60520591e+01
 4.13764870e+01 3.06144464e+02 3.11110002e-01 6.77839480e-01
 1.04754106e+00 3.09170615e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998412772671154
cond(S) = 1152.9028498335304
E1 = -183.5694020574886  E_coul = 55.07788204422679
init E= -128.491520013262
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773613910838024  LUMO = 1.02604052081897
  mo_energy =
[-3.25555147e+01 -1.85136978e+00 -7.73613911e-01 -7.73613911e-01
 -7.73613911e-01  1.02604052e+00  1.02604052e+00  1.02604052e+00
  1.79567966e+00  5.20622516e+00  5.20622516e+00  5.20622516e+00
  8.75074171e+00  2.09561380e+01  2.09561380e+01  2.09561380e+01
  3.57050877e+01  9.19729248e+01  9.19729248e+01  9.19729248e+01
  1.39502374e+02  5.03666453e+02  1.87130448e+03  8.00091077e+03
  4.77684720e+04]
E1 = -182.0951100520059  E_coul = 53.571720445632195
cycle= 1 E= -128.523389606374  delta_E= -0.0319  |g|= 0.203  |ddm|= 0.255
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463184
diis-c [-0.21453977  1.        ]
  HOMO = -0.879537665616717  LUMO = 0.991736790671449
  mo_energy =
[-3.28767612e+01 -1.96302553e+00 -8.79537666e-01 -8.79537666e-01
 -8.79537666e-01  9.91736791e-01  9.91736791e-01  9.91736791e-01
  1.73759791e+00  5.08645280e+00  5.08645280e+00  5.08645280e+00
  8.61947864e+00  2.07322204e+01  2.07322204e+01  2.07322204e+01
  3.54636299e+01  9.16620913e+01  9.16620913e+01  9.16620913e+01
  1.39186778e+02  5.03306583e+02  1.87090858e+03  8.00048598e+03
  4.77680283e+04]
E1 = -182.83367067583882  E_coul = 54.30773426915749
cycle= 2 E= -128.525936406681  delta_E= -0.00255  |g|= 0.101  |ddm|= 0.0722
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231332
diis-c [-6.05108913e-04  3.32135124e-01  6.67864876e-01]
  HOMO = -0.844890267427611  LUMO = 1.00305036104778
  mo_energy =
[-3.27709091e+01 -1.92646675e+00 -8.44890267e-01 -8.44890267e-01
 -8.44890267e-01  1.00305036e+00  1.00305036e+00  1.00305036e+00
  1.75635706e+00  5.12550375e+00  5.12550375e+00  5.12550375e+00
  8.66240712e+00  2.08060955e+01  2.08060955e+01  2.08060955e+01
  3.55436659e+01  9.17643038e+01  9.17643038e+01  9.17643038e+01
  1.39290535e+02  5.03421078e+02  1.87102827e+03  8.00060810e+03
  4.77681513e+04]
E1 = -182.58607554410057  E_coul = 54.05927709896219
cycle= 3 E= -128.526798445138  delta_E= -0.000862  |g|= 0.000429  |ddm|= 0.0251
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000841146
diis-c [-3.51471775e-08 -2.00842592e-03 -4.74774828e-04  1.00248320e+00]
  HOMO = -0.845109884539845  LUMO = 1.00301203336128
  mo_energy =
[-3.27713282e+01 -1.92667099e+00 -8.45109885e-01 -8.45109885e-01
 -8.45109885e-01  1.00301203e+00  1.00301203e+00  1.00301203e+00
  1.75625784e+00  5.12531984e+00  5.12531984e+00  5.12531984e+00
  8.66220029e+00  2.08057836e+01  2.08057836e+01  2.08057836e+01
  3.55433419e+01  9.17638934e+01  9.17638934e+01  9.17638934e+01
  1.39290119e+02  5.03420573e+02  1.87102767e+03  8.00060742e+03
  4.77681506e+04]
E1 = -182.58659489872824  E_coul = 54.05979644207945
cycle= 4 E= -128.526798456649  delta_E= -1.15e-08  |g|= 4.51e-05  |ddm|= 0.000237
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.92308e-05
diis-c [-2.18391657e-10  6.10402775e-05  2.41492096e-04 -8.14125791e-02
  1.08111005e+00]
  HOMO = -0.845133434970482  LUMO = 1.00300271309533
  mo_energy =
[-3.27713689e+01 -1.92669568e+00 -8.45133435e-01 -8.45133435e-01
 -8.45133435e-01  1.00300271e+00  1.00300271e+00  1.00300271e+00
  1.75624090e+00  5.12529313e+00  5.12529313e+00  5.12529313e+00
  8.66217133e+00  2.08057467e+01  2.08057467e+01  2.08057467e+01
  3.55433039e+01  9.17638530e+01  9.17638530e+01  9.17638530e+01
  1.39290079e+02  5.03420532e+02  1.87102762e+03  8.00060738e+03
  4.77681506e+04]
E1 = -182.5866755362596  E_coul = 54.05987707947029
cycle= 5 E= -128.526798456789  delta_E= -1.41e-10  |g|= 1.3e-06  |ddm|= 1.81e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5866755362596  E_coul = 54.05987707947029
  HOMO = -0.845132826689959  LUMO = 1.00300289188958
  mo_energy =
[-3.27713671e+01 -1.92669513e+00 -8.45132827e-01 -8.45132827e-01
 -8.45132827e-01  1.00300289e+00  1.00300289e+00  1.00300289e+00
  1.75624113e+00  5.12529380e+00  5.12529380e+00  5.12529380e+00
  8.66217206e+00  2.08057480e+01  2.08057480e+01  2.08057480e+01
  3.55433054e+01  9.17638547e+01  9.17638547e+01  9.17638547e+01
  1.39290081e+02  5.03420533e+02  1.87102763e+03  8.00060738e+03
  4.77681506e+04]
E1 = -182.58667039304763  E_coul = 54.05987193625812
Extra cycle  E= -128.526798456789  delta_E= -1.71e-13  |g|= 7.03e-07  |ddm|= 5.89e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1152.9028498335304
E1 = -182.58667039304763  E_coul = 54.05987193625812
init E= -128.526798456789
    CPU time for initialize scf      0.24 sec, wall time      0.26 sec
  HOMO = -0.845133190791742  LUMO = 1.00300276901876
  mo_energy =
[-3.27713682e+01 -1.92669553e+00 -8.45133191e-01 -8.45133191e-01
 -8.45133191e-01  1.00300277e+00  1.00300277e+00  1.00300277e+00
  1.75624091e+00  5.12529339e+00  5.12529339e+00  5.12529339e+00
  8.66217159e+00  2.08057473e+01  2.08057473e+01  2.08057473e+01
  3.55433045e+01  9.17638537e+01  9.17638537e+01  9.17638537e+01
  1.39290080e+02  5.03420532e+02  1.87102763e+03  8.00060738e+03
  4.77681506e+04]
E1 = -182.58667286853688  E_coul = 54.05987441174719
cycle= 1 E= -128.52679845679  delta_E= -1.99e-13  |g|= 3.37e-07  |ddm|= 2.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58667286853688  E_coul = 54.05987441174719
  HOMO = -0.845133016297325  LUMO = 1.00300282555973
  mo_energy =
[-3.27713676e+01 -1.92669535e+00 -8.45133016e-01 -8.45133016e-01
 -8.45133016e-01  1.00300283e+00  1.00300283e+00  1.00300283e+00
  1.75624100e+00  5.12529359e+00  5.12529359e+00  5.12529359e+00
  8.66217181e+00  2.08057477e+01  2.08057477e+01  2.08057477e+01
  3.55433049e+01  9.17638542e+01  9.17638542e+01  9.17638542e+01
  1.39290080e+02  5.03420533e+02  1.87102763e+03  8.00060738e+03
  4.77681506e+04]
E1 = -182.58667160390715  E_coul = 54.059873147117386
Extra cycle  E= -128.52679845679  delta_E= -8.53e-14  |g|= 1.72e-07  |ddm|= 1.24e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272496e+02 2.35721093e+02
 7.64840588e+01 9.87434365e+00 2.71643949e+01 5.04005815e-01
 2.42025614e+00 1.67895262e+00 3.30704707e+00 1.06386309e+01
 4.13764870e+01 3.11110002e-01 1.04754106e+00]
grad_E = [-1.97917215e-09  1.05040998e-07 -2.08643399e-06  2.55517005e-05
 -1.96564088e-04 -2.33672426e-03  1.02988262e-03  3.52581151e-03
 -1.58059380e-04  3.86407724e-03 -5.00135674e-04  1.39337742e-03
 -5.82431703e-04  2.52163431e-03 -2.90875543e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.4543943         1
[INPUT] 0    0    [1    /1   ]  833.272508337        1
[INPUT] 0    0    [1    /1   ]  235.720950589        1
[INPUT] 0    0    [1    /1   ]  76.4849015671        1
[INPUT] 0    0    [1    /1   ]  9.84678414666        1
[INPUT] 0    0    [1    /1   ]  27.1645068713        1
[INPUT] 0    0    [1    /1   ]  0.506180195963       1
[INPUT] 0    0    [1    /1   ]  2.34381166055        1
[INPUT] 0    0    [1    /1   ]  1.74062383235        1
[INPUT] 1    0    [1    /1   ]  3.39099045654        1
[INPUT] 1    0    [1    /1   ]  10.8744832961        1
[INPUT] 1    0    [1    /1   ]  43.1388705329        1
[INPUT] 1    0    [1    /1   ]  0.316324361447       1
[INPUT] 1    0    [1    /1   ]  1.07321467878        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131470873, 1.0]], [0, [3661.4543942991636, 1.0]], [0, [833.2725083368666, 1.0]], [0, [235.7209505892911, 1.0]], [0, [76.48490156708415, 1.0]], [0, [9.8467841466649, 1.0]], [0, [27.164506871287344, 1.0]], [0, [0.5061801959632911, 1.0]], [0, [2.343811660547791, 1.0]], [0, [1.7406238323508436, 1.0]], [1, [3.3909904565377804, 1.0]], [1, [10.874483296061277, 1.0]], [1, [43.13887053285336, 1.0]], [1, [0.3163243614469359, 1.0]], [1, [1.0732146787751016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413147]
bas 1, expnt(s) = [3661.4543943]
bas 2, expnt(s) = [833.27250834]
bas 3, expnt(s) = [235.72095059]
bas 4, expnt(s) = [76.48490157]
bas 5, expnt(s) = [9.84678415]
bas 6, expnt(s) = [27.16450687]
bas 7, expnt(s) = [0.5061802]
bas 8, expnt(s) = [2.34381166]
bas 9, expnt(s) = [1.74062383]
bas 10, expnt(s) = [3.39099046]
bas 11, expnt(s) = [10.8744833]
bas 12, expnt(s) = [43.13887053]
bas 13, expnt(s) = [0.31632436]
bas 14, expnt(s) = [1.07321468]
CPU time:       107.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272508e+02 3.91836884e+02 2.35720951e+02 1.51989527e+02
 7.64849016e+01 6.53426598e+01 9.84678415e+00 1.40438389e+01
 2.71645069e+01 3.00618978e+01 5.06180196e-01 1.51615599e+00
 2.34381166e+00 4.78582768e+00 1.74062383e+00 3.82863282e+00
 3.39099046e+00 1.34243295e+01 1.08744833e+01 5.76096426e+01
 4.31388705e+01 3.22530177e+02 3.16324361e-01 6.92070269e-01
 1.07321468e+00 3.18671077e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998284698497171
cond(S) = 1657.7084501117513
E1 = -183.56890040409212  E_coul = 55.07762683446053
init E= -128.491273569632
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773740200556998  LUMO = 1.04965203448959
  mo_energy =
[-3.25555399e+01 -1.85124372e+00 -7.73740201e-01 -7.73740201e-01
 -7.73740201e-01  1.04965203e+00  1.04965203e+00  1.04965203e+00
  1.81411964e+00  5.34808286e+00  5.34808286e+00  5.34808286e+00
  8.77200110e+00  2.15251434e+01  2.15251434e+01  2.15251434e+01
  3.56250086e+01  9.56085301e+01  9.56085301e+01  9.56085301e+01
  1.39354644e+02  5.03514722e+02  1.87116538e+03  8.00078777e+03
  4.77683701e+04]
E1 = -182.10226734395945  E_coul = 53.578481410425525
cycle= 1 E= -128.523785933534  delta_E= -0.0325  |g|= 0.202  |ddm|= 0.321
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.459451
diis-c [-0.211095  1.      ]
  HOMO = -0.879181349800918  LUMO = 1.01455681605806
  mo_energy =
[-3.28753951e+01 -1.96225070e+00 -8.79181350e-01 -8.79181350e-01
 -8.79181350e-01  1.01455682e+00  1.01455682e+00  1.01455682e+00
  1.75604457e+00  5.22662588e+00  5.22662588e+00  5.22662588e+00
  8.64166701e+00  2.13002965e+01  2.13002965e+01  2.13002965e+01
  3.53849219e+01  9.52971715e+01  9.52971715e+01  9.52971715e+01
  1.39040391e+02  5.03156163e+02  1.87077070e+03  8.00036418e+03
  4.77679276e+04]
E1 = -182.83583973430373  E_coul = 54.30952993056586
cycle= 2 E= -128.526309803738  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.0726
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.228884
diis-c [-5.9861414e-04  3.3155900e-01  6.6844100e-01]
  HOMO = -0.844752715742395  LUMO = 1.02612278948936
  mo_energy =
[-3.27701102e+01 -1.92592241e+00 -8.44752716e-01 -8.44752716e-01
 -8.44752716e-01  1.02612279e+00  1.02612279e+00  1.02612279e+00
  1.77480404e+00  5.26618159e+00  5.26618159e+00  5.26618159e+00
  8.68423633e+00  2.13743953e+01  2.13743953e+01  2.13743953e+01
  3.54644192e+01  9.53993969e+01  9.53993969e+01  9.53993969e+01
  1.39143587e+02  5.03270054e+02  1.87088976e+03  8.00048565e+03
  4.77680500e+04]
E1 = -182.5901000530384  E_coul = 54.062939826818756
cycle= 3 E= -128.52716022622  delta_E= -0.00085  |g|= 0.000455  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000923591
diis-c [-3.86195179e-08 -2.02832850e-03 -1.21913552e-04  1.00215024e+00]
  HOMO = -0.844983693951067  LUMO = 1.02607952229598
  mo_energy =
[-3.27705528e+01 -1.92612891e+00 -8.44983694e-01 -8.44983694e-01
 -8.44983694e-01  1.02607952e+00  1.02607952e+00  1.02607952e+00
  1.77470366e+00  5.26598240e+00  5.26598240e+00  5.26598240e+00
  8.68401973e+00  2.13740624e+01  2.13740624e+01  2.13740624e+01
  3.54640771e+01  9.53989609e+01  9.53989609e+01  9.53989609e+01
  1.39143147e+02  5.03269520e+02  1.87088913e+03  8.00048494e+03
  4.77680492e+04]
E1 = -182.59069669621528  E_coul = 54.06353645682081
cycle= 4 E= -128.527160239394  delta_E= -1.32e-08  |g|= 4.66e-05  |ddm|= 0.000349
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.82151e-05
diis-c [-1.98389039e-10  8.02429012e-05  2.66607558e-04 -8.93265998e-02
  1.08897975e+00]
  HOMO = -0.845008028405797  LUMO = 1.02606990675692
  mo_energy =
[-3.27705956e+01 -1.92615230e+00 -8.45008028e-01 -8.45008028e-01
 -8.45008028e-01  1.02606991e+00  1.02606991e+00  1.02606991e+00
  1.77468776e+00  5.26595474e+00  5.26595474e+00  5.26595474e+00
  8.68399090e+00  2.13740242e+01  2.13740242e+01  2.13740242e+01
  3.54640381e+01  9.53989184e+01  9.53989184e+01  9.53989184e+01
  1.39143105e+02  5.03269475e+02  1.87088908e+03  8.00048489e+03
  4.77680492e+04]
E1 = -182.590785141635  E_coul = 54.063624902082154
cycle= 5 E= -128.527160239553  delta_E= -1.58e-10  |g|= 1.43e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.590785141635  E_coul = 54.063624902082154
  HOMO = -0.84500740910915  LUMO = 1.02607012847625
  mo_energy =
[-3.27705940e+01 -1.92615148e+00 -8.45007409e-01 -8.45007409e-01
 -8.45007409e-01  1.02607013e+00  1.02607013e+00  1.02607013e+00
  1.77468822e+00  5.26595546e+00  5.26595546e+00  5.26595546e+00
  8.68399177e+00  2.13740255e+01  2.13740255e+01  2.13740255e+01
  3.54640395e+01  9.53989199e+01  9.53989199e+01  9.53989199e+01
  1.39143106e+02  5.03269476e+02  1.87088908e+03  8.00048489e+03
  4.77680492e+04]
E1 = -182.59078087508584  E_coul = 54.06362063553328
Extra cycle  E= -128.527160239553  delta_E= 2.84e-13  |g|= 5.81e-07  |ddm|= 8.03e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272508e+02 2.35720951e+02
 7.64849016e+01 9.84678415e+00 2.71645069e+01 5.06180196e-01
 2.34381166e+00 1.74062383e+00 3.39099046e+00 1.08744833e+01
 4.31388705e+01 3.16324361e-01 1.07321468e+00]
E = -128.52716023955256
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.4543943         1
[INPUT] 0    0    [1    /1   ]  833.272508337        1
[INPUT] 0    0    [1    /1   ]  235.720950589        1
[INPUT] 0    0    [1    /1   ]  76.4849015671        1
[INPUT] 0    0    [1    /1   ]  9.84678414666        1
[INPUT] 0    0    [1    /1   ]  27.1645068713        1
[INPUT] 0    0    [1    /1   ]  0.506180195963       1
[INPUT] 0    0    [1    /1   ]  2.34381166055        1
[INPUT] 0    0    [1    /1   ]  1.74062383235        1
[INPUT] 1    0    [1    /1   ]  3.39099045654        1
[INPUT] 1    0    [1    /1   ]  10.8744832961        1
[INPUT] 1    0    [1    /1   ]  43.1388705329        1
[INPUT] 1    0    [1    /1   ]  0.316324361447       1
[INPUT] 1    0    [1    /1   ]  1.07321467878        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131470873, 1.0]], [0, [3661.4543942991636, 1.0]], [0, [833.2725083368666, 1.0]], [0, [235.7209505892911, 1.0]], [0, [76.48490156708415, 1.0]], [0, [9.8467841466649, 1.0]], [0, [27.164506871287344, 1.0]], [0, [0.5061801959632911, 1.0]], [0, [2.343811660547791, 1.0]], [0, [1.7406238323508436, 1.0]], [1, [3.3909904565377804, 1.0]], [1, [10.874483296061277, 1.0]], [1, [43.13887053285336, 1.0]], [1, [0.3163243614469359, 1.0]], [1, [1.0732146787751016, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413147]
bas 1, expnt(s) = [3661.4543943]
bas 2, expnt(s) = [833.27250834]
bas 3, expnt(s) = [235.72095059]
bas 4, expnt(s) = [76.48490157]
bas 5, expnt(s) = [9.84678415]
bas 6, expnt(s) = [27.16450687]
bas 7, expnt(s) = [0.5061802]
bas 8, expnt(s) = [2.34381166]
bas 9, expnt(s) = [1.74062383]
bas 10, expnt(s) = [3.39099046]
bas 11, expnt(s) = [10.8744833]
bas 12, expnt(s) = [43.13887053]
bas 13, expnt(s) = [0.31632436]
bas 14, expnt(s) = [1.07321468]
CPU time:       108.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272508e+02 3.91836884e+02 2.35720951e+02 1.51989527e+02
 7.64849016e+01 6.53426598e+01 9.84678415e+00 1.40438389e+01
 2.71645069e+01 3.00618978e+01 5.06180196e-01 1.51615599e+00
 2.34381166e+00 4.78582768e+00 1.74062383e+00 3.82863282e+00
 3.39099046e+00 1.34243295e+01 1.08744833e+01 5.76096426e+01
 4.31388705e+01 3.22530177e+02 3.16324361e-01 6.92070269e-01
 1.07321468e+00 3.18671077e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998284698497171
cond(S) = 1657.7084501117513
E1 = -183.56890040409212  E_coul = 55.07762683446053
init E= -128.491273569632
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773740200556998  LUMO = 1.04965203448959
  mo_energy =
[-3.25555399e+01 -1.85124372e+00 -7.73740201e-01 -7.73740201e-01
 -7.73740201e-01  1.04965203e+00  1.04965203e+00  1.04965203e+00
  1.81411964e+00  5.34808286e+00  5.34808286e+00  5.34808286e+00
  8.77200110e+00  2.15251434e+01  2.15251434e+01  2.15251434e+01
  3.56250086e+01  9.56085301e+01  9.56085301e+01  9.56085301e+01
  1.39354644e+02  5.03514722e+02  1.87116538e+03  8.00078777e+03
  4.77683701e+04]
E1 = -182.10226734395945  E_coul = 53.578481410425525
cycle= 1 E= -128.523785933534  delta_E= -0.0325  |g|= 0.202  |ddm|= 0.321
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.459451
diis-c [-0.211095  1.      ]
  HOMO = -0.879181349800918  LUMO = 1.01455681605806
  mo_energy =
[-3.28753951e+01 -1.96225070e+00 -8.79181350e-01 -8.79181350e-01
 -8.79181350e-01  1.01455682e+00  1.01455682e+00  1.01455682e+00
  1.75604457e+00  5.22662588e+00  5.22662588e+00  5.22662588e+00
  8.64166701e+00  2.13002965e+01  2.13002965e+01  2.13002965e+01
  3.53849219e+01  9.52971715e+01  9.52971715e+01  9.52971715e+01
  1.39040391e+02  5.03156163e+02  1.87077070e+03  8.00036418e+03
  4.77679276e+04]
E1 = -182.83583973430373  E_coul = 54.30952993056586
cycle= 2 E= -128.526309803738  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.0726
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.228884
diis-c [-5.9861414e-04  3.3155900e-01  6.6844100e-01]
  HOMO = -0.844752715742395  LUMO = 1.02612278948936
  mo_energy =
[-3.27701102e+01 -1.92592241e+00 -8.44752716e-01 -8.44752716e-01
 -8.44752716e-01  1.02612279e+00  1.02612279e+00  1.02612279e+00
  1.77480404e+00  5.26618159e+00  5.26618159e+00  5.26618159e+00
  8.68423633e+00  2.13743953e+01  2.13743953e+01  2.13743953e+01
  3.54644192e+01  9.53993969e+01  9.53993969e+01  9.53993969e+01
  1.39143587e+02  5.03270054e+02  1.87088976e+03  8.00048565e+03
  4.77680500e+04]
E1 = -182.5901000530384  E_coul = 54.062939826818756
cycle= 3 E= -128.52716022622  delta_E= -0.00085  |g|= 0.000455  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000923591
diis-c [-3.86195179e-08 -2.02832850e-03 -1.21913552e-04  1.00215024e+00]
  HOMO = -0.844983693951067  LUMO = 1.02607952229598
  mo_energy =
[-3.27705528e+01 -1.92612891e+00 -8.44983694e-01 -8.44983694e-01
 -8.44983694e-01  1.02607952e+00  1.02607952e+00  1.02607952e+00
  1.77470366e+00  5.26598240e+00  5.26598240e+00  5.26598240e+00
  8.68401973e+00  2.13740624e+01  2.13740624e+01  2.13740624e+01
  3.54640771e+01  9.53989609e+01  9.53989609e+01  9.53989609e+01
  1.39143147e+02  5.03269520e+02  1.87088913e+03  8.00048494e+03
  4.77680492e+04]
E1 = -182.59069669621528  E_coul = 54.06353645682081
cycle= 4 E= -128.527160239394  delta_E= -1.32e-08  |g|= 4.66e-05  |ddm|= 0.000349
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.82151e-05
diis-c [-1.98389039e-10  8.02429012e-05  2.66607558e-04 -8.93265998e-02
  1.08897975e+00]
  HOMO = -0.845008028405797  LUMO = 1.02606990675692
  mo_energy =
[-3.27705956e+01 -1.92615230e+00 -8.45008028e-01 -8.45008028e-01
 -8.45008028e-01  1.02606991e+00  1.02606991e+00  1.02606991e+00
  1.77468776e+00  5.26595474e+00  5.26595474e+00  5.26595474e+00
  8.68399090e+00  2.13740242e+01  2.13740242e+01  2.13740242e+01
  3.54640381e+01  9.53989184e+01  9.53989184e+01  9.53989184e+01
  1.39143105e+02  5.03269475e+02  1.87088908e+03  8.00048489e+03
  4.77680492e+04]
E1 = -182.590785141635  E_coul = 54.063624902082154
cycle= 5 E= -128.527160239553  delta_E= -1.58e-10  |g|= 1.43e-06  |ddm|= 2.96e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.590785141635  E_coul = 54.063624902082154
  HOMO = -0.84500740910915  LUMO = 1.02607012847625
  mo_energy =
[-3.27705940e+01 -1.92615148e+00 -8.45007409e-01 -8.45007409e-01
 -8.45007409e-01  1.02607013e+00  1.02607013e+00  1.02607013e+00
  1.77468822e+00  5.26595546e+00  5.26595546e+00  5.26595546e+00
  8.68399177e+00  2.13740255e+01  2.13740255e+01  2.13740255e+01
  3.54640395e+01  9.53989199e+01  9.53989199e+01  9.53989199e+01
  1.39143106e+02  5.03269476e+02  1.87088908e+03  8.00048489e+03
  4.77680492e+04]
E1 = -182.59078087508584  E_coul = 54.06362063553328
Extra cycle  E= -128.527160239553  delta_E= 2.84e-13  |g|= 5.81e-07  |ddm|= 8.03e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1657.7084501117513
E1 = -182.59078087508584  E_coul = 54.06362063553328
init E= -128.527160239553
    CPU time for initialize scf      0.24 sec, wall time      0.35 sec
  HOMO = -0.845007716912775  LUMO = 1.02607002616734
  mo_energy =
[-3.27705949e+01 -1.92615177e+00 -8.45007717e-01 -8.45007717e-01
 -8.45007717e-01  1.02607003e+00  1.02607003e+00  1.02607003e+00
  1.77468807e+00  5.26595511e+00  5.26595511e+00  5.26595511e+00
  8.68399141e+00  2.13740249e+01  2.13740249e+01  2.13740249e+01
  3.54640388e+01  9.53989190e+01  9.53989190e+01  9.53989190e+01
  1.39143105e+02  5.03269475e+02  1.87088908e+03  8.00048489e+03
  4.77680492e+04]
E1 = -182.59078305456438  E_coul = 54.06362281501183
cycle= 1 E= -128.527160239553  delta_E=    0  |g|= 3.01e-07  |ddm|= 2.11e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.59078305456438  E_coul = 54.06362281501183
  HOMO = -0.845007564740593  LUMO = 1.02607007772927
  mo_energy =
[-3.27705944e+01 -1.92615160e+00 -8.45007565e-01 -8.45007565e-01
 -8.45007565e-01  1.02607008e+00  1.02607008e+00  1.02607008e+00
  1.77468816e+00  5.26595529e+00  5.26595529e+00  5.26595529e+00
  8.68399160e+00  2.13740252e+01  2.13740252e+01  2.13740252e+01
  3.54640392e+01  9.53989195e+01  9.53989195e+01  9.53989195e+01
  1.39143106e+02  5.03269476e+02  1.87088908e+03  8.00048489e+03
  4.77680492e+04]
E1 = -182.59078196663594  E_coul = 54.06362172708304
Extra cycle  E= -128.527160239553  delta_E= -3.41e-13  |g|= 1.48e-07  |ddm|= 1.23e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.43 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272508e+02 2.35720951e+02
 7.64849016e+01 9.84678415e+00 2.71645069e+01 5.06180196e-01
 2.34381166e+00 1.74062383e+00 3.39099046e+00 1.08744833e+01
 4.31388705e+01 3.16324361e-01 1.07321468e+00]
grad_E = [-2.18152675e-09  1.15858882e-07 -2.29921980e-06  2.82126627e-05
 -2.16807057e-04 -2.57618736e-03  1.14249910e-03  6.20934255e-05
  1.57942642e-04  3.81010017e-03  1.82838914e-03  4.60601886e-04
 -4.12072947e-04  2.01788286e-03 -3.74793085e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439324        1
[INPUT] 0    0    [1    /1   ]  833.272529269        1
[INPUT] 0    0    [1    /1   ]  235.720713629        1
[INPUT] 0    0    [1    /1   ]  76.4863655148        1
[INPUT] 0    0    [1    /1   ]  9.81030680492        1
[INPUT] 0    0    [1    /1   ]  27.1633177687        1
[INPUT] 0    0    [1    /1   ]  0.513195112589       1
[INPUT] 0    0    [1    /1   ]  2.23374161129        1
[INPUT] 0    0    [1    /1   ]  1.8261655007         1
[INPUT] 1    0    [1    /1   ]  3.44619658676        1
[INPUT] 1    0    [1    /1   ]  11.1258022654        1
[INPUT] 1    0    [1    /1   ]  45.674588172         1
[INPUT] 1    0    [1    /1   ]  0.320306208383       1
[INPUT] 1    0    [1    /1   ]  1.08886325359        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413148891, 1.0]], [0, [3661.454393239108, 1.0]], [0, [833.2725292689734, 1.0]], [0, [235.72071362928443, 1.0]], [0, [76.4863655147513, 1.0]], [0, [9.810306804919163, 1.0]], [0, [27.163317768736256, 1.0]], [0, [0.5131951125892849, 1.0]], [0, [2.233741611293911, 1.0]], [0, [1.8261655007005229, 1.0]], [1, [3.446196586758629, 1.0]], [1, [11.125802265363237, 1.0]], [1, [45.67458817202332, 1.0]], [1, [0.3203062083832258, 1.0]], [1, [1.0888632535914582, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413149]
bas 1, expnt(s) = [3661.45439324]
bas 2, expnt(s) = [833.27252927]
bas 3, expnt(s) = [235.72071363]
bas 4, expnt(s) = [76.48636551]
bas 5, expnt(s) = [9.8103068]
bas 6, expnt(s) = [27.16331777]
bas 7, expnt(s) = [0.51319511]
bas 8, expnt(s) = [2.23374161]
bas 9, expnt(s) = [1.8261655]
bas 10, expnt(s) = [3.44619659]
bas 11, expnt(s) = [11.12580227]
bas 12, expnt(s) = [45.67458817]
bas 13, expnt(s) = [0.32030621]
bas 14, expnt(s) = [1.08886325]
CPU time:       111.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272529e+02 3.91836892e+02 2.35720714e+02 1.51989412e+02
 7.64863655e+01 6.53435978e+01 9.81030680e+00 1.40048018e+01
 2.71633178e+01 3.00609108e+01 5.13195113e-01 1.53188763e+00
 2.23374161e+00 4.61625430e+00 1.82616550e+00 3.96889971e+00
 3.44619659e+00 1.36980722e+01 1.11258023e+01 5.92786854e+01
 4.56745882e+01 3.46399848e+02 3.20306208e-01 7.02976955e-01
 1.08886325e+00 3.24489815e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998148579760104
cond(S) = 3471.9039053742113
E1 = -183.56931747094052  E_coul = 55.07781250125698
init E= -128.491504969684
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773827990833342  LUMO = 1.0666255387785
  mo_energy =
[-3.25554858e+01 -1.85107634e+00 -7.73827991e-01 -7.73827991e-01
 -7.73827991e-01  1.06662554e+00  1.06662554e+00  1.06662554e+00
  1.84420148e+00  5.44136680e+00  5.44136680e+00  5.44136680e+00
  8.79618939e+00  2.19876466e+01  2.19876466e+01  2.19876466e+01
  3.55126762e+01  1.00334358e+02  1.00334358e+02  1.00334358e+02
  1.39152568e+02  5.03307069e+02  1.87097498e+03  8.00061941e+03
  4.77682307e+04]
E1 = -182.11369212547555  E_coul = 53.589523406357294
cycle= 1 E= -128.524168719118  delta_E= -0.0327  |g|=  0.2  |ddm|= 0.482
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.453987
diis-c [-0.20610417  1.        ]
  HOMO = -0.878413738908404  LUMO = 1.03122620988581
  mo_energy =
[-3.28733730e+01 -1.96120989e+00 -8.78413739e-01 -8.78413739e-01
 -8.78413739e-01  1.03122621e+00  1.03122621e+00  1.03122621e+00
  1.78619223e+00  5.31937037e+00  5.31937037e+00  5.31937037e+00
  8.66736367e+00  2.17624263e+01  2.17624263e+01  2.17624263e+01
  3.52745292e+01  1.00022322e+02  1.00022322e+02  1.00022322e+02
  1.38840235e+02  5.02950436e+02  1.87058219e+03  8.00019771e+03
  4.77677900e+04]
E1 = -182.84107266682764  E_coul = 54.31441085706722
cycle= 2 E= -128.52666180976  delta_E= -0.00249  |g|= 0.0993  |ddm|= 0.0746
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.225623
diis-c [-5.90554137e-04  3.31013627e-01  6.68986373e-01]
  HOMO = -0.844259536081213  LUMO = 1.04291336322999
  mo_energy =
[-3.27688489e+01 -1.92516731e+00 -8.44259536e-01 -8.44259536e-01
 -8.44259536e-01  1.04291336e+00  1.04291336e+00  1.04291336e+00
  1.80496303e+00  5.35911469e+00  5.35911469e+00  5.35911469e+00
  8.70944173e+00  2.18366064e+01  2.18366064e+01  2.18366064e+01
  3.53533170e+01  1.00124571e+02  1.00124571e+02  1.00124571e+02
  1.38942681e+02  5.03063520e+02  1.87070041e+03  8.00031833e+03
  4.77679115e+04]
E1 = -182.59775933669707  E_coul = 54.070262122877594
cycle= 3 E= -128.527497213819  delta_E= -0.000835  |g|= 0.000453  |ddm|= 0.0273
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000935357
diis-c [-3.68949210e-08 -2.00864341e-03  2.39809193e-05  1.00198466e+00]
  HOMO = -0.84448809676778  LUMO = 1.04287015949993
  mo_energy =
[-3.27692948e+01 -1.92537164e+00 -8.44488097e-01 -8.44488097e-01
 -8.44488097e-01  1.04287016e+00  1.04287016e+00  1.04287016e+00
  1.80486452e+00  5.35891489e+00  5.35891489e+00  5.35891489e+00
  8.70922783e+00  2.18362700e+01  2.18362700e+01  2.18362700e+01
  3.53529737e+01  1.00124128e+02  1.00124128e+02  1.00124128e+02
  1.38942238e+02  5.03062982e+02  1.87069977e+03  8.00031762e+03
  4.77679108e+04]
E1 = -182.59838736340177  E_coul = 54.07089013648521
cycle= 4 E= -128.527497226917  delta_E= -1.31e-08  |g|= 4.49e-05  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.53923e-05
diis-c [-1.83336130e-10  8.02760070e-05  2.55496778e-04 -8.78600327e-02
  1.08752426e+00]
  HOMO = -0.844511356516248  LUMO = 1.04286088075147
  mo_energy =
[-3.27693363e+01 -1.92539387e+00 -8.44511357e-01 -8.44511357e-01
 -8.44511357e-01  1.04286088e+00  1.04286088e+00  1.04286088e+00
  1.80484942e+00  5.35888824e+00  5.35888824e+00  5.35888824e+00
  8.70920040e+00  2.18362331e+01  2.18362331e+01  2.18362331e+01
  3.53529362e+01  1.00124087e+02  1.00124087e+02  1.00124087e+02
  1.38942197e+02  5.03062939e+02  1.87069973e+03  8.00031757e+03
  4.77679107e+04]
E1 = -182.59847418392826  E_coul = 54.07097695686388
cycle= 5 E= -128.527497227064  delta_E= -1.48e-10  |g|= 1.4e-06  |ddm|= 4.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59847418392826  E_coul = 54.07097695686388
  HOMO = -0.844510770407744  LUMO = 1.04286109633548
  mo_energy =
[-3.27693348e+01 -1.92539307e+00 -8.44510770e-01 -8.44510770e-01
 -8.44510770e-01  1.04286110e+00  1.04286110e+00  1.04286110e+00
  1.80484987e+00  5.35888894e+00  5.35888894e+00  5.35888894e+00
  8.70920123e+00  2.18362343e+01  2.18362343e+01  2.18362343e+01
  3.53529376e+01  1.00124089e+02  1.00124089e+02  1.00124089e+02
  1.38942198e+02  5.03062940e+02  1.87069973e+03  8.00031757e+03
  4.77679107e+04]
E1 = -182.59847018105324  E_coul = 54.070972953988566
Extra cycle  E= -128.527497227065  delta_E= -3.13e-13  |g|= 5.48e-07  |ddm|= 1.14e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272529e+02 2.35720714e+02
 7.64863655e+01 9.81030680e+00 2.71633178e+01 5.13195113e-01
 2.23374161e+00 1.82616550e+00 3.44619659e+00 1.11258023e+01
 4.56745882e+01 3.20306208e-01 1.08886325e+00]
E = -128.52749722706469
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439324        1
[INPUT] 0    0    [1    /1   ]  833.272529269        1
[INPUT] 0    0    [1    /1   ]  235.720713629        1
[INPUT] 0    0    [1    /1   ]  76.4863655148        1
[INPUT] 0    0    [1    /1   ]  9.81030680492        1
[INPUT] 0    0    [1    /1   ]  27.1633177687        1
[INPUT] 0    0    [1    /1   ]  0.513195112589       1
[INPUT] 0    0    [1    /1   ]  2.23374161129        1
[INPUT] 0    0    [1    /1   ]  1.8261655007         1
[INPUT] 1    0    [1    /1   ]  3.44619658676        1
[INPUT] 1    0    [1    /1   ]  11.1258022654        1
[INPUT] 1    0    [1    /1   ]  45.674588172         1
[INPUT] 1    0    [1    /1   ]  0.320306208383       1
[INPUT] 1    0    [1    /1   ]  1.08886325359        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413148891, 1.0]], [0, [3661.454393239108, 1.0]], [0, [833.2725292689734, 1.0]], [0, [235.72071362928443, 1.0]], [0, [76.4863655147513, 1.0]], [0, [9.810306804919163, 1.0]], [0, [27.163317768736256, 1.0]], [0, [0.5131951125892849, 1.0]], [0, [2.233741611293911, 1.0]], [0, [1.8261655007005229, 1.0]], [1, [3.446196586758629, 1.0]], [1, [11.125802265363237, 1.0]], [1, [45.67458817202332, 1.0]], [1, [0.3203062083832258, 1.0]], [1, [1.0888632535914582, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413149]
bas 1, expnt(s) = [3661.45439324]
bas 2, expnt(s) = [833.27252927]
bas 3, expnt(s) = [235.72071363]
bas 4, expnt(s) = [76.48636551]
bas 5, expnt(s) = [9.8103068]
bas 6, expnt(s) = [27.16331777]
bas 7, expnt(s) = [0.51319511]
bas 8, expnt(s) = [2.23374161]
bas 9, expnt(s) = [1.8261655]
bas 10, expnt(s) = [3.44619659]
bas 11, expnt(s) = [11.12580227]
bas 12, expnt(s) = [45.67458817]
bas 13, expnt(s) = [0.32030621]
bas 14, expnt(s) = [1.08886325]
CPU time:       112.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272529e+02 3.91836892e+02 2.35720714e+02 1.51989412e+02
 7.64863655e+01 6.53435978e+01 9.81030680e+00 1.40048018e+01
 2.71633178e+01 3.00609108e+01 5.13195113e-01 1.53188763e+00
 2.23374161e+00 4.61625430e+00 1.82616550e+00 3.96889971e+00
 3.44619659e+00 1.36980722e+01 1.11258023e+01 5.92786854e+01
 4.56745882e+01 3.46399848e+02 3.20306208e-01 7.02976955e-01
 1.08886325e+00 3.24489815e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998148579760104
cond(S) = 3471.9039053742113
E1 = -183.56931747094052  E_coul = 55.07781250125698
init E= -128.491504969684
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773827990833342  LUMO = 1.0666255387785
  mo_energy =
[-3.25554858e+01 -1.85107634e+00 -7.73827991e-01 -7.73827991e-01
 -7.73827991e-01  1.06662554e+00  1.06662554e+00  1.06662554e+00
  1.84420148e+00  5.44136680e+00  5.44136680e+00  5.44136680e+00
  8.79618939e+00  2.19876466e+01  2.19876466e+01  2.19876466e+01
  3.55126762e+01  1.00334358e+02  1.00334358e+02  1.00334358e+02
  1.39152568e+02  5.03307069e+02  1.87097498e+03  8.00061941e+03
  4.77682307e+04]
E1 = -182.11369212547555  E_coul = 53.589523406357294
cycle= 1 E= -128.524168719118  delta_E= -0.0327  |g|=  0.2  |ddm|= 0.482
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.453987
diis-c [-0.20610417  1.        ]
  HOMO = -0.878413738908404  LUMO = 1.03122620988581
  mo_energy =
[-3.28733730e+01 -1.96120989e+00 -8.78413739e-01 -8.78413739e-01
 -8.78413739e-01  1.03122621e+00  1.03122621e+00  1.03122621e+00
  1.78619223e+00  5.31937037e+00  5.31937037e+00  5.31937037e+00
  8.66736367e+00  2.17624263e+01  2.17624263e+01  2.17624263e+01
  3.52745292e+01  1.00022322e+02  1.00022322e+02  1.00022322e+02
  1.38840235e+02  5.02950436e+02  1.87058219e+03  8.00019771e+03
  4.77677900e+04]
E1 = -182.84107266682764  E_coul = 54.31441085706722
cycle= 2 E= -128.52666180976  delta_E= -0.00249  |g|= 0.0993  |ddm|= 0.0746
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.225623
diis-c [-5.90554137e-04  3.31013627e-01  6.68986373e-01]
  HOMO = -0.844259536081213  LUMO = 1.04291336322999
  mo_energy =
[-3.27688489e+01 -1.92516731e+00 -8.44259536e-01 -8.44259536e-01
 -8.44259536e-01  1.04291336e+00  1.04291336e+00  1.04291336e+00
  1.80496303e+00  5.35911469e+00  5.35911469e+00  5.35911469e+00
  8.70944173e+00  2.18366064e+01  2.18366064e+01  2.18366064e+01
  3.53533170e+01  1.00124571e+02  1.00124571e+02  1.00124571e+02
  1.38942681e+02  5.03063520e+02  1.87070041e+03  8.00031833e+03
  4.77679115e+04]
E1 = -182.59775933669707  E_coul = 54.070262122877594
cycle= 3 E= -128.527497213819  delta_E= -0.000835  |g|= 0.000453  |ddm|= 0.0273
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000935357
diis-c [-3.68949210e-08 -2.00864341e-03  2.39809193e-05  1.00198466e+00]
  HOMO = -0.84448809676778  LUMO = 1.04287015949993
  mo_energy =
[-3.27692948e+01 -1.92537164e+00 -8.44488097e-01 -8.44488097e-01
 -8.44488097e-01  1.04287016e+00  1.04287016e+00  1.04287016e+00
  1.80486452e+00  5.35891489e+00  5.35891489e+00  5.35891489e+00
  8.70922783e+00  2.18362700e+01  2.18362700e+01  2.18362700e+01
  3.53529737e+01  1.00124128e+02  1.00124128e+02  1.00124128e+02
  1.38942238e+02  5.03062982e+02  1.87069977e+03  8.00031762e+03
  4.77679108e+04]
E1 = -182.59838736340177  E_coul = 54.07089013648521
cycle= 4 E= -128.527497226917  delta_E= -1.31e-08  |g|= 4.49e-05  |ddm|= 0.000537
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.53923e-05
diis-c [-1.83336130e-10  8.02760070e-05  2.55496778e-04 -8.78600327e-02
  1.08752426e+00]
  HOMO = -0.844511356516248  LUMO = 1.04286088075147
  mo_energy =
[-3.27693363e+01 -1.92539387e+00 -8.44511357e-01 -8.44511357e-01
 -8.44511357e-01  1.04286088e+00  1.04286088e+00  1.04286088e+00
  1.80484942e+00  5.35888824e+00  5.35888824e+00  5.35888824e+00
  8.70920040e+00  2.18362331e+01  2.18362331e+01  2.18362331e+01
  3.53529362e+01  1.00124087e+02  1.00124087e+02  1.00124087e+02
  1.38942197e+02  5.03062939e+02  1.87069973e+03  8.00031757e+03
  4.77679107e+04]
E1 = -182.59847418392826  E_coul = 54.07097695686388
cycle= 5 E= -128.527497227064  delta_E= -1.48e-10  |g|= 1.4e-06  |ddm|= 4.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59847418392826  E_coul = 54.07097695686388
  HOMO = -0.844510770407744  LUMO = 1.04286109633548
  mo_energy =
[-3.27693348e+01 -1.92539307e+00 -8.44510770e-01 -8.44510770e-01
 -8.44510770e-01  1.04286110e+00  1.04286110e+00  1.04286110e+00
  1.80484987e+00  5.35888894e+00  5.35888894e+00  5.35888894e+00
  8.70920123e+00  2.18362343e+01  2.18362343e+01  2.18362343e+01
  3.53529376e+01  1.00124089e+02  1.00124089e+02  1.00124089e+02
  1.38942198e+02  5.03062940e+02  1.87069973e+03  8.00031757e+03
  4.77679107e+04]
E1 = -182.59847018105324  E_coul = 54.070972953988566
Extra cycle  E= -128.527497227065  delta_E= -3.13e-13  |g|= 5.48e-07  |ddm|= 1.14e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3471.9039053742113
E1 = -182.59847018105324  E_coul = 54.070972953988566
init E= -128.527497227065
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844511059761156  LUMO = 1.04286099870605
  mo_energy =
[-3.27693356e+01 -1.92539334e+00 -8.44511060e-01 -8.44511060e-01
 -8.44511060e-01  1.04286100e+00  1.04286100e+00  1.04286100e+00
  1.80484974e+00  5.35888861e+00  5.35888861e+00  5.35888861e+00
  8.70920089e+00  2.18362337e+01  2.18362337e+01  2.18362337e+01
  3.53529369e+01  1.00124088e+02  1.00124088e+02  1.00124088e+02
  1.38942197e+02  5.03062939e+02  1.87069973e+03  8.00031757e+03
  4.77679107e+04]
E1 = -182.5984722301787  E_coul = 54.07097500311414
cycle= 1 E= -128.527497227065  delta_E= 1.42e-13  |g|= 2.83e-07  |ddm|= 2.16e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5984722301787  E_coul = 54.07097500311414
  HOMO = -0.844510916875864  LUMO = 1.04286104807287
  mo_energy =
[-3.27693352e+01 -1.92539319e+00 -8.44510917e-01 -8.44510917e-01
 -8.44510917e-01  1.04286105e+00  1.04286105e+00  1.04286105e+00
  1.80484982e+00  5.35888877e+00  5.35888877e+00  5.35888877e+00
  8.70920107e+00  2.18362340e+01  2.18362340e+01  2.18362340e+01
  3.53529372e+01  1.00124088e+02  1.00124088e+02  1.00124088e+02
  1.38942198e+02  5.03062939e+02  1.87069973e+03  8.00031757e+03
  4.77679107e+04]
E1 = -182.59847121125503  E_coul = 54.07097398419014
Extra cycle  E= -128.527497227065  delta_E= -3.41e-13  |g|= 1.39e-07  |ddm|= 1.35e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272529e+02 2.35720714e+02
 7.64863655e+01 9.81030680e+00 2.71633178e+01 5.13195113e-01
 2.23374161e+00 1.82616550e+00 3.44619659e+00 1.11258023e+01
 4.56745882e+01 3.20306208e-01 1.08886325e+00]
grad_E = [-2.41681451e-09  1.28405406e-07 -2.54710676e-06  3.12985933e-05
 -2.40432826e-04 -2.82893567e-03  1.26985913e-03  2.15582089e-03
  5.69600932e-04  3.01380340e-03  3.19847866e-03 -3.40833108e-04
 -2.17909379e-04  6.15178158e-03 -5.57013280e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439217        1
[INPUT] 0    0    [1    /1   ]  833.272550477        1
[INPUT] 0    0    [1    /1   ]  235.720469797        1
[INPUT] 0    0    [1    /1   ]  76.4879451175        1
[INPUT] 0    0    [1    /1   ]  9.78458969948        1
[INPUT] 0    0    [1    /1   ]  27.1603794813        1
[INPUT] 0    0    [1    /1   ]  0.513471291105       1
[INPUT] 0    0    [1    /1   ]  2.14224615065        1
[INPUT] 0    0    [1    /1   ]  1.89232149749        1
[INPUT] 1    0    [1    /1   ]  3.45247611888        1
[INPUT] 1    0    [1    /1   ]  11.2676777301        1
[INPUT] 1    0    [1    /1   ]  47.7744944375        1
[INPUT] 1    0    [1    /1   ]  0.320110469766       1
[INPUT] 1    0    [1    /1   ]  1.09181800859        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413150753, 1.0]], [0, [3661.4543921661593, 1.0]], [0, [833.2725504765652, 1.0]], [0, [235.72046979747122, 1.0]], [0, [76.48794511753525, 1.0]], [0, [9.784589699476275, 1.0]], [0, [27.160379481271402, 1.0]], [0, [0.513471291105354, 1.0]], [0, [2.1422461506496955, 1.0]], [0, [1.8923214974859006, 1.0]], [1, [3.4524761188792557, 1.0]], [1, [11.267677730142823, 1.0]], [1, [47.77449443753221, 1.0]], [1, [0.32011046976649443, 1.0]], [1, [1.0918180085914329, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413151]
bas 1, expnt(s) = [3661.45439217]
bas 2, expnt(s) = [833.27255048]
bas 3, expnt(s) = [235.7204698]
bas 4, expnt(s) = [76.48794512]
bas 5, expnt(s) = [9.7845897]
bas 6, expnt(s) = [27.16037948]
bas 7, expnt(s) = [0.51347129]
bas 8, expnt(s) = [2.14224615]
bas 9, expnt(s) = [1.8923215]
bas 10, expnt(s) = [3.45247612]
bas 11, expnt(s) = [11.26767773]
bas 12, expnt(s) = [47.77449444]
bas 13, expnt(s) = [0.32011047]
bas 14, expnt(s) = [1.09181801]
CPU time:       115.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272550e+02 3.91836899e+02 2.35720470e+02 1.51989294e+02
 7.64879451e+01 6.53446099e+01 9.78458970e+00 1.39772582e+01
 2.71603795e+01 3.00584720e+01 5.13471291e-01 1.53250588e+00
 2.14224615e+00 4.47370201e+00 1.89232150e+00 4.07625380e+00
 3.45247612e+00 1.37292795e+01 1.12676777e+01 6.02250839e+01
 4.77744944e+01 3.66420293e+02 3.20110470e-01 7.02440011e-01
 1.09181801e+00 3.25590863e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998138841157344
cond(S) = 8904.370932246618
E1 = -183.56881371135296  E_coul = 55.077535137784906
init E= -128.491278573568
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77391541384331  LUMO = 1.0672563502354
  mo_energy =
[-3.25555150e+01 -1.85101608e+00 -7.73915414e-01 -7.73915414e-01
 -7.73915414e-01  1.06725635e+00  1.06725635e+00  1.06725635e+00
  1.84709307e+00  5.45385779e+00  5.45385779e+00  5.45385779e+00
  8.76857887e+00  2.21471979e+01  2.21471979e+01  2.21471979e+01
  3.53766897e+01  1.03921334e+02  1.03921334e+02  1.03921334e+02
  1.38955144e+02  5.03109680e+02  1.87079482e+03  8.00046027e+03
  4.77680988e+04]
E1 = -182.11126353653455  E_coul = 53.586903214537095
cycle= 1 E= -128.524360321997  delta_E= -0.0331  |g|= 0.201  |ddm|= 1.07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.451899
diis-c [-0.20421267  1.        ]
  HOMO = -0.878714162619047  LUMO = 1.03167101820544
  mo_energy =
[-3.28737620e+01 -1.96132807e+00 -8.78714163e-01 -8.78714163e-01
 -8.78714163e-01  1.03167102e+00  1.03167102e+00  1.03167102e+00
  1.78890572e+00  5.33128798e+00  5.33128798e+00  5.33128798e+00
  8.63999673e+00  2.19206909e+01  2.19206909e+01  2.19206909e+01
  3.51385031e+01  1.03606893e+02  1.03606893e+02  1.03606893e+02
  1.38642436e+02  5.02752577e+02  1.87040149e+03  8.00003800e+03
  4.77676576e+04]
E1 = -182.83901233716895  E_coul = 54.312157369016084
cycle= 2 E= -128.526854968153  delta_E= -0.00249  |g|= 0.0994  |ddm|= 0.0812
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224602
diis-c [-5.87381858e-04  3.31026502e-01  6.68973498e-01]
  HOMO = -0.84454510010863  LUMO = 1.04338747403112
  mo_energy =
[-3.27691810e+01 -1.92526842e+00 -8.44545100e-01 -8.44545100e-01
 -8.44545100e-01  1.04338747e+00  1.04338747e+00  1.04338747e+00
  1.80768183e+00  5.37115801e+00  5.37115801e+00  5.37115801e+00
  8.68193795e+00  2.19952443e+01  2.19952443e+01  2.19952443e+01
  3.52172591e+01  1.03709792e+02  1.03709792e+02  1.03709792e+02
  1.38744939e+02  5.02865727e+02  1.87051979e+03  8.00015870e+03
  4.77677792e+04]
E1 = -182.59535221858854  E_coul = 54.06766026091664
cycle= 3 E= -128.527691957672  delta_E= -0.000837  |g|= 0.000482  |ddm|= 0.035
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981794
diis-c [-4.21124975e-08 -2.04198175e-03  1.76425271e-04  1.00186556e+00]
  HOMO = -0.844789077516247  LUMO = 1.04333750549808
  mo_energy =
[-3.27696485e+01 -1.92548664e+00 -8.44789078e-01 -8.44789078e-01
 -8.44789078e-01  1.04333751e+00  1.04333751e+00  1.04333751e+00
  1.80757251e+00  5.37094045e+00  5.37094045e+00  5.37094045e+00
  8.68170732e+00  2.19948857e+01  2.19948857e+01  2.19948857e+01
  3.52168956e+01  1.03709325e+02  1.03709325e+02  1.03709325e+02
  1.38744474e+02  5.02865167e+02  1.87051913e+03  8.00015796e+03
  4.77677784e+04]
E1 = -182.59601450384386  E_coul = 54.06832253119117
cycle= 4 E= -128.527691972653  delta_E= -1.5e-08  |g|= 4.75e-05  |ddm|= 0.00125
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000100136
diis-c [-1.94623751e-10  9.19621443e-05  2.58105152e-04 -9.44115072e-02
  1.09406144e+00]
  HOMO = -0.844813919549762  LUMO = 1.04332755185711
  mo_energy =
[-3.27696923e+01 -1.92551016e+00 -8.44813920e-01 -8.44813920e-01
 -8.44813920e-01  1.04332755e+00  1.04332755e+00  1.04332755e+00
  1.80755644e+00  5.37091196e+00  5.37091196e+00  5.37091196e+00
  8.68167824e+00  2.19948465e+01  2.19948465e+01  2.19948465e+01
  3.52168559e+01  1.03709281e+02  1.03709281e+02  1.03709281e+02
  1.38744430e+02  5.02865120e+02  1.87051908e+03  8.00015791e+03
  4.77677784e+04]
E1 = -182.59610537053464  E_coul = 54.06841339771583
cycle= 5 E= -128.527691972819  delta_E= -1.66e-10  |g|= 1.61e-06  |ddm|= 0.000107
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59610537053464  E_coul = 54.06841339771583
  HOMO = -0.844813199415275  LUMO = 1.04332782371168
  mo_energy =
[-3.27696905e+01 -1.92550919e+00 -8.44813199e-01 -8.44813199e-01
 -8.44813199e-01  1.04332782e+00  1.04332782e+00  1.04332782e+00
  1.80755700e+00  5.37091282e+00  5.37091282e+00  5.37091282e+00
  8.68167924e+00  2.19948480e+01  2.19948480e+01  2.19948480e+01
  3.52168575e+01  1.03709283e+02  1.03709283e+02  1.03709283e+02
  1.38744432e+02  5.02865122e+02  1.87051908e+03  8.00015791e+03
  4.77677784e+04]
E1 = -182.59610087787703  E_coul = 54.068408905058014
Extra cycle  E= -128.527691972819  delta_E= -1.99e-13  |g|= 6.18e-07  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272550e+02 2.35720470e+02
 7.64879451e+01 9.78458970e+00 2.71603795e+01 5.13471291e-01
 2.14224615e+00 1.89232150e+00 3.45247612e+00 1.12676777e+01
 4.77744944e+01 3.20110470e-01 1.09181801e+00]
E = -128.527691972819
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439217        1
[INPUT] 0    0    [1    /1   ]  833.272550477        1
[INPUT] 0    0    [1    /1   ]  235.720469797        1
[INPUT] 0    0    [1    /1   ]  76.4879451175        1
[INPUT] 0    0    [1    /1   ]  9.78458969948        1
[INPUT] 0    0    [1    /1   ]  27.1603794813        1
[INPUT] 0    0    [1    /1   ]  0.513471291105       1
[INPUT] 0    0    [1    /1   ]  2.14224615065        1
[INPUT] 0    0    [1    /1   ]  1.89232149749        1
[INPUT] 1    0    [1    /1   ]  3.45247611888        1
[INPUT] 1    0    [1    /1   ]  11.2676777301        1
[INPUT] 1    0    [1    /1   ]  47.7744944375        1
[INPUT] 1    0    [1    /1   ]  0.320110469766       1
[INPUT] 1    0    [1    /1   ]  1.09181800859        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413150753, 1.0]], [0, [3661.4543921661593, 1.0]], [0, [833.2725504765652, 1.0]], [0, [235.72046979747122, 1.0]], [0, [76.48794511753525, 1.0]], [0, [9.784589699476275, 1.0]], [0, [27.160379481271402, 1.0]], [0, [0.513471291105354, 1.0]], [0, [2.1422461506496955, 1.0]], [0, [1.8923214974859006, 1.0]], [1, [3.4524761188792557, 1.0]], [1, [11.267677730142823, 1.0]], [1, [47.77449443753221, 1.0]], [1, [0.32011046976649443, 1.0]], [1, [1.0918180085914329, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413151]
bas 1, expnt(s) = [3661.45439217]
bas 2, expnt(s) = [833.27255048]
bas 3, expnt(s) = [235.7204698]
bas 4, expnt(s) = [76.48794512]
bas 5, expnt(s) = [9.7845897]
bas 6, expnt(s) = [27.16037948]
bas 7, expnt(s) = [0.51347129]
bas 8, expnt(s) = [2.14224615]
bas 9, expnt(s) = [1.8923215]
bas 10, expnt(s) = [3.45247612]
bas 11, expnt(s) = [11.26767773]
bas 12, expnt(s) = [47.77449444]
bas 13, expnt(s) = [0.32011047]
bas 14, expnt(s) = [1.09181801]
CPU time:       115.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272550e+02 3.91836899e+02 2.35720470e+02 1.51989294e+02
 7.64879451e+01 6.53446099e+01 9.78458970e+00 1.39772582e+01
 2.71603795e+01 3.00584720e+01 5.13471291e-01 1.53250588e+00
 2.14224615e+00 4.47370201e+00 1.89232150e+00 4.07625380e+00
 3.45247612e+00 1.37292795e+01 1.12676777e+01 6.02250839e+01
 4.77744944e+01 3.66420293e+02 3.20110470e-01 7.02440011e-01
 1.09181801e+00 3.25590863e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998138841157344
cond(S) = 8904.370932246618
E1 = -183.56881371135296  E_coul = 55.077535137784906
init E= -128.491278573568
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77391541384331  LUMO = 1.0672563502354
  mo_energy =
[-3.25555150e+01 -1.85101608e+00 -7.73915414e-01 -7.73915414e-01
 -7.73915414e-01  1.06725635e+00  1.06725635e+00  1.06725635e+00
  1.84709307e+00  5.45385779e+00  5.45385779e+00  5.45385779e+00
  8.76857887e+00  2.21471979e+01  2.21471979e+01  2.21471979e+01
  3.53766897e+01  1.03921334e+02  1.03921334e+02  1.03921334e+02
  1.38955144e+02  5.03109680e+02  1.87079482e+03  8.00046027e+03
  4.77680988e+04]
E1 = -182.11126353653455  E_coul = 53.586903214537095
cycle= 1 E= -128.524360321997  delta_E= -0.0331  |g|= 0.201  |ddm|= 1.07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.451899
diis-c [-0.20421267  1.        ]
  HOMO = -0.878714162619047  LUMO = 1.03167101820544
  mo_energy =
[-3.28737620e+01 -1.96132807e+00 -8.78714163e-01 -8.78714163e-01
 -8.78714163e-01  1.03167102e+00  1.03167102e+00  1.03167102e+00
  1.78890572e+00  5.33128798e+00  5.33128798e+00  5.33128798e+00
  8.63999673e+00  2.19206909e+01  2.19206909e+01  2.19206909e+01
  3.51385031e+01  1.03606893e+02  1.03606893e+02  1.03606893e+02
  1.38642436e+02  5.02752577e+02  1.87040149e+03  8.00003800e+03
  4.77676576e+04]
E1 = -182.83901233716895  E_coul = 54.312157369016084
cycle= 2 E= -128.526854968153  delta_E= -0.00249  |g|= 0.0994  |ddm|= 0.0812
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224602
diis-c [-5.87381858e-04  3.31026502e-01  6.68973498e-01]
  HOMO = -0.84454510010863  LUMO = 1.04338747403112
  mo_energy =
[-3.27691810e+01 -1.92526842e+00 -8.44545100e-01 -8.44545100e-01
 -8.44545100e-01  1.04338747e+00  1.04338747e+00  1.04338747e+00
  1.80768183e+00  5.37115801e+00  5.37115801e+00  5.37115801e+00
  8.68193795e+00  2.19952443e+01  2.19952443e+01  2.19952443e+01
  3.52172591e+01  1.03709792e+02  1.03709792e+02  1.03709792e+02
  1.38744939e+02  5.02865727e+02  1.87051979e+03  8.00015870e+03
  4.77677792e+04]
E1 = -182.59535221858854  E_coul = 54.06766026091664
cycle= 3 E= -128.527691957672  delta_E= -0.000837  |g|= 0.000482  |ddm|= 0.035
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981794
diis-c [-4.21124975e-08 -2.04198175e-03  1.76425271e-04  1.00186556e+00]
  HOMO = -0.844789077516247  LUMO = 1.04333750549808
  mo_energy =
[-3.27696485e+01 -1.92548664e+00 -8.44789078e-01 -8.44789078e-01
 -8.44789078e-01  1.04333751e+00  1.04333751e+00  1.04333751e+00
  1.80757251e+00  5.37094045e+00  5.37094045e+00  5.37094045e+00
  8.68170732e+00  2.19948857e+01  2.19948857e+01  2.19948857e+01
  3.52168956e+01  1.03709325e+02  1.03709325e+02  1.03709325e+02
  1.38744474e+02  5.02865167e+02  1.87051913e+03  8.00015796e+03
  4.77677784e+04]
E1 = -182.59601450384386  E_coul = 54.06832253119117
cycle= 4 E= -128.527691972653  delta_E= -1.5e-08  |g|= 4.75e-05  |ddm|= 0.00125
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000100136
diis-c [-1.94623751e-10  9.19621443e-05  2.58105152e-04 -9.44115072e-02
  1.09406144e+00]
  HOMO = -0.844813919549762  LUMO = 1.04332755185711
  mo_energy =
[-3.27696923e+01 -1.92551016e+00 -8.44813920e-01 -8.44813920e-01
 -8.44813920e-01  1.04332755e+00  1.04332755e+00  1.04332755e+00
  1.80755644e+00  5.37091196e+00  5.37091196e+00  5.37091196e+00
  8.68167824e+00  2.19948465e+01  2.19948465e+01  2.19948465e+01
  3.52168559e+01  1.03709281e+02  1.03709281e+02  1.03709281e+02
  1.38744430e+02  5.02865120e+02  1.87051908e+03  8.00015791e+03
  4.77677784e+04]
E1 = -182.59610537053464  E_coul = 54.06841339771583
cycle= 5 E= -128.527691972819  delta_E= -1.66e-10  |g|= 1.61e-06  |ddm|= 0.000107
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59610537053464  E_coul = 54.06841339771583
  HOMO = -0.844813199415275  LUMO = 1.04332782371168
  mo_energy =
[-3.27696905e+01 -1.92550919e+00 -8.44813199e-01 -8.44813199e-01
 -8.44813199e-01  1.04332782e+00  1.04332782e+00  1.04332782e+00
  1.80755700e+00  5.37091282e+00  5.37091282e+00  5.37091282e+00
  8.68167924e+00  2.19948480e+01  2.19948480e+01  2.19948480e+01
  3.52168575e+01  1.03709283e+02  1.03709283e+02  1.03709283e+02
  1.38744432e+02  5.02865122e+02  1.87051908e+03  8.00015791e+03
  4.77677784e+04]
E1 = -182.59610087787703  E_coul = 54.068408905058014
Extra cycle  E= -128.527691972819  delta_E= -1.99e-13  |g|= 6.18e-07  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 8904.370932246618
E1 = -182.59610087787703  E_coul = 54.068408905058014
init E= -128.527691972819
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.844813522279133  LUMO = 1.0433277153251
  mo_energy =
[-3.27696915e+01 -1.92550950e+00 -8.44813522e-01 -8.44813522e-01
 -8.44813522e-01  1.04332772e+00  1.04332772e+00  1.04332772e+00
  1.80755685e+00  5.37091245e+00  5.37091245e+00  5.37091245e+00
  8.68167886e+00  2.19948473e+01  2.19948473e+01  2.19948473e+01
  3.52168568e+01  1.03709282e+02  1.03709282e+02  1.03709282e+02
  1.38744431e+02  5.02865121e+02  1.87051908e+03  8.00015791e+03
  4.77677784e+04]
E1 = -182.5961032088015  E_coul = 54.068411235982296
cycle= 1 E= -128.527691972819  delta_E= -1.99e-13  |g|= 3.22e-07  |ddm|= 2.89e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5961032088015  E_coul = 54.068411235982296
  HOMO = -0.844813359538206  LUMO = 1.04332777175204
  mo_energy =
[-3.27696910e+01 -1.92550932e+00 -8.44813360e-01 -8.44813360e-01
 -8.44813360e-01  1.04332777e+00  1.04332777e+00  1.04332777e+00
  1.80755694e+00  5.37091264e+00  5.37091264e+00  5.37091264e+00
  8.68167907e+00  2.19948477e+01  2.19948477e+01  2.19948477e+01
  3.52168572e+01  1.03709282e+02  1.03709282e+02  1.03709282e+02
  1.38744432e+02  5.02865121e+02  1.87051908e+03  8.00015791e+03
  4.77677784e+04]
E1 = -182.596102051716  E_coul = 54.06841007889669
Extra cycle  E= -128.527691972819  delta_E= -8.53e-14  |g|= 1.57e-07  |ddm|= 2.29e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272550e+02 2.35720470e+02
 7.64879451e+01 9.78458970e+00 2.71603795e+01 5.13471291e-01
 2.14224615e+00 1.89232150e+00 3.45247612e+00 1.12676777e+01
 4.77744944e+01 3.20110470e-01 1.09181801e+00]
grad_E = [-2.57248378e-09  1.36741443e-07 -2.71141303e-06  3.33793770e-05
 -2.56596760e-04 -3.02351096e-03  1.36268939e-03  1.05247337e-05
  1.01865365e-03  2.61536036e-03  1.89957730e-03 -6.31838591e-04
 -8.81738084e-05 -1.61967455e-03 -8.08157645e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439109        1
[INPUT] 0    0    [1    /1   ]  833.272571711        1
[INPUT] 0    0    [1    /1   ]  235.720224366        1
[INPUT] 0    0    [1    /1   ]  76.4895554703        1
[INPUT] 0    0    [1    /1   ]  9.76205874902        1
[INPUT] 0    0    [1    /1   ]  27.1569106497        1
[INPUT] 0    0    [1    /1   ]  0.517477343843       1
[INPUT] 0    0    [1    /1   ]  2.0551073069         1
[INPUT] 0    0    [1    /1   ]  1.95478500103        1
[INPUT] 1    0    [1    /1   ]  3.46396979277        1
[INPUT] 1    0    [1    /1   ]  11.4585221533        1
[INPUT] 1    0    [1    /1   ]  49.7320330872        1
[INPUT] 1    0    [1    /1   ]  0.320751566955       1
[INPUT] 1    0    [1    /1   ]  1.09220507965        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413152627, 1.0]], [0, [3661.45439109181, 1.0]], [0, [833.2725717109278, 1.0]], [0, [235.72022436585897, 1.0]], [0, [76.48955547034234, 1.0]], [0, [9.762058749017413, 1.0]], [0, [27.156910649668962, 1.0]], [0, [0.5174773438425249, 1.0]], [0, [2.0551073068989587, 1.0]], [0, [1.9547850010257153, 1.0]], [1, [3.463969792768622, 1.0]], [1, [11.45852215331681, 1.0]], [1, [49.73203308715133, 1.0]], [1, [0.3207515669552099, 1.0]], [1, [1.0922050796532332, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413153]
bas 1, expnt(s) = [3661.45439109]
bas 2, expnt(s) = [833.27257171]
bas 3, expnt(s) = [235.72022437]
bas 4, expnt(s) = [76.48955547]
bas 5, expnt(s) = [9.76205875]
bas 6, expnt(s) = [27.15691065]
bas 7, expnt(s) = [0.51747734]
bas 8, expnt(s) = [2.05510731]
bas 9, expnt(s) = [1.954785]
bas 10, expnt(s) = [3.46396979]
bas 11, expnt(s) = [11.45852215]
bas 12, expnt(s) = [49.73203309]
bas 13, expnt(s) = [0.32075157]
bas 14, expnt(s) = [1.09220508]
CPU time:       119.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272572e+02 3.91836907e+02 2.35720224e+02 1.51989175e+02
 7.64895555e+01 6.53456417e+01 9.76205875e+00 1.39531122e+01
 2.71569106e+01 3.00555927e+01 5.17477344e-01 1.54146451e+00
 2.05510731e+00 4.33651549e+00 1.95478500e+00 4.17675761e+00
 3.46396979e+00 1.37864361e+01 1.14585222e+01 6.15028376e+01
 4.97320331e+01 3.85282834e+02 3.20751567e-01 7.04198954e-01
 1.09220508e+00 3.25735155e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998096783387847
cond(S) = 54409.3270288645
E1 = -183.56947580271913  E_coul = 55.07780981962526
init E= -128.491665983094
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773922514387864  LUMO = 1.06957866771677
  mo_energy =
[-3.25554436e+01 -1.85096301e+00 -7.73922514e-01 -7.73922514e-01
 -7.73922514e-01  1.06957867e+00  1.06957867e+00  1.06957867e+00
  1.85558481e+00  5.46456198e+00  5.46456198e+00  5.46456198e+00
  8.74601099e+00  2.23673294e+01  2.23673294e+01  2.23673294e+01
  3.52604009e+01  1.07491515e+02  1.07491515e+02  1.07491515e+02
  1.38785169e+02  5.02938880e+02  1.87063878e+03  8.00032241e+03
  4.77679846e+04]
E1 = -182.11655460946957  E_coul = 53.59208433901545
cycle= 1 E= -128.524470270454  delta_E= -0.0328  |g|=  0.2  |ddm|= 5.02
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.448662
diis-c [-0.20129728  1.        ]
  HOMO = -0.878290127868901  LUMO = 1.03409360166404
  mo_energy =
[-3.28728902e+01 -1.96092179e+00 -8.78290128e-01 -8.78290128e-01
 -8.78290128e-01  1.03409360e+00  1.03409360e+00  1.03409360e+00
  1.79761566e+00  5.34213928e+00  5.34213928e+00  5.34213928e+00
  8.61839583e+00  2.21402079e+01  2.21402079e+01  2.21402079e+01
  3.50230871e+01  1.07176027e+02  1.07176027e+02  1.07176027e+02
  1.38473242e+02  5.02582579e+02  1.87024627e+03  7.99990098e+03
  4.77675443e+04]
E1 = -182.84192804146264  E_coul = 54.31497589856428
cycle= 2 E= -128.526952142898  delta_E= -0.00248  |g|= 0.099  |ddm|= 0.164
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.222866
diis-c [-5.84116477e-04  3.30890883e-01  6.69109117e-01]
  HOMO = -0.844227129593596  LUMO = 1.04579513013144
  mo_energy =
[-3.27686254e+01 -1.92497235e+00 -8.44227130e-01 -8.44227130e-01
 -8.44227130e-01  1.04579513e+00  1.04579513e+00  1.04579513e+00
  1.81633979e+00  5.38199394e+00  5.38199394e+00  5.38199394e+00
  8.66004852e+00  2.22149681e+01  2.22149681e+01  2.22149681e+01
  3.51015370e+01  1.07279140e+02  1.07279140e+02  1.07279140e+02
  1.38575437e+02  5.02695398e+02  1.87036423e+03  8.00002133e+03
  4.77676655e+04]
E1 = -182.5992316597169  E_coul = 54.071448516504965
cycle= 3 E= -128.527783143212  delta_E= -0.000831  |g|= 0.000469  |ddm|= 0.119
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000947381
diis-c [-3.71822809e-08 -2.01548243e-03  1.13832469e-04  1.00190165e+00]
  HOMO = -0.844464702776447  LUMO = 1.04574703537625
  mo_energy =
[-3.27690852e+01 -1.92518998e+00 -8.44464703e-01 -8.44464703e-01
 -8.44464703e-01  1.04574704e+00  1.04574704e+00  1.04574704e+00
  1.81623108e+00  5.38178186e+00  5.38178186e+00  5.38178186e+00
  8.65982338e+00  2.22146148e+01  2.22146148e+01  2.22146148e+01
  3.51011799e+01  1.07278678e+02  1.07278678e+02  1.07278678e+02
  1.38574981e+02  5.02694849e+02  1.87036358e+03  8.00002061e+03
  4.77676648e+04]
E1 = -182.5998801073511  E_coul = 54.072096950153735
cycle= 4 E= -128.527783157197  delta_E= -1.4e-08  |g|= 4.51e-05  |ddm|= 0.00541
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.22977e-05
diis-c [-1.72584030e-10  7.34300365e-05  2.35359200e-04 -8.46406677e-02
  1.08433188e+00]
  HOMO = -0.844488242747616  LUMO = 1.04573748896761
  mo_energy =
[-3.27691267e+01 -1.92521340e+00 -8.44488243e-01 -8.44488243e-01
 -8.44488243e-01  1.04573749e+00  1.04573749e+00  1.04573749e+00
  1.81621502e+00  5.38175468e+00  5.38175468e+00  5.38175468e+00
  8.65979534e+00  2.22145774e+01  2.22145774e+01  2.22145774e+01
  3.51011421e+01  1.07278637e+02  1.07278637e+02  1.07278637e+02
  1.38574940e+02  5.02694806e+02  1.87036354e+03  8.00002056e+03
  4.77676647e+04]
E1 = -182.59996478304825  E_coul = 54.07218162570718
cycle= 5 E= -128.527783157341  delta_E= -1.44e-10  |g|= 1.2e-06  |ddm|= 0.000424
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59996478304825  E_coul = 54.07218162570718
  HOMO = -0.844487666459681  LUMO = 1.04573768948096
  mo_energy =
[-3.27691251e+01 -1.92521272e+00 -8.44487666e-01 -8.44487666e-01
 -8.44487666e-01  1.04573769e+00  1.04573769e+00  1.04573769e+00
  1.81621537e+00  5.38175536e+00  5.38175536e+00  5.38175536e+00
  8.65979610e+00  2.22145786e+01  2.22145786e+01  2.22145786e+01
  3.51011434e+01  1.07278638e+02  1.07278638e+02  1.07278638e+02
  1.38574941e+02  5.02694807e+02  1.87036354e+03  8.00002057e+03
  4.77676647e+04]
E1 = -182.5999605212226  E_coul = 54.07217736388149
Extra cycle  E= -128.527783157341  delta_E= -5.68e-14  |g|= 5.74e-07  |ddm|= 5.32e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272572e+02 2.35720224e+02
 7.64895555e+01 9.76205875e+00 2.71569106e+01 5.17477344e-01
 2.05510731e+00 1.95478500e+00 3.46396979e+00 1.14585222e+01
 4.97320331e+01 3.20751567e-01 1.09220508e+00]
E = -128.52778315734113
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439109        1
[INPUT] 0    0    [1    /1   ]  833.272571711        1
[INPUT] 0    0    [1    /1   ]  235.720224366        1
[INPUT] 0    0    [1    /1   ]  76.4895554703        1
[INPUT] 0    0    [1    /1   ]  9.76205874902        1
[INPUT] 0    0    [1    /1   ]  27.1569106497        1
[INPUT] 0    0    [1    /1   ]  0.517477343843       1
[INPUT] 0    0    [1    /1   ]  2.0551073069         1
[INPUT] 0    0    [1    /1   ]  1.95478500103        1
[INPUT] 1    0    [1    /1   ]  3.46396979277        1
[INPUT] 1    0    [1    /1   ]  11.4585221533        1
[INPUT] 1    0    [1    /1   ]  49.7320330872        1
[INPUT] 1    0    [1    /1   ]  0.320751566955       1
[INPUT] 1    0    [1    /1   ]  1.09220507965        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413152627, 1.0]], [0, [3661.45439109181, 1.0]], [0, [833.2725717109278, 1.0]], [0, [235.72022436585897, 1.0]], [0, [76.48955547034234, 1.0]], [0, [9.762058749017413, 1.0]], [0, [27.156910649668962, 1.0]], [0, [0.5174773438425249, 1.0]], [0, [2.0551073068989587, 1.0]], [0, [1.9547850010257153, 1.0]], [1, [3.463969792768622, 1.0]], [1, [11.45852215331681, 1.0]], [1, [49.73203308715133, 1.0]], [1, [0.3207515669552099, 1.0]], [1, [1.0922050796532332, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413153]
bas 1, expnt(s) = [3661.45439109]
bas 2, expnt(s) = [833.27257171]
bas 3, expnt(s) = [235.72022437]
bas 4, expnt(s) = [76.48955547]
bas 5, expnt(s) = [9.76205875]
bas 6, expnt(s) = [27.15691065]
bas 7, expnt(s) = [0.51747734]
bas 8, expnt(s) = [2.05510731]
bas 9, expnt(s) = [1.954785]
bas 10, expnt(s) = [3.46396979]
bas 11, expnt(s) = [11.45852215]
bas 12, expnt(s) = [49.73203309]
bas 13, expnt(s) = [0.32075157]
bas 14, expnt(s) = [1.09220508]
CPU time:       119.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272572e+02 3.91836907e+02 2.35720224e+02 1.51989175e+02
 7.64895555e+01 6.53456417e+01 9.76205875e+00 1.39531122e+01
 2.71569106e+01 3.00555927e+01 5.17477344e-01 1.54146451e+00
 2.05510731e+00 4.33651549e+00 1.95478500e+00 4.17675761e+00
 3.46396979e+00 1.37864361e+01 1.14585222e+01 6.15028376e+01
 4.97320331e+01 3.85282834e+02 3.20751567e-01 7.04198954e-01
 1.09220508e+00 3.25735155e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998096783387847
cond(S) = 54409.3270288645
E1 = -183.56947580271913  E_coul = 55.07780981962526
init E= -128.491665983094
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773922514387864  LUMO = 1.06957866771677
  mo_energy =
[-3.25554436e+01 -1.85096301e+00 -7.73922514e-01 -7.73922514e-01
 -7.73922514e-01  1.06957867e+00  1.06957867e+00  1.06957867e+00
  1.85558481e+00  5.46456198e+00  5.46456198e+00  5.46456198e+00
  8.74601099e+00  2.23673294e+01  2.23673294e+01  2.23673294e+01
  3.52604009e+01  1.07491515e+02  1.07491515e+02  1.07491515e+02
  1.38785169e+02  5.02938880e+02  1.87063878e+03  8.00032241e+03
  4.77679846e+04]
E1 = -182.11655460946957  E_coul = 53.59208433901545
cycle= 1 E= -128.524470270454  delta_E= -0.0328  |g|=  0.2  |ddm|= 5.02
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.448662
diis-c [-0.20129728  1.        ]
  HOMO = -0.878290127868901  LUMO = 1.03409360166404
  mo_energy =
[-3.28728902e+01 -1.96092179e+00 -8.78290128e-01 -8.78290128e-01
 -8.78290128e-01  1.03409360e+00  1.03409360e+00  1.03409360e+00
  1.79761566e+00  5.34213928e+00  5.34213928e+00  5.34213928e+00
  8.61839583e+00  2.21402079e+01  2.21402079e+01  2.21402079e+01
  3.50230871e+01  1.07176027e+02  1.07176027e+02  1.07176027e+02
  1.38473242e+02  5.02582579e+02  1.87024627e+03  7.99990098e+03
  4.77675443e+04]
E1 = -182.84192804146264  E_coul = 54.31497589856428
cycle= 2 E= -128.526952142898  delta_E= -0.00248  |g|= 0.099  |ddm|= 0.164
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.222866
diis-c [-5.84116477e-04  3.30890883e-01  6.69109117e-01]
  HOMO = -0.844227129593596  LUMO = 1.04579513013144
  mo_energy =
[-3.27686254e+01 -1.92497235e+00 -8.44227130e-01 -8.44227130e-01
 -8.44227130e-01  1.04579513e+00  1.04579513e+00  1.04579513e+00
  1.81633979e+00  5.38199394e+00  5.38199394e+00  5.38199394e+00
  8.66004852e+00  2.22149681e+01  2.22149681e+01  2.22149681e+01
  3.51015370e+01  1.07279140e+02  1.07279140e+02  1.07279140e+02
  1.38575437e+02  5.02695398e+02  1.87036423e+03  8.00002133e+03
  4.77676655e+04]
E1 = -182.5992316597169  E_coul = 54.071448516504965
cycle= 3 E= -128.527783143212  delta_E= -0.000831  |g|= 0.000469  |ddm|= 0.119
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000947381
diis-c [-3.71822809e-08 -2.01548243e-03  1.13832469e-04  1.00190165e+00]
  HOMO = -0.844464702776447  LUMO = 1.04574703537625
  mo_energy =
[-3.27690852e+01 -1.92518998e+00 -8.44464703e-01 -8.44464703e-01
 -8.44464703e-01  1.04574704e+00  1.04574704e+00  1.04574704e+00
  1.81623108e+00  5.38178186e+00  5.38178186e+00  5.38178186e+00
  8.65982338e+00  2.22146148e+01  2.22146148e+01  2.22146148e+01
  3.51011799e+01  1.07278678e+02  1.07278678e+02  1.07278678e+02
  1.38574981e+02  5.02694849e+02  1.87036358e+03  8.00002061e+03
  4.77676648e+04]
E1 = -182.5998801073511  E_coul = 54.072096950153735
cycle= 4 E= -128.527783157197  delta_E= -1.4e-08  |g|= 4.51e-05  |ddm|= 0.00541
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.22977e-05
diis-c [-1.72584030e-10  7.34300365e-05  2.35359200e-04 -8.46406677e-02
  1.08433188e+00]
  HOMO = -0.844488242747616  LUMO = 1.04573748896761
  mo_energy =
[-3.27691267e+01 -1.92521340e+00 -8.44488243e-01 -8.44488243e-01
 -8.44488243e-01  1.04573749e+00  1.04573749e+00  1.04573749e+00
  1.81621502e+00  5.38175468e+00  5.38175468e+00  5.38175468e+00
  8.65979534e+00  2.22145774e+01  2.22145774e+01  2.22145774e+01
  3.51011421e+01  1.07278637e+02  1.07278637e+02  1.07278637e+02
  1.38574940e+02  5.02694806e+02  1.87036354e+03  8.00002056e+03
  4.77676647e+04]
E1 = -182.59996478304825  E_coul = 54.07218162570718
cycle= 5 E= -128.527783157341  delta_E= -1.44e-10  |g|= 1.2e-06  |ddm|= 0.000424
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59996478304825  E_coul = 54.07218162570718
  HOMO = -0.844487666459681  LUMO = 1.04573768948096
  mo_energy =
[-3.27691251e+01 -1.92521272e+00 -8.44487666e-01 -8.44487666e-01
 -8.44487666e-01  1.04573769e+00  1.04573769e+00  1.04573769e+00
  1.81621537e+00  5.38175536e+00  5.38175536e+00  5.38175536e+00
  8.65979610e+00  2.22145786e+01  2.22145786e+01  2.22145786e+01
  3.51011434e+01  1.07278638e+02  1.07278638e+02  1.07278638e+02
  1.38574941e+02  5.02694807e+02  1.87036354e+03  8.00002057e+03
  4.77676647e+04]
E1 = -182.5999605212226  E_coul = 54.07217736388149
Extra cycle  E= -128.527783157341  delta_E= -5.68e-14  |g|= 5.74e-07  |ddm|= 5.32e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 54409.3270288645
E1 = -182.5999605212226  E_coul = 54.07217736388149
init E= -128.527783157341
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.844487971297592  LUMO = 1.04573758419481
  mo_energy =
[-3.27691260e+01 -1.92521302e+00 -8.44487971e-01 -8.44487971e-01
 -8.44487971e-01  1.04573758e+00  1.04573758e+00  1.04573758e+00
  1.81621521e+00  5.38175500e+00  5.38175500e+00  5.38175500e+00
  8.65979573e+00  2.22145780e+01  2.22145780e+01  2.22145780e+01
  3.51011427e+01  1.07278637e+02  1.07278637e+02  1.07278637e+02
  1.38574940e+02  5.02694806e+02  1.87036354e+03  8.00002057e+03
  4.77676647e+04]
E1 = -182.59996264392413  E_coul = 54.07217948658302
cycle= 1 E= -128.527783157341  delta_E= 2.84e-14  |g|= 2.91e-07  |ddm|= 3.69e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.59996264392413  E_coul = 54.07217948658302
  HOMO = -0.844487822583505  LUMO = 1.04573763541786
  mo_energy =
[-3.27691255e+01 -1.92521287e+00 -8.44487823e-01 -8.44487823e-01
 -8.44487823e-01  1.04573764e+00  1.04573764e+00  1.04573764e+00
  1.81621529e+00  5.38175518e+00  5.38175518e+00  5.38175518e+00
  8.65979592e+00  2.22145783e+01  2.22145783e+01  2.22145783e+01
  3.51011431e+01  1.07278638e+02  1.07278638e+02  1.07278638e+02
  1.38574941e+02  5.02694807e+02  1.87036354e+03  8.00002057e+03
  4.77676647e+04]
E1 = -182.59996157841462  E_coul = 54.07217842107373
Extra cycle  E= -128.527783157341  delta_E= 2.27e-13  |g|= 1.45e-07  |ddm|= 6.29e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.37 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272572e+02 2.35720224e+02
 7.64895555e+01 9.76205875e+00 2.71569106e+01 5.17477344e-01
 2.05510731e+00 1.95478500e+00 3.46396979e+00 1.14585222e+01
 4.97320331e+01 3.20751567e-01 1.09220508e+00]
grad_E = [-2.68410947e-09  1.42675800e-07 -2.82982084e-06  3.48595939e-05
 -2.68326369e-04 -3.14155554e-03  1.42559025e-03  3.74143286e-03
  1.29198595e-03  1.89514335e-03  9.30263943e-04 -6.16394664e-04
 -1.45500991e-05  1.19103614e-03 -9.83704550e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45438985        1
[INPUT] 0    0    [1    /1   ]  833.272596349        1
[INPUT] 0    0    [1    /1   ]  235.719937028        1
[INPUT] 0    0    [1    /1   ]  76.4914875848        1
[INPUT] 0    0    [1    /1   ]  9.74317530435        1
[INPUT] 0    0    [1    /1   ]  27.1517442837        1
[INPUT] 0    0    [1    /1   ]  0.516096523606       1
[INPUT] 0    0    [1    /1   ]  1.96610831525        1
[INPUT] 0    0    [1    /1   ]  2.01479457366        1
[INPUT] 1    0    [1    /1   ]  3.49557780431        1
[INPUT] 1    0    [1    /1   ]  11.6945164063        1
[INPUT] 1    0    [1    /1   ]  51.690854436         1
[INPUT] 1    0    [1    /1   ]  0.322108350064       1
[INPUT] 1    0    [1    /1   ]  1.09992901237        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413154823, 1.0]], [0, [3661.454389845813, 1.0]], [0, [833.2725963488648, 1.0]], [0, [235.7199370277153, 1.0]], [0, [76.49148758480786, 1.0]], [0, [9.743175304352823, 1.0]], [0, [27.151744283747032, 1.0]], [0, [0.5160965236055004, 1.0]], [0, [1.9661083152527645, 1.0]], [0, [2.01479457366226, 1.0]], [1, [3.4955778043073793, 1.0]], [1, [11.694516406278842, 1.0]], [1, [51.69085443604429, 1.0]], [1, [0.32210835006439387, 1.0]], [1, [1.0999290123664995, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438985]
bas 2, expnt(s) = [833.27259635]
bas 3, expnt(s) = [235.71993703]
bas 4, expnt(s) = [76.49148758]
bas 5, expnt(s) = [9.7431753]
bas 6, expnt(s) = [27.15174428]
bas 7, expnt(s) = [0.51609652]
bas 8, expnt(s) = [1.96610832]
bas 9, expnt(s) = [2.01479457]
bas 10, expnt(s) = [3.4955778]
bas 11, expnt(s) = [11.69451641]
bas 12, expnt(s) = [51.69085444]
bas 13, expnt(s) = [0.32210835]
bas 14, expnt(s) = [1.09992901]
CPU time:       123.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272596e+02 3.91836915e+02 2.35719937e+02 1.51989036e+02
 7.64914876e+01 6.53468796e+01 9.74317530e+00 1.39328644e+01
 2.71517443e+01 3.00513042e+01 5.16096524e-01 1.53837858e+00
 1.96610832e+00 4.19489026e+00 2.01479457e+00 4.27255934e+00
 3.49557780e+00 1.39438631e+01 1.16945164e+01 6.30902469e+01
 5.16908544e+01 4.04344492e+02 3.22108350e-01 7.07924384e-01
 1.09992901e+00 3.28617142e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998070314844071
cond(S) = 226624.24110455997
E1 = -183.5693098058369  E_coul = 55.07766113394914
init E= -128.491648671888
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773953990928798  LUMO = 1.07644950447587
  mo_energy =
[-3.25554403e+01 -1.85098262e+00 -7.73953991e-01 -7.73953991e-01
 -7.73953991e-01  1.07644950e+00  1.07644950e+00  1.07644950e+00
  1.84392193e+00  5.50999945e+00  5.50999945e+00  5.50999945e+00
  8.68130270e+00  2.27206202e+01  2.27206202e+01  2.27206202e+01
  3.51045363e+01  1.11314555e+02  1.11314555e+02  1.11314555e+02
  1.38586139e+02  5.02743132e+02  1.87046062e+03  8.00016513e+03
  4.77678544e+04]
E1 = -182.11708712886067  E_coul = 53.5925236236889
cycle= 1 E= -128.524563505172  delta_E= -0.0329  |g|=  0.2  |ddm|= 20.2
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.446502
diis-c [-0.19936363  1.        ]
  HOMO = -0.87828414557246  LUMO = 1.04065725191764
  mo_energy =
[-3.28727915e+01 -1.96086081e+00 -8.78284146e-01 -8.78284146e-01
 -8.78284146e-01  1.04065725e+00  1.04065725e+00  1.04065725e+00
  1.78632472e+00  5.38677458e+00  5.38677458e+00  5.38677458e+00
  8.55431832e+00  2.24919892e+01  2.24919892e+01  2.24919892e+01
  3.48674816e+01  1.10997435e+02  1.10997435e+02  1.10997435e+02
  1.38274287e+02  5.02386889e+02  1.87006815e+03  7.99974373e+03
  4.77674140e+04]
E1 = -182.84155755919386  E_coul = 54.314516036282114
cycle= 2 E= -128.527041522912  delta_E= -0.00248  |g|= 0.0989  |ddm|= 0.426
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.221683
diis-c [-5.82732245e-04  3.30771665e-01  6.69228335e-01]
  HOMO = -0.844259901178466  LUMO = 1.05244399904176
  mo_energy =
[-3.27686249e+01 -1.92495579e+00 -8.44259901e-01 -8.44259901e-01
 -8.44259901e-01  1.05244400e+00  1.05244400e+00  1.05244400e+00
  1.80490665e+00  5.42686458e+00  5.42686458e+00  5.42686458e+00
  8.59573747e+00  2.25672090e+01  2.25672090e+01  2.25672090e+01
  3.49458076e+01  1.11100938e+02  1.11100938e+02  1.11100938e+02
  1.38376391e+02  5.02499609e+02  1.87018601e+03  7.99986398e+03
  4.77675352e+04]
E1 = -182.59912286114016  E_coul = 54.07125218690688
cycle= 3 E= -128.527870674233  delta_E= -0.000829  |g|= 0.000486  |ddm|= 0.429
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000973355
diis-c [-3.94041133e-08 -2.03499798e-03  2.10195951e-04  1.00182480e+00]
  HOMO = -0.844505622359626  LUMO = 1.05239180712767
  mo_energy =
[-3.27690977e+01 -1.92518090e+00 -8.44505622e-01 -8.44505622e-01
 -8.44505622e-01  1.05239181e+00  1.05239181e+00  1.05239181e+00
  1.80479294e+00  5.42664189e+00  5.42664189e+00  5.42664189e+00
  8.59550385e+00  2.25668418e+01  2.25668418e+01  2.25668418e+01
  3.49454389e+01  1.11100460e+02  1.11100460e+02  1.11100460e+02
  1.38375922e+02  5.02499047e+02  1.87018535e+03  7.99986325e+03
  4.77675344e+04]
E1 = -182.59979514937717  E_coul = 54.071924460109976
cycle= 4 E= -128.527870689267  delta_E= -1.5e-08  |g|= 4.62e-05  |ddm|= 0.0225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.40444e-05
diis-c [-1.74636554e-10  7.91247046e-05  2.34884747e-04 -8.73912757e-02
  1.08707727e+00]
  HOMO = -0.844529814023831  LUMO = 1.05238192289762
  mo_energy =
[-3.27691401e+01 -1.92520478e+00 -8.44529814e-01 -8.44529814e-01
 -8.44529814e-01  1.05238192e+00  1.05238192e+00  1.05238192e+00
  1.80477659e+00  5.42661387e+00  5.42661387e+00  5.42661387e+00
  8.59547522e+00  2.25668034e+01  2.25668034e+01  2.25668034e+01
  3.49454002e+01  1.11100418e+02  1.11100418e+02  1.11100418e+02
  1.38375880e+02  5.02499003e+02  1.87018530e+03  7.99986320e+03
  4.77675343e+04]
E1 = -182.59988142846188  E_coul = 54.07201073904415
cycle= 5 E= -128.527870689418  delta_E= -1.51e-10  |g|= 1.29e-06  |ddm|= 0.00181
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59988142846188  E_coul = 54.07201073904415
  HOMO = -0.844529188249094  LUMO = 1.05238214787123
  mo_energy =
[-3.27691384e+01 -1.92520403e+00 -8.44529188e-01 -8.44529188e-01
 -8.44529188e-01  1.05238215e+00  1.05238215e+00  1.05238215e+00
  1.80477699e+00  5.42661462e+00  5.42661462e+00  5.42661462e+00
  8.59547604e+00  2.25668048e+01  2.25668048e+01  2.25668048e+01
  3.49454016e+01  1.11100419e+02  1.11100419e+02  1.11100419e+02
  1.38375881e+02  5.02499004e+02  1.87018530e+03  7.99986320e+03
  4.77675343e+04]
E1 = -182.59987703259318  E_coul = 54.072006343175076
Extra cycle  E= -128.527870689418  delta_E= -3.69e-13  |g|= 5.94e-07  |ddm|= 2.2e-05
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272596e+02 2.35719937e+02
 7.64914876e+01 9.74317530e+00 2.71517443e+01 5.16096524e-01
 1.96610832e+00 2.01479457e+00 3.49557780e+00 1.16945164e+01
 5.16908544e+01 3.22108350e-01 1.09992901e+00]
E = -128.5278706894181
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45438985        1
[INPUT] 0    0    [1    /1   ]  833.272596349        1
[INPUT] 0    0    [1    /1   ]  235.719937028        1
[INPUT] 0    0    [1    /1   ]  76.4914875848        1
[INPUT] 0    0    [1    /1   ]  9.74317530435        1
[INPUT] 0    0    [1    /1   ]  27.1517442837        1
[INPUT] 0    0    [1    /1   ]  0.516096523606       1
[INPUT] 0    0    [1    /1   ]  1.96610831525        1
[INPUT] 0    0    [1    /1   ]  2.01479457366        1
[INPUT] 1    0    [1    /1   ]  3.49557780431        1
[INPUT] 1    0    [1    /1   ]  11.6945164063        1
[INPUT] 1    0    [1    /1   ]  51.690854436         1
[INPUT] 1    0    [1    /1   ]  0.322108350064       1
[INPUT] 1    0    [1    /1   ]  1.09992901237        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413154823, 1.0]], [0, [3661.454389845813, 1.0]], [0, [833.2725963488648, 1.0]], [0, [235.7199370277153, 1.0]], [0, [76.49148758480786, 1.0]], [0, [9.743175304352823, 1.0]], [0, [27.151744283747032, 1.0]], [0, [0.5160965236055004, 1.0]], [0, [1.9661083152527645, 1.0]], [0, [2.01479457366226, 1.0]], [1, [3.4955778043073793, 1.0]], [1, [11.694516406278842, 1.0]], [1, [51.69085443604429, 1.0]], [1, [0.32210835006439387, 1.0]], [1, [1.0999290123664995, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438985]
bas 2, expnt(s) = [833.27259635]
bas 3, expnt(s) = [235.71993703]
bas 4, expnt(s) = [76.49148758]
bas 5, expnt(s) = [9.7431753]
bas 6, expnt(s) = [27.15174428]
bas 7, expnt(s) = [0.51609652]
bas 8, expnt(s) = [1.96610832]
bas 9, expnt(s) = [2.01479457]
bas 10, expnt(s) = [3.4955778]
bas 11, expnt(s) = [11.69451641]
bas 12, expnt(s) = [51.69085444]
bas 13, expnt(s) = [0.32210835]
bas 14, expnt(s) = [1.09992901]
CPU time:       123.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272596e+02 3.91836915e+02 2.35719937e+02 1.51989036e+02
 7.64914876e+01 6.53468796e+01 9.74317530e+00 1.39328644e+01
 2.71517443e+01 3.00513042e+01 5.16096524e-01 1.53837858e+00
 1.96610832e+00 4.19489026e+00 2.01479457e+00 4.27255934e+00
 3.49557780e+00 1.39438631e+01 1.16945164e+01 6.30902469e+01
 5.16908544e+01 4.04344492e+02 3.22108350e-01 7.07924384e-01
 1.09992901e+00 3.28617142e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998070314844071
cond(S) = 226624.24110455997
E1 = -183.5693098058369  E_coul = 55.07766113394914
init E= -128.491648671888
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773953990928798  LUMO = 1.07644950447587
  mo_energy =
[-3.25554403e+01 -1.85098262e+00 -7.73953991e-01 -7.73953991e-01
 -7.73953991e-01  1.07644950e+00  1.07644950e+00  1.07644950e+00
  1.84392193e+00  5.50999945e+00  5.50999945e+00  5.50999945e+00
  8.68130270e+00  2.27206202e+01  2.27206202e+01  2.27206202e+01
  3.51045363e+01  1.11314555e+02  1.11314555e+02  1.11314555e+02
  1.38586139e+02  5.02743132e+02  1.87046062e+03  8.00016513e+03
  4.77678544e+04]
E1 = -182.11708712886067  E_coul = 53.5925236236889
cycle= 1 E= -128.524563505172  delta_E= -0.0329  |g|=  0.2  |ddm|= 20.2
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.446502
diis-c [-0.19936363  1.        ]
  HOMO = -0.87828414557246  LUMO = 1.04065725191764
  mo_energy =
[-3.28727915e+01 -1.96086081e+00 -8.78284146e-01 -8.78284146e-01
 -8.78284146e-01  1.04065725e+00  1.04065725e+00  1.04065725e+00
  1.78632472e+00  5.38677458e+00  5.38677458e+00  5.38677458e+00
  8.55431832e+00  2.24919892e+01  2.24919892e+01  2.24919892e+01
  3.48674816e+01  1.10997435e+02  1.10997435e+02  1.10997435e+02
  1.38274287e+02  5.02386889e+02  1.87006815e+03  7.99974373e+03
  4.77674140e+04]
E1 = -182.84155755919386  E_coul = 54.314516036282114
cycle= 2 E= -128.527041522912  delta_E= -0.00248  |g|= 0.0989  |ddm|= 0.426
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.221683
diis-c [-5.82732245e-04  3.30771665e-01  6.69228335e-01]
  HOMO = -0.844259901178466  LUMO = 1.05244399904176
  mo_energy =
[-3.27686249e+01 -1.92495579e+00 -8.44259901e-01 -8.44259901e-01
 -8.44259901e-01  1.05244400e+00  1.05244400e+00  1.05244400e+00
  1.80490665e+00  5.42686458e+00  5.42686458e+00  5.42686458e+00
  8.59573747e+00  2.25672090e+01  2.25672090e+01  2.25672090e+01
  3.49458076e+01  1.11100938e+02  1.11100938e+02  1.11100938e+02
  1.38376391e+02  5.02499609e+02  1.87018601e+03  7.99986398e+03
  4.77675352e+04]
E1 = -182.59912286114016  E_coul = 54.07125218690688
cycle= 3 E= -128.527870674233  delta_E= -0.000829  |g|= 0.000486  |ddm|= 0.429
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000973355
diis-c [-3.94041133e-08 -2.03499798e-03  2.10195951e-04  1.00182480e+00]
  HOMO = -0.844505622359626  LUMO = 1.05239180712767
  mo_energy =
[-3.27690977e+01 -1.92518090e+00 -8.44505622e-01 -8.44505622e-01
 -8.44505622e-01  1.05239181e+00  1.05239181e+00  1.05239181e+00
  1.80479294e+00  5.42664189e+00  5.42664189e+00  5.42664189e+00
  8.59550385e+00  2.25668418e+01  2.25668418e+01  2.25668418e+01
  3.49454389e+01  1.11100460e+02  1.11100460e+02  1.11100460e+02
  1.38375922e+02  5.02499047e+02  1.87018535e+03  7.99986325e+03
  4.77675344e+04]
E1 = -182.59979514937717  E_coul = 54.071924460109976
cycle= 4 E= -128.527870689267  delta_E= -1.5e-08  |g|= 4.62e-05  |ddm|= 0.0225
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=9.40444e-05
diis-c [-1.74636554e-10  7.91247046e-05  2.34884747e-04 -8.73912757e-02
  1.08707727e+00]
  HOMO = -0.844529814023831  LUMO = 1.05238192289762
  mo_energy =
[-3.27691401e+01 -1.92520478e+00 -8.44529814e-01 -8.44529814e-01
 -8.44529814e-01  1.05238192e+00  1.05238192e+00  1.05238192e+00
  1.80477659e+00  5.42661387e+00  5.42661387e+00  5.42661387e+00
  8.59547522e+00  2.25668034e+01  2.25668034e+01  2.25668034e+01
  3.49454002e+01  1.11100418e+02  1.11100418e+02  1.11100418e+02
  1.38375880e+02  5.02499003e+02  1.87018530e+03  7.99986320e+03
  4.77675343e+04]
E1 = -182.59988142846188  E_coul = 54.07201073904415
cycle= 5 E= -128.527870689418  delta_E= -1.51e-10  |g|= 1.29e-06  |ddm|= 0.00181
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59988142846188  E_coul = 54.07201073904415
  HOMO = -0.844529188249094  LUMO = 1.05238214787123
  mo_energy =
[-3.27691384e+01 -1.92520403e+00 -8.44529188e-01 -8.44529188e-01
 -8.44529188e-01  1.05238215e+00  1.05238215e+00  1.05238215e+00
  1.80477699e+00  5.42661462e+00  5.42661462e+00  5.42661462e+00
  8.59547604e+00  2.25668048e+01  2.25668048e+01  2.25668048e+01
  3.49454016e+01  1.11100419e+02  1.11100419e+02  1.11100419e+02
  1.38375881e+02  5.02499004e+02  1.87018530e+03  7.99986320e+03
  4.77675343e+04]
E1 = -182.59987703259318  E_coul = 54.072006343175076
Extra cycle  E= -128.527870689418  delta_E= -3.69e-13  |g|= 5.94e-07  |ddm|= 2.2e-05
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 226624.24110455997
E1 = -182.59987703259318  E_coul = 54.072006343175076
init E= -128.527870689418
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.844529502415515  LUMO = 1.05238203908521
  mo_energy =
[-3.27691393e+01 -1.92520434e+00 -8.44529502e-01 -8.44529502e-01
 -8.44529502e-01  1.05238204e+00  1.05238204e+00  1.05238204e+00
  1.80477683e+00  5.42661425e+00  5.42661425e+00  5.42661425e+00
  8.59547567e+00  2.25668041e+01  2.25668041e+01  2.25668041e+01
  3.49454009e+01  1.11100419e+02  1.11100419e+02  1.11100419e+02
  1.38375880e+02  5.02499003e+02  1.87018530e+03  7.99986320e+03
  4.77675343e+04]
E1 = -182.5998792422849  E_coul = 54.07200855286705
cycle= 1 E= -128.527870689418  delta_E= 2.56e-13  |g|= 3.03e-07  |ddm|= 4.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5998792422849  E_coul = 54.07200855286705
  HOMO = -0.844529347646087  LUMO = 1.05238209293881
  mo_energy =
[-3.27691388e+01 -1.92520418e+00 -8.44529348e-01 -8.44529348e-01
 -8.44529348e-01  1.05238209e+00  1.05238209e+00  1.05238209e+00
  1.80477692e+00  5.42661443e+00  5.42661443e+00  5.42661443e+00
  8.59547586e+00  2.25668044e+01  2.25668044e+01  2.25668044e+01
  3.49454013e+01  1.11100419e+02  1.11100419e+02  1.11100419e+02
  1.38375881e+02  5.02499004e+02  1.87018530e+03  7.99986320e+03
  4.77675343e+04]
E1 = -182.5998781360196  E_coul = 54.07200744660168
Extra cycle  E= -128.527870689418  delta_E= -8.53e-14  |g|= 1.51e-07  |ddm|= 2.55e-06
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272596e+02 2.35719937e+02
 7.64914876e+01 9.74317530e+00 2.71517443e+01 5.16096524e-01
 1.96610832e+00 2.01479457e+00 3.49557780e+00 1.16945164e+01
 5.16908544e+01 3.22108350e-01 1.09992901e+00]
grad_E = [-2.76588091e-09  1.47050115e-07 -2.91702745e-06  3.59831787e-05
 -2.77539530e-04 -3.25584558e-03  1.48038710e-03  3.19700348e-03
  1.71278981e-03  1.41389244e-03 -6.35378762e-04 -4.54756863e-04
  3.10280931e-05 -2.23399114e-03  2.01193198e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438499        1
[INPUT] 0    0    [1    /1   ]  833.272692434        1
[INPUT] 0    0    [1    /1   ]  235.718816253        1
[INPUT] 0    0    [1    /1   ]  76.4990211209        1
[INPUT] 0    0    [1    /1   ]  9.66890282984        1
[INPUT] 0    0    [1    /1   ]  27.1316316825        1
[INPUT] 0    0    [1    /1   ]  0.51362219335        1
[INPUT] 0    0    [1    /1   ]  1.615283206          1
[INPUT] 0    0    [1    /1   ]  2.25394890643        1
[INPUT] 1    0    [1    /1   ]  3.68868915795        1
[INPUT] 1    0    [1    /1   ]  12.7715254886        1
[INPUT] 1    0    [1    /1   ]  59.3387848262        1
[INPUT] 1    0    [1    /1   ]  0.331058625916       1
[INPUT] 1    0    [1    /1   ]  1.14573758408        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131633844, 1.0]], [0, [3661.4543849861416, 1.0]], [0, [833.2726924344297, 1.0]], [0, [235.7188162533195, 1.0]], [0, [76.49902112094449, 1.0]], [0, [9.668902829844805, 1.0]], [0, [27.131631682549415, 1.0]], [0, [0.5136221933504459, 1.0]], [0, [1.6152832059976887, 1.0]], [0, [2.2539489064310416, 1.0]], [1, [3.688689157947966, 1.0]], [1, [12.771525488571502, 1.0]], [1, [59.338784826161145, 1.0]], [1, [0.3310586259159761, 1.0]], [1, [1.145737584078729, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413163]
bas 1, expnt(s) = [3661.45438499]
bas 2, expnt(s) = [833.27269243]
bas 3, expnt(s) = [235.71881625]
bas 4, expnt(s) = [76.49902112]
bas 5, expnt(s) = [9.66890283]
bas 6, expnt(s) = [27.13163168]
bas 7, expnt(s) = [0.51362219]
bas 8, expnt(s) = [1.61528321]
bas 9, expnt(s) = [2.25394891]
bas 10, expnt(s) = [3.68868916]
bas 11, expnt(s) = [12.77152549]
bas 12, expnt(s) = [59.33878483]
bas 13, expnt(s) = [0.33105863]
bas 14, expnt(s) = [1.14573758]
CPU time:       126.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272692e+02 3.91836949e+02 2.35718816e+02 1.51988494e+02
 7.64990211e+01 6.53517065e+01 9.66890283e+00 1.38531304e+01
 2.71316317e+01 3.00346074e+01 5.13622193e-01 1.53284365e+00
 1.61528321e+00 3.61994134e+00 2.25394891e+00 4.64753934e+00
 3.68868916e+00 1.49133245e+01 1.27715255e+01 7.04348932e+01
 5.93387848e+01 4.80460516e+02 3.31058626e-01 7.32597661e-01
 1.14573758e+00 3.45812623e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997839593571591
cond(S) = 1378.5293392134308
E1 = -183.57222608328283  E_coul = 55.07869797469045
init E= -128.493528108592
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773838825351909  LUMO = 1.11929817238125
  mo_energy =
[-3.25551290e+01 -1.85122944e+00 -7.73838825e-01 -7.73838825e-01
 -7.73838825e-01  1.11929817e+00  1.11929817e+00  1.11929817e+00
  1.76345905e+00  5.78765686e+00  5.78765686e+00  5.78765686e+00
  8.33192317e+00  2.45511686e+01  2.45511686e+01  2.45511686e+01
  3.44720082e+01  1.27216825e+02  1.27216825e+02  1.27216825e+02
  1.37826093e+02  5.02001599e+02  1.86978682e+03  7.99957058e+03
  4.77673620e+04]
E1 = -182.13567702912295  E_coul = 53.61072109528232
cycle= 1 E= -128.524955933841  delta_E= -0.0314  |g|= 0.198  |ddm|= 0.203
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.43596
diis-c [-0.19006117  1.        ]
  HOMO = -0.876751119850259  LUMO = 1.08224730838133
  mo_energy =
[-3.28694274e+01 -1.95986506e+00 -8.76751120e-01 -8.76751120e-01
 -8.76751120e-01  1.08224731e+00  1.08224731e+00  1.08224731e+00
  1.70905509e+00  5.66128534e+00  5.66128534e+00  5.66128534e+00
  8.20893644e+00  2.43181528e+01  2.43181528e+01  2.43181528e+01
  3.42376853e+01  1.26896823e+02  1.26896823e+02  1.26896823e+02
  1.37517160e+02  5.01648540e+02  1.86939773e+03  7.99915265e+03
  4.77669251e+04]
E1 = -182.85059481783816  E_coul = 54.323210299360966
cycle= 2 E= -128.527384518477  delta_E= -0.00243  |g|= 0.0976  |ddm|= 0.0715
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215912
diis-c [-5.77625305e-04  3.30175888e-01  6.69824112e-01]
  HOMO = -0.843153924262311  LUMO = 1.0944688026635
  mo_energy =
[-3.27664825e+01 -1.92443806e+00 -8.43153924e-01 -8.43153924e-01
 -8.43153924e-01  1.09446880e+00  1.09446880e+00  1.09446880e+00
  1.72658987e+00  5.70242766e+00  5.70242766e+00  5.70242766e+00
  8.24904541e+00  2.43947605e+01  2.43947605e+01  2.43947605e+01
  3.43149774e+01  1.27000728e+02  1.27000728e+02  1.27000728e+02
  1.37618100e+02  5.01759991e+02  1.86951428e+03  7.99927159e+03
  4.77670449e+04]
E1 = -182.61179063397952  E_coul = 54.08359943757529
cycle= 3 E= -128.528191196404  delta_E= -0.000807  |g|= 0.000481  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000916174
diis-c [-3.99970985e-08 -2.07029499e-03 -3.10378852e-05  1.00210133e+00]
  HOMO = -0.843391874992217  LUMO = 1.09441394650118
  mo_energy =
[-3.27669525e+01 -1.92468087e+00 -8.43391875e-01 -8.43391875e-01
 -8.43391875e-01  1.09441395e+00  1.09441395e+00  1.09441395e+00
  1.72646964e+00  5.70220051e+00  5.70220051e+00  5.70220051e+00
  8.24881277e+00  2.43943857e+01  2.43943857e+01  2.43943857e+01
  3.43146069e+01  1.27000245e+02  1.27000245e+02  1.27000245e+02
  1.37617635e+02  5.01759445e+02  1.86951364e+03  7.99927089e+03
  4.77670442e+04]
E1 = -182.61246430727934  E_coul = 54.08427309611548
cycle= 4 E= -128.528191211164  delta_E= -1.48e-08  |g|= 4.28e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.16249e-05
diis-c [-4.01956135e-10  1.12297350e-04  1.34851640e-04 -1.04161598e-01
  1.10391445e+00]
  HOMO = -0.843412991584526  LUMO = 1.09440449706656
  mo_energy =
[-3.27669888e+01 -1.92470671e+00 -8.43412992e-01 -8.43412992e-01
 -8.43412992e-01  1.09440450e+00  1.09440450e+00  1.09440450e+00
  1.72645226e+00  5.70217482e+00  5.70217482e+00  5.70217482e+00
  8.24878563e+00  2.43943511e+01  2.43943511e+01  2.43943511e+01
  3.43145720e+01  1.27000209e+02  1.27000209e+02  1.27000209e+02
  1.37617599e+02  5.01759409e+02  1.86951361e+03  7.99927086e+03
  4.77670442e+04]
E1 = -182.61253338222397  E_coul = 54.08434217092628
cycle= 5 E= -128.528191211298  delta_E= -1.34e-10  |g|= 3.07e-06  |ddm|= 1.38e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61253338222397  E_coul = 54.08434217092628
  HOMO = -0.843411403995626  LUMO = 1.09440507004607
  mo_energy =
[-3.27669848e+01 -1.92470552e+00 -8.43411404e-01 -8.43411404e-01
 -8.43411404e-01  1.09440507e+00  1.09440507e+00  1.09440507e+00
  1.72645283e+00  5.70217670e+00  5.70217670e+00  5.70217670e+00
  8.24878728e+00  2.43943543e+01  2.43943543e+01  2.43943543e+01
  3.43145751e+01  1.27000213e+02  1.27000213e+02  1.27000213e+02
  1.37617603e+02  5.01759414e+02  1.86951362e+03  7.99927086e+03
  4.77670442e+04]
E1 = -182.61252321184037  E_coul = 54.08433200054166
Extra cycle  E= -128.528191211299  delta_E= -1.02e-12  |g|= 1.47e-06  |ddm|= 1.66e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272692e+02 2.35718816e+02
 7.64990211e+01 9.66890283e+00 2.71316317e+01 5.13622193e-01
 1.61528321e+00 2.25394891e+00 3.68868916e+00 1.27715255e+01
 5.93387848e+01 3.31058626e-01 1.14573758e+00]
E = -128.52819121129872
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438499        1
[INPUT] 0    0    [1    /1   ]  833.272692434        1
[INPUT] 0    0    [1    /1   ]  235.718816253        1
[INPUT] 0    0    [1    /1   ]  76.4990211209        1
[INPUT] 0    0    [1    /1   ]  9.66890282984        1
[INPUT] 0    0    [1    /1   ]  27.1316316825        1
[INPUT] 0    0    [1    /1   ]  0.51362219335        1
[INPUT] 0    0    [1    /1   ]  1.615283206          1
[INPUT] 0    0    [1    /1   ]  2.25394890643        1
[INPUT] 1    0    [1    /1   ]  3.68868915795        1
[INPUT] 1    0    [1    /1   ]  12.7715254886        1
[INPUT] 1    0    [1    /1   ]  59.3387848262        1
[INPUT] 1    0    [1    /1   ]  0.331058625916       1
[INPUT] 1    0    [1    /1   ]  1.14573758408        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131633844, 1.0]], [0, [3661.4543849861416, 1.0]], [0, [833.2726924344297, 1.0]], [0, [235.7188162533195, 1.0]], [0, [76.49902112094449, 1.0]], [0, [9.668902829844805, 1.0]], [0, [27.131631682549415, 1.0]], [0, [0.5136221933504459, 1.0]], [0, [1.6152832059976887, 1.0]], [0, [2.2539489064310416, 1.0]], [1, [3.688689157947966, 1.0]], [1, [12.771525488571502, 1.0]], [1, [59.338784826161145, 1.0]], [1, [0.3310586259159761, 1.0]], [1, [1.145737584078729, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413163]
bas 1, expnt(s) = [3661.45438499]
bas 2, expnt(s) = [833.27269243]
bas 3, expnt(s) = [235.71881625]
bas 4, expnt(s) = [76.49902112]
bas 5, expnt(s) = [9.66890283]
bas 6, expnt(s) = [27.13163168]
bas 7, expnt(s) = [0.51362219]
bas 8, expnt(s) = [1.61528321]
bas 9, expnt(s) = [2.25394891]
bas 10, expnt(s) = [3.68868916]
bas 11, expnt(s) = [12.77152549]
bas 12, expnt(s) = [59.33878483]
bas 13, expnt(s) = [0.33105863]
bas 14, expnt(s) = [1.14573758]
CPU time:       127.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272692e+02 3.91836949e+02 2.35718816e+02 1.51988494e+02
 7.64990211e+01 6.53517065e+01 9.66890283e+00 1.38531304e+01
 2.71316317e+01 3.00346074e+01 5.13622193e-01 1.53284365e+00
 1.61528321e+00 3.61994134e+00 2.25394891e+00 4.64753934e+00
 3.68868916e+00 1.49133245e+01 1.27715255e+01 7.04348932e+01
 5.93387848e+01 4.80460516e+02 3.31058626e-01 7.32597661e-01
 1.14573758e+00 3.45812623e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997839593571591
cond(S) = 1378.5293392134308
E1 = -183.57222608328283  E_coul = 55.07869797469045
init E= -128.493528108592
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773838825351909  LUMO = 1.11929817238125
  mo_energy =
[-3.25551290e+01 -1.85122944e+00 -7.73838825e-01 -7.73838825e-01
 -7.73838825e-01  1.11929817e+00  1.11929817e+00  1.11929817e+00
  1.76345905e+00  5.78765686e+00  5.78765686e+00  5.78765686e+00
  8.33192317e+00  2.45511686e+01  2.45511686e+01  2.45511686e+01
  3.44720082e+01  1.27216825e+02  1.27216825e+02  1.27216825e+02
  1.37826093e+02  5.02001599e+02  1.86978682e+03  7.99957058e+03
  4.77673620e+04]
E1 = -182.13567702912295  E_coul = 53.61072109528232
cycle= 1 E= -128.524955933841  delta_E= -0.0314  |g|= 0.198  |ddm|= 0.203
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.43596
diis-c [-0.19006117  1.        ]
  HOMO = -0.876751119850259  LUMO = 1.08224730838133
  mo_energy =
[-3.28694274e+01 -1.95986506e+00 -8.76751120e-01 -8.76751120e-01
 -8.76751120e-01  1.08224731e+00  1.08224731e+00  1.08224731e+00
  1.70905509e+00  5.66128534e+00  5.66128534e+00  5.66128534e+00
  8.20893644e+00  2.43181528e+01  2.43181528e+01  2.43181528e+01
  3.42376853e+01  1.26896823e+02  1.26896823e+02  1.26896823e+02
  1.37517160e+02  5.01648540e+02  1.86939773e+03  7.99915265e+03
  4.77669251e+04]
E1 = -182.85059481783816  E_coul = 54.323210299360966
cycle= 2 E= -128.527384518477  delta_E= -0.00243  |g|= 0.0976  |ddm|= 0.0715
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215912
diis-c [-5.77625305e-04  3.30175888e-01  6.69824112e-01]
  HOMO = -0.843153924262311  LUMO = 1.0944688026635
  mo_energy =
[-3.27664825e+01 -1.92443806e+00 -8.43153924e-01 -8.43153924e-01
 -8.43153924e-01  1.09446880e+00  1.09446880e+00  1.09446880e+00
  1.72658987e+00  5.70242766e+00  5.70242766e+00  5.70242766e+00
  8.24904541e+00  2.43947605e+01  2.43947605e+01  2.43947605e+01
  3.43149774e+01  1.27000728e+02  1.27000728e+02  1.27000728e+02
  1.37618100e+02  5.01759991e+02  1.86951428e+03  7.99927159e+03
  4.77670449e+04]
E1 = -182.61179063397952  E_coul = 54.08359943757529
cycle= 3 E= -128.528191196404  delta_E= -0.000807  |g|= 0.000481  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000916174
diis-c [-3.99970985e-08 -2.07029499e-03 -3.10378852e-05  1.00210133e+00]
  HOMO = -0.843391874992217  LUMO = 1.09441394650118
  mo_energy =
[-3.27669525e+01 -1.92468087e+00 -8.43391875e-01 -8.43391875e-01
 -8.43391875e-01  1.09441395e+00  1.09441395e+00  1.09441395e+00
  1.72646964e+00  5.70220051e+00  5.70220051e+00  5.70220051e+00
  8.24881277e+00  2.43943857e+01  2.43943857e+01  2.43943857e+01
  3.43146069e+01  1.27000245e+02  1.27000245e+02  1.27000245e+02
  1.37617635e+02  5.01759445e+02  1.86951364e+03  7.99927089e+03
  4.77670442e+04]
E1 = -182.61246430727934  E_coul = 54.08427309611548
cycle= 4 E= -128.528191211164  delta_E= -1.48e-08  |g|= 4.28e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=7.16249e-05
diis-c [-4.01956135e-10  1.12297350e-04  1.34851640e-04 -1.04161598e-01
  1.10391445e+00]
  HOMO = -0.843412991584526  LUMO = 1.09440449706656
  mo_energy =
[-3.27669888e+01 -1.92470671e+00 -8.43412992e-01 -8.43412992e-01
 -8.43412992e-01  1.09440450e+00  1.09440450e+00  1.09440450e+00
  1.72645226e+00  5.70217482e+00  5.70217482e+00  5.70217482e+00
  8.24878563e+00  2.43943511e+01  2.43943511e+01  2.43943511e+01
  3.43145720e+01  1.27000209e+02  1.27000209e+02  1.27000209e+02
  1.37617599e+02  5.01759409e+02  1.86951361e+03  7.99927086e+03
  4.77670442e+04]
E1 = -182.61253338222397  E_coul = 54.08434217092628
cycle= 5 E= -128.528191211298  delta_E= -1.34e-10  |g|= 3.07e-06  |ddm|= 1.38e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61253338222397  E_coul = 54.08434217092628
  HOMO = -0.843411403995626  LUMO = 1.09440507004607
  mo_energy =
[-3.27669848e+01 -1.92470552e+00 -8.43411404e-01 -8.43411404e-01
 -8.43411404e-01  1.09440507e+00  1.09440507e+00  1.09440507e+00
  1.72645283e+00  5.70217670e+00  5.70217670e+00  5.70217670e+00
  8.24878728e+00  2.43943543e+01  2.43943543e+01  2.43943543e+01
  3.43145751e+01  1.27000213e+02  1.27000213e+02  1.27000213e+02
  1.37617603e+02  5.01759414e+02  1.86951362e+03  7.99927086e+03
  4.77670442e+04]
E1 = -182.61252321184037  E_coul = 54.08433200054166
Extra cycle  E= -128.528191211299  delta_E= -1.02e-12  |g|= 1.47e-06  |ddm|= 1.66e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1378.5293392134308
E1 = -182.61252321184037  E_coul = 54.08433200054166
init E= -128.528191211299
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.843412099933585  LUMO = 1.09440481121478
  mo_energy =
[-3.27669870e+01 -1.92470635e+00 -8.43412100e-01 -8.43412100e-01
 -8.43412100e-01  1.09440481e+00  1.09440481e+00  1.09440481e+00
  1.72645241e+00  5.70217583e+00  5.70217583e+00  5.70217583e+00
  8.24878640e+00  2.43943527e+01  2.43943527e+01  2.43943527e+01
  3.43145734e+01  1.27000211e+02  1.27000211e+02  1.27000211e+02
  1.37617600e+02  5.01759412e+02  1.86951361e+03  7.99927086e+03
  4.77670442e+04]
E1 = -182.61252819294162  E_coul = 54.084336981642714
cycle= 1 E= -128.528191211299  delta_E= -1.99e-13  |g|= 6.76e-07  |ddm|= 6.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61252819294162  E_coul = 54.084336981642714
  HOMO = -0.843411746082457  LUMO = 1.09440493900778
  mo_energy =
[-3.27669859e+01 -1.92470599e+00 -8.43411746e-01 -8.43411746e-01
 -8.43411746e-01  1.09440494e+00  1.09440494e+00  1.09440494e+00
  1.72645258e+00  5.70217626e+00  5.70217626e+00  5.70217626e+00
  8.24878681e+00  2.43943535e+01  2.43943535e+01  2.43943535e+01
  3.43145743e+01  1.27000212e+02  1.27000212e+02  1.27000212e+02
  1.37617602e+02  5.01759413e+02  1.86951361e+03  7.99927086e+03
  4.77670442e+04]
E1 = -182.61252567104637  E_coul = 54.08433445974732
Extra cycle  E= -128.528191211299  delta_E= -1.42e-13  |g|= 3.45e-07  |ddm|= 2.48e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272692e+02 2.35718816e+02
 7.64990211e+01 9.66890283e+00 2.71316317e+01 5.13622193e-01
 1.61528321e+00 2.25394891e+00 3.68868916e+00 1.27715255e+01
 5.93387848e+01 3.31058626e-01 1.14573758e+00]
grad_E = [-3.03023919e-09  1.60939367e-07 -3.20140149e-06  3.95100501e-05
 -3.07417268e-04 -3.50139407e-03  1.63157473e-03  1.84133833e-02
  2.02633681e-03 -4.14248279e-04 -3.88567119e-03  1.28846396e-04
  1.07832545e-04 -7.05997940e-03  7.19452567e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45436788        1
[INPUT] 0    0    [1    /1   ]  833.2730307          1
[INPUT] 0    0    [1    /1   ]  235.714859103        1
[INPUT] 0    0    [1    /1   ]  76.525838739         1
[INPUT] 0    0    [1    /1   ]  9.44096373816        1
[INPUT] 0    0    [1    /1   ]  27.0555863787        1
[INPUT] 0    0    [1    /1   ]  0.469099269657       1
[INPUT] 0    0    [1    /1   ]  0.438347118031       1
[INPUT] 0    0    [1    /1   ]  3.03719556188        1
[INPUT] 1    0    [1    /1   ]  4.34323567923        1
[INPUT] 1    0    [1    /1   ]  16.3590121048        1
[INPUT] 1    0    [1    /1   ]  84.8486481108        1
[INPUT] 1    0    [1    /1   ]  0.365057165405       1
[INPUT] 1    0    [1    /1   ]  1.30482646715        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131936254, 1.0]], [0, [3661.4543678816144, 1.0]], [0, [833.2730307003275, 1.0]], [0, [235.71485910274882, 1.0]], [0, [76.52583873903872, 1.0]], [0, [9.440963738164585, 1.0]], [0, [27.0555863787173, 1.0]], [0, [0.4690992696566789, 1.0]], [0, [0.43834711803051496, 1.0]], [0, [3.0371955618801287, 1.0]], [1, [4.343235679232718, 1.0]], [1, [16.359012104827467, 1.0]], [1, [84.84864811081856, 1.0]], [1, [0.3650571654054959, 1.0]], [1, [1.304826467152112, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413194]
bas 1, expnt(s) = [3661.45436788]
bas 2, expnt(s) = [833.2730307]
bas 3, expnt(s) = [235.7148591]
bas 4, expnt(s) = [76.52583874]
bas 5, expnt(s) = [9.44096374]
bas 6, expnt(s) = [27.05558638]
bas 7, expnt(s) = [0.46909927]
bas 8, expnt(s) = [0.43834712]
bas 9, expnt(s) = [3.03719556]
bas 10, expnt(s) = [4.34323568]
bas 11, expnt(s) = [16.3590121]
bas 12, expnt(s) = [84.84864811]
bas 13, expnt(s) = [0.36505717]
bas 14, expnt(s) = [1.30482647]
CPU time:       130.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273031e+02 3.91837069e+02 2.35714859e+02 1.51986581e+02
 7.65258387e+01 6.53688881e+01 9.44096374e+00 1.36074664e+01
 2.70555864e+01 2.99714488e+01 4.69099270e-01 1.43206784e+00
 4.38347118e-01 1.36106429e+00 3.03719556e+00 5.81258868e+00
 4.34323568e+00 1.82915765e+01 1.63590121e+01 9.59799976e+01
 8.48486481e+01 7.51260494e+02 3.65057165e-01 8.27819189e-01
 1.30482647e+00 4.06841587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.990281474646842
cond(S) = 8139.912323880148
E1 = -183.2919694668602  E_coul = 55.00795375393408
init E= -128.284015712926
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.780975849655743  LUMO = 0.808537442011521
  mo_energy =
[-3.25617800e+01 -1.83001411e+00 -7.80975850e-01 -7.80975850e-01
 -7.80975850e-01  8.08537442e-01  1.27387212e+00  1.27387212e+00
  1.27387212e+00  5.39969541e+00  6.76449869e+00  6.76449869e+00
  6.76449869e+00  3.09692130e+01  3.09692130e+01  3.09692130e+01
  3.17182439e+01  1.35194620e+02  1.82315113e+02  1.82315113e+02
  1.82315113e+02  4.99531889e+02  1.86756024e+03  7.99760944e+03
  4.77657370e+04]
E1 = -182.02070623078984  E_coul = 53.55202978756047
cycle= 1 E= -128.468676443229  delta_E= -0.185  |g|= 0.209  |ddm|=   23
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.452378
diis-c [-0.20464571  1.        ]
  HOMO = -0.882610324402307  LUMO = 0.787383119685496
  mo_energy =
[-3.28778341e+01 -1.93533722e+00 -8.82610324e-01 -8.82610324e-01
 -8.82610324e-01  7.87383120e-01  1.23430422e+00  1.23430422e+00
  1.23430422e+00  5.29194796e+00  6.62380257e+00  6.62380257e+00
  6.62380257e+00  3.07184138e+01  3.07184138e+01  3.07184138e+01
  3.14777780e+01  1.34883752e+02  1.81979489e+02  1.81979489e+02
  1.81979489e+02  4.99176445e+02  1.86716902e+03  7.99718902e+03
  4.77652979e+04]
E1 = -182.76451937806584  E_coul = 54.29307543983583
cycle= 2 E= -128.47144393823  delta_E= -0.00277  |g|= 0.103  |ddm|= 4.11
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.221658
diis-c [-0.00073116  0.32759324  0.67240676]
  HOMO = -0.847474918940412  LUMO = 0.796498831749996
  mo_energy =
[-3.27703352e+01 -1.89851839e+00 -8.47474919e-01 -8.47474919e-01
 -8.47474919e-01  7.96498832e-01  1.24927161e+00  1.24927161e+00
  1.24927161e+00  5.33089008e+00  6.67165503e+00  6.67165503e+00
  6.67165503e+00  3.08048641e+01  3.08048641e+01  3.08048641e+01
  3.15598002e+01  1.34989402e+02  1.82091565e+02  1.82091565e+02
  1.82091565e+02  4.99292681e+02  1.86729032e+03  7.99731266e+03
  4.77654224e+04]
E1 = -182.52174381070122  E_coul = 54.049442263764824
cycle= 3 E= -128.472301546936  delta_E= -0.000858  |g|= 0.00165  |ddm|= 0.517
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00234128
diis-c [-4.25924998e-06 -7.92736779e-03 -1.17500067e-02  1.01967737e+00]
  HOMO = -0.847419185035451  LUMO = 0.796673254869166
  mo_energy =
[-3.27704512e+01 -1.89817454e+00 -8.47419185e-01 -8.47419185e-01
 -8.47419185e-01  7.96673255e-01  1.24939048e+00  1.24939048e+00
  1.24939048e+00  5.33128555e+00  6.67174040e+00  6.67174040e+00
  6.67174040e+00  3.08049109e+01  3.08049109e+01  3.08049109e+01
  3.15598861e+01  1.34989260e+02  1.82091303e+02  1.82091303e+02
  1.82091303e+02  4.99292230e+02  1.86728956e+03  7.99731168e+03
  4.77654213e+04]
E1 = -182.5227253250958  E_coul = 54.05042354013605
cycle= 4 E= -128.47230178496  delta_E= -2.38e-07  |g|= 0.0002  |ddm|= 0.0691
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000361863
diis-c [-1.70038127e-09  4.24519470e-04  8.46849335e-04 -1.86723931e-01
  1.18545256e+00]
  HOMO = -0.847415311790082  LUMO = 0.796695097316231
  mo_energy =
[-3.27704833e+01 -1.89812173e+00 -8.47415312e-01 -8.47415312e-01
 -8.47415312e-01  7.96695097e-01  1.24939552e+00  1.24939552e+00
  1.24939552e+00  5.33133383e+00  6.67173995e+00  6.67173995e+00
  6.67173995e+00  3.08049003e+01  3.08049003e+01  3.08049003e+01
  3.15598899e+01  1.34989225e+02  1.82091251e+02  1.82091251e+02
  1.82091251e+02  4.99292150e+02  1.86728943e+03  7.99731152e+03
  4.77654211e+04]
E1 = -182.5228975605868  E_coul = 54.05059577134858
cycle= 5 E= -128.472301789238  delta_E= -4.28e-09  |g|= 9.59e-06  |ddm|= 0.002
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.46206e-06
diis-c [-4.26159270e-12 -3.30701485e-06 -1.97737972e-05 -1.94059581e-05
 -4.33921938e-03  1.00438171e+00]
  HOMO = -0.847416428006069  LUMO = 0.796695040028656
  mo_energy =
[-3.27704831e+01 -1.89812180e+00 -8.47416428e-01 -8.47416428e-01
 -8.47416428e-01  7.96695040e-01  1.24939495e+00  1.24939495e+00
  1.24939495e+00  5.33133269e+00  6.67173943e+00  6.67173943e+00
  6.67173943e+00  3.08049000e+01  3.08049000e+01  3.08049000e+01
  3.15598897e+01  1.34989225e+02  1.82091252e+02  1.82091252e+02
  1.82091252e+02  4.99292150e+02  1.86728943e+03  7.99731152e+03
  4.77654211e+04]
E1 = -182.522890040397  E_coul = 54.05058825114284
cycle= 6 E= -128.472301789254  delta_E= -1.59e-11  |g|= 1.48e-06  |ddm|= 0.0013
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.522890040397  E_coul = 54.05058825114284
  HOMO = -0.847416927838625  LUMO = 0.796694964643041
  mo_energy =
[-3.27704839e+01 -1.89812207e+00 -8.47416928e-01 -8.47416928e-01
 -8.47416928e-01  7.96694965e-01  1.24939472e+00  1.24939472e+00
  1.24939472e+00  5.33133222e+00  6.67173889e+00  6.67173889e+00
  6.67173889e+00  3.08048992e+01  3.08048992e+01  3.08048992e+01
  3.15598890e+01  1.34989224e+02  1.82091251e+02  1.82091251e+02
  1.82091251e+02  4.99292149e+02  1.86728943e+03  7.99731152e+03
  4.77654211e+04]
E1 = -182.52289117411792  E_coul = 54.050589384863706
Extra cycle  E= -128.472301789254  delta_E= -5.68e-14  |g|= 3.1e-07  |ddm|= 0.000183
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273031e+02 2.35714859e+02
 7.65258387e+01 9.44096374e+00 2.70555864e+01 4.69099270e-01
 4.38347118e-01 3.03719556e+00 4.34323568e+00 1.63590121e+01
 8.48486481e+01 3.65057165e-01 1.30482647e+00]
E = -128.4723017892542
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941317        1
[INPUT] 0    0    [1    /1   ]  3661.45438328        1
[INPUT] 0    0    [1    /1   ]  833.272726261        1
[INPUT] 0    0    [1    /1   ]  235.718420538        1
[INPUT] 0    0    [1    /1   ]  76.5017028828        1
[INPUT] 0    0    [1    /1   ]  9.64610892068        1
[INPUT] 0    0    [1    /1   ]  27.1240271522        1
[INPUT] 0    0    [1    /1   ]  0.509169900981       1
[INPUT] 0    0    [1    /1   ]  1.4975895972         1
[INPUT] 0    0    [1    /1   ]  2.33227357198        1
[INPUT] 1    0    [1    /1   ]  3.75414381008        1
[INPUT] 1    0    [1    /1   ]  13.1302741502        1
[INPUT] 1    0    [1    /1   ]  61.8897711546        1
[INPUT] 1    0    [1    /1   ]  0.334458479865       1
[INPUT] 1    0    [1    /1   ]  1.16164647239        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131664086, 1.0]], [0, [3661.454383275689, 1.0]], [0, [833.2727262610194, 1.0]], [0, [235.71842053826242, 1.0]], [0, [76.50170288275392, 1.0]], [0, [9.646108920676783, 1.0]], [0, [27.124027152166203, 1.0]], [0, [0.5091699009810692, 1.0]], [0, [1.4975895972009714, 1.0]], [0, [2.3322735719759504, 1.0]], [1, [3.754143810076441, 1.0]], [1, [13.1302741501971, 1.0]], [1, [61.889771154626885, 1.0]], [1, [0.3344584798649281, 1.0]], [1, [1.1616464723860673, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413166]
bas 1, expnt(s) = [3661.45438328]
bas 2, expnt(s) = [833.27272626]
bas 3, expnt(s) = [235.71842054]
bas 4, expnt(s) = [76.50170288]
bas 5, expnt(s) = [9.64610892]
bas 6, expnt(s) = [27.12402715]
bas 7, expnt(s) = [0.5091699]
bas 8, expnt(s) = [1.4975896]
bas 9, expnt(s) = [2.33227357]
bas 10, expnt(s) = [3.75414381]
bas 11, expnt(s) = [13.13027415]
bas 12, expnt(s) = [61.88977115]
bas 13, expnt(s) = [0.33445848]
bas 14, expnt(s) = [1.16164647]
CPU time:       131.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272726e+02 3.91836961e+02 2.35718421e+02 1.51988303e+02
 7.65017029e+01 6.53534247e+01 9.64610892e+00 1.38286296e+01
 2.71240272e+01 3.00282935e+01 5.09169901e-01 1.52286732e+00
 1.49758960e+00 3.42026405e+00 2.33227357e+00 4.76814707e+00
 3.75414381e+00 1.52448454e+01 1.31302742e+01 7.29166378e+01
 6.18897712e+01 5.06416665e+02 3.34458480e-01 7.42014098e-01
 1.16164647e+00 3.51825137e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99776503230117
cond(S) = 851.572542755516
E1 = -183.57332087465892  E_coul = 55.0790956502313
init E= -128.494225224428
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773774613971805  LUMO = 1.13510335638269
  mo_energy =
[-3.25550049e+01 -1.85137721e+00 -7.73774614e-01 -7.73774614e-01
 -7.73774614e-01  1.13510336e+00  1.13510336e+00  1.13510336e+00
  1.71055443e+00  5.88473224e+00  5.88473224e+00  5.88473224e+00
  8.15442171e+00  2.51765103e+01  2.51765103e+01  2.51765103e+01
  3.42248533e+01  1.32598082e+02  1.32598082e+02  1.32598082e+02
  1.37555850e+02  5.01742264e+02  1.86955194e+03  7.99936350e+03
  4.77671905e+04]
E1 = -182.14285884574278  E_coul = 53.61778401326968
cycle= 1 E= -128.525074832473  delta_E= -0.0308  |g|= 0.197  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.432831
diis-c [-0.18734276  1.        ]
  HOMO = -0.876135192797962  LUMO = 1.09764529632352
  mo_energy =
[-3.28681331e+01 -1.95951572e+00 -8.76135193e-01 -8.76135193e-01
 -8.76135193e-01  1.09764530e+00  1.09764530e+00  1.09764530e+00
  1.65788362e+00  5.75744527e+00  5.75744527e+00  5.75744527e+00
  8.03295804e+00  2.49423658e+01  2.49423658e+01  2.49423658e+01
  3.39914170e+01  1.32277520e+02  1.32277520e+02  1.32277520e+02
  1.37248028e+02  5.01390432e+02  1.86916417e+03  7.99894693e+03
  4.77667550e+04]
E1 = -182.8545262565535  E_coul = 54.32703994645296
cycle= 2 E= -128.527486310101  delta_E= -0.00241  |g|= 0.0971  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.214222
diis-c [-5.76209405e-04  3.30015712e-01  6.69984288e-01]
  HOMO = -0.842682720992102  LUMO = 1.11002139955432
  mo_energy =
[-3.27656155e+01 -1.92425777e+00 -8.42682721e-01 -8.42682721e-01
 -8.42682721e-01  1.11002140e+00  1.11002140e+00  1.11002140e+00
  1.67487401e+00  5.79891629e+00  5.79891629e+00  5.79891629e+00
  8.07259218e+00  2.50193565e+01  2.50193565e+01  2.50193565e+01
  3.40683932e+01  1.32381455e+02  1.32381455e+02  1.32381455e+02
  1.37348565e+02  5.01501441e+02  1.86928026e+03  7.99906541e+03
  4.77668744e+04]
E1 = -182.6170249537974  E_coul = 54.08873976935278
cycle= 3 E= -128.528285184445  delta_E= -0.000799  |g|= 0.000471  |ddm|= 0.0242
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000879728
diis-c [-4.57803191e-08 -2.08110100e-03 -2.15555975e-04  1.00229666e+00]
  HOMO = -0.842911071999866  LUMO = 1.10996870428328
  mo_energy =
[-3.27660734e+01 -1.92450056e+00 -8.42911072e-01 -8.42911072e-01
 -8.42911072e-01  1.10996870e+00  1.10996870e+00  1.10996870e+00
  1.67475723e+00  5.79869547e+00  5.79869547e+00  5.79869547e+00
  8.07236780e+00  2.50189898e+01  2.50189898e+01  2.50189898e+01
  3.40680317e+01  1.32380983e+02  1.32380983e+02  1.32380983e+02
  1.37348112e+02  5.01500912e+02  1.86927966e+03  7.99906474e+03
  4.77668737e+04]
E1 = -182.61768229673854  E_coul = 54.089397097656445
cycle= 4 E= -128.528285199082  delta_E= -1.46e-08  |g|= 4.28e-05  |ddm|= 0.000114
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=6.57157e-05
diis-c [-5.83514058e-10  1.61777716e-04  1.05317385e-04 -1.30098986e-01
  1.12983189e+00]
  HOMO = -0.842930816275558  LUMO = 1.10995954582672
  mo_energy =
[-3.27661075e+01 -1.92452713e+00 -8.42930816e-01 -8.42930816e-01
 -8.42930816e-01  1.10995955e+00  1.10995955e+00  1.10995955e+00
  1.67473966e+00  5.79867092e+00  5.79867092e+00  5.79867092e+00
  8.07234135e+00  2.50189568e+01  2.50189568e+01  2.50189568e+01
  3.40679983e+01  1.32380949e+02  1.32380949e+02  1.32380949e+02
  1.37348079e+02  5.01500881e+02  1.86927963e+03  7.99906471e+03
  4.77668737e+04]
E1 = -182.61774546531132  E_coul = 54.08946026607537
cycle= 5 E= -128.528285199236  delta_E= -1.54e-10  |g|= 4.21e-06  |ddm|= 1.76e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61774546531132  E_coul = 54.08946026607537
  HOMO = -0.842928484924848  LUMO = 1.109960429173
  mo_energy =
[-3.27661018e+01 -1.92452525e+00 -8.42928485e-01 -8.42928485e-01
 -8.42928485e-01  1.10996043e+00  1.10996043e+00  1.10996043e+00
  1.67474060e+00  5.79867371e+00  5.79867371e+00  5.79867371e+00
  8.07234380e+00  2.50189614e+01  2.50189614e+01  2.50189614e+01
  3.40680028e+01  1.32380955e+02  1.32380955e+02  1.32380955e+02
  1.37348084e+02  5.01500887e+02  1.86927963e+03  7.99906472e+03
  4.77668737e+04]
E1 = -182.617731648306  E_coul = 54.08944644906861
Extra cycle  E= -128.528285199237  delta_E= -1.45e-12  |g|= 1.99e-06  |ddm|= 1.89e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272726e+02 2.35718421e+02
 7.65017029e+01 9.64610892e+00 2.71240272e+01 5.09169901e-01
 1.49758960e+00 2.33227357e+00 3.75414381e+00 1.31302742e+01
 6.18897712e+01 3.34458480e-01 1.16164647e+00]
E = -128.5282851992374
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941317        1
[INPUT] 0    0    [1    /1   ]  3661.45438328        1
[INPUT] 0    0    [1    /1   ]  833.272726261        1
[INPUT] 0    0    [1    /1   ]  235.718420538        1
[INPUT] 0    0    [1    /1   ]  76.5017028828        1
[INPUT] 0    0    [1    /1   ]  9.64610892068        1
[INPUT] 0    0    [1    /1   ]  27.1240271522        1
[INPUT] 0    0    [1    /1   ]  0.509169900981       1
[INPUT] 0    0    [1    /1   ]  1.4975895972         1
[INPUT] 0    0    [1    /1   ]  2.33227357198        1
[INPUT] 1    0    [1    /1   ]  3.75414381008        1
[INPUT] 1    0    [1    /1   ]  13.1302741502        1
[INPUT] 1    0    [1    /1   ]  61.8897711546        1
[INPUT] 1    0    [1    /1   ]  0.334458479865       1
[INPUT] 1    0    [1    /1   ]  1.16164647239        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131664086, 1.0]], [0, [3661.454383275689, 1.0]], [0, [833.2727262610194, 1.0]], [0, [235.71842053826242, 1.0]], [0, [76.50170288275392, 1.0]], [0, [9.646108920676783, 1.0]], [0, [27.124027152166203, 1.0]], [0, [0.5091699009810692, 1.0]], [0, [1.4975895972009714, 1.0]], [0, [2.3322735719759504, 1.0]], [1, [3.754143810076441, 1.0]], [1, [13.1302741501971, 1.0]], [1, [61.889771154626885, 1.0]], [1, [0.3344584798649281, 1.0]], [1, [1.1616464723860673, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413166]
bas 1, expnt(s) = [3661.45438328]
bas 2, expnt(s) = [833.27272626]
bas 3, expnt(s) = [235.71842054]
bas 4, expnt(s) = [76.50170288]
bas 5, expnt(s) = [9.64610892]
bas 6, expnt(s) = [27.12402715]
bas 7, expnt(s) = [0.5091699]
bas 8, expnt(s) = [1.4975896]
bas 9, expnt(s) = [2.33227357]
bas 10, expnt(s) = [3.75414381]
bas 11, expnt(s) = [13.13027415]
bas 12, expnt(s) = [61.88977115]
bas 13, expnt(s) = [0.33445848]
bas 14, expnt(s) = [1.16164647]
CPU time:       132.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272726e+02 3.91836961e+02 2.35718421e+02 1.51988303e+02
 7.65017029e+01 6.53534247e+01 9.64610892e+00 1.38286296e+01
 2.71240272e+01 3.00282935e+01 5.09169901e-01 1.52286732e+00
 1.49758960e+00 3.42026405e+00 2.33227357e+00 4.76814707e+00
 3.75414381e+00 1.52448454e+01 1.31302742e+01 7.29166378e+01
 6.18897712e+01 5.06416665e+02 3.34458480e-01 7.42014098e-01
 1.16164647e+00 3.51825137e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99776503230117
cond(S) = 851.572542755516
E1 = -183.57332087465892  E_coul = 55.0790956502313
init E= -128.494225224428
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773774613971805  LUMO = 1.13510335638269
  mo_energy =
[-3.25550049e+01 -1.85137721e+00 -7.73774614e-01 -7.73774614e-01
 -7.73774614e-01  1.13510336e+00  1.13510336e+00  1.13510336e+00
  1.71055443e+00  5.88473224e+00  5.88473224e+00  5.88473224e+00
  8.15442171e+00  2.51765103e+01  2.51765103e+01  2.51765103e+01
  3.42248533e+01  1.32598082e+02  1.32598082e+02  1.32598082e+02
  1.37555850e+02  5.01742264e+02  1.86955194e+03  7.99936350e+03
  4.77671905e+04]
E1 = -182.14285884574278  E_coul = 53.61778401326968
cycle= 1 E= -128.525074832473  delta_E= -0.0308  |g|= 0.197  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.432831
diis-c [-0.18734276  1.        ]
  HOMO = -0.876135192797962  LUMO = 1.09764529632352
  mo_energy =
[-3.28681331e+01 -1.95951572e+00 -8.76135193e-01 -8.76135193e-01
 -8.76135193e-01  1.09764530e+00  1.09764530e+00  1.09764530e+00
  1.65788362e+00  5.75744527e+00  5.75744527e+00  5.75744527e+00
  8.03295804e+00  2.49423658e+01  2.49423658e+01  2.49423658e+01
  3.39914170e+01  1.32277520e+02  1.32277520e+02  1.32277520e+02
  1.37248028e+02  5.01390432e+02  1.86916417e+03  7.99894693e+03
  4.77667550e+04]
E1 = -182.8545262565535  E_coul = 54.32703994645296
cycle= 2 E= -128.527486310101  delta_E= -0.00241  |g|= 0.0971  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.214222
diis-c [-5.76209405e-04  3.30015712e-01  6.69984288e-01]
  HOMO = -0.842682720992102  LUMO = 1.11002139955432
  mo_energy =
[-3.27656155e+01 -1.92425777e+00 -8.42682721e-01 -8.42682721e-01
 -8.42682721e-01  1.11002140e+00  1.11002140e+00  1.11002140e+00
  1.67487401e+00  5.79891629e+00  5.79891629e+00  5.79891629e+00
  8.07259218e+00  2.50193565e+01  2.50193565e+01  2.50193565e+01
  3.40683932e+01  1.32381455e+02  1.32381455e+02  1.32381455e+02
  1.37348565e+02  5.01501441e+02  1.86928026e+03  7.99906541e+03
  4.77668744e+04]
E1 = -182.6170249537974  E_coul = 54.08873976935278
cycle= 3 E= -128.528285184445  delta_E= -0.000799  |g|= 0.000471  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879728
diis-c [-4.57803191e-08 -2.08110100e-03 -2.15555975e-04  1.00229666e+00]
  HOMO = -0.842911071999866  LUMO = 1.10996870428328
  mo_energy =
[-3.27660734e+01 -1.92450056e+00 -8.42911072e-01 -8.42911072e-01
 -8.42911072e-01  1.10996870e+00  1.10996870e+00  1.10996870e+00
  1.67475723e+00  5.79869547e+00  5.79869547e+00  5.79869547e+00
  8.07236780e+00  2.50189898e+01  2.50189898e+01  2.50189898e+01
  3.40680317e+01  1.32380983e+02  1.32380983e+02  1.32380983e+02
  1.37348112e+02  5.01500912e+02  1.86927966e+03  7.99906474e+03
  4.77668737e+04]
E1 = -182.61768229673854  E_coul = 54.089397097656445
cycle= 4 E= -128.528285199082  delta_E= -1.46e-08  |g|= 4.28e-05  |ddm|= 0.000114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.57157e-05
diis-c [-5.83514058e-10  1.61777716e-04  1.05317385e-04 -1.30098986e-01
  1.12983189e+00]
  HOMO = -0.842930816275558  LUMO = 1.10995954582672
  mo_energy =
[-3.27661075e+01 -1.92452713e+00 -8.42930816e-01 -8.42930816e-01
 -8.42930816e-01  1.10995955e+00  1.10995955e+00  1.10995955e+00
  1.67473966e+00  5.79867092e+00  5.79867092e+00  5.79867092e+00
  8.07234135e+00  2.50189568e+01  2.50189568e+01  2.50189568e+01
  3.40679983e+01  1.32380949e+02  1.32380949e+02  1.32380949e+02
  1.37348079e+02  5.01500881e+02  1.86927963e+03  7.99906471e+03
  4.77668737e+04]
E1 = -182.61774546531132  E_coul = 54.08946026607537
cycle= 5 E= -128.528285199236  delta_E= -1.54e-10  |g|= 4.21e-06  |ddm|= 1.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61774546531132  E_coul = 54.08946026607537
  HOMO = -0.842928484924848  LUMO = 1.109960429173
  mo_energy =
[-3.27661018e+01 -1.92452525e+00 -8.42928485e-01 -8.42928485e-01
 -8.42928485e-01  1.10996043e+00  1.10996043e+00  1.10996043e+00
  1.67474060e+00  5.79867371e+00  5.79867371e+00  5.79867371e+00
  8.07234380e+00  2.50189614e+01  2.50189614e+01  2.50189614e+01
  3.40680028e+01  1.32380955e+02  1.32380955e+02  1.32380955e+02
  1.37348084e+02  5.01500887e+02  1.86927963e+03  7.99906472e+03
  4.77668737e+04]
E1 = -182.617731648306  E_coul = 54.08944644906861
Extra cycle  E= -128.528285199237  delta_E= -1.45e-12  |g|= 1.99e-06  |ddm|= 1.89e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 851.572542755516
E1 = -182.617731648306  E_coul = 54.08944644906861
init E= -128.528285199237
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.842929427291979  LUMO = 1.10996007588283
  mo_energy =
[-3.27661047e+01 -1.92452636e+00 -8.42929427e-01 -8.42929427e-01
 -8.42929427e-01  1.10996008e+00  1.10996008e+00  1.10996008e+00
  1.67474006e+00  5.79867253e+00  5.79867253e+00  5.79867253e+00
  8.07234262e+00  2.50189592e+01  2.50189592e+01  2.50189592e+01
  3.40680005e+01  1.32380952e+02  1.32380952e+02  1.32380952e+02
  1.37348082e+02  5.01500884e+02  1.86927963e+03  7.99906472e+03
  4.77668737e+04]
E1 = -182.61773851160444  E_coul = 54.08945331236648
cycle= 1 E= -128.528285199238  delta_E= -5.68e-13  |g|= 9.3e-07  |ddm|= 8.56e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61773851160444  E_coul = 54.08945331236648
  HOMO = -0.84292893986092  LUMO = 1.10996025536372
  mo_energy =
[-3.27661033e+01 -1.92452587e+00 -8.42928940e-01 -8.42928940e-01
 -8.42928940e-01  1.10996026e+00  1.10996026e+00  1.10996026e+00
  1.67474029e+00  5.79867313e+00  5.79867313e+00  5.79867313e+00
  8.07234319e+00  2.50189603e+01  2.50189603e+01  2.50189603e+01
  3.40680016e+01  1.32380953e+02  1.32380953e+02  1.32380953e+02
  1.37348083e+02  5.01500885e+02  1.86927963e+03  7.99906472e+03
  4.77668737e+04]
E1 = -182.61773505414826  E_coul = 54.089449854910534
Extra cycle  E= -128.528285199238  delta_E= 2.27e-13  |g|= 4.73e-07  |ddm|= 3.41e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272726e+02 2.35718421e+02
 7.65017029e+01 9.64610892e+00 2.71240272e+01 5.09169901e-01
 1.49758960e+00 2.33227357e+00 3.75414381e+00 1.31302742e+01
 6.18897712e+01 3.34458480e-01 1.16164647e+00]
grad_E = [-3.08329356e-09  1.63654867e-07 -3.25974045e-06  4.02089779e-05
 -3.13887233e-04 -3.50876059e-03  1.65768595e-03  2.48308809e-02
  1.40468574e-03 -5.98344360e-04 -4.79328357e-03  3.18230212e-04
  1.18693672e-04 -6.87793238e-03  8.33709395e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941317        1
[INPUT] 0    0    [1    /1   ]  3661.45437924        1
[INPUT] 0    0    [1    /1   ]  833.272806155        1
[INPUT] 0    0    [1    /1   ]  235.717476685        1
[INPUT] 0    0    [1    /1   ]  76.5082710513        1
[INPUT] 0    0    [1    /1   ]  9.61897962262        1
[INPUT] 0    0    [1    /1   ]  27.1018906454        1
[INPUT] 0    0    [1    /1   ]  0.480579703535       1
[INPUT] 0    0    [1    /1   ]  1.26625377746        1
[INPUT] 0    0    [1    /1   ]  2.46990747539        1
[INPUT] 1    0    [1    /1   ]  3.89038335465        1
[INPUT] 1    0    [1    /1   ]  13.8599413409        1
[INPUT] 1    0    [1    /1   ]  66.7828283124        1
[INPUT] 1    0    [1    /1   ]  0.342779700278       1
[INPUT] 1    0    [1    /1   ]  1.19665764059        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131736322, 1.0]], [0, [3661.4543792384216, 1.0]], [0, [833.2728061546484, 1.0]], [0, [235.71747668524316, 1.0]], [0, [76.50827105126521, 1.0]], [0, [9.618979622618038, 1.0]], [0, [27.1018906453694, 1.0]], [0, [0.48057970353482804, 1.0]], [0, [1.2662537774566038, 1.0]], [0, [2.4699074753941543, 1.0]], [1, [3.8903833546538946, 1.0]], [1, [13.859941340939994, 1.0]], [1, [66.78282831240908, 1.0]], [1, [0.3427797002775569, 1.0]], [1, [1.196657640592314, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413174]
bas 1, expnt(s) = [3661.45437924]
bas 2, expnt(s) = [833.27280615]
bas 3, expnt(s) = [235.71747669]
bas 4, expnt(s) = [76.50827105]
bas 5, expnt(s) = [9.61897962]
bas 6, expnt(s) = [27.10189065]
bas 7, expnt(s) = [0.4805797]
bas 8, expnt(s) = [1.26625378]
bas 9, expnt(s) = [2.46990748]
bas 10, expnt(s) = [3.89038335]
bas 11, expnt(s) = [13.85994134]
bas 12, expnt(s) = [66.78282831]
bas 13, expnt(s) = [0.3427797]
bas 14, expnt(s) = [1.19665764]
CPU time:       135.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272806e+02 3.91836989e+02 2.35717477e+02 1.51987847e+02
 7.65082711e+01 6.53576330e+01 9.61897962e+00 1.37994500e+01
 2.71018906e+01 3.00099116e+01 4.80579704e-01 1.45827387e+00
 1.26625378e+00 3.01582120e+00 2.46990748e+00 4.97766354e+00
 3.89038335e+00 1.59395072e+01 1.38599413e+01 7.80164407e+01
 6.67828283e+01 5.56948966e+02 3.42779700e-01 7.65161766e-01
 1.19665764e+00 3.65129389e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997686765237479
cond(S) = 467.1392994455805
E1 = -183.57457071142235  E_coul = 55.07918286764626
init E= -128.495387843776
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773695944509906  LUMO = 1.17249277471836
  mo_energy =
[-3.25548838e+01 -1.85188270e+00 -7.73695945e-01 -7.73695945e-01
 -7.73695945e-01  1.17249277e+00  1.17249277e+00  1.17249277e+00
  1.53269523e+00  6.09736192e+00  6.09736192e+00  6.09736192e+00
  7.63430538e+00  2.64844516e+01  2.64844516e+01  2.64844516e+01
  3.35968349e+01  1.36932005e+02  1.43185080e+02  1.43185080e+02
  1.43185080e+02  5.01155473e+02  1.86902251e+03  7.99889717e+03
  4.77668044e+04]
E1 = -182.1531906632949  E_coul = 53.62765603937605
cycle= 1 E= -128.525534623919  delta_E= -0.0301  |g|= 0.196  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.428867
diis-c [-0.1839272  1.       ]
  HOMO = -0.875321367269497  LUMO = 1.13392477194966
  mo_energy =
[-3.28663449e+01 -1.95901183e+00 -8.75321367e-01 -8.75321367e-01
 -8.75321367e-01  1.13392477e+00  1.13392477e+00  1.13392477e+00
  1.48505916e+00  5.96787032e+00  5.96787032e+00  5.96787032e+00
  7.51595840e+00  2.62476941e+01  2.62476941e+01  2.62476941e+01
  3.33643835e+01  1.36625690e+02  1.42863163e+02  1.42863163e+02
  1.42863163e+02  5.00805324e+02  1.86863651e+03  7.99848239e+03
  4.77663707e+04]
E1 = -182.86005599938326  E_coul = 54.33213244491476
cycle= 2 E= -128.527923554468  delta_E= -0.00239  |g|= 0.0965  |ddm|= 0.0709
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.211853
diis-c [-5.73886903e-04  3.29570882e-01  6.70429118e-01]
  HOMO = -0.842070624461854  LUMO = 1.14669702459442
  mo_energy =
[-3.27644131e+01 -1.92401379e+00 -8.42070624e-01 -8.42070624e-01
 -8.42070624e-01  1.14669702e+00  1.14669702e+00  1.14669702e+00
  1.50050088e+00  6.01010962e+00  6.01010962e+00  6.01010962e+00
  7.55462579e+00  2.63255817e+01  2.63255817e+01  2.63255817e+01
  3.34410246e+01  1.36725703e+02  1.42967300e+02  1.42967300e+02
  1.42967300e+02  5.00915732e+02  1.86875199e+03  7.99860024e+03
  4.77664895e+04]
E1 = -182.62461893423648  E_coul = 54.09590835605067
cycle= 3 E= -128.528710578186  delta_E= -0.000787  |g|= 0.000442  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000856793
diis-c [-3.61330044e-08 -2.03007091e-03 -1.59843473e-04  1.00218991e+00]
  HOMO = -0.842284472832066  LUMO = 1.14664901723167
  mo_energy =
[-3.27648523e+01 -1.92423791e+00 -8.42284473e-01 -8.42284473e-01
 -8.42284473e-01  1.14664902e+00  1.14664902e+00  1.14664902e+00
  1.50040625e+00  6.00989997e+00  6.00989997e+00  6.00989997e+00
  7.55442411e+00  2.63252302e+01  2.63252302e+01  2.63252302e+01
  3.34406818e+01  1.36725269e+02  1.42966841e+02  1.42966841e+02
  1.42966841e+02  5.00915220e+02  1.86875139e+03  7.99859958e+03
  4.77664888e+04]
E1 = -182.62527422500813  E_coul = 54.09656363399309
cycle= 4 E= -128.528710591015  delta_E= -1.28e-08  |g|= 3.88e-05  |ddm|= 9.72e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.36683e-05
diis-c [-4.53978523e-10  1.31849433e-04  1.24471715e-04 -1.12173756e-01
  1.11191743e+00]
  HOMO = -0.84230238325626  LUMO = 1.14664059323419
  mo_energy =
[-3.27648845e+01 -1.92426142e+00 -8.42302383e-01 -8.42302383e-01
 -8.42302383e-01  1.14664059e+00  1.14664059e+00  1.14664059e+00
  1.50039199e+00  6.00987728e+00  6.00987728e+00  6.00987728e+00
  7.55440074e+00  2.63251994e+01  2.63251994e+01  2.63251994e+01
  3.34406508e+01  1.36725237e+02  1.42966809e+02  1.42966809e+02
  1.42966809e+02  5.00915189e+02  1.86875137e+03  7.99859955e+03
  4.77664888e+04]
E1 = -182.6253377779345  E_coul = 54.0966271867961
cycle= 5 E= -128.528710591138  delta_E= -1.23e-10  |g|= 3.48e-06  |ddm|= 1.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6253377779345  E_coul = 54.0966271867961
  HOMO = -0.842300562923322  LUMO = 1.14664129810585
  mo_energy =
[-3.27648800e+01 -1.92426005e+00 -8.42300563e-01 -8.42300563e-01
 -8.42300563e-01  1.14664130e+00  1.14664130e+00  1.14664130e+00
  1.50039259e+00  6.00987950e+00  6.00987950e+00  6.00987950e+00
  7.55440256e+00  2.63252030e+01  2.63252030e+01  2.63252030e+01
  3.34406544e+01  1.36725241e+02  1.42966813e+02  1.42966813e+02
  1.42966813e+02  5.00915194e+02  1.86875137e+03  7.99859956e+03
  4.77664888e+04]
E1 = -182.62532665261375  E_coul = 54.09661606147436
Extra cycle  E= -128.528710591139  delta_E= -9.95e-13  |g|= 1.62e-06  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272806e+02 2.35717477e+02
 7.65082711e+01 9.61897962e+00 2.71018906e+01 4.80579704e-01
 1.26625378e+00 2.46990748e+00 3.89038335e+00 1.38599413e+01
 6.67828283e+01 3.42779700e-01 1.19665764e+00]
E = -128.5287105911394
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941317        1
[INPUT] 0    0    [1    /1   ]  3661.45437924        1
[INPUT] 0    0    [1    /1   ]  833.272806155        1
[INPUT] 0    0    [1    /1   ]  235.717476685        1
[INPUT] 0    0    [1    /1   ]  76.5082710513        1
[INPUT] 0    0    [1    /1   ]  9.61897962262        1
[INPUT] 0    0    [1    /1   ]  27.1018906454        1
[INPUT] 0    0    [1    /1   ]  0.480579703535       1
[INPUT] 0    0    [1    /1   ]  1.26625377746        1
[INPUT] 0    0    [1    /1   ]  2.46990747539        1
[INPUT] 1    0    [1    /1   ]  3.89038335465        1
[INPUT] 1    0    [1    /1   ]  13.8599413409        1
[INPUT] 1    0    [1    /1   ]  66.7828283124        1
[INPUT] 1    0    [1    /1   ]  0.342779700278       1
[INPUT] 1    0    [1    /1   ]  1.19665764059        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131736322, 1.0]], [0, [3661.4543792384216, 1.0]], [0, [833.2728061546484, 1.0]], [0, [235.71747668524316, 1.0]], [0, [76.50827105126521, 1.0]], [0, [9.618979622618038, 1.0]], [0, [27.1018906453694, 1.0]], [0, [0.48057970353482804, 1.0]], [0, [1.2662537774566038, 1.0]], [0, [2.4699074753941543, 1.0]], [1, [3.8903833546538946, 1.0]], [1, [13.859941340939994, 1.0]], [1, [66.78282831240908, 1.0]], [1, [0.3427797002775569, 1.0]], [1, [1.196657640592314, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413174]
bas 1, expnt(s) = [3661.45437924]
bas 2, expnt(s) = [833.27280615]
bas 3, expnt(s) = [235.71747669]
bas 4, expnt(s) = [76.50827105]
bas 5, expnt(s) = [9.61897962]
bas 6, expnt(s) = [27.10189065]
bas 7, expnt(s) = [0.4805797]
bas 8, expnt(s) = [1.26625378]
bas 9, expnt(s) = [2.46990748]
bas 10, expnt(s) = [3.89038335]
bas 11, expnt(s) = [13.85994134]
bas 12, expnt(s) = [66.78282831]
bas 13, expnt(s) = [0.3427797]
bas 14, expnt(s) = [1.19665764]
CPU time:       135.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272806e+02 3.91836989e+02 2.35717477e+02 1.51987847e+02
 7.65082711e+01 6.53576330e+01 9.61897962e+00 1.37994500e+01
 2.71018906e+01 3.00099116e+01 4.80579704e-01 1.45827387e+00
 1.26625378e+00 3.01582120e+00 2.46990748e+00 4.97766354e+00
 3.89038335e+00 1.59395072e+01 1.38599413e+01 7.80164407e+01
 6.67828283e+01 5.56948966e+02 3.42779700e-01 7.65161766e-01
 1.19665764e+00 3.65129389e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997686765237479
cond(S) = 467.1392994455805
E1 = -183.57457071142235  E_coul = 55.07918286764626
init E= -128.495387843776
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773695944509906  LUMO = 1.17249277471836
  mo_energy =
[-3.25548838e+01 -1.85188270e+00 -7.73695945e-01 -7.73695945e-01
 -7.73695945e-01  1.17249277e+00  1.17249277e+00  1.17249277e+00
  1.53269523e+00  6.09736192e+00  6.09736192e+00  6.09736192e+00
  7.63430538e+00  2.64844516e+01  2.64844516e+01  2.64844516e+01
  3.35968349e+01  1.36932005e+02  1.43185080e+02  1.43185080e+02
  1.43185080e+02  5.01155473e+02  1.86902251e+03  7.99889717e+03
  4.77668044e+04]
E1 = -182.1531906632949  E_coul = 53.62765603937605
cycle= 1 E= -128.525534623919  delta_E= -0.0301  |g|= 0.196  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.428867
diis-c [-0.1839272  1.       ]
  HOMO = -0.875321367269497  LUMO = 1.13392477194966
  mo_energy =
[-3.28663449e+01 -1.95901183e+00 -8.75321367e-01 -8.75321367e-01
 -8.75321367e-01  1.13392477e+00  1.13392477e+00  1.13392477e+00
  1.48505916e+00  5.96787032e+00  5.96787032e+00  5.96787032e+00
  7.51595840e+00  2.62476941e+01  2.62476941e+01  2.62476941e+01
  3.33643835e+01  1.36625690e+02  1.42863163e+02  1.42863163e+02
  1.42863163e+02  5.00805324e+02  1.86863651e+03  7.99848239e+03
  4.77663707e+04]
E1 = -182.86005599938326  E_coul = 54.33213244491476
cycle= 2 E= -128.527923554468  delta_E= -0.00239  |g|= 0.0965  |ddm|= 0.0709
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.211853
diis-c [-5.73886903e-04  3.29570882e-01  6.70429118e-01]
  HOMO = -0.842070624461854  LUMO = 1.14669702459442
  mo_energy =
[-3.27644131e+01 -1.92401379e+00 -8.42070624e-01 -8.42070624e-01
 -8.42070624e-01  1.14669702e+00  1.14669702e+00  1.14669702e+00
  1.50050088e+00  6.01010962e+00  6.01010962e+00  6.01010962e+00
  7.55462579e+00  2.63255817e+01  2.63255817e+01  2.63255817e+01
  3.34410246e+01  1.36725703e+02  1.42967300e+02  1.42967300e+02
  1.42967300e+02  5.00915732e+02  1.86875199e+03  7.99860024e+03
  4.77664895e+04]
E1 = -182.62461893423648  E_coul = 54.09590835605067
cycle= 3 E= -128.528710578186  delta_E= -0.000787  |g|= 0.000442  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000856793
diis-c [-3.61330044e-08 -2.03007091e-03 -1.59843473e-04  1.00218991e+00]
  HOMO = -0.842284472832066  LUMO = 1.14664901723167
  mo_energy =
[-3.27648523e+01 -1.92423791e+00 -8.42284473e-01 -8.42284473e-01
 -8.42284473e-01  1.14664902e+00  1.14664902e+00  1.14664902e+00
  1.50040625e+00  6.00989997e+00  6.00989997e+00  6.00989997e+00
  7.55442411e+00  2.63252302e+01  2.63252302e+01  2.63252302e+01
  3.34406818e+01  1.36725269e+02  1.42966841e+02  1.42966841e+02
  1.42966841e+02  5.00915220e+02  1.86875139e+03  7.99859958e+03
  4.77664888e+04]
E1 = -182.62527422500813  E_coul = 54.09656363399309
cycle= 4 E= -128.528710591015  delta_E= -1.28e-08  |g|= 3.88e-05  |ddm|= 9.72e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.36683e-05
diis-c [-4.53978523e-10  1.31849433e-04  1.24471715e-04 -1.12173756e-01
  1.11191743e+00]
  HOMO = -0.84230238325626  LUMO = 1.14664059323419
  mo_energy =
[-3.27648845e+01 -1.92426142e+00 -8.42302383e-01 -8.42302383e-01
 -8.42302383e-01  1.14664059e+00  1.14664059e+00  1.14664059e+00
  1.50039199e+00  6.00987728e+00  6.00987728e+00  6.00987728e+00
  7.55440074e+00  2.63251994e+01  2.63251994e+01  2.63251994e+01
  3.34406508e+01  1.36725237e+02  1.42966809e+02  1.42966809e+02
  1.42966809e+02  5.00915189e+02  1.86875137e+03  7.99859955e+03
  4.77664888e+04]
E1 = -182.6253377779345  E_coul = 54.0966271867961
cycle= 5 E= -128.528710591138  delta_E= -1.23e-10  |g|= 3.48e-06  |ddm|= 1.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6253377779345  E_coul = 54.0966271867961
  HOMO = -0.842300562923322  LUMO = 1.14664129810585
  mo_energy =
[-3.27648800e+01 -1.92426005e+00 -8.42300563e-01 -8.42300563e-01
 -8.42300563e-01  1.14664130e+00  1.14664130e+00  1.14664130e+00
  1.50039259e+00  6.00987950e+00  6.00987950e+00  6.00987950e+00
  7.55440256e+00  2.63252030e+01  2.63252030e+01  2.63252030e+01
  3.34406544e+01  1.36725241e+02  1.42966813e+02  1.42966813e+02
  1.42966813e+02  5.00915194e+02  1.86875137e+03  7.99859956e+03
  4.77664888e+04]
E1 = -182.62532665261375  E_coul = 54.09661606147436
Extra cycle  E= -128.528710591139  delta_E= -9.95e-13  |g|= 1.62e-06  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 467.1392994455805
E1 = -182.62532665261375  E_coul = 54.09661606147436
init E= -128.528710591139
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.842301319726039  LUMO = 1.14664100240635
  mo_energy =
[-3.27648823e+01 -1.92426096e+00 -8.42301320e-01 -8.42301320e-01
 -8.42301320e-01  1.14664100e+00  1.14664100e+00  1.14664100e+00
  1.50039217e+00  6.00987852e+00  6.00987852e+00  6.00987852e+00
  7.55440162e+00  2.63252012e+01  2.63252012e+01  2.63252012e+01
  3.34406526e+01  1.36725239e+02  1.42966811e+02  1.42966811e+02
  1.42966811e+02  5.00915192e+02  1.86875137e+03  7.99859956e+03
  4.77664888e+04]
E1 = -182.6253321353005  E_coul = 54.09662154416081
cycle= 1 E= -128.52871059114  delta_E= -3.13e-13  |g|= 7.44e-07  |ddm|= 6.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6253321353005  E_coul = 54.09662154416081
  HOMO = -0.842300929584577  LUMO = 1.1466411513745
  mo_energy =
[-3.27648812e+01 -1.92426057e+00 -8.42300930e-01 -8.42300930e-01
 -8.42300930e-01  1.14664115e+00  1.14664115e+00  1.14664115e+00
  1.50039234e+00  6.00987902e+00  6.00987902e+00  6.00987902e+00
  7.55440206e+00  2.63252021e+01  2.63252021e+01  2.63252021e+01
  3.34406534e+01  1.36725240e+02  1.42966812e+02  1.42966812e+02
  1.42966812e+02  5.00915193e+02  1.86875137e+03  7.99859956e+03
  4.77664888e+04]
E1 = -182.62532937731146  E_coul = 54.09661878617167
Extra cycle  E= -128.52871059114  delta_E= -8.53e-14  |g|= 3.78e-07  |ddm|= 2.72e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272806e+02 2.35717477e+02
 7.65082711e+01 9.61897962e+00 2.71018906e+01 4.80579704e-01
 1.26625378e+00 2.46990748e+00 3.89038335e+00 1.38599413e+01
 6.67828283e+01 3.42779700e-01 1.19665764e+00]
grad_E = [-2.98713700e-09  1.58350609e-07 -3.16466565e-06  3.90424932e-05
 -3.07889378e-04 -3.30802345e-03  1.61441088e-03  2.99739422e-02
 -1.09883370e-03 -2.46259858e-04 -6.58127776e-03  7.59353795e-04
  1.19161937e-04 -1.97412109e-03  9.88311451e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941318        1
[INPUT] 0    0    [1    /1   ]  3661.45437637        1
[INPUT] 0    0    [1    /1   ]  833.272863075        1
[INPUT] 0    0    [1    /1   ]  235.716786285        1
[INPUT] 0    0    [1    /1   ]  76.5134033555        1
[INPUT] 0    0    [1    /1   ]  9.65100253598        1
[INPUT] 0    0    [1    /1   ]  27.07805712          1
[INPUT] 0    0    [1    /1   ]  0.430319838253       1
[INPUT] 0    0    [1    /1   ]  1.19033051643        1
[INPUT] 0    0    [1    /1   ]  2.47900375078        1
[INPUT] 1    0    [1    /1   ]  3.9741455904         1
[INPUT] 1    0    [1    /1   ]  14.2129215036        1
[INPUT] 1    0    [1    /1   ]  68.0858681836        1
[INPUT] 1    0    [1    /1   ]  0.348852818612       1
[INPUT] 1    0    [1    /1   ]  1.21993744184        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131789335, 1.0]], [0, [3661.454376366928, 1.0]], [0, [833.2728630746576, 1.0]], [0, [235.7167862847858, 1.0]], [0, [76.51340335550944, 1.0]], [0, [9.651002535976696, 1.0]], [0, [27.078057120035957, 1.0]], [0, [0.43031983825289893, 1.0]], [0, [1.190330516434415, 1.0]], [0, [2.479003750782721, 1.0]], [1, [3.9741455903975695, 1.0]], [1, [14.21292150358229, 1.0]], [1, [68.08586818363635, 1.0]], [1, [0.3488528186123583, 1.0]], [1, [1.2199374418381355, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413179]
bas 1, expnt(s) = [3661.45437637]
bas 2, expnt(s) = [833.27286307]
bas 3, expnt(s) = [235.71678628]
bas 4, expnt(s) = [76.51340336]
bas 5, expnt(s) = [9.65100254]
bas 6, expnt(s) = [27.07805712]
bas 7, expnt(s) = [0.43031984]
bas 8, expnt(s) = [1.19033052]
bas 9, expnt(s) = [2.47900375]
bas 10, expnt(s) = [3.97414559]
bas 11, expnt(s) = [14.2129215]
bas 12, expnt(s) = [68.08586818]
bas 13, expnt(s) = [0.34885282]
bas 14, expnt(s) = [1.21993744]
CPU time:       138.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272863e+02 3.91837009e+02 2.35716786e+02 1.51987513e+02
 7.65134034e+01 6.53609212e+01 9.65100254e+00 1.38338909e+01
 2.70780571e+01 2.99901163e+01 4.30319838e-01 1.34232769e+00
 1.19033052e+00 2.87915934e+00 2.47900375e+00 4.99140618e+00
 3.97414559e+00 1.63696393e+01 1.42129215e+01 8.05079169e+01
 6.80858682e+01 5.70565643e+02 3.48852819e-01 7.82144846e-01
 1.21993744e+00 3.74029919e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997778685122984
cond(S) = 388.1172494864921
E1 = -183.57385790016008  E_coul = 55.07782995761813
init E= -128.496027942542
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773784312342033  LUMO = 1.19878036544762
  mo_energy =
[-3.25552006e+01 -1.85246895e+00 -7.73784312e-01 -7.73784312e-01
 -7.73784312e-01  1.19878037e+00  1.19878037e+00  1.19878037e+00
  1.36543266e+00  6.23706670e+00  6.23706670e+00  6.23706670e+00
  7.22239269e+00  2.72066235e+01  2.72066235e+01  2.72066235e+01
  3.31336671e+01  1.36536188e+02  1.46695057e+02  1.46695057e+02
  1.46695057e+02  5.00797451e+02  1.86870178e+03  7.99861511e+03
  4.77665709e+04]
E1 = -182.14798865523994  E_coul = 53.62147516364259
cycle= 1 E= -128.526513491597  delta_E= -0.0305  |g|= 0.196  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430108
diis-c [-0.18499281  1.        ]
  HOMO = -0.876046965961798  LUMO = 1.15891720509517
  mo_energy =
[-3.28674514e+01 -1.95931204e+00 -8.76046966e-01 -8.76046966e-01
 -8.76046966e-01  1.15891721e+00  1.15891721e+00  1.15891721e+00
  1.32162011e+00  6.10528524e+00  6.10528524e+00  6.10528524e+00
  7.10500051e+00  2.69672144e+01  2.69672144e+01  2.69672144e+01
  3.29003231e+01  1.36228946e+02  1.46371640e+02  1.46371640e+02
  1.46371640e+02  5.00446298e+02  1.86831458e+03  7.99819899e+03
  4.77661359e+04]
E1 = -182.8546083784653  E_coul = 54.32569993688118
cycle= 2 E= -128.528908441584  delta_E= -0.00239  |g|= 0.0966  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.211904
diis-c [-5.74493351e-04  3.28983734e-01  6.71016266e-01]
  HOMO = -0.842788266167471  LUMO = 1.17201453163781
  mo_energy =
[-3.27653996e+01 -1.92433490e+00 -8.42788266e-01 -8.42788266e-01
 -8.42788266e-01  1.17201453e+00  1.17201453e+00  1.17201453e+00
  1.33584661e+00  6.14814218e+00  6.14814218e+00  6.14814218e+00
  7.14320813e+00  2.70457904e+01  2.70457904e+01  2.70457904e+01
  3.29771754e+01  1.36329118e+02  1.46476086e+02  1.46476086e+02
  1.46476086e+02  5.00556837e+02  1.86843017e+03  7.99831695e+03
  4.77662547e+04]
E1 = -182.61907979996857  E_coul = 54.08938412939886
cycle= 3 E= -128.52969567057  delta_E= -0.000787  |g|= 0.000524  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108356
diis-c [-7.16571428e-08 -2.13851493e-03  6.29661048e-04  1.00150885e+00]
  HOMO = -0.843045830947693  LUMO = 1.1719490124232
  mo_energy =
[-3.27658969e+01 -1.92454560e+00 -8.43045831e-01 -8.43045831e-01
 -8.43045831e-01  1.17194901e+00  1.17194901e+00  1.17194901e+00
  1.33576753e+00  6.14789037e+00  6.14789037e+00  6.14789037e+00
  7.14298374e+00  2.70453864e+01  2.70453864e+01  2.70453864e+01
  3.29767892e+01  1.36328623e+02  1.46475562e+02  1.46475562e+02
  1.46475562e+02  5.00556241e+02  1.86842946e+03  7.99831616e+03
  4.77662539e+04]
E1 = -182.61985767448553  E_coul = 54.09016198365372
cycle= 4 E= -128.529695690832  delta_E= -2.03e-08  |g|= 5.41e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000115746
diis-c [-5.04725775e-10  2.45926481e-04  2.65680363e-04 -1.66077159e-01
  1.16556555e+00]
  HOMO = -0.843072981050128  LUMO = 1.17193721488871
  mo_energy =
[-3.27659449e+01 -1.92456492e+00 -8.43072981e-01 -8.43072981e-01
 -8.43072981e-01  1.17193721e+00  1.17193721e+00  1.17193721e+00
  1.33575739e+00  6.14785842e+00  6.14785842e+00  6.14785842e+00
  7.14295680e+00  2.70453433e+01  2.70453433e+01  2.70453433e+01
  3.29767476e+01  1.36328575e+02  1.46475513e+02  1.46475513e+02
  1.46475513e+02  5.00556186e+02  1.86842940e+03  7.99831610e+03
  4.77662538e+04]
E1 = -182.61996089704635  E_coul = 54.09026520590727
cycle= 5 E= -128.529695691139  delta_E= -3.07e-10  |g|= 4.34e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61996089704635  E_coul = 54.09026520590727
  HOMO = -0.843070878488771  LUMO = 1.1719381759447
  mo_energy =
[-3.27659405e+01 -1.92456215e+00 -8.43070878e-01 -8.43070878e-01
 -8.43070878e-01  1.17193818e+00  1.17193818e+00  1.17193818e+00
  1.33575884e+00  6.14786111e+00  6.14786111e+00  6.14786111e+00
  7.14295957e+00  2.70453473e+01  2.70453473e+01  2.70453473e+01
  3.29767516e+01  1.36328579e+02  1.46475517e+02  1.46475517e+02
  1.46475517e+02  5.00556190e+02  1.86842941e+03  7.99831610e+03
  4.77662538e+04]
E1 = -182.61995112537488  E_coul = 54.09025543423421
Extra cycle  E= -128.529695691141  delta_E= -1.59e-12  |g|= 1.4e-06  |ddm|= 1.55e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272863e+02 2.35716786e+02
 7.65134034e+01 9.65100254e+00 2.70780571e+01 4.30319838e-01
 1.19033052e+00 2.47900375e+00 3.97414559e+00 1.42129215e+01
 6.80858682e+01 3.48852819e-01 1.21993744e+00]
E = -128.52969569114066
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941318        1
[INPUT] 0    0    [1    /1   ]  3661.45437637        1
[INPUT] 0    0    [1    /1   ]  833.272863075        1
[INPUT] 0    0    [1    /1   ]  235.716786285        1
[INPUT] 0    0    [1    /1   ]  76.5134033555        1
[INPUT] 0    0    [1    /1   ]  9.65100253598        1
[INPUT] 0    0    [1    /1   ]  27.07805712          1
[INPUT] 0    0    [1    /1   ]  0.430319838253       1
[INPUT] 0    0    [1    /1   ]  1.19033051643        1
[INPUT] 0    0    [1    /1   ]  2.47900375078        1
[INPUT] 1    0    [1    /1   ]  3.9741455904         1
[INPUT] 1    0    [1    /1   ]  14.2129215036        1
[INPUT] 1    0    [1    /1   ]  68.0858681836        1
[INPUT] 1    0    [1    /1   ]  0.348852818612       1
[INPUT] 1    0    [1    /1   ]  1.21993744184        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131789335, 1.0]], [0, [3661.454376366928, 1.0]], [0, [833.2728630746576, 1.0]], [0, [235.7167862847858, 1.0]], [0, [76.51340335550944, 1.0]], [0, [9.651002535976696, 1.0]], [0, [27.078057120035957, 1.0]], [0, [0.43031983825289893, 1.0]], [0, [1.190330516434415, 1.0]], [0, [2.479003750782721, 1.0]], [1, [3.9741455903975695, 1.0]], [1, [14.21292150358229, 1.0]], [1, [68.08586818363635, 1.0]], [1, [0.3488528186123583, 1.0]], [1, [1.2199374418381355, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413179]
bas 1, expnt(s) = [3661.45437637]
bas 2, expnt(s) = [833.27286307]
bas 3, expnt(s) = [235.71678628]
bas 4, expnt(s) = [76.51340336]
bas 5, expnt(s) = [9.65100254]
bas 6, expnt(s) = [27.07805712]
bas 7, expnt(s) = [0.43031984]
bas 8, expnt(s) = [1.19033052]
bas 9, expnt(s) = [2.47900375]
bas 10, expnt(s) = [3.97414559]
bas 11, expnt(s) = [14.2129215]
bas 12, expnt(s) = [68.08586818]
bas 13, expnt(s) = [0.34885282]
bas 14, expnt(s) = [1.21993744]
CPU time:       139.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272863e+02 3.91837009e+02 2.35716786e+02 1.51987513e+02
 7.65134034e+01 6.53609212e+01 9.65100254e+00 1.38338909e+01
 2.70780571e+01 2.99901163e+01 4.30319838e-01 1.34232769e+00
 1.19033052e+00 2.87915934e+00 2.47900375e+00 4.99140618e+00
 3.97414559e+00 1.63696393e+01 1.42129215e+01 8.05079169e+01
 6.80858682e+01 5.70565643e+02 3.48852819e-01 7.82144846e-01
 1.21993744e+00 3.74029919e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997778685122984
cond(S) = 388.1172494864921
E1 = -183.57385790016008  E_coul = 55.07782995761813
init E= -128.496027942542
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773784312342033  LUMO = 1.19878036544762
  mo_energy =
[-3.25552006e+01 -1.85246895e+00 -7.73784312e-01 -7.73784312e-01
 -7.73784312e-01  1.19878037e+00  1.19878037e+00  1.19878037e+00
  1.36543266e+00  6.23706670e+00  6.23706670e+00  6.23706670e+00
  7.22239269e+00  2.72066235e+01  2.72066235e+01  2.72066235e+01
  3.31336671e+01  1.36536188e+02  1.46695057e+02  1.46695057e+02
  1.46695057e+02  5.00797451e+02  1.86870178e+03  7.99861511e+03
  4.77665709e+04]
E1 = -182.14798865523994  E_coul = 53.62147516364259
cycle= 1 E= -128.526513491597  delta_E= -0.0305  |g|= 0.196  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430108
diis-c [-0.18499281  1.        ]
  HOMO = -0.876046965961798  LUMO = 1.15891720509517
  mo_energy =
[-3.28674514e+01 -1.95931204e+00 -8.76046966e-01 -8.76046966e-01
 -8.76046966e-01  1.15891721e+00  1.15891721e+00  1.15891721e+00
  1.32162011e+00  6.10528524e+00  6.10528524e+00  6.10528524e+00
  7.10500051e+00  2.69672144e+01  2.69672144e+01  2.69672144e+01
  3.29003231e+01  1.36228946e+02  1.46371640e+02  1.46371640e+02
  1.46371640e+02  5.00446298e+02  1.86831458e+03  7.99819899e+03
  4.77661359e+04]
E1 = -182.8546083784653  E_coul = 54.32569993688118
cycle= 2 E= -128.528908441584  delta_E= -0.00239  |g|= 0.0966  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.211904
diis-c [-5.74493351e-04  3.28983734e-01  6.71016266e-01]
  HOMO = -0.842788266167471  LUMO = 1.17201453163781
  mo_energy =
[-3.27653996e+01 -1.92433490e+00 -8.42788266e-01 -8.42788266e-01
 -8.42788266e-01  1.17201453e+00  1.17201453e+00  1.17201453e+00
  1.33584661e+00  6.14814218e+00  6.14814218e+00  6.14814218e+00
  7.14320813e+00  2.70457904e+01  2.70457904e+01  2.70457904e+01
  3.29771754e+01  1.36329118e+02  1.46476086e+02  1.46476086e+02
  1.46476086e+02  5.00556837e+02  1.86843017e+03  7.99831695e+03
  4.77662547e+04]
E1 = -182.61907979996857  E_coul = 54.08938412939886
cycle= 3 E= -128.52969567057  delta_E= -0.000787  |g|= 0.000524  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108356
diis-c [-7.16571428e-08 -2.13851493e-03  6.29661048e-04  1.00150885e+00]
  HOMO = -0.843045830947693  LUMO = 1.1719490124232
  mo_energy =
[-3.27658969e+01 -1.92454560e+00 -8.43045831e-01 -8.43045831e-01
 -8.43045831e-01  1.17194901e+00  1.17194901e+00  1.17194901e+00
  1.33576753e+00  6.14789037e+00  6.14789037e+00  6.14789037e+00
  7.14298374e+00  2.70453864e+01  2.70453864e+01  2.70453864e+01
  3.29767892e+01  1.36328623e+02  1.46475562e+02  1.46475562e+02
  1.46475562e+02  5.00556241e+02  1.86842946e+03  7.99831616e+03
  4.77662539e+04]
E1 = -182.61985767448553  E_coul = 54.09016198365372
cycle= 4 E= -128.529695690832  delta_E= -2.03e-08  |g|= 5.41e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000115746
diis-c [-5.04725775e-10  2.45926481e-04  2.65680363e-04 -1.66077159e-01
  1.16556555e+00]
  HOMO = -0.843072981050128  LUMO = 1.17193721488871
  mo_energy =
[-3.27659449e+01 -1.92456492e+00 -8.43072981e-01 -8.43072981e-01
 -8.43072981e-01  1.17193721e+00  1.17193721e+00  1.17193721e+00
  1.33575739e+00  6.14785842e+00  6.14785842e+00  6.14785842e+00
  7.14295680e+00  2.70453433e+01  2.70453433e+01  2.70453433e+01
  3.29767476e+01  1.36328575e+02  1.46475513e+02  1.46475513e+02
  1.46475513e+02  5.00556186e+02  1.86842940e+03  7.99831610e+03
  4.77662538e+04]
E1 = -182.61996089704635  E_coul = 54.09026520590727
cycle= 5 E= -128.529695691139  delta_E= -3.07e-10  |g|= 4.34e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61996089704635  E_coul = 54.09026520590727
  HOMO = -0.843070878488771  LUMO = 1.1719381759447
  mo_energy =
[-3.27659405e+01 -1.92456215e+00 -8.43070878e-01 -8.43070878e-01
 -8.43070878e-01  1.17193818e+00  1.17193818e+00  1.17193818e+00
  1.33575884e+00  6.14786111e+00  6.14786111e+00  6.14786111e+00
  7.14295957e+00  2.70453473e+01  2.70453473e+01  2.70453473e+01
  3.29767516e+01  1.36328579e+02  1.46475517e+02  1.46475517e+02
  1.46475517e+02  5.00556190e+02  1.86842941e+03  7.99831610e+03
  4.77662538e+04]
E1 = -182.61995112537488  E_coul = 54.09025543423421
Extra cycle  E= -128.529695691141  delta_E= -1.59e-12  |g|= 1.4e-06  |ddm|= 1.55e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 388.1172494864921
E1 = -182.61995112537488  E_coul = 54.09025543423421
init E= -128.529695691141
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.843071570957087  LUMO = 1.17193791486733
  mo_energy =
[-3.27659426e+01 -1.92456277e+00 -8.43071571e-01 -8.43071571e-01
 -8.43071571e-01  1.17193791e+00  1.17193791e+00  1.17193791e+00
  1.33575862e+00  6.14786023e+00  6.14786023e+00  6.14786023e+00
  7.14295885e+00  2.70453456e+01  2.70453456e+01  2.70453456e+01
  3.29767500e+01  1.36328577e+02  1.46475515e+02  1.46475515e+02
  1.46475515e+02  5.00556188e+02  1.86842940e+03  7.99831610e+03
  4.77662538e+04]
E1 = -182.6199563684112  E_coul = 54.09026067727024
cycle= 1 E= -128.529695691141  delta_E= -3.13e-13  |g|= 7.28e-07  |ddm|= 5.52e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6199563684112  E_coul = 54.09026067727024
  HOMO = -0.843071205393366  LUMO = 1.17193806072224
  mo_energy =
[-3.27659415e+01 -1.92456236e+00 -8.43071205e-01 -8.43071205e-01
 -8.43071205e-01  1.17193806e+00  1.17193806e+00  1.17193806e+00
  1.33575880e+00  6.14786070e+00  6.14786070e+00  6.14786070e+00
  7.14295928e+00  2.70453465e+01  2.70453465e+01  2.70453465e+01
  3.29767509e+01  1.36328578e+02  1.46475516e+02  1.46475516e+02
  1.46475516e+02  5.00556189e+02  1.86842940e+03  7.99831610e+03
  4.77662538e+04]
E1 = -182.6199537982414  E_coul = 54.09025810710064
Extra cycle  E= -128.529695691141  delta_E= 1.99e-13  |g|= 3.49e-07  |ddm|= 2.73e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272863e+02 2.35716786e+02
 7.65134034e+01 9.65100254e+00 2.70780571e+01 4.30319838e-01
 1.19033052e+00 2.47900375e+00 3.97414559e+00 1.42129215e+01
 6.80858682e+01 3.48852819e-01 1.21993744e+00]
grad_E = [-2.55607093e-09  1.35529057e-07 -2.71559115e-06  3.37106955e-05
 -2.70155916e-04 -3.06211269e-03  1.44701995e-03  6.29961862e-03
  2.77637482e-03 -1.12058353e-03 -6.53310477e-03  9.86151659e-04
  9.38134224e-05  6.70836623e-03  8.30284259e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437063        1
[INPUT] 0    0    [1    /1   ]  833.272976673        1
[INPUT] 0    0    [1    /1   ]  235.715427726        1
[INPUT] 0    0    [1    /1   ]  76.5231634969        1
[INPUT] 0    0    [1    /1   ]  9.65816693224        1
[INPUT] 0    0    [1    /1   ]  27.0392763187        1
[INPUT] 0    0    [1    /1   ]  0.365462539382       1
[INPUT] 0    0    [1    /1   ]  0.937913428244       1
[INPUT] 0    0    [1    /1   ]  2.60251580166        1
[INPUT] 1    0    [1    /1   ]  4.19410900777        1
[INPUT] 1    0    [1    /1   ]  15.1706912574        1
[INPUT] 1    0    [1    /1   ]  73.0865841584        1
[INPUT] 1    0    [1    /1   ]  0.351443453728       1
[INPUT] 1    0    [1    /1   ]  1.26236725066        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413189339, 1.0]], [0, [3661.4543706323216, 1.0]], [0, [833.2729766734523, 1.0]], [0, [235.71542772596496, 1.0]], [0, [76.52316349685167, 1.0]], [0, [9.658166932241018, 1.0]], [0, [27.039276318748044, 1.0]], [0, [0.3654625393815127, 1.0]], [0, [0.9379134282437588, 1.0]], [0, [2.6025158016647283, 1.0]], [1, [4.194109007765563, 1.0]], [1, [15.170691257419318, 1.0]], [1, [73.086584158358, 1.0]], [1, [0.351443453727598, 1.0]], [1, [1.262367250656882, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.45437063]
bas 2, expnt(s) = [833.27297667]
bas 3, expnt(s) = [235.71542773]
bas 4, expnt(s) = [76.5231635]
bas 5, expnt(s) = [9.65816693]
bas 6, expnt(s) = [27.03927632]
bas 7, expnt(s) = [0.36546254]
bas 8, expnt(s) = [0.93791343]
bas 9, expnt(s) = [2.6025158]
bas 10, expnt(s) = [4.19410901]
bas 11, expnt(s) = [15.17069126]
bas 12, expnt(s) = [73.08658416]
bas 13, expnt(s) = [0.35144345]
bas 14, expnt(s) = [1.26236725]
CPU time:       142.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272977e+02 3.91837049e+02 2.35715428e+02 1.51986856e+02
 7.65231635e+01 6.53671742e+01 9.65816693e+00 1.38415924e+01
 2.70392763e+01 2.99578969e+01 3.65462539e-01 1.18753707e+00
 9.37913428e-01 2.40789248e+00 2.60251580e+00 5.17678413e+00
 4.19410901e+00 1.75099149e+01 1.51706913e+01 8.73456146e+01
 7.30865842e+01 6.23421066e+02 3.51443454e-01 7.89411984e-01
 1.26236725e+00 3.90361108e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997660523039691
cond(S) = 296.75373803513173
E1 = -183.57272089963794  E_coul = 55.07769887684188
init E= -128.495022022796
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77378115392989  LUMO = 1.06524300955841
  mo_energy =
[-3.25549384e+01 -1.85264065e+00 -7.73781154e-01 -7.73781154e-01
 -7.73781154e-01  1.06524301e+00  1.22096657e+00  1.22096657e+00
  1.22096657e+00  6.34308407e+00  6.50721714e+00  6.50721714e+00
  6.50721714e+00  2.90472773e+01  2.90472773e+01  2.90472773e+01
  3.22275500e+01  1.35731884e+02  1.58547887e+02  1.58547887e+02
  1.58547887e+02  5.00058418e+02  1.86803804e+03  7.99803124e+03
  4.77660877e+04]
E1 = -182.1356998290783  E_coul = 53.6096926235901
cycle= 1 E= -128.526007205488  delta_E= -0.031  |g|= 0.198  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.432649
diis-c [-0.18718535  1.        ]
  HOMO = -0.877094755773824  LUMO = 1.02944124922209
  mo_energy =
[-3.28688067e+01 -1.96049971e+00 -8.77094756e-01 -8.77094756e-01
 -8.77094756e-01  1.02944125e+00  1.17944894e+00  1.17944894e+00
  1.17944894e+00  6.22796121e+00  6.36936788e+00  6.36936788e+00
  6.36936788e+00  2.88014380e+01  2.88014380e+01  2.88014380e+01
  3.19912463e+01  1.35422854e+02  1.58220233e+02  1.58220233e+02
  1.58220233e+02  4.99705771e+02  1.86764962e+03  7.99761396e+03
  4.77656515e+04]
E1 = -182.85072685867968  E_coul = 54.322281516928314
cycle= 2 E= -128.528445341751  delta_E= -0.00244  |g|= 0.0978  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.213732
diis-c [-5.86366323e-04  3.29577786e-01  6.70422214e-01]
  HOMO = -0.843453164626487  LUMO = 1.04114630798568
  mo_energy =
[-3.27656664e+01 -1.92515391e+00 -8.43453165e-01 -8.43453165e-01
 -8.43453165e-01  1.04114631e+00  1.19313820e+00  1.19313820e+00
  1.19313820e+00  6.26551157e+00  6.41423973e+00  6.41423973e+00
  6.41423973e+00  2.88825328e+01  2.88825328e+01  2.88825328e+01
  3.20692739e+01  1.35524182e+02  1.58326478e+02  1.58326478e+02
  1.58326478e+02  4.99817497e+02  1.86776643e+03  7.99773315e+03
  4.77657716e+04]
E1 = -182.6123891113657  E_coul = 54.08313798583065
cycle= 3 E= -128.529251125535  delta_E= -0.000806  |g|= 0.00047  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103557
diis-c [-8.46508551e-08 -2.11050894e-03  3.90932773e-04  1.00171958e+00]
  HOMO = -0.843682930479651  LUMO = 1.04109744239396
  mo_energy =
[-3.27661226e+01 -1.92533777e+00 -8.43682930e-01 -8.43682930e-01
 -8.43682930e-01  1.04109744e+00  1.19308504e+00  1.19308504e+00
  1.19308504e+00  6.26533323e+00  6.41400968e+00  6.41400968e+00
  6.41400968e+00  2.88821650e+01  2.88821650e+01  2.88821650e+01
  3.20689250e+01  1.35523726e+02  1.58325985e+02  1.58325985e+02
  1.58325985e+02  4.99816931e+02  1.86776575e+03  7.99773238e+03
  4.77657708e+04]
E1 = -182.6131279828881  E_coul = 54.08387684096983
cycle= 4 E= -128.529251141918  delta_E= -1.64e-08  |g|= 5.14e-05  |ddm|= 0.000109
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00011524
diis-c [-4.77884897e-10  2.52714010e-04  3.07850365e-04 -1.67622369e-01
  1.16706181e+00]
  HOMO = -0.843707859453619  LUMO = 1.04109019314952
  mo_energy =
[-3.27661698e+01 -1.92535522e+00 -8.43707859e-01 -8.43707859e-01
 -8.43707859e-01  1.04109019e+00  1.19307397e+00  1.19307397e+00
  1.19307397e+00  6.26531029e+00  6.41397901e+00  6.41397901e+00
  6.41397901e+00  2.88821231e+01  2.88821231e+01  2.88821231e+01
  3.20688853e+01  1.35523678e+02  1.58325935e+02  1.58325935e+02
  1.58325935e+02  4.99816876e+02  1.86776568e+03  7.99773231e+03
  4.77657707e+04]
E1 = -182.61323325263706  E_coul = 54.08398211044119
cycle= 5 E= -128.529251142196  delta_E= -2.78e-10  |g|= 4.3e-06  |ddm|= 2.24e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61323325263706  E_coul = 54.08398211044119
  HOMO = -0.843705713644357  LUMO = 1.04109137943491
  mo_energy =
[-3.27661649e+01 -1.92535243e+00 -8.43705714e-01 -8.43705714e-01
 -8.43705714e-01  1.04109138e+00  1.19307495e+00  1.19307495e+00
  1.19307495e+00  6.26531302e+00  6.41398189e+00  6.41398189e+00
  6.41398189e+00  2.88821274e+01  2.88821274e+01  2.88821274e+01
  3.20688896e+01  1.35523683e+02  1.58325940e+02  1.58325940e+02
  1.58325940e+02  4.99816881e+02  1.86776569e+03  7.99773232e+03
  4.77657707e+04]
E1 = -182.61322195079435  E_coul = 54.083970808596945
Extra cycle  E= -128.529251142197  delta_E= -1.53e-12  |g|= 1.58e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272977e+02 2.35715428e+02
 7.65231635e+01 9.65816693e+00 2.70392763e+01 3.65462539e-01
 9.37913428e-01 2.60251580e+00 4.19410901e+00 1.51706913e+01
 7.30865842e+01 3.51443454e-01 1.26236725e+00]
E = -128.5292511421974
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941318        1
[INPUT] 0    0    [1    /1   ]  3661.45437439        1
[INPUT] 0    0    [1    /1   ]  833.272902177        1
[INPUT] 0    0    [1    /1   ]  235.716318647        1
[INPUT] 0    0    [1    /1   ]  76.5167629497        1
[INPUT] 0    0    [1    /1   ]  9.65346863385        1
[INPUT] 0    0    [1    /1   ]  27.0647081583        1
[INPUT] 0    0    [1    /1   ]  0.407994935959       1
[INPUT] 0    0    [1    /1   ]  1.10344458487        1
[INPUT] 0    0    [1    /1   ]  2.52151854119        1
[INPUT] 1    0    [1    /1   ]  4.04986045806        1
[INPUT] 1    0    [1    /1   ]  14.5426009159        1
[INPUT] 1    0    [1    /1   ]  69.8071932693        1
[INPUT] 1    0    [1    /1   ]  0.349744555962       1
[INPUT] 1    0    [1    /1   ]  1.23454244934        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131825154, 1.0]], [0, [3661.454374392986, 1.0]], [0, [833.2729021771493, 1.0]], [0, [235.71631864747337, 1.0]], [0, [76.51676294965898, 1.0]], [0, [9.653468633846662, 1.0]], [0, [27.064708158319817, 1.0]], [0, [0.40799493595862507, 1.0]], [0, [1.1034445848689294, 1.0]], [0, [2.521518541193191, 1.0]], [1, [4.049860458061008, 1.0]], [1, [14.542600915875171, 1.0]], [1, [69.80719326932117, 1.0]], [1, [0.3497445559624217, 1.0]], [1, [1.234542449335004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413183]
bas 1, expnt(s) = [3661.45437439]
bas 2, expnt(s) = [833.27290218]
bas 3, expnt(s) = [235.71631865]
bas 4, expnt(s) = [76.51676295]
bas 5, expnt(s) = [9.65346863]
bas 6, expnt(s) = [27.06470816]
bas 7, expnt(s) = [0.40799494]
bas 8, expnt(s) = [1.10344458]
bas 9, expnt(s) = [2.52151854]
bas 10, expnt(s) = [4.04986046]
bas 11, expnt(s) = [14.54260092]
bas 12, expnt(s) = [69.80719327]
bas 13, expnt(s) = [0.34974456]
bas 14, expnt(s) = [1.23454245]
CPU time:       143.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272902e+02 3.91837023e+02 2.35716319e+02 1.51987287e+02
 7.65167629e+01 6.53630736e+01 9.65346863e+00 1.38365420e+01
 2.70647082e+01 2.99790272e+01 4.07994936e-01 1.28975168e+00
 1.10344458e+00 2.72005647e+00 2.52151854e+00 5.05547129e+00
 4.04986046e+00 1.67604034e+01 1.45426009e+01 8.28489484e+01
 6.98071933e+01 5.88653341e+02 3.49744556e-01 7.84644792e-01
 1.23454245e+00 3.79635596e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997783840662692
cond(S) = 344.14014274772677
E1 = -183.5746886551141  E_coul = 55.0779459831539
init E= -128.49674267196
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773763096181497  LUMO = 1.20643761706893
  mo_energy =
[-3.25551348e+01 -1.85267798e+00 -7.73763096e-01 -7.73763096e-01
 -7.73763096e-01  1.20643762e+00  1.20643762e+00  1.20643762e+00
  1.26311223e+00  6.32964051e+00  6.32964051e+00  6.32964051e+00
  6.93276300e+00  2.78371960e+01  2.78371960e+01  2.78371960e+01
  3.28240878e+01  1.36257723e+02  1.50763864e+02  1.50763864e+02
  1.50763864e+02  5.00540968e+02  1.86847130e+03  7.99841233e+03
  4.77664031e+04]
E1 = -182.14428637436734  E_coul = 53.61754107629912
cycle= 1 E= -128.526745298068  delta_E= -0.03  |g|= 0.197  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430564
diis-c [-0.18538549  1.        ]
  HOMO = -0.876406854685548  LUMO = 1.16595692511648
  mo_energy =
[-3.28679131e+01 -1.95986621e+00 -8.76406855e-01 -8.76406855e-01
 -8.76406855e-01  1.16595693e+00  1.16595693e+00  1.16595693e+00
  1.22181976e+00  6.19578133e+00  6.19578133e+00  6.19578133e+00
  6.81604001e+00  2.75955161e+01  2.75955161e+01  2.75955161e+01
  3.25898426e+01  1.35949887e+02  1.50438979e+02  1.50438979e+02
  1.50438979e+02  5.00189311e+02  1.86808366e+03  7.99799578e+03
  4.77659676e+04]
E1 = -182.85317816169857  E_coul = 54.32402753884941
cycle= 2 E= -128.529150622849  delta_E= -0.00241  |g|= 0.0969  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.212336
diis-c [-5.77668778e-04  3.29198680e-01  6.70801320e-01]
  HOMO = -0.843047026428844  LUMO = 1.17924459319736
  mo_energy =
[-3.27655711e+01 -1.92479674e+00 -8.43047026e-01 -8.43047026e-01
 -8.43047026e-01  1.17924459e+00  1.17924459e+00  1.17924459e+00
  1.23522235e+00  6.23929550e+00  6.23929550e+00  6.23929550e+00
  6.85400239e+00  2.76749046e+01  2.76749046e+01  2.76749046e+01
  3.26670194e+01  1.36050372e+02  1.50543967e+02  1.50543967e+02
  1.50543967e+02  5.00300170e+02  1.86819958e+03  7.99811407e+03
  4.77660868e+04]
E1 = -182.61675637901  E_coul = 54.08681314436993
cycle= 3 E= -128.52994323464  delta_E= -0.000793  |g|= 0.000521  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108427
diis-c [-7.54470490e-08 -2.16283074e-03  5.69203019e-04  1.00159363e+00]
  HOMO = -0.843304902123674  LUMO = 1.17917822379728
  mo_energy =
[-3.27660667e+01 -1.92500762e+00 -8.43304902e-01 -8.43304902e-01
 -8.43304902e-01  1.17917822e+00  1.17917822e+00  1.17917822e+00
  1.23514843e+00  6.23904068e+00  6.23904068e+00  6.23904068e+00
  6.85378103e+00  2.76744996e+01  2.76744996e+01  2.76744996e+01
  3.26666332e+01  1.36049879e+02  1.50543442e+02  1.50543442e+02
  1.50543442e+02  5.00299574e+02  1.86819887e+03  7.99811328e+03
  4.77660860e+04]
E1 = -182.61753144797626  E_coul = 54.08758819313601
cycle= 4 E= -128.52994325484  delta_E= -2.02e-08  |g|= 5.47e-05  |ddm|= 0.000196
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000116944
diis-c [-5.28914836e-10  2.52211830e-04  2.73752020e-04 -1.68183849e-01
  1.16765788e+00]
  HOMO = -0.843332363098338  LUMO = 1.17916614573397
  mo_energy =
[-3.27661153e+01 -1.92502707e+00 -8.43332363e-01 -8.43332363e-01
 -8.43332363e-01  1.17916615e+00  1.17916615e+00  1.17916615e+00
  1.23513882e+00  6.23900811e+00  6.23900811e+00  6.23900811e+00
  6.85375418e+00  2.76744558e+01  2.76744558e+01  2.76744558e+01
  3.26665911e+01  1.36049830e+02  1.50543391e+02  1.50543391e+02
  1.50543391e+02  5.00299518e+02  1.86819881e+03  7.99811322e+03
  4.77660859e+04]
E1 = -182.61763573884636  E_coul = 54.08769248368849
cycle= 5 E= -128.529943255158  delta_E= -3.18e-10  |g|= 4.47e-06  |ddm|= 3.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61763573884636  E_coul = 54.08769248368849
  HOMO = -0.843330186312533  LUMO = 1.17916714742803
  mo_energy =
[-3.27661106e+01 -1.92502421e+00 -8.43330186e-01 -8.43330186e-01
 -8.43330186e-01  1.17916715e+00  1.17916715e+00  1.17916715e+00
  1.23514023e+00  6.23901093e+00  6.23901093e+00  6.23901093e+00
  6.85375703e+00  2.76744600e+01  2.76744600e+01  2.76744600e+01
  3.26665953e+01  1.36049835e+02  1.50543396e+02  1.50543396e+02
  1.50543396e+02  5.00299522e+02  1.86819882e+03  7.99811322e+03
  4.77660859e+04]
E1 = -182.61762541297372  E_coul = 54.08768215781424
Extra cycle  E= -128.529943255159  delta_E= -1.62e-12  |g|= 1.47e-06  |ddm|= 1.62e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272902e+02 2.35716319e+02
 7.65167629e+01 9.65346863e+00 2.70647082e+01 4.07994936e-01
 1.10344458e+00 2.52151854e+00 4.04986046e+00 1.45426009e+01
 6.98071933e+01 3.49744556e-01 1.23454245e+00]
E = -128.52994325515948
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941318        1
[INPUT] 0    0    [1    /1   ]  3661.45437439        1
[INPUT] 0    0    [1    /1   ]  833.272902177        1
[INPUT] 0    0    [1    /1   ]  235.716318647        1
[INPUT] 0    0    [1    /1   ]  76.5167629497        1
[INPUT] 0    0    [1    /1   ]  9.65346863385        1
[INPUT] 0    0    [1    /1   ]  27.0647081583        1
[INPUT] 0    0    [1    /1   ]  0.407994935959       1
[INPUT] 0    0    [1    /1   ]  1.10344458487        1
[INPUT] 0    0    [1    /1   ]  2.52151854119        1
[INPUT] 1    0    [1    /1   ]  4.04986045806        1
[INPUT] 1    0    [1    /1   ]  14.5426009159        1
[INPUT] 1    0    [1    /1   ]  69.8071932693        1
[INPUT] 1    0    [1    /1   ]  0.349744555962       1
[INPUT] 1    0    [1    /1   ]  1.23454244934        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131825154, 1.0]], [0, [3661.454374392986, 1.0]], [0, [833.2729021771493, 1.0]], [0, [235.71631864747337, 1.0]], [0, [76.51676294965898, 1.0]], [0, [9.653468633846662, 1.0]], [0, [27.064708158319817, 1.0]], [0, [0.40799493595862507, 1.0]], [0, [1.1034445848689294, 1.0]], [0, [2.521518541193191, 1.0]], [1, [4.049860458061008, 1.0]], [1, [14.542600915875171, 1.0]], [1, [69.80719326932117, 1.0]], [1, [0.3497445559624217, 1.0]], [1, [1.234542449335004, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413183]
bas 1, expnt(s) = [3661.45437439]
bas 2, expnt(s) = [833.27290218]
bas 3, expnt(s) = [235.71631865]
bas 4, expnt(s) = [76.51676295]
bas 5, expnt(s) = [9.65346863]
bas 6, expnt(s) = [27.06470816]
bas 7, expnt(s) = [0.40799494]
bas 8, expnt(s) = [1.10344458]
bas 9, expnt(s) = [2.52151854]
bas 10, expnt(s) = [4.04986046]
bas 11, expnt(s) = [14.54260092]
bas 12, expnt(s) = [69.80719327]
bas 13, expnt(s) = [0.34974456]
bas 14, expnt(s) = [1.23454245]
CPU time:       143.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272902e+02 3.91837023e+02 2.35716319e+02 1.51987287e+02
 7.65167629e+01 6.53630736e+01 9.65346863e+00 1.38365420e+01
 2.70647082e+01 2.99790272e+01 4.07994936e-01 1.28975168e+00
 1.10344458e+00 2.72005647e+00 2.52151854e+00 5.05547129e+00
 4.04986046e+00 1.67604034e+01 1.45426009e+01 8.28489484e+01
 6.98071933e+01 5.88653341e+02 3.49744556e-01 7.84644792e-01
 1.23454245e+00 3.79635596e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997783840662692
cond(S) = 344.14014274772677
E1 = -183.5746886551141  E_coul = 55.0779459831539
init E= -128.49674267196
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773763096181497  LUMO = 1.20643761706893
  mo_energy =
[-3.25551348e+01 -1.85267798e+00 -7.73763096e-01 -7.73763096e-01
 -7.73763096e-01  1.20643762e+00  1.20643762e+00  1.20643762e+00
  1.26311223e+00  6.32964051e+00  6.32964051e+00  6.32964051e+00
  6.93276300e+00  2.78371960e+01  2.78371960e+01  2.78371960e+01
  3.28240878e+01  1.36257723e+02  1.50763864e+02  1.50763864e+02
  1.50763864e+02  5.00540968e+02  1.86847130e+03  7.99841233e+03
  4.77664031e+04]
E1 = -182.14428637436734  E_coul = 53.61754107629912
cycle= 1 E= -128.526745298068  delta_E= -0.03  |g|= 0.197  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430564
diis-c [-0.18538549  1.        ]
  HOMO = -0.876406854685548  LUMO = 1.16595692511648
  mo_energy =
[-3.28679131e+01 -1.95986621e+00 -8.76406855e-01 -8.76406855e-01
 -8.76406855e-01  1.16595693e+00  1.16595693e+00  1.16595693e+00
  1.22181976e+00  6.19578133e+00  6.19578133e+00  6.19578133e+00
  6.81604001e+00  2.75955161e+01  2.75955161e+01  2.75955161e+01
  3.25898426e+01  1.35949887e+02  1.50438979e+02  1.50438979e+02
  1.50438979e+02  5.00189311e+02  1.86808366e+03  7.99799578e+03
  4.77659676e+04]
E1 = -182.85317816169857  E_coul = 54.32402753884941
cycle= 2 E= -128.529150622849  delta_E= -0.00241  |g|= 0.0969  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.212336
diis-c [-5.77668778e-04  3.29198680e-01  6.70801320e-01]
  HOMO = -0.843047026428844  LUMO = 1.17924459319736
  mo_energy =
[-3.27655711e+01 -1.92479674e+00 -8.43047026e-01 -8.43047026e-01
 -8.43047026e-01  1.17924459e+00  1.17924459e+00  1.17924459e+00
  1.23522235e+00  6.23929550e+00  6.23929550e+00  6.23929550e+00
  6.85400239e+00  2.76749046e+01  2.76749046e+01  2.76749046e+01
  3.26670194e+01  1.36050372e+02  1.50543967e+02  1.50543967e+02
  1.50543967e+02  5.00300170e+02  1.86819958e+03  7.99811407e+03
  4.77660868e+04]
E1 = -182.61675637901  E_coul = 54.08681314436993
cycle= 3 E= -128.52994323464  delta_E= -0.000793  |g|= 0.000521  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108427
diis-c [-7.54470490e-08 -2.16283074e-03  5.69203019e-04  1.00159363e+00]
  HOMO = -0.843304902123674  LUMO = 1.17917822379728
  mo_energy =
[-3.27660667e+01 -1.92500762e+00 -8.43304902e-01 -8.43304902e-01
 -8.43304902e-01  1.17917822e+00  1.17917822e+00  1.17917822e+00
  1.23514843e+00  6.23904068e+00  6.23904068e+00  6.23904068e+00
  6.85378103e+00  2.76744996e+01  2.76744996e+01  2.76744996e+01
  3.26666332e+01  1.36049879e+02  1.50543442e+02  1.50543442e+02
  1.50543442e+02  5.00299574e+02  1.86819887e+03  7.99811328e+03
  4.77660860e+04]
E1 = -182.61753144797626  E_coul = 54.08758819313601
cycle= 4 E= -128.52994325484  delta_E= -2.02e-08  |g|= 5.47e-05  |ddm|= 0.000196
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000116944
diis-c [-5.28914836e-10  2.52211830e-04  2.73752020e-04 -1.68183849e-01
  1.16765788e+00]
  HOMO = -0.843332363098338  LUMO = 1.17916614573397
  mo_energy =
[-3.27661153e+01 -1.92502707e+00 -8.43332363e-01 -8.43332363e-01
 -8.43332363e-01  1.17916615e+00  1.17916615e+00  1.17916615e+00
  1.23513882e+00  6.23900811e+00  6.23900811e+00  6.23900811e+00
  6.85375418e+00  2.76744558e+01  2.76744558e+01  2.76744558e+01
  3.26665911e+01  1.36049830e+02  1.50543391e+02  1.50543391e+02
  1.50543391e+02  5.00299518e+02  1.86819881e+03  7.99811322e+03
  4.77660859e+04]
E1 = -182.61763573884636  E_coul = 54.08769248368849
cycle= 5 E= -128.529943255158  delta_E= -3.18e-10  |g|= 4.47e-06  |ddm|= 3.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61763573884636  E_coul = 54.08769248368849
  HOMO = -0.843330186312533  LUMO = 1.17916714742803
  mo_energy =
[-3.27661106e+01 -1.92502421e+00 -8.43330186e-01 -8.43330186e-01
 -8.43330186e-01  1.17916715e+00  1.17916715e+00  1.17916715e+00
  1.23514023e+00  6.23901093e+00  6.23901093e+00  6.23901093e+00
  6.85375703e+00  2.76744600e+01  2.76744600e+01  2.76744600e+01
  3.26665953e+01  1.36049835e+02  1.50543396e+02  1.50543396e+02
  1.50543396e+02  5.00299522e+02  1.86819882e+03  7.99811322e+03
  4.77660859e+04]
E1 = -182.61762541297372  E_coul = 54.08768215781424
Extra cycle  E= -128.529943255159  delta_E= -1.62e-12  |g|= 1.47e-06  |ddm|= 1.62e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 344.14014274772677
E1 = -182.61762541297372  E_coul = 54.08768215781424
init E= -128.529943255159
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.843330919192667  LUMO = 1.17916686689801
  mo_energy =
[-3.27661129e+01 -1.92502486e+00 -8.43330919e-01 -8.43330919e-01
 -8.43330919e-01  1.17916687e+00  1.17916687e+00  1.17916687e+00
  1.23514002e+00  6.23900998e+00  6.23900998e+00  6.23900998e+00
  6.85375627e+00  2.76744583e+01  2.76744583e+01  2.76744583e+01
  3.26665936e+01  1.36049832e+02  1.50543393e+02  1.50543393e+02
  1.50543393e+02  5.00299520e+02  1.86819881e+03  7.99811322e+03
  4.77660859e+04]
E1 = -182.61763092676742  E_coul = 54.08768767160797
cycle= 1 E= -128.529943255159  delta_E= 2.84e-14  |g|= 7.65e-07  |ddm|= 5.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61763092676742  E_coul = 54.08768767160797
  HOMO = -0.843330534858268  LUMO = 1.17916702184793
  mo_energy =
[-3.27661118e+01 -1.92502443e+00 -8.43330535e-01 -8.43330535e-01
 -8.43330535e-01  1.17916702e+00  1.17916702e+00  1.17916702e+00
  1.23514019e+00  6.23901048e+00  6.23901048e+00  6.23901048e+00
  6.85375672e+00  2.76744592e+01  2.76744592e+01  2.76744592e+01
  3.26665945e+01  1.36049833e+02  1.50543395e+02  1.50543395e+02
  1.50543395e+02  5.00299521e+02  1.86819882e+03  7.99811322e+03
  4.77660859e+04]
E1 = -182.617628216543  E_coul = 54.087684961383715
Extra cycle  E= -128.529943255159  delta_E= 1.42e-13  |g|= 3.68e-07  |ddm|= 2.87e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272902e+02 2.35716319e+02
 7.65167629e+01 9.65346863e+00 2.70647082e+01 4.07994936e-01
 1.10344458e+00 2.52151854e+00 4.04986046e+00 1.45426009e+01
 6.98071933e+01 3.49744556e-01 1.23454245e+00]
grad_E = [-2.34445084e-09  1.24199482e-07 -2.49583582e-06  3.10153714e-05
 -2.50845641e-04 -2.74557978e-03  1.33603099e-03  8.91341007e-03
  5.58076390e-04 -5.64748820e-04 -5.89703898e-03  9.94715845e-04
  8.79703869e-05 -1.56556070e-03  9.19436820e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437194        1
[INPUT] 0    0    [1    /1   ]  833.272950847        1
[INPUT] 0    0    [1    /1   ]  235.715724884        1
[INPUT] 0    0    [1    /1   ]  76.5212467055        1
[INPUT] 0    0    [1    /1   ]  9.68850587675        1
[INPUT] 0    0    [1    /1   ]  27.0429437198        1
[INPUT] 0    0    [1    /1   ]  0.366210947039       1
[INPUT] 0    0    [1    /1   ]  1.04795340007        1
[INPUT] 0    0    [1    /1   ]  2.52510963434        1
[INPUT] 1    0    [1    /1   ]  4.15845036536        1
[INPUT] 1    0    [1    /1   ]  14.8770059497        1
[INPUT] 1    0    [1    /1   ]  70.5871715006        1
[INPUT] 1    0    [1    /1   ]  0.34700672042        1
[INPUT] 1    0    [1    /1   ]  1.24766007805        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131870665, 1.0]], [0, [3661.4543719410754, 1.0]], [0, [833.272950846777, 1.0]], [0, [235.71572488387477, 1.0]], [0, [76.52124670551359, 1.0]], [0, [9.688505876747502, 1.0]], [0, [27.042943719848765, 1.0]], [0, [0.3662109470393446, 1.0]], [0, [1.0479534000715174, 1.0]], [0, [2.525109634343096, 1.0]], [1, [4.158450365360054, 1.0]], [1, [14.877005949685016, 1.0]], [1, [70.58717150059216, 1.0]], [1, [0.3470067204203538, 1.0]], [1, [1.247660078051921, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413187]
bas 1, expnt(s) = [3661.45437194]
bas 2, expnt(s) = [833.27295085]
bas 3, expnt(s) = [235.71572488]
bas 4, expnt(s) = [76.52124671]
bas 5, expnt(s) = [9.68850588]
bas 6, expnt(s) = [27.04294372]
bas 7, expnt(s) = [0.36621095]
bas 8, expnt(s) = [1.0479534]
bas 9, expnt(s) = [2.52510963]
bas 10, expnt(s) = [4.15845037]
bas 11, expnt(s) = [14.87700595]
bas 12, expnt(s) = [70.5871715]
bas 13, expnt(s) = [0.34700672]
bas 14, expnt(s) = [1.24766008]
CPU time:       146.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272951e+02 3.91837040e+02 2.35715725e+02 1.51986999e+02
 7.65212467e+01 6.53659462e+01 9.68850588e+00 1.38741897e+01
 2.70429437e+01 2.99609443e+01 3.66210947e-01 1.18936051e+00
 1.04795340e+00 2.61680585e+00 2.52510963e+00 5.06087025e+00
 4.15845037e+00 1.73240247e+01 1.48770059e+01 8.52371290e+01
 7.05871715e+01 5.96886309e+02 3.47006720e-01 7.76974472e-01
 1.24766008e+00 3.84684547e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99784256079043
cond(S) = 314.34934831139134
E1 = -183.57306833222174  E_coul = 55.07676440620518
init E= -128.496303926017
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874351795712  LUMO = 1.12710295212151
  mo_energy =
[-3.25553501e+01 -1.85287413e+00 -7.73874352e-01 -7.73874352e-01
 -7.73874352e-01  1.12710295e+00  1.20173812e+00  1.20173812e+00
  1.20173812e+00  6.42730025e+00  6.42730025e+00  6.42730025e+00
  6.59101361e+00  2.85608664e+01  2.85608664e+01  2.85608664e+01
  3.24684867e+01  1.35972098e+02  1.53413420e+02  1.53413420e+02
  1.53413420e+02  5.00285331e+02  1.86824277e+03  7.99821149e+03
  4.77662369e+04]
E1 = -182.12369097770647  E_coul = 53.596767609989634
cycle= 1 E= -128.526923367717  delta_E= -0.0306  |g|= 0.199  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434463
diis-c [-0.18875786  1.        ]
  HOMO = -0.878277369496947  LUMO = 1.08841363627082
  mo_energy =
[-3.28710555e+01 -1.96163999e+00 -8.78277369e-01 -8.78277369e-01
 -8.78277369e-01  1.08841364e+00  1.16024176e+00  1.16024176e+00
  1.16024176e+00  6.28925125e+00  6.28925125e+00  6.28925125e+00
  6.47344473e+00  2.83145157e+01  2.83145157e+01  2.83145157e+01
  3.22311785e+01  1.35661255e+02  1.53085261e+02  1.53085261e+02
  1.53085261e+02  4.99930683e+02  1.86785208e+03  7.99779185e+03
  4.77657983e+04]
E1 = -182.84139622347604  E_coul = 54.312023886369346
cycle= 2 E= -128.529372337107  delta_E= -0.00245  |g|= 0.0981  |ddm|= 0.0707
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.214891
diis-c [-5.86952875e-04  3.29860087e-01  6.70139913e-01]
  HOMO = -0.844531822866678  LUMO = 1.10088971910064
  mo_energy =
[-3.27675561e+01 -1.92616813e+00 -8.44531823e-01 -8.44531823e-01
 -8.44531823e-01  1.10088972e+00  1.17375398e+00  1.17375398e+00
  1.17375398e+00  6.33398493e+00  6.33398493e+00  6.33398493e+00
  6.51147115e+00  2.83954306e+01  2.83954306e+01  2.83954306e+01
  3.23093782e+01  1.35762911e+02  1.53191532e+02  1.53191532e+02
  1.53191532e+02  5.00042782e+02  1.86796927e+03  7.99791142e+03
  4.77659187e+04]
E1 = -182.60112090385934  E_coul = 54.07093373167491
cycle= 3 E= -128.530187172184  delta_E= -0.000815  |g|= 0.00061  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00122015
diis-c [-1.37090147e-07 -2.42296587e-03  5.28606715e-04  1.00189436e+00]
  HOMO = -0.84482979554558  LUMO = 1.10081135229718
  mo_energy =
[-3.27680985e+01 -1.92639940e+00 -8.44829796e-01 -8.44829796e-01
 -8.44829796e-01  1.10081135e+00  1.17366981e+00  1.17366981e+00
  1.17366981e+00  6.33368632e+00  6.33368632e+00  6.33368632e+00
  6.51121474e+00  2.83949755e+01  2.83949755e+01  2.83949755e+01
  3.23089465e+01  1.35762369e+02  1.53190956e+02  1.53190956e+02
  1.53190956e+02  5.00042129e+02  1.86796850e+03  7.99791056e+03
  4.77659178e+04]
E1 = -182.60195574093166  E_coul = 54.071768537853096
cycle= 4 E= -128.530187203079  delta_E= -3.09e-08  |g|= 7.03e-05  |ddm|= 0.000296
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000145273
diis-c [-9.43036261e-10  3.34239134e-04  2.95793917e-04 -2.02504833e-01
  1.20187480e+00]
  HOMO = -0.844864048151653  LUMO = 1.10080193960301
  mo_energy =
[-3.27681566e+01 -1.92642018e+00 -8.44864048e-01 -8.44864048e-01
 -8.44864048e-01  1.10080194e+00  1.17365470e+00  1.17365470e+00
  1.17365470e+00  6.33364629e+00  6.33364629e+00  6.33364629e+00
  6.51118306e+00  2.83949229e+01  2.83949229e+01  2.83949229e+01
  3.23088963e+01  1.35762310e+02  1.53190895e+02  1.53190895e+02
  1.53190895e+02  5.00042061e+02  1.86796842e+03  7.99791048e+03
  4.77659178e+04]
E1 = -182.60207798759376  E_coul = 54.07189078389236
cycle= 5 E= -128.530187203701  delta_E= -6.23e-10  |g|= 6.33e-06  |ddm|= 4.87e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60207798759376  E_coul = 54.07189078389236
  HOMO = -0.844860760075296  LUMO = 1.10080384193222
  mo_energy =
[-3.27681498e+01 -1.92641609e+00 -8.44860760e-01 -8.44860760e-01
 -8.44860760e-01  1.10080384e+00  1.17365622e+00  1.17365622e+00
  1.17365622e+00  6.33365052e+00  6.33365052e+00  6.33365052e+00
  6.51118726e+00  2.83949290e+01  2.83949290e+01  2.83949290e+01
  3.23089025e+01  1.35762317e+02  1.53190902e+02  1.53190902e+02
  1.53190902e+02  5.00042067e+02  1.86796843e+03  7.99791049e+03
  4.77659178e+04]
E1 = -182.60206345437138  E_coul = 54.07187625066754
Extra cycle  E= -128.530187203704  delta_E= -2.42e-12  |g|= 2.06e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272951e+02 2.35715725e+02
 7.65212467e+01 9.68850588e+00 2.70429437e+01 3.66210947e-01
 1.04795340e+00 2.52510963e+00 4.15845037e+00 1.48770059e+01
 7.05871715e+01 3.47006720e-01 1.24766008e+00]
E = -128.53018720370383
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437194        1
[INPUT] 0    0    [1    /1   ]  833.272950847        1
[INPUT] 0    0    [1    /1   ]  235.715724884        1
[INPUT] 0    0    [1    /1   ]  76.5212467055        1
[INPUT] 0    0    [1    /1   ]  9.68850587675        1
[INPUT] 0    0    [1    /1   ]  27.0429437198        1
[INPUT] 0    0    [1    /1   ]  0.366210947039       1
[INPUT] 0    0    [1    /1   ]  1.04795340007        1
[INPUT] 0    0    [1    /1   ]  2.52510963434        1
[INPUT] 1    0    [1    /1   ]  4.15845036536        1
[INPUT] 1    0    [1    /1   ]  14.8770059497        1
[INPUT] 1    0    [1    /1   ]  70.5871715006        1
[INPUT] 1    0    [1    /1   ]  0.34700672042        1
[INPUT] 1    0    [1    /1   ]  1.24766007805        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131870665, 1.0]], [0, [3661.4543719410754, 1.0]], [0, [833.272950846777, 1.0]], [0, [235.71572488387477, 1.0]], [0, [76.52124670551359, 1.0]], [0, [9.688505876747502, 1.0]], [0, [27.042943719848765, 1.0]], [0, [0.3662109470393446, 1.0]], [0, [1.0479534000715174, 1.0]], [0, [2.525109634343096, 1.0]], [1, [4.158450365360054, 1.0]], [1, [14.877005949685016, 1.0]], [1, [70.58717150059216, 1.0]], [1, [0.3470067204203538, 1.0]], [1, [1.247660078051921, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413187]
bas 1, expnt(s) = [3661.45437194]
bas 2, expnt(s) = [833.27295085]
bas 3, expnt(s) = [235.71572488]
bas 4, expnt(s) = [76.52124671]
bas 5, expnt(s) = [9.68850588]
bas 6, expnt(s) = [27.04294372]
bas 7, expnt(s) = [0.36621095]
bas 8, expnt(s) = [1.0479534]
bas 9, expnt(s) = [2.52510963]
bas 10, expnt(s) = [4.15845037]
bas 11, expnt(s) = [14.87700595]
bas 12, expnt(s) = [70.5871715]
bas 13, expnt(s) = [0.34700672]
bas 14, expnt(s) = [1.24766008]
CPU time:       147.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272951e+02 3.91837040e+02 2.35715725e+02 1.51986999e+02
 7.65212467e+01 6.53659462e+01 9.68850588e+00 1.38741897e+01
 2.70429437e+01 2.99609443e+01 3.66210947e-01 1.18936051e+00
 1.04795340e+00 2.61680585e+00 2.52510963e+00 5.06087025e+00
 4.15845037e+00 1.73240247e+01 1.48770059e+01 8.52371290e+01
 7.05871715e+01 5.96886309e+02 3.47006720e-01 7.76974472e-01
 1.24766008e+00 3.84684547e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99784256079043
cond(S) = 314.34934831139134
E1 = -183.57306833222174  E_coul = 55.07676440620518
init E= -128.496303926017
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773874351795712  LUMO = 1.12710295212151
  mo_energy =
[-3.25553501e+01 -1.85287413e+00 -7.73874352e-01 -7.73874352e-01
 -7.73874352e-01  1.12710295e+00  1.20173812e+00  1.20173812e+00
  1.20173812e+00  6.42730025e+00  6.42730025e+00  6.42730025e+00
  6.59101361e+00  2.85608664e+01  2.85608664e+01  2.85608664e+01
  3.24684867e+01  1.35972098e+02  1.53413420e+02  1.53413420e+02
  1.53413420e+02  5.00285331e+02  1.86824277e+03  7.99821149e+03
  4.77662369e+04]
E1 = -182.12369097770647  E_coul = 53.596767609989634
cycle= 1 E= -128.526923367717  delta_E= -0.0306  |g|= 0.199  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434463
diis-c [-0.18875786  1.        ]
  HOMO = -0.878277369496947  LUMO = 1.08841363627082
  mo_energy =
[-3.28710555e+01 -1.96163999e+00 -8.78277369e-01 -8.78277369e-01
 -8.78277369e-01  1.08841364e+00  1.16024176e+00  1.16024176e+00
  1.16024176e+00  6.28925125e+00  6.28925125e+00  6.28925125e+00
  6.47344473e+00  2.83145157e+01  2.83145157e+01  2.83145157e+01
  3.22311785e+01  1.35661255e+02  1.53085261e+02  1.53085261e+02
  1.53085261e+02  4.99930683e+02  1.86785208e+03  7.99779185e+03
  4.77657983e+04]
E1 = -182.84139622347604  E_coul = 54.312023886369346
cycle= 2 E= -128.529372337107  delta_E= -0.00245  |g|= 0.0981  |ddm|= 0.0707
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.214891
diis-c [-5.86952875e-04  3.29860087e-01  6.70139913e-01]
  HOMO = -0.844531822866678  LUMO = 1.10088971910064
  mo_energy =
[-3.27675561e+01 -1.92616813e+00 -8.44531823e-01 -8.44531823e-01
 -8.44531823e-01  1.10088972e+00  1.17375398e+00  1.17375398e+00
  1.17375398e+00  6.33398493e+00  6.33398493e+00  6.33398493e+00
  6.51147115e+00  2.83954306e+01  2.83954306e+01  2.83954306e+01
  3.23093782e+01  1.35762911e+02  1.53191532e+02  1.53191532e+02
  1.53191532e+02  5.00042782e+02  1.86796927e+03  7.99791142e+03
  4.77659187e+04]
E1 = -182.60112090385934  E_coul = 54.07093373167491
cycle= 3 E= -128.530187172184  delta_E= -0.000815  |g|= 0.00061  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00122015
diis-c [-1.37090147e-07 -2.42296587e-03  5.28606715e-04  1.00189436e+00]
  HOMO = -0.84482979554558  LUMO = 1.10081135229718
  mo_energy =
[-3.27680985e+01 -1.92639940e+00 -8.44829796e-01 -8.44829796e-01
 -8.44829796e-01  1.10081135e+00  1.17366981e+00  1.17366981e+00
  1.17366981e+00  6.33368632e+00  6.33368632e+00  6.33368632e+00
  6.51121474e+00  2.83949755e+01  2.83949755e+01  2.83949755e+01
  3.23089465e+01  1.35762369e+02  1.53190956e+02  1.53190956e+02
  1.53190956e+02  5.00042129e+02  1.86796850e+03  7.99791056e+03
  4.77659178e+04]
E1 = -182.60195574093166  E_coul = 54.071768537853096
cycle= 4 E= -128.530187203079  delta_E= -3.09e-08  |g|= 7.03e-05  |ddm|= 0.000296
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000145273
diis-c [-9.43036261e-10  3.34239134e-04  2.95793917e-04 -2.02504833e-01
  1.20187480e+00]
  HOMO = -0.844864048151653  LUMO = 1.10080193960301
  mo_energy =
[-3.27681566e+01 -1.92642018e+00 -8.44864048e-01 -8.44864048e-01
 -8.44864048e-01  1.10080194e+00  1.17365470e+00  1.17365470e+00
  1.17365470e+00  6.33364629e+00  6.33364629e+00  6.33364629e+00
  6.51118306e+00  2.83949229e+01  2.83949229e+01  2.83949229e+01
  3.23088963e+01  1.35762310e+02  1.53190895e+02  1.53190895e+02
  1.53190895e+02  5.00042061e+02  1.86796842e+03  7.99791048e+03
  4.77659178e+04]
E1 = -182.60207798759376  E_coul = 54.07189078389236
cycle= 5 E= -128.530187203701  delta_E= -6.23e-10  |g|= 6.33e-06  |ddm|= 4.87e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60207798759376  E_coul = 54.07189078389236
  HOMO = -0.844860760075296  LUMO = 1.10080384193222
  mo_energy =
[-3.27681498e+01 -1.92641609e+00 -8.44860760e-01 -8.44860760e-01
 -8.44860760e-01  1.10080384e+00  1.17365622e+00  1.17365622e+00
  1.17365622e+00  6.33365052e+00  6.33365052e+00  6.33365052e+00
  6.51118726e+00  2.83949290e+01  2.83949290e+01  2.83949290e+01
  3.23089025e+01  1.35762317e+02  1.53190902e+02  1.53190902e+02
  1.53190902e+02  5.00042067e+02  1.86796843e+03  7.99791049e+03
  4.77659178e+04]
E1 = -182.60206345437138  E_coul = 54.07187625066754
Extra cycle  E= -128.530187203704  delta_E= -2.42e-12  |g|= 2.06e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 314.34934831139134
E1 = -182.60206345437138  E_coul = 54.07187625066754
init E= -128.530187203704
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.844861777776829  LUMO = 1.10080355867869
  mo_energy =
[-3.27681531e+01 -1.92641702e+00 -8.44861778e-01 -8.44861778e-01
 -8.44861778e-01  1.10080356e+00  1.17365583e+00  1.17365583e+00
  1.17365583e+00  6.33364917e+00  6.33364917e+00  6.33364917e+00
  6.51118620e+00  2.83949265e+01  2.83949265e+01  2.83949265e+01
  3.23089001e+01  1.35762314e+02  1.53190898e+02  1.53190898e+02
  1.53190898e+02  5.00042063e+02  1.86796843e+03  7.99791048e+03
  4.77659178e+04]
E1 = -182.6020713119961  E_coul = 54.07188410829167
cycle= 1 E= -128.530187203704  delta_E= -5.97e-13  |g|= 1.08e-06  |ddm|= 8.15e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6020713119961  E_coul = 54.07188410829167
  HOMO = -0.844861227471913  LUMO = 1.10080377873064
  mo_energy =
[-3.27681514e+01 -1.92641642e+00 -8.44861227e-01 -8.44861227e-01
 -8.44861227e-01  1.10080378e+00  1.17365605e+00  1.17365605e+00
  1.17365605e+00  6.33364990e+00  6.33364990e+00  6.33364990e+00
  6.51118684e+00  2.83949278e+01  2.83949278e+01  2.83949278e+01
  3.23089013e+01  1.35762315e+02  1.53190900e+02  1.53190900e+02
  1.53190900e+02  5.00042065e+02  1.86796843e+03  7.99791048e+03
  4.77659178e+04]
E1 = -182.6020674336822  E_coul = 54.071880229977985
Extra cycle  E= -128.530187203704  delta_E= 1.99e-13  |g|= 5.28e-07  |ddm|= 4.01e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272951e+02 2.35715725e+02
 7.65212467e+01 9.68850588e+00 2.70429437e+01 3.66210947e-01
 1.04795340e+00 2.52510963e+00 4.15845037e+00 1.48770059e+01
 7.05871715e+01 3.47006720e-01 1.24766008e+00]
grad_E = [-1.85840940e-09  9.84671672e-08 -1.98771405e-06  2.49293093e-05
 -2.06347196e-04 -2.32968563e-03  1.12049548e-03 -7.51018801e-03
  4.83519916e-03 -1.11081300e-03 -1.64658290e-03  6.17436602e-04
  7.59614963e-05 -1.91779603e-02  5.31406898e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.4543708         1
[INPUT] 0    0    [1    /1   ]  833.272973579        1
[INPUT] 0    0    [1    /1   ]  235.715452359        1
[INPUT] 0    0    [1    /1   ]  76.5232261456        1
[INPUT] 0    0    [1    /1   ]  9.69118659912        1
[INPUT] 0    0    [1    /1   ]  27.0349128644        1
[INPUT] 0    0    [1    /1   ]  0.356518570684       1
[INPUT] 0    0    [1    /1   ]  0.998207335803       1
[INPUT] 0    0    [1    /1   ]  2.54767987119        1
[INPUT] 1    0    [1    /1   ]  4.19531334895        1
[INPUT] 1    0    [1    /1   ]  15.0054846724        1
[INPUT] 1    0    [1    /1   ]  71.5465224586        1
[INPUT] 1    0    [1    /1   ]  0.354029495644       1
[INPUT] 1    0    [1    /1   ]  1.26150302455        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.7941318915, 1.0]], [0, [3661.4543707955695, 1.0]], [0, [833.2729735789529, 1.0]], [0, [235.7154523588596, 1.0]], [0, [76.52322614559682, 1.0]], [0, [9.691186599121021, 1.0]], [0, [27.03491286444415, 1.0]], [0, [0.3565185706835687, 1.0]], [0, [0.99820733580297, 1.0]], [0, [2.5476798711890964, 1.0]], [1, [4.195313348951029, 1.0]], [1, [15.005484672399346, 1.0]], [1, [71.5465224585684, 1.0]], [1, [0.35402949564365105, 1.0]], [1, [1.2615030245486167, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.4543708]
bas 2, expnt(s) = [833.27297358]
bas 3, expnt(s) = [235.71545236]
bas 4, expnt(s) = [76.52322615]
bas 5, expnt(s) = [9.6911866]
bas 6, expnt(s) = [27.03491286]
bas 7, expnt(s) = [0.35651857]
bas 8, expnt(s) = [0.99820734]
bas 9, expnt(s) = [2.54767987]
bas 10, expnt(s) = [4.19531335]
bas 11, expnt(s) = [15.00548467]
bas 12, expnt(s) = [71.54652246]
bas 13, expnt(s) = [0.3540295]
bas 14, expnt(s) = [1.26150302]
CPU time:       150.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272974e+02 3.91837048e+02 2.35715452e+02 1.51986868e+02
 7.65232261e+01 6.53672143e+01 9.69118660e+00 1.38770688e+01
 2.70349129e+01 2.99542710e+01 3.56518571e-01 1.16567274e+00
 9.98207336e-01 2.52307751e+00 2.54767987e+00 5.09475925e+00
 4.19531335e+00 1.75162001e+01 1.50054847e+01 8.61582615e+01
 7.15465225e+01 6.07043837e+02 3.54029496e-01 7.96679607e-01
 1.26150302e+00 3.90027081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997693177673508
cond(S) = 302.45478036088747
E1 = -183.57487227606396  E_coul = 55.07771060129091
init E= -128.497161674773
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773771098737998  LUMO = 1.07641201895191
  mo_energy =
[-3.25551544e+01 -1.85288963e+00 -7.73771099e-01 -7.73771099e-01
 -7.73771099e-01  1.07641202e+00  1.22806405e+00  1.22806405e+00
  1.22806405e+00  6.42575818e+00  6.51639074e+00  6.51639074e+00
  6.51639074e+00  2.88762488e+01  2.88762488e+01  2.88762488e+01
  3.22986634e+01  1.35822779e+02  1.55525739e+02  1.55525739e+02
  1.55525739e+02  5.00148074e+02  1.86811951e+03  7.99810311e+03
  4.77661472e+04]
E1 = -182.14648502070594  E_coul = 53.619455949780374
cycle= 1 E= -128.527029070926  delta_E= -0.0299  |g|= 0.197  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430513
diis-c [-0.18534131  1.        ]
  HOMO = -0.876407162206164  LUMO = 1.0403657292134
  mo_energy =
[-3.28672699e+01 -1.95968722e+00 -8.76407162e-01 -8.76407162e-01
 -8.76407162e-01  1.04036573e+00  1.18667380e+00  1.18667380e+00
  1.18667380e+00  6.31099427e+00  6.37975969e+00  6.37975969e+00
  6.37975969e+00  2.86324790e+01  2.86324790e+01  2.86324790e+01
  3.20640828e+01  1.35515434e+02  1.55200740e+02  1.55200740e+02
  1.55200740e+02  4.99797151e+02  1.86773266e+03  7.99768732e+03
  4.77657125e+04]
E1 = -182.85422462574473  E_coul = 54.32479336574508
cycle= 2 E= -128.52943126  delta_E= -0.0024  |g|= 0.0968  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.212034
diis-c [-5.81442942e-04  3.28898821e-01  6.71101179e-01]
  HOMO = -0.843090826999026  LUMO = 1.05216418448805
  mo_energy =
[-3.27650146e+01 -1.92468170e+00 -8.43090827e-01 -8.43090827e-01
 -8.43090827e-01  1.05216418e+00  1.20026392e+00  1.20026392e+00
  1.20026392e+00  6.34830112e+00  6.42418403e+00  6.42418403e+00
  6.42418403e+00  2.87125977e+01  2.87125977e+01  2.87125977e+01
  3.21413860e+01  1.35615887e+02  1.55305865e+02  1.55305865e+02
  1.55305865e+02  4.99907924e+02  1.86784847e+03  7.99780549e+03
  4.77658315e+04]
E1 = -182.6183757495223  E_coul = 54.08815513252899
cycle= 3 E= -128.530220616993  delta_E= -0.000789  |g|= 0.000549  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116182
diis-c [-1.54148593e-07 -2.31299336e-03  4.76461891e-04  1.00183653e+00]
  HOMO = -0.843350889875972  LUMO = 1.05211353087738
  mo_energy =
[-3.27655123e+01 -1.92486819e+00 -8.43350890e-01 -8.43350890e-01
 -8.43350890e-01  1.05211353e+00  1.20019643e+00  1.20019643e+00
  1.20019643e+00  6.34809395e+00  6.42392721e+00  6.42392721e+00
  6.42392721e+00  2.87121907e+01  2.87121907e+01  2.87121907e+01
  3.21410024e+01  1.35615389e+02  1.55305331e+02  1.55305331e+02
  1.55305331e+02  4.99907311e+02  1.86784773e+03  7.99780466e+03
  4.77658307e+04]
E1 = -182.6191665053008  E_coul = 54.088945860606884
cycle= 4 E= -128.530220644694  delta_E= -2.77e-08  |g|= 6.92e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000146351
diis-c [-8.73718757e-10  3.70794051e-04  3.14876602e-04 -2.24139827e-01
  1.22345416e+00]
  HOMO = -0.843382289642943  LUMO = 1.05210719974
  mo_energy =
[-3.27655679e+01 -1.92488414e+00 -8.43382290e-01 -8.43382290e-01
 -8.43382290e-01  1.05210720e+00  1.20018261e+00  1.20018261e+00
  1.20018261e+00  6.34806719e+00  6.42389054e+00  6.42389054e+00
  6.42389054e+00  2.87121414e+01  2.87121414e+01  2.87121414e+01
  3.21409561e+01  1.35615333e+02  1.55305272e+02  1.55305272e+02
  1.55305272e+02  4.99907244e+02  1.86784766e+03  7.99780458e+03
  4.77658306e+04]
E1 = -182.61928659461412  E_coul = 54.089065949251946
cycle= 5 E= -128.530220645362  delta_E= -6.68e-10  |g|= 6.22e-06  |ddm|= 4.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61928659461412  E_coul = 54.089065949251946
  HOMO = -0.843378870147967  LUMO = 1.05210897041635
  mo_energy =
[-3.27655607e+01 -1.92488008e+00 -8.43378870e-01 -8.43378870e-01
 -8.43378870e-01  1.05210897e+00  1.20018419e+00  1.20018419e+00
  1.20018419e+00  6.34807143e+00  6.42389495e+00  6.42389495e+00
  6.42389495e+00  2.87121480e+01  2.87121480e+01  2.87121480e+01
  3.21409626e+01  1.35615340e+02  1.55305279e+02  1.55305279e+02
  1.55305279e+02  4.99907251e+02  1.86784766e+03  7.99780459e+03
  4.77658306e+04]
E1 = -182.6192705776679  E_coul = 54.08904993230314
Extra cycle  E= -128.530220645365  delta_E= -2.56e-12  |g|= 2.24e-06  |ddm|= 1.98e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272974e+02 2.35715452e+02
 7.65232261e+01 9.69118660e+00 2.70349129e+01 3.56518571e-01
 9.98207336e-01 2.54767987e+00 4.19531335e+00 1.50054847e+01
 7.15465225e+01 3.54029496e-01 1.26150302e+00]
E = -128.53022064536475
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.4543708         1
[INPUT] 0    0    [1    /1   ]  833.272973579        1
[INPUT] 0    0    [1    /1   ]  235.715452359        1
[INPUT] 0    0    [1    /1   ]  76.5232261456        1
[INPUT] 0    0    [1    /1   ]  9.69118659912        1
[INPUT] 0    0    [1    /1   ]  27.0349128644        1
[INPUT] 0    0    [1    /1   ]  0.356518570684       1
[INPUT] 0    0    [1    /1   ]  0.998207335803       1
[INPUT] 0    0    [1    /1   ]  2.54767987119        1
[INPUT] 1    0    [1    /1   ]  4.19531334895        1
[INPUT] 1    0    [1    /1   ]  15.0054846724        1
[INPUT] 1    0    [1    /1   ]  71.5465224586        1
[INPUT] 1    0    [1    /1   ]  0.354029495644       1
[INPUT] 1    0    [1    /1   ]  1.26150302455        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.7941318915, 1.0]], [0, [3661.4543707955695, 1.0]], [0, [833.2729735789529, 1.0]], [0, [235.7154523588596, 1.0]], [0, [76.52322614559682, 1.0]], [0, [9.691186599121021, 1.0]], [0, [27.03491286444415, 1.0]], [0, [0.3565185706835687, 1.0]], [0, [0.99820733580297, 1.0]], [0, [2.5476798711890964, 1.0]], [1, [4.195313348951029, 1.0]], [1, [15.005484672399346, 1.0]], [1, [71.5465224585684, 1.0]], [1, [0.35402949564365105, 1.0]], [1, [1.2615030245486167, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.4543708]
bas 2, expnt(s) = [833.27297358]
bas 3, expnt(s) = [235.71545236]
bas 4, expnt(s) = [76.52322615]
bas 5, expnt(s) = [9.6911866]
bas 6, expnt(s) = [27.03491286]
bas 7, expnt(s) = [0.35651857]
bas 8, expnt(s) = [0.99820734]
bas 9, expnt(s) = [2.54767987]
bas 10, expnt(s) = [4.19531335]
bas 11, expnt(s) = [15.00548467]
bas 12, expnt(s) = [71.54652246]
bas 13, expnt(s) = [0.3540295]
bas 14, expnt(s) = [1.26150302]
CPU time:       151.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272974e+02 3.91837048e+02 2.35715452e+02 1.51986868e+02
 7.65232261e+01 6.53672143e+01 9.69118660e+00 1.38770688e+01
 2.70349129e+01 2.99542710e+01 3.56518571e-01 1.16567274e+00
 9.98207336e-01 2.52307751e+00 2.54767987e+00 5.09475925e+00
 4.19531335e+00 1.75162001e+01 1.50054847e+01 8.61582615e+01
 7.15465225e+01 6.07043837e+02 3.54029496e-01 7.96679607e-01
 1.26150302e+00 3.90027081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997693177673508
cond(S) = 302.45478036088747
E1 = -183.57487227606396  E_coul = 55.07771060129091
init E= -128.497161674773
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773771098737998  LUMO = 1.07641201895191
  mo_energy =
[-3.25551544e+01 -1.85288963e+00 -7.73771099e-01 -7.73771099e-01
 -7.73771099e-01  1.07641202e+00  1.22806405e+00  1.22806405e+00
  1.22806405e+00  6.42575818e+00  6.51639074e+00  6.51639074e+00
  6.51639074e+00  2.88762488e+01  2.88762488e+01  2.88762488e+01
  3.22986634e+01  1.35822779e+02  1.55525739e+02  1.55525739e+02
  1.55525739e+02  5.00148074e+02  1.86811951e+03  7.99810311e+03
  4.77661472e+04]
E1 = -182.14648502070594  E_coul = 53.619455949780374
cycle= 1 E= -128.527029070926  delta_E= -0.0299  |g|= 0.197  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430513
diis-c [-0.18534131  1.        ]
  HOMO = -0.876407162206164  LUMO = 1.0403657292134
  mo_energy =
[-3.28672699e+01 -1.95968722e+00 -8.76407162e-01 -8.76407162e-01
 -8.76407162e-01  1.04036573e+00  1.18667380e+00  1.18667380e+00
  1.18667380e+00  6.31099427e+00  6.37975969e+00  6.37975969e+00
  6.37975969e+00  2.86324790e+01  2.86324790e+01  2.86324790e+01
  3.20640828e+01  1.35515434e+02  1.55200740e+02  1.55200740e+02
  1.55200740e+02  4.99797151e+02  1.86773266e+03  7.99768732e+03
  4.77657125e+04]
E1 = -182.85422462574473  E_coul = 54.32479336574508
cycle= 2 E= -128.52943126  delta_E= -0.0024  |g|= 0.0968  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.212034
diis-c [-5.81442942e-04  3.28898821e-01  6.71101179e-01]
  HOMO = -0.843090826999026  LUMO = 1.05216418448805
  mo_energy =
[-3.27650146e+01 -1.92468170e+00 -8.43090827e-01 -8.43090827e-01
 -8.43090827e-01  1.05216418e+00  1.20026392e+00  1.20026392e+00
  1.20026392e+00  6.34830112e+00  6.42418403e+00  6.42418403e+00
  6.42418403e+00  2.87125977e+01  2.87125977e+01  2.87125977e+01
  3.21413860e+01  1.35615887e+02  1.55305865e+02  1.55305865e+02
  1.55305865e+02  4.99907924e+02  1.86784847e+03  7.99780549e+03
  4.77658315e+04]
E1 = -182.6183757495223  E_coul = 54.08815513252899
cycle= 3 E= -128.530220616993  delta_E= -0.000789  |g|= 0.000549  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116182
diis-c [-1.54148593e-07 -2.31299336e-03  4.76461891e-04  1.00183653e+00]
  HOMO = -0.843350889875972  LUMO = 1.05211353087738
  mo_energy =
[-3.27655123e+01 -1.92486819e+00 -8.43350890e-01 -8.43350890e-01
 -8.43350890e-01  1.05211353e+00  1.20019643e+00  1.20019643e+00
  1.20019643e+00  6.34809395e+00  6.42392721e+00  6.42392721e+00
  6.42392721e+00  2.87121907e+01  2.87121907e+01  2.87121907e+01
  3.21410024e+01  1.35615389e+02  1.55305331e+02  1.55305331e+02
  1.55305331e+02  4.99907311e+02  1.86784773e+03  7.99780466e+03
  4.77658307e+04]
E1 = -182.6191665053008  E_coul = 54.088945860606884
cycle= 4 E= -128.530220644694  delta_E= -2.77e-08  |g|= 6.92e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000146351
diis-c [-8.73718757e-10  3.70794051e-04  3.14876602e-04 -2.24139827e-01
  1.22345416e+00]
  HOMO = -0.843382289642943  LUMO = 1.05210719974
  mo_energy =
[-3.27655679e+01 -1.92488414e+00 -8.43382290e-01 -8.43382290e-01
 -8.43382290e-01  1.05210720e+00  1.20018261e+00  1.20018261e+00
  1.20018261e+00  6.34806719e+00  6.42389054e+00  6.42389054e+00
  6.42389054e+00  2.87121414e+01  2.87121414e+01  2.87121414e+01
  3.21409561e+01  1.35615333e+02  1.55305272e+02  1.55305272e+02
  1.55305272e+02  4.99907244e+02  1.86784766e+03  7.99780458e+03
  4.77658306e+04]
E1 = -182.61928659461412  E_coul = 54.089065949251946
cycle= 5 E= -128.530220645362  delta_E= -6.68e-10  |g|= 6.22e-06  |ddm|= 4.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61928659461412  E_coul = 54.089065949251946
  HOMO = -0.843378870147967  LUMO = 1.05210897041635
  mo_energy =
[-3.27655607e+01 -1.92488008e+00 -8.43378870e-01 -8.43378870e-01
 -8.43378870e-01  1.05210897e+00  1.20018419e+00  1.20018419e+00
  1.20018419e+00  6.34807143e+00  6.42389495e+00  6.42389495e+00
  6.42389495e+00  2.87121480e+01  2.87121480e+01  2.87121480e+01
  3.21409626e+01  1.35615340e+02  1.55305279e+02  1.55305279e+02
  1.55305279e+02  4.99907251e+02  1.86784766e+03  7.99780459e+03
  4.77658306e+04]
E1 = -182.6192705776679  E_coul = 54.08904993230314
Extra cycle  E= -128.530220645365  delta_E= -2.56e-12  |g|= 2.24e-06  |ddm|= 1.98e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 302.45478036088747
E1 = -182.6192705776679  E_coul = 54.08904993230314
init E= -128.530220645365
    CPU time for initialize scf      0.21 sec, wall time      0.20 sec
  HOMO = -0.843379987842067  LUMO = 1.05210864606143
  mo_energy =
[-3.27655642e+01 -1.92488115e+00 -8.43379988e-01 -8.43379988e-01
 -8.43379988e-01  1.05210865e+00  1.20018375e+00  1.20018375e+00
  1.20018375e+00  6.34807024e+00  6.42389346e+00  6.42389346e+00
  6.42389346e+00  2.87121452e+01  2.87121452e+01  2.87121452e+01
  3.21409600e+01  1.35615336e+02  1.55305276e+02  1.55305276e+02
  1.55305276e+02  4.99907247e+02  1.86784766e+03  7.99780458e+03
  4.77658306e+04]
E1 = -182.6192790589806  E_coul = 54.089058413615575
cycle= 1 E= -128.530220645365  delta_E= -2.84e-13  |g|= 1.16e-06  |ddm|= 8.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6192790589806  E_coul = 54.089058413615575
  HOMO = -0.843379392820627  LUMO = 1.05210886875483
  mo_energy =
[-3.27655624e+01 -1.92488050e+00 -8.43379393e-01 -8.43379393e-01
 -8.43379393e-01  1.05210887e+00  1.20018399e+00  1.20018399e+00
  1.20018399e+00  6.34807092e+00  6.42389425e+00  6.42389425e+00
  6.42389425e+00  2.87121466e+01  2.87121466e+01  2.87121466e+01
  3.21409613e+01  1.35615338e+02  1.55305277e+02  1.55305277e+02
  1.55305277e+02  4.99907249e+02  1.86784766e+03  7.99780458e+03
  4.77658306e+04]
E1 = -182.6192748795744  E_coul = 54.0890542342093
Extra cycle  E= -128.530220645365  delta_E= -5.68e-14  |g|= 5.69e-07  |ddm|= 4.29e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272974e+02 2.35715452e+02
 7.65232261e+01 9.69118660e+00 2.70349129e+01 3.56518571e-01
 9.98207336e-01 2.54767987e+00 4.19531335e+00 1.50054847e+01
 7.15465225e+01 3.54029496e-01 1.26150302e+00]
grad_E = [-1.68491869e-09  8.92064618e-08 -1.80636661e-06  2.26924421e-05
 -1.89466646e-04 -1.99415754e-03  1.01773038e-03  5.59260425e-04
 -6.36464757e-05 -2.30989557e-05 -6.52148845e-04  4.74324104e-04
  8.38427637e-05  6.54848697e-03 -1.40222621e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437182        1
[INPUT] 0    0    [1    /1   ]  833.272953333        1
[INPUT] 0    0    [1    /1   ]  235.7156934          1
[INPUT] 0    0    [1    /1   ]  76.5215206097        1
[INPUT] 0    0    [1    /1   ]  9.69205408286        1
[INPUT] 0    0    [1    /1   ]  27.0414021915        1
[INPUT] 0    0    [1    /1   ]  0.370759511887       1
[INPUT] 0    0    [1    /1   ]  1.04514513387        1
[INPUT] 0    0    [1    /1   ]  2.52364197072        1
[INPUT] 1    0    [1    /1   ]  4.15638288253        1
[INPUT] 1    0    [1    /1   ]  14.8035117681        1
[INPUT] 1    0    [1    /1   ]  70.5696392506        1
[INPUT] 1    0    [1    /1   ]  0.353676538951       1
[INPUT] 1    0    [1    /1   ]  1.25540923043        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131872994, 1.0]], [0, [3661.454371819414, 1.0]], [0, [833.2729533333946, 1.0]], [0, [235.7156934004309, 1.0]], [0, [76.52152060967322, 1.0]], [0, [9.692054082863132, 1.0]], [0, [27.04140219149084, 1.0]], [0, [0.3707595118865845, 1.0]], [0, [1.0451451338653541, 1.0]], [0, [2.523641970718957, 1.0]], [1, [4.1563828825336735, 1.0]], [1, [14.803511768116943, 1.0]], [1, [70.5696392506423, 1.0]], [1, [0.35367653895146217, 1.0]], [1, [1.2554092304257125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413187]
bas 1, expnt(s) = [3661.45437182]
bas 2, expnt(s) = [833.27295333]
bas 3, expnt(s) = [235.7156934]
bas 4, expnt(s) = [76.52152061]
bas 5, expnt(s) = [9.69205408]
bas 6, expnt(s) = [27.04140219]
bas 7, expnt(s) = [0.37075951]
bas 8, expnt(s) = [1.04514513]
bas 9, expnt(s) = [2.52364197]
bas 10, expnt(s) = [4.15638288]
bas 11, expnt(s) = [14.80351177]
bas 12, expnt(s) = [70.56963925]
bas 13, expnt(s) = [0.35367654]
bas 14, expnt(s) = [1.25540923]
CPU time:       154.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272953e+02 3.91837041e+02 2.35715693e+02 1.51986984e+02
 7.65215206e+01 6.53661217e+01 9.69205408e+00 1.38780004e+01
 2.70414022e+01 2.99596634e+01 3.70759512e-01 1.20042284e+00
 1.04514513e+00 2.61154478e+00 2.52364197e+00 5.05866396e+00
 4.15638288e+00 1.73132590e+01 1.48035118e+01 8.47111025e+01
 7.05696393e+01 5.96700998e+02 3.53676539e-01 7.95686899e-01
 1.25540923e+00 3.87673432e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997703988161312
cond(S) = 315.45857685120814
E1 = -183.57439105083765  E_coul = 55.077493923100164
init E= -128.496897127737
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773798748928242  LUMO = 1.1371649881977
  mo_energy =
[-3.25552517e+01 -1.85283541e+00 -7.73798749e-01 -7.73798749e-01
 -7.73798749e-01  1.13716499e+00  1.22488436e+00  1.22488436e+00
  1.22488436e+00  6.47305640e+00  6.47305640e+00  6.47305640e+00
  6.60101977e+00  2.85187855e+01  2.85187855e+01  2.85187855e+01
  3.24765988e+01  1.35981847e+02  1.53179424e+02  1.53179424e+02
  1.53179424e+02  5.00294065e+02  1.86825057e+03  7.99821838e+03
  4.77662426e+04]
E1 = -182.14776601958616  E_coul = 53.62066471184735
cycle= 1 E= -128.527101307739  delta_E= -0.0302  |g|= 0.197  |ddm|= 0.174
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430225
diis-c [-0.18509392  1.        ]
  HOMO = -0.876314090640206  LUMO = 1.09941171966368
  mo_energy =
[-3.28671581e+01 -1.95950254e+00 -8.76314091e-01 -8.76314091e-01
 -8.76314091e-01  1.09941172e+00  1.18371826e+00  1.18371826e+00
  1.18371826e+00  6.33739176e+00  6.33739176e+00  6.33739176e+00
  6.48575375e+00  2.82762053e+01  2.82762053e+01  2.82762053e+01
  3.22425056e+01  1.35674742e+02  1.52855142e+02  1.52855142e+02
  1.52855142e+02  4.99943306e+02  1.86786381e+03  7.99780267e+03
  4.77658079e+04]
E1 = -182.85416780573905  E_coul = 54.324671103380744
cycle= 2 E= -128.529496702358  delta_E= -0.0024  |g|= 0.0966  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.211801
diis-c [-5.78853099e-04  3.28805779e-01  6.71194221e-01]
  HOMO = -0.843059488505605  LUMO = 1.11174042770712
  mo_energy =
[-3.27650731e+01 -1.92455714e+00 -8.43059489e-01 -8.43059489e-01
 -8.43059489e-01  1.11174043e+00  1.19721819e+00  1.19721819e+00
  1.19721819e+00  6.38147959e+00  6.38147959e+00  6.38147959e+00
  6.52319445e+00  2.83558515e+01  2.83558515e+01  2.83558515e+01
  3.23196088e+01  1.35775010e+02  1.52959958e+02  1.52959958e+02
  1.52959958e+02  5.00053892e+02  1.86797943e+03  7.99792064e+03
  4.77659268e+04]
E1 = -182.61870273500946  E_coul = 54.08841935324118
cycle= 3 E= -128.530283381768  delta_E= -0.000787  |g|= 0.000569  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118552
diis-c [-1.54153049e-07 -2.33395664e-03  5.57092444e-04  1.00177686e+00]
  HOMO = -0.843328196552868  LUMO = 1.11168276012487
  mo_energy =
[-3.27655834e+01 -1.92475122e+00 -8.43328197e-01 -8.43328197e-01
 -8.43328197e-01  1.11168276e+00  1.19714680e+00  1.19714680e+00
  1.19714680e+00  6.38121457e+00  6.38121457e+00  6.38121457e+00
  6.52297501e+00  2.83554331e+01  2.83554331e+01  2.83554331e+01
  3.23192137e+01  1.35774500e+02  1.52959414e+02  1.52959414e+02
  1.52959414e+02  5.00053267e+02  1.86797868e+03  7.99791981e+03
  4.77659259e+04]
E1 = -182.61951212990186  E_coul = 54.08922871865528
cycle= 4 E= -128.530283411247  delta_E= -2.95e-08  |g|= 7.06e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148235
diis-c [-8.94779279e-10  3.71314257e-04  3.02060692e-04 -2.24006535e-01
  1.22333316e+00]
  HOMO = -0.843360334081943  LUMO = 1.11167584363687
  mo_energy =
[-3.27656397e+01 -1.92476765e+00 -8.43360334e-01 -8.43360334e-01
 -8.43360334e-01  1.11167584e+00  1.19713272e+00  1.19713272e+00
  1.19713272e+00  6.38117727e+00  6.38117727e+00  6.38117727e+00
  6.52294716e+00  2.83553832e+01  2.83553832e+01  2.83553832e+01
  3.23191666e+01  1.35774443e+02  1.52959354e+02  1.52959354e+02
  1.52959354e+02  5.00053199e+02  1.86797861e+03  7.99791972e+03
  4.77659258e+04]
E1 = -182.61963351919965  E_coul = 54.089350107261524
cycle= 5 E= -128.530283411938  delta_E= -6.92e-10  |g|= 6.32e-06  |ddm|= 5.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61963351919965  E_coul = 54.089350107261524
  HOMO = -0.843356871235275  LUMO = 1.111677721498
  mo_energy =
[-3.27656325e+01 -1.92476355e+00 -8.43356871e-01 -8.43356871e-01
 -8.43356871e-01  1.11167772e+00  1.19713432e+00  1.19713432e+00
  1.19713432e+00  6.38118170e+00  6.38118170e+00  6.38118170e+00
  6.52295147e+00  2.83553897e+01  2.83553897e+01  2.83553897e+01
  3.23191731e+01  1.35774451e+02  1.52959362e+02  1.52959362e+02
  1.52959362e+02  5.00053206e+02  1.86797861e+03  7.99791973e+03
  4.77659258e+04]
E1 = -182.61961775068883  E_coul = 54.08933433874858
Extra cycle  E= -128.53028341194  delta_E= -2.13e-12  |g|= 2.21e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272953e+02 2.35715693e+02
 7.65215206e+01 9.69205408e+00 2.70414022e+01 3.70759512e-01
 1.04514513e+00 2.52364197e+00 4.15638288e+00 1.48035118e+01
 7.05696393e+01 3.53676539e-01 1.25540923e+00]
E = -128.53028341194025
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437182        1
[INPUT] 0    0    [1    /1   ]  833.272953333        1
[INPUT] 0    0    [1    /1   ]  235.7156934          1
[INPUT] 0    0    [1    /1   ]  76.5215206097        1
[INPUT] 0    0    [1    /1   ]  9.69205408286        1
[INPUT] 0    0    [1    /1   ]  27.0414021915        1
[INPUT] 0    0    [1    /1   ]  0.370759511887       1
[INPUT] 0    0    [1    /1   ]  1.04514513387        1
[INPUT] 0    0    [1    /1   ]  2.52364197072        1
[INPUT] 1    0    [1    /1   ]  4.15638288253        1
[INPUT] 1    0    [1    /1   ]  14.8035117681        1
[INPUT] 1    0    [1    /1   ]  70.5696392506        1
[INPUT] 1    0    [1    /1   ]  0.353676538951       1
[INPUT] 1    0    [1    /1   ]  1.25540923043        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131872994, 1.0]], [0, [3661.454371819414, 1.0]], [0, [833.2729533333946, 1.0]], [0, [235.7156934004309, 1.0]], [0, [76.52152060967322, 1.0]], [0, [9.692054082863132, 1.0]], [0, [27.04140219149084, 1.0]], [0, [0.3707595118865845, 1.0]], [0, [1.0451451338653541, 1.0]], [0, [2.523641970718957, 1.0]], [1, [4.1563828825336735, 1.0]], [1, [14.803511768116943, 1.0]], [1, [70.5696392506423, 1.0]], [1, [0.35367653895146217, 1.0]], [1, [1.2554092304257125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413187]
bas 1, expnt(s) = [3661.45437182]
bas 2, expnt(s) = [833.27295333]
bas 3, expnt(s) = [235.7156934]
bas 4, expnt(s) = [76.52152061]
bas 5, expnt(s) = [9.69205408]
bas 6, expnt(s) = [27.04140219]
bas 7, expnt(s) = [0.37075951]
bas 8, expnt(s) = [1.04514513]
bas 9, expnt(s) = [2.52364197]
bas 10, expnt(s) = [4.15638288]
bas 11, expnt(s) = [14.80351177]
bas 12, expnt(s) = [70.56963925]
bas 13, expnt(s) = [0.35367654]
bas 14, expnt(s) = [1.25540923]
CPU time:       155.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272953e+02 3.91837041e+02 2.35715693e+02 1.51986984e+02
 7.65215206e+01 6.53661217e+01 9.69205408e+00 1.38780004e+01
 2.70414022e+01 2.99596634e+01 3.70759512e-01 1.20042284e+00
 1.04514513e+00 2.61154478e+00 2.52364197e+00 5.05866396e+00
 4.15638288e+00 1.73132590e+01 1.48035118e+01 8.47111025e+01
 7.05696393e+01 5.96700998e+02 3.53676539e-01 7.95686899e-01
 1.25540923e+00 3.87673432e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997703988161312
cond(S) = 315.45857685120814
E1 = -183.57439105083765  E_coul = 55.077493923100164
init E= -128.496897127737
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773798748928242  LUMO = 1.1371649881977
  mo_energy =
[-3.25552517e+01 -1.85283541e+00 -7.73798749e-01 -7.73798749e-01
 -7.73798749e-01  1.13716499e+00  1.22488436e+00  1.22488436e+00
  1.22488436e+00  6.47305640e+00  6.47305640e+00  6.47305640e+00
  6.60101977e+00  2.85187855e+01  2.85187855e+01  2.85187855e+01
  3.24765988e+01  1.35981847e+02  1.53179424e+02  1.53179424e+02
  1.53179424e+02  5.00294065e+02  1.86825057e+03  7.99821838e+03
  4.77662426e+04]
E1 = -182.14776601958616  E_coul = 53.62066471184735
cycle= 1 E= -128.527101307739  delta_E= -0.0302  |g|= 0.197  |ddm|= 0.174
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.430225
diis-c [-0.18509392  1.        ]
  HOMO = -0.876314090640206  LUMO = 1.09941171966368
  mo_energy =
[-3.28671581e+01 -1.95950254e+00 -8.76314091e-01 -8.76314091e-01
 -8.76314091e-01  1.09941172e+00  1.18371826e+00  1.18371826e+00
  1.18371826e+00  6.33739176e+00  6.33739176e+00  6.33739176e+00
  6.48575375e+00  2.82762053e+01  2.82762053e+01  2.82762053e+01
  3.22425056e+01  1.35674742e+02  1.52855142e+02  1.52855142e+02
  1.52855142e+02  4.99943306e+02  1.86786381e+03  7.99780267e+03
  4.77658079e+04]
E1 = -182.85416780573905  E_coul = 54.324671103380744
cycle= 2 E= -128.529496702358  delta_E= -0.0024  |g|= 0.0966  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.211801
diis-c [-5.78853099e-04  3.28805779e-01  6.71194221e-01]
  HOMO = -0.843059488505605  LUMO = 1.11174042770712
  mo_energy =
[-3.27650731e+01 -1.92455714e+00 -8.43059489e-01 -8.43059489e-01
 -8.43059489e-01  1.11174043e+00  1.19721819e+00  1.19721819e+00
  1.19721819e+00  6.38147959e+00  6.38147959e+00  6.38147959e+00
  6.52319445e+00  2.83558515e+01  2.83558515e+01  2.83558515e+01
  3.23196088e+01  1.35775010e+02  1.52959958e+02  1.52959958e+02
  1.52959958e+02  5.00053892e+02  1.86797943e+03  7.99792064e+03
  4.77659268e+04]
E1 = -182.61870273500946  E_coul = 54.08841935324118
cycle= 3 E= -128.530283381768  delta_E= -0.000787  |g|= 0.000569  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118552
diis-c [-1.54153049e-07 -2.33395664e-03  5.57092444e-04  1.00177686e+00]
  HOMO = -0.843328196552868  LUMO = 1.11168276012487
  mo_energy =
[-3.27655834e+01 -1.92475122e+00 -8.43328197e-01 -8.43328197e-01
 -8.43328197e-01  1.11168276e+00  1.19714680e+00  1.19714680e+00
  1.19714680e+00  6.38121457e+00  6.38121457e+00  6.38121457e+00
  6.52297501e+00  2.83554331e+01  2.83554331e+01  2.83554331e+01
  3.23192137e+01  1.35774500e+02  1.52959414e+02  1.52959414e+02
  1.52959414e+02  5.00053267e+02  1.86797868e+03  7.99791981e+03
  4.77659259e+04]
E1 = -182.61951212990186  E_coul = 54.08922871865528
cycle= 4 E= -128.530283411247  delta_E= -2.95e-08  |g|= 7.06e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148235
diis-c [-8.94779279e-10  3.71314257e-04  3.02060692e-04 -2.24006535e-01
  1.22333316e+00]
  HOMO = -0.843360334081943  LUMO = 1.11167584363687
  mo_energy =
[-3.27656397e+01 -1.92476765e+00 -8.43360334e-01 -8.43360334e-01
 -8.43360334e-01  1.11167584e+00  1.19713272e+00  1.19713272e+00
  1.19713272e+00  6.38117727e+00  6.38117727e+00  6.38117727e+00
  6.52294716e+00  2.83553832e+01  2.83553832e+01  2.83553832e+01
  3.23191666e+01  1.35774443e+02  1.52959354e+02  1.52959354e+02
  1.52959354e+02  5.00053199e+02  1.86797861e+03  7.99791972e+03
  4.77659258e+04]
E1 = -182.61963351919965  E_coul = 54.089350107261524
cycle= 5 E= -128.530283411938  delta_E= -6.92e-10  |g|= 6.32e-06  |ddm|= 5.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61963351919965  E_coul = 54.089350107261524
  HOMO = -0.843356871235275  LUMO = 1.111677721498
  mo_energy =
[-3.27656325e+01 -1.92476355e+00 -8.43356871e-01 -8.43356871e-01
 -8.43356871e-01  1.11167772e+00  1.19713432e+00  1.19713432e+00
  1.19713432e+00  6.38118170e+00  6.38118170e+00  6.38118170e+00
  6.52295147e+00  2.83553897e+01  2.83553897e+01  2.83553897e+01
  3.23191731e+01  1.35774451e+02  1.52959362e+02  1.52959362e+02
  1.52959362e+02  5.00053206e+02  1.86797861e+03  7.99791973e+03
  4.77659258e+04]
E1 = -182.61961775068883  E_coul = 54.08933433874858
Extra cycle  E= -128.53028341194  delta_E= -2.13e-12  |g|= 2.21e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 315.45857685120814
E1 = -182.61961775068883  E_coul = 54.08933433874858
init E= -128.53028341194
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.843357968734101  LUMO = 1.11167738981513
  mo_energy =
[-3.27656360e+01 -1.92476460e+00 -8.43357969e-01 -8.43357969e-01
 -8.43357969e-01  1.11167739e+00  1.19713389e+00  1.19713389e+00
  1.19713389e+00  6.38118024e+00  6.38118024e+00  6.38118024e+00
  6.52295030e+00  2.83553870e+01  2.83553870e+01  2.83553870e+01
  3.23191705e+01  1.35774447e+02  1.52959358e+02  1.52959358e+02
  1.52959358e+02  5.00053202e+02  1.86797861e+03  7.99791972e+03
  4.77659258e+04]
E1 = -182.61962614533383  E_coul = 54.0893427333933
cycle= 1 E= -128.530283411941  delta_E= -2.84e-13  |g|= 1.15e-06  |ddm|= 8.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61962614533383  E_coul = 54.0893427333933
  HOMO = -0.843357379487875  LUMO = 1.11167762078152
  mo_energy =
[-3.27656342e+01 -1.92476396e+00 -8.43357379e-01 -8.43357379e-01
 -8.43357379e-01  1.11167762e+00  1.19713413e+00  1.19713413e+00
  1.19713413e+00  6.38118102e+00  6.38118102e+00  6.38118102e+00
  6.52295098e+00  2.83553884e+01  2.83553884e+01  2.83553884e+01
  3.23191719e+01  1.35774449e+02  1.52959360e+02  1.52959360e+02
  1.52959360e+02  5.00053204e+02  1.86797861e+03  7.99791973e+03
  4.77659258e+04]
E1 = -182.61962201364875  E_coul = 54.08933860170787
Extra cycle  E= -128.530283411941  delta_E= -3.41e-13  |g|= 5.63e-07  |ddm|= 4.23e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272953e+02 2.35715693e+02
 7.65215206e+01 9.69205408e+00 2.70414022e+01 3.70759512e-01
 1.04514513e+00 2.52364197e+00 4.15638288e+00 1.48035118e+01
 7.05696393e+01 3.53676539e-01 1.25540923e+00]
grad_E = [-1.80125339e-09  9.54250753e-08 -1.92773494e-06  2.41912460e-05
 -2.00715624e-04 -2.23912009e-03  1.08814568e-03 -3.47576701e-03
  3.24159148e-03 -8.71100624e-04 -7.79041150e-04  3.77378985e-04
  9.11252686e-05  9.50534112e-03 -1.20422888e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437174        1
[INPUT] 0    0    [1    /1   ]  833.272955028        1
[INPUT] 0    0    [1    /1   ]  235.715670462        1
[INPUT] 0    0    [1    /1   ]  76.5217451365        1
[INPUT] 0    0    [1    /1   ]  9.698137313          1
[INPUT] 0    0    [1    /1   ]  27.0397346131        1
[INPUT] 0    0    [1    /1   ]  0.372713679384       1
[INPUT] 0    0    [1    /1   ]  1.04855686717        1
[INPUT] 0    0    [1    /1   ]  2.51894528217        1
[INPUT] 1    0    [1    /1   ]  4.14775994388        1
[INPUT] 1    0    [1    /1   ]  14.7496467004        1
[INPUT] 1    0    [1    /1   ]  70.3994166488        1
[INPUT] 1    0    [1    /1   ]  0.350922092238       1
[INPUT] 1    0    [1    /1   ]  1.25121542004        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131874685, 1.0]], [0, [3661.4543717372712, 1.0]], [0, [833.27295502758, 1.0]], [0, [235.7156704617603, 1.0]], [0, [76.52174513651376, 1.0]], [0, [9.698137313001064, 1.0]], [0, [27.039734613081794, 1.0]], [0, [0.3727136793840864, 1.0]], [0, [1.0485568671685381, 1.0]], [0, [2.518945282172427, 1.0]], [1, [4.147759943876853, 1.0]], [1, [14.749646700412395, 1.0]], [1, [70.399416648785, 1.0]], [1, [0.3509220922384056, 1.0]], [1, [1.2512154200370955, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413187]
bas 1, expnt(s) = [3661.45437174]
bas 2, expnt(s) = [833.27295503]
bas 3, expnt(s) = [235.71567046]
bas 4, expnt(s) = [76.52174514]
bas 5, expnt(s) = [9.69813731]
bas 6, expnt(s) = [27.03973461]
bas 7, expnt(s) = [0.37271368]
bas 8, expnt(s) = [1.04855687]
bas 9, expnt(s) = [2.51894528]
bas 10, expnt(s) = [4.14775994]
bas 11, expnt(s) = [14.7496467]
bas 12, expnt(s) = [70.39941665]
bas 13, expnt(s) = [0.35092209]
bas 14, expnt(s) = [1.25121542]
CPU time:       158.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272955e+02 3.91837042e+02 2.35715670e+02 1.51986973e+02
 7.65217451e+01 6.53662655e+01 9.69813731e+00 1.38845328e+01
 2.70397346e+01 2.99582777e+01 3.72713679e-01 1.20516504e+00
 1.04855687e+00 2.61793594e+00 2.51894528e+00 5.05160139e+00
 4.14775994e+00 1.72683725e+01 1.47496467e+01 8.43259834e+01
 7.03994166e+01 5.94902396e+02 3.50922092e-01 7.87948404e-01
 1.25121542e+00 3.86055285e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997773067001958
cond(S) = 316.94968661267785
E1 = -183.5741828763441  E_coul = 55.077331739683196
init E= -128.496851136661
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773825916217746  LUMO = 1.14372664828465
  mo_energy =
[-3.25552822e+01 -1.85284824e+00 -7.73825916e-01 -7.73825916e-01
 -7.73825916e-01  1.14372665e+00  1.21494274e+00  1.21494274e+00
  1.21494274e+00  6.44596038e+00  6.44596038e+00  6.44596038e+00
  6.61417613e+00  2.84122266e+01  2.84122266e+01  2.84122266e+01
  3.24921001e+01  1.36001908e+02  1.52695047e+02  1.52695047e+02
  1.52695047e+02  5.00313080e+02  1.86826771e+03  7.99823348e+03
  4.77662551e+04]
E1 = -182.13905224314237  E_coul = 53.611937057880525
cycle= 1 E= -128.527115185262  delta_E= -0.0303  |g|= 0.198  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.432014
diis-c [-0.18663638  1.        ]
  HOMO = -0.877032895072569  LUMO = 1.10538013730681
  mo_energy =
[-3.28685811e+01 -1.96031903e+00 -8.77032895e-01 -8.77032895e-01
 -8.77032895e-01  1.10538014e+00  1.17371869e+00  1.17371869e+00
  1.17371869e+00  6.30958622e+00  6.30958622e+00  6.30958622e+00
  6.49809052e+00  2.81686558e+01  2.81686558e+01  2.81686558e+01
  3.22568060e+01  1.35693435e+02  1.52369450e+02  1.52369450e+02
  1.52369450e+02  4.99960891e+02  1.86787951e+03  7.99781631e+03
  4.77658190e+04]
E1 = -182.84988132639214  E_coul = 54.32035012369812
cycle= 2 E= -128.529531202694  delta_E= -0.00242  |g|= 0.0972  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.213093
diis-c [-5.80675234e-04  3.29243705e-01  6.70756295e-01]
  HOMO = -0.843586283746722  LUMO = 1.11784422893054
  mo_energy =
[-3.27659489e+01 -1.92516712e+00 -8.43586284e-01 -8.43586284e-01
 -8.43586284e-01  1.11784423e+00  1.18720909e+00  1.18720909e+00
  1.18720909e+00  6.35386613e+00  6.35386613e+00  6.35386613e+00
  6.53575019e+00  2.82486621e+01  2.82486621e+01  2.82486621e+01
  3.23343325e+01  1.35794239e+02  1.52474801e+02  1.52474801e+02
  1.52474801e+02  5.00072061e+02  1.86799573e+03  7.99793491e+03
  4.77659385e+04]
E1 = -182.61258972672493  E_coul = 54.082261027267755
cycle= 3 E= -128.530328699457  delta_E= -0.000797  |g|= 0.000571  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117974
diis-c [-1.37762819e-07 -2.33215989e-03  5.43367399e-04  1.00178879e+00]
  HOMO = -0.843860942353969  LUMO = 1.11777970830617
  mo_energy =
[-3.27664641e+01 -1.92537259e+00 -8.43860942e-01 -8.43860942e-01
 -8.43860942e-01  1.11777971e+00  1.18713536e+00  1.18713536e+00
  1.18713536e+00  6.35359410e+00  6.35359410e+00  6.35359410e+00
  6.53552176e+00  2.82482372e+01  2.82482372e+01  2.82482372e+01
  3.23339301e+01  1.35793725e+02  1.52474253e+02  1.52474253e+02
  1.52474253e+02  5.00071433e+02  1.86799498e+03  7.99793407e+03
  4.77659376e+04]
E1 = -182.61339802040703  E_coul = 54.083069292642776
cycle= 4 E= -128.530328727764  delta_E= -2.83e-08  |g|= 6.85e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143879
diis-c [-8.73631162e-10  3.49683345e-04  3.01596393e-04 -2.13041289e-01
  1.21239001e+00]
  HOMO = -0.843893172658522  LUMO = 1.11777178500967
  mo_energy =
[-3.27665202e+01 -1.92539068e+00 -8.43893173e-01 -8.43893173e-01
 -8.43893173e-01  1.11777179e+00  1.18712122e+00  1.18712122e+00
  1.18712122e+00  6.35355650e+00  6.35355650e+00  6.35355650e+00
  6.53549292e+00  2.82481871e+01  2.82481871e+01  2.82481871e+01
  3.23338826e+01  1.35793668e+02  1.52474194e+02  1.52474194e+02
  1.52474194e+02  5.00071367e+02  1.86799491e+03  7.99793399e+03
  4.77659375e+04]
E1 = -182.61351831209345  E_coul = 54.08318958371078
cycle= 5 E= -128.530328728383  delta_E= -6.18e-10  |g|= 6.19e-06  |ddm|= 4.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.61351831209345  E_coul = 54.08318958371078
  HOMO = -0.843889856650414  LUMO = 1.11777364433555
  mo_energy =
[-3.27665133e+01 -1.92538666e+00 -8.43889857e-01 -8.43889857e-01
 -8.43889857e-01  1.11777364e+00  1.18712275e+00  1.18712275e+00
  1.18712275e+00  6.35356075e+00  6.35356075e+00  6.35356075e+00
  6.53549710e+00  2.82481933e+01  2.82481933e+01  2.82481933e+01
  3.23338888e+01  1.35793675e+02  1.52474201e+02  1.52474201e+02
  1.52474201e+02  5.00071373e+02  1.86799491e+03  7.99793400e+03
  4.77659375e+04]
E1 = -182.61350324888483  E_coul = 54.08317452049999
Extra cycle  E= -128.530328728385  delta_E= -2.16e-12  |g|= 2.12e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272955e+02 2.35715670e+02
 7.65217451e+01 9.69813731e+00 2.70397346e+01 3.72713679e-01
 1.04855687e+00 2.51894528e+00 4.14775994e+00 1.47496467e+01
 7.03994166e+01 3.50922092e-01 1.25121542e+00]
E = -128.53032872838483
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437174        1
[INPUT] 0    0    [1    /1   ]  833.272955028        1
[INPUT] 0    0    [1    /1   ]  235.715670462        1
[INPUT] 0    0    [1    /1   ]  76.5217451365        1
[INPUT] 0    0    [1    /1   ]  9.698137313          1
[INPUT] 0    0    [1    /1   ]  27.0397346131        1
[INPUT] 0    0    [1    /1   ]  0.372713679384       1
[INPUT] 0    0    [1    /1   ]  1.04855686717        1
[INPUT] 0    0    [1    /1   ]  2.51894528217        1
[INPUT] 1    0    [1    /1   ]  4.14775994388        1
[INPUT] 1    0    [1    /1   ]  14.7496467004        1
[INPUT] 1    0    [1    /1   ]  70.3994166488        1
[INPUT] 1    0    [1    /1   ]  0.350922092238       1
[INPUT] 1    0    [1    /1   ]  1.25121542004        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131874685, 1.0]], [0, [3661.4543717372712, 1.0]], [0, [833.27295502758, 1.0]], [0, [235.7156704617603, 1.0]], [0, [76.52174513651376, 1.0]], [0, [9.698137313001064, 1.0]], [0, [27.039734613081794, 1.0]], [0, [0.3727136793840864, 1.0]], [0, [1.0485568671685381, 1.0]], [0, [2.518945282172427, 1.0]], [1, [4.147759943876853, 1.0]], [1, [14.749646700412395, 1.0]], [1, [70.399416648785, 1.0]], [1, [0.3509220922384056, 1.0]], [1, [1.2512154200370955, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413187]
bas 1, expnt(s) = [3661.45437174]
bas 2, expnt(s) = [833.27295503]
bas 3, expnt(s) = [235.71567046]
bas 4, expnt(s) = [76.52174514]
bas 5, expnt(s) = [9.69813731]
bas 6, expnt(s) = [27.03973461]
bas 7, expnt(s) = [0.37271368]
bas 8, expnt(s) = [1.04855687]
bas 9, expnt(s) = [2.51894528]
bas 10, expnt(s) = [4.14775994]
bas 11, expnt(s) = [14.7496467]
bas 12, expnt(s) = [70.39941665]
bas 13, expnt(s) = [0.35092209]
bas 14, expnt(s) = [1.25121542]
CPU time:       158.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272955e+02 3.91837042e+02 2.35715670e+02 1.51986973e+02
 7.65217451e+01 6.53662655e+01 9.69813731e+00 1.38845328e+01
 2.70397346e+01 2.99582777e+01 3.72713679e-01 1.20516504e+00
 1.04855687e+00 2.61793594e+00 2.51894528e+00 5.05160139e+00
 4.14775994e+00 1.72683725e+01 1.47496467e+01 8.43259834e+01
 7.03994166e+01 5.94902396e+02 3.50922092e-01 7.87948404e-01
 1.25121542e+00 3.86055285e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997773067001958
cond(S) = 316.94968661267785
E1 = -183.5741828763441  E_coul = 55.077331739683196
init E= -128.496851136661
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773825916217746  LUMO = 1.14372664828465
  mo_energy =
[-3.25552822e+01 -1.85284824e+00 -7.73825916e-01 -7.73825916e-01
 -7.73825916e-01  1.14372665e+00  1.21494274e+00  1.21494274e+00
  1.21494274e+00  6.44596038e+00  6.44596038e+00  6.44596038e+00
  6.61417613e+00  2.84122266e+01  2.84122266e+01  2.84122266e+01
  3.24921001e+01  1.36001908e+02  1.52695047e+02  1.52695047e+02
  1.52695047e+02  5.00313080e+02  1.86826771e+03  7.99823348e+03
  4.77662551e+04]
E1 = -182.13905224314237  E_coul = 53.611937057880525
cycle= 1 E= -128.527115185262  delta_E= -0.0303  |g|= 0.198  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.432014
diis-c [-0.18663638  1.        ]
  HOMO = -0.877032895072569  LUMO = 1.10538013730681
  mo_energy =
[-3.28685811e+01 -1.96031903e+00 -8.77032895e-01 -8.77032895e-01
 -8.77032895e-01  1.10538014e+00  1.17371869e+00  1.17371869e+00
  1.17371869e+00  6.30958622e+00  6.30958622e+00  6.30958622e+00
  6.49809052e+00  2.81686558e+01  2.81686558e+01  2.81686558e+01
  3.22568060e+01  1.35693435e+02  1.52369450e+02  1.52369450e+02
  1.52369450e+02  4.99960891e+02  1.86787951e+03  7.99781631e+03
  4.77658190e+04]
E1 = -182.84988132639214  E_coul = 54.32035012369812
cycle= 2 E= -128.529531202694  delta_E= -0.00242  |g|= 0.0972  |ddm|= 0.0701
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.213093
diis-c [-5.80675234e-04  3.29243705e-01  6.70756295e-01]
  HOMO = -0.843586283746722  LUMO = 1.11784422893054
  mo_energy =
[-3.27659489e+01 -1.92516712e+00 -8.43586284e-01 -8.43586284e-01
 -8.43586284e-01  1.11784423e+00  1.18720909e+00  1.18720909e+00
  1.18720909e+00  6.35386613e+00  6.35386613e+00  6.35386613e+00
  6.53575019e+00  2.82486621e+01  2.82486621e+01  2.82486621e+01
  3.23343325e+01  1.35794239e+02  1.52474801e+02  1.52474801e+02
  1.52474801e+02  5.00072061e+02  1.86799573e+03  7.99793491e+03
  4.77659385e+04]
E1 = -182.61258972672493  E_coul = 54.082261027267755
cycle= 3 E= -128.530328699457  delta_E= -0.000797  |g|= 0.000571  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00117974
diis-c [-1.37762819e-07 -2.33215989e-03  5.43367399e-04  1.00178879e+00]
  HOMO = -0.843860942353969  LUMO = 1.11777970830617
  mo_energy =
[-3.27664641e+01 -1.92537259e+00 -8.43860942e-01 -8.43860942e-01
 -8.43860942e-01  1.11777971e+00  1.18713536e+00  1.18713536e+00
  1.18713536e+00  6.35359410e+00  6.35359410e+00  6.35359410e+00
  6.53552176e+00  2.82482372e+01  2.82482372e+01  2.82482372e+01
  3.23339301e+01  1.35793725e+02  1.52474253e+02  1.52474253e+02
  1.52474253e+02  5.00071433e+02  1.86799498e+03  7.99793407e+03
  4.77659376e+04]
E1 = -182.61339802040703  E_coul = 54.083069292642776
cycle= 4 E= -128.530328727764  delta_E= -2.83e-08  |g|= 6.85e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143879
diis-c [-8.73631162e-10  3.49683345e-04  3.01596393e-04 -2.13041289e-01
  1.21239001e+00]
  HOMO = -0.843893172658522  LUMO = 1.11777178500967
  mo_energy =
[-3.27665202e+01 -1.92539068e+00 -8.43893173e-01 -8.43893173e-01
 -8.43893173e-01  1.11777179e+00  1.18712122e+00  1.18712122e+00
  1.18712122e+00  6.35355650e+00  6.35355650e+00  6.35355650e+00
  6.53549292e+00  2.82481871e+01  2.82481871e+01  2.82481871e+01
  3.23338826e+01  1.35793668e+02  1.52474194e+02  1.52474194e+02
  1.52474194e+02  5.00071367e+02  1.86799491e+03  7.99793399e+03
  4.77659375e+04]
E1 = -182.61351831209345  E_coul = 54.08318958371078
cycle= 5 E= -128.530328728383  delta_E= -6.18e-10  |g|= 6.19e-06  |ddm|= 4.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61351831209345  E_coul = 54.08318958371078
  HOMO = -0.843889856650414  LUMO = 1.11777364433555
  mo_energy =
[-3.27665133e+01 -1.92538666e+00 -8.43889857e-01 -8.43889857e-01
 -8.43889857e-01  1.11777364e+00  1.18712275e+00  1.18712275e+00
  1.18712275e+00  6.35356075e+00  6.35356075e+00  6.35356075e+00
  6.53549710e+00  2.82481933e+01  2.82481933e+01  2.82481933e+01
  3.23338888e+01  1.35793675e+02  1.52474201e+02  1.52474201e+02
  1.52474201e+02  5.00071373e+02  1.86799491e+03  7.99793400e+03
  4.77659375e+04]
E1 = -182.61350324888483  E_coul = 54.08317452049999
Extra cycle  E= -128.530328728385  delta_E= -2.16e-12  |g|= 2.12e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 316.94968661267785
E1 = -182.61350324888483  E_coul = 54.08317452049999
init E= -128.530328728385
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.843890908866183  LUMO = 1.11777333434629
  mo_energy =
[-3.27665167e+01 -1.92538765e+00 -8.43890909e-01 -8.43890909e-01
 -8.43890909e-01  1.11777333e+00  1.18712234e+00  1.18712234e+00
  1.18712234e+00  6.35355935e+00  6.35355935e+00  6.35355935e+00
  6.53549599e+00  2.82481907e+01  2.82481907e+01  2.82481907e+01
  3.23338863e+01  1.35793671e+02  1.52474197e+02  1.52474197e+02
  1.52474197e+02  5.00071370e+02  1.86799491e+03  7.99793399e+03
  4.77659375e+04]
E1 = -182.61351130425456  E_coul = 54.08318257586936
cycle= 1 E= -128.530328728385  delta_E= -3.69e-13  |g|= 1.11e-06  |ddm|= 8.28e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61351130425456  E_coul = 54.08318257586936
  HOMO = -0.843890344146147  LUMO = 1.11777355901729
  mo_energy =
[-3.27665150e+01 -1.92538703e+00 -8.43890344e-01 -8.43890344e-01
 -8.43890344e-01  1.11777356e+00  1.18712257e+00  1.18712257e+00
  1.18712257e+00  6.35356010e+00  6.35356010e+00  6.35356010e+00
  6.53549664e+00  2.82481921e+01  2.82481921e+01  2.82481921e+01
  3.23338876e+01  1.35793673e+02  1.52474199e+02  1.52474199e+02
  1.52474199e+02  5.00071372e+02  1.86799491e+03  7.99793400e+03
  4.77659375e+04]
E1 = -182.61350733474748  E_coul = 54.08317860636211
Extra cycle  E= -128.530328728385  delta_E= -1.71e-13  |g|= 5.4e-07  |ddm|= 4.08e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272955e+02 2.35715670e+02
 7.65217451e+01 9.69813731e+00 2.70397346e+01 3.72713679e-01
 1.04855687e+00 2.51894528e+00 4.14775994e+00 1.47496467e+01
 7.03994166e+01 3.50922092e-01 1.25121542e+00]
grad_E = [-1.73987619e-09  9.21817621e-08 -1.86327217e-06  2.34162092e-05
 -1.94889540e-04 -2.18432304e-03  1.05960904e-03 -3.01147655e-03
  3.17311840e-03 -8.98276741e-04 -5.82382527e-04  2.85221000e-04
  9.67775363e-05 -1.27442027e-03  9.50253718e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.454371          1
[INPUT] 0    0    [1    /1   ]  833.272970001        1
[INPUT] 0    0    [1    /1   ]  235.715479339        1
[INPUT] 0    0    [1    /1   ]  76.5233842441        1
[INPUT] 0    0    [1    /1   ]  9.72665403309        1
[INPUT] 0    0    [1    /1   ]  27.0296714193        1
[INPUT] 0    0    [1    /1   ]  0.375015261707       1
[INPUT] 0    0    [1    /1   ]  1.05013182301        1
[INPUT] 0    0    [1    /1   ]  2.5017794811         1
[INPUT] 1    0    [1    /1   ]  4.12060311716        1
[INPUT] 1    0    [1    /1   ]  14.5649999154        1
[INPUT] 1    0    [1    /1   ]  69.9323687288        1
[INPUT] 1    0    [1    /1   ]  0.347128149729       1
[INPUT] 1    0    [1    /1   ]  1.24193646191        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131889055, 1.0]], [0, [3661.454370995851, 1.0]], [0, [833.2729700007181, 1.0]], [0, [235.71547933853975, 1.0]], [0, [76.52338424411803, 1.0]], [0, [9.726654033091194, 1.0]], [0, [27.029671419298566, 1.0]], [0, [0.3750152617065493, 1.0]], [0, [1.0501318230085295, 1.0]], [0, [2.501779481103238, 1.0]], [1, [4.120603117155984, 1.0]], [1, [14.564999915446483, 1.0]], [1, [69.93236872884529, 1.0]], [1, [0.3471281497294836, 1.0]], [1, [1.2419364619075912, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.454371]
bas 2, expnt(s) = [833.27297]
bas 3, expnt(s) = [235.71547934]
bas 4, expnt(s) = [76.52338424]
bas 5, expnt(s) = [9.72665403]
bas 6, expnt(s) = [27.02967142]
bas 7, expnt(s) = [0.37501526]
bas 8, expnt(s) = [1.05013182]
bas 9, expnt(s) = [2.50177948]
bas 10, expnt(s) = [4.12060312]
bas 11, expnt(s) = [14.56499992]
bas 12, expnt(s) = [69.93236873]
bas 13, expnt(s) = [0.34712815]
bas 14, expnt(s) = [1.24193646]
CPU time:       161.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272970e+02 3.91837047e+02 2.35715479e+02 1.51986881e+02
 7.65233842e+01 6.53673156e+01 9.72665403e+00 1.39151415e+01
 2.70296714e+01 2.99499153e+01 3.75015262e-01 1.21074234e+00
 1.05013182e+00 2.62088454e+00 2.50177948e+00 5.02576056e+00
 4.12060312e+00 1.71271608e+01 1.45649999e+01 8.30084875e+01
 6.99323687e+01 5.89973074e+02 3.47128150e-01 7.77314348e-01
 1.24193646e+00 3.82479898e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997869762204635
cond(S) = 318.6223826712517
E1 = -183.57403641101905  E_coul = 55.0771698336233
init E= -128.496866577396
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773854338417882  LUMO = 1.14960937369292
  mo_energy =
[-3.25553419e+01 -1.85286652e+00 -7.73854338e-01 -7.73854338e-01
 -7.73854338e-01  1.14960937e+00  1.19995012e+00  1.19995012e+00
  1.19995012e+00  6.38982475e+00  6.38982475e+00  6.38982475e+00
  6.60835792e+00  2.80875810e+01  2.80875810e+01  2.80875810e+01
  3.24900129e+01  1.36027834e+02  1.51253351e+02  1.51253351e+02
  1.51253351e+02  5.00340001e+02  1.86829228e+03  7.99825523e+03
  4.77662731e+04]
E1 = -182.12951988431942  E_coul = 53.60233238518738
cycle= 1 E= -128.527187499132  delta_E= -0.0303  |g|= 0.199  |ddm|= 0.176
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.43439
diis-c [-0.18869472  1.        ]
  HOMO = -0.877821541517936  LUMO = 1.11069841198938
  mo_energy =
[-3.28701719e+01 -1.96123064e+00 -8.77821542e-01 -8.77821542e-01
 -8.77821542e-01  1.11069841e+00  1.15885721e+00  1.15885721e+00
  1.15885721e+00  6.25306016e+00  6.25306016e+00  6.25306016e+00
  6.49160414e+00  2.78435283e+01  2.78435283e+01  2.78435283e+01
  3.22533095e+01  1.35717845e+02  1.50926486e+02  1.50926486e+02
  1.50926486e+02  4.99986231e+02  1.86790247e+03  7.99783644e+03
  4.77658354e+04]
E1 = -182.84571565233165  E_coul = 54.31608765425145
cycle= 2 E= -128.52962799808  delta_E= -0.00244  |g|= 0.0979  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.214798
diis-c [-5.81100405e-04  3.29810790e-01  6.70189210e-01]
  HOMO = -0.844142370700039  LUMO = 1.12329857350507
  mo_energy =
[-3.27668916e+01 -1.92582824e+00 -8.44142371e-01 -8.44142371e-01
 -8.44142371e-01  1.12329857e+00  1.17228723e+00  1.17228723e+00
  1.17228723e+00  6.29744905e+00  6.29744905e+00  6.29744905e+00
  6.52945098e+00  2.79237669e+01  2.79237669e+01  2.79237669e+01
  3.23313598e+01  1.35819289e+02  1.51032432e+02  1.51032432e+02
  1.51032432e+02  5.00098092e+02  1.86801941e+03  7.99795576e+03
  4.77659556e+04]
E1 = -182.6062874465445  E_coul = 54.075849067120394
cycle= 3 E= -128.530438379424  delta_E= -0.00081  |g|= 0.000563  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115212
diis-c [-1.20371840e-07 -2.30841180e-03  4.61754876e-04  1.00184666e+00]
  HOMO = -0.844417011946167  LUMO = 1.12323012820696
  mo_energy =
[-3.27674010e+01 -1.92603949e+00 -8.44417012e-01 -8.44417012e-01
 -8.44417012e-01  1.12323013e+00  1.17221451e+00  1.17221451e+00
  1.17221451e+00  6.29717803e+00  6.29717803e+00  6.29717803e+00
  6.52922067e+00  2.79233460e+01  2.79233460e+01  2.79233460e+01
  3.23309594e+01  1.35818780e+02  1.51031891e+02  1.51031891e+02
  1.51031891e+02  5.00097473e+02  1.86801868e+03  7.99795494e+03
  4.77659547e+04]
E1 = -182.60707324469183  E_coul = 54.0766348390314
cycle= 4 E= -128.53043840566  delta_E= -2.62e-08  |g|= 6.59e-05  |ddm|= 0.000263
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138672
diis-c [-8.23097538e-10  3.21921854e-04  3.12449995e-04 -2.00582710e-01
  1.19994834e+00]
  HOMO = -0.844448934037466  LUMO = 1.12322134362968
  mo_energy =
[-3.27674564e+01 -1.92605896e+00 -8.44448934e-01 -8.44448934e-01
 -8.44448934e-01  1.12322134e+00  1.17220057e+00  1.17220057e+00
  1.17220057e+00  6.29714065e+00  6.29714065e+00  6.29714065e+00
  6.52919129e+00  2.79232962e+01  2.79232962e+01  2.79232962e+01
  3.23309119e+01  1.35818724e+02  1.51031833e+02  1.51031833e+02
  1.51031833e+02  5.00097408e+02  1.86801860e+03  7.99795486e+03
  4.77659547e+04]
E1 = -182.60719162872684  E_coul = 54.07675322252517
cycle= 5 E= -128.530438406202  delta_E= -5.41e-10  |g|= 5.91e-06  |ddm|= 4.42e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60719162872684  E_coul = 54.07675322252517
  HOMO = -0.844445847661434  LUMO = 1.12322313129344
  mo_energy =
[-3.27674499e+01 -1.92605512e+00 -8.44445848e-01 -8.44445848e-01
 -8.44445848e-01  1.12322313e+00  1.17220198e+00  1.17220198e+00
  1.17220198e+00  6.29714461e+00  6.29714461e+00  6.29714461e+00
  6.52919522e+00  2.79233021e+01  2.79233021e+01  2.79233021e+01
  3.23309178e+01  1.35818731e+02  1.51031839e+02  1.51031839e+02
  1.51031839e+02  5.00097414e+02  1.86801861e+03  7.99795486e+03
  4.77659547e+04]
E1 = -182.60717752844596  E_coul = 54.07673912224207
Extra cycle  E= -128.530438406204  delta_E= -2.25e-12  |g|= 1.99e-06  |ddm|= 1.92e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272970e+02 2.35715479e+02
 7.65233842e+01 9.72665403e+00 2.70296714e+01 3.75015262e-01
 1.05013182e+00 2.50177948e+00 4.12060312e+00 1.45649999e+01
 6.99323687e+01 3.47128150e-01 1.24193646e+00]
E = -128.5304384062039
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.454371          1
[INPUT] 0    0    [1    /1   ]  833.272970001        1
[INPUT] 0    0    [1    /1   ]  235.715479339        1
[INPUT] 0    0    [1    /1   ]  76.5233842441        1
[INPUT] 0    0    [1    /1   ]  9.72665403309        1
[INPUT] 0    0    [1    /1   ]  27.0296714193        1
[INPUT] 0    0    [1    /1   ]  0.375015261707       1
[INPUT] 0    0    [1    /1   ]  1.05013182301        1
[INPUT] 0    0    [1    /1   ]  2.5017794811         1
[INPUT] 1    0    [1    /1   ]  4.12060311716        1
[INPUT] 1    0    [1    /1   ]  14.5649999154        1
[INPUT] 1    0    [1    /1   ]  69.9323687288        1
[INPUT] 1    0    [1    /1   ]  0.347128149729       1
[INPUT] 1    0    [1    /1   ]  1.24193646191        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131889055, 1.0]], [0, [3661.454370995851, 1.0]], [0, [833.2729700007181, 1.0]], [0, [235.71547933853975, 1.0]], [0, [76.52338424411803, 1.0]], [0, [9.726654033091194, 1.0]], [0, [27.029671419298566, 1.0]], [0, [0.3750152617065493, 1.0]], [0, [1.0501318230085295, 1.0]], [0, [2.501779481103238, 1.0]], [1, [4.120603117155984, 1.0]], [1, [14.564999915446483, 1.0]], [1, [69.93236872884529, 1.0]], [1, [0.3471281497294836, 1.0]], [1, [1.2419364619075912, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.454371]
bas 2, expnt(s) = [833.27297]
bas 3, expnt(s) = [235.71547934]
bas 4, expnt(s) = [76.52338424]
bas 5, expnt(s) = [9.72665403]
bas 6, expnt(s) = [27.02967142]
bas 7, expnt(s) = [0.37501526]
bas 8, expnt(s) = [1.05013182]
bas 9, expnt(s) = [2.50177948]
bas 10, expnt(s) = [4.12060312]
bas 11, expnt(s) = [14.56499992]
bas 12, expnt(s) = [69.93236873]
bas 13, expnt(s) = [0.34712815]
bas 14, expnt(s) = [1.24193646]
CPU time:       162.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272970e+02 3.91837047e+02 2.35715479e+02 1.51986881e+02
 7.65233842e+01 6.53673156e+01 9.72665403e+00 1.39151415e+01
 2.70296714e+01 2.99499153e+01 3.75015262e-01 1.21074234e+00
 1.05013182e+00 2.62088454e+00 2.50177948e+00 5.02576056e+00
 4.12060312e+00 1.71271608e+01 1.45649999e+01 8.30084875e+01
 6.99323687e+01 5.89973074e+02 3.47128150e-01 7.77314348e-01
 1.24193646e+00 3.82479898e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997869762204635
cond(S) = 318.6223826712517
E1 = -183.57403641101905  E_coul = 55.0771698336233
init E= -128.496866577396
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.773854338417882  LUMO = 1.14960937369292
  mo_energy =
[-3.25553419e+01 -1.85286652e+00 -7.73854338e-01 -7.73854338e-01
 -7.73854338e-01  1.14960937e+00  1.19995012e+00  1.19995012e+00
  1.19995012e+00  6.38982475e+00  6.38982475e+00  6.38982475e+00
  6.60835792e+00  2.80875810e+01  2.80875810e+01  2.80875810e+01
  3.24900129e+01  1.36027834e+02  1.51253351e+02  1.51253351e+02
  1.51253351e+02  5.00340001e+02  1.86829228e+03  7.99825523e+03
  4.77662731e+04]
E1 = -182.12951988431942  E_coul = 53.60233238518738
cycle= 1 E= -128.527187499132  delta_E= -0.0303  |g|= 0.199  |ddm|= 0.176
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.43439
diis-c [-0.18869472  1.        ]
  HOMO = -0.877821541517936  LUMO = 1.11069841198938
  mo_energy =
[-3.28701719e+01 -1.96123064e+00 -8.77821542e-01 -8.77821542e-01
 -8.77821542e-01  1.11069841e+00  1.15885721e+00  1.15885721e+00
  1.15885721e+00  6.25306016e+00  6.25306016e+00  6.25306016e+00
  6.49160414e+00  2.78435283e+01  2.78435283e+01  2.78435283e+01
  3.22533095e+01  1.35717845e+02  1.50926486e+02  1.50926486e+02
  1.50926486e+02  4.99986231e+02  1.86790247e+03  7.99783644e+03
  4.77658354e+04]
E1 = -182.84571565233165  E_coul = 54.31608765425145
cycle= 2 E= -128.52962799808  delta_E= -0.00244  |g|= 0.0979  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.214798
diis-c [-5.81100405e-04  3.29810790e-01  6.70189210e-01]
  HOMO = -0.844142370700039  LUMO = 1.12329857350507
  mo_energy =
[-3.27668916e+01 -1.92582824e+00 -8.44142371e-01 -8.44142371e-01
 -8.44142371e-01  1.12329857e+00  1.17228723e+00  1.17228723e+00
  1.17228723e+00  6.29744905e+00  6.29744905e+00  6.29744905e+00
  6.52945098e+00  2.79237669e+01  2.79237669e+01  2.79237669e+01
  3.23313598e+01  1.35819289e+02  1.51032432e+02  1.51032432e+02
  1.51032432e+02  5.00098092e+02  1.86801941e+03  7.99795576e+03
  4.77659556e+04]
E1 = -182.6062874465445  E_coul = 54.075849067120394
cycle= 3 E= -128.530438379424  delta_E= -0.00081  |g|= 0.000563  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115212
diis-c [-1.20371840e-07 -2.30841180e-03  4.61754876e-04  1.00184666e+00]
  HOMO = -0.844417011946167  LUMO = 1.12323012820696
  mo_energy =
[-3.27674010e+01 -1.92603949e+00 -8.44417012e-01 -8.44417012e-01
 -8.44417012e-01  1.12323013e+00  1.17221451e+00  1.17221451e+00
  1.17221451e+00  6.29717803e+00  6.29717803e+00  6.29717803e+00
  6.52922067e+00  2.79233460e+01  2.79233460e+01  2.79233460e+01
  3.23309594e+01  1.35818780e+02  1.51031891e+02  1.51031891e+02
  1.51031891e+02  5.00097473e+02  1.86801868e+03  7.99795494e+03
  4.77659547e+04]
E1 = -182.60707324469183  E_coul = 54.0766348390314
cycle= 4 E= -128.53043840566  delta_E= -2.62e-08  |g|= 6.59e-05  |ddm|= 0.000263
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000138672
diis-c [-8.23097538e-10  3.21921854e-04  3.12449995e-04 -2.00582710e-01
  1.19994834e+00]
  HOMO = -0.844448934037466  LUMO = 1.12322134362968
  mo_energy =
[-3.27674564e+01 -1.92605896e+00 -8.44448934e-01 -8.44448934e-01
 -8.44448934e-01  1.12322134e+00  1.17220057e+00  1.17220057e+00
  1.17220057e+00  6.29714065e+00  6.29714065e+00  6.29714065e+00
  6.52919129e+00  2.79232962e+01  2.79232962e+01  2.79232962e+01
  3.23309119e+01  1.35818724e+02  1.51031833e+02  1.51031833e+02
  1.51031833e+02  5.00097408e+02  1.86801860e+03  7.99795486e+03
  4.77659547e+04]
E1 = -182.60719162872684  E_coul = 54.07675322252517
cycle= 5 E= -128.530438406202  delta_E= -5.41e-10  |g|= 5.91e-06  |ddm|= 4.42e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60719162872684  E_coul = 54.07675322252517
  HOMO = -0.844445847661434  LUMO = 1.12322313129344
  mo_energy =
[-3.27674499e+01 -1.92605512e+00 -8.44445848e-01 -8.44445848e-01
 -8.44445848e-01  1.12322313e+00  1.17220198e+00  1.17220198e+00
  1.17220198e+00  6.29714461e+00  6.29714461e+00  6.29714461e+00
  6.52919522e+00  2.79233021e+01  2.79233021e+01  2.79233021e+01
  3.23309178e+01  1.35818731e+02  1.51031839e+02  1.51031839e+02
  1.51031839e+02  5.00097414e+02  1.86801861e+03  7.99795486e+03
  4.77659547e+04]
E1 = -182.60717752844596  E_coul = 54.07673912224207
Extra cycle  E= -128.530438406204  delta_E= -2.25e-12  |g|= 1.99e-06  |ddm|= 1.92e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 318.6223826712517
E1 = -182.60717752844596  E_coul = 54.07673912224207
init E= -128.530438406204
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.844446837169153  LUMO = 1.12322284788358
  mo_energy =
[-3.27674531e+01 -1.92605604e+00 -8.44446837e-01 -8.44446837e-01
 -8.44446837e-01  1.12322285e+00  1.17220160e+00  1.17220160e+00
  1.17220160e+00  6.29714331e+00  6.29714331e+00  6.29714331e+00
  6.52919419e+00  2.79232997e+01  2.79232997e+01  2.79232997e+01
  3.23309154e+01  1.35818727e+02  1.51031836e+02  1.51031836e+02
  1.51031836e+02  5.00097411e+02  1.86801860e+03  7.99795486e+03
  4.77659547e+04]
E1 = -182.60718509907863  E_coul = 54.07674669287467
cycle= 1 E= -128.530438406204  delta_E= -5.68e-14  |g|= 1.04e-06  |ddm|= 7.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.03 sec
E1 = -182.60718509907863  E_coul = 54.07674669287467
  HOMO = -0.844446307176109  LUMO = 1.12322306172359
  mo_energy =
[-3.27674515e+01 -1.92605545e+00 -8.44446307e-01 -8.44446307e-01
 -8.44446307e-01  1.12322306e+00  1.17220182e+00  1.17220182e+00
  1.17220182e+00  6.29714401e+00  6.29714401e+00  6.29714401e+00
  6.52919480e+00  2.79233009e+01  2.79233009e+01  2.79233009e+01
  3.23309167e+01  1.35818729e+02  1.51031837e+02  1.51031837e+02
  1.51031837e+02  5.00097412e+02  1.86801861e+03  7.99795486e+03
  4.77659547e+04]
E1 = -182.6071813629269  E_coul = 54.07674295672292
Extra cycle  E= -128.530438406204  delta_E= -2.84e-14  |g|= 5.08e-07  |ddm|= 3.86e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.36 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272970e+02 2.35715479e+02
 7.65233842e+01 9.72665403e+00 2.70296714e+01 3.75015262e-01
 1.05013182e+00 2.50177948e+00 4.12060312e+00 1.45649999e+01
 6.99323687e+01 3.47128150e-01 1.24193646e+00]
grad_E = [-1.41767784e-09  7.51569586e-08 -1.52506211e-06  1.93540386e-05
 -1.64376647e-04 -1.87638420e-03  9.08694817e-04 -2.14375106e-03
  2.92170769e-03 -9.59426158e-04  8.68448016e-04 -1.25713506e-04
  1.21512798e-04 -1.01918611e-02  8.38514268e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45436944        1
[INPUT] 0    0    [1    /1   ]  833.273001299        1
[INPUT] 0    0    [1    /1   ]  235.715084419        1
[INPUT] 0    0    [1    /1   ]  76.5266715001        1
[INPUT] 0    0    [1    /1   ]  9.77575536752        1
[INPUT] 0    0    [1    /1   ]  27.0105440564        1
[INPUT] 0    0    [1    /1   ]  0.373743371513       1
[INPUT] 0    0    [1    /1   ]  1.04080296136        1
[INPUT] 0    0    [1    /1   ]  2.4767467162         1
[INPUT] 1    0    [1    /1   ]  4.08145088454        1
[INPUT] 1    0    [1    /1   ]  14.3193323209        1
[INPUT] 1    0    [1    /1   ]  69.390008912         1
[INPUT] 1    0    [1    /1   ]  0.344847182457       1
[INPUT] 1    0    [1    /1   ]  1.23236067911        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131918843, 1.0]], [0, [3661.454369439798, 1.0]], [0, [833.2730012992922, 1.0]], [0, [235.71508441888068, 1.0]], [0, [76.52667150006386, 1.0]], [0, [9.775755367519846, 1.0]], [0, [27.01054405644101, 1.0]], [0, [0.3737433715128087, 1.0]], [0, [1.0408029613577734, 1.0]], [0, [2.4767467162035706, 1.0]], [1, [4.081450884542977, 1.0]], [1, [14.3193323209071, 1.0]], [1, [69.39000891201464, 1.0]], [1, [0.3448471824574726, 1.0]], [1, [1.2323606791059916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413192]
bas 1, expnt(s) = [3661.45436944]
bas 2, expnt(s) = [833.2730013]
bas 3, expnt(s) = [235.71508442]
bas 4, expnt(s) = [76.5266715]
bas 5, expnt(s) = [9.77575537]
bas 6, expnt(s) = [27.01054406]
bas 7, expnt(s) = [0.37374337]
bas 8, expnt(s) = [1.04080296]
bas 9, expnt(s) = [2.47674672]
bas 10, expnt(s) = [4.08145088]
bas 11, expnt(s) = [14.31933232]
bas 12, expnt(s) = [69.39000891]
bas 13, expnt(s) = [0.34484718]
bas 14, expnt(s) = [1.23236068]
CPU time:       165.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273001e+02 3.91837058e+02 2.35715084e+02 1.51986690e+02
 7.65266715e+01 6.53694216e+01 9.77575537e+00 1.39677923e+01
 2.70105441e+01 2.99340185e+01 3.73743372e-01 1.20766130e+00
 1.04080296e+00 2.60340308e+00 2.47674672e+00 4.98799743e+00
 4.08145088e+00 1.69239842e+01 1.43193323e+01 8.12620647e+01
 6.93900089e+01 5.84259216e+02 3.44847182e-01 7.70934968e-01
 1.23236068e+00 3.78797133e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997942908875736
cond(S) = 317.11714125912306
E1 = -183.57410660157387  E_coul = 55.07718825907056
init E= -128.496918342503
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773852720947423  LUMO = 1.14018912244568
  mo_energy =
[-3.25553940e+01 -1.85288180e+00 -7.73852721e-01 -7.73852721e-01
 -7.73852721e-01  1.14018912e+00  1.18954847e+00  1.18954847e+00
  1.18954847e+00  6.33110187e+00  6.33110187e+00  6.33110187e+00
  6.54484742e+00  2.76649071e+01  2.76649071e+01  2.76649071e+01
  3.24275446e+01  1.36019348e+02  1.49467355e+02  1.49467355e+02
  1.49467355e+02  5.00337987e+02  1.86829125e+03  7.99825456e+03
  4.77662726e+04]
E1 = -182.1257814601501  E_coul = 53.59849975153169
cycle= 1 E= -128.527281708618  delta_E= -0.0304  |g|= 0.199  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435831
diis-c [-0.18994875  1.        ]
  HOMO = -0.878126602144967  LUMO = 1.10146088337261
  mo_energy =
[-3.28708495e+01 -1.96161552e+00 -8.78126602e-01 -8.78126602e-01
 -8.78126602e-01  1.10146088e+00  1.14872885e+00  1.14872885e+00
  1.14872885e+00  6.19478053e+00  6.19478053e+00  6.19478053e+00
  6.42833010e+00  2.74215442e+01  2.74215442e+01  2.74215442e+01
  3.21901175e+01  1.35708722e+02  1.49140201e+02  1.49140201e+02
  1.49140201e+02  4.99983564e+02  1.86790078e+03  7.99783509e+03
  4.77658342e+04]
E1 = -182.8446382628026  E_coul = 54.31490446901195
cycle= 2 E= -128.529733793791  delta_E= -0.00245  |g|= 0.0983  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215836
diis-c [-5.78847635e-04  3.30159735e-01  6.69840265e-01]
  HOMO = -0.844333322539374  LUMO = 1.11399920191755
  mo_energy =
[-3.27672673e+01 -1.92609113e+00 -8.44333323e-01 -8.44333323e-01
 -8.44333323e-01  1.11399920e+00  1.16207452e+00  1.16207452e+00
  1.16207452e+00  6.23904033e+00  6.23904033e+00  6.23904033e+00
  6.46610598e+00  2.75016205e+01  2.75016205e+01  2.75016205e+01
  3.22684561e+01  1.35810474e+02  1.49246374e+02  1.49246374e+02
  1.49246374e+02  5.00095746e+02  1.86801805e+03  7.99795475e+03
  4.77659548e+04]
E1 = -182.60423889601682  E_coul = 54.0736886136885
cycle= 3 E= -128.530550282328  delta_E= -0.000816  |g|= 0.000541  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00110704
diis-c [-1.12089376e-07 -2.26451653e-03  3.29955868e-04  1.00193456e+00]
  HOMO = -0.844599445912941  LUMO = 1.11393425347296
  mo_energy =
[-3.27677576e+01 -1.92629586e+00 -8.44599446e-01 -8.44599446e-01
 -8.44599446e-01  1.11393425e+00  1.16200658e+00  1.16200658e+00
  1.16200658e+00  6.23878134e+00  6.23878134e+00  6.23878134e+00
  6.46588565e+00  2.75012171e+01  2.75012171e+01  2.75012171e+01
  3.22680708e+01  1.35809985e+02  1.49245854e+02  1.49245854e+02
  1.49245854e+02  5.00095150e+02  1.86801734e+03  7.99795396e+03
  4.77659539e+04]
E1 = -182.60498184630177  E_coul = 54.0744315397789
cycle= 4 E= -128.530550306523  delta_E= -2.42e-08  |g|= 6.43e-05  |ddm|= 0.000255
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135671
diis-c [-7.91729707e-10  3.11215391e-04  3.34270709e-04 -1.97528512e-01
  1.19688303e+00]
  HOMO = -0.844630833547301  LUMO = 1.11392545745628
  mo_energy =
[-3.27678122e+01 -1.92631542e+00 -8.44630834e-01 -8.44630834e-01
 -8.44630834e-01  1.11392546e+00  1.16199297e+00  1.16199297e+00
  1.16199297e+00  6.23874466e+00  6.23874466e+00  6.23874466e+00
  6.46585669e+00  2.75011682e+01  2.75011682e+01  2.75011682e+01
  3.22680239e+01  1.35809930e+02  1.49245797e+02  1.49245797e+02
  1.49245797e+02  5.00095086e+02  1.86801727e+03  7.99795388e+03
  4.77659539e+04]
E1 = -182.60509835110778  E_coul = 54.074548044076366
cycle= 5 E= -128.530550307031  delta_E= -5.09e-10  |g|= 5.76e-06  |ddm|= 4.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60509835110778  E_coul = 54.074548044076366
  HOMO = -0.844627845997331  LUMO = 1.11392718525344
  mo_energy =
[-3.27678059e+01 -1.92631168e+00 -8.44627846e-01 -8.44627846e-01
 -8.44627846e-01  1.11392719e+00  1.16199433e+00  1.16199433e+00
  1.16199433e+00  6.23874849e+00  6.23874849e+00  6.23874849e+00
  6.46586048e+00  2.75011738e+01  2.75011738e+01  2.75011738e+01
  3.22680296e+01  1.35809936e+02  1.49245803e+02  1.49245803e+02
  1.49245803e+02  5.00095092e+02  1.86801727e+03  7.99795389e+03
  4.77659539e+04]
E1 = -182.60508460031917  E_coul = 54.07453429328571
Extra cycle  E= -128.530550307033  delta_E= -2.05e-12  |g|= 1.94e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273001e+02 2.35715084e+02
 7.65266715e+01 9.77575537e+00 2.70105441e+01 3.73743372e-01
 1.04080296e+00 2.47674672e+00 4.08145088e+00 1.43193323e+01
 6.93900089e+01 3.44847182e-01 1.23236068e+00]
E = -128.53055030703348
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45436944        1
[INPUT] 0    0    [1    /1   ]  833.273001299        1
[INPUT] 0    0    [1    /1   ]  235.715084419        1
[INPUT] 0    0    [1    /1   ]  76.5266715001        1
[INPUT] 0    0    [1    /1   ]  9.77575536752        1
[INPUT] 0    0    [1    /1   ]  27.0105440564        1
[INPUT] 0    0    [1    /1   ]  0.373743371513       1
[INPUT] 0    0    [1    /1   ]  1.04080296136        1
[INPUT] 0    0    [1    /1   ]  2.4767467162         1
[INPUT] 1    0    [1    /1   ]  4.08145088454        1
[INPUT] 1    0    [1    /1   ]  14.3193323209        1
[INPUT] 1    0    [1    /1   ]  69.390008912         1
[INPUT] 1    0    [1    /1   ]  0.344847182457       1
[INPUT] 1    0    [1    /1   ]  1.23236067911        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131918843, 1.0]], [0, [3661.454369439798, 1.0]], [0, [833.2730012992922, 1.0]], [0, [235.71508441888068, 1.0]], [0, [76.52667150006386, 1.0]], [0, [9.775755367519846, 1.0]], [0, [27.01054405644101, 1.0]], [0, [0.3737433715128087, 1.0]], [0, [1.0408029613577734, 1.0]], [0, [2.4767467162035706, 1.0]], [1, [4.081450884542977, 1.0]], [1, [14.3193323209071, 1.0]], [1, [69.39000891201464, 1.0]], [1, [0.3448471824574726, 1.0]], [1, [1.2323606791059916, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413192]
bas 1, expnt(s) = [3661.45436944]
bas 2, expnt(s) = [833.2730013]
bas 3, expnt(s) = [235.71508442]
bas 4, expnt(s) = [76.5266715]
bas 5, expnt(s) = [9.77575537]
bas 6, expnt(s) = [27.01054406]
bas 7, expnt(s) = [0.37374337]
bas 8, expnt(s) = [1.04080296]
bas 9, expnt(s) = [2.47674672]
bas 10, expnt(s) = [4.08145088]
bas 11, expnt(s) = [14.31933232]
bas 12, expnt(s) = [69.39000891]
bas 13, expnt(s) = [0.34484718]
bas 14, expnt(s) = [1.23236068]
CPU time:       166.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273001e+02 3.91837058e+02 2.35715084e+02 1.51986690e+02
 7.65266715e+01 6.53694216e+01 9.77575537e+00 1.39677923e+01
 2.70105441e+01 2.99340185e+01 3.73743372e-01 1.20766130e+00
 1.04080296e+00 2.60340308e+00 2.47674672e+00 4.98799743e+00
 4.08145088e+00 1.69239842e+01 1.43193323e+01 8.12620647e+01
 6.93900089e+01 5.84259216e+02 3.44847182e-01 7.70934968e-01
 1.23236068e+00 3.78797133e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997942908875736
cond(S) = 317.11714125912306
E1 = -183.57410660157387  E_coul = 55.07718825907056
init E= -128.496918342503
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773852720947423  LUMO = 1.14018912244568
  mo_energy =
[-3.25553940e+01 -1.85288180e+00 -7.73852721e-01 -7.73852721e-01
 -7.73852721e-01  1.14018912e+00  1.18954847e+00  1.18954847e+00
  1.18954847e+00  6.33110187e+00  6.33110187e+00  6.33110187e+00
  6.54484742e+00  2.76649071e+01  2.76649071e+01  2.76649071e+01
  3.24275446e+01  1.36019348e+02  1.49467355e+02  1.49467355e+02
  1.49467355e+02  5.00337987e+02  1.86829125e+03  7.99825456e+03
  4.77662726e+04]
E1 = -182.1257814601501  E_coul = 53.59849975153169
cycle= 1 E= -128.527281708618  delta_E= -0.0304  |g|= 0.199  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435831
diis-c [-0.18994875  1.        ]
  HOMO = -0.878126602144967  LUMO = 1.10146088337261
  mo_energy =
[-3.28708495e+01 -1.96161552e+00 -8.78126602e-01 -8.78126602e-01
 -8.78126602e-01  1.10146088e+00  1.14872885e+00  1.14872885e+00
  1.14872885e+00  6.19478053e+00  6.19478053e+00  6.19478053e+00
  6.42833010e+00  2.74215442e+01  2.74215442e+01  2.74215442e+01
  3.21901175e+01  1.35708722e+02  1.49140201e+02  1.49140201e+02
  1.49140201e+02  4.99983564e+02  1.86790078e+03  7.99783509e+03
  4.77658342e+04]
E1 = -182.8446382628026  E_coul = 54.31490446901195
cycle= 2 E= -128.529733793791  delta_E= -0.00245  |g|= 0.0983  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215836
diis-c [-5.78847635e-04  3.30159735e-01  6.69840265e-01]
  HOMO = -0.844333322539374  LUMO = 1.11399920191755
  mo_energy =
[-3.27672673e+01 -1.92609113e+00 -8.44333323e-01 -8.44333323e-01
 -8.44333323e-01  1.11399920e+00  1.16207452e+00  1.16207452e+00
  1.16207452e+00  6.23904033e+00  6.23904033e+00  6.23904033e+00
  6.46610598e+00  2.75016205e+01  2.75016205e+01  2.75016205e+01
  3.22684561e+01  1.35810474e+02  1.49246374e+02  1.49246374e+02
  1.49246374e+02  5.00095746e+02  1.86801805e+03  7.99795475e+03
  4.77659548e+04]
E1 = -182.60423889601682  E_coul = 54.0736886136885
cycle= 3 E= -128.530550282328  delta_E= -0.000816  |g|= 0.000541  |ddm|= 0.0241
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00110704
diis-c [-1.12089376e-07 -2.26451653e-03  3.29955868e-04  1.00193456e+00]
  HOMO = -0.844599445912941  LUMO = 1.11393425347296
  mo_energy =
[-3.27677576e+01 -1.92629586e+00 -8.44599446e-01 -8.44599446e-01
 -8.44599446e-01  1.11393425e+00  1.16200658e+00  1.16200658e+00
  1.16200658e+00  6.23878134e+00  6.23878134e+00  6.23878134e+00
  6.46588565e+00  2.75012171e+01  2.75012171e+01  2.75012171e+01
  3.22680708e+01  1.35809985e+02  1.49245854e+02  1.49245854e+02
  1.49245854e+02  5.00095150e+02  1.86801734e+03  7.99795396e+03
  4.77659539e+04]
E1 = -182.60498184630177  E_coul = 54.0744315397789
cycle= 4 E= -128.530550306523  delta_E= -2.42e-08  |g|= 6.43e-05  |ddm|= 0.000255
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000135671
diis-c [-7.91729707e-10  3.11215391e-04  3.34270709e-04 -1.97528512e-01
  1.19688303e+00]
  HOMO = -0.844630833547301  LUMO = 1.11392545745628
  mo_energy =
[-3.27678122e+01 -1.92631542e+00 -8.44630834e-01 -8.44630834e-01
 -8.44630834e-01  1.11392546e+00  1.16199297e+00  1.16199297e+00
  1.16199297e+00  6.23874466e+00  6.23874466e+00  6.23874466e+00
  6.46585669e+00  2.75011682e+01  2.75011682e+01  2.75011682e+01
  3.22680239e+01  1.35809930e+02  1.49245797e+02  1.49245797e+02
  1.49245797e+02  5.00095086e+02  1.86801727e+03  7.99795388e+03
  4.77659539e+04]
E1 = -182.60509835110778  E_coul = 54.074548044076366
cycle= 5 E= -128.530550307031  delta_E= -5.09e-10  |g|= 5.76e-06  |ddm|= 4.26e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.60509835110778  E_coul = 54.074548044076366
  HOMO = -0.844627845997331  LUMO = 1.11392718525344
  mo_energy =
[-3.27678059e+01 -1.92631168e+00 -8.44627846e-01 -8.44627846e-01
 -8.44627846e-01  1.11392719e+00  1.16199433e+00  1.16199433e+00
  1.16199433e+00  6.23874849e+00  6.23874849e+00  6.23874849e+00
  6.46586048e+00  2.75011738e+01  2.75011738e+01  2.75011738e+01
  3.22680296e+01  1.35809936e+02  1.49245803e+02  1.49245803e+02
  1.49245803e+02  5.00095092e+02  1.86801727e+03  7.99795389e+03
  4.77659539e+04]
E1 = -182.60508460031917  E_coul = 54.07453429328571
Extra cycle  E= -128.530550307033  delta_E= -2.05e-12  |g|= 1.94e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 317.11714125912306
E1 = -182.60508460031917  E_coul = 54.07453429328571
init E= -128.530550307033
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.844628812437487  LUMO = 1.11392691255045
  mo_energy =
[-3.27678090e+01 -1.92631257e+00 -8.44628812e-01 -8.44628812e-01
 -8.44628812e-01  1.11392691e+00  1.16199396e+00  1.16199396e+00
  1.16199396e+00  6.23874722e+00  6.23874722e+00  6.23874722e+00
  6.46585948e+00  2.75011715e+01  2.75011715e+01  2.75011715e+01
  3.22680273e+01  1.35809933e+02  1.49245800e+02  1.49245800e+02
  1.49245800e+02  5.00095089e+02  1.86801727e+03  7.99795388e+03
  4.77659539e+04]
E1 = -182.60509198915227  E_coul = 54.07454168211843
cycle= 1 E= -128.530550307034  delta_E= -3.69e-13  |g|= 1.02e-06  |ddm|= 7.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60509198915227  E_coul = 54.07454168211843
  HOMO = -0.844628295304375  LUMO = 1.11392711993716
  mo_energy =
[-3.27678074e+01 -1.92631200e+00 -8.44628295e-01 -8.44628295e-01
 -8.44628295e-01  1.11392712e+00  1.16199417e+00  1.16199417e+00
  1.16199417e+00  6.23874790e+00  6.23874790e+00  6.23874790e+00
  6.46586008e+00  2.75011727e+01  2.75011727e+01  2.75011727e+01
  3.22680285e+01  1.35809934e+02  1.49245802e+02  1.49245802e+02
  1.49245802e+02  5.00095090e+02  1.86801727e+03  7.99795388e+03
  4.77659539e+04]
E1 = -182.60508833971068  E_coul = 54.07453803267703
Extra cycle  E= -128.530550307034  delta_E= 1.99e-13  |g|= 4.97e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273001e+02 2.35715084e+02
 7.65266715e+01 9.77575537e+00 2.70105441e+01 3.73743372e-01
 1.04080296e+00 2.47674672e+00 4.08145088e+00 1.43193323e+01
 6.93900089e+01 3.44847182e-01 1.23236068e+00]
grad_E = [-8.32208504e-10  4.42706129e-08 -9.10114526e-07  1.19940186e-05
 -1.08798058e-04 -1.29787562e-03  6.34532249e-04 -1.29029041e-03
  2.38466018e-03 -9.96847064e-04  2.52060902e-03 -6.63389853e-04
  1.57026566e-04 -1.03293113e-02 -1.16742925e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45436794        1
[INPUT] 0    0    [1    /1   ]  833.27303136         1
[INPUT] 0    0    [1    /1   ]  235.714707222        1
[INPUT] 0    0    [1    /1   ]  76.5297592784        1
[INPUT] 0    0    [1    /1   ]  9.81730496268        1
[INPUT] 0    0    [1    /1   ]  26.9931455066        1
[INPUT] 0    0    [1    /1   ]  0.368741514711       1
[INPUT] 0    0    [1    /1   ]  1.02440691293        1
[INPUT] 0    0    [1    /1   ]  2.45926777516        1
[INPUT] 1    0    [1    /1   ]  4.05380776991        1
[INPUT] 1    0    [1    /1   ]  14.1905639114        1
[INPUT] 1    0    [1    /1   ]  69.1026071214        1
[INPUT] 1    0    [1    /1   ]  0.344727529932       1
[INPUT] 1    0    [1    /1   ]  1.22714087445        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413194731, 1.0]], [0, [3661.454367941887, 1.0]], [0, [833.2730313600955, 1.0]], [0, [235.71470722198737, 1.0]], [0, [76.52975927837022, 1.0]], [0, [9.817304962677616, 1.0]], [0, [26.993145506606385, 1.0]], [0, [0.36874151471061933, 1.0]], [0, [1.024406912925244, 1.0]], [0, [2.4592677751607788, 1.0]], [1, [4.0538077699080075, 1.0]], [1, [14.190563911430983, 1.0]], [1, [69.10260712135948, 1.0]], [1, [0.34472752993165395, 1.0]], [1, [1.2271408744539154, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413195]
bas 1, expnt(s) = [3661.45436794]
bas 2, expnt(s) = [833.27303136]
bas 3, expnt(s) = [235.71470722]
bas 4, expnt(s) = [76.52975928]
bas 5, expnt(s) = [9.81730496]
bas 6, expnt(s) = [26.99314551]
bas 7, expnt(s) = [0.36874151]
bas 8, expnt(s) = [1.02440691]
bas 9, expnt(s) = [2.45926778]
bas 10, expnt(s) = [4.05380777]
bas 11, expnt(s) = [14.19056391]
bas 12, expnt(s) = [69.10260712]
bas 13, expnt(s) = [0.34472753]
bas 14, expnt(s) = [1.22714087]
CPU time:       169.54
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273031e+02 3.91837069e+02 2.35714707e+02 1.51986507e+02
 7.65297593e+01 6.53713998e+01 9.81730496e+00 1.40122938e+01
 2.69931455e+01 2.99195561e+01 3.68741515e-01 1.19551919e+00
 1.02440691e+00 2.57258302e+00 2.45926778e+00 4.96157303e+00
 4.05380777e+00 1.67808259e+01 1.41905639e+01 8.03496446e+01
 6.91026071e+01 5.81235904e+02 3.44727530e-01 7.70600616e-01
 1.22714087e+00 3.76792648e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99797027339152
cond(S) = 312.73066403503634
E1 = -183.57430872469425  E_coul = 55.07734146280863
init E= -128.496967261886
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773836493871103  LUMO = 1.11797144039703
  mo_energy =
[-3.25553963e+01 -1.85289019e+00 -7.73836494e-01 -7.73836494e-01
 -7.73836494e-01  1.11797144e+00  1.18742641e+00  1.18742641e+00
  1.18742641e+00  6.29882589e+00  6.29882589e+00  6.29882589e+00
  6.45297482e+00  2.74254193e+01  2.74254193e+01  2.74254193e+01
  3.23339276e+01  1.35975965e+02  1.48507634e+02  1.48507634e+02
  1.48507634e+02  5.00303460e+02  1.86826098e+03  7.99822815e+03
  4.77662508e+04]
E1 = -182.12752008119725  E_coul = 53.60015763619948
cycle= 1 E= -128.527362444998  delta_E= -0.0304  |g|= 0.199  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435889
diis-c [-0.18999946  1.        ]
  HOMO = -0.877985785494157  LUMO = 1.08002197289034
  mo_energy =
[-3.28706159e+01 -1.96148016e+00 -8.77985785e-01 -8.77985785e-01
 -8.77985785e-01  1.08002197e+00  1.14681703e+00  1.14681703e+00
  1.14681703e+00  6.16325625e+00  6.16325625e+00  6.16325625e+00
  6.33725266e+00  2.71829774e+01  2.71829774e+01  2.71829774e+01
  3.20965336e+01  1.35665554e+02  1.48180913e+02  1.48180913e+02
  1.48180913e+02  4.99949293e+02  1.86787079e+03  7.99780896e+03
  4.77658127e+04]
E1 = -182.84598933421123  E_coul = 54.31617721160439
cycle= 2 E= -128.529812122607  delta_E= -0.00245  |g|= 0.0982  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215903
diis-c [-5.76949823e-04  3.30203361e-01  6.69796639e-01]
  HOMO = -0.844210693775258  LUMO = 1.09233254623551
  mo_energy =
[-3.27671030e+01 -1.92597717e+00 -8.44210694e-01 -8.44210694e-01
 -8.44210694e-01  1.09233255e+00  1.16010728e+00  1.16010728e+00
  1.16010728e+00  6.20729713e+00  6.20729713e+00  6.20729713e+00
  6.37479206e+00  2.72627736e+01  2.72627736e+01  2.72627736e+01
  3.21748778e+01  1.35767254e+02  1.48286975e+02  1.48286975e+02
  1.48286975e+02  5.00061404e+02  1.86798799e+03  7.99792855e+03
  4.77659332e+04]
E1 = -182.60583620934412  E_coul = 54.07520887388191
cycle= 3 E= -128.530627335462  delta_E= -0.000815  |g|= 0.000524  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107387
diis-c [-1.14330480e-07 -2.23420595e-03  2.22631451e-04  1.00201157e+00]
  HOMO = -0.844467863152864  LUMO = 1.09227407786643
  mo_energy =
[-3.27675758e+01 -1.92617112e+00 -8.44467863e-01 -8.44467863e-01
 -8.44467863e-01  1.09227408e+00  1.16004368e+00  1.16004368e+00
  1.16004368e+00  6.20705046e+00  6.20705046e+00  6.20705046e+00
  6.37458381e+00  2.72623870e+01  2.72623870e+01  2.72623870e+01
  3.21745078e+01  1.35766782e+02  1.48286473e+02  1.48286473e+02
  1.48286473e+02  5.00060827e+02  1.86798730e+03  7.99792777e+03
  4.77659324e+04]
E1 = -182.606544166711  E_coul = 54.075916807896164
cycle= 4 E= -128.530627358815  delta_E= -2.34e-08  |g|= 6.44e-05  |ddm|= 0.000255
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135881
diis-c [-8.04040770e-10  3.20488114e-04  3.56282684e-04 -2.03703309e-01
  1.20302654e+00]
  HOMO = -0.84449898498563  LUMO = 1.09226584224073
  mo_energy =
[-3.27676300e+01 -1.92618991e+00 -8.44498985e-01 -8.44498985e-01
 -8.44498985e-01  1.09226584e+00  1.16003025e+00  1.16003025e+00
  1.16003025e+00  6.20701430e+00  6.20701430e+00  6.20701430e+00
  6.37455559e+00  2.72623386e+01  2.72623386e+01  2.72623386e+01
  3.21744615e+01  1.35766728e+02  1.48286416e+02  1.48286416e+02
  1.48286416e+02  5.00060764e+02  1.86798723e+03  7.99792770e+03
  4.77659323e+04]
E1 = -182.60665987587657  E_coul = 54.076032516537666
cycle= 5 E= -128.530627359339  delta_E= -5.24e-10  |g|= 5.83e-06  |ddm|= 4.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60665987587657  E_coul = 54.076032516537666
  HOMO = -0.84449591915875  LUMO = 1.09226756386078
  mo_energy =
[-3.27676235e+01 -1.92618612e+00 -8.44495919e-01 -8.44495919e-01
 -8.44495919e-01  1.09226756e+00  1.16003164e+00  1.16003164e+00
  1.16003164e+00  6.20701821e+00  6.20701821e+00  6.20701821e+00
  6.37455945e+00  2.72623444e+01  2.72623444e+01  2.72623444e+01
  3.21744673e+01  1.35766734e+02  1.48286423e+02  1.48286423e+02
  1.48286423e+02  5.00060770e+02  1.86798724e+03  7.99792770e+03
  4.77659323e+04]
E1 = -182.6066457509244  E_coul = 54.076018391583105
Extra cycle  E= -128.530627359341  delta_E= -2.39e-12  |g|= 1.99e-06  |ddm|= 1.89e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273031e+02 2.35714707e+02
 7.65297593e+01 9.81730496e+00 2.69931455e+01 3.68741515e-01
 1.02440691e+00 2.45926778e+00 4.05380777e+00 1.41905639e+01
 6.91026071e+01 3.44727530e-01 1.22714087e+00]
E = -128.53062735934128
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45436794        1
[INPUT] 0    0    [1    /1   ]  833.27303136         1
[INPUT] 0    0    [1    /1   ]  235.714707222        1
[INPUT] 0    0    [1    /1   ]  76.5297592784        1
[INPUT] 0    0    [1    /1   ]  9.81730496268        1
[INPUT] 0    0    [1    /1   ]  26.9931455066        1
[INPUT] 0    0    [1    /1   ]  0.368741514711       1
[INPUT] 0    0    [1    /1   ]  1.02440691293        1
[INPUT] 0    0    [1    /1   ]  2.45926777516        1
[INPUT] 1    0    [1    /1   ]  4.05380776991        1
[INPUT] 1    0    [1    /1   ]  14.1905639114        1
[INPUT] 1    0    [1    /1   ]  69.1026071214        1
[INPUT] 1    0    [1    /1   ]  0.344727529932       1
[INPUT] 1    0    [1    /1   ]  1.22714087445        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413194731, 1.0]], [0, [3661.454367941887, 1.0]], [0, [833.2730313600955, 1.0]], [0, [235.71470722198737, 1.0]], [0, [76.52975927837022, 1.0]], [0, [9.817304962677616, 1.0]], [0, [26.993145506606385, 1.0]], [0, [0.36874151471061933, 1.0]], [0, [1.024406912925244, 1.0]], [0, [2.4592677751607788, 1.0]], [1, [4.0538077699080075, 1.0]], [1, [14.190563911430983, 1.0]], [1, [69.10260712135948, 1.0]], [1, [0.34472752993165395, 1.0]], [1, [1.2271408744539154, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413195]
bas 1, expnt(s) = [3661.45436794]
bas 2, expnt(s) = [833.27303136]
bas 3, expnt(s) = [235.71470722]
bas 4, expnt(s) = [76.52975928]
bas 5, expnt(s) = [9.81730496]
bas 6, expnt(s) = [26.99314551]
bas 7, expnt(s) = [0.36874151]
bas 8, expnt(s) = [1.02440691]
bas 9, expnt(s) = [2.45926778]
bas 10, expnt(s) = [4.05380777]
bas 11, expnt(s) = [14.19056391]
bas 12, expnt(s) = [69.10260712]
bas 13, expnt(s) = [0.34472753]
bas 14, expnt(s) = [1.22714087]
CPU time:       170.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273031e+02 3.91837069e+02 2.35714707e+02 1.51986507e+02
 7.65297593e+01 6.53713998e+01 9.81730496e+00 1.40122938e+01
 2.69931455e+01 2.99195561e+01 3.68741515e-01 1.19551919e+00
 1.02440691e+00 2.57258302e+00 2.45926778e+00 4.96157303e+00
 4.05380777e+00 1.67808259e+01 1.41905639e+01 8.03496446e+01
 6.91026071e+01 5.81235904e+02 3.44727530e-01 7.70600616e-01
 1.22714087e+00 3.76792648e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99797027339152
cond(S) = 312.73066403503634
E1 = -183.57430872469425  E_coul = 55.07734146280863
init E= -128.496967261886
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773836493871103  LUMO = 1.11797144039703
  mo_energy =
[-3.25553963e+01 -1.85289019e+00 -7.73836494e-01 -7.73836494e-01
 -7.73836494e-01  1.11797144e+00  1.18742641e+00  1.18742641e+00
  1.18742641e+00  6.29882589e+00  6.29882589e+00  6.29882589e+00
  6.45297482e+00  2.74254193e+01  2.74254193e+01  2.74254193e+01
  3.23339276e+01  1.35975965e+02  1.48507634e+02  1.48507634e+02
  1.48507634e+02  5.00303460e+02  1.86826098e+03  7.99822815e+03
  4.77662508e+04]
E1 = -182.12752008119725  E_coul = 53.60015763619948
cycle= 1 E= -128.527362444998  delta_E= -0.0304  |g|= 0.199  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435889
diis-c [-0.18999946  1.        ]
  HOMO = -0.877985785494157  LUMO = 1.08002197289034
  mo_energy =
[-3.28706159e+01 -1.96148016e+00 -8.77985785e-01 -8.77985785e-01
 -8.77985785e-01  1.08002197e+00  1.14681703e+00  1.14681703e+00
  1.14681703e+00  6.16325625e+00  6.16325625e+00  6.16325625e+00
  6.33725266e+00  2.71829774e+01  2.71829774e+01  2.71829774e+01
  3.20965336e+01  1.35665554e+02  1.48180913e+02  1.48180913e+02
  1.48180913e+02  4.99949293e+02  1.86787079e+03  7.99780896e+03
  4.77658127e+04]
E1 = -182.84598933421123  E_coul = 54.31617721160439
cycle= 2 E= -128.529812122607  delta_E= -0.00245  |g|= 0.0982  |ddm|= 0.0704
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.215903
diis-c [-5.76949823e-04  3.30203361e-01  6.69796639e-01]
  HOMO = -0.844210693775258  LUMO = 1.09233254623551
  mo_energy =
[-3.27671030e+01 -1.92597717e+00 -8.44210694e-01 -8.44210694e-01
 -8.44210694e-01  1.09233255e+00  1.16010728e+00  1.16010728e+00
  1.16010728e+00  6.20729713e+00  6.20729713e+00  6.20729713e+00
  6.37479206e+00  2.72627736e+01  2.72627736e+01  2.72627736e+01
  3.21748778e+01  1.35767254e+02  1.48286975e+02  1.48286975e+02
  1.48286975e+02  5.00061404e+02  1.86798799e+03  7.99792855e+03
  4.77659332e+04]
E1 = -182.60583620934412  E_coul = 54.07520887388191
cycle= 3 E= -128.530627335462  delta_E= -0.000815  |g|= 0.000524  |ddm|= 0.0241
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00107387
diis-c [-1.14330480e-07 -2.23420595e-03  2.22631451e-04  1.00201157e+00]
  HOMO = -0.844467863152864  LUMO = 1.09227407786643
  mo_energy =
[-3.27675758e+01 -1.92617112e+00 -8.44467863e-01 -8.44467863e-01
 -8.44467863e-01  1.09227408e+00  1.16004368e+00  1.16004368e+00
  1.16004368e+00  6.20705046e+00  6.20705046e+00  6.20705046e+00
  6.37458381e+00  2.72623870e+01  2.72623870e+01  2.72623870e+01
  3.21745078e+01  1.35766782e+02  1.48286473e+02  1.48286473e+02
  1.48286473e+02  5.00060827e+02  1.86798730e+03  7.99792777e+03
  4.77659324e+04]
E1 = -182.606544166711  E_coul = 54.075916807896164
cycle= 4 E= -128.530627358815  delta_E= -2.34e-08  |g|= 6.44e-05  |ddm|= 0.000255
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000135881
diis-c [-8.04040770e-10  3.20488114e-04  3.56282684e-04 -2.03703309e-01
  1.20302654e+00]
  HOMO = -0.84449898498563  LUMO = 1.09226584224073
  mo_energy =
[-3.27676300e+01 -1.92618991e+00 -8.44498985e-01 -8.44498985e-01
 -8.44498985e-01  1.09226584e+00  1.16003025e+00  1.16003025e+00
  1.16003025e+00  6.20701430e+00  6.20701430e+00  6.20701430e+00
  6.37455559e+00  2.72623386e+01  2.72623386e+01  2.72623386e+01
  3.21744615e+01  1.35766728e+02  1.48286416e+02  1.48286416e+02
  1.48286416e+02  5.00060764e+02  1.86798723e+03  7.99792770e+03
  4.77659323e+04]
E1 = -182.60665987587657  E_coul = 54.076032516537666
cycle= 5 E= -128.530627359339  delta_E= -5.24e-10  |g|= 5.83e-06  |ddm|= 4.35e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.60665987587657  E_coul = 54.076032516537666
  HOMO = -0.84449591915875  LUMO = 1.09226756386078
  mo_energy =
[-3.27676235e+01 -1.92618612e+00 -8.44495919e-01 -8.44495919e-01
 -8.44495919e-01  1.09226756e+00  1.16003164e+00  1.16003164e+00
  1.16003164e+00  6.20701821e+00  6.20701821e+00  6.20701821e+00
  6.37455945e+00  2.72623444e+01  2.72623444e+01  2.72623444e+01
  3.21744673e+01  1.35766734e+02  1.48286423e+02  1.48286423e+02
  1.48286423e+02  5.00060770e+02  1.86798724e+03  7.99792770e+03
  4.77659323e+04]
E1 = -182.6066457509244  E_coul = 54.076018391583105
Extra cycle  E= -128.530627359341  delta_E= -2.39e-12  |g|= 1.99e-06  |ddm|= 1.89e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 312.73066403503634
E1 = -182.6066457509244  E_coul = 54.076018391583105
init E= -128.530627359341
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.844496910001689  LUMO = 1.09226728514297
  mo_energy =
[-3.27676267e+01 -1.92618704e+00 -8.44496910e-01 -8.44496910e-01
 -8.44496910e-01  1.09226729e+00  1.16003126e+00  1.16003126e+00
  1.16003126e+00  6.20701692e+00  6.20701692e+00  6.20701692e+00
  6.37455843e+00  2.72623420e+01  2.72623420e+01  2.72623420e+01
  3.21744649e+01  1.35766731e+02  1.48286419e+02  1.48286419e+02
  1.48286419e+02  5.00060767e+02  1.86798723e+03  7.99792770e+03
  4.77659323e+04]
E1 = -182.60665333160503  E_coul = 54.07602597226362
cycle= 1 E= -128.530627359341  delta_E= -1.14e-13  |g|= 1.04e-06  |ddm|= 7.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60665333160503  E_coul = 54.07602597226362
  HOMO = -0.844496379008509  LUMO = 1.09226749337328
  mo_energy =
[-3.27676251e+01 -1.92618646e+00 -8.44496379e-01 -8.44496379e-01
 -8.44496379e-01  1.09226749e+00  1.16003147e+00  1.16003147e+00
  1.16003147e+00  6.20701762e+00  6.20701762e+00  6.20701762e+00
  6.37455903e+00  2.72623433e+01  2.72623433e+01  2.72623433e+01
  3.21744662e+01  1.35766732e+02  1.48286421e+02  1.48286421e+02
  1.48286421e+02  5.00060768e+02  1.86798724e+03  7.99792770e+03
  4.77659323e+04]
E1 = -182.60664958724246  E_coul = 54.076022227900864
Extra cycle  E= -128.530627359342  delta_E= -1.99e-13  |g|= 5.1e-07  |ddm|= 3.83e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273031e+02 2.35714707e+02
 7.65297593e+01 9.81730496e+00 2.69931455e+01 3.68741515e-01
 1.02440691e+00 2.45926778e+00 4.05380777e+00 1.41905639e+01
 6.91026071e+01 3.44727530e-01 1.22714087e+00]
grad_E = [-3.13597801e-10  1.69692812e-08 -3.64849760e-07  5.49630826e-06
 -5.93586557e-05 -7.69747816e-04  3.91860927e-04 -1.03509473e-03
  1.82975870e-03 -9.74364181e-04  2.83474611e-03 -8.50467055e-04
  1.73183470e-04 -4.99752777e-03 -2.60002474e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.4543662         1
[INPUT] 0    0    [1    /1   ]  833.273066369        1
[INPUT] 0    0    [1    /1   ]  235.71426612         1
[INPUT] 0    0    [1    /1   ]  76.5333937005        1
[INPUT] 0    0    [1    /1   ]  9.86742975573        1
[INPUT] 0    0    [1    /1   ]  26.9724259346        1
[INPUT] 0    0    [1    /1   ]  0.362518429342       1
[INPUT] 0    0    [1    /1   ]  1.00538084198        1
[INPUT] 0    0    [1    /1   ]  2.43816413654        1
[INPUT] 1    0    [1    /1   ]  4.02300377128        1
[INPUT] 1    0    [1    /1   ]  14.1006757524        1
[INPUT] 1    0    [1    /1   ]  68.7075674229        1
[INPUT] 1    0    [1    /1   ]  0.345293482581       1
[INPUT] 1    0    [1    /1   ]  1.22206070262        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131980463, 1.0]], [0, [3661.454366198404, 1.0]], [0, [833.2730663693925, 1.0]], [0, [235.7142661201011, 1.0]], [0, [76.53339370054333, 1.0]], [0, [9.867429755730686, 1.0]], [0, [26.972425934647806, 1.0]], [0, [0.36251842934177037, 1.0]], [0, [1.0053808419753067, 1.0]], [0, [2.4381641365361766, 1.0]], [1, [4.023003771283948, 1.0]], [1, [14.100675752418566, 1.0]], [1, [68.70756742287055, 1.0]], [1, [0.34529348258148773, 1.0]], [1, [1.2220607026185535, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413198]
bas 1, expnt(s) = [3661.4543662]
bas 2, expnt(s) = [833.27306637]
bas 3, expnt(s) = [235.71426612]
bas 4, expnt(s) = [76.5333937]
bas 5, expnt(s) = [9.86742976]
bas 6, expnt(s) = [26.97242593]
bas 7, expnt(s) = [0.36251843]
bas 8, expnt(s) = [1.00538084]
bas 9, expnt(s) = [2.43816414]
bas 10, expnt(s) = [4.02300377]
bas 11, expnt(s) = [14.10067575]
bas 12, expnt(s) = [68.70756742]
bas 13, expnt(s) = [0.34529348]
bas 14, expnt(s) = [1.2220607]
CPU time:       173.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273066e+02 3.91837081e+02 2.35714266e+02 1.51986294e+02
 7.65333937e+01 6.53737282e+01 9.86742976e+00 1.40659172e+01
 2.69724259e+01 2.99023301e+01 3.62518429e-01 1.18035486e+00
 1.00538084e+00 2.53666419e+00 2.43816414e+00 4.92960621e+00
 4.02300377e+00 1.66215853e+01 1.41006758e+01 7.97139445e+01
 6.87075674e+01 5.77085428e+02 3.45293483e-01 7.72182347e-01
 1.22206070e+00 3.74843830e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997983564868932
cond(S) = 307.8080458974701
E1 = -183.57455530719986  E_coul = 55.07758053343351
init E= -128.496974773766
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773821138829281  LUMO = 1.09126314496895
  mo_energy =
[-3.25553593e+01 -1.85289019e+00 -7.73821139e-01 -7.73821139e-01
 -7.73821139e-01  1.09126314e+00  1.18758559e+00  1.18758559e+00
  1.18758559e+00  6.26652896e+00  6.26652896e+00  6.26652896e+00
  6.34323187e+00  2.72224261e+01  2.72224261e+01  2.72224261e+01
  3.22228441e+01  1.35926303e+02  1.47488147e+02  1.47488147e+02
  1.47488147e+02  5.00264689e+02  1.86822712e+03  7.99819864e+03
  4.77662264e+04]
E1 = -182.13145945938948  E_coul = 53.603996755213856
cycle= 1 E= -128.527462704176  delta_E= -0.0305  |g|= 0.199  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435365
diis-c [-0.18954296  1.        ]
  HOMO = -0.877675419391038  LUMO = 1.05431913315188
  mo_energy =
[-3.28700081e+01 -1.96113971e+00 -8.77675419e-01 -8.77675419e-01
 -8.77675419e-01  1.05431913e+00  1.14720498e+00  1.14720498e+00
  1.14720498e+00  6.13199797e+00  6.13199797e+00  6.13199797e+00
  6.22863675e+00  2.69810535e+01  2.69810535e+01  2.69810535e+01
  3.19857700e+01  1.35616449e+02  1.47162261e+02  1.47162261e+02
  1.47162261e+02  4.99911163e+02  1.86783764e+03  7.99778016e+03
  4.77657891e+04]
E1 = -182.84830842007273  E_coul = 54.318404399222686
cycle= 2 E= -128.52990402085  delta_E= -0.00244  |g|= 0.098  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215587
diis-c [-5.76046852e-04  3.30143822e-01  6.69856178e-01]
  HOMO = -0.843972597655797  LUMO = 1.06633400761247
  mo_energy =
[-3.27667196e+01 -1.92571640e+00 -8.43972598e-01 -8.43972598e-01
 -8.43972598e-01  1.06633401e+00  1.16043441e+00  1.16043441e+00
  1.16043441e+00  6.17572791e+00  6.17572791e+00  6.17572791e+00
  6.26583544e+00  2.70605003e+01  2.70605003e+01  2.70605003e+01
  3.20640118e+01  1.35717946e+02  1.47268039e+02  1.47268039e+02
  1.47268039e+02  5.00023037e+02  1.86795460e+03  7.99789950e+03
  4.77659093e+04]
E1 = -182.60887349203782  E_coul = 54.078158463522925
cycle= 3 E= -128.530715028515  delta_E= -0.000811  |g|= 0.000509  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104438
diis-c [-1.20093005e-07 -2.21305580e-03  1.11850414e-04  1.00210121e+00]
  HOMO = -0.844221288066233  LUMO = 1.06628229744952
  mo_energy =
[-3.27671761e+01 -1.92589900e+00 -8.44221288e-01 -8.44221288e-01
 -8.44221288e-01  1.06628230e+00  1.16037466e+00  1.16037466e+00
  1.16037466e+00  6.17549314e+00  6.17549314e+00  6.17549314e+00
  6.26563927e+00  2.70601296e+01  2.70601296e+01  2.70601296e+01
  3.20636565e+01  1.35717491e+02  1.47267555e+02  1.47267555e+02
  1.47267555e+02  5.00022479e+02  1.86795393e+03  7.99789874e+03
  4.77659085e+04]
E1 = -182.60954845580733  E_coul = 54.07883340430077
cycle= 4 E= -128.530715051507  delta_E= -2.3e-08  |g|= 6.49e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136939
diis-c [-8.24788060e-10  3.34985036e-04  3.80686171e-04 -2.12162397e-01
  1.21144673e+00]
  HOMO = -0.844252242133784  LUMO = 1.06627475532051
  mo_energy =
[-3.27672299e+01 -1.92591678e+00 -8.44252242e-01 -8.44252242e-01
 -8.44252242e-01  1.06627476e+00  1.16036136e+00  1.16036136e+00
  1.16036136e+00  6.17545746e+00  6.17545746e+00  6.17545746e+00
  6.26561190e+00  2.70600817e+01  2.70600817e+01  2.70600817e+01
  3.20636107e+01  1.35717437e+02  1.47267499e+02  1.47267499e+02
  1.47267499e+02  5.00022417e+02  1.86795386e+03  7.99789867e+03
  4.77659084e+04]
E1 = -182.60966328953873  E_coul = 54.07894823747654
cycle= 5 E= -128.530715052062  delta_E= -5.56e-10  |g|= 5.92e-06  |ddm|= 4.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60966328953873  E_coul = 54.07894823747654
  HOMO = -0.844249072412436  LUMO = 1.06627647171717
  mo_energy =
[-3.27672233e+01 -1.92591292e+00 -8.44249072e-01 -8.44249072e-01
 -8.44249072e-01  1.06627647e+00  1.16036279e+00  1.16036279e+00
  1.16036279e+00  6.17546147e+00  6.17546147e+00  6.17546147e+00
  6.26561584e+00  2.70600876e+01  2.70600876e+01  2.70600876e+01
  3.20636167e+01  1.35717443e+02  1.47267505e+02  1.47267505e+02
  1.47267505e+02  5.00022423e+02  1.86795386e+03  7.99789867e+03
  4.77659084e+04]
E1 = -182.60964874817694  E_coul = 54.078933696112365
Extra cycle  E= -128.530715052065  delta_E= -2.39e-12  |g|= 2.04e-06  |ddm|= 1.91e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273066e+02 2.35714266e+02
 7.65333937e+01 9.86742976e+00 2.69724259e+01 3.62518429e-01
 1.00538084e+00 2.43816414e+00 4.02300377e+00 1.41006758e+01
 6.87075674e+01 3.45293483e-01 1.22206070e+00]
E = -128.53071505206458
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.4543662         1
[INPUT] 0    0    [1    /1   ]  833.273066369        1
[INPUT] 0    0    [1    /1   ]  235.71426612         1
[INPUT] 0    0    [1    /1   ]  76.5333937005        1
[INPUT] 0    0    [1    /1   ]  9.86742975573        1
[INPUT] 0    0    [1    /1   ]  26.9724259346        1
[INPUT] 0    0    [1    /1   ]  0.362518429342       1
[INPUT] 0    0    [1    /1   ]  1.00538084198        1
[INPUT] 0    0    [1    /1   ]  2.43816413654        1
[INPUT] 1    0    [1    /1   ]  4.02300377128        1
[INPUT] 1    0    [1    /1   ]  14.1006757524        1
[INPUT] 1    0    [1    /1   ]  68.7075674229        1
[INPUT] 1    0    [1    /1   ]  0.345293482581       1
[INPUT] 1    0    [1    /1   ]  1.22206070262        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131980463, 1.0]], [0, [3661.454366198404, 1.0]], [0, [833.2730663693925, 1.0]], [0, [235.7142661201011, 1.0]], [0, [76.53339370054333, 1.0]], [0, [9.867429755730686, 1.0]], [0, [26.972425934647806, 1.0]], [0, [0.36251842934177037, 1.0]], [0, [1.0053808419753067, 1.0]], [0, [2.4381641365361766, 1.0]], [1, [4.023003771283948, 1.0]], [1, [14.100675752418566, 1.0]], [1, [68.70756742287055, 1.0]], [1, [0.34529348258148773, 1.0]], [1, [1.2220607026185535, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413198]
bas 1, expnt(s) = [3661.4543662]
bas 2, expnt(s) = [833.27306637]
bas 3, expnt(s) = [235.71426612]
bas 4, expnt(s) = [76.5333937]
bas 5, expnt(s) = [9.86742976]
bas 6, expnt(s) = [26.97242593]
bas 7, expnt(s) = [0.36251843]
bas 8, expnt(s) = [1.00538084]
bas 9, expnt(s) = [2.43816414]
bas 10, expnt(s) = [4.02300377]
bas 11, expnt(s) = [14.10067575]
bas 12, expnt(s) = [68.70756742]
bas 13, expnt(s) = [0.34529348]
bas 14, expnt(s) = [1.2220607]
CPU time:       174.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273066e+02 3.91837081e+02 2.35714266e+02 1.51986294e+02
 7.65333937e+01 6.53737282e+01 9.86742976e+00 1.40659172e+01
 2.69724259e+01 2.99023301e+01 3.62518429e-01 1.18035486e+00
 1.00538084e+00 2.53666419e+00 2.43816414e+00 4.92960621e+00
 4.02300377e+00 1.66215853e+01 1.41006758e+01 7.97139445e+01
 6.87075674e+01 5.77085428e+02 3.45293483e-01 7.72182347e-01
 1.22206070e+00 3.74843830e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997983564868932
cond(S) = 307.8080458974701
E1 = -183.57455530719986  E_coul = 55.07758053343351
init E= -128.496974773766
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773821138829281  LUMO = 1.09126314496895
  mo_energy =
[-3.25553593e+01 -1.85289019e+00 -7.73821139e-01 -7.73821139e-01
 -7.73821139e-01  1.09126314e+00  1.18758559e+00  1.18758559e+00
  1.18758559e+00  6.26652896e+00  6.26652896e+00  6.26652896e+00
  6.34323187e+00  2.72224261e+01  2.72224261e+01  2.72224261e+01
  3.22228441e+01  1.35926303e+02  1.47488147e+02  1.47488147e+02
  1.47488147e+02  5.00264689e+02  1.86822712e+03  7.99819864e+03
  4.77662264e+04]
E1 = -182.13145945938948  E_coul = 53.603996755213856
cycle= 1 E= -128.527462704176  delta_E= -0.0305  |g|= 0.199  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435365
diis-c [-0.18954296  1.        ]
  HOMO = -0.877675419391038  LUMO = 1.05431913315188
  mo_energy =
[-3.28700081e+01 -1.96113971e+00 -8.77675419e-01 -8.77675419e-01
 -8.77675419e-01  1.05431913e+00  1.14720498e+00  1.14720498e+00
  1.14720498e+00  6.13199797e+00  6.13199797e+00  6.13199797e+00
  6.22863675e+00  2.69810535e+01  2.69810535e+01  2.69810535e+01
  3.19857700e+01  1.35616449e+02  1.47162261e+02  1.47162261e+02
  1.47162261e+02  4.99911163e+02  1.86783764e+03  7.99778016e+03
  4.77657891e+04]
E1 = -182.84830842007273  E_coul = 54.318404399222686
cycle= 2 E= -128.52990402085  delta_E= -0.00244  |g|= 0.098  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215587
diis-c [-5.76046852e-04  3.30143822e-01  6.69856178e-01]
  HOMO = -0.843972597655797  LUMO = 1.06633400761247
  mo_energy =
[-3.27667196e+01 -1.92571640e+00 -8.43972598e-01 -8.43972598e-01
 -8.43972598e-01  1.06633401e+00  1.16043441e+00  1.16043441e+00
  1.16043441e+00  6.17572791e+00  6.17572791e+00  6.17572791e+00
  6.26583544e+00  2.70605003e+01  2.70605003e+01  2.70605003e+01
  3.20640118e+01  1.35717946e+02  1.47268039e+02  1.47268039e+02
  1.47268039e+02  5.00023037e+02  1.86795460e+03  7.99789950e+03
  4.77659093e+04]
E1 = -182.60887349203782  E_coul = 54.078158463522925
cycle= 3 E= -128.530715028515  delta_E= -0.000811  |g|= 0.000509  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104438
diis-c [-1.20093005e-07 -2.21305580e-03  1.11850414e-04  1.00210121e+00]
  HOMO = -0.844221288066233  LUMO = 1.06628229744952
  mo_energy =
[-3.27671761e+01 -1.92589900e+00 -8.44221288e-01 -8.44221288e-01
 -8.44221288e-01  1.06628230e+00  1.16037466e+00  1.16037466e+00
  1.16037466e+00  6.17549314e+00  6.17549314e+00  6.17549314e+00
  6.26563927e+00  2.70601296e+01  2.70601296e+01  2.70601296e+01
  3.20636565e+01  1.35717491e+02  1.47267555e+02  1.47267555e+02
  1.47267555e+02  5.00022479e+02  1.86795393e+03  7.99789874e+03
  4.77659085e+04]
E1 = -182.60954845580733  E_coul = 54.07883340430077
cycle= 4 E= -128.530715051507  delta_E= -2.3e-08  |g|= 6.49e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136939
diis-c [-8.24788060e-10  3.34985036e-04  3.80686171e-04 -2.12162397e-01
  1.21144673e+00]
  HOMO = -0.844252242133784  LUMO = 1.06627475532051
  mo_energy =
[-3.27672299e+01 -1.92591678e+00 -8.44252242e-01 -8.44252242e-01
 -8.44252242e-01  1.06627476e+00  1.16036136e+00  1.16036136e+00
  1.16036136e+00  6.17545746e+00  6.17545746e+00  6.17545746e+00
  6.26561190e+00  2.70600817e+01  2.70600817e+01  2.70600817e+01
  3.20636107e+01  1.35717437e+02  1.47267499e+02  1.47267499e+02
  1.47267499e+02  5.00022417e+02  1.86795386e+03  7.99789867e+03
  4.77659084e+04]
E1 = -182.60966328953873  E_coul = 54.07894823747654
cycle= 5 E= -128.530715052062  delta_E= -5.56e-10  |g|= 5.92e-06  |ddm|= 4.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60966328953873  E_coul = 54.07894823747654
  HOMO = -0.844249072412436  LUMO = 1.06627647171717
  mo_energy =
[-3.27672233e+01 -1.92591292e+00 -8.44249072e-01 -8.44249072e-01
 -8.44249072e-01  1.06627647e+00  1.16036279e+00  1.16036279e+00
  1.16036279e+00  6.17546147e+00  6.17546147e+00  6.17546147e+00
  6.26561584e+00  2.70600876e+01  2.70600876e+01  2.70600876e+01
  3.20636167e+01  1.35717443e+02  1.47267505e+02  1.47267505e+02
  1.47267505e+02  5.00022423e+02  1.86795386e+03  7.99789867e+03
  4.77659084e+04]
E1 = -182.60964874817694  E_coul = 54.078933696112365
Extra cycle  E= -128.530715052065  delta_E= -2.39e-12  |g|= 2.04e-06  |ddm|= 1.91e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 307.8080458974701
E1 = -182.60964874817694  E_coul = 54.078933696112365
init E= -128.530715052065
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.844250089504141  LUMO = 1.06627618709442
  mo_energy =
[-3.27672265e+01 -1.92591388e+00 -8.44250090e-01 -8.44250090e-01
 -8.44250090e-01  1.06627619e+00  1.16036240e+00  1.16036240e+00
  1.16036240e+00  6.17546015e+00  6.17546015e+00  6.17546015e+00
  6.26561479e+00  2.70600852e+01  2.70600852e+01  2.70600852e+01
  3.20636143e+01  1.35717440e+02  1.47267502e+02  1.47267502e+02
  1.47267502e+02  5.00022419e+02  1.86795386e+03  7.99789867e+03
  4.77659084e+04]
E1 = -182.6096565443547  E_coul = 54.0789414922901
cycle= 1 E= -128.530715052065  delta_E=    0  |g|= 1.07e-06  |ddm|= 7.96e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6096565443547  E_coul = 54.0789414922901
  HOMO = -0.844249542824209  LUMO = 1.06627639556675
  mo_energy =
[-3.27672249e+01 -1.92591328e+00 -8.44249543e-01 -8.44249543e-01
 -8.44249543e-01  1.06627640e+00  1.16036262e+00  1.16036262e+00
  1.16036262e+00  6.17546087e+00  6.17546087e+00  6.17546087e+00
  6.26561541e+00  2.70600865e+01  2.70600865e+01  2.70600865e+01
  3.20636156e+01  1.35717442e+02  1.47267504e+02  1.47267504e+02
  1.47267504e+02  5.00022421e+02  1.86795386e+03  7.99789867e+03
  4.77659084e+04]
E1 = -182.60965269529305  E_coul = 54.078937643228244
Extra cycle  E= -128.530715052065  delta_E= -2.27e-13  |g|= 5.24e-07  |ddm|= 3.92e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273066e+02 2.35714266e+02
 7.65333937e+01 9.86742976e+00 2.69724259e+01 3.62518429e-01
 1.00538084e+00 2.43816414e+00 4.02300377e+00 1.41006758e+01
 6.87075674e+01 3.45293483e-01 1.22206070e+00]
grad_E = [ 3.12674030e-10 -1.59164489e-08  2.94506350e-07 -2.32210471e-06
  6.55089429e-07 -1.29538472e-04  1.00750068e-04 -9.62662534e-04
  1.20348899e-03 -9.64132601e-04  1.96348514e-03 -7.45219902e-04
  1.73574719e-04  2.10731528e-03 -2.85896483e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436513        1
[INPUT] 0    0    [1    /1   ]  833.273087871        1
[INPUT] 0    0    [1    /1   ]  235.713988846        1
[INPUT] 0    0    [1    /1   ]  76.5357865151        1
[INPUT] 0    0    [1    /1   ]  9.90802247536        1
[INPUT] 0    0    [1    /1   ]  26.957639473         1
[INPUT] 0    0    [1    /1   ]  0.361785998595       1
[INPUT] 0    0    [1    /1   ]  1.00155948036        1
[INPUT] 0    0    [1    /1   ]  2.41667146187        1
[INPUT] 1    0    [1    /1   ]  3.99927504731        1
[INPUT] 1    0    [1    /1   ]  14.0586337896        1
[INPUT] 1    0    [1    /1   ]  68.0854352604        1
[INPUT] 1    0    [1    /1   ]  0.345552683933       1
[INPUT] 1    0    [1    /1   ]  1.21788706264        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794132000978, 1.0]], [0, [3661.4543651334757, 1.0]], [0, [833.273087871455, 1.0]], [0, [235.7139888461892, 1.0]], [0, [76.53578651512146, 1.0]], [0, [9.90802247535985, 1.0]], [0, [26.957639473003567, 1.0]], [0, [0.3617859985946147, 1.0]], [0, [1.0015594803615242, 1.0]], [0, [2.4166714618659157, 1.0]], [1, [3.999275047310162, 1.0]], [1, [14.058633789603007, 1.0]], [1, [68.08543526043299, 1.0]], [1, [0.3455526839327076, 1.0]], [1, [1.2178870626408242, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.794132]
bas 1, expnt(s) = [3661.45436513]
bas 2, expnt(s) = [833.27308787]
bas 3, expnt(s) = [235.71398885]
bas 4, expnt(s) = [76.53578652]
bas 5, expnt(s) = [9.90802248]
bas 6, expnt(s) = [26.95763947]
bas 7, expnt(s) = [0.361786]
bas 8, expnt(s) = [1.00155948]
bas 9, expnt(s) = [2.41667146]
bas 10, expnt(s) = [3.99927505]
bas 11, expnt(s) = [14.05863379]
bas 12, expnt(s) = [68.08543526]
bas 13, expnt(s) = [0.34555268]
bas 14, expnt(s) = [1.21788706]
CPU time:       177.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273088e+02 3.91837089e+02 2.35713989e+02 1.51986160e+02
 7.65357865e+01 6.53752611e+01 9.90802248e+00 1.41092933e+01
 2.69576395e+01 2.98900347e+01 3.61785999e-01 1.17856582e+00
 1.00155948e+00 2.52942953e+00 2.41667146e+00 4.89697892e+00
 3.99927505e+00 1.64991277e+01 1.40586338e+01 7.94169658e+01
 6.80854353e+01 5.70561109e+02 3.45552684e-01 7.72906982e-01
 1.21788706e+00 3.73244283e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997990506837631
cond(S) = 307.59340546018484
E1 = -183.57460178381376  E_coul = 55.077703082924685
init E= -128.496898700889
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773825812066961  LUMO = 1.08652322438831
  mo_energy =
[-3.25553211e+01 -1.85288211e+00 -7.73825812e-01 -7.73825812e-01
 -7.73825812e-01  1.08652322e+00  1.18714384e+00  1.18714384e+00
  1.18714384e+00  6.23951241e+00  6.23951241e+00  6.23951241e+00
  6.30249376e+00  2.70956514e+01  2.70956514e+01  2.70956514e+01
  3.21852924e+01  1.35934371e+02  1.46274076e+02  1.46274076e+02
  1.46274076e+02  5.00277903e+02  1.86823978e+03  7.99821000e+03
  4.77662358e+04]
E1 = -182.13406789126847  E_coul = 53.60652161986056
cycle= 1 E= -128.527546271408  delta_E= -0.0306  |g|= 0.198  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434891
diis-c [-0.1891306  1.       ]
  HOMO = -0.877479745754632  LUMO = 1.0498703903751
  mo_energy =
[-3.28695957e+01 -1.96091076e+00 -8.77479746e-01 -8.77479746e-01
 -8.77479746e-01  1.04987039e+00  1.14693192e+00  1.14693192e+00
  1.14693192e+00  6.10575776e+00  6.10575776e+00  6.10575776e+00
  6.18857824e+00  2.68549180e+01  2.68549180e+01  2.68549180e+01
  3.19484865e+01  1.35624904e+02  1.45948945e+02  1.45948945e+02
  1.45948945e+02  4.99924837e+02  1.86785083e+03  7.99779205e+03
  4.77657990e+04]
E1 = -182.8496400355031  E_coul = 54.31965911339391
cycle= 2 E= -128.529980922109  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.07
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2153
diis-c [-5.77046500e-04  3.30085052e-01  6.69914948e-01]
  HOMO = -0.84383395063422  LUMO = 1.06179889578838
  mo_energy =
[-3.27664812e+01 -1.92554871e+00 -8.43833951e-01 -8.43833951e-01
 -8.43833951e-01  1.06179890e+00  1.16010871e+00  1.16010871e+00
  1.16010871e+00  6.14924363e+00  6.14924363e+00  6.14924363e+00
  6.22556404e+00  2.69341360e+01  2.69341360e+01  2.69341360e+01
  3.20266347e+01  1.35726239e+02  1.46054458e+02  1.46054458e+02
  1.46054458e+02  5.00036528e+02  1.86796759e+03  7.99791120e+03
  4.77659191e+04]
E1 = -182.61070808719936  E_coul = 54.07991926643535
cycle= 3 E= -128.530788820764  delta_E= -0.000808  |g|= 0.000506  |ddm|= 0.0239
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00103323
diis-c [-1.21711846e-07 -2.21197213e-03  5.96810387e-05  1.00215229e+00]
  HOMO = -0.844080517442764  LUMO = 1.06174867639634
  mo_energy =
[-3.27669331e+01 -1.92572820e+00 -8.44080517e-01 -8.44080517e-01
 -8.44080517e-01  1.06174868e+00  1.16004979e+00  1.16004979e+00
  1.16004979e+00  6.14901255e+00  6.14901255e+00  6.14901255e+00
  6.22537115e+00  2.69337699e+01  2.69337699e+01  2.69337699e+01
  3.20262836e+01  1.35725790e+02  1.46053980e+02  1.46053980e+02
  1.46053980e+02  5.00035976e+02  1.86796693e+03  7.99791045e+03
  4.77659183e+04]
E1 = -182.61137061763642  E_coul = 54.08058177384481
cycle= 4 E= -128.530788843792  delta_E= -2.3e-08  |g|= 6.52e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000137024
diis-c [-8.32009152e-10  3.40367540e-04  3.90341174e-04 -2.14926556e-01
  1.21419585e+00]
  HOMO = -0.844111452871457  LUMO = 1.06174130788021
  mo_energy =
[-3.27669866e+01 -1.92574567e+00 -8.44111453e-01 -8.44111453e-01
 -8.44111453e-01  1.06174131e+00  1.16003651e+00  1.16003651e+00
  1.16003651e+00  6.14897707e+00  6.14897707e+00  6.14897707e+00
  6.22534404e+00  2.69337223e+01  2.69337223e+01  2.69337223e+01
  3.20262381e+01  1.35725736e+02  1.46053925e+02  1.46053925e+02
  1.46053925e+02  5.00035913e+02  1.86796686e+03  7.99791037e+03
  4.77659182e+04]
E1 = -182.61148451213464  E_coul = 54.08069566777581
cycle= 5 E= -128.530788844359  delta_E= -5.67e-10  |g|= 5.92e-06  |ddm|= 4.63e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61148451213464  E_coul = 54.08069566777581
  HOMO = -0.844108269631621  LUMO = 1.0617430200162
  mo_energy =
[-3.27669800e+01 -1.92574181e+00 -8.44108270e-01 -8.44108270e-01
 -8.44108270e-01  1.06174302e+00  1.16003794e+00  1.16003794e+00
  1.16003794e+00  6.14898109e+00  6.14898109e+00  6.14898109e+00
  6.22534798e+00  2.69337282e+01  2.69337282e+01  2.69337282e+01
  3.20262441e+01  1.35725742e+02  1.46053931e+02  1.46053931e+02
  1.46053931e+02  5.00035920e+02  1.86796687e+03  7.99791038e+03
  4.77659182e+04]
E1 = -182.61147005041752  E_coul = 54.08068120605669
Extra cycle  E= -128.530788844361  delta_E= -2.02e-12  |g|= 2.03e-06  |ddm|= 1.92e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273088e+02 2.35713989e+02
 7.65357865e+01 9.90802248e+00 2.69576395e+01 3.61785999e-01
 1.00155948e+00 2.41667146e+00 3.99927505e+00 1.40586338e+01
 6.80854353e+01 3.45552684e-01 1.21788706e+00]
E = -128.53078884436084
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436513        1
[INPUT] 0    0    [1    /1   ]  833.273087871        1
[INPUT] 0    0    [1    /1   ]  235.713988846        1
[INPUT] 0    0    [1    /1   ]  76.5357865151        1
[INPUT] 0    0    [1    /1   ]  9.90802247536        1
[INPUT] 0    0    [1    /1   ]  26.957639473         1
[INPUT] 0    0    [1    /1   ]  0.361785998595       1
[INPUT] 0    0    [1    /1   ]  1.00155948036        1
[INPUT] 0    0    [1    /1   ]  2.41667146187        1
[INPUT] 1    0    [1    /1   ]  3.99927504731        1
[INPUT] 1    0    [1    /1   ]  14.0586337896        1
[INPUT] 1    0    [1    /1   ]  68.0854352604        1
[INPUT] 1    0    [1    /1   ]  0.345552683933       1
[INPUT] 1    0    [1    /1   ]  1.21788706264        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794132000978, 1.0]], [0, [3661.4543651334757, 1.0]], [0, [833.273087871455, 1.0]], [0, [235.7139888461892, 1.0]], [0, [76.53578651512146, 1.0]], [0, [9.90802247535985, 1.0]], [0, [26.957639473003567, 1.0]], [0, [0.3617859985946147, 1.0]], [0, [1.0015594803615242, 1.0]], [0, [2.4166714618659157, 1.0]], [1, [3.999275047310162, 1.0]], [1, [14.058633789603007, 1.0]], [1, [68.08543526043299, 1.0]], [1, [0.3455526839327076, 1.0]], [1, [1.2178870626408242, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.794132]
bas 1, expnt(s) = [3661.45436513]
bas 2, expnt(s) = [833.27308787]
bas 3, expnt(s) = [235.71398885]
bas 4, expnt(s) = [76.53578652]
bas 5, expnt(s) = [9.90802248]
bas 6, expnt(s) = [26.95763947]
bas 7, expnt(s) = [0.361786]
bas 8, expnt(s) = [1.00155948]
bas 9, expnt(s) = [2.41667146]
bas 10, expnt(s) = [3.99927505]
bas 11, expnt(s) = [14.05863379]
bas 12, expnt(s) = [68.08543526]
bas 13, expnt(s) = [0.34555268]
bas 14, expnt(s) = [1.21788706]
CPU time:       178.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273088e+02 3.91837089e+02 2.35713989e+02 1.51986160e+02
 7.65357865e+01 6.53752611e+01 9.90802248e+00 1.41092933e+01
 2.69576395e+01 2.98900347e+01 3.61785999e-01 1.17856582e+00
 1.00155948e+00 2.52942953e+00 2.41667146e+00 4.89697892e+00
 3.99927505e+00 1.64991277e+01 1.40586338e+01 7.94169658e+01
 6.80854353e+01 5.70561109e+02 3.45552684e-01 7.72906982e-01
 1.21788706e+00 3.73244283e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997990506837631
cond(S) = 307.59340546018484
E1 = -183.57460178381376  E_coul = 55.077703082924685
init E= -128.496898700889
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773825812066961  LUMO = 1.08652322438831
  mo_energy =
[-3.25553211e+01 -1.85288211e+00 -7.73825812e-01 -7.73825812e-01
 -7.73825812e-01  1.08652322e+00  1.18714384e+00  1.18714384e+00
  1.18714384e+00  6.23951241e+00  6.23951241e+00  6.23951241e+00
  6.30249376e+00  2.70956514e+01  2.70956514e+01  2.70956514e+01
  3.21852924e+01  1.35934371e+02  1.46274076e+02  1.46274076e+02
  1.46274076e+02  5.00277903e+02  1.86823978e+03  7.99821000e+03
  4.77662358e+04]
E1 = -182.13406789126847  E_coul = 53.60652161986056
cycle= 1 E= -128.527546271408  delta_E= -0.0306  |g|= 0.198  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434891
diis-c [-0.1891306  1.       ]
  HOMO = -0.877479745754632  LUMO = 1.0498703903751
  mo_energy =
[-3.28695957e+01 -1.96091076e+00 -8.77479746e-01 -8.77479746e-01
 -8.77479746e-01  1.04987039e+00  1.14693192e+00  1.14693192e+00
  1.14693192e+00  6.10575776e+00  6.10575776e+00  6.10575776e+00
  6.18857824e+00  2.68549180e+01  2.68549180e+01  2.68549180e+01
  3.19484865e+01  1.35624904e+02  1.45948945e+02  1.45948945e+02
  1.45948945e+02  4.99924837e+02  1.86785083e+03  7.99779205e+03
  4.77657990e+04]
E1 = -182.8496400355031  E_coul = 54.31965911339391
cycle= 2 E= -128.529980922109  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.07
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2153
diis-c [-5.77046500e-04  3.30085052e-01  6.69914948e-01]
  HOMO = -0.84383395063422  LUMO = 1.06179889578838
  mo_energy =
[-3.27664812e+01 -1.92554871e+00 -8.43833951e-01 -8.43833951e-01
 -8.43833951e-01  1.06179890e+00  1.16010871e+00  1.16010871e+00
  1.16010871e+00  6.14924363e+00  6.14924363e+00  6.14924363e+00
  6.22556404e+00  2.69341360e+01  2.69341360e+01  2.69341360e+01
  3.20266347e+01  1.35726239e+02  1.46054458e+02  1.46054458e+02
  1.46054458e+02  5.00036528e+02  1.86796759e+03  7.99791120e+03
  4.77659191e+04]
E1 = -182.61070808719936  E_coul = 54.07991926643535
cycle= 3 E= -128.530788820764  delta_E= -0.000808  |g|= 0.000506  |ddm|= 0.0239
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00103323
diis-c [-1.21711846e-07 -2.21197213e-03  5.96810387e-05  1.00215229e+00]
  HOMO = -0.844080517442764  LUMO = 1.06174867639634
  mo_energy =
[-3.27669331e+01 -1.92572820e+00 -8.44080517e-01 -8.44080517e-01
 -8.44080517e-01  1.06174868e+00  1.16004979e+00  1.16004979e+00
  1.16004979e+00  6.14901255e+00  6.14901255e+00  6.14901255e+00
  6.22537115e+00  2.69337699e+01  2.69337699e+01  2.69337699e+01
  3.20262836e+01  1.35725790e+02  1.46053980e+02  1.46053980e+02
  1.46053980e+02  5.00035976e+02  1.86796693e+03  7.99791045e+03
  4.77659183e+04]
E1 = -182.61137061763642  E_coul = 54.08058177384481
cycle= 4 E= -128.530788843792  delta_E= -2.3e-08  |g|= 6.52e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000137024
diis-c [-8.32009152e-10  3.40367540e-04  3.90341174e-04 -2.14926556e-01
  1.21419585e+00]
  HOMO = -0.844111452871457  LUMO = 1.06174130788021
  mo_energy =
[-3.27669866e+01 -1.92574567e+00 -8.44111453e-01 -8.44111453e-01
 -8.44111453e-01  1.06174131e+00  1.16003651e+00  1.16003651e+00
  1.16003651e+00  6.14897707e+00  6.14897707e+00  6.14897707e+00
  6.22534404e+00  2.69337223e+01  2.69337223e+01  2.69337223e+01
  3.20262381e+01  1.35725736e+02  1.46053925e+02  1.46053925e+02
  1.46053925e+02  5.00035913e+02  1.86796686e+03  7.99791037e+03
  4.77659182e+04]
E1 = -182.61148451213464  E_coul = 54.08069566777581
cycle= 5 E= -128.530788844359  delta_E= -5.67e-10  |g|= 5.92e-06  |ddm|= 4.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.61148451213464  E_coul = 54.08069566777581
  HOMO = -0.844108269631621  LUMO = 1.0617430200162
  mo_energy =
[-3.27669800e+01 -1.92574181e+00 -8.44108270e-01 -8.44108270e-01
 -8.44108270e-01  1.06174302e+00  1.16003794e+00  1.16003794e+00
  1.16003794e+00  6.14898109e+00  6.14898109e+00  6.14898109e+00
  6.22534798e+00  2.69337282e+01  2.69337282e+01  2.69337282e+01
  3.20262441e+01  1.35725742e+02  1.46053931e+02  1.46053931e+02
  1.46053931e+02  5.00035920e+02  1.86796687e+03  7.99791038e+03
  4.77659182e+04]
E1 = -182.61147005041752  E_coul = 54.08068120605669
Extra cycle  E= -128.530788844361  delta_E= -2.02e-12  |g|= 2.03e-06  |ddm|= 1.92e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 307.59340546018484
E1 = -182.61147005041752  E_coul = 54.08068120605669
init E= -128.530788844361
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.844109279668829  LUMO = 1.0617427387075
  mo_energy =
[-3.27669832e+01 -1.92574276e+00 -8.44109280e-01 -8.44109280e-01
 -8.44109280e-01  1.06174274e+00  1.16003756e+00  1.16003756e+00
  1.16003756e+00  6.14897978e+00  6.14897978e+00  6.14897978e+00
  6.22534695e+00  2.69337258e+01  2.69337258e+01  2.69337258e+01
  3.20262417e+01  1.35725739e+02  1.46053928e+02  1.46053928e+02
  1.46053928e+02  5.00035916e+02  1.86796686e+03  7.99791037e+03
  4.77659182e+04]
E1 = -182.61147781337078  E_coul = 54.08068896900965
cycle= 1 E= -128.530788844361  delta_E= -2.84e-13  |g|= 1.07e-06  |ddm|= 7.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61147781337078  E_coul = 54.08068896900965
  HOMO = -0.844108735093955  LUMO = 1.06174294502608
  mo_energy =
[-3.27669816e+01 -1.92574217e+00 -8.44108735e-01 -8.44108735e-01
 -8.44108735e-01  1.06174295e+00  1.16003778e+00  1.16003778e+00
  1.16003778e+00  6.14898049e+00  6.14898049e+00  6.14898049e+00
  6.22534756e+00  2.69337271e+01  2.69337271e+01  2.69337271e+01
  3.20262429e+01  1.35725741e+02  1.46053930e+02  1.46053930e+02
  1.46053930e+02  5.00035918e+02  1.86796686e+03  7.99791038e+03
  4.77659182e+04]
E1 = -182.61147398341052  E_coul = 54.0806851390491
Extra cycle  E= -128.530788844361  delta_E= -2.84e-13  |g|= 5.21e-07  |ddm|= 3.89e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273088e+02 2.35713989e+02
 7.65357865e+01 9.90802248e+00 2.69576395e+01 3.61785999e-01
 1.00155948e+00 2.41667146e+00 3.99927505e+00 1.40586338e+01
 6.80854353e+01 3.45552684e-01 1.21788706e+00]
grad_E = [ 7.86783526e-10 -4.07404464e-08  7.94464226e-07 -8.21623080e-06
  4.62725613e-05  3.31099136e-04 -1.15024908e-04 -1.22066772e-03
  1.17920543e-03 -1.12457887e-03  4.81404748e-04 -4.14090263e-04
  1.56321821e-04  5.73367655e-03 -1.74537301e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436464        1
[INPUT] 0    0    [1    /1   ]  833.273098088        1
[INPUT] 0    0    [1    /1   ]  235.713846504        1
[INPUT] 0    0    [1    /1   ]  76.5371890804        1
[INPUT] 0    0    [1    /1   ]  9.94275511753        1
[INPUT] 0    0    [1    /1   ]  26.9472722069        1
[INPUT] 0    0    [1    /1   ]  0.366897474867       1
[INPUT] 0    0    [1    /1   ]  1.01066697346        1
[INPUT] 0    0    [1    /1   ]  2.3944002777         1
[INPUT] 1    0    [1    /1   ]  3.98965483457        1
[INPUT] 1    0    [1    /1   ]  14.0558482632        1
[INPUT] 1    0    [1    /1   ]  67.2003507557        1
[INPUT] 1    0    [1    /1   ]  0.345474477422       1
[INPUT] 1    0    [1    /1   ]  1.21611561147        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794132010942, 1.0]], [0, [3661.454364637406, 1.0]], [0, [833.2730980878703, 1.0]], [0, [235.7138465038653, 1.0]], [0, [76.53718908040435, 1.0]], [0, [9.94275511752652, 1.0]], [0, [26.947272206923213, 1.0]], [0, [0.3668974748666363, 1.0]], [0, [1.0106669734589968, 1.0]], [0, [2.3944002777020903, 1.0]], [1, [3.989654834572878, 1.0]], [1, [14.055848263192019, 1.0]], [1, [67.20035075572478, 1.0]], [1, [0.3454744774221535, 1.0]], [1, [1.2161156114727667, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413201]
bas 1, expnt(s) = [3661.45436464]
bas 2, expnt(s) = [833.27309809]
bas 3, expnt(s) = [235.7138465]
bas 4, expnt(s) = [76.53718908]
bas 5, expnt(s) = [9.94275512]
bas 6, expnt(s) = [26.94727221]
bas 7, expnt(s) = [0.36689747]
bas 8, expnt(s) = [1.01066697]
bas 9, expnt(s) = [2.39440028]
bas 10, expnt(s) = [3.98965483]
bas 11, expnt(s) = [14.05584826]
bas 12, expnt(s) = [67.20035076]
bas 13, expnt(s) = [0.34547448]
bas 14, expnt(s) = [1.21611561]
CPU time:       181.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145436e+03 1.18920094e+03
 8.33273098e+02 3.91837092e+02 2.35713847e+02 1.51986091e+02
 7.65371891e+01 6.53761596e+01 9.94275512e+00 1.41463722e+01
 2.69472722e+01 2.98814131e+01 3.66897475e-01 1.19103237e+00
 1.01066697e+00 2.54666066e+00 2.39440028e+00 4.86309317e+00
 3.98965483e+00 1.64495321e+01 1.40558483e+01 7.93972970e+01
 6.72003508e+01 5.61304879e+02 3.45474477e-01 7.72688330e-01
 1.21611561e+00 3.72565788e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99799146716215
cond(S) = 311.9242177767056
E1 = -183.5744947417332  E_coul = 55.07772786075079
init E= -128.496766880982
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773846149520644  LUMO = 1.10317523262419
  mo_energy =
[-3.25552863e+01 -1.85287184e+00 -7.73846150e-01 -7.73846150e-01
 -7.73846150e-01  1.10317523e+00  1.18643968e+00  1.18643968e+00
  1.18643968e+00  6.22678244e+00  6.22678244e+00  6.22678244e+00
  6.32496713e+00  2.70612691e+01  2.70612691e+01  2.70612691e+01
  3.22174959e+01  1.36000758e+02  1.44807054e+02  1.44807054e+02
  1.44807054e+02  5.00343997e+02  1.86829980e+03  7.99826298e+03
  4.77662797e+04]
E1 = -182.13497977511412  E_coul = 53.607361003193446
cycle= 1 E= -128.527618771921  delta_E= -0.0309  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434685
diis-c [-0.18895092  1.        ]
  HOMO = -0.877429352988228  LUMO = 1.06612311969938
  mo_energy =
[-3.28694235e+01 -1.96084704e+00 -8.77429353e-01 -8.77429353e-01
 -8.77429353e-01  1.06612312e+00  1.14629430e+00  1.14629430e+00
  1.14629430e+00  6.09334075e+00  6.09334075e+00  6.09334075e+00
  6.21129067e+00  2.68207176e+01  2.68207176e+01  2.68207176e+01
  3.19808214e+01  1.35691463e+02  1.44482597e+02  1.44482597e+02
  1.44482597e+02  4.99991166e+02  1.86791115e+03  7.99784535e+03
  4.77658433e+04]
E1 = -182.84994387983605  E_coul = 54.319893821684325
cycle= 2 E= -128.530050058152  delta_E= -0.00243  |g|= 0.0977  |ddm|= 0.0699
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.21517
diis-c [-5.79809113e-04  3.30050745e-01  6.69949255e-01]
  HOMO = -0.843810876579321  LUMO = 1.0781689188231
  mo_energy =
[-3.27663907e+01 -1.92551252e+00 -8.43810877e-01 -8.43810877e-01
 -8.43810877e-01  1.07816892e+00  1.15944365e+00  1.15944365e+00
  1.15944365e+00  6.13671784e+00  6.13671784e+00  6.13671784e+00
  6.24819255e+00  2.68998528e+01  2.68998528e+01  2.68998528e+01
  3.20589221e+01  1.35792720e+02  1.44587896e+02  1.44587896e+02
  1.44587896e+02  5.00102770e+02  1.86802782e+03  7.99796440e+03
  4.77659632e+04]
E1 = -182.61120002356105  E_coul = 54.08034337919156
cycle= 3 E= -128.530856644369  delta_E= -0.000807  |g|= 0.000509  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00103475
diis-c [-1.16102778e-07 -2.22005607e-03  6.65392370e-05  1.00215352e+00]
  HOMO = -0.844059699580085  LUMO = 1.07811576840916
  mo_energy =
[-3.27668473e+01 -1.92569604e+00 -8.44059700e-01 -8.44059700e-01
 -8.44059700e-01  1.07811577e+00  1.15938349e+00  1.15938349e+00
  1.15938349e+00  6.13648408e+00  6.13648408e+00  6.13648408e+00
  6.24799629e+00  2.68994828e+01  2.68994828e+01  2.68994828e+01
  3.20585671e+01  1.35792266e+02  1.44587415e+02  1.44587415e+02
  1.44587415e+02  5.00102214e+02  1.86802716e+03  7.99796365e+03
  4.77659624e+04]
E1 = -182.61186835925716  E_coul = 54.08101169204144
cycle= 4 E= -128.530856667216  delta_E= -2.28e-08  |g|= 6.43e-05  |ddm|= 0.000263
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135016
diis-c [-8.13707707e-10  3.34131747e-04  3.83630130e-04 -2.10853665e-01
  1.21013590e+00]
  HOMO = -0.844090480973646  LUMO = 1.07810808819671
  mo_energy =
[-3.27669003e+01 -1.92571386e+00 -8.44090481e-01 -8.44090481e-01
 -8.44090481e-01  1.07810809e+00  1.15937026e+00  1.15937026e+00
  1.15937026e+00  6.13644877e+00  6.13644877e+00  6.13644877e+00
  6.24796909e+00  2.68994356e+01  2.68994356e+01  2.68994356e+01
  3.20585218e+01  1.35792213e+02  1.44587360e+02  1.44587360e+02
  1.44587360e+02  5.00102153e+02  1.86802709e+03  7.99796357e+03
  4.77659623e+04]
E1 = -182.61198090651274  E_coul = 54.08112423875456
cycle= 5 E= -128.530856667758  delta_E= -5.42e-10  |g|= 5.79e-06  |ddm|= 4.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61198090651274  E_coul = 54.08112423875456
  HOMO = -0.844087400677003  LUMO = 1.07810978374966
  mo_energy =
[-3.27668939e+01 -1.92571009e+00 -8.44087401e-01 -8.44087401e-01
 -8.44087401e-01  1.07810978e+00  1.15937165e+00  1.15937165e+00
  1.15937165e+00  6.13645265e+00  6.13645265e+00  6.13645265e+00
  6.24797291e+00  2.68994413e+01  2.68994413e+01  2.68994413e+01
  3.20585276e+01  1.35792219e+02  1.44587367e+02  1.44587367e+02
  1.44587367e+02  5.00102159e+02  1.86802709e+03  7.99796358e+03
  4.77659623e+04]
E1 = -182.61196702793697  E_coul = 54.08111036017653
Extra cycle  E= -128.53085666776  delta_E= -2.27e-12  |g|= 1.96e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145436e+03 8.33273098e+02 2.35713847e+02
 7.65371891e+01 9.94275512e+00 2.69472722e+01 3.66897475e-01
 1.01066697e+00 2.39440028e+00 3.98965483e+00 1.40558483e+01
 6.72003508e+01 3.45474477e-01 1.21611561e+00]
E = -128.53085666776045
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436464        1
[INPUT] 0    0    [1    /1   ]  833.273098088        1
[INPUT] 0    0    [1    /1   ]  235.713846504        1
[INPUT] 0    0    [1    /1   ]  76.5371890804        1
[INPUT] 0    0    [1    /1   ]  9.94275511753        1
[INPUT] 0    0    [1    /1   ]  26.9472722069        1
[INPUT] 0    0    [1    /1   ]  0.366897474867       1
[INPUT] 0    0    [1    /1   ]  1.01066697346        1
[INPUT] 0    0    [1    /1   ]  2.3944002777         1
[INPUT] 1    0    [1    /1   ]  3.98965483457        1
[INPUT] 1    0    [1    /1   ]  14.0558482632        1
[INPUT] 1    0    [1    /1   ]  67.2003507557        1
[INPUT] 1    0    [1    /1   ]  0.345474477422       1
[INPUT] 1    0    [1    /1   ]  1.21611561147        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794132010942, 1.0]], [0, [3661.454364637406, 1.0]], [0, [833.2730980878703, 1.0]], [0, [235.7138465038653, 1.0]], [0, [76.53718908040435, 1.0]], [0, [9.94275511752652, 1.0]], [0, [26.947272206923213, 1.0]], [0, [0.3668974748666363, 1.0]], [0, [1.0106669734589968, 1.0]], [0, [2.3944002777020903, 1.0]], [1, [3.989654834572878, 1.0]], [1, [14.055848263192019, 1.0]], [1, [67.20035075572478, 1.0]], [1, [0.3454744774221535, 1.0]], [1, [1.2161156114727667, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413201]
bas 1, expnt(s) = [3661.45436464]
bas 2, expnt(s) = [833.27309809]
bas 3, expnt(s) = [235.7138465]
bas 4, expnt(s) = [76.53718908]
bas 5, expnt(s) = [9.94275512]
bas 6, expnt(s) = [26.94727221]
bas 7, expnt(s) = [0.36689747]
bas 8, expnt(s) = [1.01066697]
bas 9, expnt(s) = [2.39440028]
bas 10, expnt(s) = [3.98965483]
bas 11, expnt(s) = [14.05584826]
bas 12, expnt(s) = [67.20035076]
bas 13, expnt(s) = [0.34547448]
bas 14, expnt(s) = [1.21611561]
CPU time:       182.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145436e+03 1.18920094e+03
 8.33273098e+02 3.91837092e+02 2.35713847e+02 1.51986091e+02
 7.65371891e+01 6.53761596e+01 9.94275512e+00 1.41463722e+01
 2.69472722e+01 2.98814131e+01 3.66897475e-01 1.19103237e+00
 1.01066697e+00 2.54666066e+00 2.39440028e+00 4.86309317e+00
 3.98965483e+00 1.64495321e+01 1.40558483e+01 7.93972970e+01
 6.72003508e+01 5.61304879e+02 3.45474477e-01 7.72688330e-01
 1.21611561e+00 3.72565788e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99799146716215
cond(S) = 311.9242177767056
E1 = -183.5744947417332  E_coul = 55.07772786075079
init E= -128.496766880982
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773846149520644  LUMO = 1.10317523262419
  mo_energy =
[-3.25552863e+01 -1.85287184e+00 -7.73846150e-01 -7.73846150e-01
 -7.73846150e-01  1.10317523e+00  1.18643968e+00  1.18643968e+00
  1.18643968e+00  6.22678244e+00  6.22678244e+00  6.22678244e+00
  6.32496713e+00  2.70612691e+01  2.70612691e+01  2.70612691e+01
  3.22174959e+01  1.36000758e+02  1.44807054e+02  1.44807054e+02
  1.44807054e+02  5.00343997e+02  1.86829980e+03  7.99826298e+03
  4.77662797e+04]
E1 = -182.13497977511412  E_coul = 53.607361003193446
cycle= 1 E= -128.527618771921  delta_E= -0.0309  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434685
diis-c [-0.18895092  1.        ]
  HOMO = -0.877429352988228  LUMO = 1.06612311969938
  mo_energy =
[-3.28694235e+01 -1.96084704e+00 -8.77429353e-01 -8.77429353e-01
 -8.77429353e-01  1.06612312e+00  1.14629430e+00  1.14629430e+00
  1.14629430e+00  6.09334075e+00  6.09334075e+00  6.09334075e+00
  6.21129067e+00  2.68207176e+01  2.68207176e+01  2.68207176e+01
  3.19808214e+01  1.35691463e+02  1.44482597e+02  1.44482597e+02
  1.44482597e+02  4.99991166e+02  1.86791115e+03  7.99784535e+03
  4.77658433e+04]
E1 = -182.84994387983605  E_coul = 54.319893821684325
cycle= 2 E= -128.530050058152  delta_E= -0.00243  |g|= 0.0977  |ddm|= 0.0699
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.21517
diis-c [-5.79809113e-04  3.30050745e-01  6.69949255e-01]
  HOMO = -0.843810876579321  LUMO = 1.0781689188231
  mo_energy =
[-3.27663907e+01 -1.92551252e+00 -8.43810877e-01 -8.43810877e-01
 -8.43810877e-01  1.07816892e+00  1.15944365e+00  1.15944365e+00
  1.15944365e+00  6.13671784e+00  6.13671784e+00  6.13671784e+00
  6.24819255e+00  2.68998528e+01  2.68998528e+01  2.68998528e+01
  3.20589221e+01  1.35792720e+02  1.44587896e+02  1.44587896e+02
  1.44587896e+02  5.00102770e+02  1.86802782e+03  7.99796440e+03
  4.77659632e+04]
E1 = -182.61120002356105  E_coul = 54.08034337919156
cycle= 3 E= -128.530856644369  delta_E= -0.000807  |g|= 0.000509  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00103475
diis-c [-1.16102778e-07 -2.22005607e-03  6.65392370e-05  1.00215352e+00]
  HOMO = -0.844059699580085  LUMO = 1.07811576840916
  mo_energy =
[-3.27668473e+01 -1.92569604e+00 -8.44059700e-01 -8.44059700e-01
 -8.44059700e-01  1.07811577e+00  1.15938349e+00  1.15938349e+00
  1.15938349e+00  6.13648408e+00  6.13648408e+00  6.13648408e+00
  6.24799629e+00  2.68994828e+01  2.68994828e+01  2.68994828e+01
  3.20585671e+01  1.35792266e+02  1.44587415e+02  1.44587415e+02
  1.44587415e+02  5.00102214e+02  1.86802716e+03  7.99796365e+03
  4.77659624e+04]
E1 = -182.61186835925716  E_coul = 54.08101169204144
cycle= 4 E= -128.530856667216  delta_E= -2.28e-08  |g|= 6.43e-05  |ddm|= 0.000263
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000135016
diis-c [-8.13707707e-10  3.34131747e-04  3.83630130e-04 -2.10853665e-01
  1.21013590e+00]
  HOMO = -0.844090480973646  LUMO = 1.07810808819671
  mo_energy =
[-3.27669003e+01 -1.92571386e+00 -8.44090481e-01 -8.44090481e-01
 -8.44090481e-01  1.07810809e+00  1.15937026e+00  1.15937026e+00
  1.15937026e+00  6.13644877e+00  6.13644877e+00  6.13644877e+00
  6.24796909e+00  2.68994356e+01  2.68994356e+01  2.68994356e+01
  3.20585218e+01  1.35792213e+02  1.44587360e+02  1.44587360e+02
  1.44587360e+02  5.00102153e+02  1.86802709e+03  7.99796357e+03
  4.77659623e+04]
E1 = -182.61198090651274  E_coul = 54.08112423875456
cycle= 5 E= -128.530856667758  delta_E= -5.42e-10  |g|= 5.79e-06  |ddm|= 4.54e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61198090651274  E_coul = 54.08112423875456
  HOMO = -0.844087400677003  LUMO = 1.07810978374966
  mo_energy =
[-3.27668939e+01 -1.92571009e+00 -8.44087401e-01 -8.44087401e-01
 -8.44087401e-01  1.07810978e+00  1.15937165e+00  1.15937165e+00
  1.15937165e+00  6.13645265e+00  6.13645265e+00  6.13645265e+00
  6.24797291e+00  2.68994413e+01  2.68994413e+01  2.68994413e+01
  3.20585276e+01  1.35792219e+02  1.44587367e+02  1.44587367e+02
  1.44587367e+02  5.00102159e+02  1.86802709e+03  7.99796358e+03
  4.77659623e+04]
E1 = -182.61196702793697  E_coul = 54.08111036017653
Extra cycle  E= -128.53085666776  delta_E= -2.27e-12  |g|= 1.96e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 311.9242177767056
E1 = -182.61196702793697  E_coul = 54.08111036017653
init E= -128.53085666776
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.844088370873946  LUMO = 1.07810951493426
  mo_energy =
[-3.27668970e+01 -1.92571100e+00 -8.44088371e-01 -8.44088371e-01
 -8.44088371e-01  1.07810951e+00  1.15937129e+00  1.15937129e+00
  1.15937129e+00  6.13645140e+00  6.13645140e+00  6.13645140e+00
  6.24797192e+00  2.68994389e+01  2.68994389e+01  2.68994389e+01
  3.20585253e+01  1.35792216e+02  1.44587363e+02  1.44587363e+02
  1.44587363e+02  5.00102155e+02  1.86802709e+03  7.99796357e+03
  4.77659623e+04]
E1 = -182.6119744947303  E_coul = 54.08111782696971
cycle= 1 E= -128.530856667761  delta_E= -1.42e-13  |g|= 1.03e-06  |ddm|= 7.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6119744947303  E_coul = 54.08111782696971
  HOMO = -0.844087847352506  LUMO = 1.07810971625739
  mo_energy =
[-3.27668955e+01 -1.92571043e+00 -8.44087847e-01 -8.44087847e-01
 -8.44087847e-01  1.07810972e+00  1.15937150e+00  1.15937150e+00
  1.15937150e+00  6.13645208e+00  6.13645208e+00  6.13645208e+00
  6.24797251e+00  2.68994402e+01  2.68994402e+01  2.68994402e+01
  3.20585265e+01  1.35792218e+02  1.44587365e+02  1.44587365e+02
  1.44587365e+02  5.00102157e+02  1.86802709e+03  7.99796358e+03
  4.77659623e+04]
E1 = -182.61197081336437  E_coul = 54.081114145603635
Extra cycle  E= -128.530856667761  delta_E= -1.42e-13  |g|= 5.01e-07  |ddm|= 3.74e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145436e+03 8.33273098e+02 2.35713847e+02
 7.65371891e+01 9.94275512e+00 2.69472722e+01 3.66897475e-01
 1.01066697e+00 2.39440028e+00 3.98965483e+00 1.40558483e+01
 6.72003508e+01 3.45474477e-01 1.21611561e+00]
grad_E = [ 1.15370033e-09 -5.99064485e-08  1.18197489e-06 -1.27643414e-05
  8.17091102e-05  6.63450981e-04 -2.78192270e-04 -9.73323896e-04
  1.34549121e-03 -1.37685019e-03 -9.29435356e-04  3.33152813e-07
  1.25336432e-04  5.10871260e-03  1.19880005e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.4543648         1
[INPUT] 0    0    [1    /1   ]  833.273095216        1
[INPUT] 0    0    [1    /1   ]  235.713866844        1
[INPUT] 0    0    [1    /1   ]  76.5372828535        1
[INPUT] 0    0    [1    /1   ]  9.96048004936        1
[INPUT] 0    0    [1    /1   ]  26.9441167806        1
[INPUT] 0    0    [1    /1   ]  0.375123337747       1
[INPUT] 0    0    [1    /1   ]  1.02583937481        1
[INPUT] 0    0    [1    /1   ]  2.38063616248        1
[INPUT] 1    0    [1    /1   ]  3.99958574787        1
[INPUT] 1    0    [1    /1   ]  14.0816883729        1
[INPUT] 1    0    [1    /1   ]  66.414047431         1
[INPUT] 1    0    [1    /1   ]  0.345213906524       1
[INPUT] 1    0    [1    /1   ]  1.2176995266         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794132008497, 1.0]], [0, [3661.454364795041, 1.0]], [0, [833.2730952158885, 1.0]], [0, [235.7138668444286, 1.0]], [0, [76.53728285352686, 1.0]], [0, [9.960480049357491, 1.0]], [0, [26.944116780618575, 1.0]], [0, [0.37512333774690565, 1.0]], [0, [1.025839374811042, 1.0]], [0, [2.380636162480781, 1.0]], [1, [3.9995857478691983, 1.0]], [1, [14.081688372933334, 1.0]], [1, [66.41404743099653, 1.0]], [1, [0.3452139065236927, 1.0]], [1, [1.2176995266031185, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413201]
bas 1, expnt(s) = [3661.4543648]
bas 2, expnt(s) = [833.27309522]
bas 3, expnt(s) = [235.71386684]
bas 4, expnt(s) = [76.53728285]
bas 5, expnt(s) = [9.96048005]
bas 6, expnt(s) = [26.94411678]
bas 7, expnt(s) = [0.37512334]
bas 8, expnt(s) = [1.02583937]
bas 9, expnt(s) = [2.38063616]
bas 10, expnt(s) = [3.99958575]
bas 11, expnt(s) = [14.08168837]
bas 12, expnt(s) = [66.41404743]
bas 13, expnt(s) = [0.34521391]
bas 14, expnt(s) = [1.21769953]
CPU time:       185.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145436e+03 1.18920094e+03
 8.33273095e+02 3.91837091e+02 2.35713867e+02 1.51986101e+02
 7.65372829e+01 6.53762197e+01 9.96048005e+00 1.41652821e+01
 2.69441168e+01 2.98787888e+01 3.75123338e-01 1.21100403e+00
 1.02583937e+00 2.57528055e+00 2.38063616e+00 4.84211159e+00
 3.99958575e+00 1.65007300e+01 1.40816884e+01 7.95797928e+01
 6.64140474e+01 5.53107220e+02 3.45213907e-01 7.71959908e-01
 1.21769953e+00 3.73172442e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997983904502544
cond(S) = 318.7807374518221
E1 = -183.57439748714634  E_coul = 55.077713779374506
init E= -128.496683707772
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773867431681507  LUMO = 1.13109005195959
  mo_energy =
[-3.25552630e+01 -1.85286044e+00 -7.73867432e-01 -7.73867432e-01
 -7.73867432e-01  1.13109005e+00  1.18616804e+00  1.18616804e+00
  1.18616804e+00  6.23585883e+00  6.23585883e+00  6.23585883e+00
  6.38913028e+00  2.71260153e+01  2.71260153e+01  2.71260153e+01
  3.22955659e+01  1.36092152e+02  1.43656830e+02  1.43656830e+02
  1.43656830e+02  5.00430651e+02  1.86837793e+03  7.99833180e+03
  4.77663366e+04]
E1 = -182.13457949522538  E_coul = 53.60691702449591
cycle= 1 E= -128.527662470729  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434815
diis-c [-0.1890645  1.       ]
  HOMO = -0.877484071403896  LUMO = 1.09326174420377
  mo_energy =
[-3.28694339e+01 -1.96091721e+00 -8.77484071e-01 -8.77484071e-01
 -8.77484071e-01  1.09326174e+00  1.14598088e+00  1.14598088e+00
  1.14598088e+00  6.10217508e+00  6.10217508e+00  6.10217508e+00
  6.27528135e+00  2.68852688e+01  2.68852688e+01  2.68852688e+01
  3.20588874e+01  1.35782858e+02  1.43332820e+02  1.43332820e+02
  1.43332820e+02  5.00077863e+02  1.86798936e+03  7.99791426e+03
  4.77659003e+04]
E1 = -182.8496887807122  E_coul = 54.31959454617282
cycle= 2 E= -128.530094234539  delta_E= -0.00243  |g|= 0.0977  |ddm|= 0.0699
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.215234
diis-c [-5.82706838e-04  3.30044567e-01  6.69955433e-01]
  HOMO = -0.843859014106918  LUMO = 1.10554226016333
  mo_energy =
[-3.27663798e+01 -1.92557273e+00 -8.43859014e-01 -8.43859014e-01
 -8.43859014e-01  1.10554226e+00  1.15914036e+00  1.15914036e+00
  1.15914036e+00  6.14562303e+00  6.14562303e+00  6.14562303e+00
  6.31223400e+00  2.69644659e+01  2.69644659e+01  2.69644659e+01
  3.21369966e+01  1.35884130e+02  1.43438019e+02  1.43438019e+02
  1.43438019e+02  5.00189486e+02  1.86810605e+03  7.99803333e+03
  4.77660203e+04]
E1 = -182.61085028234226  E_coul = 54.079948984657506
cycle= 3 E= -128.530901297685  delta_E= -0.000807  |g|= 0.000511  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00104018
diis-c [-1.05754755e-07 -2.22194779e-03  1.13011733e-04  1.00210894e+00]
  HOMO = -0.84411004393614  LUMO = 1.10548499816337
  mo_energy =
[-3.27668435e+01 -1.92576225e+00 -8.44110044e-01 -8.44110044e-01
 -8.44110044e-01  1.10548500e+00  1.15907909e+00  1.15907909e+00
  1.15907909e+00  6.14538528e+00  6.14538528e+00  6.14538528e+00
  6.31203334e+00  2.69640899e+01  2.69640899e+01  2.69640899e+01
  3.21366358e+01  1.35883670e+02  1.43437532e+02  1.43437532e+02
  1.43437532e+02  5.00188924e+02  1.86810538e+03  7.99803257e+03
  4.77660195e+04]
E1 = -182.61153381500552  E_coul = 54.08063249520409
cycle= 4 E= -128.530901319801  delta_E= -2.21e-08  |g|= 6.23e-05  |ddm|= 0.000254
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000131323
diis-c [-7.65516646e-10  3.18515994e-04  3.67246493e-04 -2.02019487e-01
  1.20133373e+00]
  HOMO = -0.844140288890147  LUMO = 1.10547684756076
  mo_energy =
[-3.27668957e+01 -1.92578060e+00 -8.44140289e-01 -8.44140289e-01
 -8.44140289e-01  1.10547685e+00  1.15906606e+00  1.15906606e+00
  1.15906606e+00  6.14535039e+00  6.14535039e+00  6.14535039e+00
  6.31200611e+00  2.69640432e+01  2.69640432e+01  2.69640432e+01
  3.21365910e+01  1.35883618e+02  1.43437478e+02  1.43437478e+02
  1.43437478e+02  5.00188864e+02  1.86810531e+03  7.99803250e+03
  4.77660194e+04]
E1 = -182.61164476731366  E_coul = 54.08074344702161
cycle= 5 E= -128.530901320292  delta_E= -4.91e-10  |g|= 5.53e-06  |ddm|= 4.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61164476731366  E_coul = 54.08074344702161
  HOMO = -0.844137402333328  LUMO = 1.10547849631151
  mo_energy =
[-3.27668897e+01 -1.92577701e+00 -8.44137402e-01 -8.44137402e-01
 -8.44137402e-01  1.10547850e+00  1.15906737e+00  1.15906737e+00
  1.15906737e+00  6.14535404e+00  6.14535404e+00  6.14535404e+00
  6.31200972e+00  2.69640486e+01  2.69640486e+01  2.69640486e+01
  3.21365964e+01  1.35883624e+02  1.43437484e+02  1.43437484e+02
  1.43437484e+02  5.00188869e+02  1.86810532e+03  7.99803250e+03
  4.77660194e+04]
E1 = -182.61163170853627  E_coul = 54.08073038824235
Extra cycle  E= -128.530901320294  delta_E= -1.85e-12  |g|= 1.85e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145436e+03 8.33273095e+02 2.35713867e+02
 7.65372829e+01 9.96048005e+00 2.69441168e+01 3.75123338e-01
 1.02583937e+00 2.38063616e+00 3.99958575e+00 1.40816884e+01
 6.64140474e+01 3.45213907e-01 1.21769953e+00]
E = -128.5309013202939
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.4543648         1
[INPUT] 0    0    [1    /1   ]  833.273095216        1
[INPUT] 0    0    [1    /1   ]  235.713866844        1
[INPUT] 0    0    [1    /1   ]  76.5372828535        1
[INPUT] 0    0    [1    /1   ]  9.96048004936        1
[INPUT] 0    0    [1    /1   ]  26.9441167806        1
[INPUT] 0    0    [1    /1   ]  0.375123337747       1
[INPUT] 0    0    [1    /1   ]  1.02583937481        1
[INPUT] 0    0    [1    /1   ]  2.38063616248        1
[INPUT] 1    0    [1    /1   ]  3.99958574787        1
[INPUT] 1    0    [1    /1   ]  14.0816883729        1
[INPUT] 1    0    [1    /1   ]  66.414047431         1
[INPUT] 1    0    [1    /1   ]  0.345213906524       1
[INPUT] 1    0    [1    /1   ]  1.2176995266         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794132008497, 1.0]], [0, [3661.454364795041, 1.0]], [0, [833.2730952158885, 1.0]], [0, [235.7138668444286, 1.0]], [0, [76.53728285352686, 1.0]], [0, [9.960480049357491, 1.0]], [0, [26.944116780618575, 1.0]], [0, [0.37512333774690565, 1.0]], [0, [1.025839374811042, 1.0]], [0, [2.380636162480781, 1.0]], [1, [3.9995857478691983, 1.0]], [1, [14.081688372933334, 1.0]], [1, [66.41404743099653, 1.0]], [1, [0.3452139065236927, 1.0]], [1, [1.2176995266031185, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413201]
bas 1, expnt(s) = [3661.4543648]
bas 2, expnt(s) = [833.27309522]
bas 3, expnt(s) = [235.71386684]
bas 4, expnt(s) = [76.53728285]
bas 5, expnt(s) = [9.96048005]
bas 6, expnt(s) = [26.94411678]
bas 7, expnt(s) = [0.37512334]
bas 8, expnt(s) = [1.02583937]
bas 9, expnt(s) = [2.38063616]
bas 10, expnt(s) = [3.99958575]
bas 11, expnt(s) = [14.08168837]
bas 12, expnt(s) = [66.41404743]
bas 13, expnt(s) = [0.34521391]
bas 14, expnt(s) = [1.21769953]
CPU time:       186.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145436e+03 1.18920094e+03
 8.33273095e+02 3.91837091e+02 2.35713867e+02 1.51986101e+02
 7.65372829e+01 6.53762197e+01 9.96048005e+00 1.41652821e+01
 2.69441168e+01 2.98787888e+01 3.75123338e-01 1.21100403e+00
 1.02583937e+00 2.57528055e+00 2.38063616e+00 4.84211159e+00
 3.99958575e+00 1.65007300e+01 1.40816884e+01 7.95797928e+01
 6.64140474e+01 5.53107220e+02 3.45213907e-01 7.71959908e-01
 1.21769953e+00 3.73172442e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997983904502544
cond(S) = 318.7807374518221
E1 = -183.57439748714634  E_coul = 55.077713779374506
init E= -128.496683707772
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773867431681507  LUMO = 1.13109005195959
  mo_energy =
[-3.25552630e+01 -1.85286044e+00 -7.73867432e-01 -7.73867432e-01
 -7.73867432e-01  1.13109005e+00  1.18616804e+00  1.18616804e+00
  1.18616804e+00  6.23585883e+00  6.23585883e+00  6.23585883e+00
  6.38913028e+00  2.71260153e+01  2.71260153e+01  2.71260153e+01
  3.22955659e+01  1.36092152e+02  1.43656830e+02  1.43656830e+02
  1.43656830e+02  5.00430651e+02  1.86837793e+03  7.99833180e+03
  4.77663366e+04]
E1 = -182.13457949522538  E_coul = 53.60691702449591
cycle= 1 E= -128.527662470729  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.434815
diis-c [-0.1890645  1.       ]
  HOMO = -0.877484071403896  LUMO = 1.09326174420377
  mo_energy =
[-3.28694339e+01 -1.96091721e+00 -8.77484071e-01 -8.77484071e-01
 -8.77484071e-01  1.09326174e+00  1.14598088e+00  1.14598088e+00
  1.14598088e+00  6.10217508e+00  6.10217508e+00  6.10217508e+00
  6.27528135e+00  2.68852688e+01  2.68852688e+01  2.68852688e+01
  3.20588874e+01  1.35782858e+02  1.43332820e+02  1.43332820e+02
  1.43332820e+02  5.00077863e+02  1.86798936e+03  7.99791426e+03
  4.77659003e+04]
E1 = -182.8496887807122  E_coul = 54.31959454617282
cycle= 2 E= -128.530094234539  delta_E= -0.00243  |g|= 0.0977  |ddm|= 0.0699
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.215234
diis-c [-5.82706838e-04  3.30044567e-01  6.69955433e-01]
  HOMO = -0.843859014106918  LUMO = 1.10554226016333
  mo_energy =
[-3.27663798e+01 -1.92557273e+00 -8.43859014e-01 -8.43859014e-01
 -8.43859014e-01  1.10554226e+00  1.15914036e+00  1.15914036e+00
  1.15914036e+00  6.14562303e+00  6.14562303e+00  6.14562303e+00
  6.31223400e+00  2.69644659e+01  2.69644659e+01  2.69644659e+01
  3.21369966e+01  1.35884130e+02  1.43438019e+02  1.43438019e+02
  1.43438019e+02  5.00189486e+02  1.86810605e+03  7.99803333e+03
  4.77660203e+04]
E1 = -182.61085028234226  E_coul = 54.079948984657506
cycle= 3 E= -128.530901297685  delta_E= -0.000807  |g|= 0.000511  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00104018
diis-c [-1.05754755e-07 -2.22194779e-03  1.13011733e-04  1.00210894e+00]
  HOMO = -0.84411004393614  LUMO = 1.10548499816337
  mo_energy =
[-3.27668435e+01 -1.92576225e+00 -8.44110044e-01 -8.44110044e-01
 -8.44110044e-01  1.10548500e+00  1.15907909e+00  1.15907909e+00
  1.15907909e+00  6.14538528e+00  6.14538528e+00  6.14538528e+00
  6.31203334e+00  2.69640899e+01  2.69640899e+01  2.69640899e+01
  3.21366358e+01  1.35883670e+02  1.43437532e+02  1.43437532e+02
  1.43437532e+02  5.00188924e+02  1.86810538e+03  7.99803257e+03
  4.77660195e+04]
E1 = -182.61153381500552  E_coul = 54.08063249520409
cycle= 4 E= -128.530901319801  delta_E= -2.21e-08  |g|= 6.23e-05  |ddm|= 0.000254
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000131323
diis-c [-7.65516646e-10  3.18515994e-04  3.67246493e-04 -2.02019487e-01
  1.20133373e+00]
  HOMO = -0.844140288890147  LUMO = 1.10547684756076
  mo_energy =
[-3.27668957e+01 -1.92578060e+00 -8.44140289e-01 -8.44140289e-01
 -8.44140289e-01  1.10547685e+00  1.15906606e+00  1.15906606e+00
  1.15906606e+00  6.14535039e+00  6.14535039e+00  6.14535039e+00
  6.31200611e+00  2.69640432e+01  2.69640432e+01  2.69640432e+01
  3.21365910e+01  1.35883618e+02  1.43437478e+02  1.43437478e+02
  1.43437478e+02  5.00188864e+02  1.86810531e+03  7.99803250e+03
  4.77660194e+04]
E1 = -182.61164476731366  E_coul = 54.08074344702161
cycle= 5 E= -128.530901320292  delta_E= -4.91e-10  |g|= 5.53e-06  |ddm|= 4.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61164476731366  E_coul = 54.08074344702161
  HOMO = -0.844137402333328  LUMO = 1.10547849631151
  mo_energy =
[-3.27668897e+01 -1.92577701e+00 -8.44137402e-01 -8.44137402e-01
 -8.44137402e-01  1.10547850e+00  1.15906737e+00  1.15906737e+00
  1.15906737e+00  6.14535404e+00  6.14535404e+00  6.14535404e+00
  6.31200972e+00  2.69640486e+01  2.69640486e+01  2.69640486e+01
  3.21365964e+01  1.35883624e+02  1.43437484e+02  1.43437484e+02
  1.43437484e+02  5.00188869e+02  1.86810532e+03  7.99803250e+03
  4.77660194e+04]
E1 = -182.61163170853627  E_coul = 54.08073038824235
Extra cycle  E= -128.530901320294  delta_E= -1.85e-12  |g|= 1.85e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 318.7807374518221
E1 = -182.61163170853627  E_coul = 54.08073038824235
init E= -128.530901320294
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844138318276198  LUMO = 1.10547824315769
  mo_energy =
[-3.27668927e+01 -1.92577785e+00 -8.44138318e-01 -8.44138318e-01
 -8.44138318e-01  1.10547824e+00  1.15906703e+00  1.15906703e+00
  1.15906703e+00  6.14535286e+00  6.14535286e+00  6.14535286e+00
  6.31200879e+00  2.69640464e+01  2.69640464e+01  2.69640464e+01
  3.21365943e+01  1.35883621e+02  1.43437481e+02  1.43437481e+02
  1.43437481e+02  5.00188866e+02  1.86810531e+03  7.99803250e+03
  4.77660194e+04]
E1 = -182.61163873941265  E_coul = 54.08073741911807
cycle= 1 E= -128.530901320295  delta_E= -6.82e-13  |g|= 9.69e-07  |ddm|= 7.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61163873941265  E_coul = 54.08073741911807
  HOMO = -0.844137825956521  LUMO = 1.10547843746294
  mo_energy =
[-3.27668912e+01 -1.92577731e+00 -8.44137826e-01 -8.44137826e-01
 -8.44137826e-01  1.10547844e+00  1.15906722e+00  1.15906722e+00
  1.15906722e+00  6.14535350e+00  6.14535350e+00  6.14535350e+00
  6.31200935e+00  2.69640475e+01  2.69640475e+01  2.69640475e+01
  3.21365954e+01  1.35883622e+02  1.43437482e+02  1.43437482e+02
  1.43437482e+02  5.00188867e+02  1.86810531e+03  7.99803250e+03
  4.77660194e+04]
E1 = -182.6116352738972  E_coul = 54.080733953602625
Extra cycle  E= -128.530901320295  delta_E=    0  |g|= 4.71e-07  |ddm|= 3.54e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145436e+03 8.33273095e+02 2.35713867e+02
 7.65372829e+01 9.96048005e+00 2.69441168e+01 3.75123338e-01
 1.02583937e+00 2.38063616e+00 3.99958575e+00 1.40816884e+01
 6.64140474e+01 3.45213907e-01 1.21769953e+00]
grad_E = [ 1.30652368e-09 -6.78744310e-08  1.34373061e-06 -1.46596116e-05
  9.65922200e-05  7.86175125e-04 -3.44514977e-04  2.82952421e-04
  1.27029488e-03 -1.51785891e-03 -1.19742537e-03  2.22909736e-04
  9.78076521e-05  1.77643511e-03  1.02347132e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436525        1
[INPUT] 0    0    [1    /1   ]  833.273086217        1
[INPUT] 0    0    [1    /1   ]  235.713967147        1
[INPUT] 0    0    [1    /1   ]  76.5366627033        1
[INPUT] 0    0    [1    /1   ]  9.96377701001        1
[INPUT] 0    0    [1    /1   ]  26.9456494967        1
[INPUT] 0    0    [1    /1   ]  0.381686235703       1
[INPUT] 0    0    [1    /1   ]  1.03823952025        1
[INPUT] 0    0    [1    /1   ]  2.37652770515        1
[INPUT] 1    0    [1    /1   ]  4.01535721851        1
[INPUT] 1    0    [1    /1   ]  14.1007054266        1
[INPUT] 1    0    [1    /1   ]  65.9349618583        1
[INPUT] 1    0    [1    /1   ]  0.345004651627       1
[INPUT] 1    0    [1    /1   ]  1.22022144126        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413200013, 1.0]], [0, [3661.4543652546486, 1.0]], [0, [833.273086216833, 1.0]], [0, [235.71396714653022, 1.0]], [0, [76.53666270327204, 1.0]], [0, [9.96377701000541, 1.0]], [0, [26.945649496683426, 1.0]], [0, [0.3816862357029286, 1.0]], [0, [1.0382395202450228, 1.0]], [0, [2.376527705145024, 1.0]], [1, [4.015357218514536, 1.0]], [1, [14.100705426557209, 1.0]], [1, [65.93496185833366, 1.0]], [1, [0.345004651627092, 1.0]], [1, [1.220221441255721, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.794132]
bas 1, expnt(s) = [3661.45436525]
bas 2, expnt(s) = [833.27308622]
bas 3, expnt(s) = [235.71396715]
bas 4, expnt(s) = [76.5366627]
bas 5, expnt(s) = [9.96377701]
bas 6, expnt(s) = [26.9456495]
bas 7, expnt(s) = [0.38168624]
bas 8, expnt(s) = [1.03823952]
bas 9, expnt(s) = [2.37652771]
bas 10, expnt(s) = [4.01535722]
bas 11, expnt(s) = [14.10070543]
bas 12, expnt(s) = [65.93496186]
bas 13, expnt(s) = [0.34500465]
bas 14, expnt(s) = [1.22022144]
CPU time:       189.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273086e+02 3.91837088e+02 2.35713967e+02 1.51986149e+02
 7.65366627e+01 6.53758224e+01 9.96377701e+00 1.41687985e+01
 2.69456495e+01 2.98800635e+01 3.81686236e-01 1.22685969e+00
 1.03823952e+00 2.59859256e+00 2.37652771e+00 4.83584292e+00
 4.01535722e+00 1.65821037e+01 1.41007054e+01 7.97141542e+01
 6.59349619e+01 5.48124345e+02 3.45004652e-01 7.71375038e-01
 1.22022144e+00 3.74138764e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99797305166237
cond(S) = 324.4764360444542
E1 = -183.57438023246232  E_coul = 55.07770062161548
init E= -128.496679610847
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773880412843589  LUMO = 1.15381819261951
  mo_energy =
[-3.25552541e+01 -1.85285035e+00 -7.73880413e-01 -7.73880413e-01
 -7.73880413e-01  1.15381819e+00  1.18626845e+00  1.18626845e+00
  1.18626845e+00  6.25220671e+00  6.25220671e+00  6.25220671e+00
  6.44942377e+00  2.72027173e+01  2.72027173e+01  2.72027173e+01
  3.23684472e+01  1.36164172e+02  1.43000242e+02  1.43000242e+02
  1.43000242e+02  5.00497490e+02  1.86843799e+03  7.99838465e+03
  4.77663804e+04]
E1 = -182.13409664143964  E_coul = 53.60641422347874
cycle= 1 E= -128.527682417961  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435055
diis-c [-0.18927286  1.        ]
  HOMO = -0.877538006376257  LUMO = 1.1153495608965
  mo_energy =
[-3.28694608e+01 -1.96099177e+00 -8.77538006e-01 -8.77538006e-01
 -8.77538006e-01  1.11534956e+00  1.14602119e+00  1.14602119e+00
  1.14602119e+00  6.11814376e+00  6.11814376e+00  6.11814376e+00
  6.33529399e+00  2.69617742e+01  2.69617742e+01  2.69617742e+01
  3.21317436e+01  1.35854862e+02  1.42676494e+02  1.42676494e+02
  1.42676494e+02  5.00144703e+02  1.86804943e+03  7.99796713e+03
  4.77659441e+04]
E1 = -182.84953874105005  E_coul = 54.31942303648946
cycle= 2 E= -128.530115704561  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.07
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.215355
diis-c [-5.84290430e-04  3.30045284e-01  6.69954716e-01]
  HOMO = -0.843897747274409  LUMO = 1.12782979744635
  mo_energy =
[-3.27663600e+01 -1.92562848e+00 -8.43897747e-01 -8.43897747e-01
 -8.43897747e-01  1.12782980e+00  1.15920274e+00  1.15920274e+00
  1.15920274e+00  6.16171510e+00  6.16171510e+00  6.16171510e+00
  6.37234031e+00  2.70410496e+01  2.70410496e+01  2.70410496e+01
  3.22098740e+01  1.35956174e+02  1.42781663e+02  1.42781663e+02
  1.42781663e+02  5.00256372e+02  1.86816617e+03  7.99808625e+03
  4.77660641e+04]
E1 = -182.61056824308844  E_coul = 54.07964466283141
cycle= 3 E= -128.530923580257  delta_E= -0.000808  |g|= 0.00051  |ddm|= 0.0239
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00104314
diis-c [-9.76538606e-08 -2.21704913e-03  1.54164287e-04  1.00206288e+00]
  HOMO = -0.844148836456932  LUMO = 1.12777022266022
  mo_energy =
[-3.27668275e+01 -1.92582121e+00 -8.44148836e-01 -8.44148836e-01
 -8.44148836e-01  1.12777022e+00  1.15914148e+00  1.15914148e+00
  1.15914148e+00  6.16147576e+00  6.16147576e+00  6.16147576e+00
  6.37213790e+00  2.70406706e+01  2.70406706e+01  2.70406706e+01
  3.22095104e+01  1.35955710e+02  1.42781172e+02  1.42781172e+02
  1.42781172e+02  5.00255805e+02  1.86816549e+03  7.99808549e+03
  4.77660633e+04]
E1 = -182.611263636949  E_coul = 54.08034003534923
cycle= 4 E= -128.5309236016  delta_E= -2.13e-08  |g|= 6.06e-05  |ddm|= 0.000244
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000128241
diis-c [-7.18874587e-10  3.04297884e-04  3.54186876e-04 -1.94427148e-01
  1.19376866e+00]
  HOMO = -0.844178466876457  LUMO = 1.12776178757461
  mo_energy =
[-3.27668789e+01 -1.92583984e+00 -8.44178467e-01 -8.44178467e-01
 -8.44178467e-01  1.12776179e+00  1.15912870e+00  1.15912870e+00
  1.15912870e+00  6.16144137e+00  6.16144137e+00  6.16144137e+00
  6.37211083e+00  2.70406246e+01  2.70406246e+01  2.70406246e+01
  3.22094661e+01  1.35955658e+02  1.42781119e+02  1.42781119e+02
  1.42781119e+02  5.00255746e+02  1.86816543e+03  7.99808541e+03
  4.77660632e+04]
E1 = -182.61137338069798  E_coul = 54.08044977865021
cycle= 5 E= -128.530923602048  delta_E= -4.48e-10  |g|= 5.3e-06  |ddm|= 4.03e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.61137338069798  E_coul = 54.08044977865021
  HOMO = -0.844175748543958  LUMO = 1.12776338419408
  mo_energy =
[-3.27668733e+01 -1.92583641e+00 -8.44175749e-01 -8.44175749e-01
 -8.44175749e-01  1.12776338e+00  1.15912993e+00  1.15912993e+00
  1.15912993e+00  6.16144483e+00  6.16144483e+00  6.16144483e+00
  6.37211426e+00  2.70406297e+01  2.70406297e+01  2.70406297e+01
  3.22094713e+01  1.35955664e+02  1.42781125e+02  1.42781125e+02
  1.42781125e+02  5.00255751e+02  1.86816543e+03  7.99808542e+03
  4.77660632e+04]
E1 = -182.61136094651488  E_coul = 54.080437344465054
Extra cycle  E= -128.53092360205  delta_E= -2.05e-12  |g|= 1.76e-06  |ddm|= 1.75e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273086e+02 2.35713967e+02
 7.65366627e+01 9.96377701e+00 2.69456495e+01 3.81686236e-01
 1.03823952e+00 2.37652771e+00 4.01535722e+00 1.41007054e+01
 6.59349619e+01 3.45004652e-01 1.22022144e+00]
E = -128.53092360204982
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436525        1
[INPUT] 0    0    [1    /1   ]  833.273086217        1
[INPUT] 0    0    [1    /1   ]  235.713967147        1
[INPUT] 0    0    [1    /1   ]  76.5366627033        1
[INPUT] 0    0    [1    /1   ]  9.96377701001        1
[INPUT] 0    0    [1    /1   ]  26.9456494967        1
[INPUT] 0    0    [1    /1   ]  0.381686235703       1
[INPUT] 0    0    [1    /1   ]  1.03823952025        1
[INPUT] 0    0    [1    /1   ]  2.37652770515        1
[INPUT] 1    0    [1    /1   ]  4.01535721851        1
[INPUT] 1    0    [1    /1   ]  14.1007054266        1
[INPUT] 1    0    [1    /1   ]  65.9349618583        1
[INPUT] 1    0    [1    /1   ]  0.345004651627       1
[INPUT] 1    0    [1    /1   ]  1.22022144126        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413200013, 1.0]], [0, [3661.4543652546486, 1.0]], [0, [833.273086216833, 1.0]], [0, [235.71396714653022, 1.0]], [0, [76.53666270327204, 1.0]], [0, [9.96377701000541, 1.0]], [0, [26.945649496683426, 1.0]], [0, [0.3816862357029286, 1.0]], [0, [1.0382395202450228, 1.0]], [0, [2.376527705145024, 1.0]], [1, [4.015357218514536, 1.0]], [1, [14.100705426557209, 1.0]], [1, [65.93496185833366, 1.0]], [1, [0.345004651627092, 1.0]], [1, [1.220221441255721, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.794132]
bas 1, expnt(s) = [3661.45436525]
bas 2, expnt(s) = [833.27308622]
bas 3, expnt(s) = [235.71396715]
bas 4, expnt(s) = [76.5366627]
bas 5, expnt(s) = [9.96377701]
bas 6, expnt(s) = [26.9456495]
bas 7, expnt(s) = [0.38168624]
bas 8, expnt(s) = [1.03823952]
bas 9, expnt(s) = [2.37652771]
bas 10, expnt(s) = [4.01535722]
bas 11, expnt(s) = [14.10070543]
bas 12, expnt(s) = [65.93496186]
bas 13, expnt(s) = [0.34500465]
bas 14, expnt(s) = [1.22022144]
CPU time:       190.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273086e+02 3.91837088e+02 2.35713967e+02 1.51986149e+02
 7.65366627e+01 6.53758224e+01 9.96377701e+00 1.41687985e+01
 2.69456495e+01 2.98800635e+01 3.81686236e-01 1.22685969e+00
 1.03823952e+00 2.59859256e+00 2.37652771e+00 4.83584292e+00
 4.01535722e+00 1.65821037e+01 1.41007054e+01 7.97141542e+01
 6.59349619e+01 5.48124345e+02 3.45004652e-01 7.71375038e-01
 1.22022144e+00 3.74138764e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99797305166237
cond(S) = 324.4764360444542
E1 = -183.57438023246232  E_coul = 55.07770062161548
init E= -128.496679610847
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773880412843589  LUMO = 1.15381819261951
  mo_energy =
[-3.25552541e+01 -1.85285035e+00 -7.73880413e-01 -7.73880413e-01
 -7.73880413e-01  1.15381819e+00  1.18626845e+00  1.18626845e+00
  1.18626845e+00  6.25220671e+00  6.25220671e+00  6.25220671e+00
  6.44942377e+00  2.72027173e+01  2.72027173e+01  2.72027173e+01
  3.23684472e+01  1.36164172e+02  1.43000242e+02  1.43000242e+02
  1.43000242e+02  5.00497490e+02  1.86843799e+03  7.99838465e+03
  4.77663804e+04]
E1 = -182.13409664143964  E_coul = 53.60641422347874
cycle= 1 E= -128.527682417961  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435055
diis-c [-0.18927286  1.        ]
  HOMO = -0.877538006376257  LUMO = 1.1153495608965
  mo_energy =
[-3.28694608e+01 -1.96099177e+00 -8.77538006e-01 -8.77538006e-01
 -8.77538006e-01  1.11534956e+00  1.14602119e+00  1.14602119e+00
  1.14602119e+00  6.11814376e+00  6.11814376e+00  6.11814376e+00
  6.33529399e+00  2.69617742e+01  2.69617742e+01  2.69617742e+01
  3.21317436e+01  1.35854862e+02  1.42676494e+02  1.42676494e+02
  1.42676494e+02  5.00144703e+02  1.86804943e+03  7.99796713e+03
  4.77659441e+04]
E1 = -182.84953874105005  E_coul = 54.31942303648946
cycle= 2 E= -128.530115704561  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215355
diis-c [-5.84290430e-04  3.30045284e-01  6.69954716e-01]
  HOMO = -0.843897747274409  LUMO = 1.12782979744635
  mo_energy =
[-3.27663600e+01 -1.92562848e+00 -8.43897747e-01 -8.43897747e-01
 -8.43897747e-01  1.12782980e+00  1.15920274e+00  1.15920274e+00
  1.15920274e+00  6.16171510e+00  6.16171510e+00  6.16171510e+00
  6.37234031e+00  2.70410496e+01  2.70410496e+01  2.70410496e+01
  3.22098740e+01  1.35956174e+02  1.42781663e+02  1.42781663e+02
  1.42781663e+02  5.00256372e+02  1.86816617e+03  7.99808625e+03
  4.77660641e+04]
E1 = -182.61056824308844  E_coul = 54.07964466283141
cycle= 3 E= -128.530923580257  delta_E= -0.000808  |g|= 0.00051  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104314
diis-c [-9.76538606e-08 -2.21704913e-03  1.54164287e-04  1.00206288e+00]
  HOMO = -0.844148836456932  LUMO = 1.12777022266022
  mo_energy =
[-3.27668275e+01 -1.92582121e+00 -8.44148836e-01 -8.44148836e-01
 -8.44148836e-01  1.12777022e+00  1.15914148e+00  1.15914148e+00
  1.15914148e+00  6.16147576e+00  6.16147576e+00  6.16147576e+00
  6.37213790e+00  2.70406706e+01  2.70406706e+01  2.70406706e+01
  3.22095104e+01  1.35955710e+02  1.42781172e+02  1.42781172e+02
  1.42781172e+02  5.00255805e+02  1.86816549e+03  7.99808549e+03
  4.77660633e+04]
E1 = -182.611263636949  E_coul = 54.08034003534923
cycle= 4 E= -128.5309236016  delta_E= -2.13e-08  |g|= 6.06e-05  |ddm|= 0.000244
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000128241
diis-c [-7.18874587e-10  3.04297884e-04  3.54186876e-04 -1.94427148e-01
  1.19376866e+00]
  HOMO = -0.844178466876457  LUMO = 1.12776178757461
  mo_energy =
[-3.27668789e+01 -1.92583984e+00 -8.44178467e-01 -8.44178467e-01
 -8.44178467e-01  1.12776179e+00  1.15912870e+00  1.15912870e+00
  1.15912870e+00  6.16144137e+00  6.16144137e+00  6.16144137e+00
  6.37211083e+00  2.70406246e+01  2.70406246e+01  2.70406246e+01
  3.22094661e+01  1.35955658e+02  1.42781119e+02  1.42781119e+02
  1.42781119e+02  5.00255746e+02  1.86816543e+03  7.99808541e+03
  4.77660632e+04]
E1 = -182.61137338069798  E_coul = 54.08044977865021
cycle= 5 E= -128.530923602048  delta_E= -4.48e-10  |g|= 5.3e-06  |ddm|= 4.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61137338069798  E_coul = 54.08044977865021
  HOMO = -0.844175748543958  LUMO = 1.12776338419408
  mo_energy =
[-3.27668733e+01 -1.92583641e+00 -8.44175749e-01 -8.44175749e-01
 -8.44175749e-01  1.12776338e+00  1.15912993e+00  1.15912993e+00
  1.15912993e+00  6.16144483e+00  6.16144483e+00  6.16144483e+00
  6.37211426e+00  2.70406297e+01  2.70406297e+01  2.70406297e+01
  3.22094713e+01  1.35955664e+02  1.42781125e+02  1.42781125e+02
  1.42781125e+02  5.00255751e+02  1.86816543e+03  7.99808542e+03
  4.77660632e+04]
E1 = -182.61136094651488  E_coul = 54.080437344465054
Extra cycle  E= -128.53092360205  delta_E= -2.05e-12  |g|= 1.76e-06  |ddm|= 1.75e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 324.4764360444542
E1 = -182.61136094651488  E_coul = 54.080437344465054
init E= -128.53092360205
    CPU time for initialize scf      0.21 sec, wall time      0.20 sec
  HOMO = -0.844176623536246  LUMO = 1.12776314193893
  mo_energy =
[-3.27668761e+01 -1.92583721e+00 -8.44176624e-01 -8.44176624e-01
 -8.44176624e-01  1.12776314e+00  1.15912960e+00  1.15912960e+00
  1.15912960e+00  6.16144370e+00  6.16144370e+00  6.16144370e+00
  6.37211337e+00  2.70406276e+01  2.70406276e+01  2.70406276e+01
  3.22094693e+01  1.35955661e+02  1.42781122e+02  1.42781122e+02
  1.42781122e+02  5.00255748e+02  1.86816543e+03  7.99808542e+03
  4.77660632e+04]
E1 = -182.611367635704  E_coul = 54.080444033653734
cycle= 1 E= -128.53092360205  delta_E= -4.55e-13  |g|= 9.24e-07  |ddm|= 6.91e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.611367635704  E_coul = 54.080444033653734
  HOMO = -0.844176155680134  LUMO = 1.1277633304364
  mo_energy =
[-3.27668746e+01 -1.92583669e+00 -8.44176156e-01 -8.44176156e-01
 -8.44176156e-01  1.12776333e+00  1.15912978e+00  1.15912978e+00
  1.15912978e+00  6.16144431e+00  6.16144431e+00  6.16144431e+00
  6.37211390e+00  2.70406287e+01  2.70406287e+01  2.70406287e+01
  3.22094704e+01  1.35955662e+02  1.42781123e+02  1.42781123e+02
  1.42781123e+02  5.00255749e+02  1.86816543e+03  7.99808542e+03
  4.77660632e+04]
E1 = -182.61136433855168  E_coul = 54.0804407365014
Extra cycle  E= -128.53092360205  delta_E=    0  |g|= 4.48e-07  |ddm|= 3.39e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273086e+02 2.35713967e+02
 7.65366627e+01 9.96377701e+00 2.69456495e+01 3.81686236e-01
 1.03823952e+00 2.37652771e+00 4.01535722e+00 1.41007054e+01
 6.59349619e+01 3.45004652e-01 1.22022144e+00]
grad_E = [ 1.30201851e-09 -6.76344324e-08  1.33929996e-06 -1.46111339e-05
  9.63067969e-05  7.67024513e-04 -3.41617629e-04  1.60267993e-03
  1.10212416e-03 -1.54006155e-03 -5.31256603e-04  2.13934351e-04
  8.49894180e-05 -8.12052889e-04  5.17695507e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436563        1
[INPUT] 0    0    [1    /1   ]  833.273078762        1
[INPUT] 0    0    [1    /1   ]  235.714051728        1
[INPUT] 0    0    [1    /1   ]  76.5361005672        1
[INPUT] 0    0    [1    /1   ]  9.96252091191        1
[INPUT] 0    0    [1    /1   ]  26.947608234         1
[INPUT] 0    0    [1    /1   ]  0.384381417965       1
[INPUT] 0    0    [1    /1   ]  1.04349705592        1
[INPUT] 0    0    [1    /1   ]  2.3775886016         1
[INPUT] 1    0    [1    /1   ]  4.02486739029        1
[INPUT] 1    0    [1    /1   ]  14.099942562         1
[INPUT] 1    0    [1    /1   ]  65.7159126792        1
[INPUT] 1    0    [1    /1   ]  0.344974129212       1
[INPUT] 1    0    [1    /1   ]  1.22182728115        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131993098, 1.0]], [0, [3661.454365633122, 1.0]], [0, [833.2730787619961, 1.0]], [0, [235.7140517276791, 1.0]], [0, [76.53610056721898, 1.0]], [0, [9.96252091191477, 1.0]], [0, [26.947608234021498, 1.0]], [0, [0.38438141796532876, 1.0]], [0, [1.0434970559162855, 1.0]], [0, [2.377588601604866, 1.0]], [1, [4.024867390289856, 1.0]], [1, [14.099942561990666, 1.0]], [1, [65.71591267916234, 1.0]], [1, [0.3449741292115771, 1.0]], [1, [1.2218272811477724, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413199]
bas 1, expnt(s) = [3661.45436563]
bas 2, expnt(s) = [833.27307876]
bas 3, expnt(s) = [235.71405173]
bas 4, expnt(s) = [76.53610057]
bas 5, expnt(s) = [9.96252091]
bas 6, expnt(s) = [26.94760823]
bas 7, expnt(s) = [0.38438142]
bas 8, expnt(s) = [1.04349706]
bas 9, expnt(s) = [2.3775886]
bas 10, expnt(s) = [4.02486739]
bas 11, expnt(s) = [14.09994256]
bas 12, expnt(s) = [65.71591268]
bas 13, expnt(s) = [0.34497413]
bas 14, expnt(s) = [1.22182728]
CPU time:       193.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273079e+02 3.91837085e+02 2.35714052e+02 1.51986190e+02
 7.65361006e+01 6.53754623e+01 9.96252091e+00 1.41674588e+01
 2.69476082e+01 2.98816925e+01 3.84381418e-01 1.23335135e+00
 1.04349706e+00 2.60845558e+00 2.37758860e+00 4.83746189e+00
 4.02486739e+00 1.66312106e+01 1.40999426e+01 7.97087635e+01
 6.57159127e+01 5.45849067e+02 3.44974129e-01 7.71289735e-01
 1.22182728e+00 3.74754335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997965681153719
cond(S) = 326.84029543649393
E1 = -183.57440335978748  E_coul = 55.07769782497242
init E= -128.496705534815
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773885148470135  LUMO = 1.16338170368821
  mo_energy =
[-3.25552528e+01 -1.85284643e+00 -7.73885148e-01 -7.73885148e-01
 -7.73885148e-01  1.16338170e+00  1.18661509e+00  1.18661509e+00
  1.18661509e+00  6.26292957e+00  6.26292957e+00  6.26292957e+00
  6.47820346e+00  2.72359461e+01  2.72359461e+01  2.72359461e+01
  3.24057100e+01  1.36199000e+02  1.42678945e+02  1.42678945e+02
  1.42678945e+02  5.00529630e+02  1.86846684e+03  7.99841003e+03
  4.77664014e+04]
E1 = -182.13407231591623  E_coul = 53.606378097487806
cycle= 1 E= -128.527694218428  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.43522
diis-c [-0.18941622  1.        ]
  HOMO = -0.877548532370256  LUMO = 1.1246500313329
  mo_energy =
[-3.28694350e+01 -1.96101058e+00 -8.77548532e-01 -8.77548532e-01
 -8.77548532e-01  1.12465003e+00  1.14633668e+00  1.14633668e+00
  1.14633668e+00  6.12866265e+00  6.12866265e+00  6.12866265e+00
  6.36391621e+00  2.69949798e+01  2.69949798e+01  2.69949798e+01
  3.21690129e+01  1.35889718e+02  1.42355361e+02  1.42355361e+02
  1.42355361e+02  5.00176876e+02  1.86807831e+03  7.99799254e+03
  4.77659651e+04]
E1 = -182.84963470323848  E_coul = 54.31950664018315
cycle= 2 E= -128.530128063055  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.21543
diis-c [-5.84666826e-04  3.30039141e-01  6.69960859e-01]
  HOMO = -0.843902566370882  LUMO = 1.1372164282977
  mo_energy =
[-3.27663161e+01 -1.92564006e+00 -8.43902566e-01 -8.43902566e-01
 -8.43902566e-01  1.13721643e+00  1.15953247e+00  1.15953247e+00
  1.15953247e+00  6.17230424e+00  6.17230424e+00  6.17230424e+00
  6.40101867e+00  2.70742752e+01  2.70742752e+01  2.70742752e+01
  3.22471499e+01  1.35991044e+02  1.42460511e+02  1.42460511e+02
  1.42460511e+02  5.00288562e+02  1.86819507e+03  7.99811168e+03
  4.77660852e+04]
E1 = -182.61063116893646  E_coul = 54.079694983508105
cycle= 3 E= -128.530936185428  delta_E= -0.000808  |g|= 0.000507  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104383
diis-c [-9.46750283e-08 -2.21236667e-03  1.72306121e-04  1.00204006e+00]
  HOMO = -0.844152687394844  LUMO = 1.13715659575623
  mo_energy =
[-3.27667842e+01 -1.92583299e+00 -8.44152687e-01 -8.44152687e-01
 -8.44152687e-01  1.13715660e+00  1.15947172e+00  1.15947172e+00
  1.15947172e+00  6.17206527e+00  6.17206527e+00  6.17206527e+00
  6.40081666e+00  2.70738962e+01  2.70738962e+01  2.70738962e+01
  3.22467864e+01  1.35990579e+02  1.42460020e+02  1.42460020e+02
  1.42460020e+02  5.00287994e+02  1.86819439e+03  7.99811091e+03
  4.77660844e+04]
E1 = -182.61133117416063  E_coul = 54.08039496777524
cycle= 4 E= -128.530936206385  delta_E= -2.1e-08  |g|= 5.98e-05  |ddm|= 0.000238
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000127072
diis-c [-6.98985541e-10  2.98810063e-04  3.49373153e-04 -1.91595036e-01
  1.19094685e+00]
  HOMO = -0.844181985331111  LUMO = 1.13714811495577
  mo_energy =
[-3.27668352e+01 -1.92585163e+00 -8.44181985e-01 -8.44181985e-01
 -8.44181985e-01  1.13714811e+00  1.15945908e+00  1.15945908e+00
  1.15945908e+00  6.17203116e+00  6.17203116e+00  6.17203116e+00
  6.40078976e+00  2.70738504e+01  2.70738504e+01  2.70738504e+01
  3.22467424e+01  1.35990528e+02  1.42459967e+02  1.42459967e+02
  1.42459967e+02  5.00287935e+02  1.86819432e+03  7.99811084e+03
  4.77660843e+04]
E1 = -182.61144053093753  E_coul = 54.08050432412027
cycle= 5 E= -128.530936206817  delta_E= -4.32e-10  |g|= 5.21e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61144053093753  E_coul = 54.08050432412027
  HOMO = -0.844179332804973  LUMO = 1.13714968814504
  mo_energy =
[-3.27668297e+01 -1.92584826e+00 -8.44179333e-01 -8.44179333e-01
 -8.44179333e-01  1.13714969e+00  1.15946028e+00  1.15946028e+00
  1.15946028e+00  6.17203454e+00  6.17203454e+00  6.17203454e+00
  6.40079312e+00  2.70738554e+01  2.70738554e+01  2.70738554e+01
  3.22467475e+01  1.35990533e+02  1.42459973e+02  1.42459973e+02
  1.42459973e+02  5.00287941e+02  1.86819433e+03  7.99811085e+03
  4.77660843e+04]
E1 = -182.6114283039282  E_coul = 54.08049209710899
Extra cycle  E= -128.530936206819  delta_E= -1.93e-12  |g|= 1.73e-06  |ddm|= 1.73e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273079e+02 2.35714052e+02
 7.65361006e+01 9.96252091e+00 2.69476082e+01 3.84381418e-01
 1.04349706e+00 2.37758860e+00 4.02486739e+00 1.40999426e+01
 6.57159127e+01 3.44974129e-01 1.22182728e+00]
E = -128.5309362068192
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436563        1
[INPUT] 0    0    [1    /1   ]  833.273078762        1
[INPUT] 0    0    [1    /1   ]  235.714051728        1
[INPUT] 0    0    [1    /1   ]  76.5361005672        1
[INPUT] 0    0    [1    /1   ]  9.96252091191        1
[INPUT] 0    0    [1    /1   ]  26.947608234         1
[INPUT] 0    0    [1    /1   ]  0.384381417965       1
[INPUT] 0    0    [1    /1   ]  1.04349705592        1
[INPUT] 0    0    [1    /1   ]  2.3775886016         1
[INPUT] 1    0    [1    /1   ]  4.02486739029        1
[INPUT] 1    0    [1    /1   ]  14.099942562         1
[INPUT] 1    0    [1    /1   ]  65.7159126792        1
[INPUT] 1    0    [1    /1   ]  0.344974129212       1
[INPUT] 1    0    [1    /1   ]  1.22182728115        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131993098, 1.0]], [0, [3661.454365633122, 1.0]], [0, [833.2730787619961, 1.0]], [0, [235.7140517276791, 1.0]], [0, [76.53610056721898, 1.0]], [0, [9.96252091191477, 1.0]], [0, [26.947608234021498, 1.0]], [0, [0.38438141796532876, 1.0]], [0, [1.0434970559162855, 1.0]], [0, [2.377588601604866, 1.0]], [1, [4.024867390289856, 1.0]], [1, [14.099942561990666, 1.0]], [1, [65.71591267916234, 1.0]], [1, [0.3449741292115771, 1.0]], [1, [1.2218272811477724, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413199]
bas 1, expnt(s) = [3661.45436563]
bas 2, expnt(s) = [833.27307876]
bas 3, expnt(s) = [235.71405173]
bas 4, expnt(s) = [76.53610057]
bas 5, expnt(s) = [9.96252091]
bas 6, expnt(s) = [26.94760823]
bas 7, expnt(s) = [0.38438142]
bas 8, expnt(s) = [1.04349706]
bas 9, expnt(s) = [2.3775886]
bas 10, expnt(s) = [4.02486739]
bas 11, expnt(s) = [14.09994256]
bas 12, expnt(s) = [65.71591268]
bas 13, expnt(s) = [0.34497413]
bas 14, expnt(s) = [1.22182728]
CPU time:       194.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273079e+02 3.91837085e+02 2.35714052e+02 1.51986190e+02
 7.65361006e+01 6.53754623e+01 9.96252091e+00 1.41674588e+01
 2.69476082e+01 2.98816925e+01 3.84381418e-01 1.23335135e+00
 1.04349706e+00 2.60845558e+00 2.37758860e+00 4.83746189e+00
 4.02486739e+00 1.66312106e+01 1.40999426e+01 7.97087635e+01
 6.57159127e+01 5.45849067e+02 3.44974129e-01 7.71289735e-01
 1.22182728e+00 3.74754335e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997965681153719
cond(S) = 326.84029543649393
E1 = -183.57440335978748  E_coul = 55.07769782497242
init E= -128.496705534815
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773885148470135  LUMO = 1.16338170368821
  mo_energy =
[-3.25552528e+01 -1.85284643e+00 -7.73885148e-01 -7.73885148e-01
 -7.73885148e-01  1.16338170e+00  1.18661509e+00  1.18661509e+00
  1.18661509e+00  6.26292957e+00  6.26292957e+00  6.26292957e+00
  6.47820346e+00  2.72359461e+01  2.72359461e+01  2.72359461e+01
  3.24057100e+01  1.36199000e+02  1.42678945e+02  1.42678945e+02
  1.42678945e+02  5.00529630e+02  1.86846684e+03  7.99841003e+03
  4.77664014e+04]
E1 = -182.13407231591623  E_coul = 53.606378097487806
cycle= 1 E= -128.527694218428  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.43522
diis-c [-0.18941622  1.        ]
  HOMO = -0.877548532370256  LUMO = 1.1246500313329
  mo_energy =
[-3.28694350e+01 -1.96101058e+00 -8.77548532e-01 -8.77548532e-01
 -8.77548532e-01  1.12465003e+00  1.14633668e+00  1.14633668e+00
  1.14633668e+00  6.12866265e+00  6.12866265e+00  6.12866265e+00
  6.36391621e+00  2.69949798e+01  2.69949798e+01  2.69949798e+01
  3.21690129e+01  1.35889718e+02  1.42355361e+02  1.42355361e+02
  1.42355361e+02  5.00176876e+02  1.86807831e+03  7.99799254e+03
  4.77659651e+04]
E1 = -182.84963470323848  E_coul = 54.31950664018315
cycle= 2 E= -128.530128063055  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.21543
diis-c [-5.84666826e-04  3.30039141e-01  6.69960859e-01]
  HOMO = -0.843902566370882  LUMO = 1.1372164282977
  mo_energy =
[-3.27663161e+01 -1.92564006e+00 -8.43902566e-01 -8.43902566e-01
 -8.43902566e-01  1.13721643e+00  1.15953247e+00  1.15953247e+00
  1.15953247e+00  6.17230424e+00  6.17230424e+00  6.17230424e+00
  6.40101867e+00  2.70742752e+01  2.70742752e+01  2.70742752e+01
  3.22471499e+01  1.35991044e+02  1.42460511e+02  1.42460511e+02
  1.42460511e+02  5.00288562e+02  1.86819507e+03  7.99811168e+03
  4.77660852e+04]
E1 = -182.61063116893646  E_coul = 54.079694983508105
cycle= 3 E= -128.530936185428  delta_E= -0.000808  |g|= 0.000507  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104383
diis-c [-9.46750283e-08 -2.21236667e-03  1.72306121e-04  1.00204006e+00]
  HOMO = -0.844152687394844  LUMO = 1.13715659575623
  mo_energy =
[-3.27667842e+01 -1.92583299e+00 -8.44152687e-01 -8.44152687e-01
 -8.44152687e-01  1.13715660e+00  1.15947172e+00  1.15947172e+00
  1.15947172e+00  6.17206527e+00  6.17206527e+00  6.17206527e+00
  6.40081666e+00  2.70738962e+01  2.70738962e+01  2.70738962e+01
  3.22467864e+01  1.35990579e+02  1.42460020e+02  1.42460020e+02
  1.42460020e+02  5.00287994e+02  1.86819439e+03  7.99811091e+03
  4.77660844e+04]
E1 = -182.61133117416063  E_coul = 54.08039496777524
cycle= 4 E= -128.530936206385  delta_E= -2.1e-08  |g|= 5.98e-05  |ddm|= 0.000238
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000127072
diis-c [-6.98985541e-10  2.98810063e-04  3.49373153e-04 -1.91595036e-01
  1.19094685e+00]
  HOMO = -0.844181985331111  LUMO = 1.13714811495577
  mo_energy =
[-3.27668352e+01 -1.92585163e+00 -8.44181985e-01 -8.44181985e-01
 -8.44181985e-01  1.13714811e+00  1.15945908e+00  1.15945908e+00
  1.15945908e+00  6.17203116e+00  6.17203116e+00  6.17203116e+00
  6.40078976e+00  2.70738504e+01  2.70738504e+01  2.70738504e+01
  3.22467424e+01  1.35990528e+02  1.42459967e+02  1.42459967e+02
  1.42459967e+02  5.00287935e+02  1.86819432e+03  7.99811084e+03
  4.77660843e+04]
E1 = -182.61144053093753  E_coul = 54.08050432412027
cycle= 5 E= -128.530936206817  delta_E= -4.32e-10  |g|= 5.21e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61144053093753  E_coul = 54.08050432412027
  HOMO = -0.844179332804973  LUMO = 1.13714968814504
  mo_energy =
[-3.27668297e+01 -1.92584826e+00 -8.44179333e-01 -8.44179333e-01
 -8.44179333e-01  1.13714969e+00  1.15946028e+00  1.15946028e+00
  1.15946028e+00  6.17203454e+00  6.17203454e+00  6.17203454e+00
  6.40079312e+00  2.70738554e+01  2.70738554e+01  2.70738554e+01
  3.22467475e+01  1.35990533e+02  1.42459973e+02  1.42459973e+02
  1.42459973e+02  5.00287941e+02  1.86819433e+03  7.99811085e+03
  4.77660843e+04]
E1 = -182.6114283039282  E_coul = 54.08049209710899
Extra cycle  E= -128.530936206819  delta_E= -1.93e-12  |g|= 1.73e-06  |ddm|= 1.73e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 326.84029543649393
E1 = -182.6114283039282  E_coul = 54.08049209710899
init E= -128.530936206819
    CPU time for initialize scf      0.21 sec, wall time      0.20 sec
  HOMO = -0.84418019441955  LUMO = 1.13714944865542
  mo_energy =
[-3.27668324e+01 -1.92584904e+00 -8.44180194e-01 -8.44180194e-01
 -8.44180194e-01  1.13714945e+00  1.15945996e+00  1.15945996e+00
  1.15945996e+00  6.17203343e+00  6.17203343e+00  6.17203343e+00
  6.40079225e+00  2.70738533e+01  2.70738533e+01  2.70738533e+01
  3.22467455e+01  1.35990531e+02  1.42459970e+02  1.42459970e+02
  1.42459970e+02  5.00287937e+02  1.86819432e+03  7.99811084e+03
  4.77660843e+04]
E1 = -182.61143487489176  E_coul = 54.080498668072174
cycle= 1 E= -128.53093620682  delta_E= -3.69e-13  |g|= 9.08e-07  |ddm|= 6.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61143487489176  E_coul = 54.080498668072174
  HOMO = -0.844179735039823  LUMO = 1.13714963523862
  mo_energy =
[-3.27668310e+01 -1.92584853e+00 -8.44179735e-01 -8.44179735e-01
 -8.44179735e-01  1.13714964e+00  1.15946014e+00  1.15946014e+00
  1.15946014e+00  6.17203403e+00  6.17203403e+00  6.17203403e+00
  6.40079277e+00  2.70738544e+01  2.70738544e+01  2.70738544e+01
  3.22467465e+01  1.35990532e+02  1.42459971e+02  1.42459971e+02
  1.42459971e+02  5.00287939e+02  1.86819432e+03  7.99811084e+03
  4.77660843e+04]
E1 = -182.6114316357125  E_coul = 54.080495428892824
Extra cycle  E= -128.53093620682  delta_E= -1.14e-13  |g|= 4.4e-07  |ddm|= 3.34e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273079e+02 2.35714052e+02
 7.65361006e+01 9.96252091e+00 2.69476082e+01 3.84381418e-01
 1.04349706e+00 2.37758860e+00 4.02486739e+00 1.40999426e+01
 6.57159127e+01 3.44974129e-01 1.22182728e+00]
grad_E = [ 1.26554642e-09 -6.57309042e-08  1.30098501e-06 -1.41671276e-05
  9.29121172e-05  7.28213511e-04 -3.25643470e-04  2.24538607e-03
  1.00046145e-03 -1.52117056e-03  1.82833545e-04  1.23349866e-04
  8.32038880e-05 -1.50842934e-03 -3.69204742e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.4543663         1
[INPUT] 0    0    [1    /1   ]  833.27306566         1
[INPUT] 0    0    [1    /1   ]  235.714197678        1
[INPUT] 0    0    [1    /1   ]  76.5351585414        1
[INPUT] 0    0    [1    /1   ]  9.9605673245         1
[INPUT] 0    0    [1    /1   ]  26.9506405982        1
[INPUT] 0    0    [1    /1   ]  0.386868722928       1
[INPUT] 0    0    [1    /1   ]  1.04834506816        1
[INPUT] 0    0    [1    /1   ]  2.38213946663        1
[INPUT] 1    0    [1    /1   ]  4.03390248145        1
[INPUT] 1    0    [1    /1   ]  14.0774748019        1
[INPUT] 1    0    [1    /1   ]  65.3724143465        1
[INPUT] 1    0    [1    /1   ]  0.344969262902       1
[INPUT] 1    0    [1    /1   ]  1.22339119246        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131980656, 1.0]], [0, [3661.4543662991555, 1.0]], [0, [833.2730656598995, 1.0]], [0, [235.7141976779932, 1.0]], [0, [76.53515854137827, 1.0]], [0, [9.960567324496449, 1.0]], [0, [26.95064059824462, 1.0]], [0, [0.38686872292798674, 1.0]], [0, [1.0483450681595967, 1.0]], [0, [2.3821394666331024, 1.0]], [1, [4.033902481445079, 1.0]], [1, [14.077474801898362, 1.0]], [1, [65.37241434647902, 1.0]], [1, [0.3449692629015309, 1.0]], [1, [1.2233911924636967, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413198]
bas 1, expnt(s) = [3661.4543663]
bas 2, expnt(s) = [833.27306566]
bas 3, expnt(s) = [235.71419768]
bas 4, expnt(s) = [76.53515854]
bas 5, expnt(s) = [9.96056732]
bas 6, expnt(s) = [26.9506406]
bas 7, expnt(s) = [0.38686872]
bas 8, expnt(s) = [1.04834507]
bas 9, expnt(s) = [2.38213947]
bas 10, expnt(s) = [4.03390248]
bas 11, expnt(s) = [14.0774748]
bas 12, expnt(s) = [65.37241435]
bas 13, expnt(s) = [0.34496926]
bas 14, expnt(s) = [1.22339119]
CPU time:       197.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273066e+02 3.91837081e+02 2.35714198e+02 1.51986261e+02
 7.65351585e+01 6.53748588e+01 9.96056732e+00 1.41653751e+01
 2.69506406e+01 2.98842144e+01 3.86868723e-01 1.23933222e+00
 1.04834507e+00 2.61753933e+00 2.38213947e+00 4.84440465e+00
 4.03390248e+00 1.66778912e+01 1.40774748e+01 7.95500287e+01
 6.53724143e+01 5.42284946e+02 3.44969263e-01 7.71276135e-01
 1.22339119e+00 3.75354027e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99795832593151
cond(S) = 328.92689057340584
E1 = -183.57447595751327  E_coul = 55.07771238240222
init E= -128.496763575111
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773888955539859  LUMO = 1.17239553475555
  mo_energy =
[-3.25552508e+01 -1.85284302e+00 -7.73888956e-01 -7.73888956e-01
 -7.73888956e-01  1.17239553e+00  1.18698246e+00  1.18698246e+00
  1.18698246e+00  6.27353008e+00  6.27353008e+00  6.27353008e+00
  6.50962501e+00  2.72444681e+01  2.72444681e+01  2.72444681e+01
  3.24529704e+01  1.36245121e+02  1.42089793e+02  1.42089793e+02
  1.42089793e+02  5.00572635e+02  1.86850548e+03  7.99844404e+03
  4.77664296e+04]
E1 = -182.13431748974696  E_coul = 53.60660043499097
cycle= 1 E= -128.527717054756  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435499
diis-c [-0.18965965  1.        ]
  HOMO = -0.877540430853944  LUMO = 1.13342275245224
  mo_energy =
[-3.28693604e+01 -1.96101013e+00 -8.77540431e-01 -8.77540431e-01
 -8.77540431e-01  1.13342275e+00  1.14668638e+00  1.14668638e+00
  1.14668638e+00  6.13909483e+00  6.13909483e+00  6.13909483e+00
  6.39514045e+00  2.70036219e+01  2.70036219e+01  2.70036219e+01
  3.22162959e+01  1.35935913e+02  1.41766497e+02  1.41766497e+02
  1.41766497e+02  5.00219961e+02  1.86811703e+03  7.99802663e+03
  4.77659934e+04]
E1 = -182.84996023425623  E_coul = 54.319809020229
cycle= 2 E= -128.530151214027  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.0701
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.215559
diis-c [-5.84875119e-04  3.30029997e-01  6.69970003e-01]
  HOMO = -0.843890400420913  LUMO = 1.14607288666232
  mo_energy =
[-3.27662289e+01 -1.92563420e+00 -8.43890400e-01 -8.43890400e-01
 -8.43890400e-01  1.14607289e+00  1.15989526e+00  1.15989526e+00
  1.15989526e+00  6.18279974e+00  6.18279974e+00  6.18279974e+00
  6.43231715e+00  2.70828970e+01  2.70828970e+01  2.70828970e+01
  3.22944384e+01  1.36037247e+02  1.41871602e+02  1.41871602e+02
  1.41871602e+02  5.00331658e+02  1.86823379e+03  7.99814577e+03
  4.77661134e+04]
E1 = -182.61095498538623  E_coul = 54.079995554004824
cycle= 3 E= -128.530959431381  delta_E= -0.000808  |g|= 0.000503  |ddm|= 0.0239
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00104276
diis-c [-9.20579688e-08 -2.20416986e-03  1.86884073e-04  1.00201729e+00]
  HOMO = -0.844138308860092  LUMO = 1.14601366453434
  mo_energy =
[-3.27666958e+01 -1.92582589e+00 -8.44138309e-01 -8.44138309e-01
 -8.44138309e-01  1.14601366e+00  1.15983567e+00  1.15983567e+00
  1.15983567e+00  6.18256261e+00  6.18256261e+00  6.18256261e+00
  6.43211697e+00  2.70825197e+01  2.70825197e+01  2.70825197e+01
  3.22940765e+01  1.36036783e+02  1.41871112e+02  1.41871112e+02
  1.41871112e+02  5.00331090e+02  1.86823311e+03  7.99814501e+03
  4.77661126e+04]
E1 = -182.61165782815374  E_coul = 54.080698376297285
cycle= 4 E= -128.530959451856  delta_E= -2.05e-08  |g|= 5.9e-05  |ddm|= 0.000232
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000126031
diis-c [-6.80373235e-10  2.94187357e-04  3.46071715e-04 -1.89333114e-01
  1.18869285e+00]
  HOMO = -0.844167199478185  LUMO = 1.14600521893951
  mo_energy =
[-3.27667466e+01 -1.92584441e+00 -8.44167199e-01 -8.44167199e-01
 -8.44167199e-01  1.14600522e+00  1.15982321e+00  1.15982321e+00
  1.15982321e+00  6.18252887e+00  6.18252887e+00  6.18252887e+00
  6.43209036e+00  2.70824744e+01  2.70824744e+01  2.70824744e+01
  3.22940329e+01  1.36036732e+02  1.41871059e+02  1.41871059e+02
  1.41871059e+02  5.00331031e+02  1.86823305e+03  7.99814494e+03
  4.77661125e+04]
E1 = -182.6117668836792  E_coul = 54.08080743140588
cycle= 5 E= -128.530959452273  delta_E= -4.17e-10  |g|= 5.12e-06  |ddm|= 3.81e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.6117668836792  E_coul = 54.08080743140588
  HOMO = -0.844164605206913  LUMO = 1.14600676874707
  mo_energy =
[-3.27667411e+01 -1.92584110e+00 -8.44164605e-01 -8.44164605e-01
 -8.44164605e-01  1.14600677e+00  1.15982438e+00  1.15982438e+00
  1.15982438e+00  6.18253219e+00  6.18253219e+00  6.18253219e+00
  6.43209366e+00  2.70824793e+01  2.70824793e+01  2.70824793e+01
  3.22940379e+01  1.36036738e+02  1.41871065e+02  1.41871065e+02
  1.41871065e+02  5.00331037e+02  1.86823305e+03  7.99814494e+03
  4.77661125e+04]
E1 = -182.61175480236545  E_coul = 54.08079535009047
Extra cycle  E= -128.530959452275  delta_E= -1.68e-12  |g|= 1.71e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273066e+02 2.35714198e+02
 7.65351585e+01 9.96056732e+00 2.69506406e+01 3.86868723e-01
 1.04834507e+00 2.38213947e+00 4.03390248e+00 1.40774748e+01
 6.53724143e+01 3.44969263e-01 1.22339119e+00]
E = -128.530959452275
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.4543663         1
[INPUT] 0    0    [1    /1   ]  833.27306566         1
[INPUT] 0    0    [1    /1   ]  235.714197678        1
[INPUT] 0    0    [1    /1   ]  76.5351585414        1
[INPUT] 0    0    [1    /1   ]  9.9605673245         1
[INPUT] 0    0    [1    /1   ]  26.9506405982        1
[INPUT] 0    0    [1    /1   ]  0.386868722928       1
[INPUT] 0    0    [1    /1   ]  1.04834506816        1
[INPUT] 0    0    [1    /1   ]  2.38213946663        1
[INPUT] 1    0    [1    /1   ]  4.03390248145        1
[INPUT] 1    0    [1    /1   ]  14.0774748019        1
[INPUT] 1    0    [1    /1   ]  65.3724143465        1
[INPUT] 1    0    [1    /1   ]  0.344969262902       1
[INPUT] 1    0    [1    /1   ]  1.22339119246        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131980656, 1.0]], [0, [3661.4543662991555, 1.0]], [0, [833.2730656598995, 1.0]], [0, [235.7141976779932, 1.0]], [0, [76.53515854137827, 1.0]], [0, [9.960567324496449, 1.0]], [0, [26.95064059824462, 1.0]], [0, [0.38686872292798674, 1.0]], [0, [1.0483450681595967, 1.0]], [0, [2.3821394666331024, 1.0]], [1, [4.033902481445079, 1.0]], [1, [14.077474801898362, 1.0]], [1, [65.37241434647902, 1.0]], [1, [0.3449692629015309, 1.0]], [1, [1.2233911924636967, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413198]
bas 1, expnt(s) = [3661.4543663]
bas 2, expnt(s) = [833.27306566]
bas 3, expnt(s) = [235.71419768]
bas 4, expnt(s) = [76.53515854]
bas 5, expnt(s) = [9.96056732]
bas 6, expnt(s) = [26.9506406]
bas 7, expnt(s) = [0.38686872]
bas 8, expnt(s) = [1.04834507]
bas 9, expnt(s) = [2.38213947]
bas 10, expnt(s) = [4.03390248]
bas 11, expnt(s) = [14.0774748]
bas 12, expnt(s) = [65.37241435]
bas 13, expnt(s) = [0.34496926]
bas 14, expnt(s) = [1.22339119]
CPU time:       198.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273066e+02 3.91837081e+02 2.35714198e+02 1.51986261e+02
 7.65351585e+01 6.53748588e+01 9.96056732e+00 1.41653751e+01
 2.69506406e+01 2.98842144e+01 3.86868723e-01 1.23933222e+00
 1.04834507e+00 2.61753933e+00 2.38213947e+00 4.84440465e+00
 4.03390248e+00 1.66778912e+01 1.40774748e+01 7.95500287e+01
 6.53724143e+01 5.42284946e+02 3.44969263e-01 7.71276135e-01
 1.22339119e+00 3.75354027e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99795832593151
cond(S) = 328.92689057340584
E1 = -183.57447595751327  E_coul = 55.07771238240222
init E= -128.496763575111
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773888955539859  LUMO = 1.17239553475555
  mo_energy =
[-3.25552508e+01 -1.85284302e+00 -7.73888956e-01 -7.73888956e-01
 -7.73888956e-01  1.17239553e+00  1.18698246e+00  1.18698246e+00
  1.18698246e+00  6.27353008e+00  6.27353008e+00  6.27353008e+00
  6.50962501e+00  2.72444681e+01  2.72444681e+01  2.72444681e+01
  3.24529704e+01  1.36245121e+02  1.42089793e+02  1.42089793e+02
  1.42089793e+02  5.00572635e+02  1.86850548e+03  7.99844404e+03
  4.77664296e+04]
E1 = -182.13431748974696  E_coul = 53.60660043499097
cycle= 1 E= -128.527717054756  delta_E= -0.031  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.435499
diis-c [-0.18965965  1.        ]
  HOMO = -0.877540430853944  LUMO = 1.13342275245224
  mo_energy =
[-3.28693604e+01 -1.96101013e+00 -8.77540431e-01 -8.77540431e-01
 -8.77540431e-01  1.13342275e+00  1.14668638e+00  1.14668638e+00
  1.14668638e+00  6.13909483e+00  6.13909483e+00  6.13909483e+00
  6.39514045e+00  2.70036219e+01  2.70036219e+01  2.70036219e+01
  3.22162959e+01  1.35935913e+02  1.41766497e+02  1.41766497e+02
  1.41766497e+02  5.00219961e+02  1.86811703e+03  7.99802663e+03
  4.77659934e+04]
E1 = -182.84996023425623  E_coul = 54.319809020229
cycle= 2 E= -128.530151214027  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215559
diis-c [-5.84875119e-04  3.30029997e-01  6.69970003e-01]
  HOMO = -0.843890400420913  LUMO = 1.14607288666232
  mo_energy =
[-3.27662289e+01 -1.92563420e+00 -8.43890400e-01 -8.43890400e-01
 -8.43890400e-01  1.14607289e+00  1.15989526e+00  1.15989526e+00
  1.15989526e+00  6.18279974e+00  6.18279974e+00  6.18279974e+00
  6.43231715e+00  2.70828970e+01  2.70828970e+01  2.70828970e+01
  3.22944384e+01  1.36037247e+02  1.41871602e+02  1.41871602e+02
  1.41871602e+02  5.00331658e+02  1.86823379e+03  7.99814577e+03
  4.77661134e+04]
E1 = -182.61095498538623  E_coul = 54.079995554004824
cycle= 3 E= -128.530959431381  delta_E= -0.000808  |g|= 0.000503  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104276
diis-c [-9.20579688e-08 -2.20416986e-03  1.86884073e-04  1.00201729e+00]
  HOMO = -0.844138308860092  LUMO = 1.14601366453434
  mo_energy =
[-3.27666958e+01 -1.92582589e+00 -8.44138309e-01 -8.44138309e-01
 -8.44138309e-01  1.14601366e+00  1.15983567e+00  1.15983567e+00
  1.15983567e+00  6.18256261e+00  6.18256261e+00  6.18256261e+00
  6.43211697e+00  2.70825197e+01  2.70825197e+01  2.70825197e+01
  3.22940765e+01  1.36036783e+02  1.41871112e+02  1.41871112e+02
  1.41871112e+02  5.00331090e+02  1.86823311e+03  7.99814501e+03
  4.77661126e+04]
E1 = -182.61165782815374  E_coul = 54.080698376297285
cycle= 4 E= -128.530959451856  delta_E= -2.05e-08  |g|= 5.9e-05  |ddm|= 0.000232
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000126031
diis-c [-6.80373235e-10  2.94187357e-04  3.46071715e-04 -1.89333114e-01
  1.18869285e+00]
  HOMO = -0.844167199478185  LUMO = 1.14600521893951
  mo_energy =
[-3.27667466e+01 -1.92584441e+00 -8.44167199e-01 -8.44167199e-01
 -8.44167199e-01  1.14600522e+00  1.15982321e+00  1.15982321e+00
  1.15982321e+00  6.18252887e+00  6.18252887e+00  6.18252887e+00
  6.43209036e+00  2.70824744e+01  2.70824744e+01  2.70824744e+01
  3.22940329e+01  1.36036732e+02  1.41871059e+02  1.41871059e+02
  1.41871059e+02  5.00331031e+02  1.86823305e+03  7.99814494e+03
  4.77661125e+04]
E1 = -182.6117668836792  E_coul = 54.08080743140588
cycle= 5 E= -128.530959452273  delta_E= -4.17e-10  |g|= 5.12e-06  |ddm|= 3.81e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6117668836792  E_coul = 54.08080743140588
  HOMO = -0.844164605206913  LUMO = 1.14600676874707
  mo_energy =
[-3.27667411e+01 -1.92584110e+00 -8.44164605e-01 -8.44164605e-01
 -8.44164605e-01  1.14600677e+00  1.15982438e+00  1.15982438e+00
  1.15982438e+00  6.18253219e+00  6.18253219e+00  6.18253219e+00
  6.43209366e+00  2.70824793e+01  2.70824793e+01  2.70824793e+01
  3.22940379e+01  1.36036738e+02  1.41871065e+02  1.41871065e+02
  1.41871065e+02  5.00331037e+02  1.86823305e+03  7.99814494e+03
  4.77661125e+04]
E1 = -182.61175480236545  E_coul = 54.08079535009047
Extra cycle  E= -128.530959452275  delta_E= -1.68e-12  |g|= 1.71e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 328.92689057340584
E1 = -182.61175480236545  E_coul = 54.08079535009047
init E= -128.530959452275
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844165457673898  LUMO = 1.14600653014992
  mo_energy =
[-3.27667438e+01 -1.92584187e+00 -8.44165458e-01 -8.44165458e-01
 -8.44165458e-01  1.14600653e+00  1.15982406e+00  1.15982406e+00
  1.15982406e+00  6.18253109e+00  6.18253109e+00  6.18253109e+00
  6.43209279e+00  2.70824772e+01  2.70824772e+01  2.70824772e+01
  3.22940359e+01  1.36036735e+02  1.41871062e+02  1.41871062e+02
  1.41871062e+02  5.00331033e+02  1.86823305e+03  7.99814494e+03
  4.77661125e+04]
E1 = -182.6117612844299  E_coul = 54.08080183215469
cycle= 1 E= -128.530959452275  delta_E= -1.99e-13  |g|= 8.96e-07  |ddm|= 6.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6117612844299  E_coul = 54.08080183215469
  HOMO = -0.844165004684555  LUMO = 1.14600671544944
  mo_energy =
[-3.27667424e+01 -1.92584137e+00 -8.44165005e-01 -8.44165005e-01
 -8.44165005e-01  1.14600672e+00  1.15982424e+00  1.15982424e+00
  1.15982424e+00  6.18253168e+00  6.18253168e+00  6.18253168e+00
  6.43209331e+00  2.70824783e+01  2.70824783e+01  2.70824783e+01
  3.22940369e+01  1.36036736e+02  1.41871063e+02  1.41871063e+02
  1.41871063e+02  5.00331035e+02  1.86823305e+03  7.99814494e+03
  4.77661125e+04]
E1 = -182.61175808853793  E_coul = 54.08079863626267
Extra cycle  E= -128.530959452275  delta_E= -5.68e-14  |g|= 4.35e-07  |ddm|= 3.3e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273066e+02 2.35714198e+02
 7.65351585e+01 9.96056732e+00 2.69506406e+01 3.86868723e-01
 1.04834507e+00 2.38213947e+00 4.03390248e+00 1.40774748e+01
 6.53724143e+01 3.44969263e-01 1.22339119e+00]
grad_E = [ 1.21187439e-09 -6.29334663e-08  1.24466117e-06 -1.35189915e-05
  8.80029890e-05  6.77975084e-04 -3.03498774e-04  3.00490201e-03
  8.37514929e-04 -1.47006154e-03  1.21975155e-03 -3.37553765e-05
  8.36381949e-05 -1.57653302e-03 -1.81489094e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436772        1
[INPUT] 0    0    [1    /1   ]  833.273037736        1
[INPUT] 0    0    [1    /1   ]  235.714503377        1
[INPUT] 0    0    [1    /1   ]  76.5332509753        1
[INPUT] 0    0    [1    /1   ]  9.95853845419        1
[INPUT] 0    0    [1    /1   ]  26.9560966594        1
[INPUT] 0    0    [1    /1   ]  0.389219973102       1
[INPUT] 0    0    [1    /1   ]  1.05318737394        1
[INPUT] 0    0    [1    /1   ]  2.39454296736        1
[INPUT] 1    0    [1    /1   ]  4.03895521396        1
[INPUT] 1    0    [1    /1   ]  14.0040639446        1
[INPUT] 1    0    [1    /1   ]  64.6372693899        1
[INPUT] 1    0    [1    /1   ]  0.344821456441       1
[INPUT] 1    0    [1    /1   ]  1.22412419422        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413195403, 1.0]], [0, [3661.454367720995, 1.0]], [0, [833.2730377356861, 1.0]], [0, [235.71450337745497, 1.0]], [0, [76.53325097532235, 1.0]], [0, [9.958538454194606, 1.0]], [0, [26.956096659371664, 1.0]], [0, [0.3892199731019183, 1.0]], [0, [1.0531873739397357, 1.0]], [0, [2.394542967363005, 1.0]], [1, [4.038955213958384, 1.0]], [1, [14.004063944594783, 1.0]], [1, [64.63726938994839, 1.0]], [1, [0.34482145644124884, 1.0]], [1, [1.224124194218208, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413195]
bas 1, expnt(s) = [3661.45436772]
bas 2, expnt(s) = [833.27303774]
bas 3, expnt(s) = [235.71450338]
bas 4, expnt(s) = [76.53325098]
bas 5, expnt(s) = [9.95853845]
bas 6, expnt(s) = [26.95609666]
bas 7, expnt(s) = [0.38921997]
bas 8, expnt(s) = [1.05318737]
bas 9, expnt(s) = [2.39454297]
bas 10, expnt(s) = [4.03895521]
bas 11, expnt(s) = [14.00406394]
bas 12, expnt(s) = [64.63726939]
bas 13, expnt(s) = [0.34482146]
bas 14, expnt(s) = [1.22412419]
CPU time:       201.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273038e+02 3.91837071e+02 2.35714503e+02 1.51986409e+02
 7.65332510e+01 6.53736367e+01 9.95853845e+00 1.41632111e+01
 2.69560967e+01 2.98887518e+01 3.89219973e-01 1.24497710e+00
 1.05318737e+00 2.62660192e+00 2.39454297e+00 4.86331052e+00
 4.03895521e+00 1.67040080e+01 1.40040639e+01 7.90318229e+01
 6.46372694e+01 5.34672865e+02 3.44821456e-01 7.70863078e-01
 1.22412419e+00 3.75635167e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99795655380721
cond(S) = 330.6822064088164
E1 = -183.5746472132724  E_coul = 55.0777608712676
init E= -128.496886342005
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773892908000069  LUMO = 1.18149319188954
  mo_energy =
[-3.25552461e+01 -1.85284025e+00 -7.73892908e-01 -7.73892908e-01
 -7.73892908e-01  1.18149319e+00  1.18656506e+00  1.18656506e+00
  1.18656506e+00  6.27895163e+00  6.27895163e+00  6.27895163e+00
  6.55134199e+00  2.71839358e+01  2.71839358e+01  2.71839358e+01
  3.25306791e+01  1.36326732e+02  1.40703544e+02  1.40703544e+02
  1.40703544e+02  5.00649837e+02  1.86857496e+03  7.99850523e+03
  4.77664802e+04]
E1 = -182.1346679976721  E_coul = 53.60690064158922
cycle= 1 E= -128.527767356083  delta_E= -0.0309  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.436151
diis-c [-0.1902278  1.       ]
  HOMO = -0.87753088424768  LUMO = 1.14226210728686
  mo_energy =
[-3.28692642e+01 -1.96101101e+00 -8.77530884e-01 -8.77530884e-01
 -8.77530884e-01  1.14226211e+00  1.14629125e+00  1.14629125e+00
  1.14629125e+00  6.14444389e+00  6.14444389e+00  6.14444389e+00
  6.43650061e+00  2.69434787e+01  2.69434787e+01  2.69434787e+01
  3.22939946e+01  1.36017616e+02  1.40380796e+02  1.40380796e+02
  1.40380796e+02  5.00297262e+02  1.86818660e+03  7.99808791e+03
  4.77660441e+04]
E1 = -182.8505322550653  E_coul = 54.32032992645234
cycle= 2 E= -128.530202328613  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.0702
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.215887
diis-c [-5.85215444e-04  3.30038226e-01  6.69961774e-01]
  HOMO = -0.843870479602357  LUMO = 1.1550070348083
  mo_energy =
[-3.27661046e+01 -1.92562295e+00 -8.43870480e-01 -8.43870480e-01
 -8.43870480e-01  1.15500703e+00  1.15950471e+00  1.15950471e+00
  1.15950471e+00  6.18818799e+00  6.18818799e+00  6.18818799e+00
  6.47381172e+00  2.70226589e+01  2.70226589e+01  2.70226589e+01
  3.23721632e+01  1.36118972e+02  1.40485805e+02  1.40485805e+02
  1.40485805e+02  5.00408985e+02  1.86830339e+03  7.99820708e+03
  4.77661642e+04]
E1 = -182.61149127791506  E_coul = 54.080480384851505
cycle= 3 E= -128.531010893064  delta_E= -0.000809  |g|= 0.000496  |ddm|= 0.0239
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00103842
diis-c [-8.93673796e-08 -2.19028123e-03  1.93232556e-04  1.00199705e+00]
  HOMO = -0.844114279944986  LUMO = 1.15494954273627
  mo_energy =
[-3.27665680e+01 -1.92581145e+00 -8.44114280e-01 -8.44114280e-01
 -8.44114280e-01  1.15494954e+00  1.15944730e+00  1.15944730e+00
  1.15944730e+00  6.18795502e+00  6.18795502e+00  6.18795502e+00
  6.47361535e+00  2.70222861e+01  2.70222861e+01  2.70222861e+01
  3.23718053e+01  1.36118512e+02  1.40485319e+02  1.40485319e+02
  1.40485319e+02  5.00408419e+02  1.86830271e+03  7.99820631e+03
  4.77661634e+04]
E1 = -182.61219368588283  E_coul = 54.081182773045064
cycle= 4 E= -128.531010912838  delta_E= -1.98e-08  |g|= 5.81e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000124997
diis-c [-6.61720608e-10  2.89506005e-04  3.45010365e-04 -1.87252146e-01
  1.18661763e+00]
  HOMO = -0.844142630657227  LUMO = 1.15494121393033
  mo_energy =
[-3.27666183e+01 -1.92582972e+00 -8.44142631e-01 -8.44142631e-01
 -8.44142631e-01  1.15494121e+00  1.15943510e+00  1.15943510e+00
  1.15943510e+00  6.18792182e+00  6.18792182e+00  6.18792182e+00
  6.47358915e+00  2.70222413e+01  2.70222413e+01  2.70222413e+01
  3.23717622e+01  1.36118461e+02  1.40485267e+02  1.40485267e+02
  1.40485267e+02  5.00408361e+02  1.86830265e+03  7.99820624e+03
  4.77661633e+04]
E1 = -182.6123024904974  E_coul = 54.081291577258646
cycle= 5 E= -128.531010913239  delta_E= -4.01e-10  |g|= 5.03e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.6123024904974  E_coul = 54.081291577258646
  HOMO = -0.844140096321707  LUMO = 1.15494273678903
  mo_energy =
[-3.27666129e+01 -1.92582648e+00 -8.44140096e-01 -8.44140096e-01
 -8.44140096e-01  1.15494274e+00  1.15943625e+00  1.15943625e+00
  1.15943625e+00  6.18792507e+00  6.18792507e+00  6.18792507e+00
  6.47359238e+00  2.70222462e+01  2.70222462e+01  2.70222462e+01
  3.23717671e+01  1.36118466e+02  1.40485272e+02  1.40485272e+02
  1.40485272e+02  5.00408366e+02  1.86830265e+03  7.99820625e+03
  4.77661633e+04]
E1 = -182.61229051665214  E_coul = 54.08127960341192
Extra cycle  E= -128.53101091324  delta_E= -1.45e-12  |g|= 1.69e-06  |ddm|= 1.69e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273038e+02 2.35714503e+02
 7.65332510e+01 9.95853845e+00 2.69560967e+01 3.89219973e-01
 1.05318737e+00 2.39454297e+00 4.03895521e+00 1.40040639e+01
 6.46372694e+01 3.44821456e-01 1.22412419e+00]
E = -128.5310109132402
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.794132         1
[INPUT] 0    0    [1    /1   ]  3661.45436772        1
[INPUT] 0    0    [1    /1   ]  833.273037736        1
[INPUT] 0    0    [1    /1   ]  235.714503377        1
[INPUT] 0    0    [1    /1   ]  76.5332509753        1
[INPUT] 0    0    [1    /1   ]  9.95853845419        1
[INPUT] 0    0    [1    /1   ]  26.9560966594        1
[INPUT] 0    0    [1    /1   ]  0.389219973102       1
[INPUT] 0    0    [1    /1   ]  1.05318737394        1
[INPUT] 0    0    [1    /1   ]  2.39454296736        1
[INPUT] 1    0    [1    /1   ]  4.03895521396        1
[INPUT] 1    0    [1    /1   ]  14.0040639446        1
[INPUT] 1    0    [1    /1   ]  64.6372693899        1
[INPUT] 1    0    [1    /1   ]  0.344821456441       1
[INPUT] 1    0    [1    /1   ]  1.22412419422        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413195403, 1.0]], [0, [3661.454367720995, 1.0]], [0, [833.2730377356861, 1.0]], [0, [235.71450337745497, 1.0]], [0, [76.53325097532235, 1.0]], [0, [9.958538454194606, 1.0]], [0, [26.956096659371664, 1.0]], [0, [0.3892199731019183, 1.0]], [0, [1.0531873739397357, 1.0]], [0, [2.394542967363005, 1.0]], [1, [4.038955213958384, 1.0]], [1, [14.004063944594783, 1.0]], [1, [64.63726938994839, 1.0]], [1, [0.34482145644124884, 1.0]], [1, [1.224124194218208, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413195]
bas 1, expnt(s) = [3661.45436772]
bas 2, expnt(s) = [833.27303774]
bas 3, expnt(s) = [235.71450338]
bas 4, expnt(s) = [76.53325098]
bas 5, expnt(s) = [9.95853845]
bas 6, expnt(s) = [26.95609666]
bas 7, expnt(s) = [0.38921997]
bas 8, expnt(s) = [1.05318737]
bas 9, expnt(s) = [2.39454297]
bas 10, expnt(s) = [4.03895521]
bas 11, expnt(s) = [14.00406394]
bas 12, expnt(s) = [64.63726939]
bas 13, expnt(s) = [0.34482146]
bas 14, expnt(s) = [1.22412419]
CPU time:       202.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33273038e+02 3.91837071e+02 2.35714503e+02 1.51986409e+02
 7.65332510e+01 6.53736367e+01 9.95853845e+00 1.41632111e+01
 2.69560967e+01 2.98887518e+01 3.89219973e-01 1.24497710e+00
 1.05318737e+00 2.62660192e+00 2.39454297e+00 4.86331052e+00
 4.03895521e+00 1.67040080e+01 1.40040639e+01 7.90318229e+01
 6.46372694e+01 5.34672865e+02 3.44821456e-01 7.70863078e-01
 1.22412419e+00 3.75635167e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99795655380721
cond(S) = 330.6822064088164
E1 = -183.5746472132724  E_coul = 55.0777608712676
init E= -128.496886342005
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773892908000069  LUMO = 1.18149319188954
  mo_energy =
[-3.25552461e+01 -1.85284025e+00 -7.73892908e-01 -7.73892908e-01
 -7.73892908e-01  1.18149319e+00  1.18656506e+00  1.18656506e+00
  1.18656506e+00  6.27895163e+00  6.27895163e+00  6.27895163e+00
  6.55134199e+00  2.71839358e+01  2.71839358e+01  2.71839358e+01
  3.25306791e+01  1.36326732e+02  1.40703544e+02  1.40703544e+02
  1.40703544e+02  5.00649837e+02  1.86857496e+03  7.99850523e+03
  4.77664802e+04]
E1 = -182.1346679976721  E_coul = 53.60690064158922
cycle= 1 E= -128.527767356083  delta_E= -0.0309  |g|= 0.198  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.436151
diis-c [-0.1902278  1.       ]
  HOMO = -0.87753088424768  LUMO = 1.14226210728686
  mo_energy =
[-3.28692642e+01 -1.96101101e+00 -8.77530884e-01 -8.77530884e-01
 -8.77530884e-01  1.14226211e+00  1.14629125e+00  1.14629125e+00
  1.14629125e+00  6.14444389e+00  6.14444389e+00  6.14444389e+00
  6.43650061e+00  2.69434787e+01  2.69434787e+01  2.69434787e+01
  3.22939946e+01  1.36017616e+02  1.40380796e+02  1.40380796e+02
  1.40380796e+02  5.00297262e+02  1.86818660e+03  7.99808791e+03
  4.77660441e+04]
E1 = -182.8505322550653  E_coul = 54.32032992645234
cycle= 2 E= -128.530202328613  delta_E= -0.00243  |g|= 0.0978  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.215887
diis-c [-5.85215444e-04  3.30038226e-01  6.69961774e-01]
  HOMO = -0.843870479602357  LUMO = 1.1550070348083
  mo_energy =
[-3.27661046e+01 -1.92562295e+00 -8.43870480e-01 -8.43870480e-01
 -8.43870480e-01  1.15500703e+00  1.15950471e+00  1.15950471e+00
  1.15950471e+00  6.18818799e+00  6.18818799e+00  6.18818799e+00
  6.47381172e+00  2.70226589e+01  2.70226589e+01  2.70226589e+01
  3.23721632e+01  1.36118972e+02  1.40485805e+02  1.40485805e+02
  1.40485805e+02  5.00408985e+02  1.86830339e+03  7.99820708e+03
  4.77661642e+04]
E1 = -182.61149127791506  E_coul = 54.080480384851505
cycle= 3 E= -128.531010893064  delta_E= -0.000809  |g|= 0.000496  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103842
diis-c [-8.93673796e-08 -2.19028123e-03  1.93232556e-04  1.00199705e+00]
  HOMO = -0.844114279944986  LUMO = 1.15494954273627
  mo_energy =
[-3.27665680e+01 -1.92581145e+00 -8.44114280e-01 -8.44114280e-01
 -8.44114280e-01  1.15494954e+00  1.15944730e+00  1.15944730e+00
  1.15944730e+00  6.18795502e+00  6.18795502e+00  6.18795502e+00
  6.47361535e+00  2.70222861e+01  2.70222861e+01  2.70222861e+01
  3.23718053e+01  1.36118512e+02  1.40485319e+02  1.40485319e+02
  1.40485319e+02  5.00408419e+02  1.86830271e+03  7.99820631e+03
  4.77661634e+04]
E1 = -182.61219368588283  E_coul = 54.081182773045064
cycle= 4 E= -128.531010912838  delta_E= -1.98e-08  |g|= 5.81e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124997
diis-c [-6.61720608e-10  2.89506005e-04  3.45010365e-04 -1.87252146e-01
  1.18661763e+00]
  HOMO = -0.844142630657227  LUMO = 1.15494121393033
  mo_energy =
[-3.27666183e+01 -1.92582972e+00 -8.44142631e-01 -8.44142631e-01
 -8.44142631e-01  1.15494121e+00  1.15943510e+00  1.15943510e+00
  1.15943510e+00  6.18792182e+00  6.18792182e+00  6.18792182e+00
  6.47358915e+00  2.70222413e+01  2.70222413e+01  2.70222413e+01
  3.23717622e+01  1.36118461e+02  1.40485267e+02  1.40485267e+02
  1.40485267e+02  5.00408361e+02  1.86830265e+03  7.99820624e+03
  4.77661633e+04]
E1 = -182.6123024904974  E_coul = 54.081291577258646
cycle= 5 E= -128.531010913239  delta_E= -4.01e-10  |g|= 5.03e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6123024904974  E_coul = 54.081291577258646
  HOMO = -0.844140096321707  LUMO = 1.15494273678903
  mo_energy =
[-3.27666129e+01 -1.92582648e+00 -8.44140096e-01 -8.44140096e-01
 -8.44140096e-01  1.15494274e+00  1.15943625e+00  1.15943625e+00
  1.15943625e+00  6.18792507e+00  6.18792507e+00  6.18792507e+00
  6.47359238e+00  2.70222462e+01  2.70222462e+01  2.70222462e+01
  3.23717671e+01  1.36118466e+02  1.40485272e+02  1.40485272e+02
  1.40485272e+02  5.00408366e+02  1.86830265e+03  7.99820625e+03
  4.77661633e+04]
E1 = -182.61229051665214  E_coul = 54.08127960341192
Extra cycle  E= -128.53101091324  delta_E= -1.45e-12  |g|= 1.69e-06  |ddm|= 1.69e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 330.6822064088164
E1 = -182.61229051665214  E_coul = 54.08127960341192
init E= -128.53101091324
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844140942435207  LUMO = 1.15494249745873
  mo_energy =
[-3.27666156e+01 -1.92582724e+00 -8.44140942e-01 -8.44140942e-01
 -8.44140942e-01  1.15494250e+00  1.15943593e+00  1.15943593e+00
  1.15943593e+00  6.18792398e+00  6.18792398e+00  6.18792398e+00
  6.47359152e+00  2.70222442e+01  2.70222442e+01  2.70222442e+01
  3.23717652e+01  1.36118464e+02  1.40485269e+02  1.40485269e+02
  1.40485269e+02  5.00408363e+02  1.86830265e+03  7.99820624e+03
  4.77661633e+04]
E1 = -182.61229692589905  E_coul = 54.081286012658374
cycle= 1 E= -128.531010913241  delta_E= -4.55e-13  |g|= 8.87e-07  |ddm|= 6.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61229692589905  E_coul = 54.081286012658374
  HOMO = -0.844140494701852  LUMO = 1.15494268191674
  mo_energy =
[-3.27666142e+01 -1.92582674e+00 -8.44140495e-01 -8.44140495e-01
 -8.44140495e-01  1.15494268e+00  1.15943611e+00  1.15943611e+00
  1.15943611e+00  6.18792456e+00  6.18792456e+00  6.18792456e+00
  6.47359203e+00  2.70222452e+01  2.70222452e+01  2.70222452e+01
  3.23717662e+01  1.36118465e+02  1.40485271e+02  1.40485271e+02
  1.40485271e+02  5.00408365e+02  1.86830265e+03  7.99820625e+03
  4.77661633e+04]
E1 = -182.61229376488282  E_coul = 54.08128285164191
Extra cycle  E= -128.531010913241  delta_E= -2.56e-13  |g|= 4.3e-07  |ddm|= 3.27e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145437e+03 8.33273038e+02 2.35714503e+02
 7.65332510e+01 9.95853845e+00 2.69560967e+01 3.89219973e-01
 1.05318737e+00 2.39454297e+00 4.03895521e+00 1.40040639e+01
 6.46372694e+01 3.44821456e-01 1.22412419e+00]
grad_E = [ 1.12911742e-09 -5.86263670e-08  1.15806219e-06 -1.25334976e-05
  8.06754508e-05  6.10557325e-04 -2.72044756e-04  4.02552760e-03
  5.50013987e-04 -1.35760422e-03  2.70187580e-03 -2.73161638e-04
  8.43933766e-05 -9.18581273e-04 -4.01561762e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437098        1
[INPUT] 0    0    [1    /1   ]  833.272973844        1
[INPUT] 0    0    [1    /1   ]  235.71519594         1
[INPUT] 0    0    [1    /1   ]  76.5290132053        1
[INPUT] 0    0    [1    /1   ]  9.95651564147        1
[INPUT] 0    0    [1    /1   ]  26.9673058591        1
[INPUT] 0    0    [1    /1   ]  0.390364330546       1
[INPUT] 0    0    [1    /1   ]  1.05711939029        1
[INPUT] 0    0    [1    /1   ]  2.42635537678        1
[INPUT] 1    0    [1    /1   ]  4.02785440944        1
[INPUT] 1    0    [1    /1   ]  13.808058569         1
[INPUT] 1    0    [1    /1   ]  62.9576841061        1
[INPUT] 1    0    [1    /1   ]  0.344067199722       1
[INPUT] 1    0    [1    /1   ]  1.22144670332        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413189297, 1.0]], [0, [3661.4543709769814, 1.0]], [0, [833.2729738438359, 1.0]], [0, [235.71519594010485, 1.0]], [0, [76.52901320525295, 1.0]], [0, [9.956515641472295, 1.0]], [0, [26.967305859064506, 1.0]], [0, [0.39036433054645436, 1.0]], [0, [1.0571193902916776, 1.0]], [0, [2.4263553767845867, 1.0]], [1, [4.027854409435001, 1.0]], [1, [13.808058569010988, 1.0]], [1, [62.95768410609969, 1.0]], [1, [0.3440671997219995, 1.0]], [1, [1.2214467033199694, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.45437098]
bas 2, expnt(s) = [833.27297384]
bas 3, expnt(s) = [235.71519594]
bas 4, expnt(s) = [76.52901321]
bas 5, expnt(s) = [9.95651564]
bas 6, expnt(s) = [26.96730586]
bas 7, expnt(s) = [0.39036433]
bas 8, expnt(s) = [1.05711939]
bas 9, expnt(s) = [2.42635538]
bas 10, expnt(s) = [4.02785441]
bas 11, expnt(s) = [13.80805857]
bas 12, expnt(s) = [62.95768411]
bas 13, expnt(s) = [0.3440672]
bas 14, expnt(s) = [1.2214467]
CPU time:       206.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272974e+02 3.91837048e+02 2.35715196e+02 1.51986744e+02
 7.65290132e+01 6.53709218e+01 9.95651564e+00 1.41610534e+01
 2.69673059e+01 2.98980728e+01 3.90364331e-01 1.24772139e+00
 1.05711939e+00 2.63395320e+00 2.42635538e+00 4.91168868e+00
 4.02785441e+00 1.66466404e+01 1.38080586e+01 7.76515570e+01
 6.29576841e+01 5.17362948e+02 3.44067200e-01 7.68755938e-01
 1.22144670e+00 3.74608429e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997978635184573
cond(S) = 331.0389984854042
E1 = -183.5750160077475  E_coul = 55.0778694951983
init E= -128.497146512549
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773898442791684  LUMO = 1.18305115953852
  mo_energy =
[-3.25552398e+01 -1.85284052e+00 -7.73898443e-01 -7.73898443e-01
 -7.73898443e-01  1.18305116e+00  1.18305116e+00  1.18305116e+00
  1.18813424e+00  6.26242420e+00  6.26242420e+00  6.26242420e+00
  6.61202800e+00  2.69330727e+01  2.69330727e+01  2.69330727e+01
  3.26759581e+01  1.36489372e+02  1.37380987e+02  1.37380987e+02
  1.37380987e+02  5.00805557e+02  1.86871530e+03  7.99862887e+03
  4.77665826e+04]
E1 = -182.13442451376253  E_coul = 53.60654650503733
cycle= 1 E= -128.527878008725  delta_E= -0.0307  |g|= 0.198  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.437821
diis-c [-0.19168734  1.        ]
  HOMO = -0.877582573241847  LUMO = 1.14290981554419
  mo_energy =
[-3.28692772e+01 -1.96107969e+00 -8.77582573e-01 -8.77582573e-01
 -8.77582573e-01  1.14290982e+00  1.14290982e+00  1.14290982e+00
  1.14862469e+00  6.12813612e+00  6.12813612e+00  6.12813612e+00
  6.49638811e+00  2.66935577e+01  2.66935577e+01  2.66935577e+01
  3.24390724e+01  1.36180240e+02  1.37059264e+02  1.37059264e+02
  1.37059264e+02  5.00452967e+02  1.86832691e+03  7.99821152e+03
  4.77661465e+04]
E1 = -182.85118273221426  E_coul = 54.32086616479627
cycle= 2 E= -128.530316567418  delta_E= -0.00244  |g|= 0.098  |ddm|= 0.0702
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.216792
diis-c [-5.86233304e-04  3.30125683e-01  6.69874317e-01]
  HOMO = -0.843882304142829  LUMO = 1.156096633018
  mo_energy =
[-3.27660124e+01 -1.92564836e+00 -8.43882304e-01 -8.43882304e-01
 -8.43882304e-01  1.15609663e+00  1.15609663e+00  1.15609663e+00
  1.16147659e+00  6.17183392e+00  6.17183392e+00  6.17183392e+00
  6.53398938e+00  2.67724858e+01  2.67724858e+01  2.67724858e+01
  3.25173505e+01  1.36281691e+02  1.37164093e+02  1.37164093e+02
  1.37164093e+02  5.00564796e+02  1.86844381e+03  7.99833080e+03
  4.77662666e+04]
E1 = -182.6118678226753  E_coul = 54.08074085973841
cycle= 3 E= -128.531126962937  delta_E= -0.00081  |g|= 0.000484  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102844
diis-c [-8.71721330e-08 -2.16884884e-03  1.75530967e-04  1.00199332e+00]
  HOMO = -0.844119349432034  LUMO = 1.15604297377068
  mo_energy =
[-3.27664678e+01 -1.92583075e+00 -8.44119349e-01 -8.44119349e-01
 -8.44119349e-01  1.15604297e+00  1.15604297e+00  1.15604297e+00
  1.16142249e+00  6.17160887e+00  6.17160887e+00  6.17160887e+00
  6.53379953e+00  2.67721226e+01  2.67721226e+01  2.67721226e+01
  3.25170006e+01  1.36281238e+02  1.37163616e+02  1.37163616e+02
  1.37163616e+02  5.00564236e+02  1.86844313e+03  7.99833004e+03
  4.77662658e+04]
E1 = -182.61256184458065  E_coul = 54.08143486284849
cycle= 4 E= -128.531126981732  delta_E= -1.88e-08  |g|= 5.72e-05  |ddm|= 0.00021
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124439
diis-c [-6.49288826e-10  2.85230450e-04  3.49886846e-04 -1.85821669e-01
  1.18518655e+00]
  HOMO = -0.844147086322907  LUMO = 1.15603111883278
  mo_energy =
[-3.27665177e+01 -1.92584864e+00 -8.44147086e-01 -8.44147086e-01
 -8.44147086e-01  1.15603112e+00  1.15603112e+00  1.15603112e+00
  1.16141437e+00  6.17157633e+00  6.17157633e+00  6.17157633e+00
  6.53377381e+00  2.67720784e+01  2.67720784e+01  2.67720784e+01
  3.25169581e+01  1.36281188e+02  1.37163565e+02  1.37163565e+02
  1.37163565e+02  5.00564178e+02  1.86844307e+03  7.99832997e+03
  4.77662658e+04]
E1 = -182.6126707514221  E_coul = 54.08154376930312
cycle= 5 E= -128.531126982119  delta_E= -3.87e-10  |g|= 4.95e-06  |ddm|= 3.52e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.6126707514221  E_coul = 54.08154376930312
  HOMO = -0.844144599369998  LUMO = 1.15603223751041
  mo_energy =
[-3.27665124e+01 -1.92584545e+00 -8.44144599e-01 -8.44144599e-01
 -8.44144599e-01  1.15603224e+00  1.15603224e+00  1.15603224e+00
  1.16141586e+00  6.17157952e+00  6.17157952e+00  6.17157952e+00
  6.53377700e+00  2.67720832e+01  2.67720832e+01  2.67720832e+01
  3.25169629e+01  1.36281193e+02  1.37163570e+02  1.37163570e+02
  1.37163570e+02  5.00564183e+02  1.86844307e+03  7.99832997e+03
  4.77662658e+04]
E1 = -182.61265877367302  E_coul = 54.08153179155247
Extra cycle  E= -128.531126982121  delta_E= -1.59e-12  |g|= 1.69e-06  |ddm|= 1.69e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272974e+02 2.35715196e+02
 7.65290132e+01 9.95651564e+00 2.69673059e+01 3.90364331e-01
 1.05711939e+00 2.42635538e+00 4.02785441e+00 1.38080586e+01
 6.29576841e+01 3.44067200e-01 1.22144670e+00]
E = -128.53112698212055
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941319        1
[INPUT] 0    0    [1    /1   ]  3661.45437098        1
[INPUT] 0    0    [1    /1   ]  833.272973844        1
[INPUT] 0    0    [1    /1   ]  235.71519594         1
[INPUT] 0    0    [1    /1   ]  76.5290132053        1
[INPUT] 0    0    [1    /1   ]  9.95651564147        1
[INPUT] 0    0    [1    /1   ]  26.9673058591        1
[INPUT] 0    0    [1    /1   ]  0.390364330546       1
[INPUT] 0    0    [1    /1   ]  1.05711939029        1
[INPUT] 0    0    [1    /1   ]  2.42635537678        1
[INPUT] 1    0    [1    /1   ]  4.02785440944        1
[INPUT] 1    0    [1    /1   ]  13.808058569         1
[INPUT] 1    0    [1    /1   ]  62.9576841061        1
[INPUT] 1    0    [1    /1   ]  0.344067199722       1
[INPUT] 1    0    [1    /1   ]  1.22144670332        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413189297, 1.0]], [0, [3661.4543709769814, 1.0]], [0, [833.2729738438359, 1.0]], [0, [235.71519594010485, 1.0]], [0, [76.52901320525295, 1.0]], [0, [9.956515641472295, 1.0]], [0, [26.967305859064506, 1.0]], [0, [0.39036433054645436, 1.0]], [0, [1.0571193902916776, 1.0]], [0, [2.4263553767845867, 1.0]], [1, [4.027854409435001, 1.0]], [1, [13.808058569010988, 1.0]], [1, [62.95768410609969, 1.0]], [1, [0.3440671997219995, 1.0]], [1, [1.2214467033199694, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413189]
bas 1, expnt(s) = [3661.45437098]
bas 2, expnt(s) = [833.27297384]
bas 3, expnt(s) = [235.71519594]
bas 4, expnt(s) = [76.52901321]
bas 5, expnt(s) = [9.95651564]
bas 6, expnt(s) = [26.96730586]
bas 7, expnt(s) = [0.39036433]
bas 8, expnt(s) = [1.05711939]
bas 9, expnt(s) = [2.42635538]
bas 10, expnt(s) = [4.02785441]
bas 11, expnt(s) = [13.80805857]
bas 12, expnt(s) = [62.95768411]
bas 13, expnt(s) = [0.3440672]
bas 14, expnt(s) = [1.2214467]
CPU time:       207.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145437e+03 1.18920094e+03
 8.33272974e+02 3.91837048e+02 2.35715196e+02 1.51986744e+02
 7.65290132e+01 6.53709218e+01 9.95651564e+00 1.41610534e+01
 2.69673059e+01 2.98980728e+01 3.90364331e-01 1.24772139e+00
 1.05711939e+00 2.63395320e+00 2.42635538e+00 4.91168868e+00
 4.02785441e+00 1.66466404e+01 1.38080586e+01 7.76515570e+01
 6.29576841e+01 5.17362948e+02 3.44067200e-01 7.68755938e-01
 1.22144670e+00 3.74608429e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997978635184573
cond(S) = 331.0389984854042
E1 = -183.5750160077475  E_coul = 55.0778694951983
init E= -128.497146512549
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773898442791684  LUMO = 1.18305115953852
  mo_energy =
[-3.25552398e+01 -1.85284052e+00 -7.73898443e-01 -7.73898443e-01
 -7.73898443e-01  1.18305116e+00  1.18305116e+00  1.18305116e+00
  1.18813424e+00  6.26242420e+00  6.26242420e+00  6.26242420e+00
  6.61202800e+00  2.69330727e+01  2.69330727e+01  2.69330727e+01
  3.26759581e+01  1.36489372e+02  1.37380987e+02  1.37380987e+02
  1.37380987e+02  5.00805557e+02  1.86871530e+03  7.99862887e+03
  4.77665826e+04]
E1 = -182.13442451376253  E_coul = 53.60654650503733
cycle= 1 E= -128.527878008725  delta_E= -0.0307  |g|= 0.198  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.437821
diis-c [-0.19168734  1.        ]
  HOMO = -0.877582573241847  LUMO = 1.14290981554419
  mo_energy =
[-3.28692772e+01 -1.96107969e+00 -8.77582573e-01 -8.77582573e-01
 -8.77582573e-01  1.14290982e+00  1.14290982e+00  1.14290982e+00
  1.14862469e+00  6.12813612e+00  6.12813612e+00  6.12813612e+00
  6.49638811e+00  2.66935577e+01  2.66935577e+01  2.66935577e+01
  3.24390724e+01  1.36180240e+02  1.37059264e+02  1.37059264e+02
  1.37059264e+02  5.00452967e+02  1.86832691e+03  7.99821152e+03
  4.77661465e+04]
E1 = -182.85118273221426  E_coul = 54.32086616479627
cycle= 2 E= -128.530316567418  delta_E= -0.00244  |g|= 0.098  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.216792
diis-c [-5.86233304e-04  3.30125683e-01  6.69874317e-01]
  HOMO = -0.843882304142829  LUMO = 1.156096633018
  mo_energy =
[-3.27660124e+01 -1.92564836e+00 -8.43882304e-01 -8.43882304e-01
 -8.43882304e-01  1.15609663e+00  1.15609663e+00  1.15609663e+00
  1.16147659e+00  6.17183392e+00  6.17183392e+00  6.17183392e+00
  6.53398938e+00  2.67724858e+01  2.67724858e+01  2.67724858e+01
  3.25173505e+01  1.36281691e+02  1.37164093e+02  1.37164093e+02
  1.37164093e+02  5.00564796e+02  1.86844381e+03  7.99833080e+03
  4.77662666e+04]
E1 = -182.6118678226753  E_coul = 54.08074085973841
cycle= 3 E= -128.531126962937  delta_E= -0.00081  |g|= 0.000484  |ddm|= 0.0239
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102844
diis-c [-8.71721330e-08 -2.16884884e-03  1.75530967e-04  1.00199332e+00]
  HOMO = -0.844119349432034  LUMO = 1.15604297377068
  mo_energy =
[-3.27664678e+01 -1.92583075e+00 -8.44119349e-01 -8.44119349e-01
 -8.44119349e-01  1.15604297e+00  1.15604297e+00  1.15604297e+00
  1.16142249e+00  6.17160887e+00  6.17160887e+00  6.17160887e+00
  6.53379953e+00  2.67721226e+01  2.67721226e+01  2.67721226e+01
  3.25170006e+01  1.36281238e+02  1.37163616e+02  1.37163616e+02
  1.37163616e+02  5.00564236e+02  1.86844313e+03  7.99833004e+03
  4.77662658e+04]
E1 = -182.61256184458065  E_coul = 54.08143486284849
cycle= 4 E= -128.531126981732  delta_E= -1.88e-08  |g|= 5.72e-05  |ddm|= 0.00021
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124439
diis-c [-6.49288826e-10  2.85230450e-04  3.49886846e-04 -1.85821669e-01
  1.18518655e+00]
  HOMO = -0.844147086322907  LUMO = 1.15603111883278
  mo_energy =
[-3.27665177e+01 -1.92584864e+00 -8.44147086e-01 -8.44147086e-01
 -8.44147086e-01  1.15603112e+00  1.15603112e+00  1.15603112e+00
  1.16141437e+00  6.17157633e+00  6.17157633e+00  6.17157633e+00
  6.53377381e+00  2.67720784e+01  2.67720784e+01  2.67720784e+01
  3.25169581e+01  1.36281188e+02  1.37163565e+02  1.37163565e+02
  1.37163565e+02  5.00564178e+02  1.86844307e+03  7.99832997e+03
  4.77662658e+04]
E1 = -182.6126707514221  E_coul = 54.08154376930312
cycle= 5 E= -128.531126982119  delta_E= -3.87e-10  |g|= 4.95e-06  |ddm|= 3.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6126707514221  E_coul = 54.08154376930312
  HOMO = -0.844144599369998  LUMO = 1.15603223751041
  mo_energy =
[-3.27665124e+01 -1.92584545e+00 -8.44144599e-01 -8.44144599e-01
 -8.44144599e-01  1.15603224e+00  1.15603224e+00  1.15603224e+00
  1.16141586e+00  6.17157952e+00  6.17157952e+00  6.17157952e+00
  6.53377700e+00  2.67720832e+01  2.67720832e+01  2.67720832e+01
  3.25169629e+01  1.36281193e+02  1.37163570e+02  1.37163570e+02
  1.37163570e+02  5.00564183e+02  1.86844307e+03  7.99832997e+03
  4.77662658e+04]
E1 = -182.61265877367302  E_coul = 54.08153179155247
Extra cycle  E= -128.531126982121  delta_E= -1.59e-12  |g|= 1.69e-06  |ddm|= 1.69e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 331.0389984854042
E1 = -182.61265877367302  E_coul = 54.08153179155247
init E= -128.531126982121
    CPU time for initialize scf      0.21 sec, wall time      0.21 sec
  HOMO = -0.844145446981741  LUMO = 1.15603191789935
  mo_energy =
[-3.27665150e+01 -1.92584621e+00 -8.44145447e-01 -8.44145447e-01
 -8.44145447e-01  1.15603192e+00  1.15603192e+00  1.15603192e+00
  1.16141562e+00  6.17157843e+00  6.17157843e+00  6.17157843e+00
  6.53377612e+00  2.67720812e+01  2.67720812e+01  2.67720812e+01
  3.25169610e+01  1.36281190e+02  1.37163567e+02  1.37163567e+02
  1.37163567e+02  5.00564180e+02  1.86844307e+03  7.99832997e+03
  4.77662658e+04]
E1 = -182.6126651664217  E_coul = 54.08153818430063
cycle= 1 E= -128.531126982121  delta_E= -5.12e-13  |g|= 8.85e-07  |ddm|= 6.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6126651664217  E_coul = 54.08153818430063
  HOMO = -0.844145000510486  LUMO = 1.15603209451019
  mo_energy =
[-3.27665137e+01 -1.92584572e+00 -8.44145001e-01 -8.44145001e-01
 -8.44145001e-01  1.15603209e+00  1.15603209e+00  1.15603209e+00
  1.16141581e+00  6.17157901e+00  6.17157901e+00  6.17157901e+00
  6.53377664e+00  2.67720823e+01  2.67720823e+01  2.67720823e+01
  3.25169620e+01  1.36281192e+02  1.37163568e+02  1.37163568e+02
  1.37163568e+02  5.00564182e+02  1.86844307e+03  7.99832997e+03
  4.77662658e+04]
E1 = -182.61266201128717  E_coul = 54.0815350291663
Extra cycle  E= -128.531126982121  delta_E= 1.99e-13  |g|= 4.29e-07  |ddm|= 3.27e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [2.44137941e+04 3.66145437e+03 8.33272974e+02 2.35715196e+02
 7.65290132e+01 9.95651564e+00 2.69673059e+01 3.90364331e-01
 1.05711939e+00 2.42635538e+00 4.02785441e+00 1.38080586e+01
 6.29576841e+01 3.44067200e-01 1.22144670e+00]
grad_E = [ 9.78719475e-10 -5.08056174e-08  1.00113532e-06 -1.07643877e-05
  6.77735411e-05  5.04015467e-04 -2.19222954e-04  5.27279387e-03
  5.64889139e-05 -1.12336728e-03  4.69816591e-03 -6.09505808e-04
  8.13800104e-05  7.25130670e-04 -7.09326680e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941318        1
[INPUT] 0    0    [1    /1   ]  3661.45437726        1
[INPUT] 0    0    [1    /1   ]  833.272850589        1
[INPUT] 0    0    [1    /1   ]  235.716526511        1
[INPUT] 0    0    [1    /1   ]  76.5209277421        1
[INPUT] 0    0    [1    /1   ]  9.95317540312        1
[INPUT] 0    0    [1    /1   ]  26.9881085941        1
[INPUT] 0    0    [1    /1   ]  0.387179273153       1
[INPUT] 0    0    [1    /1   ]  1.05646304765        1
[INPUT] 0    0    [1    /1   ]  2.49228862362        1
[INPUT] 1    0    [1    /1   ]  3.9740365081         1
[INPUT] 1    0    [1    /1   ]  13.4024681455        1
[INPUT] 1    0    [1    /1   ]  59.7989641673        1
[INPUT] 1    0    [1    /1   ]  0.341797389468       1
[INPUT] 1    0    [1    /1   ]  1.20973225661        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131775012, 1.0]], [0, [3661.454377259337, 1.0]], [0, [833.2728505889577, 1.0]], [0, [235.7165265111245, 1.0]], [0, [76.52092774212892, 1.0]], [0, [9.953175403116475, 1.0]], [0, [26.98810859407301, 1.0]], [0, [0.3871792731533815, 1.0]], [0, [1.0564630476500703, 1.0]], [0, [2.4922886236172954, 1.0]], [1, [3.9740365080993416, 1.0]], [1, [13.40246814550336, 1.0]], [1, [59.79896416725773, 1.0]], [1, [0.34179738946792143, 1.0]], [1, [1.209732256605715, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413178]
bas 1, expnt(s) = [3661.45437726]
bas 2, expnt(s) = [833.27285059]
bas 3, expnt(s) = [235.71652651]
bas 4, expnt(s) = [76.52092774]
bas 5, expnt(s) = [9.9531754]
bas 6, expnt(s) = [26.98810859]
bas 7, expnt(s) = [0.38717927]
bas 8, expnt(s) = [1.05646305]
bas 9, expnt(s) = [2.49228862]
bas 10, expnt(s) = [3.97403651]
bas 11, expnt(s) = [13.40246815]
bas 12, expnt(s) = [59.79896417]
bas 13, expnt(s) = [0.34179739]
bas 14, expnt(s) = [1.20973226]
CPU time:       210.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272851e+02 3.91837005e+02 2.35716527e+02 1.51987387e+02
 7.65209277e+01 6.53657418e+01 9.95317540e+00 1.41574901e+01
 2.69881086e+01 2.99153688e+01 3.87179273e-01 1.24007828e+00
 1.05646305e+00 2.63272658e+00 2.49228862e+00 5.01145431e+00
 3.97403651e+00 1.63690776e+01 1.34024681e+01 7.48109849e+01
 5.97989642e+01 4.85122557e+02 3.41797389e-01 7.62421824e-01
 1.20973226e+00 3.70122911e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998062166010275
cond(S) = 328.0627749291558
E1 = -183.57566981158388  E_coul = 55.07805765473666
init E= -128.497612156847
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773906278306891  LUMO = 1.17185597564367
  mo_energy =
[-3.25552368e+01 -1.85284551e+00 -7.73906278e-01 -7.73906278e-01
 -7.73906278e-01  1.17185598e+00  1.17185598e+00  1.17185598e+00
  1.18311464e+00  6.18743595e+00  6.18743595e+00  6.18743595e+00
  6.68666506e+00  2.63031047e+01  2.63031047e+01  2.63031047e+01
  3.29139721e+01  1.30941936e+02  1.30941936e+02  1.30941936e+02
  1.36768552e+02  5.01075352e+02  1.86895869e+03  7.99884336e+03
  4.77667602e+04]
E1 = -182.1317181768063  E_coul = 53.603648357748625
cycle= 1 E= -128.528069819058  delta_E= -0.0305  |g|= 0.199  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.441427
diis-c [-0.1948582  1.       ]
  HOMO = -0.877845490040739  LUMO = 1.1320822013164
  mo_energy =
[-3.28697641e+01 -1.96136265e+00 -8.77845490e-01 -8.77845490e-01
 -8.77845490e-01  1.13208220e+00  1.13208220e+00  1.13208220e+00
  1.14341450e+00  6.05406624e+00  6.05406624e+00  6.05406624e+00
  6.56941852e+00  2.60653599e+01  2.60653599e+01  2.60653599e+01
  3.26763624e+01  1.30621759e+02  1.30621759e+02  1.30621759e+02
  1.36458943e+02  5.00722252e+02  1.86856977e+03  7.99842548e+03
  4.77663235e+04]
E1 = -182.85108308342075  E_coul = 54.320563676904406
cycle= 2 E= -128.530519406516  delta_E= -0.00245  |g|= 0.0983  |ddm|= 0.0703
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.218844
diis-c [-5.88723678e-04  3.30410780e-01  6.69589220e-01]
  HOMO = -0.84403054838625  LUMO = 1.14516290578281
  mo_energy =
[-3.27661947e+01 -1.92580952e+00 -8.44030548e-01 -8.44030548e-01
 -8.44030548e-01  1.14516291e+00  1.14516291e+00  1.14516291e+00
  1.15634300e+00  6.09749422e+00  6.09749422e+00  6.09749422e+00
  6.60758154e+00  2.61437890e+01  2.61437890e+01  2.61437890e+01
  3.27549510e+01  1.30726327e+02  1.30726327e+02  1.30726327e+02
  1.36560682e+02  5.00834397e+02  1.86868699e+03  7.99854509e+03
  4.77664440e+04]
E1 = -182.61082513327486  E_coul = 54.079489485118856
cycle= 3 E= -128.531335648156  delta_E= -0.000816  |g|= 0.000469  |ddm|= 0.024
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00101265
diis-c [-8.82636244e-08 -2.14437280e-03  1.08705416e-04  1.00203567e+00]
  HOMO = -0.844259546394827  LUMO = 1.14511418217836
  mo_energy =
[-3.27666369e+01 -1.92598311e+00 -8.44259546e-01 -8.44259546e-01
 -8.44259546e-01  1.14511418e+00  1.14511418e+00  1.14511418e+00
  1.15629377e+00  6.09728067e+00  6.09728067e+00  6.09728067e+00
  6.60739976e+00  2.61434411e+01  2.61434411e+01  2.61434411e+01
  3.27546130e+01  1.30725866e+02  1.30725866e+02  1.30725866e+02
  1.36560241e+02  5.00833848e+02  1.86868633e+03  7.99854434e+03
  4.77664432e+04]
E1 = -182.6114955274322  E_coul = 54.08015986141622
cycle= 4 E= -128.531335666016  delta_E= -1.79e-08  |g|= 5.72e-05  |ddm|= 0.000199
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000126153
diis-c [-6.64103730e-10  2.85515380e-04  3.68089278e-04 -1.87582845e-01
  1.18692924e+00]
  HOMO = -0.844287078187952  LUMO = 1.14510258434982
  mo_energy =
[-3.27666871e+01 -1.92600070e+00 -8.44287078e-01 -8.44287078e-01
 -8.44287078e-01  1.14510258e+00  1.14510258e+00  1.14510258e+00
  1.15628586e+00  6.09724851e+00  6.09724851e+00  6.09724851e+00
  6.60737415e+00  2.61433971e+01  2.61433971e+01  2.61433971e+01
  3.27545704e+01  1.30725815e+02  1.30725815e+02  1.30725815e+02
  1.36560191e+02  5.00833790e+02  1.86868627e+03  7.99854427e+03
  4.77664432e+04]
E1 = -182.6116059390526  E_coul = 54.08027027264708
cycle= 5 E= -128.531335666406  delta_E= -3.9e-10  |g|= 4.99e-06  |ddm|= 3.44e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.6116059390526  E_coul = 54.08027027264708
  HOMO = -0.844284550427842  LUMO = 1.1451037054389
  mo_energy =
[-3.27666816e+01 -1.92599747e+00 -8.44284550e-01 -8.44284550e-01
 -8.44284550e-01  1.14510371e+00  1.14510371e+00  1.14510371e+00
  1.15628737e+00  6.09725174e+00  6.09725174e+00  6.09725174e+00
  6.60737740e+00  2.61434019e+01  2.61434019e+01  2.61434019e+01
  3.27545754e+01  1.30725820e+02  1.30725820e+02  1.30725820e+02
  1.36560196e+02  5.00833795e+02  1.86868627e+03  7.99854427e+03
  4.77664432e+04]
E1 = -182.61159356425412  E_coul = 54.08025789784687
Extra cycle  E= -128.531335666407  delta_E= -1.73e-12  |g|= 1.74e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272851e+02 2.35716527e+02
 7.65209277e+01 9.95317540e+00 2.69881086e+01 3.87179273e-01
 1.05646305e+00 2.49228862e+00 3.97403651e+00 1.34024681e+01
 5.97989642e+01 3.41797389e-01 1.20973226e+00]
E = -128.53133566640724
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941318        1
[INPUT] 0    0    [1    /1   ]  3661.45437726        1
[INPUT] 0    0    [1    /1   ]  833.272850589        1
[INPUT] 0    0    [1    /1   ]  235.716526511        1
[INPUT] 0    0    [1    /1   ]  76.5209277421        1
[INPUT] 0    0    [1    /1   ]  9.95317540312        1
[INPUT] 0    0    [1    /1   ]  26.9881085941        1
[INPUT] 0    0    [1    /1   ]  0.387179273153       1
[INPUT] 0    0    [1    /1   ]  1.05646304765        1
[INPUT] 0    0    [1    /1   ]  2.49228862362        1
[INPUT] 1    0    [1    /1   ]  3.9740365081         1
[INPUT] 1    0    [1    /1   ]  13.4024681455        1
[INPUT] 1    0    [1    /1   ]  59.7989641673        1
[INPUT] 1    0    [1    /1   ]  0.341797389468       1
[INPUT] 1    0    [1    /1   ]  1.20973225661        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131775012, 1.0]], [0, [3661.454377259337, 1.0]], [0, [833.2728505889577, 1.0]], [0, [235.7165265111245, 1.0]], [0, [76.52092774212892, 1.0]], [0, [9.953175403116475, 1.0]], [0, [26.98810859407301, 1.0]], [0, [0.3871792731533815, 1.0]], [0, [1.0564630476500703, 1.0]], [0, [2.4922886236172954, 1.0]], [1, [3.9740365080993416, 1.0]], [1, [13.40246814550336, 1.0]], [1, [59.79896416725773, 1.0]], [1, [0.34179738946792143, 1.0]], [1, [1.209732256605715, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413178]
bas 1, expnt(s) = [3661.45437726]
bas 2, expnt(s) = [833.27285059]
bas 3, expnt(s) = [235.71652651]
bas 4, expnt(s) = [76.52092774]
bas 5, expnt(s) = [9.9531754]
bas 6, expnt(s) = [26.98810859]
bas 7, expnt(s) = [0.38717927]
bas 8, expnt(s) = [1.05646305]
bas 9, expnt(s) = [2.49228862]
bas 10, expnt(s) = [3.97403651]
bas 11, expnt(s) = [13.40246815]
bas 12, expnt(s) = [59.79896417]
bas 13, expnt(s) = [0.34179739]
bas 14, expnt(s) = [1.20973226]
CPU time:       211.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145438e+03 1.18920094e+03
 8.33272851e+02 3.91837005e+02 2.35716527e+02 1.51987387e+02
 7.65209277e+01 6.53657418e+01 9.95317540e+00 1.41574901e+01
 2.69881086e+01 2.99153688e+01 3.87179273e-01 1.24007828e+00
 1.05646305e+00 2.63272658e+00 2.49228862e+00 5.01145431e+00
 3.97403651e+00 1.63690776e+01 1.34024681e+01 7.48109849e+01
 5.97989642e+01 4.85122557e+02 3.41797389e-01 7.62421824e-01
 1.20973226e+00 3.70122911e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998062166010275
cond(S) = 328.0627749291558
E1 = -183.57566981158388  E_coul = 55.07805765473666
init E= -128.497612156847
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773906278306891  LUMO = 1.17185597564367
  mo_energy =
[-3.25552368e+01 -1.85284551e+00 -7.73906278e-01 -7.73906278e-01
 -7.73906278e-01  1.17185598e+00  1.17185598e+00  1.17185598e+00
  1.18311464e+00  6.18743595e+00  6.18743595e+00  6.18743595e+00
  6.68666506e+00  2.63031047e+01  2.63031047e+01  2.63031047e+01
  3.29139721e+01  1.30941936e+02  1.30941936e+02  1.30941936e+02
  1.36768552e+02  5.01075352e+02  1.86895869e+03  7.99884336e+03
  4.77667602e+04]
E1 = -182.1317181768063  E_coul = 53.603648357748625
cycle= 1 E= -128.528069819058  delta_E= -0.0305  |g|= 0.199  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.441427
diis-c [-0.1948582  1.       ]
  HOMO = -0.877845490040739  LUMO = 1.1320822013164
  mo_energy =
[-3.28697641e+01 -1.96136265e+00 -8.77845490e-01 -8.77845490e-01
 -8.77845490e-01  1.13208220e+00  1.13208220e+00  1.13208220e+00
  1.14341450e+00  6.05406624e+00  6.05406624e+00  6.05406624e+00
  6.56941852e+00  2.60653599e+01  2.60653599e+01  2.60653599e+01
  3.26763624e+01  1.30621759e+02  1.30621759e+02  1.30621759e+02
  1.36458943e+02  5.00722252e+02  1.86856977e+03  7.99842548e+03
  4.77663235e+04]
E1 = -182.85108308342075  E_coul = 54.320563676904406
cycle= 2 E= -128.530519406516  delta_E= -0.00245  |g|= 0.0983  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.218844
diis-c [-5.88723678e-04  3.30410780e-01  6.69589220e-01]
  HOMO = -0.84403054838625  LUMO = 1.14516290578281
  mo_energy =
[-3.27661947e+01 -1.92580952e+00 -8.44030548e-01 -8.44030548e-01
 -8.44030548e-01  1.14516291e+00  1.14516291e+00  1.14516291e+00
  1.15634300e+00  6.09749422e+00  6.09749422e+00  6.09749422e+00
  6.60758154e+00  2.61437890e+01  2.61437890e+01  2.61437890e+01
  3.27549510e+01  1.30726327e+02  1.30726327e+02  1.30726327e+02
  1.36560682e+02  5.00834397e+02  1.86868699e+03  7.99854509e+03
  4.77664440e+04]
E1 = -182.61082513327486  E_coul = 54.079489485118856
cycle= 3 E= -128.531335648156  delta_E= -0.000816  |g|= 0.000469  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101265
diis-c [-8.82636244e-08 -2.14437280e-03  1.08705416e-04  1.00203567e+00]
  HOMO = -0.844259546394827  LUMO = 1.14511418217836
  mo_energy =
[-3.27666369e+01 -1.92598311e+00 -8.44259546e-01 -8.44259546e-01
 -8.44259546e-01  1.14511418e+00  1.14511418e+00  1.14511418e+00
  1.15629377e+00  6.09728067e+00  6.09728067e+00  6.09728067e+00
  6.60739976e+00  2.61434411e+01  2.61434411e+01  2.61434411e+01
  3.27546130e+01  1.30725866e+02  1.30725866e+02  1.30725866e+02
  1.36560241e+02  5.00833848e+02  1.86868633e+03  7.99854434e+03
  4.77664432e+04]
E1 = -182.6114955274322  E_coul = 54.08015986141622
cycle= 4 E= -128.531335666016  delta_E= -1.79e-08  |g|= 5.72e-05  |ddm|= 0.000199
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000126153
diis-c [-6.64103730e-10  2.85515380e-04  3.68089278e-04 -1.87582845e-01
  1.18692924e+00]
  HOMO = -0.844287078187952  LUMO = 1.14510258434982
  mo_energy =
[-3.27666871e+01 -1.92600070e+00 -8.44287078e-01 -8.44287078e-01
 -8.44287078e-01  1.14510258e+00  1.14510258e+00  1.14510258e+00
  1.15628586e+00  6.09724851e+00  6.09724851e+00  6.09724851e+00
  6.60737415e+00  2.61433971e+01  2.61433971e+01  2.61433971e+01
  3.27545704e+01  1.30725815e+02  1.30725815e+02  1.30725815e+02
  1.36560191e+02  5.00833790e+02  1.86868627e+03  7.99854427e+03
  4.77664432e+04]
E1 = -182.6116059390526  E_coul = 54.08027027264708
cycle= 5 E= -128.531335666406  delta_E= -3.9e-10  |g|= 4.99e-06  |ddm|= 3.44e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6116059390526  E_coul = 54.08027027264708
  HOMO = -0.844284550427842  LUMO = 1.1451037054389
  mo_energy =
[-3.27666816e+01 -1.92599747e+00 -8.44284550e-01 -8.44284550e-01
 -8.44284550e-01  1.14510371e+00  1.14510371e+00  1.14510371e+00
  1.15628737e+00  6.09725174e+00  6.09725174e+00  6.09725174e+00
  6.60737740e+00  2.61434019e+01  2.61434019e+01  2.61434019e+01
  3.27545754e+01  1.30725820e+02  1.30725820e+02  1.30725820e+02
  1.36560196e+02  5.00833795e+02  1.86868627e+03  7.99854427e+03
  4.77664432e+04]
E1 = -182.61159356425412  E_coul = 54.08025789784687
Extra cycle  E= -128.531335666407  delta_E= -1.73e-12  |g|= 1.74e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 328.0627749291558
E1 = -182.61159356425412  E_coul = 54.08025789784687
init E= -128.531335666407
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.844285426240682  LUMO = 1.14510337855578
  mo_energy =
[-3.27666843e+01 -1.92599827e+00 -8.44285426e-01 -8.44285426e-01
 -8.44285426e-01  1.14510338e+00  1.14510338e+00  1.14510338e+00
  1.15628711e+00  6.09725062e+00  6.09725062e+00  6.09725062e+00
  6.60737649e+00  2.61433999e+01  2.61433999e+01  2.61433999e+01
  3.27545734e+01  1.30725817e+02  1.30725817e+02  1.30725817e+02
  1.36560193e+02  5.00833792e+02  1.86868627e+03  7.99854427e+03
  4.77664432e+04]
E1 = -182.6116001568554  E_coul = 54.08026449044805
cycle= 1 E= -128.531335666407  delta_E= -8.53e-14  |g|= 9.12e-07  |ddm|= 6.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6116001568554  E_coul = 54.08026449044805
  HOMO = -0.844284965623099  LUMO = 1.14510355861696
  mo_energy =
[-3.27666829e+01 -1.92599776e+00 -8.44284966e-01 -8.44284966e-01
 -8.44284966e-01  1.14510356e+00  1.14510356e+00  1.14510356e+00
  1.15628730e+00  6.09725122e+00  6.09725122e+00  6.09725122e+00
  6.60737702e+00  2.61434009e+01  2.61434009e+01  2.61434009e+01
  3.27545744e+01  1.30725819e+02  1.30725819e+02  1.30725819e+02
  1.36560195e+02  5.00833794e+02  1.86868627e+03  7.99854427e+03
  4.77664432e+04]
E1 = -182.6115968983317  E_coul = 54.080261231924155
Extra cycle  E= -128.531335666408  delta_E= -1.99e-13  |g|= 4.43e-07  |ddm|= 3.37e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145438e+03 8.33272851e+02 2.35716527e+02
 7.65209277e+01 9.95317540e+00 2.69881086e+01 3.87179273e-01
 1.05646305e+00 2.49228862e+00 3.97403651e+00 1.34024681e+01
 5.97989642e+01 3.41797389e-01 1.20973226e+00]
grad_E = [ 7.08187964e-10 -3.67286046e-08  7.19303743e-07 -7.59221290e-06
  4.49119183e-05  3.28957179e-04 -1.27601333e-04  6.01779330e-03
 -6.46972448e-04 -7.23067189e-04  6.48471166e-03 -9.24583235e-04
  6.31680533e-05  3.19619889e-03 -9.92394861e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438512        1
[INPUT] 0    0    [1    /1   ]  833.272696352        1
[INPUT] 0    0    [1    /1   ]  235.718193992        1
[INPUT] 0    0    [1    /1   ]  76.5107264745        1
[INPUT] 0    0    [1    /1   ]  9.94239646205        1
[INPUT] 0    0    [1    /1   ]  27.0152936485        1
[INPUT] 0    0    [1    /1   ]  0.377773963357       1
[INPUT] 0    0    [1    /1   ]  1.04836687518        1
[INPUT] 0    0    [1    /1   ]  2.58088840245        1
[INPUT] 1    0    [1    /1   ]  3.8637968011         1
[INPUT] 1    0    [1    /1   ]  12.8660667558        1
[INPUT] 1    0    [1    /1   ]  56.1441163034        1
[INPUT] 1    0    [1    /1   ]  0.33755064221        1
[INPUT] 1    0    [1    /1   ]  1.18565069685        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131627244, 1.0]], [0, [3661.454385116488, 1.0]], [0, [833.2726963522214, 1.0]], [0, [235.71819399205827, 1.0]], [0, [76.5107264744687, 1.0]], [0, [9.942396462046297, 1.0]], [0, [27.015293648486942, 1.0]], [0, [0.37777396335702573, 1.0]], [0, [1.0483668751771666, 1.0]], [0, [2.580888402446974, 1.0]], [1, [3.863796801095639, 1.0]], [1, [12.866066755776135, 1.0]], [1, [56.14411630343003, 1.0]], [1, [0.3375506422099727, 1.0]], [1, [1.1856506968506233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413163]
bas 1, expnt(s) = [3661.45438512]
bas 2, expnt(s) = [833.27269635]
bas 3, expnt(s) = [235.71819399]
bas 4, expnt(s) = [76.51072647]
bas 5, expnt(s) = [9.94239646]
bas 6, expnt(s) = [27.01529365]
bas 7, expnt(s) = [0.37777396]
bas 8, expnt(s) = [1.04836688]
bas 9, expnt(s) = [2.5808884]
bas 10, expnt(s) = [3.8637968]
bas 11, expnt(s) = [12.86606676]
bas 12, expnt(s) = [56.1441163]
bas 13, expnt(s) = [0.33755064]
bas 14, expnt(s) = [1.1856507]
CPU time:       214.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272696e+02 3.91836951e+02 2.35718194e+02 1.51988193e+02
 7.65107265e+01 6.53592061e+01 9.94239646e+00 1.41459895e+01
 2.70152936e+01 2.99379662e+01 3.77773963e-01 1.21741610e+00
 1.04836688e+00 2.61758017e+00 2.58088840e+00 5.14448546e+00
 3.86379680e+00 1.58034622e+01 1.28660668e+01 7.10872384e+01
 5.61441163e+01 4.48347452e+02 3.37550642e-01 7.50599146e-01
 1.18565070e+00 3.60936119e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99821971047508
cond(S) = 322.53434194340554
E1 = -183.5765086859564  E_coul = 55.07830393083311
init E= -128.498204755123
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773915863190715  LUMO = 1.15076842821172
  mo_energy =
[-3.25552354e+01 -1.85284084e+00 -7.73915863e-01 -7.73915863e-01
 -7.73915863e-01  1.15076843e+00  1.15076843e+00  1.15076843e+00
  1.15893198e+00  6.03415143e+00  6.03415143e+00  6.03415143e+00
  6.73991395e+00  2.53295328e+01  2.53295328e+01  2.53295328e+01
  3.31665908e+01  1.23175211e+02  1.23175211e+02  1.23175211e+02
  1.37072240e+02  5.01370963e+02  1.86922556e+03  7.99907858e+03
  4.77669550e+04]
E1 = -182.1250755921546  E_coul = 53.596793565600294
cycle= 1 E= -128.528282026554  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.446471
diis-c [-0.1993361  1.       ]
  HOMO = -0.878420253288751  LUMO = 1.11164134418312
  mo_energy =
[-3.28710222e+01 -1.96193902e+00 -8.78420253e-01 -8.78420253e-01
 -8.78420253e-01  1.11164134e+00  1.11164134e+00  1.11164134e+00
  1.11929820e+00  5.90258658e+00  5.90258658e+00  5.90258658e+00
  6.62046201e+00  2.50939243e+01  2.50939243e+01  2.50939243e+01
  3.29276091e+01  1.22856290e+02  1.22856290e+02  1.22856290e+02
  1.36761398e+02  5.01016539e+02  1.86883528e+03  7.99865934e+03
  4.77665169e+04]
E1 = -182.8491373460682  E_coul = 54.31838530684769
cycle= 2 E= -128.530752039221  delta_E= -0.00247  |g|= 0.099  |ddm|= 0.0704
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.221838
diis-c [-5.92550568e-04  3.30926981e-01  6.69073019e-01]
  HOMO = -0.844399399663789  LUMO = 1.12450653013517
  mo_energy =
[-3.27669030e+01 -1.92616804e+00 -8.44399400e-01 -8.44399400e-01
 -8.44399400e-01  1.12450653e+00  1.12450653e+00  1.12450653e+00
  1.13220045e+00  5.94543940e+00  5.94543940e+00  5.94543940e+00
  6.65937174e+00  2.51717257e+01  2.51717257e+01  2.51717257e+01
  3.30067317e+01  1.22960693e+02  1.22960693e+02  1.22960693e+02
  1.36863668e+02  5.01129265e+02  1.86895311e+03  7.99877956e+03
  4.77666381e+04]
E1 = -182.60705036433612  E_coul = 54.07547107176735
cycle= 3 E= -128.531579292569  delta_E= -0.000827  |g|= 0.000461  |ddm|= 0.024
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000999526
diis-c [-9.54024694e-08 -2.13202530e-03  3.39035904e-06  1.00212863e+00]
  HOMO = -0.844624757871309  LUMO = 1.12446114860598
  mo_energy =
[-3.27673330e+01 -1.92633499e+00 -8.44624758e-01 -8.44624758e-01
 -8.44624758e-01  1.12446115e+00  1.12446115e+00  1.12446115e+00
  1.13215465e+00  5.94523511e+00  5.94523511e+00  5.94523511e+00
  6.65919402e+00  2.51713916e+01  2.51713916e+01  2.51713916e+01
  3.30064033e+01  1.22960249e+02  1.22960249e+02  1.22960249e+02
  1.36863239e+02  5.01128727e+02  1.86895246e+03  7.99877882e+03
  4.77666373e+04]
E1 = -182.60768467962552  E_coul = 54.076105369284896
cycle= 4 E= -128.531579310341  delta_E= -1.78e-08  |g|= 5.93e-05  |ddm|= 0.000201
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000131719
diis-c [-7.20523226e-10  2.93601248e-04  4.00184525e-04 -1.94279254e-01
  1.19358547e+00]
  HOMO = -0.844653242525334  LUMO = 1.12444940135131
  mo_energy =
[-3.27673849e+01 -1.92635284e+00 -8.44653243e-01 -8.44653243e-01
 -8.44653243e-01  1.12444940e+00  1.12444940e+00  1.12444940e+00
  1.13214669e+00  5.94520230e+00  5.94520230e+00  5.94520230e+00
  6.65916747e+00  2.51713464e+01  2.51713464e+01  2.51713464e+01
  3.30063592e+01  1.22960196e+02  1.22960196e+02  1.22960196e+02
  1.36863186e+02  5.01128667e+02  1.86895239e+03  7.99877875e+03
  4.77666372e+04]
E1 = -182.60779886375698  E_coul = 54.07621955298969
cycle= 5 E= -128.531579310767  delta_E= -4.27e-10  |g|= 5.27e-06  |ddm|= 3.57e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.60779886375698  E_coul = 54.07621955298969
  HOMO = -0.844650507932746  LUMO = 1.12445058727952
  mo_energy =
[-3.27673789e+01 -1.92634941e+00 -8.44650508e-01 -8.44650508e-01
 -8.44650508e-01  1.12445059e+00  1.12445059e+00  1.12445059e+00
  1.13214828e+00  5.94520574e+00  5.94520574e+00  5.94520574e+00
  6.65917100e+00  2.51713516e+01  2.51713516e+01  2.51713516e+01
  3.30063646e+01  1.22960202e+02  1.22960202e+02  1.22960202e+02
  1.36863192e+02  5.01128672e+02  1.86895239e+03  7.99877875e+03
  4.77666372e+04]
E1 = -182.6077855069044  E_coul = 54.076206196135345
Extra cycle  E= -128.531579310769  delta_E= -1.79e-12  |g|= 1.87e-06  |ddm|= 1.78e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272696e+02 2.35718194e+02
 7.65107265e+01 9.94239646e+00 2.70152936e+01 3.77773963e-01
 1.04836688e+00 2.58088840e+00 3.86379680e+00 1.28660668e+01
 5.61441163e+01 3.37550642e-01 1.18565070e+00]
E = -128.53157931076908
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438512        1
[INPUT] 0    0    [1    /1   ]  833.272696352        1
[INPUT] 0    0    [1    /1   ]  235.718193992        1
[INPUT] 0    0    [1    /1   ]  76.5107264745        1
[INPUT] 0    0    [1    /1   ]  9.94239646205        1
[INPUT] 0    0    [1    /1   ]  27.0152936485        1
[INPUT] 0    0    [1    /1   ]  0.377773963357       1
[INPUT] 0    0    [1    /1   ]  1.04836687518        1
[INPUT] 0    0    [1    /1   ]  2.58088840245        1
[INPUT] 1    0    [1    /1   ]  3.8637968011         1
[INPUT] 1    0    [1    /1   ]  12.8660667558        1
[INPUT] 1    0    [1    /1   ]  56.1441163034        1
[INPUT] 1    0    [1    /1   ]  0.33755064221        1
[INPUT] 1    0    [1    /1   ]  1.18565069685        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131627244, 1.0]], [0, [3661.454385116488, 1.0]], [0, [833.2726963522214, 1.0]], [0, [235.71819399205827, 1.0]], [0, [76.5107264744687, 1.0]], [0, [9.942396462046297, 1.0]], [0, [27.015293648486942, 1.0]], [0, [0.37777396335702573, 1.0]], [0, [1.0483668751771666, 1.0]], [0, [2.580888402446974, 1.0]], [1, [3.863796801095639, 1.0]], [1, [12.866066755776135, 1.0]], [1, [56.14411630343003, 1.0]], [1, [0.3375506422099727, 1.0]], [1, [1.1856506968506233, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413163]
bas 1, expnt(s) = [3661.45438512]
bas 2, expnt(s) = [833.27269635]
bas 3, expnt(s) = [235.71819399]
bas 4, expnt(s) = [76.51072647]
bas 5, expnt(s) = [9.94239646]
bas 6, expnt(s) = [27.01529365]
bas 7, expnt(s) = [0.37777396]
bas 8, expnt(s) = [1.04836688]
bas 9, expnt(s) = [2.5808884]
bas 10, expnt(s) = [3.8637968]
bas 11, expnt(s) = [12.86606676]
bas 12, expnt(s) = [56.1441163]
bas 13, expnt(s) = [0.33755064]
bas 14, expnt(s) = [1.1856507]
CPU time:       215.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272696e+02 3.91836951e+02 2.35718194e+02 1.51988193e+02
 7.65107265e+01 6.53592061e+01 9.94239646e+00 1.41459895e+01
 2.70152936e+01 2.99379662e+01 3.77773963e-01 1.21741610e+00
 1.04836688e+00 2.61758017e+00 2.58088840e+00 5.14448546e+00
 3.86379680e+00 1.58034622e+01 1.28660668e+01 7.10872384e+01
 5.61441163e+01 4.48347452e+02 3.37550642e-01 7.50599146e-01
 1.18565070e+00 3.60936119e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99821971047508
cond(S) = 322.53434194340554
E1 = -183.5765086859564  E_coul = 55.07830393083311
init E= -128.498204755123
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773915863190715  LUMO = 1.15076842821172
  mo_energy =
[-3.25552354e+01 -1.85284084e+00 -7.73915863e-01 -7.73915863e-01
 -7.73915863e-01  1.15076843e+00  1.15076843e+00  1.15076843e+00
  1.15893198e+00  6.03415143e+00  6.03415143e+00  6.03415143e+00
  6.73991395e+00  2.53295328e+01  2.53295328e+01  2.53295328e+01
  3.31665908e+01  1.23175211e+02  1.23175211e+02  1.23175211e+02
  1.37072240e+02  5.01370963e+02  1.86922556e+03  7.99907858e+03
  4.77669550e+04]
E1 = -182.1250755921546  E_coul = 53.596793565600294
cycle= 1 E= -128.528282026554  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.446471
diis-c [-0.1993361  1.       ]
  HOMO = -0.878420253288751  LUMO = 1.11164134418312
  mo_energy =
[-3.28710222e+01 -1.96193902e+00 -8.78420253e-01 -8.78420253e-01
 -8.78420253e-01  1.11164134e+00  1.11164134e+00  1.11164134e+00
  1.11929820e+00  5.90258658e+00  5.90258658e+00  5.90258658e+00
  6.62046201e+00  2.50939243e+01  2.50939243e+01  2.50939243e+01
  3.29276091e+01  1.22856290e+02  1.22856290e+02  1.22856290e+02
  1.36761398e+02  5.01016539e+02  1.86883528e+03  7.99865934e+03
  4.77665169e+04]
E1 = -182.8491373460682  E_coul = 54.31838530684769
cycle= 2 E= -128.530752039221  delta_E= -0.00247  |g|= 0.099  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.221838
diis-c [-5.92550568e-04  3.30926981e-01  6.69073019e-01]
  HOMO = -0.844399399663789  LUMO = 1.12450653013517
  mo_energy =
[-3.27669030e+01 -1.92616804e+00 -8.44399400e-01 -8.44399400e-01
 -8.44399400e-01  1.12450653e+00  1.12450653e+00  1.12450653e+00
  1.13220045e+00  5.94543940e+00  5.94543940e+00  5.94543940e+00
  6.65937174e+00  2.51717257e+01  2.51717257e+01  2.51717257e+01
  3.30067317e+01  1.22960693e+02  1.22960693e+02  1.22960693e+02
  1.36863668e+02  5.01129265e+02  1.86895311e+03  7.99877956e+03
  4.77666381e+04]
E1 = -182.60705036433612  E_coul = 54.07547107176735
cycle= 3 E= -128.531579292569  delta_E= -0.000827  |g|= 0.000461  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999526
diis-c [-9.54024694e-08 -2.13202530e-03  3.39035904e-06  1.00212863e+00]
  HOMO = -0.844624757871309  LUMO = 1.12446114860598
  mo_energy =
[-3.27673330e+01 -1.92633499e+00 -8.44624758e-01 -8.44624758e-01
 -8.44624758e-01  1.12446115e+00  1.12446115e+00  1.12446115e+00
  1.13215465e+00  5.94523511e+00  5.94523511e+00  5.94523511e+00
  6.65919402e+00  2.51713916e+01  2.51713916e+01  2.51713916e+01
  3.30064033e+01  1.22960249e+02  1.22960249e+02  1.22960249e+02
  1.36863239e+02  5.01128727e+02  1.86895246e+03  7.99877882e+03
  4.77666373e+04]
E1 = -182.60768467962552  E_coul = 54.076105369284896
cycle= 4 E= -128.531579310341  delta_E= -1.78e-08  |g|= 5.93e-05  |ddm|= 0.000201
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131719
diis-c [-7.20523226e-10  2.93601248e-04  4.00184525e-04 -1.94279254e-01
  1.19358547e+00]
  HOMO = -0.844653242525334  LUMO = 1.12444940135131
  mo_energy =
[-3.27673849e+01 -1.92635284e+00 -8.44653243e-01 -8.44653243e-01
 -8.44653243e-01  1.12444940e+00  1.12444940e+00  1.12444940e+00
  1.13214669e+00  5.94520230e+00  5.94520230e+00  5.94520230e+00
  6.65916747e+00  2.51713464e+01  2.51713464e+01  2.51713464e+01
  3.30063592e+01  1.22960196e+02  1.22960196e+02  1.22960196e+02
  1.36863186e+02  5.01128667e+02  1.86895239e+03  7.99877875e+03
  4.77666372e+04]
E1 = -182.60779886375698  E_coul = 54.07621955298969
cycle= 5 E= -128.531579310767  delta_E= -4.27e-10  |g|= 5.27e-06  |ddm|= 3.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60779886375698  E_coul = 54.07621955298969
  HOMO = -0.844650507932746  LUMO = 1.12445058727952
  mo_energy =
[-3.27673789e+01 -1.92634941e+00 -8.44650508e-01 -8.44650508e-01
 -8.44650508e-01  1.12445059e+00  1.12445059e+00  1.12445059e+00
  1.13214828e+00  5.94520574e+00  5.94520574e+00  5.94520574e+00
  6.65917100e+00  2.51713516e+01  2.51713516e+01  2.51713516e+01
  3.30063646e+01  1.22960202e+02  1.22960202e+02  1.22960202e+02
  1.36863192e+02  5.01128672e+02  1.86895239e+03  7.99877875e+03
  4.77666372e+04]
E1 = -182.6077855069044  E_coul = 54.076206196135345
Extra cycle  E= -128.531579310769  delta_E= -1.79e-12  |g|= 1.87e-06  |ddm|= 1.78e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 322.53434194340554
E1 = -182.6077855069044  E_coul = 54.076206196135345
init E= -128.531579310769
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.844651450706712  LUMO = 1.1244502433767
  mo_energy =
[-3.27673819e+01 -1.92635028e+00 -8.44651451e-01 -8.44651451e-01
 -8.44651451e-01  1.12445024e+00  1.12445024e+00  1.12445024e+00
  1.13214801e+00  5.94520456e+00  5.94520456e+00  5.94520456e+00
  6.65916999e+00  2.51713494e+01  2.51713494e+01  2.51713494e+01
  3.30063624e+01  1.22960199e+02  1.22960199e+02  1.22960199e+02
  1.36863189e+02  5.01128669e+02  1.86895239e+03  7.99877875e+03
  4.77666372e+04]
E1 = -182.6077926377364  E_coul = 54.076213326967
cycle= 1 E= -128.531579310769  delta_E= -3.13e-13  |g|= 9.84e-07  |ddm|= 7.22e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6077926377364  E_coul = 54.076213326967
  HOMO = -0.844650951733072  LUMO = 1.12445043401973
  mo_energy =
[-3.27673804e+01 -1.92634973e+00 -8.44650952e-01 -8.44650952e-01
 -8.44650952e-01  1.12445043e+00  1.12445043e+00  1.12445043e+00
  1.13214821e+00  5.94520519e+00  5.94520519e+00  5.94520519e+00
  6.65917058e+00  2.51713506e+01  2.51713506e+01  2.51713506e+01
  3.30063635e+01  1.22960200e+02  1.22960200e+02  1.22960200e+02
  1.36863191e+02  5.01128671e+02  1.86895239e+03  7.99877875e+03
  4.77666372e+04]
E1 = -182.60778910594718  E_coul = 54.076209795177824
Extra cycle  E= -128.531579310769  delta_E= 2.84e-14  |g|= 4.81e-07  |ddm|= 3.62e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272696e+02 2.35718194e+02
 7.65107265e+01 9.94239646e+00 2.70152936e+01 3.77773963e-01
 1.04836688e+00 2.58088840e+00 3.86379680e+00 1.28660668e+01
 5.61441163e+01 3.37550642e-01 1.18565070e+00]
grad_E = [ 3.16220838e-10 -1.62815713e-08  3.10603148e-07 -2.94635059e-06
  1.13176556e-05  7.29972423e-05  1.00561976e-05  5.02195393e-03
 -1.27382427e-03 -2.55600060e-04  6.28487213e-03 -9.21099273e-04
  2.32212432e-05  4.87439762e-03 -9.64308752e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439001        1
[INPUT] 0    0    [1    /1   ]  833.272600124        1
[INPUT] 0    0    [1    /1   ]  235.719244989        1
[INPUT] 0    0    [1    /1   ]  76.5041053857        1
[INPUT] 0    0    [1    /1   ]  9.92253945732        1
[INPUT] 0    0    [1    /1   ]  27.0353445028        1
[INPUT] 0    0    [1    /1   ]  0.3675037765         1
[INPUT] 0    0    [1    /1   ]  1.03909356914        1
[INPUT] 0    0    [1    /1   ]  2.64240103762        1
[INPUT] 1    0    [1    /1   ]  3.7373570784         1
[INPUT] 1    0    [1    /1   ]  12.4792567825        1
[INPUT] 1    0    [1    /1   ]  54.3426961807        1
[INPUT] 1    0    [1    /1   ]  0.332585120237       1
[INPUT] 1    0    [1    /1   ]  1.1568098927         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131534934, 1.0]], [0, [3661.4543900090143, 1.0]], [0, [833.2726001241246, 1.0]], [0, [235.71924498942528, 1.0]], [0, [76.50410538572613, 1.0]], [0, [9.922539457315322, 1.0]], [0, [27.035344502788888, 1.0]], [0, [0.367503776500488, 1.0]], [0, [1.0390935691375296, 1.0]], [0, [2.642401037617206, 1.0]], [1, [3.7373570784013026, 1.0]], [1, [12.479256782541176, 1.0]], [1, [54.34269618074374, 1.0]], [1, [0.332585120237222, 1.0]], [1, [1.1568098927040273, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413153]
bas 1, expnt(s) = [3661.45439001]
bas 2, expnt(s) = [833.27260012]
bas 3, expnt(s) = [235.71924499]
bas 4, expnt(s) = [76.50410539]
bas 5, expnt(s) = [9.92253946]
bas 6, expnt(s) = [27.0353445]
bas 7, expnt(s) = [0.36750378]
bas 8, expnt(s) = [1.03909357]
bas 9, expnt(s) = [2.64240104]
bas 10, expnt(s) = [3.73735708]
bas 11, expnt(s) = [12.47925678]
bas 12, expnt(s) = [54.34269618]
bas 13, expnt(s) = [0.33258512]
bas 14, expnt(s) = [1.15680989]
CPU time:       218.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272600e+02 3.91836917e+02 2.35719245e+02 1.51988702e+02
 7.65041054e+01 6.53549640e+01 9.92253946e+00 1.41247949e+01
 2.70353445e+01 2.99546297e+01 3.67503777e-01 1.19250821e+00
 1.03909357e+00 2.60019559e+00 2.64240104e+00 5.23617403e+00
 3.73735708e+00 1.51596835e+01 1.24792568e+01 6.84258647e+01
 5.43426962e+01 4.30438263e+02 3.32585120e-01 7.36822555e-01
 1.15680989e+00 3.49995036e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998386755975291
cond(S) = 318.03403942600215
E1 = -183.57718243689564  E_coul = 55.0784910507294
init E= -128.498691386166
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773932675636321  LUMO = 1.12641488706125
  mo_energy =
[-3.25552327e+01 -1.85281732e+00 -7.73932676e-01 -7.73932676e-01
 -7.73932676e-01  1.12641489e+00  1.12641489e+00  1.12641489e+00
  1.13012049e+00  5.85523016e+00  5.85523016e+00  5.85523016e+00
  6.74608617e+00  2.44492952e+01  2.44492952e+01  2.44492952e+01
  3.32871004e+01  1.18722753e+02  1.18722753e+02  1.18722753e+02
  1.37213722e+02  5.01509568e+02  1.86935071e+03  7.99918888e+03
  4.77670463e+04]
E1 = -182.1168066683519  E_coul = 53.588367522071216
cycle= 1 E= -128.528439146281  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450058
diis-c [-0.20255204  1.        ]
  HOMO = -0.879104860357525  LUMO = 1.08801931685855
  mo_energy =
[-3.28726200e+01 -1.96260613e+00 -8.79104860e-01 -8.79104860e-01
 -8.79104860e-01  1.08801932e+00  1.08801932e+00  1.08801932e+00
  1.09067099e+00  5.72571307e+00  5.72571307e+00  5.72571307e+00
  6.62489814e+00  2.42149508e+01  2.42149508e+01  2.42149508e+01
  3.30466879e+01  1.18403506e+02  1.18403506e+02  1.18403506e+02
  1.36901309e+02  5.01153454e+02  1.86895870e+03  7.99876792e+03
  4.77666065e+04]
E1 = -182.84583892827246  E_coul = 54.31490804014682
cycle= 2 E= -128.530930888126  delta_E= -0.00249  |g|= 0.0996  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224161
diis-c [-5.95649184e-04  3.31479512e-01  6.68520488e-01]
  HOMO = -0.844866923096646  LUMO = 1.100620100003
  mo_energy =
[-3.27679215e+01 -1.92660446e+00 -8.44866923e-01 -8.44866923e-01
 -8.44866923e-01  1.10062010e+00  1.10062010e+00  1.10062010e+00
  1.10348096e+00  5.76788249e+00  5.76788249e+00  5.76788249e+00
  6.66437375e+00  2.42923630e+01  2.42923630e+01  2.42923630e+01
  3.31263314e+01  1.18508119e+02  1.18508119e+02  1.18508119e+02
  1.37004145e+02  5.01266796e+02  1.86907718e+03  7.99888879e+03
  4.77667283e+04]
E1 = -182.60170081756007  E_coul = 54.06993060543801
cycle= 3 E= -128.531770212122  delta_E= -0.000839  |g|= 0.000467  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994779
diis-c [-1.03357535e-07 -2.13988062e-03 -8.85283933e-05  1.00222841e+00]
  HOMO = -0.845097197988232  LUMO = 1.10057388659729
  mo_energy =
[-3.27683491e+01 -1.92677351e+00 -8.45097198e-01 -8.45097198e-01
 -8.45097198e-01  1.10057389e+00  1.10057389e+00  1.10057389e+00
  1.10343324e+00  5.76767834e+00  5.76767834e+00  5.76767834e+00
  6.66419092e+00  2.42920314e+01  2.42920314e+01  2.42920314e+01
  3.31260024e+01  1.18507679e+02  1.18507679e+02  1.18507679e+02
  1.37003717e+02  5.01266262e+02  1.86907653e+03  7.99888806e+03
  4.77667275e+04]
E1 = -182.6023034519428  E_coul = 54.070533221152814
cycle= 4 E= -128.53177023079  delta_E= -1.87e-08  |g|= 6.24e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013765
diis-c [-7.86247324e-10  2.99301182e-04  4.27524489e-04 -1.99566472e-01
  1.19883965e+00]
  HOMO = -0.845127536086295  LUMO = 1.10056159597258
  mo_energy =
[-3.27684034e+01 -1.92679253e+00 -8.45127536e-01 -8.45127536e-01
 -8.45127536e-01  1.10056160e+00  1.10056160e+00  1.10056160e+00
  1.10342469e+00  5.76764399e+00  5.76764399e+00  5.76764399e+00
  6.66416244e+00  2.42919841e+01  2.42919841e+01  2.42919841e+01
  3.31259560e+01  1.18507624e+02  1.18507624e+02  1.18507624e+02
  1.37003663e+02  5.01266199e+02  1.86907646e+03  7.99888798e+03
  4.77667275e+04]
E1 = -182.6024213190602  E_coul = 54.070651087795916
cycle= 5 E= -128.531770231264  delta_E= -4.74e-10  |g|= 5.61e-06  |ddm|= 3.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6024213190602  E_coul = 54.070651087795916
  HOMO = -0.845124564502456  LUMO = 1.10056285777074
  mo_energy =
[-3.27683970e+01 -1.92678885e+00 -8.45124565e-01 -8.45124565e-01
 -8.45124565e-01  1.10056286e+00  1.10056286e+00  1.10056286e+00
  1.10342639e+00  5.76764765e+00  5.76764765e+00  5.76764765e+00
  6.66416626e+00  2.42919897e+01  2.42919897e+01  2.42919897e+01
  3.31259618e+01  1.18507631e+02  1.18507631e+02  1.18507631e+02
  1.37003669e+02  5.01266205e+02  1.86907646e+03  7.99888799e+03
  4.77667275e+04]
E1 = -182.60240715041624  E_coul = 54.07063691915001
Extra cycle  E= -128.531770231266  delta_E= -1.93e-12  |g|= 1.99e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272600e+02 2.35719245e+02
 7.65041054e+01 9.92253946e+00 2.70353445e+01 3.67503777e-01
 1.03909357e+00 2.64240104e+00 3.73735708e+00 1.24792568e+01
 5.43426962e+01 3.32585120e-01 1.15680989e+00]
E = -128.53177023126622
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439001        1
[INPUT] 0    0    [1    /1   ]  833.272600124        1
[INPUT] 0    0    [1    /1   ]  235.719244989        1
[INPUT] 0    0    [1    /1   ]  76.5041053857        1
[INPUT] 0    0    [1    /1   ]  9.92253945732        1
[INPUT] 0    0    [1    /1   ]  27.0353445028        1
[INPUT] 0    0    [1    /1   ]  0.3675037765         1
[INPUT] 0    0    [1    /1   ]  1.03909356914        1
[INPUT] 0    0    [1    /1   ]  2.64240103762        1
[INPUT] 1    0    [1    /1   ]  3.7373570784         1
[INPUT] 1    0    [1    /1   ]  12.4792567825        1
[INPUT] 1    0    [1    /1   ]  54.3426961807        1
[INPUT] 1    0    [1    /1   ]  0.332585120237       1
[INPUT] 1    0    [1    /1   ]  1.1568098927         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131534934, 1.0]], [0, [3661.4543900090143, 1.0]], [0, [833.2726001241246, 1.0]], [0, [235.71924498942528, 1.0]], [0, [76.50410538572613, 1.0]], [0, [9.922539457315322, 1.0]], [0, [27.035344502788888, 1.0]], [0, [0.367503776500488, 1.0]], [0, [1.0390935691375296, 1.0]], [0, [2.642401037617206, 1.0]], [1, [3.7373570784013026, 1.0]], [1, [12.479256782541176, 1.0]], [1, [54.34269618074374, 1.0]], [1, [0.332585120237222, 1.0]], [1, [1.1568098927040273, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413153]
bas 1, expnt(s) = [3661.45439001]
bas 2, expnt(s) = [833.27260012]
bas 3, expnt(s) = [235.71924499]
bas 4, expnt(s) = [76.50410539]
bas 5, expnt(s) = [9.92253946]
bas 6, expnt(s) = [27.0353445]
bas 7, expnt(s) = [0.36750378]
bas 8, expnt(s) = [1.03909357]
bas 9, expnt(s) = [2.64240104]
bas 10, expnt(s) = [3.73735708]
bas 11, expnt(s) = [12.47925678]
bas 12, expnt(s) = [54.34269618]
bas 13, expnt(s) = [0.33258512]
bas 14, expnt(s) = [1.15680989]
CPU time:       219.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272600e+02 3.91836917e+02 2.35719245e+02 1.51988702e+02
 7.65041054e+01 6.53549640e+01 9.92253946e+00 1.41247949e+01
 2.70353445e+01 2.99546297e+01 3.67503777e-01 1.19250821e+00
 1.03909357e+00 2.60019559e+00 2.64240104e+00 5.23617403e+00
 3.73735708e+00 1.51596835e+01 1.24792568e+01 6.84258647e+01
 5.43426962e+01 4.30438263e+02 3.32585120e-01 7.36822555e-01
 1.15680989e+00 3.49995036e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998386755975291
cond(S) = 318.03403942600215
E1 = -183.57718243689564  E_coul = 55.0784910507294
init E= -128.498691386166
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773932675636321  LUMO = 1.12641488706125
  mo_energy =
[-3.25552327e+01 -1.85281732e+00 -7.73932676e-01 -7.73932676e-01
 -7.73932676e-01  1.12641489e+00  1.12641489e+00  1.12641489e+00
  1.13012049e+00  5.85523016e+00  5.85523016e+00  5.85523016e+00
  6.74608617e+00  2.44492952e+01  2.44492952e+01  2.44492952e+01
  3.32871004e+01  1.18722753e+02  1.18722753e+02  1.18722753e+02
  1.37213722e+02  5.01509568e+02  1.86935071e+03  7.99918888e+03
  4.77670463e+04]
E1 = -182.1168066683519  E_coul = 53.588367522071216
cycle= 1 E= -128.528439146281  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450058
diis-c [-0.20255204  1.        ]
  HOMO = -0.879104860357525  LUMO = 1.08801931685855
  mo_energy =
[-3.28726200e+01 -1.96260613e+00 -8.79104860e-01 -8.79104860e-01
 -8.79104860e-01  1.08801932e+00  1.08801932e+00  1.08801932e+00
  1.09067099e+00  5.72571307e+00  5.72571307e+00  5.72571307e+00
  6.62489814e+00  2.42149508e+01  2.42149508e+01  2.42149508e+01
  3.30466879e+01  1.18403506e+02  1.18403506e+02  1.18403506e+02
  1.36901309e+02  5.01153454e+02  1.86895870e+03  7.99876792e+03
  4.77666065e+04]
E1 = -182.84583892827246  E_coul = 54.31490804014682
cycle= 2 E= -128.530930888126  delta_E= -0.00249  |g|= 0.0996  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224161
diis-c [-5.95649184e-04  3.31479512e-01  6.68520488e-01]
  HOMO = -0.844866923096646  LUMO = 1.100620100003
  mo_energy =
[-3.27679215e+01 -1.92660446e+00 -8.44866923e-01 -8.44866923e-01
 -8.44866923e-01  1.10062010e+00  1.10062010e+00  1.10062010e+00
  1.10348096e+00  5.76788249e+00  5.76788249e+00  5.76788249e+00
  6.66437375e+00  2.42923630e+01  2.42923630e+01  2.42923630e+01
  3.31263314e+01  1.18508119e+02  1.18508119e+02  1.18508119e+02
  1.37004145e+02  5.01266796e+02  1.86907718e+03  7.99888879e+03
  4.77667283e+04]
E1 = -182.60170081756007  E_coul = 54.06993060543801
cycle= 3 E= -128.531770212122  delta_E= -0.000839  |g|= 0.000467  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994779
diis-c [-1.03357535e-07 -2.13988062e-03 -8.85283933e-05  1.00222841e+00]
  HOMO = -0.845097197988232  LUMO = 1.10057388659729
  mo_energy =
[-3.27683491e+01 -1.92677351e+00 -8.45097198e-01 -8.45097198e-01
 -8.45097198e-01  1.10057389e+00  1.10057389e+00  1.10057389e+00
  1.10343324e+00  5.76767834e+00  5.76767834e+00  5.76767834e+00
  6.66419092e+00  2.42920314e+01  2.42920314e+01  2.42920314e+01
  3.31260024e+01  1.18507679e+02  1.18507679e+02  1.18507679e+02
  1.37003717e+02  5.01266262e+02  1.86907653e+03  7.99888806e+03
  4.77667275e+04]
E1 = -182.6023034519428  E_coul = 54.070533221152814
cycle= 4 E= -128.53177023079  delta_E= -1.87e-08  |g|= 6.24e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013765
diis-c [-7.86247324e-10  2.99301182e-04  4.27524489e-04 -1.99566472e-01
  1.19883965e+00]
  HOMO = -0.845127536086295  LUMO = 1.10056159597258
  mo_energy =
[-3.27684034e+01 -1.92679253e+00 -8.45127536e-01 -8.45127536e-01
 -8.45127536e-01  1.10056160e+00  1.10056160e+00  1.10056160e+00
  1.10342469e+00  5.76764399e+00  5.76764399e+00  5.76764399e+00
  6.66416244e+00  2.42919841e+01  2.42919841e+01  2.42919841e+01
  3.31259560e+01  1.18507624e+02  1.18507624e+02  1.18507624e+02
  1.37003663e+02  5.01266199e+02  1.86907646e+03  7.99888798e+03
  4.77667275e+04]
E1 = -182.6024213190602  E_coul = 54.070651087795916
cycle= 5 E= -128.531770231264  delta_E= -4.74e-10  |g|= 5.61e-06  |ddm|= 3.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6024213190602  E_coul = 54.070651087795916
  HOMO = -0.845124564502456  LUMO = 1.10056285777074
  mo_energy =
[-3.27683970e+01 -1.92678885e+00 -8.45124565e-01 -8.45124565e-01
 -8.45124565e-01  1.10056286e+00  1.10056286e+00  1.10056286e+00
  1.10342639e+00  5.76764765e+00  5.76764765e+00  5.76764765e+00
  6.66416626e+00  2.42919897e+01  2.42919897e+01  2.42919897e+01
  3.31259618e+01  1.18507631e+02  1.18507631e+02  1.18507631e+02
  1.37003669e+02  5.01266205e+02  1.86907646e+03  7.99888799e+03
  4.77667275e+04]
E1 = -182.60240715041624  E_coul = 54.07063691915001
Extra cycle  E= -128.531770231266  delta_E= -1.93e-12  |g|= 1.99e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 318.03403942600215
E1 = -182.60240715041624  E_coul = 54.07063691915001
init E= -128.531770231266
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.845125560937885  LUMO = 1.10056250513254
  mo_energy =
[-3.27684002e+01 -1.92678978e+00 -8.45125561e-01 -8.45125561e-01
 -8.45125561e-01  1.10056251e+00  1.10056251e+00  1.10056251e+00
  1.10342610e+00  5.76764643e+00  5.76764643e+00  5.76764643e+00
  6.66416519e+00  2.42919874e+01  2.42919874e+01  2.42919874e+01
  3.31259594e+01  1.18507627e+02  1.18507627e+02  1.18507627e+02
  1.37003666e+02  5.01266202e+02  1.86907646e+03  7.99888798e+03
  4.77667275e+04]
E1 = -182.6024147686324  E_coul = 54.07064453736581
cycle= 1 E= -128.531770231267  delta_E= -3.69e-13  |g|= 1.05e-06  |ddm|= 7.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6024147686324  E_coul = 54.07064453736581
  HOMO = -0.845125026987944  LUMO = 1.10056270379216
  mo_energy =
[-3.27683986e+01 -1.92678919e+00 -8.45125027e-01 -8.45125027e-01
 -8.45125027e-01  1.10056270e+00  1.10056270e+00  1.10056270e+00
  1.10342632e+00  5.76764709e+00  5.76764709e+00  5.76764709e+00
  6.66416582e+00  2.42919886e+01  2.42919886e+01  2.42919886e+01
  3.31259607e+01  1.18507629e+02  1.18507629e+02  1.18507629e+02
  1.37003668e+02  5.01266203e+02  1.86907646e+03  7.99888799e+03
  4.77667275e+04]
E1 = -182.60241099010673  E_coul = 54.070640758840106
Extra cycle  E= -128.531770231267  delta_E= -2.84e-14  |g|= 5.14e-07  |ddm|= 3.84e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272600e+02 2.35719245e+02
 7.65041054e+01 9.92253946e+00 2.70353445e+01 3.67503777e-01
 1.03909357e+00 2.64240104e+00 3.73735708e+00 1.24792568e+01
 5.43426962e+01 3.32585120e-01 1.15680989e+00]
grad_E = [-5.28430678e-11  3.03525372e-09 -7.54440735e-08  1.51991000e-06
 -2.15664960e-05 -1.98182289e-04  1.52468750e-04  2.44897097e-03
 -1.22080616e-03  2.10101266e-05  3.35812723e-03 -5.19996208e-04
 -1.03207278e-06  3.96675531e-03 -5.23327052e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439011        1
[INPUT] 0    0    [1    /1   ]  833.27259814         1
[INPUT] 0    0    [1    /1   ]  235.719268414        1
[INPUT] 0    0    [1    /1   ]  76.5039248483        1
[INPUT] 0    0    [1    /1   ]  9.91991268248        1
[INPUT] 0    0    [1    /1   ]  27.0362822125        1
[INPUT] 0    0    [1    /1   ]  0.365314797993       1
[INPUT] 0    0    [1    /1   ]  1.04088955044        1
[INPUT] 0    0    [1    /1   ]  2.64258471014        1
[INPUT] 1    0    [1    /1   ]  3.66862628323        1
[INPUT] 1    0    [1    /1   ]  12.38110403          1
[INPUT] 1    0    [1    /1   ]  54.3986211794        1
[INPUT] 1    0    [1    /1   ]  0.329584719588       1
[INPUT] 1    0    [1    /1   ]  1.14002531856        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131533017, 1.0]], [0, [3661.4543901079437, 1.0]], [0, [833.2725981398142, 1.0]], [0, [235.71926841431826, 1.0]], [0, [76.50392484833253, 1.0]], [0, [9.919912682484474, 1.0]], [0, [27.03628221247911, 1.0]], [0, [0.36531479799274313, 1.0]], [0, [1.040889550440561, 1.0]], [0, [2.6425847101439794, 1.0]], [1, [3.6686262832292758, 1.0]], [1, [12.381104030044517, 1.0]], [1, [54.398621179363914, 1.0]], [1, [0.32958471958785485, 1.0]], [1, [1.1400253185640759, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413153]
bas 1, expnt(s) = [3661.45439011]
bas 2, expnt(s) = [833.27259814]
bas 3, expnt(s) = [235.71926841]
bas 4, expnt(s) = [76.50392485]
bas 5, expnt(s) = [9.91991268]
bas 6, expnt(s) = [27.03628221]
bas 7, expnt(s) = [0.3653148]
bas 8, expnt(s) = [1.04088955]
bas 9, expnt(s) = [2.64258471]
bas 10, expnt(s) = [3.66862628]
bas 11, expnt(s) = [12.38110403]
bas 12, expnt(s) = [54.39862118]
bas 13, expnt(s) = [0.32958472]
bas 14, expnt(s) = [1.14002532]
CPU time:       222.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272598e+02 3.91836916e+02 2.35719268e+02 1.51988713e+02
 7.65039248e+01 6.53548484e+01 9.91991268e+00 1.41219904e+01
 2.70362822e+01 2.99554089e+01 3.65314798e-01 1.18717700e+00
 1.04088955e+00 2.60356552e+00 2.64258471e+00 5.23644700e+00
 3.66862628e+00 1.48120010e+01 1.23811040e+01 6.77537923e+01
 5.43986212e+01 4.30992048e+02 3.29584720e-01 7.28522934e-01
 1.14002532e+00 3.43658835e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998472333758135
cond(S) = 317.6350970974883
E1 = -183.57727913764262  E_coul = 55.07848330692013
init E= -128.498795830722
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773946242700355  LUMO = 1.11218562435558
  mo_energy =
[-3.25552432e+01 -1.85280689e+00 -7.73946243e-01 -7.73946243e-01
 -7.73946243e-01  1.11218562e+00  1.11218562e+00  1.11218562e+00
  1.12555889e+00  5.75382517e+00  5.75382517e+00  5.75382517e+00
  6.74198834e+00  2.40806779e+01  2.40806779e+01  2.40806779e+01
  3.32816345e+01  1.18244340e+02  1.18244340e+02  1.18244340e+02
  1.37205926e+02  5.01502137e+02  1.86934397e+03  7.99918292e+03
  4.77670414e+04]
E1 = -182.1115855091812  E_coul = 53.58310818868012
cycle= 1 E= -128.528477320501  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450793
diis-c [-0.20321443  1.        ]
  HOMO = -0.879511486677756  LUMO = 1.07419754235874
  mo_energy =
[-3.28736415e+01 -1.96302794e+00 -8.79511487e-01 -8.79511487e-01
 -8.79511487e-01  1.07419754e+00  1.07419754e+00  1.07419754e+00
  1.08592162e+00  5.62539031e+00  5.62539031e+00  5.62539031e+00
  6.62028404e+00  2.38463208e+01  2.38463208e+01  2.38463208e+01
  3.30405050e+01  1.17923983e+02  1.17923983e+02  1.17923983e+02
  1.36892528e+02  5.01144973e+02  1.86895090e+03  7.99876090e+03
  4.77666005e+04]
E1 = -182.8432035806203  E_coul = 54.312223189354576
cycle= 2 E= -128.530980391266  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224832
diis-c [-5.97104934e-04  3.31784272e-01  6.68215728e-01]
  HOMO = -0.845162006090962  LUMO = 1.08663782312793
  mo_energy =
[-3.27686447e+01 -1.92690630e+00 -8.45162006e-01 -8.45162006e-01
 -8.45162006e-01  1.08663782e+00  1.08663782e+00  1.08663782e+00
  1.09875122e+00  5.66717839e+00  5.66717839e+00  5.66717839e+00
  6.65990305e+00  2.39237155e+01  2.39237155e+01  2.39237155e+01
  3.31203851e+01  1.18028922e+02  1.18028922e+02  1.18028922e+02
  1.36995658e+02  5.01258636e+02  1.86906971e+03  7.99888212e+03
  4.77667227e+04]
E1 = -182.59790837642387  E_coul = 54.06608205183373
cycle= 3 E= -128.53182632459  delta_E= -0.000846  |g|= 0.000479  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993731
diis-c [-1.02514876e-07 -2.15690448e-03 -1.32697379e-04  1.00228960e+00]
  HOMO = -0.845400953959446  LUMO = 1.08658814735586
  mo_energy =
[-3.27690789e+01 -1.92708466e+00 -8.45400954e-01 -8.45400954e-01
 -8.45400954e-01  1.08658815e+00  1.08658815e+00  1.08658815e+00
  1.09869719e+00  5.66696733e+00  5.66696733e+00  5.66696733e+00
  6.65970971e+00  2.39233763e+01  2.39233763e+01  2.39233763e+01
  3.31200478e+01  1.18028477e+02  1.18028477e+02  1.18028477e+02
  1.36995225e+02  5.01258099e+02  1.86906906e+03  7.99888139e+03
  4.77667219e+04]
E1 = -182.5984987875426  E_coul = 54.06667244350446
cycle= 4 E= -128.531826344038  delta_E= -1.94e-08  |g|= 6.36e-05  |ddm|= 0.000228
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138464
diis-c [-8.06786339e-10  2.92294524e-04  4.31276331e-04 -1.96543619e-01
  1.19582005e+00]
  HOMO = -0.845432534546451  LUMO = 1.08657541072243
  mo_energy =
[-3.27691342e+01 -1.92710512e+00 -8.45432535e-01 -8.45432535e-01
 -8.45432535e-01  1.08657541e+00  1.08657541e+00  1.08657541e+00
  1.09868774e+00  5.66693187e+00  5.66693187e+00  5.66693187e+00
  6.65967962e+00  2.39233278e+01  2.39233278e+01  2.39233278e+01
  3.31200000e+01  1.18028421e+02  1.18028421e+02  1.18028421e+02
  1.36995170e+02  5.01258036e+02  1.86906899e+03  7.99888131e+03
  4.77667218e+04]
E1 = -182.59861680867792  E_coul = 54.06679046415807
cycle= 5 E= -128.53182634452  delta_E= -4.82e-10  |g|= 5.66e-06  |ddm|= 3.91e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59861680867792  E_coul = 54.06679046415807
  HOMO = -0.845429550922181  LUMO = 1.08657666832135
  mo_energy =
[-3.27691279e+01 -1.92710141e+00 -8.45429551e-01 -8.45429551e-01
 -8.45429551e-01  1.08657667e+00  1.08657667e+00  1.08657667e+00
  1.09868947e+00  5.66693550e+00  5.66693550e+00  5.66693550e+00
  6.65968348e+00  2.39233332e+01  2.39233332e+01  2.39233332e+01
  3.31200057e+01  1.18028427e+02  1.18028427e+02  1.18028427e+02
  1.36995176e+02  5.01258041e+02  1.86906900e+03  7.99888131e+03
  4.77667218e+04]
E1 = -182.59860295416834  E_coul = 54.066776609646595
Extra cycle  E= -128.531826344522  delta_E= -1.88e-12  |g|= 1.95e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272598e+02 2.35719268e+02
 7.65039248e+01 9.91991268e+00 2.70362822e+01 3.65314798e-01
 1.04088955e+00 2.64258471e+00 3.66862628e+00 1.23811040e+01
 5.43986212e+01 3.29584720e-01 1.14002532e+00]
E = -128.53182634452173
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439011        1
[INPUT] 0    0    [1    /1   ]  833.27259814         1
[INPUT] 0    0    [1    /1   ]  235.719268414        1
[INPUT] 0    0    [1    /1   ]  76.5039248483        1
[INPUT] 0    0    [1    /1   ]  9.91991268248        1
[INPUT] 0    0    [1    /1   ]  27.0362822125        1
[INPUT] 0    0    [1    /1   ]  0.365314797993       1
[INPUT] 0    0    [1    /1   ]  1.04088955044        1
[INPUT] 0    0    [1    /1   ]  2.64258471014        1
[INPUT] 1    0    [1    /1   ]  3.66862628323        1
[INPUT] 1    0    [1    /1   ]  12.38110403          1
[INPUT] 1    0    [1    /1   ]  54.3986211794        1
[INPUT] 1    0    [1    /1   ]  0.329584719588       1
[INPUT] 1    0    [1    /1   ]  1.14002531856        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131533017, 1.0]], [0, [3661.4543901079437, 1.0]], [0, [833.2725981398142, 1.0]], [0, [235.71926841431826, 1.0]], [0, [76.50392484833253, 1.0]], [0, [9.919912682484474, 1.0]], [0, [27.03628221247911, 1.0]], [0, [0.36531479799274313, 1.0]], [0, [1.040889550440561, 1.0]], [0, [2.6425847101439794, 1.0]], [1, [3.6686262832292758, 1.0]], [1, [12.381104030044517, 1.0]], [1, [54.398621179363914, 1.0]], [1, [0.32958471958785485, 1.0]], [1, [1.1400253185640759, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413153]
bas 1, expnt(s) = [3661.45439011]
bas 2, expnt(s) = [833.27259814]
bas 3, expnt(s) = [235.71926841]
bas 4, expnt(s) = [76.50392485]
bas 5, expnt(s) = [9.91991268]
bas 6, expnt(s) = [27.03628221]
bas 7, expnt(s) = [0.3653148]
bas 8, expnt(s) = [1.04088955]
bas 9, expnt(s) = [2.64258471]
bas 10, expnt(s) = [3.66862628]
bas 11, expnt(s) = [12.38110403]
bas 12, expnt(s) = [54.39862118]
bas 13, expnt(s) = [0.32958472]
bas 14, expnt(s) = [1.14002532]
CPU time:       223.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272598e+02 3.91836916e+02 2.35719268e+02 1.51988713e+02
 7.65039248e+01 6.53548484e+01 9.91991268e+00 1.41219904e+01
 2.70362822e+01 2.99554089e+01 3.65314798e-01 1.18717700e+00
 1.04088955e+00 2.60356552e+00 2.64258471e+00 5.23644700e+00
 3.66862628e+00 1.48120010e+01 1.23811040e+01 6.77537923e+01
 5.43986212e+01 4.30992048e+02 3.29584720e-01 7.28522934e-01
 1.14002532e+00 3.43658835e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998472333758135
cond(S) = 317.6350970974883
E1 = -183.57727913764262  E_coul = 55.07848330692013
init E= -128.498795830722
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773946242700355  LUMO = 1.11218562435558
  mo_energy =
[-3.25552432e+01 -1.85280689e+00 -7.73946243e-01 -7.73946243e-01
 -7.73946243e-01  1.11218562e+00  1.11218562e+00  1.11218562e+00
  1.12555889e+00  5.75382517e+00  5.75382517e+00  5.75382517e+00
  6.74198834e+00  2.40806779e+01  2.40806779e+01  2.40806779e+01
  3.32816345e+01  1.18244340e+02  1.18244340e+02  1.18244340e+02
  1.37205926e+02  5.01502137e+02  1.86934397e+03  7.99918292e+03
  4.77670414e+04]
E1 = -182.1115855091812  E_coul = 53.58310818868012
cycle= 1 E= -128.528477320501  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450793
diis-c [-0.20321443  1.        ]
  HOMO = -0.879511486677756  LUMO = 1.07419754235874
  mo_energy =
[-3.28736415e+01 -1.96302794e+00 -8.79511487e-01 -8.79511487e-01
 -8.79511487e-01  1.07419754e+00  1.07419754e+00  1.07419754e+00
  1.08592162e+00  5.62539031e+00  5.62539031e+00  5.62539031e+00
  6.62028404e+00  2.38463208e+01  2.38463208e+01  2.38463208e+01
  3.30405050e+01  1.17923983e+02  1.17923983e+02  1.17923983e+02
  1.36892528e+02  5.01144973e+02  1.86895090e+03  7.99876090e+03
  4.77666005e+04]
E1 = -182.8432035806203  E_coul = 54.312223189354576
cycle= 2 E= -128.530980391266  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224832
diis-c [-5.97104934e-04  3.31784272e-01  6.68215728e-01]
  HOMO = -0.845162006090962  LUMO = 1.08663782312793
  mo_energy =
[-3.27686447e+01 -1.92690630e+00 -8.45162006e-01 -8.45162006e-01
 -8.45162006e-01  1.08663782e+00  1.08663782e+00  1.08663782e+00
  1.09875122e+00  5.66717839e+00  5.66717839e+00  5.66717839e+00
  6.65990305e+00  2.39237155e+01  2.39237155e+01  2.39237155e+01
  3.31203851e+01  1.18028922e+02  1.18028922e+02  1.18028922e+02
  1.36995658e+02  5.01258636e+02  1.86906971e+03  7.99888212e+03
  4.77667227e+04]
E1 = -182.59790837642387  E_coul = 54.06608205183373
cycle= 3 E= -128.53182632459  delta_E= -0.000846  |g|= 0.000479  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993731
diis-c [-1.02514876e-07 -2.15690448e-03 -1.32697379e-04  1.00228960e+00]
  HOMO = -0.845400953959446  LUMO = 1.08658814735586
  mo_energy =
[-3.27690789e+01 -1.92708466e+00 -8.45400954e-01 -8.45400954e-01
 -8.45400954e-01  1.08658815e+00  1.08658815e+00  1.08658815e+00
  1.09869719e+00  5.66696733e+00  5.66696733e+00  5.66696733e+00
  6.65970971e+00  2.39233763e+01  2.39233763e+01  2.39233763e+01
  3.31200478e+01  1.18028477e+02  1.18028477e+02  1.18028477e+02
  1.36995225e+02  5.01258099e+02  1.86906906e+03  7.99888139e+03
  4.77667219e+04]
E1 = -182.5984987875426  E_coul = 54.06667244350446
cycle= 4 E= -128.531826344038  delta_E= -1.94e-08  |g|= 6.36e-05  |ddm|= 0.000228
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138464
diis-c [-8.06786339e-10  2.92294524e-04  4.31276331e-04 -1.96543619e-01
  1.19582005e+00]
  HOMO = -0.845432534546451  LUMO = 1.08657541072243
  mo_energy =
[-3.27691342e+01 -1.92710512e+00 -8.45432535e-01 -8.45432535e-01
 -8.45432535e-01  1.08657541e+00  1.08657541e+00  1.08657541e+00
  1.09868774e+00  5.66693187e+00  5.66693187e+00  5.66693187e+00
  6.65967962e+00  2.39233278e+01  2.39233278e+01  2.39233278e+01
  3.31200000e+01  1.18028421e+02  1.18028421e+02  1.18028421e+02
  1.36995170e+02  5.01258036e+02  1.86906899e+03  7.99888131e+03
  4.77667218e+04]
E1 = -182.59861680867792  E_coul = 54.06679046415807
cycle= 5 E= -128.53182634452  delta_E= -4.82e-10  |g|= 5.66e-06  |ddm|= 3.91e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59861680867792  E_coul = 54.06679046415807
  HOMO = -0.845429550922181  LUMO = 1.08657666832135
  mo_energy =
[-3.27691279e+01 -1.92710141e+00 -8.45429551e-01 -8.45429551e-01
 -8.45429551e-01  1.08657667e+00  1.08657667e+00  1.08657667e+00
  1.09868947e+00  5.66693550e+00  5.66693550e+00  5.66693550e+00
  6.65968348e+00  2.39233332e+01  2.39233332e+01  2.39233332e+01
  3.31200057e+01  1.18028427e+02  1.18028427e+02  1.18028427e+02
  1.36995176e+02  5.01258041e+02  1.86906900e+03  7.99888131e+03
  4.77667218e+04]
E1 = -182.59860295416834  E_coul = 54.066776609646595
Extra cycle  E= -128.531826344522  delta_E= -1.88e-12  |g|= 1.95e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 317.6350970974883
E1 = -182.59860295416834  E_coul = 54.066776609646595
init E= -128.531826344522
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845430524321264  LUMO = 1.08657633091856
  mo_energy =
[-3.27691310e+01 -1.92710231e+00 -8.45430524e-01 -8.45430524e-01
 -8.45430524e-01  1.08657633e+00  1.08657633e+00  1.08657633e+00
  1.09868919e+00  5.66693432e+00  5.66693432e+00  5.66693432e+00
  6.65968243e+00  2.39233310e+01  2.39233310e+01  2.39233310e+01
  3.31200034e+01  1.18028424e+02  1.18028424e+02  1.18028424e+02
  1.36995173e+02  5.01258038e+02  1.86906899e+03  7.99888131e+03
  4.77667218e+04]
E1 = -182.5986104634648  E_coul = 54.06678411894262
cycle= 1 E= -128.531826344522  delta_E= -4.55e-13  |g|= 1.03e-06  |ddm|= 7.56e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5986104634648  E_coul = 54.06678411894262
  HOMO = -0.845429997853342  LUMO = 1.08657652391335
  mo_energy =
[-3.27691294e+01 -1.92710173e+00 -8.45429998e-01 -8.45429998e-01
 -8.45429998e-01  1.08657652e+00  1.08657652e+00  1.08657652e+00
  1.09868940e+00  5.66693497e+00  5.66693497e+00  5.66693497e+00
  6.65968305e+00  2.39233322e+01  2.39233322e+01  2.39233322e+01
  3.31200046e+01  1.18028425e+02  1.18028425e+02  1.18028425e+02
  1.36995174e+02  5.01258040e+02  1.86906899e+03  7.99888131e+03
  4.77667218e+04]
E1 = -182.59860673945104  E_coul = 54.066780394929125
Extra cycle  E= -128.531826344522  delta_E= 2.84e-13  |g|= 5.06e-07  |ddm|= 3.77e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272598e+02 2.35719268e+02
 7.65039248e+01 9.91991268e+00 2.70362822e+01 3.65314798e-01
 1.04088955e+00 2.64258471e+00 3.66862628e+00 1.23811040e+01
 5.43986212e+01 3.29584720e-01 1.14002532e+00]
grad_E = [-8.95064697e-11  4.96548761e-09 -1.14107361e-07  1.98443046e-06
 -2.52060023e-05 -2.50847232e-04  1.71589325e-04  2.97084625e-04
 -3.09633475e-04 -1.07289989e-04  5.23015393e-05 -1.46419826e-05
 -3.15093034e-06  1.13684608e-03 -4.27435363e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45438937        1
[INPUT] 0    0    [1    /1   ]  833.272612854        1
[INPUT] 0    0    [1    /1   ]  235.719099555        1
[INPUT] 0    0    [1    /1   ]  76.5051085726        1
[INPUT] 0    0    [1    /1   ]  9.928791652          1
[INPUT] 0    0    [1    /1   ]  27.0313579919        1
[INPUT] 0    0    [1    /1   ]  0.365203872516       1
[INPUT] 0    0    [1    /1   ]  1.04034553068        1
[INPUT] 0    0    [1    /1   ]  2.63286619101        1
[INPUT] 1    0    [1    /1   ]  3.67620109041        1
[INPUT] 1    0    [1    /1   ]  12.4115860519        1
[INPUT] 1    0    [1    /1   ]  54.5298705796        1
[INPUT] 1    0    [1    /1   ]  0.329808420702       1
[INPUT] 1    0    [1    /1   ]  1.14191809022        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131547067, 1.0]], [0, [3661.4543893650407, 1.0]], [0, [833.2726128542065, 1.0]], [0, [235.71909955538462, 1.0]], [0, [76.50510857255992, 1.0]], [0, [9.928791652003666, 1.0]], [0, [27.031357991886413, 1.0]], [0, [0.3652038725157979, 1.0]], [0, [1.040345530678971, 1.0]], [0, [2.6328661910134223, 1.0]], [1, [3.6762010904058466, 1.0]], [1, [12.411586051919572, 1.0]], [1, [54.52987057959933, 1.0]], [1, [0.3298084207023979, 1.0]], [1, [1.1419180902174773, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438937]
bas 2, expnt(s) = [833.27261285]
bas 3, expnt(s) = [235.71909956]
bas 4, expnt(s) = [76.50510857]
bas 5, expnt(s) = [9.92879165]
bas 6, expnt(s) = [27.03135799]
bas 7, expnt(s) = [0.36520387]
bas 8, expnt(s) = [1.04034553]
bas 9, expnt(s) = [2.63286619]
bas 10, expnt(s) = [3.67620109]
bas 11, expnt(s) = [12.41158605]
bas 12, expnt(s) = [54.52987058]
bas 13, expnt(s) = [0.32980842]
bas 14, expnt(s) = [1.14191809]
CPU time:       227.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272613e+02 3.91836921e+02 2.35719100e+02 1.51988631e+02
 7.65051086e+01 6.53556068e+01 9.92879165e+00 1.41314694e+01
 2.70313580e+01 2.99513169e+01 3.65203873e-01 1.18690663e+00
 1.04034553e+00 2.60254489e+00 2.63286619e+00 5.22199696e+00
 3.67620109e+00 1.48502398e+01 1.24115861e+01 6.79623670e+01
 5.45298706e+01 4.32292276e+02 3.29808421e-01 7.29141080e-01
 1.14191809e+00 3.44372199e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998463890892783
cond(S) = 317.4941285549469
E1 = -183.57719745912183  E_coul = 55.078463026054614
init E= -128.498734433067
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77394770263612  LUMO = 1.11349560047587
  mo_energy =
[-3.25552452e+01 -1.85280997e+00 -7.73947703e-01 -7.73947703e-01
 -7.73947703e-01  1.11349560e+00  1.11349560e+00  1.11349560e+00
  1.12461748e+00  5.76455286e+00  5.76455286e+00  5.76455286e+00
  6.72772344e+00  2.41411014e+01  2.41411014e+01  2.41411014e+01
  3.32557526e+01  1.18569642e+02  1.18569642e+02  1.18569642e+02
  1.37185515e+02  5.01483282e+02  1.86932706e+03  7.99916806e+03
  4.77670291e+04]
E1 = -182.11158472624496  E_coul = 53.5831045906987
cycle= 1 E= -128.528480135546  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450566
diis-c [-0.20300944  1.        ]
  HOMO = -0.879517247550822  LUMO = 1.07543841637759
  mo_energy =
[-3.28736201e+01 -1.96303453e+00 -8.79517248e-01 -8.79517248e-01
 -8.79517248e-01  1.07543842e+00  1.07543842e+00  1.07543842e+00
  1.08502371e+00  5.63593338e+00  5.63593338e+00  5.63593338e+00
  6.60619702e+00  2.39065590e+01  2.39065590e+01  2.39065590e+01
  3.30146384e+01  1.18249214e+02  1.18249214e+02  1.18249214e+02
  1.36872139e+02  5.01126155e+02  1.86893404e+03  7.99874608e+03
  4.77665883e+04]
E1 = -182.84304349089322  E_coul = 54.31206102348383
cycle= 2 E= -128.530982467409  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224708
diis-c [-5.97262068e-04  3.31773139e-01  6.68226861e-01]
  HOMO = -0.845175404194556  LUMO = 1.08789705429939
  mo_energy =
[-3.27686413e+01 -1.92692110e+00 -8.45175404e-01 -8.45175404e-01
 -8.45175404e-01  1.08789705e+00  1.08789705e+00  1.08789705e+00
  1.09783350e+00  5.67777335e+00  5.67777335e+00  5.67777335e+00
  6.64574657e+00  2.39840053e+01  2.39840053e+01  2.39840053e+01
  3.30945057e+01  1.18354164e+02  1.18354164e+02  1.18354164e+02
  1.36975254e+02  5.01239800e+02  1.86905283e+03  7.99886728e+03
  4.77667104e+04]
E1 = -182.5977857683626  E_coul = 54.06595764523501
cycle= 3 E= -128.531828123128  delta_E= -0.000846  |g|= 0.000483  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997324
diis-c [-1.02496463e-07 -2.16504750e-03 -1.29884826e-04  1.00229493e+00]
  HOMO = -0.845416070105104  LUMO = 1.08784645615278
  mo_energy =
[-3.27690778e+01 -1.92710134e+00 -8.45416070e-01 -8.45416070e-01
 -8.45416070e-01  1.08784646e+00  1.08784646e+00  1.08784646e+00
  1.09777848e+00  5.67756008e+00  5.67756008e+00  5.67756008e+00
  6.64555136e+00  2.39836636e+01  2.39836636e+01  2.39836636e+01
  3.30941661e+01  1.18353716e+02  1.18353716e+02  1.18353716e+02
  1.36974819e+02  5.01239261e+02  1.86905218e+03  7.99886654e+03
  4.77667096e+04]
E1 = -182.59837964277165  E_coul = 54.0665515000014
cycle= 4 E= -128.53182814277  delta_E= -1.96e-08  |g|= 6.36e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138397
diis-c [-8.07415615e-10  2.92060317e-04  4.29461410e-04 -1.95953323e-01
  1.19523180e+00]
  HOMO = -0.845447746968163  LUMO = 1.08783364893842
  mo_energy =
[-3.27691331e+01 -1.92712192e+00 -8.45447747e-01 -8.45447747e-01
 -8.45447747e-01  1.08783365e+00  1.08783365e+00  1.08783365e+00
  1.09776897e+00  5.67752448e+00  5.67752448e+00  5.67752448e+00
  6.64552117e+00  2.39836150e+01  2.39836150e+01  2.39836150e+01
  3.30941182e+01  1.18353660e+02  1.18353660e+02  1.18353660e+02
  1.36974763e+02  5.01239197e+02  1.86905211e+03  7.99886647e+03
  4.77667095e+04]
E1 = -182.59849753153767  E_coul = 54.06666938828508
cycle= 5 E= -128.531828143253  delta_E= -4.82e-10  |g|= 5.66e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59849753153767  E_coul = 54.06666938828508
  HOMO = -0.845444774117985  LUMO = 1.08783490503407
  mo_energy =
[-3.27691268e+01 -1.92711822e+00 -8.45444774e-01 -8.45444774e-01
 -8.45444774e-01  1.08783491e+00  1.08783491e+00  1.08783491e+00
  1.09777069e+00  5.67752811e+00  5.67752811e+00  5.67752811e+00
  6.64552501e+00  2.39836204e+01  2.39836204e+01  2.39836204e+01
  3.30941239e+01  1.18353666e+02  1.18353666e+02  1.18353666e+02
  1.36974769e+02  5.01239203e+02  1.86905212e+03  7.99886647e+03
  4.77667095e+04]
E1 = -182.59848376833654  E_coul = 54.06665562508173
Extra cycle  E= -128.531828143255  delta_E= -2.22e-12  |g|= 1.94e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272613e+02 2.35719100e+02
 7.65051086e+01 9.92879165e+00 2.70313580e+01 3.65203873e-01
 1.04034553e+00 2.63286619e+00 3.67620109e+00 1.24115861e+01
 5.45298706e+01 3.29808421e-01 1.14191809e+00]
E = -128.5318281432548
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45438937        1
[INPUT] 0    0    [1    /1   ]  833.272612854        1
[INPUT] 0    0    [1    /1   ]  235.719099555        1
[INPUT] 0    0    [1    /1   ]  76.5051085726        1
[INPUT] 0    0    [1    /1   ]  9.928791652          1
[INPUT] 0    0    [1    /1   ]  27.0313579919        1
[INPUT] 0    0    [1    /1   ]  0.365203872516       1
[INPUT] 0    0    [1    /1   ]  1.04034553068        1
[INPUT] 0    0    [1    /1   ]  2.63286619101        1
[INPUT] 1    0    [1    /1   ]  3.67620109041        1
[INPUT] 1    0    [1    /1   ]  12.4115860519        1
[INPUT] 1    0    [1    /1   ]  54.5298705796        1
[INPUT] 1    0    [1    /1   ]  0.329808420702       1
[INPUT] 1    0    [1    /1   ]  1.14191809022        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131547067, 1.0]], [0, [3661.4543893650407, 1.0]], [0, [833.2726128542065, 1.0]], [0, [235.71909955538462, 1.0]], [0, [76.50510857255992, 1.0]], [0, [9.928791652003666, 1.0]], [0, [27.031357991886413, 1.0]], [0, [0.3652038725157979, 1.0]], [0, [1.040345530678971, 1.0]], [0, [2.6328661910134223, 1.0]], [1, [3.6762010904058466, 1.0]], [1, [12.411586051919572, 1.0]], [1, [54.52987057959933, 1.0]], [1, [0.3298084207023979, 1.0]], [1, [1.1419180902174773, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438937]
bas 2, expnt(s) = [833.27261285]
bas 3, expnt(s) = [235.71909956]
bas 4, expnt(s) = [76.50510857]
bas 5, expnt(s) = [9.92879165]
bas 6, expnt(s) = [27.03135799]
bas 7, expnt(s) = [0.36520387]
bas 8, expnt(s) = [1.04034553]
bas 9, expnt(s) = [2.63286619]
bas 10, expnt(s) = [3.67620109]
bas 11, expnt(s) = [12.41158605]
bas 12, expnt(s) = [54.52987058]
bas 13, expnt(s) = [0.32980842]
bas 14, expnt(s) = [1.14191809]
CPU time:       227.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272613e+02 3.91836921e+02 2.35719100e+02 1.51988631e+02
 7.65051086e+01 6.53556068e+01 9.92879165e+00 1.41314694e+01
 2.70313580e+01 2.99513169e+01 3.65203873e-01 1.18690663e+00
 1.04034553e+00 2.60254489e+00 2.63286619e+00 5.22199696e+00
 3.67620109e+00 1.48502398e+01 1.24115861e+01 6.79623670e+01
 5.45298706e+01 4.32292276e+02 3.29808421e-01 7.29141080e-01
 1.14191809e+00 3.44372199e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998463890892783
cond(S) = 317.4941285549469
E1 = -183.57719745912183  E_coul = 55.078463026054614
init E= -128.498734433067
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77394770263612  LUMO = 1.11349560047587
  mo_energy =
[-3.25552452e+01 -1.85280997e+00 -7.73947703e-01 -7.73947703e-01
 -7.73947703e-01  1.11349560e+00  1.11349560e+00  1.11349560e+00
  1.12461748e+00  5.76455286e+00  5.76455286e+00  5.76455286e+00
  6.72772344e+00  2.41411014e+01  2.41411014e+01  2.41411014e+01
  3.32557526e+01  1.18569642e+02  1.18569642e+02  1.18569642e+02
  1.37185515e+02  5.01483282e+02  1.86932706e+03  7.99916806e+03
  4.77670291e+04]
E1 = -182.11158472624496  E_coul = 53.5831045906987
cycle= 1 E= -128.528480135546  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450566
diis-c [-0.20300944  1.        ]
  HOMO = -0.879517247550822  LUMO = 1.07543841637759
  mo_energy =
[-3.28736201e+01 -1.96303453e+00 -8.79517248e-01 -8.79517248e-01
 -8.79517248e-01  1.07543842e+00  1.07543842e+00  1.07543842e+00
  1.08502371e+00  5.63593338e+00  5.63593338e+00  5.63593338e+00
  6.60619702e+00  2.39065590e+01  2.39065590e+01  2.39065590e+01
  3.30146384e+01  1.18249214e+02  1.18249214e+02  1.18249214e+02
  1.36872139e+02  5.01126155e+02  1.86893404e+03  7.99874608e+03
  4.77665883e+04]
E1 = -182.84304349089322  E_coul = 54.31206102348383
cycle= 2 E= -128.530982467409  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224708
diis-c [-5.97262068e-04  3.31773139e-01  6.68226861e-01]
  HOMO = -0.845175404194556  LUMO = 1.08789705429939
  mo_energy =
[-3.27686413e+01 -1.92692110e+00 -8.45175404e-01 -8.45175404e-01
 -8.45175404e-01  1.08789705e+00  1.08789705e+00  1.08789705e+00
  1.09783350e+00  5.67777335e+00  5.67777335e+00  5.67777335e+00
  6.64574657e+00  2.39840053e+01  2.39840053e+01  2.39840053e+01
  3.30945057e+01  1.18354164e+02  1.18354164e+02  1.18354164e+02
  1.36975254e+02  5.01239800e+02  1.86905283e+03  7.99886728e+03
  4.77667104e+04]
E1 = -182.5977857683626  E_coul = 54.06595764523501
cycle= 3 E= -128.531828123128  delta_E= -0.000846  |g|= 0.000483  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997324
diis-c [-1.02496463e-07 -2.16504750e-03 -1.29884826e-04  1.00229493e+00]
  HOMO = -0.845416070105104  LUMO = 1.08784645615278
  mo_energy =
[-3.27690778e+01 -1.92710134e+00 -8.45416070e-01 -8.45416070e-01
 -8.45416070e-01  1.08784646e+00  1.08784646e+00  1.08784646e+00
  1.09777848e+00  5.67756008e+00  5.67756008e+00  5.67756008e+00
  6.64555136e+00  2.39836636e+01  2.39836636e+01  2.39836636e+01
  3.30941661e+01  1.18353716e+02  1.18353716e+02  1.18353716e+02
  1.36974819e+02  5.01239261e+02  1.86905218e+03  7.99886654e+03
  4.77667096e+04]
E1 = -182.59837964277165  E_coul = 54.0665515000014
cycle= 4 E= -128.53182814277  delta_E= -1.96e-08  |g|= 6.36e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138397
diis-c [-8.07415615e-10  2.92060317e-04  4.29461410e-04 -1.95953323e-01
  1.19523180e+00]
  HOMO = -0.845447746968163  LUMO = 1.08783364893842
  mo_energy =
[-3.27691331e+01 -1.92712192e+00 -8.45447747e-01 -8.45447747e-01
 -8.45447747e-01  1.08783365e+00  1.08783365e+00  1.08783365e+00
  1.09776897e+00  5.67752448e+00  5.67752448e+00  5.67752448e+00
  6.64552117e+00  2.39836150e+01  2.39836150e+01  2.39836150e+01
  3.30941182e+01  1.18353660e+02  1.18353660e+02  1.18353660e+02
  1.36974763e+02  5.01239197e+02  1.86905211e+03  7.99886647e+03
  4.77667095e+04]
E1 = -182.59849753153767  E_coul = 54.06666938828508
cycle= 5 E= -128.531828143253  delta_E= -4.82e-10  |g|= 5.66e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59849753153767  E_coul = 54.06666938828508
  HOMO = -0.845444774117985  LUMO = 1.08783490503407
  mo_energy =
[-3.27691268e+01 -1.92711822e+00 -8.45444774e-01 -8.45444774e-01
 -8.45444774e-01  1.08783491e+00  1.08783491e+00  1.08783491e+00
  1.09777069e+00  5.67752811e+00  5.67752811e+00  5.67752811e+00
  6.64552501e+00  2.39836204e+01  2.39836204e+01  2.39836204e+01
  3.30941239e+01  1.18353666e+02  1.18353666e+02  1.18353666e+02
  1.36974769e+02  5.01239203e+02  1.86905212e+03  7.99886647e+03
  4.77667095e+04]
E1 = -182.59848376833654  E_coul = 54.06665562508173
Extra cycle  E= -128.531828143255  delta_E= -2.22e-12  |g|= 1.94e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 317.4941285549469
E1 = -182.59848376833654  E_coul = 54.06665562508173
init E= -128.531828143255
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845445741191392  LUMO = 1.08783456937593
  mo_energy =
[-3.27691299e+01 -1.92711911e+00 -8.45445741e-01 -8.45445741e-01
 -8.45445741e-01  1.08783457e+00  1.08783457e+00  1.08783457e+00
  1.09777042e+00  5.67752693e+00  5.67752693e+00  5.67752693e+00
  6.64552397e+00  2.39836182e+01  2.39836182e+01  2.39836182e+01
  3.30941216e+01  1.18353663e+02  1.18353663e+02  1.18353663e+02
  1.36974766e+02  5.01239200e+02  1.86905211e+03  7.99886647e+03
  4.77667095e+04]
E1 = -182.59849123313217  E_coul = 54.0666630898771
cycle= 1 E= -128.531828143255  delta_E= -2.56e-13  |g|= 1.03e-06  |ddm|= 7.53e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59849123313217  E_coul = 54.0666630898771
  HOMO = -0.845445217896006  LUMO = 1.08783476155506
  mo_energy =
[-3.27691283e+01 -1.92711854e+00 -8.45445218e-01 -8.45445218e-01
 -8.45445218e-01  1.08783476e+00  1.08783476e+00  1.08783476e+00
  1.09777063e+00  5.67752758e+00  5.67752758e+00  5.67752758e+00
  6.64552459e+00  2.39836194e+01  2.39836194e+01  2.39836194e+01
  3.30941228e+01  1.18353664e+02  1.18353664e+02  1.18353664e+02
  1.36974768e+02  5.01239201e+02  1.86905211e+03  7.99886647e+03
  4.77667095e+04]
E1 = -182.59848753168194  E_coul = 54.06665938842679
Extra cycle  E= -128.531828143255  delta_E= -8.53e-14  |g|= 5.03e-07  |ddm|= 3.75e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272613e+02 2.35719100e+02
 7.65051086e+01 9.92879165e+00 2.70313580e+01 3.65203873e-01
 1.04034553e+00 2.63286619e+00 3.67620109e+00 1.24115861e+01
 5.45298706e+01 3.29808421e-01 1.14191809e+00]
grad_E = [ 2.87299021e-11 -1.23585603e-09  1.00264701e-08  5.27516681e-07
 -1.42502210e-05 -1.51378747e-04  1.21750149e-04  5.17749459e-05
 -1.78490873e-04 -1.69981861e-04 -3.32465900e-06  5.76973878e-06
 -4.02211498e-06  1.62357893e-04 -4.97204865e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438911        1
[INPUT] 0    0    [1    /1   ]  833.272617891        1
[INPUT] 0    0    [1    /1   ]  235.719040828        1
[INPUT] 0    0    [1    /1   ]  76.5055337749        1
[INPUT] 0    0    [1    /1   ]  9.93199809209        1
[INPUT] 0    0    [1    /1   ]  27.0295055019        1
[INPUT] 0    0    [1    /1   ]  0.365026387139       1
[INPUT] 0    0    [1    /1   ]  1.03980674862        1
[INPUT] 0    0    [1    /1   ]  2.63006642972        1
[INPUT] 1    0    [1    /1   ]  3.67719734402        1
[INPUT] 1    0    [1    /1   ]  12.4169236317        1
[INPUT] 1    0    [1    /1   ]  54.5802778013        1
[INPUT] 1    0    [1    /1   ]  0.329789908626       1
[INPUT] 1    0    [1    /1   ]  1.14207738015        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131551847, 1.0]], [0, [3661.4543891115804, 1.0]], [0, [833.27261789128, 1.0]], [0, [235.71904082798943, 1.0]], [0, [76.5055337748714, 1.0]], [0, [9.931998092091357, 1.0]], [0, [27.029505501926174, 1.0]], [0, [0.36502638713875996, 1.0]], [0, [1.0398067486208062, 1.0]], [0, [2.6300664297189504, 1.0]], [1, [3.677197344016377, 1.0]], [1, [12.416923631676022, 1.0]], [1, [54.58027780128966, 1.0]], [1, [0.3297899086257238, 1.0]], [1, [1.1420773801491622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438911]
bas 2, expnt(s) = [833.27261789]
bas 3, expnt(s) = [235.71904083]
bas 4, expnt(s) = [76.50553377]
bas 5, expnt(s) = [9.93199809]
bas 6, expnt(s) = [27.0295055]
bas 7, expnt(s) = [0.36502639]
bas 8, expnt(s) = [1.03980675]
bas 9, expnt(s) = [2.63006643]
bas 10, expnt(s) = [3.67719734]
bas 11, expnt(s) = [12.41692363]
bas 12, expnt(s) = [54.5802778]
bas 13, expnt(s) = [0.32978991]
bas 14, expnt(s) = [1.14207738]
CPU time:       231.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272618e+02 3.91836923e+02 2.35719041e+02 1.51988603e+02
 7.65055338e+01 6.53558792e+01 9.93199809e+00 1.41348920e+01
 2.70295055e+01 2.99497774e+01 3.65026387e-01 1.18647398e+00
 1.03980675e+00 2.60153395e+00 2.63006643e+00 5.21783165e+00
 3.67719734e+00 1.48552705e+01 1.24169236e+01 6.79989028e+01
 5.45802778e+01 4.32791846e+02 3.29789909e-01 7.29089923e-01
 1.14207738e+00 3.44432247e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99846368966999
cond(S) = 317.358662933361
E1 = -183.5771693374763  E_coul = 55.078455844073936
init E= -128.498713493402
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948282149529  LUMO = 1.11349411723774
  mo_energy =
[-3.25552461e+01 -1.85281108e+00 -7.73948282e-01 -7.73948282e-01
 -7.73948282e-01  1.11349412e+00  1.11349412e+00  1.11349412e+00
  1.12376278e+00  5.76556423e+00  5.76556423e+00  5.76556423e+00
  6.72183429e+00  2.41498342e+01  2.41498342e+01  2.41498342e+01
  3.32469692e+01  1.18667253e+02  1.18667253e+02  1.18667253e+02
  1.37178951e+02  5.01477153e+02  1.86932154e+03  7.99916320e+03
  4.77670251e+04]
E1 = -182.11146162824653  E_coul = 53.58298157699354
cycle= 1 E= -128.528480051253  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450526
diis-c [-0.20297397  1.        ]
  HOMO = -0.879528264345984  LUMO = 1.07542879672384
  mo_energy =
[-3.28736363e+01 -1.96304700e+00 -8.79528264e-01 -8.79528264e-01
 -8.79528264e-01  1.07542880e+00  1.07542880e+00  1.07542880e+00
  1.08419393e+00  5.63690908e+00  5.63690908e+00  5.63690908e+00
  6.60035517e+00  2.39152429e+01  2.39152429e+01  2.39152429e+01
  3.30058367e+01  1.18346773e+02  1.18346773e+02  1.18346773e+02
  1.36865560e+02  5.01120013e+02  1.86892852e+03  7.99874122e+03
  4.77665843e+04]
E1 = -182.84296154534903  E_coul = 54.311978984756294
cycle= 2 E= -128.530982560593  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224696
diis-c [-5.97240724e-04  3.31780076e-01  6.68219924e-01]
  HOMO = -0.845184828266513  LUMO = 1.08788915202348
  mo_energy =
[-3.27686527e+01 -1.92693190e+00 -8.45184828e-01 -8.45184828e-01
 -8.45184828e-01  1.08788915e+00  1.08788915e+00  1.08788915e+00
  1.09699431e+00  5.67875907e+00  5.67875907e+00  5.67875907e+00
  6.63988666e+00  2.39927048e+01  2.39927048e+01  2.39927048e+01
  3.30857095e+01  1.18451739e+02  1.18451739e+02  1.18451739e+02
  1.36968681e+02  5.01233664e+02  1.86904731e+03  7.99886242e+03
  4.77667064e+04]
E1 = -182.597683519101  E_coul = 54.065855184410395
cycle= 3 E= -128.531828334691  delta_E= -0.000846  |g|= 0.000483  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996987
diis-c [-1.02438228e-07 -2.16608884e-03 -1.33079489e-04  1.00229917e+00]
  HOMO = -0.845425712213519  LUMO = 1.08783843830967
  mo_energy =
[-3.27690892e+01 -1.92711239e+00 -8.45425712e-01 -8.45425712e-01
 -8.45425712e-01  1.08783844e+00  1.08783844e+00  1.08783844e+00
  1.09693918e+00  5.67854555e+00  5.67854555e+00  5.67854555e+00
  6.63969126e+00  2.39923628e+01  2.39923628e+01  2.39923628e+01
  3.30853697e+01  1.18451291e+02  1.18451291e+02  1.18451291e+02
  1.36968245e+02  5.01233124e+02  1.86904666e+03  7.99886169e+03
  4.77667056e+04]
E1 = -182.59827702141715  E_coul = 54.06644866706609
cycle= 4 E= -128.531828354351  delta_E= -1.97e-08  |g|= 6.36e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138343
diis-c [-8.07835325e-10  2.91940501e-04  4.29658756e-04 -1.95841641e-01
  1.19512004e+00]
  HOMO = -0.84545740854538  LUMO = 1.08782561882414
  mo_energy =
[-3.27691446e+01 -1.92713300e+00 -8.45457409e-01 -8.45457409e-01
 -8.45457409e-01  1.08782562e+00  1.08782562e+00  1.08782562e+00
  1.09692965e+00  5.67850993e+00  5.67850993e+00  5.67850993e+00
  6.63966105e+00  2.39923141e+01  2.39923141e+01  2.39923141e+01
  3.30853218e+01  1.18451235e+02  1.18451235e+02  1.18451235e+02
  1.36968190e+02  5.01233061e+02  1.86904659e+03  7.99886161e+03
  4.77667055e+04]
E1 = -182.59839484721516  E_coul = 54.066566492382
cycle= 5 E= -128.531828354833  delta_E= -4.82e-10  |g|= 5.65e-06  |ddm|= 3.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59839484721516  E_coul = 54.066566492382
  HOMO = -0.845454438070509  LUMO = 1.08782687428899
  mo_energy =
[-3.27691383e+01 -1.92712930e+00 -8.45454438e-01 -8.45454438e-01
 -8.45454438e-01  1.08782687e+00  1.08782687e+00  1.08782687e+00
  1.09693137e+00  5.67851355e+00  5.67851355e+00  5.67851355e+00
  6.63966489e+00  2.39923196e+01  2.39923196e+01  2.39923196e+01
  3.30853275e+01  1.18451241e+02  1.18451241e+02  1.18451241e+02
  1.36968196e+02  5.01233067e+02  1.86904660e+03  7.99886162e+03
  4.77667055e+04]
E1 = -182.59838110430042  E_coul = 54.06655274946504
Extra cycle  E= -128.531828354835  delta_E= -2.22e-12  |g|= 1.94e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272618e+02 2.35719041e+02
 7.65055338e+01 9.93199809e+00 2.70295055e+01 3.65026387e-01
 1.03980675e+00 2.63006643e+00 3.67719734e+00 1.24169236e+01
 5.45802778e+01 3.29789909e-01 1.14207738e+00]
E = -128.53182835483537
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438911        1
[INPUT] 0    0    [1    /1   ]  833.272617891        1
[INPUT] 0    0    [1    /1   ]  235.719040828        1
[INPUT] 0    0    [1    /1   ]  76.5055337749        1
[INPUT] 0    0    [1    /1   ]  9.93199809209        1
[INPUT] 0    0    [1    /1   ]  27.0295055019        1
[INPUT] 0    0    [1    /1   ]  0.365026387139       1
[INPUT] 0    0    [1    /1   ]  1.03980674862        1
[INPUT] 0    0    [1    /1   ]  2.63006642972        1
[INPUT] 1    0    [1    /1   ]  3.67719734402        1
[INPUT] 1    0    [1    /1   ]  12.4169236317        1
[INPUT] 1    0    [1    /1   ]  54.5802778013        1
[INPUT] 1    0    [1    /1   ]  0.329789908626       1
[INPUT] 1    0    [1    /1   ]  1.14207738015        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131551847, 1.0]], [0, [3661.4543891115804, 1.0]], [0, [833.27261789128, 1.0]], [0, [235.71904082798943, 1.0]], [0, [76.5055337748714, 1.0]], [0, [9.931998092091357, 1.0]], [0, [27.029505501926174, 1.0]], [0, [0.36502638713875996, 1.0]], [0, [1.0398067486208062, 1.0]], [0, [2.6300664297189504, 1.0]], [1, [3.677197344016377, 1.0]], [1, [12.416923631676022, 1.0]], [1, [54.58027780128966, 1.0]], [1, [0.3297899086257238, 1.0]], [1, [1.1420773801491622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438911]
bas 2, expnt(s) = [833.27261789]
bas 3, expnt(s) = [235.71904083]
bas 4, expnt(s) = [76.50553377]
bas 5, expnt(s) = [9.93199809]
bas 6, expnt(s) = [27.0295055]
bas 7, expnt(s) = [0.36502639]
bas 8, expnt(s) = [1.03980675]
bas 9, expnt(s) = [2.63006643]
bas 10, expnt(s) = [3.67719734]
bas 11, expnt(s) = [12.41692363]
bas 12, expnt(s) = [54.5802778]
bas 13, expnt(s) = [0.32978991]
bas 14, expnt(s) = [1.14207738]
CPU time:       232.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272618e+02 3.91836923e+02 2.35719041e+02 1.51988603e+02
 7.65055338e+01 6.53558792e+01 9.93199809e+00 1.41348920e+01
 2.70295055e+01 2.99497774e+01 3.65026387e-01 1.18647398e+00
 1.03980675e+00 2.60153395e+00 2.63006643e+00 5.21783165e+00
 3.67719734e+00 1.48552705e+01 1.24169236e+01 6.79989028e+01
 5.45802778e+01 4.32791846e+02 3.29789909e-01 7.29089923e-01
 1.14207738e+00 3.44432247e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99846368966999
cond(S) = 317.358662933361
E1 = -183.5771693374763  E_coul = 55.078455844073936
init E= -128.498713493402
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773948282149529  LUMO = 1.11349411723774
  mo_energy =
[-3.25552461e+01 -1.85281108e+00 -7.73948282e-01 -7.73948282e-01
 -7.73948282e-01  1.11349412e+00  1.11349412e+00  1.11349412e+00
  1.12376278e+00  5.76556423e+00  5.76556423e+00  5.76556423e+00
  6.72183429e+00  2.41498342e+01  2.41498342e+01  2.41498342e+01
  3.32469692e+01  1.18667253e+02  1.18667253e+02  1.18667253e+02
  1.37178951e+02  5.01477153e+02  1.86932154e+03  7.99916320e+03
  4.77670251e+04]
E1 = -182.11146162824653  E_coul = 53.58298157699354
cycle= 1 E= -128.528480051253  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450526
diis-c [-0.20297397  1.        ]
  HOMO = -0.879528264345984  LUMO = 1.07542879672384
  mo_energy =
[-3.28736363e+01 -1.96304700e+00 -8.79528264e-01 -8.79528264e-01
 -8.79528264e-01  1.07542880e+00  1.07542880e+00  1.07542880e+00
  1.08419393e+00  5.63690908e+00  5.63690908e+00  5.63690908e+00
  6.60035517e+00  2.39152429e+01  2.39152429e+01  2.39152429e+01
  3.30058367e+01  1.18346773e+02  1.18346773e+02  1.18346773e+02
  1.36865560e+02  5.01120013e+02  1.86892852e+03  7.99874122e+03
  4.77665843e+04]
E1 = -182.84296154534903  E_coul = 54.311978984756294
cycle= 2 E= -128.530982560593  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224696
diis-c [-5.97240724e-04  3.31780076e-01  6.68219924e-01]
  HOMO = -0.845184828266513  LUMO = 1.08788915202348
  mo_energy =
[-3.27686527e+01 -1.92693190e+00 -8.45184828e-01 -8.45184828e-01
 -8.45184828e-01  1.08788915e+00  1.08788915e+00  1.08788915e+00
  1.09699431e+00  5.67875907e+00  5.67875907e+00  5.67875907e+00
  6.63988666e+00  2.39927048e+01  2.39927048e+01  2.39927048e+01
  3.30857095e+01  1.18451739e+02  1.18451739e+02  1.18451739e+02
  1.36968681e+02  5.01233664e+02  1.86904731e+03  7.99886242e+03
  4.77667064e+04]
E1 = -182.597683519101  E_coul = 54.065855184410395
cycle= 3 E= -128.531828334691  delta_E= -0.000846  |g|= 0.000483  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996987
diis-c [-1.02438228e-07 -2.16608884e-03 -1.33079489e-04  1.00229917e+00]
  HOMO = -0.845425712213519  LUMO = 1.08783843830967
  mo_energy =
[-3.27690892e+01 -1.92711239e+00 -8.45425712e-01 -8.45425712e-01
 -8.45425712e-01  1.08783844e+00  1.08783844e+00  1.08783844e+00
  1.09693918e+00  5.67854555e+00  5.67854555e+00  5.67854555e+00
  6.63969126e+00  2.39923628e+01  2.39923628e+01  2.39923628e+01
  3.30853697e+01  1.18451291e+02  1.18451291e+02  1.18451291e+02
  1.36968245e+02  5.01233124e+02  1.86904666e+03  7.99886169e+03
  4.77667056e+04]
E1 = -182.59827702141715  E_coul = 54.06644866706609
cycle= 4 E= -128.531828354351  delta_E= -1.97e-08  |g|= 6.36e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138343
diis-c [-8.07835325e-10  2.91940501e-04  4.29658756e-04 -1.95841641e-01
  1.19512004e+00]
  HOMO = -0.84545740854538  LUMO = 1.08782561882414
  mo_energy =
[-3.27691446e+01 -1.92713300e+00 -8.45457409e-01 -8.45457409e-01
 -8.45457409e-01  1.08782562e+00  1.08782562e+00  1.08782562e+00
  1.09692965e+00  5.67850993e+00  5.67850993e+00  5.67850993e+00
  6.63966105e+00  2.39923141e+01  2.39923141e+01  2.39923141e+01
  3.30853218e+01  1.18451235e+02  1.18451235e+02  1.18451235e+02
  1.36968190e+02  5.01233061e+02  1.86904659e+03  7.99886161e+03
  4.77667055e+04]
E1 = -182.59839484721516  E_coul = 54.066566492382
cycle= 5 E= -128.531828354833  delta_E= -4.82e-10  |g|= 5.65e-06  |ddm|= 3.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59839484721516  E_coul = 54.066566492382
  HOMO = -0.845454438070509  LUMO = 1.08782687428899
  mo_energy =
[-3.27691383e+01 -1.92712930e+00 -8.45454438e-01 -8.45454438e-01
 -8.45454438e-01  1.08782687e+00  1.08782687e+00  1.08782687e+00
  1.09693137e+00  5.67851355e+00  5.67851355e+00  5.67851355e+00
  6.63966489e+00  2.39923196e+01  2.39923196e+01  2.39923196e+01
  3.30853275e+01  1.18451241e+02  1.18451241e+02  1.18451241e+02
  1.36968196e+02  5.01233067e+02  1.86904660e+03  7.99886162e+03
  4.77667055e+04]
E1 = -182.59838110430042  E_coul = 54.06655274946504
Extra cycle  E= -128.531828354835  delta_E= -2.22e-12  |g|= 1.94e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 317.358662933361
E1 = -182.59838110430042  E_coul = 54.06655274946504
init E= -128.531828354835
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845455403738269  LUMO = 1.08782653912169
  mo_energy =
[-3.27691414e+01 -1.92713019e+00 -8.45455404e-01 -8.45455404e-01
 -8.45455404e-01  1.08782654e+00  1.08782654e+00  1.08782654e+00
  1.09693110e+00  5.67851238e+00  5.67851238e+00  5.67851238e+00
  6.63966385e+00  2.39923174e+01  2.39923174e+01  2.39923174e+01
  3.30853252e+01  1.18451238e+02  1.18451238e+02  1.18451238e+02
  1.36968193e+02  5.01233064e+02  1.86904659e+03  7.99886161e+03
  4.77667055e+04]
E1 = -182.59838855954496  E_coul = 54.066560204709255
cycle= 1 E= -128.531828354836  delta_E= -3.41e-13  |g|= 1.03e-06  |ddm|= 7.52e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59838855954496  E_coul = 54.066560204709255
  HOMO = -0.845454881120549  LUMO = 1.08782673107512
  mo_energy =
[-3.27691398e+01 -1.92712961e+00 -8.45454881e-01 -8.45454881e-01
 -8.45454881e-01  1.08782673e+00  1.08782673e+00  1.08782673e+00
  1.09693131e+00  5.67851302e+00  5.67851302e+00  5.67851302e+00
  6.63966447e+00  2.39923186e+01  2.39923186e+01  2.39923186e+01
  3.30853264e+01  1.18451240e+02  1.18451240e+02  1.18451240e+02
  1.36968194e+02  5.01233065e+02  1.86904660e+03  7.99886161e+03
  4.77667055e+04]
E1 = -182.59838486285437  E_coul = 54.0665565080187
Extra cycle  E= -128.531828354836  delta_E= 2.84e-14  |g|= 5.03e-07  |ddm|= 3.75e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272618e+02 2.35719041e+02
 7.65055338e+01 9.93199809e+00 2.70295055e+01 3.65026387e-01
 1.03980675e+00 2.63006643e+00 3.67719734e+00 1.24169236e+01
 5.45802778e+01 3.29789909e-01 1.14207738e+00]
grad_E = [ 7.22343191e-11 -3.51730798e-09  5.57084161e-08 -8.60108571e-09
 -1.02135475e-05 -1.13745607e-04  1.03312167e-04 -1.32819528e-05
 -1.61516107e-04 -1.84478131e-04  6.02397047e-06 -4.25217520e-07
 -2.59547721e-06 -5.94284046e-05 -1.39285941e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438905        1
[INPUT] 0    0    [1    /1   ]  833.272619142        1
[INPUT] 0    0    [1    /1   ]  235.719024654        1
[INPUT] 0    0    [1    /1   ]  76.5056761482        1
[INPUT] 0    0    [1    /1   ]  9.93363752303        1
[INPUT] 0    0    [1    /1   ]  27.0286952947        1
[INPUT] 0    0    [1    /1   ]  0.365102067933       1
[INPUT] 0    0    [1    /1   ]  1.03999320373        1
[INPUT] 0    0    [1    /1   ]  2.62939688127        1
[INPUT] 1    0    [1    /1   ]  3.67697744729        1
[INPUT] 1    0    [1    /1   ]  12.4160967471        1
[INPUT] 1    0    [1    /1   ]  54.5739575764        1
[INPUT] 1    0    [1    /1   ]  0.329761515466       1
[INPUT] 1    0    [1    /1   ]  1.14200124695        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131553008, 1.0]], [0, [3661.454389050229, 1.0]], [0, [833.272619141997, 1.0]], [0, [235.71902465366924, 1.0]], [0, [76.5056761481768, 1.0]], [0, [9.933637523025789, 1.0]], [0, [27.02869529467601, 1.0]], [0, [0.36510206793330363, 1.0]], [0, [1.0399932037277506, 1.0]], [0, [2.629396881271315, 1.0]], [1, [3.676977447292465, 1.0]], [1, [12.416096747053626, 1.0]], [1, [54.57395757639677, 1.0]], [1, [0.329761515466187, 1.0]], [1, [1.142001246946908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438905]
bas 2, expnt(s) = [833.27261914]
bas 3, expnt(s) = [235.71902465]
bas 4, expnt(s) = [76.50567615]
bas 5, expnt(s) = [9.93363752]
bas 6, expnt(s) = [27.02869529]
bas 7, expnt(s) = [0.36510207]
bas 8, expnt(s) = [1.0399932]
bas 9, expnt(s) = [2.62939688]
bas 10, expnt(s) = [3.67697745]
bas 11, expnt(s) = [12.41609675]
bas 12, expnt(s) = [54.57395758]
bas 13, expnt(s) = [0.32976152]
bas 14, expnt(s) = [1.14200125]
CPU time:       235.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272619e+02 3.91836923e+02 2.35719025e+02 1.51988595e+02
 7.65056761e+01 6.53559704e+01 9.93363752e+00 1.41366419e+01
 2.70286953e+01 2.99491041e+01 3.65102068e-01 1.18665847e+00
 1.03999320e+00 2.60188382e+00 2.62939688e+00 5.21683537e+00
 3.67697745e+00 1.48541601e+01 1.24160967e+01 6.79932425e+01
 5.45739576e+01 4.32729202e+02 3.29761515e-01 7.29011460e-01
 1.14200125e+00 3.44403547e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9984641947034
cond(S) = 317.43124303882655
E1 = -183.57715951545313  E_coul = 55.07845425884748
init E= -128.498705256606
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948410522398  LUMO = 1.11338338735655
  mo_energy =
[-3.25552465e+01 -1.85281128e+00 -7.73948411e-01 -7.73948411e-01
 -7.73948411e-01  1.11338339e+00  1.11338339e+00  1.11338339e+00
  1.12403384e+00  5.76510946e+00  5.76510946e+00  5.76510946e+00
  6.72200600e+00  2.41480129e+01  2.41480129e+01  2.41480129e+01
  3.32481275e+01  1.18654030e+02  1.18654030e+02  1.18654030e+02
  1.37181363e+02  5.01479300e+02  1.86932344e+03  7.99916487e+03
  4.77670264e+04]
E1 = -182.11140563772125  E_coul = 53.5829256257116
cycle= 1 E= -128.52848001201  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450532
diis-c [-0.20297947  1.        ]
  HOMO = -0.87953283638098  LUMO = 1.07531984622318
  mo_energy =
[-3.28736448e+01 -1.96305281e+00 -8.79532836e-01 -8.79532836e-01
 -8.79532836e-01  1.07531985e+00  1.07531985e+00  1.07531985e+00
  1.08445532e+00  5.63645464e+00  5.63645464e+00  5.63645464e+00
  6.60052630e+00  2.39134199e+01  2.39134199e+01  2.39134199e+01
  3.30069849e+01  1.18333548e+02  1.18333548e+02  1.18333548e+02
  1.36867964e+02  5.01122153e+02  1.86893041e+03  7.99874288e+03
  4.77665856e+04]
E1 = -182.84293199124903  E_coul = 54.311949359399065
cycle= 2 E= -128.53098263185  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224703
diis-c [-5.97276873e-04  3.31784202e-01  6.68215798e-01]
  HOMO = -0.845188327853845  LUMO = 1.08777935138364
  mo_energy =
[-3.27686583e+01 -1.92693653e+00 -8.45188328e-01 -8.45188328e-01
 -8.45188328e-01  1.08777935e+00  1.08777935e+00  1.08777935e+00
  1.09725827e+00  5.67830412e+00  5.67830412e+00  5.67830412e+00
  6.64005735e+00  2.39908823e+01  2.39908823e+01  2.39908823e+01
  3.30868613e+01  1.18438515e+02  1.18438515e+02  1.18438515e+02
  1.36971088e+02  5.01235807e+02  1.86904921e+03  7.99886409e+03
  4.77667077e+04]
E1 = -182.59764242651525  E_coul = 54.065813951247875
cycle= 3 E= -128.531828475267  delta_E= -0.000846  |g|= 0.000483  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996568
diis-c [-1.02258514e-07 -2.16614241e-03 -1.34809021e-04  1.00230095e+00]
  HOMO = -0.845429234619933  LUMO = 1.0877286268314
  mo_energy =
[-3.27690948e+01 -1.92711710e+00 -8.45429235e-01 -8.45429235e-01
 -8.45429235e-01  1.08772863e+00  1.08772863e+00  1.08772863e+00
  1.09720307e+00  5.67809059e+00  5.67809059e+00  5.67809059e+00
  6.63986189e+00  2.39905403e+01  2.39905403e+01  2.39905403e+01
  3.30865214e+01  1.18438067e+02  1.18438067e+02  1.18438067e+02
  1.36970653e+02  5.01235268e+02  1.86904856e+03  7.99886335e+03
  4.77667070e+04]
E1 = -182.5982356017906  E_coul = 54.06640710687595
cycle= 4 E= -128.531828494915  delta_E= -1.96e-08  |g|= 6.36e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138268
diis-c [-8.07269576e-10  2.91660538e-04  4.29698504e-04 -1.95689600e-01
  1.19496824e+00]
  HOMO = -0.845460927113463  LUMO = 1.08771580853842
  mo_energy =
[-3.27691501e+01 -1.92713773e+00 -8.45460927e-01 -8.45460927e-01
 -8.45460927e-01  1.08771581e+00  1.08771581e+00  1.08771581e+00
  1.09719353e+00  5.67805497e+00  5.67805497e+00  5.67805497e+00
  6.63983168e+00  2.39904917e+01  2.39904917e+01  2.39904917e+01
  3.30864736e+01  1.18438011e+02  1.18438011e+02  1.18438011e+02
  1.36970597e+02  5.01235204e+02  1.86904849e+03  7.99886328e+03
  4.77667069e+04]
E1 = -182.59835337129664  E_coul = 54.066524875900726
cycle= 5 E= -128.531828495396  delta_E= -4.81e-10  |g|= 5.65e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59835337129664  E_coul = 54.066524875900726
  HOMO = -0.845457960509141  LUMO = 1.08771706239234
  mo_energy =
[-3.27691439e+01 -1.92713403e+00 -8.45457961e-01 -8.45457961e-01
 -8.45457961e-01  1.08771706e+00  1.08771706e+00  1.08771706e+00
  1.09719525e+00  5.67805859e+00  5.67805859e+00  5.67805859e+00
  6.63983551e+00  2.39904971e+01  2.39904971e+01  2.39904971e+01
  3.30864792e+01  1.18438017e+02  1.18438017e+02  1.18438017e+02
  1.36970603e+02  5.01235210e+02  1.86904849e+03  7.99886328e+03
  4.77667069e+04]
E1 = -182.59833964887295  E_coul = 54.06651115347495
Extra cycle  E= -128.531828495398  delta_E= -2.07e-12  |g|= 1.94e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272619e+02 2.35719025e+02
 7.65056761e+01 9.93363752e+00 2.70286953e+01 3.65102068e-01
 1.03999320e+00 2.62939688e+00 3.67697745e+00 1.24160967e+01
 5.45739576e+01 3.29761515e-01 1.14200125e+00]
E = -128.531828495398
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438905        1
[INPUT] 0    0    [1    /1   ]  833.272619142        1
[INPUT] 0    0    [1    /1   ]  235.719024654        1
[INPUT] 0    0    [1    /1   ]  76.5056761482        1
[INPUT] 0    0    [1    /1   ]  9.93363752303        1
[INPUT] 0    0    [1    /1   ]  27.0286952947        1
[INPUT] 0    0    [1    /1   ]  0.365102067933       1
[INPUT] 0    0    [1    /1   ]  1.03999320373        1
[INPUT] 0    0    [1    /1   ]  2.62939688127        1
[INPUT] 1    0    [1    /1   ]  3.67697744729        1
[INPUT] 1    0    [1    /1   ]  12.4160967471        1
[INPUT] 1    0    [1    /1   ]  54.5739575764        1
[INPUT] 1    0    [1    /1   ]  0.329761515466       1
[INPUT] 1    0    [1    /1   ]  1.14200124695        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131553008, 1.0]], [0, [3661.454389050229, 1.0]], [0, [833.272619141997, 1.0]], [0, [235.71902465366924, 1.0]], [0, [76.5056761481768, 1.0]], [0, [9.933637523025789, 1.0]], [0, [27.02869529467601, 1.0]], [0, [0.36510206793330363, 1.0]], [0, [1.0399932037277506, 1.0]], [0, [2.629396881271315, 1.0]], [1, [3.676977447292465, 1.0]], [1, [12.416096747053626, 1.0]], [1, [54.57395757639677, 1.0]], [1, [0.329761515466187, 1.0]], [1, [1.142001246946908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413155]
bas 1, expnt(s) = [3661.45438905]
bas 2, expnt(s) = [833.27261914]
bas 3, expnt(s) = [235.71902465]
bas 4, expnt(s) = [76.50567615]
bas 5, expnt(s) = [9.93363752]
bas 6, expnt(s) = [27.02869529]
bas 7, expnt(s) = [0.36510207]
bas 8, expnt(s) = [1.0399932]
bas 9, expnt(s) = [2.62939688]
bas 10, expnt(s) = [3.67697745]
bas 11, expnt(s) = [12.41609675]
bas 12, expnt(s) = [54.57395758]
bas 13, expnt(s) = [0.32976152]
bas 14, expnt(s) = [1.14200125]
CPU time:       236.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272619e+02 3.91836923e+02 2.35719025e+02 1.51988595e+02
 7.65056761e+01 6.53559704e+01 9.93363752e+00 1.41366419e+01
 2.70286953e+01 2.99491041e+01 3.65102068e-01 1.18665847e+00
 1.03999320e+00 2.60188382e+00 2.62939688e+00 5.21683537e+00
 3.67697745e+00 1.48541601e+01 1.24160967e+01 6.79932425e+01
 5.45739576e+01 4.32729202e+02 3.29761515e-01 7.29011460e-01
 1.14200125e+00 3.44403547e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9984641947034
cond(S) = 317.43124303882655
E1 = -183.57715951545313  E_coul = 55.07845425884748
init E= -128.498705256606
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773948410522398  LUMO = 1.11338338735655
  mo_energy =
[-3.25552465e+01 -1.85281128e+00 -7.73948411e-01 -7.73948411e-01
 -7.73948411e-01  1.11338339e+00  1.11338339e+00  1.11338339e+00
  1.12403384e+00  5.76510946e+00  5.76510946e+00  5.76510946e+00
  6.72200600e+00  2.41480129e+01  2.41480129e+01  2.41480129e+01
  3.32481275e+01  1.18654030e+02  1.18654030e+02  1.18654030e+02
  1.37181363e+02  5.01479300e+02  1.86932344e+03  7.99916487e+03
  4.77670264e+04]
E1 = -182.11140563772125  E_coul = 53.5829256257116
cycle= 1 E= -128.52848001201  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450532
diis-c [-0.20297947  1.        ]
  HOMO = -0.87953283638098  LUMO = 1.07531984622318
  mo_energy =
[-3.28736448e+01 -1.96305281e+00 -8.79532836e-01 -8.79532836e-01
 -8.79532836e-01  1.07531985e+00  1.07531985e+00  1.07531985e+00
  1.08445532e+00  5.63645464e+00  5.63645464e+00  5.63645464e+00
  6.60052630e+00  2.39134199e+01  2.39134199e+01  2.39134199e+01
  3.30069849e+01  1.18333548e+02  1.18333548e+02  1.18333548e+02
  1.36867964e+02  5.01122153e+02  1.86893041e+03  7.99874288e+03
  4.77665856e+04]
E1 = -182.84293199124903  E_coul = 54.311949359399065
cycle= 2 E= -128.53098263185  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224703
diis-c [-5.97276873e-04  3.31784202e-01  6.68215798e-01]
  HOMO = -0.845188327853845  LUMO = 1.08777935138364
  mo_energy =
[-3.27686583e+01 -1.92693653e+00 -8.45188328e-01 -8.45188328e-01
 -8.45188328e-01  1.08777935e+00  1.08777935e+00  1.08777935e+00
  1.09725827e+00  5.67830412e+00  5.67830412e+00  5.67830412e+00
  6.64005735e+00  2.39908823e+01  2.39908823e+01  2.39908823e+01
  3.30868613e+01  1.18438515e+02  1.18438515e+02  1.18438515e+02
  1.36971088e+02  5.01235807e+02  1.86904921e+03  7.99886409e+03
  4.77667077e+04]
E1 = -182.59764242651525  E_coul = 54.065813951247875
cycle= 3 E= -128.531828475267  delta_E= -0.000846  |g|= 0.000483  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996568
diis-c [-1.02258514e-07 -2.16614241e-03 -1.34809021e-04  1.00230095e+00]
  HOMO = -0.845429234619933  LUMO = 1.0877286268314
  mo_energy =
[-3.27690948e+01 -1.92711710e+00 -8.45429235e-01 -8.45429235e-01
 -8.45429235e-01  1.08772863e+00  1.08772863e+00  1.08772863e+00
  1.09720307e+00  5.67809059e+00  5.67809059e+00  5.67809059e+00
  6.63986189e+00  2.39905403e+01  2.39905403e+01  2.39905403e+01
  3.30865214e+01  1.18438067e+02  1.18438067e+02  1.18438067e+02
  1.36970653e+02  5.01235268e+02  1.86904856e+03  7.99886335e+03
  4.77667070e+04]
E1 = -182.5982356017906  E_coul = 54.06640710687595
cycle= 4 E= -128.531828494915  delta_E= -1.96e-08  |g|= 6.36e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138268
diis-c [-8.07269576e-10  2.91660538e-04  4.29698504e-04 -1.95689600e-01
  1.19496824e+00]
  HOMO = -0.845460927113463  LUMO = 1.08771580853842
  mo_energy =
[-3.27691501e+01 -1.92713773e+00 -8.45460927e-01 -8.45460927e-01
 -8.45460927e-01  1.08771581e+00  1.08771581e+00  1.08771581e+00
  1.09719353e+00  5.67805497e+00  5.67805497e+00  5.67805497e+00
  6.63983168e+00  2.39904917e+01  2.39904917e+01  2.39904917e+01
  3.30864736e+01  1.18438011e+02  1.18438011e+02  1.18438011e+02
  1.36970597e+02  5.01235204e+02  1.86904849e+03  7.99886328e+03
  4.77667069e+04]
E1 = -182.59835337129664  E_coul = 54.066524875900726
cycle= 5 E= -128.531828495396  delta_E= -4.81e-10  |g|= 5.65e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59835337129664  E_coul = 54.066524875900726
  HOMO = -0.845457960509141  LUMO = 1.08771706239234
  mo_energy =
[-3.27691439e+01 -1.92713403e+00 -8.45457961e-01 -8.45457961e-01
 -8.45457961e-01  1.08771706e+00  1.08771706e+00  1.08771706e+00
  1.09719525e+00  5.67805859e+00  5.67805859e+00  5.67805859e+00
  6.63983551e+00  2.39904971e+01  2.39904971e+01  2.39904971e+01
  3.30864792e+01  1.18438017e+02  1.18438017e+02  1.18438017e+02
  1.36970603e+02  5.01235210e+02  1.86904849e+03  7.99886328e+03
  4.77667069e+04]
E1 = -182.59833964887295  E_coul = 54.06651115347495
Extra cycle  E= -128.531828495398  delta_E= -2.07e-12  |g|= 1.94e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 317.43124303882655
E1 = -182.59833964887295  E_coul = 54.06651115347495
init E= -128.531828495398
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845458924778082  LUMO = 1.08771672776435
  mo_energy =
[-3.27691470e+01 -1.92713492e+00 -8.45458925e-01 -8.45458925e-01
 -8.45458925e-01  1.08771673e+00  1.08771673e+00  1.08771673e+00
  1.09719498e+00  5.67805742e+00  5.67805742e+00  5.67805742e+00
  6.63983448e+00  2.39904949e+01  2.39904949e+01  2.39904949e+01
  3.30864770e+01  1.18438014e+02  1.18438014e+02  1.18438014e+02
  1.36970600e+02  5.01235207e+02  1.86904849e+03  7.99886328e+03
  4.77667069e+04]
E1 = -182.59834709366973  E_coul = 54.066518598271486
cycle= 1 E= -128.531828495398  delta_E= -2.56e-13  |g|= 1.03e-06  |ddm|= 7.51e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59834709366973  E_coul = 54.066518598271486
  HOMO = -0.845458402901728  LUMO = 1.08771691943043
  mo_energy =
[-3.27691454e+01 -1.92713434e+00 -8.45458403e-01 -8.45458403e-01
 -8.45458403e-01  1.08771692e+00  1.08771692e+00  1.08771692e+00
  1.09719519e+00  5.67805806e+00  5.67805806e+00  5.67805806e+00
  6.63983510e+00  2.39904961e+01  2.39904961e+01  2.39904961e+01
  3.30864782e+01  1.18438016e+02  1.18438016e+02  1.18438016e+02
  1.36970602e+02  5.01235208e+02  1.86904849e+03  7.99886328e+03
  4.77667069e+04]
E1 = -182.598343402187  E_coul = 54.06651490678871
Extra cycle  E= -128.531828495398  delta_E= -2.84e-14  |g|= 5.02e-07  |ddm|= 3.74e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272619e+02 2.35719025e+02
 7.65056761e+01 9.93363752e+00 2.70286953e+01 3.65102068e-01
 1.03999320e+00 2.62939688e+00 3.67697745e+00 1.24160967e+01
 5.45739576e+01 3.29761515e-01 1.14200125e+00]
grad_E = [ 9.18246905e-11 -4.54468167e-09  7.62963994e-08 -2.50524927e-07
 -8.38985724e-06 -9.76137021e-05  9.50557592e-05 -2.50832727e-05
 -1.51108015e-04 -1.91930194e-04  3.21373056e-06  5.29504068e-07
 -2.75504575e-06 -1.23624496e-04  5.40336906e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438887        1
[INPUT] 0    0    [1    /1   ]  833.272622863        1
[INPUT] 0    0    [1    /1   ]  235.718972697        1
[INPUT] 0    0    [1    /1   ]  76.5061880089        1
[INPUT] 0    0    [1    /1   ]  9.93894107937        1
[INPUT] 0    0    [1    /1   ]  27.0255919602        1
[INPUT] 0    0    [1    /1   ]  0.365286179286       1
[INPUT] 0    0    [1    /1   ]  1.04069469829        1
[INPUT] 0    0    [1    /1   ]  2.62920907826        1
[INPUT] 1    0    [1    /1   ]  3.6766995874         1
[INPUT] 1    0    [1    /1   ]  12.4154020172        1
[INPUT] 1    0    [1    /1   ]  54.5807309444        1
[INPUT] 1    0    [1    /1   ]  0.329694109685       1
[INPUT] 1    0    [1    /1   ]  1.14186639958        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131556322, 1.0]], [0, [3661.4543888720273, 1.0]], [0, [833.2726228629894, 1.0]], [0, [235.71897269722928, 1.0]], [0, [76.50618800887706, 1.0]], [0, [9.93894107936713, 1.0]], [0, [27.02559196019468, 1.0]], [0, [0.36528617928584783, 1.0]], [0, [1.0406946982945857, 1.0]], [0, [2.6292090782612374, 1.0]], [1, [3.67669958739914, 1.0]], [1, [12.415402017200512, 1.0]], [1, [54.58073094437015, 1.0]], [1, [0.32969410968518725, 1.0]], [1, [1.141866399575791, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413156]
bas 1, expnt(s) = [3661.45438887]
bas 2, expnt(s) = [833.27262286]
bas 3, expnt(s) = [235.7189727]
bas 4, expnt(s) = [76.50618801]
bas 5, expnt(s) = [9.93894108]
bas 6, expnt(s) = [27.02559196]
bas 7, expnt(s) = [0.36528618]
bas 8, expnt(s) = [1.0406947]
bas 9, expnt(s) = [2.62920908]
bas 10, expnt(s) = [3.67669959]
bas 11, expnt(s) = [12.41540202]
bas 12, expnt(s) = [54.58073094]
bas 13, expnt(s) = [0.32969411]
bas 14, expnt(s) = [1.1418664]
CPU time:       239.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272623e+02 3.91836925e+02 2.35718973e+02 1.51988570e+02
 7.65061880e+01 6.53562984e+01 9.93894108e+00 1.41423021e+01
 2.70255920e+01 2.99465251e+01 3.65286179e-01 1.18710724e+00
 1.04069470e+00 2.60319997e+00 2.62920908e+00 5.21655591e+00
 3.67669959e+00 1.48527570e+01 1.24154020e+01 6.79884869e+01
 5.45807309e+01 4.32796337e+02 3.29694110e-01 7.28825195e-01
 1.14186640e+00 3.44352714e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99846519940506
cond(S) = 317.70041200194487
E1 = -183.57712936713418  E_coul = 55.078449770986076
init E= -128.498679596148
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948746566665  LUMO = 1.11313538533993
  mo_energy =
[-3.25552478e+01 -1.85281178e+00 -7.73948747e-01 -7.73948747e-01
 -7.73948747e-01  1.11313539e+00  1.11313539e+00  1.11313539e+00
  1.12488007e+00  5.76432685e+00  5.76432685e+00  5.76432685e+00
  6.72521973e+00  2.41457801e+01  2.41457801e+01  2.41457801e+01
  3.32593209e+01  1.18660964e+02  1.18660964e+02  1.18660964e+02
  1.37196215e+02  5.01492066e+02  1.86933466e+03  7.99917470e+03
  4.77670346e+04]
E1 = -182.1112579250453  E_coul = 53.582777667948164
cycle= 1 E= -128.528480257097  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450532
diis-c [-0.20297948  1.        ]
  HOMO = -0.879545225331113  LUMO = 1.07507439666558
  mo_energy =
[-3.28736666e+01 -1.96306833e+00 -8.79545225e-01 -8.79545225e-01
 -8.79545225e-01  1.07507440e+00  1.07507440e+00  1.07507440e+00
  1.08526745e+00  5.63566487e+00  5.63566487e+00  5.63566487e+00
  6.60369996e+00  2.39111735e+01  2.39111735e+01  2.39111735e+01
  3.30181444e+01  1.18340458e+02  1.18340458e+02  1.18340458e+02
  1.36882799e+02  5.01134904e+02  1.86894161e+03  7.99875269e+03
  4.77665937e+04]
E1 = -182.84285366877688  E_coul = 54.31187050658169
cycle= 2 E= -128.530983162195  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224715
diis-c [-5.97381142e-04  3.31796179e-01  6.68203821e-01]
  HOMO = -0.845197970920198  LUMO = 1.08753239646596
  mo_energy =
[-3.27686725e+01 -1.92694906e+00 -8.45197971e-01 -8.45197971e-01
 -8.45197971e-01  1.08753240e+00  1.08753240e+00  1.08753240e+00
  1.09808001e+00  5.67751552e+00  5.67751552e+00  5.67751552e+00
  6.64324233e+00  2.39886406e+01  2.39886406e+01  2.39886406e+01
  3.30980324e+01  1.18445434e+02  1.18445434e+02  1.18445434e+02
  1.36985930e+02  5.01248565e+02  1.86906042e+03  7.99887391e+03
  4.77667159e+04]
E1 = -182.5975346871536  E_coul = 54.065705500461306
cycle= 3 E= -128.531829186692  delta_E= -0.000846  |g|= 0.000482  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000995041
diis-c [-1.01799265e-07 -2.16605498e-03 -1.40787632e-04  1.00230684e+00]
  HOMO = -0.845438844093344  LUMO = 1.08748168317945
  mo_energy =
[-3.27691087e+01 -1.92712973e+00 -8.45438844e-01 -8.45438844e-01
 -8.45438844e-01  1.08748168e+00  1.08748168e+00  1.08748168e+00
  1.09802467e+00  5.67730205e+00  5.67730205e+00  5.67730205e+00
  6.64304679e+00  2.39882989e+01  2.39882989e+01  2.39882989e+01
  3.30976928e+01  1.18444987e+02  1.18444987e+02  1.18444987e+02
  1.36985496e+02  5.01248027e+02  1.86905977e+03  7.99887318e+03
  4.77667151e+04]
E1 = -182.59812664055463  E_coul = 54.066297434263305
cycle= 4 E= -128.531829206291  delta_E= -1.96e-08  |g|= 6.35e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138061
diis-c [-8.06082779e-10  2.91043754e-04  4.30111763e-04 -1.95350817e-01
  1.19462966e+00]
  HOMO = -0.845470519668333  LUMO = 1.08746887091427
  mo_energy =
[-3.27691639e+01 -1.92715038e+00 -8.45470520e-01 -8.45470520e-01
 -8.45470520e-01  1.08746887e+00  1.08746887e+00  1.08746887e+00
  1.09801511e+00  5.67726645e+00  5.67726645e+00  5.67726645e+00
  6.64301656e+00  2.39882503e+01  2.39882503e+01  2.39882503e+01
  3.30976449e+01  1.18444931e+02  1.18444931e+02  1.18444931e+02
  1.36985440e+02  5.01247964e+02  1.86905970e+03  7.99887310e+03
  4.77667150e+04]
E1 = -182.59824425841785  E_coul = 54.06641505164669
cycle= 5 E= -128.531829206771  delta_E= -4.8e-10  |g|= 5.64e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59824425841785  E_coul = 54.06641505164669
  HOMO = -0.845467562126541  LUMO = 1.08747012102091
  mo_energy =
[-3.27691577e+01 -1.92714669e+00 -8.45467562e-01 -8.45467562e-01
 -8.45467562e-01  1.08747012e+00  1.08747012e+00  1.08747012e+00
  1.09801683e+00  5.67727006e+00  5.67727006e+00  5.67727006e+00
  6.64302038e+00  2.39882557e+01  2.39882557e+01  2.39882557e+01
  3.30976506e+01  1.18444937e+02  1.18444937e+02  1.18444937e+02
  1.36985446e+02  5.01247969e+02  1.86905971e+03  7.99887311e+03
  4.77667150e+04]
E1 = -182.5982305841003  E_coul = 54.06640137732726
Extra cycle  E= -128.531829206773  delta_E= -1.88e-12  |g|= 1.93e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272623e+02 2.35718973e+02
 7.65061880e+01 9.93894108e+00 2.70255920e+01 3.65286179e-01
 1.04069470e+00 2.62920908e+00 3.67669959e+00 1.24154020e+01
 5.45807309e+01 3.29694110e-01 1.14186640e+00]
E = -128.53182920677304
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438887        1
[INPUT] 0    0    [1    /1   ]  833.272622863        1
[INPUT] 0    0    [1    /1   ]  235.718972697        1
[INPUT] 0    0    [1    /1   ]  76.5061880089        1
[INPUT] 0    0    [1    /1   ]  9.93894107937        1
[INPUT] 0    0    [1    /1   ]  27.0255919602        1
[INPUT] 0    0    [1    /1   ]  0.365286179286       1
[INPUT] 0    0    [1    /1   ]  1.04069469829        1
[INPUT] 0    0    [1    /1   ]  2.62920907826        1
[INPUT] 1    0    [1    /1   ]  3.6766995874         1
[INPUT] 1    0    [1    /1   ]  12.4154020172        1
[INPUT] 1    0    [1    /1   ]  54.5807309444        1
[INPUT] 1    0    [1    /1   ]  0.329694109685       1
[INPUT] 1    0    [1    /1   ]  1.14186639958        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131556322, 1.0]], [0, [3661.4543888720273, 1.0]], [0, [833.2726228629894, 1.0]], [0, [235.71897269722928, 1.0]], [0, [76.50618800887706, 1.0]], [0, [9.93894107936713, 1.0]], [0, [27.02559196019468, 1.0]], [0, [0.36528617928584783, 1.0]], [0, [1.0406946982945857, 1.0]], [0, [2.6292090782612374, 1.0]], [1, [3.67669958739914, 1.0]], [1, [12.415402017200512, 1.0]], [1, [54.58073094437015, 1.0]], [1, [0.32969410968518725, 1.0]], [1, [1.141866399575791, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413156]
bas 1, expnt(s) = [3661.45438887]
bas 2, expnt(s) = [833.27262286]
bas 3, expnt(s) = [235.7189727]
bas 4, expnt(s) = [76.50618801]
bas 5, expnt(s) = [9.93894108]
bas 6, expnt(s) = [27.02559196]
bas 7, expnt(s) = [0.36528618]
bas 8, expnt(s) = [1.0406947]
bas 9, expnt(s) = [2.62920908]
bas 10, expnt(s) = [3.67669959]
bas 11, expnt(s) = [12.41540202]
bas 12, expnt(s) = [54.58073094]
bas 13, expnt(s) = [0.32969411]
bas 14, expnt(s) = [1.1418664]
CPU time:       240.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272623e+02 3.91836925e+02 2.35718973e+02 1.51988570e+02
 7.65061880e+01 6.53562984e+01 9.93894108e+00 1.41423021e+01
 2.70255920e+01 2.99465251e+01 3.65286179e-01 1.18710724e+00
 1.04069470e+00 2.60319997e+00 2.62920908e+00 5.21655591e+00
 3.67669959e+00 1.48527570e+01 1.24154020e+01 6.79884869e+01
 5.45807309e+01 4.32796337e+02 3.29694110e-01 7.28825195e-01
 1.14186640e+00 3.44352714e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99846519940506
cond(S) = 317.70041200194487
E1 = -183.57712936713418  E_coul = 55.078449770986076
init E= -128.498679596148
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773948746566665  LUMO = 1.11313538533993
  mo_energy =
[-3.25552478e+01 -1.85281178e+00 -7.73948747e-01 -7.73948747e-01
 -7.73948747e-01  1.11313539e+00  1.11313539e+00  1.11313539e+00
  1.12488007e+00  5.76432685e+00  5.76432685e+00  5.76432685e+00
  6.72521973e+00  2.41457801e+01  2.41457801e+01  2.41457801e+01
  3.32593209e+01  1.18660964e+02  1.18660964e+02  1.18660964e+02
  1.37196215e+02  5.01492066e+02  1.86933466e+03  7.99917470e+03
  4.77670346e+04]
E1 = -182.1112579250453  E_coul = 53.582777667948164
cycle= 1 E= -128.528480257097  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450532
diis-c [-0.20297948  1.        ]
  HOMO = -0.879545225331113  LUMO = 1.07507439666558
  mo_energy =
[-3.28736666e+01 -1.96306833e+00 -8.79545225e-01 -8.79545225e-01
 -8.79545225e-01  1.07507440e+00  1.07507440e+00  1.07507440e+00
  1.08526745e+00  5.63566487e+00  5.63566487e+00  5.63566487e+00
  6.60369996e+00  2.39111735e+01  2.39111735e+01  2.39111735e+01
  3.30181444e+01  1.18340458e+02  1.18340458e+02  1.18340458e+02
  1.36882799e+02  5.01134904e+02  1.86894161e+03  7.99875269e+03
  4.77665937e+04]
E1 = -182.84285366877688  E_coul = 54.31187050658169
cycle= 2 E= -128.530983162195  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224715
diis-c [-5.97381142e-04  3.31796179e-01  6.68203821e-01]
  HOMO = -0.845197970920198  LUMO = 1.08753239646596
  mo_energy =
[-3.27686725e+01 -1.92694906e+00 -8.45197971e-01 -8.45197971e-01
 -8.45197971e-01  1.08753240e+00  1.08753240e+00  1.08753240e+00
  1.09808001e+00  5.67751552e+00  5.67751552e+00  5.67751552e+00
  6.64324233e+00  2.39886406e+01  2.39886406e+01  2.39886406e+01
  3.30980324e+01  1.18445434e+02  1.18445434e+02  1.18445434e+02
  1.36985930e+02  5.01248565e+02  1.86906042e+03  7.99887391e+03
  4.77667159e+04]
E1 = -182.5975346871536  E_coul = 54.065705500461306
cycle= 3 E= -128.531829186692  delta_E= -0.000846  |g|= 0.000482  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000995041
diis-c [-1.01799265e-07 -2.16605498e-03 -1.40787632e-04  1.00230684e+00]
  HOMO = -0.845438844093344  LUMO = 1.08748168317945
  mo_energy =
[-3.27691087e+01 -1.92712973e+00 -8.45438844e-01 -8.45438844e-01
 -8.45438844e-01  1.08748168e+00  1.08748168e+00  1.08748168e+00
  1.09802467e+00  5.67730205e+00  5.67730205e+00  5.67730205e+00
  6.64304679e+00  2.39882989e+01  2.39882989e+01  2.39882989e+01
  3.30976928e+01  1.18444987e+02  1.18444987e+02  1.18444987e+02
  1.36985496e+02  5.01248027e+02  1.86905977e+03  7.99887318e+03
  4.77667151e+04]
E1 = -182.59812664055463  E_coul = 54.066297434263305
cycle= 4 E= -128.531829206291  delta_E= -1.96e-08  |g|= 6.35e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138061
diis-c [-8.06082779e-10  2.91043754e-04  4.30111763e-04 -1.95350817e-01
  1.19462966e+00]
  HOMO = -0.845470519668333  LUMO = 1.08746887091427
  mo_energy =
[-3.27691639e+01 -1.92715038e+00 -8.45470520e-01 -8.45470520e-01
 -8.45470520e-01  1.08746887e+00  1.08746887e+00  1.08746887e+00
  1.09801511e+00  5.67726645e+00  5.67726645e+00  5.67726645e+00
  6.64301656e+00  2.39882503e+01  2.39882503e+01  2.39882503e+01
  3.30976449e+01  1.18444931e+02  1.18444931e+02  1.18444931e+02
  1.36985440e+02  5.01247964e+02  1.86905970e+03  7.99887310e+03
  4.77667150e+04]
E1 = -182.59824425841785  E_coul = 54.06641505164669
cycle= 5 E= -128.531829206771  delta_E= -4.8e-10  |g|= 5.64e-06  |ddm|= 3.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59824425841785  E_coul = 54.06641505164669
  HOMO = -0.845467562126541  LUMO = 1.08747012102091
  mo_energy =
[-3.27691577e+01 -1.92714669e+00 -8.45467562e-01 -8.45467562e-01
 -8.45467562e-01  1.08747012e+00  1.08747012e+00  1.08747012e+00
  1.09801683e+00  5.67727006e+00  5.67727006e+00  5.67727006e+00
  6.64302038e+00  2.39882557e+01  2.39882557e+01  2.39882557e+01
  3.30976506e+01  1.18444937e+02  1.18444937e+02  1.18444937e+02
  1.36985446e+02  5.01247969e+02  1.86905971e+03  7.99887311e+03
  4.77667150e+04]
E1 = -182.5982305841003  E_coul = 54.06640137732726
Extra cycle  E= -128.531829206773  delta_E= -1.88e-12  |g|= 1.93e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 317.70041200194487
E1 = -182.5982305841003  E_coul = 54.06640137732726
init E= -128.531829206773
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845468523105351  LUMO = 1.08746978764525
  mo_energy =
[-3.27691608e+01 -1.92714758e+00 -8.45468523e-01 -8.45468523e-01
 -8.45468523e-01  1.08746979e+00  1.08746979e+00  1.08746979e+00
  1.09801656e+00  5.67726889e+00  5.67726889e+00  5.67726889e+00
  6.64301935e+00  2.39882535e+01  2.39882535e+01  2.39882535e+01
  3.30976483e+01  1.18444934e+02  1.18444934e+02  1.18444934e+02
  1.36985443e+02  5.01247966e+02  1.86905970e+03  7.99887310e+03
  4.77667150e+04]
E1 = -182.59823800429413  E_coul = 54.06640879752088
cycle= 1 E= -128.531829206773  delta_E= -1.99e-13  |g|= 1.02e-06  |ddm|= 7.49e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59823800429413  E_coul = 54.06640879752088
  HOMO = -0.845468002973597  LUMO = 1.08746997864077
  mo_energy =
[-3.27691592e+01 -1.92714700e+00 -8.45468003e-01 -8.45468003e-01
 -8.45468003e-01  1.08746998e+00  1.08746998e+00  1.08746998e+00
  1.09801677e+00  5.67726953e+00  5.67726953e+00  5.67726953e+00
  6.64301997e+00  2.39882547e+01  2.39882547e+01  2.39882547e+01
  3.30976495e+01  1.18444936e+02  1.18444936e+02  1.18444936e+02
  1.36985445e+02  5.01247968e+02  1.86905970e+03  7.99887311e+03
  4.77667150e+04]
E1 = -182.5982343250425  E_coul = 54.066405118269124
Extra cycle  E= -128.531829206773  delta_E= -1.42e-13  |g|= 5e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272623e+02 2.35718973e+02
 7.65061880e+01 9.93894108e+00 2.70255920e+01 3.65286179e-01
 1.04069470e+00 2.62920908e+00 3.67669959e+00 1.24154020e+01
 5.45807309e+01 3.29694110e-01 1.14186640e+00]
grad_E = [ 1.57597159e-10 -7.99353266e-09  1.45360478e-07 -1.05996855e-06
 -2.33148746e-06 -4.54582320e-05  6.79763642e-05 -5.66840564e-05
 -1.38344164e-04 -2.07169039e-04  9.05067470e-06 -3.53659323e-06
 -2.16540749e-06 -3.05729328e-04  2.84728983e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438876        1
[INPUT] 0    0    [1    /1   ]  833.272625477        1
[INPUT] 0    0    [1    /1   ]  235.718920857        1
[INPUT] 0    0    [1    /1   ]  76.5069029586        1
[INPUT] 0    0    [1    /1   ]  9.94688348143        1
[INPUT] 0    0    [1    /1   ]  27.0203970681        1
[INPUT] 0    0    [1    /1   ]  0.365956121019       1
[INPUT] 0    0    [1    /1   ]  1.04335337525        1
[INPUT] 0    0    [1    /1   ]  2.63332111652        1
[INPUT] 1    0    [1    /1   ]  3.67611053208        1
[INPUT] 1    0    [1    /1   ]  12.4134304328        1
[INPUT] 1    0    [1    /1   ]  54.5746261778        1
[INPUT] 1    0    [1    /1   ]  0.329608986268       1
[INPUT] 1    0    [1    /1   ]  1.14164605982        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131558214, 1.0]], [0, [3661.454388763542, 1.0]], [0, [833.2726254774502, 1.0]], [0, [235.7189208566322, 1.0]], [0, [76.50690295860396, 1.0]], [0, [9.946883481432806, 1.0]], [0, [27.02039706813907, 1.0]], [0, [0.36595612101874486, 1.0]], [0, [1.0433533752543116, 1.0]], [0, [2.6333211165225037, 1.0]], [1, [3.6761105320759664, 1.0]], [1, [12.413430432827566, 1.0]], [1, [54.57462617778715, 1.0]], [1, [0.32960898626818697, 1.0]], [1, [1.1416460598203415, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413156]
bas 1, expnt(s) = [3661.45438876]
bas 2, expnt(s) = [833.27262548]
bas 3, expnt(s) = [235.71892086]
bas 4, expnt(s) = [76.50690296]
bas 5, expnt(s) = [9.94688348]
bas 6, expnt(s) = [27.02039707]
bas 7, expnt(s) = [0.36595612]
bas 8, expnt(s) = [1.04335338]
bas 9, expnt(s) = [2.63332112]
bas 10, expnt(s) = [3.67611053]
bas 11, expnt(s) = [12.41343043]
bas 12, expnt(s) = [54.57462618]
bas 13, expnt(s) = [0.32960899]
bas 14, expnt(s) = [1.14164606]
CPU time:       243.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272625e+02 3.91836926e+02 2.35718921e+02 1.51988545e+02
 7.65069030e+01 6.53567564e+01 9.94688348e+00 1.41507773e+01
 2.70203971e+01 2.99422077e+01 3.65956121e-01 1.18873975e+00
 1.04335338e+00 2.60818620e+00 2.63332112e+00 5.22267367e+00
 3.67611053e+00 1.48497825e+01 1.24134304e+01 6.79749913e+01
 5.45746262e+01 4.32735829e+02 3.29608986e-01 7.28589985e-01
 1.14164606e+00 3.44269656e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998466219262905
cond(S) = 318.57501517840757
E1 = -183.57709062859976  E_coul = 55.078444484088955
init E= -128.498646144511
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773949110901276  LUMO = 1.11280539937021
  mo_energy =
[-3.25552505e+01 -1.85281160e+00 -7.73949111e-01 -7.73949111e-01
 -7.73949111e-01  1.11280540e+00  1.11280540e+00  1.11280540e+00
  1.12820204e+00  5.76304093e+00  5.76304093e+00  5.76304093e+00
  6.74260434e+00  2.41410213e+01  2.41410213e+01  2.41410213e+01
  3.33011260e+01  1.18642899e+02  1.18642899e+02  1.18642899e+02
  1.37242666e+02  5.01532219e+02  1.86937003e+03  7.99920571e+03
  4.77670602e+04]
E1 = -182.11111101980353  E_coul = 53.58262963875433
cycle= 1 E= -128.528481381049  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450535
diis-c [-0.20298165  1.        ]
  HOMO = -0.879557402972966  LUMO = 1.07475074952497
  mo_energy =
[-3.28736888e+01 -1.96308458e+00 -8.79557403e-01 -8.79557403e-01
 -8.79557403e-01  1.07475075e+00  1.07475075e+00  1.07475075e+00
  1.08846867e+00  5.63437980e+00  5.63437980e+00  5.63437980e+00
  6.62090845e+00  2.39064103e+01  2.39064103e+01  2.39064103e+01
  3.30599010e+01  1.18322382e+02  1.18322382e+02  1.18322382e+02
  1.36929240e+02  5.01175044e+02  1.86897697e+03  7.99878369e+03
  4.77666194e+04]
E1 = -182.8427752178687  E_coul = 54.31179066939611
cycle= 2 E= -128.530984548473  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224731
diis-c [-5.97656751e-04  3.31810432e-01  6.68189568e-01]
  HOMO = -0.845207591008474  LUMO = 1.08720604500186
  mo_energy =
[-3.27686876e+01 -1.92696239e+00 -8.45207591e-01 -8.45207591e-01
 -8.45207591e-01  1.08720605e+00  1.08720605e+00  1.08720605e+00
  1.10131849e+00  5.67622884e+00  5.67622884e+00  5.67622884e+00
  6.66050673e+00  2.39838789e+01  2.39838789e+01  2.39838789e+01
  3.31398055e+01  1.18427364e+02  1.18427364e+02  1.18427364e+02
  1.37032376e+02  5.01288713e+02  1.86909579e+03  7.99890492e+03
  4.77667415e+04]
E1 = -182.59742768031057  E_coul = 54.06559692657174
cycle= 3 E= -128.531830753739  delta_E= -0.000846  |g|= 0.000482  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992685
diis-c [-1.00977562e-07 -2.16546780e-03 -1.48857834e-04  1.00231433e+00]
  HOMO = -0.84544829388494  LUMO = 1.08715540932419
  mo_energy =
[-3.27691231e+01 -1.92714312e+00 -8.45448294e-01 -8.45448294e-01
 -8.45448294e-01  1.08715541e+00  1.08715541e+00  1.08715541e+00
  1.10126291e+00  5.67601559e+00  5.67601559e+00  5.67601559e+00
  6.66031100e+00  2.39835376e+01  2.39835376e+01  2.39835376e+01
  3.31394662e+01  1.18426917e+02  1.18426917e+02  1.18426917e+02
  1.37031942e+02  5.01288175e+02  1.86909514e+03  7.99890418e+03
  4.77667407e+04]
E1 = -182.5980179717216  E_coul = 54.06618719847927
cycle= 4 E= -128.531830773242  delta_E= -1.95e-08  |g|= 6.34e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000137713
diis-c [-8.03716028e-10  2.90051807e-04  4.30612806e-04 -1.94803617e-01
  1.19408295e+00]
  HOMO = -0.845479919640692  LUMO = 1.08714261825743
  mo_energy =
[-3.27691782e+01 -1.92716379e+00 -8.45479920e-01 -8.45479920e-01
 -8.45479920e-01  1.08714262e+00  1.08714262e+00  1.08714262e+00
  1.10125331e+00  5.67598004e+00  5.67598004e+00  5.67598004e+00
  6.66028076e+00  2.39834891e+01  2.39834891e+01  2.39834891e+01
  3.31394184e+01  1.18426861e+02  1.18426861e+02  1.18426861e+02
  1.37031887e+02  5.01288113e+02  1.86909507e+03  7.99890411e+03
  4.77667407e+04]
E1 = -182.59813536300194  E_coul = 54.06630458928297
cycle= 5 E= -128.531830773719  delta_E= -4.77e-10  |g|= 5.62e-06  |ddm|= 3.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59813536300194  E_coul = 54.06630458928297
  HOMO = -0.845476976806118  LUMO = 1.08714386217535
  mo_energy =
[-3.27691721e+01 -1.92716011e+00 -8.45476977e-01 -8.45476977e-01
 -8.45476977e-01  1.08714386e+00  1.08714386e+00  1.08714386e+00
  1.10125503e+00  5.67598363e+00  5.67598363e+00  5.67598363e+00
  6.66028457e+00  2.39834945e+01  2.39834945e+01  2.39834945e+01
  3.31394240e+01  1.18426867e+02  1.18426867e+02  1.18426867e+02
  1.37031893e+02  5.01288118e+02  1.86909507e+03  7.99890411e+03
  4.77667407e+04]
E1 = -182.59812176286164  E_coul = 54.06629098914074
Extra cycle  E= -128.531830773721  delta_E= -1.93e-12  |g|= 1.92e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272625e+02 2.35718921e+02
 7.65069030e+01 9.94688348e+00 2.70203971e+01 3.65956121e-01
 1.04335338e+00 2.63332112e+00 3.67611053e+00 1.24134304e+01
 5.45746262e+01 3.29608986e-01 1.14164606e+00]
E = -128.5318307737209
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438876        1
[INPUT] 0    0    [1    /1   ]  833.272625477        1
[INPUT] 0    0    [1    /1   ]  235.718920857        1
[INPUT] 0    0    [1    /1   ]  76.5069029586        1
[INPUT] 0    0    [1    /1   ]  9.94688348143        1
[INPUT] 0    0    [1    /1   ]  27.0203970681        1
[INPUT] 0    0    [1    /1   ]  0.365956121019       1
[INPUT] 0    0    [1    /1   ]  1.04335337525        1
[INPUT] 0    0    [1    /1   ]  2.63332111652        1
[INPUT] 1    0    [1    /1   ]  3.67611053208        1
[INPUT] 1    0    [1    /1   ]  12.4134304328        1
[INPUT] 1    0    [1    /1   ]  54.5746261778        1
[INPUT] 1    0    [1    /1   ]  0.329608986268       1
[INPUT] 1    0    [1    /1   ]  1.14164605982        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131558214, 1.0]], [0, [3661.454388763542, 1.0]], [0, [833.2726254774502, 1.0]], [0, [235.7189208566322, 1.0]], [0, [76.50690295860396, 1.0]], [0, [9.946883481432806, 1.0]], [0, [27.02039706813907, 1.0]], [0, [0.36595612101874486, 1.0]], [0, [1.0433533752543116, 1.0]], [0, [2.6333211165225037, 1.0]], [1, [3.6761105320759664, 1.0]], [1, [12.413430432827566, 1.0]], [1, [54.57462617778715, 1.0]], [1, [0.32960898626818697, 1.0]], [1, [1.1416460598203415, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413156]
bas 1, expnt(s) = [3661.45438876]
bas 2, expnt(s) = [833.27262548]
bas 3, expnt(s) = [235.71892086]
bas 4, expnt(s) = [76.50690296]
bas 5, expnt(s) = [9.94688348]
bas 6, expnt(s) = [27.02039707]
bas 7, expnt(s) = [0.36595612]
bas 8, expnt(s) = [1.04335338]
bas 9, expnt(s) = [2.63332112]
bas 10, expnt(s) = [3.67611053]
bas 11, expnt(s) = [12.41343043]
bas 12, expnt(s) = [54.57462618]
bas 13, expnt(s) = [0.32960899]
bas 14, expnt(s) = [1.14164606]
CPU time:       244.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272625e+02 3.91836926e+02 2.35718921e+02 1.51988545e+02
 7.65069030e+01 6.53567564e+01 9.94688348e+00 1.41507773e+01
 2.70203971e+01 2.99422077e+01 3.65956121e-01 1.18873975e+00
 1.04335338e+00 2.60818620e+00 2.63332112e+00 5.22267367e+00
 3.67611053e+00 1.48497825e+01 1.24134304e+01 6.79749913e+01
 5.45746262e+01 4.32735829e+02 3.29608986e-01 7.28589985e-01
 1.14164606e+00 3.44269656e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998466219262905
cond(S) = 318.57501517840757
E1 = -183.57709062859976  E_coul = 55.078444484088955
init E= -128.498646144511
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949110901276  LUMO = 1.11280539937021
  mo_energy =
[-3.25552505e+01 -1.85281160e+00 -7.73949111e-01 -7.73949111e-01
 -7.73949111e-01  1.11280540e+00  1.11280540e+00  1.11280540e+00
  1.12820204e+00  5.76304093e+00  5.76304093e+00  5.76304093e+00
  6.74260434e+00  2.41410213e+01  2.41410213e+01  2.41410213e+01
  3.33011260e+01  1.18642899e+02  1.18642899e+02  1.18642899e+02
  1.37242666e+02  5.01532219e+02  1.86937003e+03  7.99920571e+03
  4.77670602e+04]
E1 = -182.11111101980353  E_coul = 53.58262963875433
cycle= 1 E= -128.528481381049  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450535
diis-c [-0.20298165  1.        ]
  HOMO = -0.879557402972966  LUMO = 1.07475074952497
  mo_energy =
[-3.28736888e+01 -1.96308458e+00 -8.79557403e-01 -8.79557403e-01
 -8.79557403e-01  1.07475075e+00  1.07475075e+00  1.07475075e+00
  1.08846867e+00  5.63437980e+00  5.63437980e+00  5.63437980e+00
  6.62090845e+00  2.39064103e+01  2.39064103e+01  2.39064103e+01
  3.30599010e+01  1.18322382e+02  1.18322382e+02  1.18322382e+02
  1.36929240e+02  5.01175044e+02  1.86897697e+03  7.99878369e+03
  4.77666194e+04]
E1 = -182.8427752178687  E_coul = 54.31179066939611
cycle= 2 E= -128.530984548473  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224731
diis-c [-5.97656751e-04  3.31810432e-01  6.68189568e-01]
  HOMO = -0.845207591008474  LUMO = 1.08720604500186
  mo_energy =
[-3.27686876e+01 -1.92696239e+00 -8.45207591e-01 -8.45207591e-01
 -8.45207591e-01  1.08720605e+00  1.08720605e+00  1.08720605e+00
  1.10131849e+00  5.67622884e+00  5.67622884e+00  5.67622884e+00
  6.66050673e+00  2.39838789e+01  2.39838789e+01  2.39838789e+01
  3.31398055e+01  1.18427364e+02  1.18427364e+02  1.18427364e+02
  1.37032376e+02  5.01288713e+02  1.86909579e+03  7.99890492e+03
  4.77667415e+04]
E1 = -182.59742768031057  E_coul = 54.06559692657174
cycle= 3 E= -128.531830753739  delta_E= -0.000846  |g|= 0.000482  |ddm|= 0.0241
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992685
diis-c [-1.00977562e-07 -2.16546780e-03 -1.48857834e-04  1.00231433e+00]
  HOMO = -0.84544829388494  LUMO = 1.08715540932419
  mo_energy =
[-3.27691231e+01 -1.92714312e+00 -8.45448294e-01 -8.45448294e-01
 -8.45448294e-01  1.08715541e+00  1.08715541e+00  1.08715541e+00
  1.10126291e+00  5.67601559e+00  5.67601559e+00  5.67601559e+00
  6.66031100e+00  2.39835376e+01  2.39835376e+01  2.39835376e+01
  3.31394662e+01  1.18426917e+02  1.18426917e+02  1.18426917e+02
  1.37031942e+02  5.01288175e+02  1.86909514e+03  7.99890418e+03
  4.77667407e+04]
E1 = -182.5980179717216  E_coul = 54.06618719847927
cycle= 4 E= -128.531830773242  delta_E= -1.95e-08  |g|= 6.34e-05  |ddm|= 0.00023
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000137713
diis-c [-8.03716028e-10  2.90051807e-04  4.30612806e-04 -1.94803617e-01
  1.19408295e+00]
  HOMO = -0.845479919640692  LUMO = 1.08714261825743
  mo_energy =
[-3.27691782e+01 -1.92716379e+00 -8.45479920e-01 -8.45479920e-01
 -8.45479920e-01  1.08714262e+00  1.08714262e+00  1.08714262e+00
  1.10125331e+00  5.67598004e+00  5.67598004e+00  5.67598004e+00
  6.66028076e+00  2.39834891e+01  2.39834891e+01  2.39834891e+01
  3.31394184e+01  1.18426861e+02  1.18426861e+02  1.18426861e+02
  1.37031887e+02  5.01288113e+02  1.86909507e+03  7.99890411e+03
  4.77667407e+04]
E1 = -182.59813536300194  E_coul = 54.06630458928297
cycle= 5 E= -128.531830773719  delta_E= -4.77e-10  |g|= 5.62e-06  |ddm|= 3.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59813536300194  E_coul = 54.06630458928297
  HOMO = -0.845476976806118  LUMO = 1.08714386217535
  mo_energy =
[-3.27691721e+01 -1.92716011e+00 -8.45476977e-01 -8.45476977e-01
 -8.45476977e-01  1.08714386e+00  1.08714386e+00  1.08714386e+00
  1.10125503e+00  5.67598363e+00  5.67598363e+00  5.67598363e+00
  6.66028457e+00  2.39834945e+01  2.39834945e+01  2.39834945e+01
  3.31394240e+01  1.18426867e+02  1.18426867e+02  1.18426867e+02
  1.37031893e+02  5.01288118e+02  1.86909507e+03  7.99890411e+03
  4.77667407e+04]
E1 = -182.59812176286164  E_coul = 54.06629098914074
Extra cycle  E= -128.531830773721  delta_E= -1.93e-12  |g|= 1.92e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 318.57501517840757
E1 = -182.59812176286164  E_coul = 54.06629098914074
init E= -128.531830773721
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845477932708513  LUMO = 1.08714353070945
  mo_energy =
[-3.27691751e+01 -1.92716099e+00 -8.45477933e-01 -8.45477933e-01
 -8.45477933e-01  1.08714353e+00  1.08714353e+00  1.08714353e+00
  1.10125476e+00  5.67598247e+00  5.67598247e+00  5.67598247e+00
  6.66028355e+00  2.39834923e+01  2.39834923e+01  2.39834923e+01
  3.31394218e+01  1.18426864e+02  1.18426864e+02  1.18426864e+02
  1.37031890e+02  5.01288115e+02  1.86909507e+03  7.99890411e+03
  4.77667407e+04]
E1 = -182.59812914443967  E_coul = 54.066298370718314
cycle= 1 E= -128.531830773721  delta_E= -4.55e-13  |g|= 1.02e-06  |ddm|= 7.45e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59812914443967  E_coul = 54.066298370718314
  HOMO = -0.845477415313796  LUMO = 1.08714372065543
  mo_energy =
[-3.27691735e+01 -1.92716042e+00 -8.45477415e-01 -8.45477415e-01
 -8.45477415e-01  1.08714372e+00  1.08714372e+00  1.08714372e+00
  1.10125497e+00  5.67598311e+00  5.67598311e+00  5.67598311e+00
  6.66028416e+00  2.39834935e+01  2.39834935e+01  2.39834935e+01
  3.31394230e+01  1.18426866e+02  1.18426866e+02  1.18426866e+02
  1.37031891e+02  5.01288116e+02  1.86909507e+03  7.99890411e+03
  4.77667407e+04]
E1 = -182.59812548440541  E_coul = 54.06629471068385
Extra cycle  E= -128.531830773722  delta_E= -1.99e-13  |g|= 4.98e-07  |ddm|= 3.71e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272625e+02 2.35718921e+02
 7.65069030e+01 9.94688348e+00 2.70203971e+01 3.65956121e-01
 1.04335338e+00 2.63332112e+00 3.67611053e+00 1.24134304e+01
 5.45746262e+01 3.29608986e-01 1.14164606e+00]
grad_E = [ 2.54047165e-10 -1.30492103e-08  2.46565162e-07 -2.24198787e-06
  6.43369468e-06  2.34734067e-05  2.98451281e-05 -9.51002125e-05
 -1.08262344e-04 -2.25281541e-04  9.61139604e-06 -4.92046153e-06
 -2.00665035e-06 -4.93603764e-04  5.78252921e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438886        1
[INPUT] 0    0    [1    /1   ]  833.272624763        1
[INPUT] 0    0    [1    /1   ]  235.718873581        1
[INPUT] 0    0    [1    /1   ]  76.5081306081        1
[INPUT] 0    0    [1    /1   ]  9.9603367512         1
[INPUT] 0    0    [1    /1   ]  27.0098592052        1
[INPUT] 0    0    [1    /1   ]  0.367653160486       1
[INPUT] 0    0    [1    /1   ]  1.05071612948        1
[INPUT] 0    0    [1    /1   ]  2.65058240864        1
[INPUT] 1    0    [1    /1   ]  3.67596898504        1
[INPUT] 1    0    [1    /1   ]  12.4135934257        1
[INPUT] 1    0    [1    /1   ]  54.589976092         1
[INPUT] 1    0    [1    /1   ]  0.3295348625         1
[INPUT] 1    0    [1    /1   ]  1.14152815191        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131555893, 1.0]], [0, [3661.4543888605376, 1.0]], [0, [833.2726247632717, 1.0]], [0, [235.71887358121387, 1.0]], [0, [76.50813060811775, 1.0]], [0, [9.960336751204933, 1.0]], [0, [27.00985920521926, 1.0]], [0, [0.3676531604855422, 1.0]], [0, [1.0507161294818088, 1.0]], [0, [2.650582408643334, 1.0]], [1, [3.675968985042118, 1.0]], [1, [12.413593425707724, 1.0]], [1, [54.58997609199645, 1.0]], [1, [0.32953486250001035, 1.0]], [1, [1.1415281519146696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413156]
bas 1, expnt(s) = [3661.45438886]
bas 2, expnt(s) = [833.27262476]
bas 3, expnt(s) = [235.71887358]
bas 4, expnt(s) = [76.50813061]
bas 5, expnt(s) = [9.96033675]
bas 6, expnt(s) = [27.00985921]
bas 7, expnt(s) = [0.36765316]
bas 8, expnt(s) = [1.05071613]
bas 9, expnt(s) = [2.65058241]
bas 10, expnt(s) = [3.67596899]
bas 11, expnt(s) = [12.41359343]
bas 12, expnt(s) = [54.58997609]
bas 13, expnt(s) = [0.32953486]
bas 14, expnt(s) = [1.14152815]
CPU time:       248.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272625e+02 3.91836925e+02 2.35718874e+02 1.51988522e+02
 7.65081306e+01 6.53575430e+01 9.96033675e+00 1.41651292e+01
 2.70098592e+01 2.99334493e+01 3.67653160e-01 1.19287175e+00
 1.05071613e+00 2.62197818e+00 2.65058241e+00 5.24832847e+00
 3.67596899e+00 1.48490678e+01 1.24135934e+01 6.79761070e+01
 5.45899761e+01 4.32887976e+02 3.29534863e-01 7.28385180e-01
 1.14152815e+00 3.44225212e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998465726996102
cond(S) = 320.91273400665904
E1 = -183.57703544314194  E_coul = 55.07843727728882
init E= -128.498598165853
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773949529553227  LUMO = 1.11254202213879
  mo_energy =
[-3.25552568e+01 -1.85280950e+00 -7.73949530e-01 -7.73949530e-01
 -7.73949530e-01  1.11254202e+00  1.11254202e+00  1.11254202e+00
  1.13723352e+00  5.76236784e+00  5.76236784e+00  5.76236784e+00
  6.79710952e+00  2.41400797e+01  2.41400797e+01  2.41400797e+01
  3.34248777e+01  1.18666153e+02  1.18666153e+02  1.18666153e+02
  1.37372201e+02  5.01643878e+02  1.86946835e+03  7.99929189e+03
  4.77671315e+04]
E1 = -182.11100934851405  E_coul = 53.582524363600236
cycle= 1 E= -128.528484984914  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450505
diis-c [-0.20295458  1.        ]
  HOMO = -0.879566219509912  LUMO = 1.074492699441
  mo_energy =
[-3.28737036e+01 -1.96309794e+00 -8.79566220e-01 -8.79566220e-01
 -8.79566220e-01  1.07449270e+00  1.07449270e+00  1.07449270e+00
  1.09717313e+00  5.63370029e+00  5.63370029e+00  5.63370029e+00
  6.67486346e+00  2.39054590e+01  2.39054590e+01  2.39054590e+01
  3.31835692e+01  1.18345617e+02  1.18345617e+02  1.18345617e+02
  1.37058790e+02  5.01286706e+02  1.86907530e+03  7.99886987e+03
  4.77666906e+04]
E1 = -182.84270961608885  E_coul = 54.31172138170395
cycle= 2 E= -128.530988234385  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224733
diis-c [-5.98314210e-04  3.31826307e-01  6.68173693e-01]
  HOMO = -0.845215623898327  LUMO = 1.08694577173838
  mo_energy =
[-3.27686997e+01 -1.92697451e+00 -8.45215624e-01 -8.45215624e-01
 -8.45215624e-01  1.08694577e+00  1.08694577e+00  1.08694577e+00
  1.11012632e+00  5.67554940e+00  5.67554940e+00  5.67554940e+00
  6.71464020e+00  2.39829304e+01  2.39829304e+01  2.39829304e+01
  3.32635010e+01  1.18450606e+02  1.18450606e+02  1.18450606e+02
  1.37161922e+02  5.01400375e+02  1.86919412e+03  7.99899110e+03
  4.77668128e+04]
E1 = -182.59734803661675  E_coul = 54.06551348968614
cycle= 3 E= -128.531834546931  delta_E= -0.000846  |g|= 0.00048  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000988749
diis-c [-9.95471861e-08 -2.16390667e-03 -1.60691562e-04  1.00232460e+00]
  HOMO = -0.845455835543942  LUMO = 1.08689535970068
  mo_energy =
[-3.27691339e+01 -1.92715511e+00 -8.45455836e-01 -8.45455836e-01
 -8.45455836e-01  1.08689536e+00  1.08689536e+00  1.08689536e+00
  1.11007032e+00  5.67533668e+00  5.67533668e+00  5.67533668e+00
  6.71444400e+00  2.39825902e+01  2.39825902e+01  2.39825902e+01
  3.32631625e+01  1.18450160e+02  1.18450160e+02  1.18450160e+02
  1.37161490e+02  5.01399840e+02  1.86919347e+03  7.99899037e+03
  4.77668120e+04]
E1 = -182.59793593840755  E_coul = 54.06610137216511
cycle= 4 E= -128.531834566242  delta_E= -1.93e-08  |g|= 6.31e-05  |ddm|= 0.000228
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000137115
diis-c [-7.99569583e-10  2.88590446e-04  4.31434052e-04 -1.93962440e-01
  1.19324242e+00]
  HOMO = -0.845487338892805  LUMO = 1.0868826220676
  mo_energy =
[-3.27691888e+01 -1.92717576e+00 -8.45487339e-01 -8.45487339e-01
 -8.45487339e-01  1.08688262e+00  1.08688262e+00  1.08688262e+00
  1.11006065e+00  5.67530125e+00  5.67530125e+00  5.67530125e+00
  6.71441372e+00  2.39825418e+01  2.39825418e+01  2.39825418e+01
  3.32631148e+01  1.18450105e+02  1.18450105e+02  1.18450105e+02
  1.37161434e+02  5.01399777e+02  1.86919340e+03  7.99899029e+03
  4.77668119e+04]
E1 = -182.5980529986086  E_coul = 54.06621843189619
cycle= 5 E= -128.531834566712  delta_E= -4.7e-10  |g|= 5.58e-06  |ddm|= 3.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5980529986086  E_coul = 54.06621843189619
  HOMO = -0.845484418517905  LUMO = 1.08688385655403
  mo_energy =
[-3.27691827e+01 -1.92717211e+00 -8.45484419e-01 -8.45484419e-01
 -8.45484419e-01  1.08688386e+00  1.08688386e+00  1.08688386e+00
  1.11006237e+00  5.67530481e+00  5.67530481e+00  5.67530481e+00
  6.71441752e+00  2.39825472e+01  2.39825472e+01  2.39825472e+01
  3.32631204e+01  1.18450111e+02  1.18450111e+02  1.18450111e+02
  1.37161440e+02  5.01399783e+02  1.86919340e+03  7.99899030e+03
  4.77668119e+04]
E1 = -182.59803950621193  E_coul = 54.06620493949748
Extra cycle  E= -128.531834566714  delta_E= -2.05e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272625e+02 2.35718874e+02
 7.65081306e+01 9.96033675e+00 2.70098592e+01 3.67653160e-01
 1.05071613e+00 2.65058241e+00 3.67596899e+00 1.24135934e+01
 5.45899761e+01 3.29534863e-01 1.14152815e+00]
E = -128.53183456671445
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941316        1
[INPUT] 0    0    [1    /1   ]  3661.45438886        1
[INPUT] 0    0    [1    /1   ]  833.272624763        1
[INPUT] 0    0    [1    /1   ]  235.718873581        1
[INPUT] 0    0    [1    /1   ]  76.5081306081        1
[INPUT] 0    0    [1    /1   ]  9.9603367512         1
[INPUT] 0    0    [1    /1   ]  27.0098592052        1
[INPUT] 0    0    [1    /1   ]  0.367653160486       1
[INPUT] 0    0    [1    /1   ]  1.05071612948        1
[INPUT] 0    0    [1    /1   ]  2.65058240864        1
[INPUT] 1    0    [1    /1   ]  3.67596898504        1
[INPUT] 1    0    [1    /1   ]  12.4135934257        1
[INPUT] 1    0    [1    /1   ]  54.589976092         1
[INPUT] 1    0    [1    /1   ]  0.3295348625         1
[INPUT] 1    0    [1    /1   ]  1.14152815191        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131555893, 1.0]], [0, [3661.4543888605376, 1.0]], [0, [833.2726247632717, 1.0]], [0, [235.71887358121387, 1.0]], [0, [76.50813060811775, 1.0]], [0, [9.960336751204933, 1.0]], [0, [27.00985920521926, 1.0]], [0, [0.3676531604855422, 1.0]], [0, [1.0507161294818088, 1.0]], [0, [2.650582408643334, 1.0]], [1, [3.675968985042118, 1.0]], [1, [12.413593425707724, 1.0]], [1, [54.58997609199645, 1.0]], [1, [0.32953486250001035, 1.0]], [1, [1.1415281519146696, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413156]
bas 1, expnt(s) = [3661.45438886]
bas 2, expnt(s) = [833.27262476]
bas 3, expnt(s) = [235.71887358]
bas 4, expnt(s) = [76.50813061]
bas 5, expnt(s) = [9.96033675]
bas 6, expnt(s) = [27.00985921]
bas 7, expnt(s) = [0.36765316]
bas 8, expnt(s) = [1.05071613]
bas 9, expnt(s) = [2.65058241]
bas 10, expnt(s) = [3.67596899]
bas 11, expnt(s) = [12.41359343]
bas 12, expnt(s) = [54.58997609]
bas 13, expnt(s) = [0.32953486]
bas 14, expnt(s) = [1.14152815]
CPU time:       248.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272625e+02 3.91836925e+02 2.35718874e+02 1.51988522e+02
 7.65081306e+01 6.53575430e+01 9.96033675e+00 1.41651292e+01
 2.70098592e+01 2.99334493e+01 3.67653160e-01 1.19287175e+00
 1.05071613e+00 2.62197818e+00 2.65058241e+00 5.24832847e+00
 3.67596899e+00 1.48490678e+01 1.24135934e+01 6.79761070e+01
 5.45899761e+01 4.32887976e+02 3.29534863e-01 7.28385180e-01
 1.14152815e+00 3.44225212e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998465726996102
cond(S) = 320.91273400665904
E1 = -183.57703544314194  E_coul = 55.07843727728882
init E= -128.498598165853
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949529553227  LUMO = 1.11254202213879
  mo_energy =
[-3.25552568e+01 -1.85280950e+00 -7.73949530e-01 -7.73949530e-01
 -7.73949530e-01  1.11254202e+00  1.11254202e+00  1.11254202e+00
  1.13723352e+00  5.76236784e+00  5.76236784e+00  5.76236784e+00
  6.79710952e+00  2.41400797e+01  2.41400797e+01  2.41400797e+01
  3.34248777e+01  1.18666153e+02  1.18666153e+02  1.18666153e+02
  1.37372201e+02  5.01643878e+02  1.86946835e+03  7.99929189e+03
  4.77671315e+04]
E1 = -182.11100934851405  E_coul = 53.582524363600236
cycle= 1 E= -128.528484984914  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450505
diis-c [-0.20295458  1.        ]
  HOMO = -0.879566219509912  LUMO = 1.074492699441
  mo_energy =
[-3.28737036e+01 -1.96309794e+00 -8.79566220e-01 -8.79566220e-01
 -8.79566220e-01  1.07449270e+00  1.07449270e+00  1.07449270e+00
  1.09717313e+00  5.63370029e+00  5.63370029e+00  5.63370029e+00
  6.67486346e+00  2.39054590e+01  2.39054590e+01  2.39054590e+01
  3.31835692e+01  1.18345617e+02  1.18345617e+02  1.18345617e+02
  1.37058790e+02  5.01286706e+02  1.86907530e+03  7.99886987e+03
  4.77666906e+04]
E1 = -182.84270961608885  E_coul = 54.31172138170395
cycle= 2 E= -128.530988234385  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224733
diis-c [-5.98314210e-04  3.31826307e-01  6.68173693e-01]
  HOMO = -0.845215623898327  LUMO = 1.08694577173838
  mo_energy =
[-3.27686997e+01 -1.92697451e+00 -8.45215624e-01 -8.45215624e-01
 -8.45215624e-01  1.08694577e+00  1.08694577e+00  1.08694577e+00
  1.11012632e+00  5.67554940e+00  5.67554940e+00  5.67554940e+00
  6.71464020e+00  2.39829304e+01  2.39829304e+01  2.39829304e+01
  3.32635010e+01  1.18450606e+02  1.18450606e+02  1.18450606e+02
  1.37161922e+02  5.01400375e+02  1.86919412e+03  7.99899110e+03
  4.77668128e+04]
E1 = -182.59734803661675  E_coul = 54.06551348968614
cycle= 3 E= -128.531834546931  delta_E= -0.000846  |g|= 0.00048  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000988749
diis-c [-9.95471861e-08 -2.16390667e-03 -1.60691562e-04  1.00232460e+00]
  HOMO = -0.845455835543942  LUMO = 1.08689535970068
  mo_energy =
[-3.27691339e+01 -1.92715511e+00 -8.45455836e-01 -8.45455836e-01
 -8.45455836e-01  1.08689536e+00  1.08689536e+00  1.08689536e+00
  1.11007032e+00  5.67533668e+00  5.67533668e+00  5.67533668e+00
  6.71444400e+00  2.39825902e+01  2.39825902e+01  2.39825902e+01
  3.32631625e+01  1.18450160e+02  1.18450160e+02  1.18450160e+02
  1.37161490e+02  5.01399840e+02  1.86919347e+03  7.99899037e+03
  4.77668120e+04]
E1 = -182.59793593840755  E_coul = 54.06610137216511
cycle= 4 E= -128.531834566242  delta_E= -1.93e-08  |g|= 6.31e-05  |ddm|= 0.000228
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000137115
diis-c [-7.99569583e-10  2.88590446e-04  4.31434052e-04 -1.93962440e-01
  1.19324242e+00]
  HOMO = -0.845487338892805  LUMO = 1.0868826220676
  mo_energy =
[-3.27691888e+01 -1.92717576e+00 -8.45487339e-01 -8.45487339e-01
 -8.45487339e-01  1.08688262e+00  1.08688262e+00  1.08688262e+00
  1.11006065e+00  5.67530125e+00  5.67530125e+00  5.67530125e+00
  6.71441372e+00  2.39825418e+01  2.39825418e+01  2.39825418e+01
  3.32631148e+01  1.18450105e+02  1.18450105e+02  1.18450105e+02
  1.37161434e+02  5.01399777e+02  1.86919340e+03  7.99899029e+03
  4.77668119e+04]
E1 = -182.5980529986086  E_coul = 54.06621843189619
cycle= 5 E= -128.531834566712  delta_E= -4.7e-10  |g|= 5.58e-06  |ddm|= 3.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5980529986086  E_coul = 54.06621843189619
  HOMO = -0.845484418517905  LUMO = 1.08688385655403
  mo_energy =
[-3.27691827e+01 -1.92717211e+00 -8.45484419e-01 -8.45484419e-01
 -8.45484419e-01  1.08688386e+00  1.08688386e+00  1.08688386e+00
  1.11006237e+00  5.67530481e+00  5.67530481e+00  5.67530481e+00
  6.71441752e+00  2.39825472e+01  2.39825472e+01  2.39825472e+01
  3.32631204e+01  1.18450111e+02  1.18450111e+02  1.18450111e+02
  1.37161440e+02  5.01399783e+02  1.86919340e+03  7.99899030e+03
  4.77668119e+04]
E1 = -182.59803950621193  E_coul = 54.06620493949748
Extra cycle  E= -128.531834566714  delta_E= -2.05e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 320.91273400665904
E1 = -182.59803950621193  E_coul = 54.06620493949748
init E= -128.531834566714
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845485367033265  LUMO = 1.08688352775556
  mo_energy =
[-3.27691857e+01 -1.92717298e+00 -8.45485367e-01 -8.45485367e-01
 -8.45485367e-01  1.08688353e+00  1.08688353e+00  1.08688353e+00
  1.11006210e+00  5.67530366e+00  5.67530366e+00  5.67530366e+00
  6.71441650e+00  2.39825450e+01  2.39825450e+01  2.39825450e+01
  3.32631182e+01  1.18450108e+02  1.18450108e+02  1.18450108e+02
  1.37161437e+02  5.01399779e+02  1.86919340e+03  7.99899029e+03
  4.77668119e+04]
E1 = -182.5980468304049  E_coul = 54.066212263689685
cycle= 1 E= -128.531834566715  delta_E= -7.67e-13  |g|= 1.01e-06  |ddm|= 7.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5980468304049  E_coul = 54.066212263689685
  HOMO = -0.845484853703249  LUMO = 1.08688371618208
  mo_energy =
[-3.27691842e+01 -1.92717241e+00 -8.45484854e-01 -8.45484854e-01
 -8.45484854e-01  1.08688372e+00  1.08688372e+00  1.08688372e+00
  1.11006231e+00  5.67530429e+00  5.67530429e+00  5.67530429e+00
  6.71441711e+00  2.39825462e+01  2.39825462e+01  2.39825462e+01
  3.32631194e+01  1.18450109e+02  1.18450109e+02  1.18450109e+02
  1.37161439e+02  5.01399781e+02  1.86919340e+03  7.99899029e+03
  4.77668119e+04]
E1 = -182.59804319890654  E_coul = 54.06620863219187
Extra cycle  E= -128.531834566715  delta_E= 5.4e-13  |g|= 4.94e-07  |ddm|= 3.69e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272625e+02 2.35718874e+02
 7.65081306e+01 9.96033675e+00 2.70098592e+01 3.67653160e-01
 1.05071613e+00 2.65058241e+00 3.67596899e+00 1.24135934e+01
 5.45899761e+01 3.29534863e-01 1.14152815e+00]
grad_E = [ 4.17642352e-10 -2.16194910e-08  4.18008155e-07 -4.23300240e-06
  2.09875835e-05  1.23516853e-04 -3.09668076e-05 -1.47378658e-04
 -6.20930265e-05 -2.36478926e-04  1.55029308e-05 -9.72126853e-06
 -1.17771931e-06 -7.32954813e-04  9.36864476e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45438961        1
[INPUT] 0    0    [1    /1   ]  833.272612336        1
[INPUT] 0    0    [1    /1   ]  235.718909824        1
[INPUT] 0    0    [1    /1   ]  76.5096000832        1
[INPUT] 0    0    [1    /1   ]  9.97701498879        1
[INPUT] 0    0    [1    /1   ]  26.9935555035        1
[INPUT] 0    0    [1    /1   ]  0.371064644968       1
[INPUT] 0    0    [1    /1   ]  1.06606012189        1
[INPUT] 0    0    [1    /1   ]  2.69283405149        1
[INPUT] 1    0    [1    /1   ]  3.67684980299        1
[INPUT] 1    0    [1    /1   ]  12.4179461767        1
[INPUT] 1    0    [1    /1   ]  54.6241604157        1
[INPUT] 1    0    [1    /1   ]  0.329550916167       1
[INPUT] 1    0    [1    /1   ]  1.14171555263        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413154077, 1.0]], [0, [3661.454389606276, 1.0]], [0, [833.2726123359495, 1.0]], [0, [235.7189098236523, 1.0]], [0, [76.50960008316787, 1.0]], [0, [9.977014988792677, 1.0]], [0, [26.99355550351103, 1.0]], [0, [0.37106464496781366, 1.0]], [0, [1.0660601218879266, 1.0]], [0, [2.69283405148834, 1.0]], [1, [3.676849802990596, 1.0]], [1, [12.417946176682399, 1.0]], [1, [54.62416041569865, 1.0]], [1, [0.3295509161670041, 1.0]], [1, [1.1417155526286524, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413154]
bas 1, expnt(s) = [3661.45438961]
bas 2, expnt(s) = [833.27261234]
bas 3, expnt(s) = [235.71890982]
bas 4, expnt(s) = [76.50960008]
bas 5, expnt(s) = [9.97701499]
bas 6, expnt(s) = [26.9935555]
bas 7, expnt(s) = [0.37106464]
bas 8, expnt(s) = [1.06606012]
bas 9, expnt(s) = [2.69283405]
bas 10, expnt(s) = [3.6768498]
bas 11, expnt(s) = [12.41794618]
bas 12, expnt(s) = [54.62416042]
bas 13, expnt(s) = [0.32955092]
bas 14, expnt(s) = [1.14171555]
CPU time:       252.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272612e+02 3.91836921e+02 2.35718910e+02 1.51988540e+02
 7.65096001e+01 6.53584845e+01 9.97701499e+00 1.41829148e+01
 2.69935555e+01 2.99198969e+01 3.71064645e-01 1.20116372e+00
 1.06606012e+00 2.65064336e+00 2.69283405e+00 5.31095005e+00
 3.67684980e+00 1.48535155e+01 1.24179462e+01 6.80059026e+01
 5.46241604e+01 4.33226846e+02 3.29550916e-01 7.28429535e-01
 1.14171555e+00 3.44295851e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998461353662481
cond(S) = 325.74441848241884
E1 = -183.5769898159109  E_coul = 55.07843127158593
init E= -128.498558544325
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773949744630332  LUMO = 1.11265104168728
  mo_energy =
[-3.25552687e+01 -1.85280268e+00 -7.73949745e-01 -7.73949745e-01
 -7.73949745e-01  1.11265104e+00  1.11265104e+00  1.11265104e+00
  1.15606184e+00  5.76350065e+00  5.76350065e+00  5.76350065e+00
  6.91753615e+00  2.41477250e+01  2.41477250e+01  2.41477250e+01
  3.36877766e+01  1.18735532e+02  1.18735532e+02  1.18735532e+02
  1.37638714e+02  5.01873699e+02  1.86967079e+03  7.99946933e+03
  4.77672782e+04]
E1 = -182.11114846332976  E_coul = 53.58265594162148
cycle= 1 E= -128.528492521708  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.45043
diis-c [-0.20288678  1.        ]
  HOMO = -0.879555214236503  LUMO = 1.07460337174345
  mo_energy =
[-3.28736838e+01 -1.96308819e+00 -8.79555214e-01 -8.79555214e-01
 -8.79555214e-01  1.07460337e+00  1.07460337e+00  1.07460337e+00
  1.11532682e+00  5.63482412e+00  5.63482412e+00  5.63482412e+00
  6.79409876e+00  2.39131014e+01  2.39131014e+01  2.39131014e+01
  3.34463590e+01  1.18415002e+02  1.18415002e+02  1.18415002e+02
  1.37325382e+02  5.01516572e+02  1.86927777e+03  7.99904734e+03
  4.77668374e+04]
E1 = -182.84274999722763  E_coul = 54.31175476712256
cycle= 2 E= -128.530995230105  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224702
diis-c [-5.99579965e-04  3.31830315e-01  6.68169685e-01]
  HOMO = -0.845209987882754  LUMO = 1.08705642230812
  mo_energy =
[-3.27686933e+01 -1.92696969e+00 -8.45209988e-01 -8.45209988e-01
 -8.45209988e-01  1.08705642e+00  1.08705642e+00  1.08705642e+00
  1.12849629e+00  5.67667423e+00  5.67667423e+00  5.67667423e+00
  6.83426634e+00  2.39905720e+01  2.39905720e+01  2.39905720e+01
  3.35263244e+01  1.18519984e+02  1.18519984e+02  1.18519984e+02
  1.37428484e+02  5.01630223e+02  1.86939658e+03  7.99916856e+03
  4.77669596e+04]
E1 = -182.59743249923864  E_coul = 54.065591180911866
cycle= 3 E= -128.531841318327  delta_E= -0.000846  |g|= 0.000478  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984123
diis-c [-9.75580726e-08 -2.16096982e-03 -1.71253095e-04  1.00233222e+00]
  HOMO = -0.845449252864901  LUMO = 1.08700644909024
  mo_energy =
[-3.27691256e+01 -1.92714979e+00 -8.45449253e-01 -8.45449253e-01
 -8.45449253e-01  1.08700645e+00  1.08700645e+00  1.08700645e+00
  1.12843959e+00  5.67646243e+00  5.67646243e+00  5.67646243e+00
  6.83406916e+00  2.39902333e+01  2.39902333e+01  2.39902333e+01
  3.35259871e+01  1.18519541e+02  1.18519541e+02  1.18519541e+02
  1.37428054e+02  5.01629689e+02  1.86939593e+03  7.99916783e+03
  4.77669588e+04]
E1 = -182.59801844324974  E_coul = 54.06617710591092
cycle= 4 E= -128.531841337339  delta_E= -1.9e-08  |g|= 6.27e-05  |ddm|= 0.000225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013632
diis-c [-7.93341124e-10  2.86885542e-04  4.32097304e-04 -1.92929114e-01
  1.19221013e+00]
  HOMO = -0.845480528037958  LUMO = 1.08699381373203
  mo_energy =
[-3.27691802e+01 -1.92717036e+00 -8.45480528e-01 -8.45480528e-01
 -8.45480528e-01  1.08699381e+00  1.08699381e+00  1.08699381e+00
  1.12842982e+00  5.67642722e+00  5.67642722e+00  5.67642722e+00
  6.83403882e+00  2.39901853e+01  2.39901853e+01  2.39901853e+01
  3.35259397e+01  1.18519486e+02  1.18519486e+02  1.18519486e+02
  1.37427999e+02  5.01629627e+02  1.86939586e+03  7.99916775e+03
  4.77669587e+04]
E1 = -182.5981351752432  E_coul = 54.06629383744375
cycle= 5 E= -128.531841337799  delta_E= -4.61e-10  |g|= 5.54e-06  |ddm|= 3.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5981351752432  E_coul = 54.06629383744375
  HOMO = -0.845477633958792  LUMO = 1.08699503710104
  mo_energy =
[-3.27691741e+01 -1.92716674e+00 -8.45477634e-01 -8.45477634e-01
 -8.45477634e-01  1.08699504e+00  1.08699504e+00  1.08699504e+00
  1.12843155e+00  5.67643075e+00  5.67643075e+00  5.67643075e+00
  6.83404261e+00  2.39901906e+01  2.39901906e+01  2.39901906e+01
  3.35259452e+01  1.18519492e+02  1.18519492e+02  1.18519492e+02
  1.37428005e+02  5.01629633e+02  1.86939587e+03  7.99916776e+03
  4.77669587e+04]
E1 = -182.5981217975461  E_coul = 54.06628045974493
Extra cycle  E= -128.531841337801  delta_E= -1.71e-12  |g|= 1.89e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272612e+02 2.35718910e+02
 7.65096001e+01 9.97701499e+00 2.69935555e+01 3.71064645e-01
 1.06606012e+00 2.69283405e+00 3.67684980e+00 1.24179462e+01
 5.46241604e+01 3.29550916e-01 1.14171555e+00]
E = -128.53184133780115
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45438961        1
[INPUT] 0    0    [1    /1   ]  833.272612336        1
[INPUT] 0    0    [1    /1   ]  235.718909824        1
[INPUT] 0    0    [1    /1   ]  76.5096000832        1
[INPUT] 0    0    [1    /1   ]  9.97701498879        1
[INPUT] 0    0    [1    /1   ]  26.9935555035        1
[INPUT] 0    0    [1    /1   ]  0.371064644968       1
[INPUT] 0    0    [1    /1   ]  1.06606012189        1
[INPUT] 0    0    [1    /1   ]  2.69283405149        1
[INPUT] 1    0    [1    /1   ]  3.67684980299        1
[INPUT] 1    0    [1    /1   ]  12.4179461767        1
[INPUT] 1    0    [1    /1   ]  54.6241604157        1
[INPUT] 1    0    [1    /1   ]  0.329550916167       1
[INPUT] 1    0    [1    /1   ]  1.14171555263        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413154077, 1.0]], [0, [3661.454389606276, 1.0]], [0, [833.2726123359495, 1.0]], [0, [235.7189098236523, 1.0]], [0, [76.50960008316787, 1.0]], [0, [9.977014988792677, 1.0]], [0, [26.99355550351103, 1.0]], [0, [0.37106464496781366, 1.0]], [0, [1.0660601218879266, 1.0]], [0, [2.69283405148834, 1.0]], [1, [3.676849802990596, 1.0]], [1, [12.417946176682399, 1.0]], [1, [54.62416041569865, 1.0]], [1, [0.3295509161670041, 1.0]], [1, [1.1417155526286524, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413154]
bas 1, expnt(s) = [3661.45438961]
bas 2, expnt(s) = [833.27261234]
bas 3, expnt(s) = [235.71890982]
bas 4, expnt(s) = [76.50960008]
bas 5, expnt(s) = [9.97701499]
bas 6, expnt(s) = [26.9935555]
bas 7, expnt(s) = [0.37106464]
bas 8, expnt(s) = [1.06606012]
bas 9, expnt(s) = [2.69283405]
bas 10, expnt(s) = [3.6768498]
bas 11, expnt(s) = [12.41794618]
bas 12, expnt(s) = [54.62416042]
bas 13, expnt(s) = [0.32955092]
bas 14, expnt(s) = [1.14171555]
CPU time:       253.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920094e+03
 8.33272612e+02 3.91836921e+02 2.35718910e+02 1.51988540e+02
 7.65096001e+01 6.53584845e+01 9.97701499e+00 1.41829148e+01
 2.69935555e+01 2.99198969e+01 3.71064645e-01 1.20116372e+00
 1.06606012e+00 2.65064336e+00 2.69283405e+00 5.31095005e+00
 3.67684980e+00 1.48535155e+01 1.24179462e+01 6.80059026e+01
 5.46241604e+01 4.33226846e+02 3.29550916e-01 7.28429535e-01
 1.14171555e+00 3.44295851e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998461353662481
cond(S) = 325.74441848241884
E1 = -183.5769898159109  E_coul = 55.07843127158593
init E= -128.498558544325
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949744630332  LUMO = 1.11265104168728
  mo_energy =
[-3.25552687e+01 -1.85280268e+00 -7.73949745e-01 -7.73949745e-01
 -7.73949745e-01  1.11265104e+00  1.11265104e+00  1.11265104e+00
  1.15606184e+00  5.76350065e+00  5.76350065e+00  5.76350065e+00
  6.91753615e+00  2.41477250e+01  2.41477250e+01  2.41477250e+01
  3.36877766e+01  1.18735532e+02  1.18735532e+02  1.18735532e+02
  1.37638714e+02  5.01873699e+02  1.86967079e+03  7.99946933e+03
  4.77672782e+04]
E1 = -182.11114846332976  E_coul = 53.58265594162148
cycle= 1 E= -128.528492521708  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.45043
diis-c [-0.20288678  1.        ]
  HOMO = -0.879555214236503  LUMO = 1.07460337174345
  mo_energy =
[-3.28736838e+01 -1.96308819e+00 -8.79555214e-01 -8.79555214e-01
 -8.79555214e-01  1.07460337e+00  1.07460337e+00  1.07460337e+00
  1.11532682e+00  5.63482412e+00  5.63482412e+00  5.63482412e+00
  6.79409876e+00  2.39131014e+01  2.39131014e+01  2.39131014e+01
  3.34463590e+01  1.18415002e+02  1.18415002e+02  1.18415002e+02
  1.37325382e+02  5.01516572e+02  1.86927777e+03  7.99904734e+03
  4.77668374e+04]
E1 = -182.84274999722763  E_coul = 54.31175476712256
cycle= 2 E= -128.530995230105  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224702
diis-c [-5.99579965e-04  3.31830315e-01  6.68169685e-01]
  HOMO = -0.845209987882754  LUMO = 1.08705642230812
  mo_energy =
[-3.27686933e+01 -1.92696969e+00 -8.45209988e-01 -8.45209988e-01
 -8.45209988e-01  1.08705642e+00  1.08705642e+00  1.08705642e+00
  1.12849629e+00  5.67667423e+00  5.67667423e+00  5.67667423e+00
  6.83426634e+00  2.39905720e+01  2.39905720e+01  2.39905720e+01
  3.35263244e+01  1.18519984e+02  1.18519984e+02  1.18519984e+02
  1.37428484e+02  5.01630223e+02  1.86939658e+03  7.99916856e+03
  4.77669596e+04]
E1 = -182.59743249923864  E_coul = 54.065591180911866
cycle= 3 E= -128.531841318327  delta_E= -0.000846  |g|= 0.000478  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984123
diis-c [-9.75580726e-08 -2.16096982e-03 -1.71253095e-04  1.00233222e+00]
  HOMO = -0.845449252864901  LUMO = 1.08700644909024
  mo_energy =
[-3.27691256e+01 -1.92714979e+00 -8.45449253e-01 -8.45449253e-01
 -8.45449253e-01  1.08700645e+00  1.08700645e+00  1.08700645e+00
  1.12843959e+00  5.67646243e+00  5.67646243e+00  5.67646243e+00
  6.83406916e+00  2.39902333e+01  2.39902333e+01  2.39902333e+01
  3.35259871e+01  1.18519541e+02  1.18519541e+02  1.18519541e+02
  1.37428054e+02  5.01629689e+02  1.86939593e+03  7.99916783e+03
  4.77669588e+04]
E1 = -182.59801844324974  E_coul = 54.06617710591092
cycle= 4 E= -128.531841337339  delta_E= -1.9e-08  |g|= 6.27e-05  |ddm|= 0.000225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013632
diis-c [-7.93341124e-10  2.86885542e-04  4.32097304e-04 -1.92929114e-01
  1.19221013e+00]
  HOMO = -0.845480528037958  LUMO = 1.08699381373203
  mo_energy =
[-3.27691802e+01 -1.92717036e+00 -8.45480528e-01 -8.45480528e-01
 -8.45480528e-01  1.08699381e+00  1.08699381e+00  1.08699381e+00
  1.12842982e+00  5.67642722e+00  5.67642722e+00  5.67642722e+00
  6.83403882e+00  2.39901853e+01  2.39901853e+01  2.39901853e+01
  3.35259397e+01  1.18519486e+02  1.18519486e+02  1.18519486e+02
  1.37427999e+02  5.01629627e+02  1.86939586e+03  7.99916775e+03
  4.77669587e+04]
E1 = -182.5981351752432  E_coul = 54.06629383744375
cycle= 5 E= -128.531841337799  delta_E= -4.61e-10  |g|= 5.54e-06  |ddm|= 3.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5981351752432  E_coul = 54.06629383744375
  HOMO = -0.845477633958792  LUMO = 1.08699503710104
  mo_energy =
[-3.27691741e+01 -1.92716674e+00 -8.45477634e-01 -8.45477634e-01
 -8.45477634e-01  1.08699504e+00  1.08699504e+00  1.08699504e+00
  1.12843155e+00  5.67643075e+00  5.67643075e+00  5.67643075e+00
  6.83404261e+00  2.39901906e+01  2.39901906e+01  2.39901906e+01
  3.35259452e+01  1.18519492e+02  1.18519492e+02  1.18519492e+02
  1.37428005e+02  5.01629633e+02  1.86939587e+03  7.99916776e+03
  4.77669587e+04]
E1 = -182.5981217975461  E_coul = 54.06628045974493
Extra cycle  E= -128.531841337801  delta_E= -1.71e-12  |g|= 1.89e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 325.74441848241884
E1 = -182.5981217975461  E_coul = 54.06628045974493
init E= -128.531841337801
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.845478574586007  LUMO = 1.08699471096056
  mo_energy =
[-3.27691771e+01 -1.92716760e+00 -8.45478575e-01 -8.45478575e-01
 -8.45478575e-01  1.08699471e+00  1.08699471e+00  1.08699471e+00
  1.12843128e+00  5.67642961e+00  5.67642961e+00  5.67642961e+00
  6.83404158e+00  2.39901884e+01  2.39901884e+01  2.39901884e+01
  3.35259430e+01  1.18519488e+02  1.18519488e+02  1.18519488e+02
  1.37428002e+02  5.01629630e+02  1.86939587e+03  7.99916776e+03
  4.77669587e+04]
E1 = -182.59812905804728  E_coul = 54.06628772024546
cycle= 1 E= -128.531841337802  delta_E= -6.54e-13  |g|= 1e-06  |ddm|= 7.33e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59812905804728  E_coul = 54.06628772024546
  HOMO = -0.845478065762283  LUMO = 1.08699489776367
  mo_energy =
[-3.27691756e+01 -1.92716704e+00 -8.45478066e-01 -8.45478066e-01
 -8.45478066e-01  1.08699490e+00  1.08699490e+00  1.08699490e+00
  1.12843149e+00  5.67643024e+00  5.67643024e+00  5.67643024e+00
  6.83404219e+00  2.39901896e+01  2.39901896e+01  2.39901896e+01
  3.35259442e+01  1.18519490e+02  1.18519490e+02  1.18519490e+02
  1.37428003e+02  5.01629631e+02  1.86939587e+03  7.99916776e+03
  4.77669587e+04]
E1 = -182.59812545822427  E_coul = 54.06628412042259
Extra cycle  E= -128.531841337802  delta_E= 1.14e-13  |g|= 4.89e-07  |ddm|= 3.67e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272612e+02 2.35718910e+02
 7.65096001e+01 9.97701499e+00 2.69935555e+01 3.71064645e-01
 1.06606012e+00 2.69283405e+00 3.67684980e+00 1.24179462e+01
 5.46241604e+01 3.29550916e-01 1.14171555e+00]
grad_E = [ 6.16391537e-10 -3.20219665e-08  6.25853204e-07 -6.62402655e-06
  3.80244460e-05  2.08628233e-04 -9.67634523e-05 -2.05519002e-04
  2.18765760e-05 -2.21732465e-04  1.69783606e-05 -1.16917714e-05
 -4.40241657e-07 -8.60398853e-04  1.13360758e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439125        1
[INPUT] 0    0    [1    /1   ]  833.272582973        1
[INPUT] 0    0    [1    /1   ]  235.719104303        1
[INPUT] 0    0    [1    /1   ]  76.5105485663        1
[INPUT] 0    0    [1    /1   ]  9.98855383027        1
[INPUT] 0    0    [1    /1   ]  26.9762450822        1
[INPUT] 0    0    [1    /1   ]  0.375487645834       1
[INPUT] 0    0    [1    /1   ]  1.08708005769        1
[INPUT] 0    0    [1    /1   ]  2.76048262           1
[INPUT] 1    0    [1    /1   ]  3.67975063305        1
[INPUT] 1    0    [1    /1   ]  12.4301763223        1
[INPUT] 1    0    [1    /1   ]  54.6960727972        1
[INPUT] 1    0    [1    /1   ]  0.329761045821       1
[INPUT] 1    0    [1    /1   ]  1.14253641295        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131508228, 1.0]], [0, [3661.454391248601, 1.0]], [0, [833.2725829734858, 1.0]], [0, [235.71910430316066, 1.0]], [0, [76.51054856629585, 1.0]], [0, [9.988553830274011, 1.0]], [0, [26.976245082207214, 1.0]], [0, [0.37548764583423394, 1.0]], [0, [1.0870800576876223, 1.0]], [0, [2.760482620000705, 1.0]], [1, [3.6797506330514733, 1.0]], [1, [12.430176322322861, 1.0]], [1, [54.69607279715382, 1.0]], [1, [0.3297610458212148, 1.0]], [1, [1.1425364129513835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413151]
bas 1, expnt(s) = [3661.45439125]
bas 2, expnt(s) = [833.27258297]
bas 3, expnt(s) = [235.7191043]
bas 4, expnt(s) = [76.51054857]
bas 5, expnt(s) = [9.98855383]
bas 6, expnt(s) = [26.97624508]
bas 7, expnt(s) = [0.37548765]
bas 8, expnt(s) = [1.08708006]
bas 9, expnt(s) = [2.76048262]
bas 10, expnt(s) = [3.67975063]
bas 11, expnt(s) = [12.43017632]
bas 12, expnt(s) = [54.6960728]
bas 13, expnt(s) = [0.32976105]
bas 14, expnt(s) = [1.14253641]
CPU time:       256.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272583e+02 3.91836911e+02 2.35719104e+02 1.51988634e+02
 7.65105486e+01 6.53590921e+01 9.98855383e+00 1.41952153e+01
 2.69762451e+01 2.99055055e+01 3.75487646e-01 1.21188599e+00
 1.08708006e+00 2.68974538e+00 2.76048262e+00 5.41070414e+00
 3.67975063e+00 1.48681652e+01 1.24301763e+01 6.80896347e+01
 5.46960728e+01 4.33939889e+02 3.29761046e-01 7.29010162e-01
 1.14253641e+00 3.44605302e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998451224977165
cond(S) = 332.52755656528325
E1 = -183.5769977939963  E_coul = 55.07843170388783
init E= -128.498566090108
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773949390107787  LUMO = 1.11355474678258
  mo_energy =
[-3.25552844e+01 -1.85279039e+00 -7.73949390e-01 -7.73949390e-01
 -7.73949390e-01  1.11355475e+00  1.11355475e+00  1.11355475e+00
  1.18177280e+00  5.76835165e+00  5.76835165e+00  5.76835165e+00
  7.09335901e+00  2.41720688e+01  2.41720688e+01  2.41720688e+01
  3.40643795e+01  1.18895711e+02  1.18895711e+02  1.18895711e+02
  1.38012765e+02  5.02196392e+02  1.86995511e+03  7.99971855e+03
  4.77674843e+04]
E1 = -182.11168196675067  E_coul = 53.58317894592774
cycle= 1 E= -128.528503020823  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450303
diis-c [-0.20277301  1.        ]
  HOMO = -0.879511791039311  LUMO = 1.07549494552395
  mo_energy =
[-3.28736071e+01 -1.96303707e+00 -8.79511791e-01 -8.79511791e-01
 -8.79511791e-01  1.07549495e+00  1.07549495e+00  1.07549495e+00
  1.14011786e+00  5.63965332e+00  5.63965332e+00  5.63965332e+00
  6.96820412e+00  2.39374428e+01  2.39374428e+01  2.39374428e+01
  3.38228643e+01  1.18575211e+02  1.18575211e+02  1.18575211e+02
  1.37699586e+02  5.01839365e+02  1.86956217e+03  7.99929663e+03
  4.77670436e+04]
E1 = -182.84296942024687  E_coul = 54.31196515358192
cycle= 2 E= -128.531004266665  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224619
diis-c [-6.01265922e-04  3.31806295e-01  6.68193705e-01]
  HOMO = -0.845181164023573  LUMO = 1.08795401183628
  mo_energy =
[-3.27686544e+01 -1.92693309e+00 -8.45181164e-01 -8.45181164e-01
 -8.45181164e-01  1.08795401e+00  1.08795401e+00  1.08795401e+00
  1.15358529e+00  5.68150968e+00  5.68150968e+00  5.68150968e+00
  7.00893906e+00  2.40149102e+01  2.40149102e+01  2.40149102e+01
  3.39028566e+01  1.18680172e+02  1.18680172e+02  1.18680172e+02
  1.37802628e+02  5.01952969e+02  1.86968094e+03  7.99941780e+03
  4.77671657e+04]
E1 = -182.5977875307482  E_coul = 54.06593794150686
cycle= 3 E= -128.531849589241  delta_E= -0.000845  |g|= 0.000476  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981454
diis-c [-9.60067827e-08 -2.15777997e-03 -1.72582502e-04  1.00233036e+00]
  HOMO = -0.845419241002913  LUMO = 1.08790459033707
  mo_energy =
[-3.27690850e+01 -1.92711226e+00 -8.45419241e-01 -8.45419241e-01
 -8.45419241e-01  1.08790459e+00  1.08790459e+00  1.08790459e+00
  1.15352787e+00  5.68129892e+00  5.68129892e+00  5.68129892e+00
  7.00874049e+00  2.40145730e+01  2.40145730e+01  2.40145730e+01
  3.39025204e+01  1.18679730e+02  1.18679730e+02  1.18679730e+02
  1.37802199e+02  5.01952438e+02  1.86968029e+03  7.99941708e+03
  4.77671649e+04]
E1 = -182.5983737075606  E_coul = 54.06652409959927
cycle= 4 E= -128.531849607961  delta_E= -1.87e-08  |g|= 6.22e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135758
diis-c [-7.88308165e-10  2.86219136e-04  4.32332219e-04 -1.92389948e-01
  1.19167140e+00]
  HOMO = -0.845450244312891  LUMO = 1.0878920793252
  mo_energy =
[-3.27691393e+01 -1.92713266e+00 -8.45450244e-01 -8.45450244e-01
 -8.45450244e-01  1.08789208e+00  1.08789208e+00  1.08789208e+00
  1.15351801e+00  5.68126396e+00  5.68126396e+00  5.68126396e+00
  7.00871005e+00  2.40145253e+01  2.40145253e+01  2.40145253e+01
  3.39024732e+01  1.18679675e+02  1.18679675e+02  1.18679675e+02
  1.37802144e+02  5.01952376e+02  1.86968022e+03  7.99941700e+03
  4.77671648e+04]
E1 = -182.5984904000245  E_coul = 54.06664079161116
cycle= 5 E= -128.531849608413  delta_E= -4.52e-10  |g|= 5.51e-06  |ddm|= 3.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984904000245  E_coul = 54.06664079161116
  HOMO = -0.84544736132293  LUMO = 1.08789329795268
  mo_energy =
[-3.27691333e+01 -1.92712905e+00 -8.45447361e-01 -8.45447361e-01
 -8.45447361e-01  1.08789330e+00  1.08789330e+00  1.08789330e+00
  1.15351976e+00  5.68126748e+00  5.68126748e+00  5.68126748e+00
  7.00871386e+00  2.40145306e+01  2.40145306e+01  2.40145306e+01
  3.39024788e+01  1.18679681e+02  1.18679681e+02  1.18679681e+02
  1.37802150e+02  5.01952381e+02  1.86968023e+03  7.99941701e+03
  4.77671649e+04]
E1 = -182.59847705071456  E_coul = 54.06662744229911
Extra cycle  E= -128.531849608415  delta_E= -2.1e-12  |g|= 1.89e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272583e+02 2.35719104e+02
 7.65105486e+01 9.98855383e+00 2.69762451e+01 3.75487646e-01
 1.08708006e+00 2.76048262e+00 3.67975063e+00 1.24301763e+01
 5.46960728e+01 3.29761046e-01 1.14253641e+00]
E = -128.53184960841546
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439125        1
[INPUT] 0    0    [1    /1   ]  833.272582973        1
[INPUT] 0    0    [1    /1   ]  235.719104303        1
[INPUT] 0    0    [1    /1   ]  76.5105485663        1
[INPUT] 0    0    [1    /1   ]  9.98855383027        1
[INPUT] 0    0    [1    /1   ]  26.9762450822        1
[INPUT] 0    0    [1    /1   ]  0.375487645834       1
[INPUT] 0    0    [1    /1   ]  1.08708005769        1
[INPUT] 0    0    [1    /1   ]  2.76048262           1
[INPUT] 1    0    [1    /1   ]  3.67975063305        1
[INPUT] 1    0    [1    /1   ]  12.4301763223        1
[INPUT] 1    0    [1    /1   ]  54.6960727972        1
[INPUT] 1    0    [1    /1   ]  0.329761045821       1
[INPUT] 1    0    [1    /1   ]  1.14253641295        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131508228, 1.0]], [0, [3661.454391248601, 1.0]], [0, [833.2725829734858, 1.0]], [0, [235.71910430316066, 1.0]], [0, [76.51054856629585, 1.0]], [0, [9.988553830274011, 1.0]], [0, [26.976245082207214, 1.0]], [0, [0.37548764583423394, 1.0]], [0, [1.0870800576876223, 1.0]], [0, [2.760482620000705, 1.0]], [1, [3.6797506330514733, 1.0]], [1, [12.430176322322861, 1.0]], [1, [54.69607279715382, 1.0]], [1, [0.3297610458212148, 1.0]], [1, [1.1425364129513835, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413151]
bas 1, expnt(s) = [3661.45439125]
bas 2, expnt(s) = [833.27258297]
bas 3, expnt(s) = [235.7191043]
bas 4, expnt(s) = [76.51054857]
bas 5, expnt(s) = [9.98855383]
bas 6, expnt(s) = [26.97624508]
bas 7, expnt(s) = [0.37548765]
bas 8, expnt(s) = [1.08708006]
bas 9, expnt(s) = [2.76048262]
bas 10, expnt(s) = [3.67975063]
bas 11, expnt(s) = [12.43017632]
bas 12, expnt(s) = [54.6960728]
bas 13, expnt(s) = [0.32976105]
bas 14, expnt(s) = [1.14253641]
CPU time:       257.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272583e+02 3.91836911e+02 2.35719104e+02 1.51988634e+02
 7.65105486e+01 6.53590921e+01 9.98855383e+00 1.41952153e+01
 2.69762451e+01 2.99055055e+01 3.75487646e-01 1.21188599e+00
 1.08708006e+00 2.68974538e+00 2.76048262e+00 5.41070414e+00
 3.67975063e+00 1.48681652e+01 1.24301763e+01 6.80896347e+01
 5.46960728e+01 4.33939889e+02 3.29761046e-01 7.29010162e-01
 1.14253641e+00 3.44605302e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998451224977165
cond(S) = 332.52755656528325
E1 = -183.5769977939963  E_coul = 55.07843170388783
init E= -128.498566090108
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949390107787  LUMO = 1.11355474678258
  mo_energy =
[-3.25552844e+01 -1.85279039e+00 -7.73949390e-01 -7.73949390e-01
 -7.73949390e-01  1.11355475e+00  1.11355475e+00  1.11355475e+00
  1.18177280e+00  5.76835165e+00  5.76835165e+00  5.76835165e+00
  7.09335901e+00  2.41720688e+01  2.41720688e+01  2.41720688e+01
  3.40643795e+01  1.18895711e+02  1.18895711e+02  1.18895711e+02
  1.38012765e+02  5.02196392e+02  1.86995511e+03  7.99971855e+03
  4.77674843e+04]
E1 = -182.11168196675067  E_coul = 53.58317894592774
cycle= 1 E= -128.528503020823  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450303
diis-c [-0.20277301  1.        ]
  HOMO = -0.879511791039311  LUMO = 1.07549494552395
  mo_energy =
[-3.28736071e+01 -1.96303707e+00 -8.79511791e-01 -8.79511791e-01
 -8.79511791e-01  1.07549495e+00  1.07549495e+00  1.07549495e+00
  1.14011786e+00  5.63965332e+00  5.63965332e+00  5.63965332e+00
  6.96820412e+00  2.39374428e+01  2.39374428e+01  2.39374428e+01
  3.38228643e+01  1.18575211e+02  1.18575211e+02  1.18575211e+02
  1.37699586e+02  5.01839365e+02  1.86956217e+03  7.99929663e+03
  4.77670436e+04]
E1 = -182.84296942024687  E_coul = 54.31196515358192
cycle= 2 E= -128.531004266665  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0705
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224619
diis-c [-6.01265922e-04  3.31806295e-01  6.68193705e-01]
  HOMO = -0.845181164023573  LUMO = 1.08795401183628
  mo_energy =
[-3.27686544e+01 -1.92693309e+00 -8.45181164e-01 -8.45181164e-01
 -8.45181164e-01  1.08795401e+00  1.08795401e+00  1.08795401e+00
  1.15358529e+00  5.68150968e+00  5.68150968e+00  5.68150968e+00
  7.00893906e+00  2.40149102e+01  2.40149102e+01  2.40149102e+01
  3.39028566e+01  1.18680172e+02  1.18680172e+02  1.18680172e+02
  1.37802628e+02  5.01952969e+02  1.86968094e+03  7.99941780e+03
  4.77671657e+04]
E1 = -182.5977875307482  E_coul = 54.06593794150686
cycle= 3 E= -128.531849589241  delta_E= -0.000845  |g|= 0.000476  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981454
diis-c [-9.60067827e-08 -2.15777997e-03 -1.72582502e-04  1.00233036e+00]
  HOMO = -0.845419241002913  LUMO = 1.08790459033707
  mo_energy =
[-3.27690850e+01 -1.92711226e+00 -8.45419241e-01 -8.45419241e-01
 -8.45419241e-01  1.08790459e+00  1.08790459e+00  1.08790459e+00
  1.15352787e+00  5.68129892e+00  5.68129892e+00  5.68129892e+00
  7.00874049e+00  2.40145730e+01  2.40145730e+01  2.40145730e+01
  3.39025204e+01  1.18679730e+02  1.18679730e+02  1.18679730e+02
  1.37802199e+02  5.01952438e+02  1.86968029e+03  7.99941708e+03
  4.77671649e+04]
E1 = -182.5983737075606  E_coul = 54.06652409959927
cycle= 4 E= -128.531849607961  delta_E= -1.87e-08  |g|= 6.22e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135758
diis-c [-7.88308165e-10  2.86219136e-04  4.32332219e-04 -1.92389948e-01
  1.19167140e+00]
  HOMO = -0.845450244312891  LUMO = 1.0878920793252
  mo_energy =
[-3.27691393e+01 -1.92713266e+00 -8.45450244e-01 -8.45450244e-01
 -8.45450244e-01  1.08789208e+00  1.08789208e+00  1.08789208e+00
  1.15351801e+00  5.68126396e+00  5.68126396e+00  5.68126396e+00
  7.00871005e+00  2.40145253e+01  2.40145253e+01  2.40145253e+01
  3.39024732e+01  1.18679675e+02  1.18679675e+02  1.18679675e+02
  1.37802144e+02  5.01952376e+02  1.86968022e+03  7.99941700e+03
  4.77671648e+04]
E1 = -182.5984904000245  E_coul = 54.06664079161116
cycle= 5 E= -128.531849608413  delta_E= -4.52e-10  |g|= 5.51e-06  |ddm|= 3.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984904000245  E_coul = 54.06664079161116
  HOMO = -0.84544736132293  LUMO = 1.08789329795268
  mo_energy =
[-3.27691333e+01 -1.92712905e+00 -8.45447361e-01 -8.45447361e-01
 -8.45447361e-01  1.08789330e+00  1.08789330e+00  1.08789330e+00
  1.15351976e+00  5.68126748e+00  5.68126748e+00  5.68126748e+00
  7.00871386e+00  2.40145306e+01  2.40145306e+01  2.40145306e+01
  3.39024788e+01  1.18679681e+02  1.18679681e+02  1.18679681e+02
  1.37802150e+02  5.01952381e+02  1.86968023e+03  7.99941701e+03
  4.77671649e+04]
E1 = -182.59847705071456  E_coul = 54.06662744229911
Extra cycle  E= -128.531849608415  delta_E= -2.1e-12  |g|= 1.89e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 332.52755656528325
E1 = -182.59847705071456  E_coul = 54.06662744229911
init E= -128.531849608415
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845448299929167  LUMO = 1.08789297206312
  mo_energy =
[-3.27691363e+01 -1.92712991e+00 -8.45448300e-01 -8.45448300e-01
 -8.45448300e-01  1.08789297e+00  1.08789297e+00  1.08789297e+00
  1.15351948e+00  5.68126634e+00  5.68126634e+00  5.68126634e+00
  7.00871282e+00  2.40145284e+01  2.40145284e+01  2.40145284e+01
  3.39024765e+01  1.18679678e+02  1.18679678e+02  1.18679678e+02
  1.37802147e+02  5.01952378e+02  1.86968023e+03  7.99941700e+03
  4.77671648e+04]
E1 = -182.598484289995  E_coul = 54.06663468157921
cycle= 1 E= -128.531849608416  delta_E= -3.41e-13  |g|= 9.98e-07  |ddm|= 7.31e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.598484289995  E_coul = 54.06663468157921
  HOMO = -0.845447792594306  LUMO = 1.08789315846848
  mo_energy =
[-3.27691347e+01 -1.92712936e+00 -8.45447793e-01 -8.45447793e-01
 -8.45447793e-01  1.08789316e+00  1.08789316e+00  1.08789316e+00
  1.15351970e+00  5.68126696e+00  5.68126696e+00  5.68126696e+00
  7.00871344e+00  2.40145296e+01  2.40145296e+01  2.40145296e+01
  3.39024777e+01  1.18679680e+02  1.18679680e+02  1.18679680e+02
  1.37802148e+02  5.01952380e+02  1.86968023e+03  7.99941701e+03
  4.77671648e+04]
E1 = -182.59848070070916  E_coul = 54.06663109229321
Extra cycle  E= -128.531849608416  delta_E= -1.42e-13  |g|= 4.88e-07  |ddm|= 3.67e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272583e+02 2.35719104e+02
 7.65105486e+01 9.98855383e+00 2.69762451e+01 3.75487646e-01
 1.08708006e+00 2.76048262e+00 3.67975063e+00 1.24301763e+01
 5.46960728e+01 3.29761046e-01 1.14253641e+00]
grad_E = [ 7.49852225e-10 -3.89992488e-08  7.64557925e-07 -8.18349243e-06
  4.82999521e-05  2.04564882e-04 -1.27022623e-04 -2.75043553e-04
  1.28554407e-04 -1.63459107e-04  1.53372281e-05 -1.06544505e-05
  3.23471094e-07 -7.07536697e-04  9.47177075e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439307        1
[INPUT] 0    0    [1    /1   ]  833.272549262        1
[INPUT] 0    0    [1    /1   ]  235.719389633        1
[INPUT] 0    0    [1    /1   ]  76.5101960975        1
[INPUT] 0    0    [1    /1   ]  9.98656006104        1
[INPUT] 0    0    [1    /1   ]  26.9684124782        1
[INPUT] 0    0    [1    /1   ]  0.378304674745       1
[INPUT] 0    0    [1    /1   ]  1.10154248152        1
[INPUT] 0    0    [1    /1   ]  2.81942565501        1
[INPUT] 1    0    [1    /1   ]  3.68293222815        1
[INPUT] 1    0    [1    /1   ]  12.4427951224        1
[INPUT] 1    0    [1    /1   ]  54.7552341808        1
[INPUT] 1    0    [1    /1   ]  0.330052198247       1
[INPUT] 1    0    [1    /1   ]  1.14351589399        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413147271, 1.0]], [0, [3661.454393065268, 1.0]], [0, [833.2725492623143, 1.0]], [0, [235.71938963277768, 1.0]], [0, [76.51019609751327, 1.0]], [0, [9.986560061043207, 1.0]], [0, [26.968412478164147, 1.0]], [0, [0.37830467474477303, 1.0]], [0, [1.101542481517903, 1.0]], [0, [2.819425655007223, 1.0]], [1, [3.6829322281547396, 1.0]], [1, [12.442795122400689, 1.0]], [1, [54.75523418081269, 1.0]], [1, [0.3300521982469976, 1.0]], [1, [1.1435158939905703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413147]
bas 1, expnt(s) = [3661.45439307]
bas 2, expnt(s) = [833.27254926]
bas 3, expnt(s) = [235.71938963]
bas 4, expnt(s) = [76.5101961]
bas 5, expnt(s) = [9.98656006]
bas 6, expnt(s) = [26.96841248]
bas 7, expnt(s) = [0.37830467]
bas 8, expnt(s) = [1.10154248]
bas 9, expnt(s) = [2.81942566]
bas 10, expnt(s) = [3.68293223]
bas 11, expnt(s) = [12.44279512]
bas 12, expnt(s) = [54.75523418]
bas 13, expnt(s) = [0.3300522]
bas 14, expnt(s) = [1.14351589]
CPU time:       260.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272549e+02 3.91836899e+02 2.35719390e+02 1.51988772e+02
 7.65101961e+01 6.53588663e+01 9.98656006e+00 1.41930902e+01
 2.69684125e+01 2.98989929e+01 3.78304675e-01 1.21869858e+00
 1.10154248e+00 2.71653911e+00 2.81942566e+00 5.49712370e+00
 3.68293223e+00 1.48842361e+01 1.24427951e+01 6.81760492e+01
 5.47552342e+01 4.34526676e+02 3.30052198e-01 7.29814822e-01
 1.14351589e+00 3.44974623e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998441208631078
cond(S) = 337.4718322037119
E1 = -183.577071742868  E_coul = 55.07844363476482
init E= -128.498628108103
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948378571414  LUMO = 1.11475668646001
  mo_energy =
[-3.25552937e+01 -1.85277958e+00 -7.73948379e-01 -7.73948379e-01
 -7.73948379e-01  1.11475669e+00  1.11475669e+00  1.11475669e+00
  1.19946656e+00  5.77410078e+00  5.77410078e+00  5.77410078e+00
  7.22866631e+00  2.41984901e+01  2.41984901e+01  2.41984901e+01
  3.43517864e+01  1.19038913e+02  1.19038913e+02  1.19038913e+02
  1.38292509e+02  5.02438042e+02  1.87016811e+03  7.99990526e+03
  4.77676388e+04]
E1 = -182.11232900112424  E_coul = 53.5838181395738
cycle= 1 E= -128.52851086155  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450222
diis-c [-0.20269998  1.        ]
  HOMO = -0.879458813818244  LUMO = 1.07667866203095
  mo_energy =
[-3.28735139e+01 -1.96297163e+00 -8.79458814e-01 -8.79458814e-01
 -8.79458814e-01  1.07667866e+00  1.07667866e+00  1.07667866e+00
  1.15717094e+00  5.64538393e+00  5.64538393e+00  5.64538393e+00
  7.10218487e+00  2.39638693e+01  2.39638693e+01  2.39638693e+01
  3.41102328e+01  1.18718462e+02  1.18718462e+02  1.18718462e+02
  1.37979476e+02  5.02081117e+02  1.86977525e+03  7.99948341e+03
  4.77671981e+04]
E1 = -182.84327198572322  E_coul = 54.31226139885959
cycle= 2 E= -128.531010586864  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224542
diis-c [-6.02521611e-04  3.31767456e-01  6.68232544e-01]
  HOMO = -0.84514332290826  LUMO = 1.08914660065217
  mo_energy =
[-3.27686011e+01 -1.92688319e+00 -8.45143323e-01 -8.45143323e-01
 -8.45143323e-01  1.08914660e+00  1.08914660e+00  1.08914660e+00
  1.17084895e+00  5.68724782e+00  5.68724782e+00  5.68724782e+00
  7.14336212e+00  2.40413323e+01  2.40413323e+01  2.40413323e+01
  3.41902330e+01  1.18823396e+02  1.18823396e+02  1.18823396e+02
  1.38082459e+02  5.02194673e+02  1.86989397e+03  7.99960455e+03
  4.77673201e+04]
E1 = -182.59824119538982  E_coul = 54.066386157996504
cycle= 3 E= -128.531855037393  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981953
diis-c [-9.58195079e-08 -2.15553584e-03 -1.64498984e-04  1.00232003e+00]
  HOMO = -0.845380416254049  LUMO = 1.08909763649229
  mo_energy =
[-3.27690308e+01 -1.92706127e+00 -8.45380416e-01 -8.45380416e-01
 -8.45380416e-01  1.08909764e+00  1.08909764e+00  1.08909764e+00
  1.17079135e+00  5.68703786e+00  5.68703786e+00  5.68703786e+00
  7.14316274e+00  2.40409960e+01  2.40409960e+01  2.40409960e+01
  3.41898975e+01  1.18822954e+02  1.18822954e+02  1.18822954e+02
  1.38082031e+02  5.02194142e+02  1.86989333e+03  7.99960382e+03
  4.77673194e+04]
E1 = -182.59882933685378  E_coul = 54.066974280889355
cycle= 4 E= -128.531855055964  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135772
diis-c [-7.87193674e-10  2.87094929e-04  4.32357256e-04 -1.92741887e-01
  1.19202243e+00]
  HOMO = -0.845411244945293  LUMO = 1.08908520838545
  mo_energy =
[-3.27690850e+01 -1.92708148e+00 -8.45411245e-01 -8.45411245e-01
 -8.45411245e-01  1.08908521e+00  1.08908521e+00  1.08908521e+00
  1.17078147e+00  5.68700306e+00  5.68700306e+00  5.68700306e+00
  7.14313224e+00  2.40409484e+01  2.40409484e+01  2.40409484e+01
  3.41898505e+01  1.18822899e+02  1.18822899e+02  1.18822899e+02
  1.38081976e+02  5.02194080e+02  1.86989326e+03  7.99960374e+03
  4.77673193e+04]
E1 = -182.5989463394893  E_coul = 54.06709128307544
cycle= 5 E= -128.531855056414  delta_E= -4.49e-10  |g|= 5.51e-06  |ddm|= 3.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5989463394893  E_coul = 54.06709128307544
  HOMO = -0.845408349717409  LUMO = 1.08908643192677
  mo_energy =
[-3.27690790e+01 -1.92707787e+00 -8.45408350e-01 -8.45408350e-01
 -8.45408350e-01  1.08908643e+00  1.08908643e+00  1.08908643e+00
  1.17078324e+00  5.68700660e+00  5.68700660e+00  5.68700660e+00
  7.14313609e+00  2.40409538e+01  2.40409538e+01  2.40409538e+01
  3.41898561e+01  1.18822905e+02  1.18822905e+02  1.18822905e+02
  1.38081982e+02  5.02194085e+02  1.86989326e+03  7.99960375e+03
  4.77673193e+04]
E1 = -182.59893289825305  E_coul = 54.06707784183696
Extra cycle  E= -128.531855056416  delta_E= -2.22e-12  |g|= 1.9e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272549e+02 2.35719390e+02
 7.65101961e+01 9.98656006e+00 2.69684125e+01 3.78304675e-01
 1.10154248e+00 2.81942566e+00 3.68293223e+00 1.24427951e+01
 5.47552342e+01 3.30052198e-01 1.14351589e+00]
E = -128.53185505641608
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439307        1
[INPUT] 0    0    [1    /1   ]  833.272549262        1
[INPUT] 0    0    [1    /1   ]  235.719389633        1
[INPUT] 0    0    [1    /1   ]  76.5101960975        1
[INPUT] 0    0    [1    /1   ]  9.98656006104        1
[INPUT] 0    0    [1    /1   ]  26.9684124782        1
[INPUT] 0    0    [1    /1   ]  0.378304674745       1
[INPUT] 0    0    [1    /1   ]  1.10154248152        1
[INPUT] 0    0    [1    /1   ]  2.81942565501        1
[INPUT] 1    0    [1    /1   ]  3.68293222815        1
[INPUT] 1    0    [1    /1   ]  12.4427951224        1
[INPUT] 1    0    [1    /1   ]  54.7552341808        1
[INPUT] 1    0    [1    /1   ]  0.330052198247       1
[INPUT] 1    0    [1    /1   ]  1.14351589399        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413147271, 1.0]], [0, [3661.454393065268, 1.0]], [0, [833.2725492623143, 1.0]], [0, [235.71938963277768, 1.0]], [0, [76.51019609751327, 1.0]], [0, [9.986560061043207, 1.0]], [0, [26.968412478164147, 1.0]], [0, [0.37830467474477303, 1.0]], [0, [1.101542481517903, 1.0]], [0, [2.819425655007223, 1.0]], [1, [3.6829322281547396, 1.0]], [1, [12.442795122400689, 1.0]], [1, [54.75523418081269, 1.0]], [1, [0.3300521982469976, 1.0]], [1, [1.1435158939905703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413147]
bas 1, expnt(s) = [3661.45439307]
bas 2, expnt(s) = [833.27254926]
bas 3, expnt(s) = [235.71938963]
bas 4, expnt(s) = [76.5101961]
bas 5, expnt(s) = [9.98656006]
bas 6, expnt(s) = [26.96841248]
bas 7, expnt(s) = [0.37830467]
bas 8, expnt(s) = [1.10154248]
bas 9, expnt(s) = [2.81942566]
bas 10, expnt(s) = [3.68293223]
bas 11, expnt(s) = [12.44279512]
bas 12, expnt(s) = [54.75523418]
bas 13, expnt(s) = [0.3300522]
bas 14, expnt(s) = [1.14351589]
CPU time:       261.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272549e+02 3.91836899e+02 2.35719390e+02 1.51988772e+02
 7.65101961e+01 6.53588663e+01 9.98656006e+00 1.41930902e+01
 2.69684125e+01 2.98989929e+01 3.78304675e-01 1.21869858e+00
 1.10154248e+00 2.71653911e+00 2.81942566e+00 5.49712370e+00
 3.68293223e+00 1.48842361e+01 1.24427951e+01 6.81760492e+01
 5.47552342e+01 4.34526676e+02 3.30052198e-01 7.29814822e-01
 1.14351589e+00 3.44974623e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998441208631078
cond(S) = 337.4718322037119
E1 = -183.577071742868  E_coul = 55.07844363476482
init E= -128.498628108103
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773948378571414  LUMO = 1.11475668646001
  mo_energy =
[-3.25552937e+01 -1.85277958e+00 -7.73948379e-01 -7.73948379e-01
 -7.73948379e-01  1.11475669e+00  1.11475669e+00  1.11475669e+00
  1.19946656e+00  5.77410078e+00  5.77410078e+00  5.77410078e+00
  7.22866631e+00  2.41984901e+01  2.41984901e+01  2.41984901e+01
  3.43517864e+01  1.19038913e+02  1.19038913e+02  1.19038913e+02
  1.38292509e+02  5.02438042e+02  1.87016811e+03  7.99990526e+03
  4.77676388e+04]
E1 = -182.11232900112424  E_coul = 53.5838181395738
cycle= 1 E= -128.52851086155  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450222
diis-c [-0.20269998  1.        ]
  HOMO = -0.879458813818244  LUMO = 1.07667866203095
  mo_energy =
[-3.28735139e+01 -1.96297163e+00 -8.79458814e-01 -8.79458814e-01
 -8.79458814e-01  1.07667866e+00  1.07667866e+00  1.07667866e+00
  1.15717094e+00  5.64538393e+00  5.64538393e+00  5.64538393e+00
  7.10218487e+00  2.39638693e+01  2.39638693e+01  2.39638693e+01
  3.41102328e+01  1.18718462e+02  1.18718462e+02  1.18718462e+02
  1.37979476e+02  5.02081117e+02  1.86977525e+03  7.99948341e+03
  4.77671981e+04]
E1 = -182.84327198572322  E_coul = 54.31226139885959
cycle= 2 E= -128.531010586864  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224542
diis-c [-6.02521611e-04  3.31767456e-01  6.68232544e-01]
  HOMO = -0.84514332290826  LUMO = 1.08914660065217
  mo_energy =
[-3.27686011e+01 -1.92688319e+00 -8.45143323e-01 -8.45143323e-01
 -8.45143323e-01  1.08914660e+00  1.08914660e+00  1.08914660e+00
  1.17084895e+00  5.68724782e+00  5.68724782e+00  5.68724782e+00
  7.14336212e+00  2.40413323e+01  2.40413323e+01  2.40413323e+01
  3.41902330e+01  1.18823396e+02  1.18823396e+02  1.18823396e+02
  1.38082459e+02  5.02194673e+02  1.86989397e+03  7.99960455e+03
  4.77673201e+04]
E1 = -182.59824119538982  E_coul = 54.066386157996504
cycle= 3 E= -128.531855037393  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981953
diis-c [-9.58195079e-08 -2.15553584e-03 -1.64498984e-04  1.00232003e+00]
  HOMO = -0.845380416254049  LUMO = 1.08909763649229
  mo_energy =
[-3.27690308e+01 -1.92706127e+00 -8.45380416e-01 -8.45380416e-01
 -8.45380416e-01  1.08909764e+00  1.08909764e+00  1.08909764e+00
  1.17079135e+00  5.68703786e+00  5.68703786e+00  5.68703786e+00
  7.14316274e+00  2.40409960e+01  2.40409960e+01  2.40409960e+01
  3.41898975e+01  1.18822954e+02  1.18822954e+02  1.18822954e+02
  1.38082031e+02  5.02194142e+02  1.86989333e+03  7.99960382e+03
  4.77673194e+04]
E1 = -182.59882933685378  E_coul = 54.066974280889355
cycle= 4 E= -128.531855055964  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135772
diis-c [-7.87193674e-10  2.87094929e-04  4.32357256e-04 -1.92741887e-01
  1.19202243e+00]
  HOMO = -0.845411244945293  LUMO = 1.08908520838545
  mo_energy =
[-3.27690850e+01 -1.92708148e+00 -8.45411245e-01 -8.45411245e-01
 -8.45411245e-01  1.08908521e+00  1.08908521e+00  1.08908521e+00
  1.17078147e+00  5.68700306e+00  5.68700306e+00  5.68700306e+00
  7.14313224e+00  2.40409484e+01  2.40409484e+01  2.40409484e+01
  3.41898505e+01  1.18822899e+02  1.18822899e+02  1.18822899e+02
  1.38081976e+02  5.02194080e+02  1.86989326e+03  7.99960374e+03
  4.77673193e+04]
E1 = -182.5989463394893  E_coul = 54.06709128307544
cycle= 5 E= -128.531855056414  delta_E= -4.49e-10  |g|= 5.51e-06  |ddm|= 3.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5989463394893  E_coul = 54.06709128307544
  HOMO = -0.845408349717409  LUMO = 1.08908643192677
  mo_energy =
[-3.27690790e+01 -1.92707787e+00 -8.45408350e-01 -8.45408350e-01
 -8.45408350e-01  1.08908643e+00  1.08908643e+00  1.08908643e+00
  1.17078324e+00  5.68700660e+00  5.68700660e+00  5.68700660e+00
  7.14313609e+00  2.40409538e+01  2.40409538e+01  2.40409538e+01
  3.41898561e+01  1.18822905e+02  1.18822905e+02  1.18822905e+02
  1.38081982e+02  5.02194085e+02  1.86989326e+03  7.99960375e+03
  4.77673193e+04]
E1 = -182.59893289825305  E_coul = 54.06707784183696
Extra cycle  E= -128.531855056416  delta_E= -2.22e-12  |g|= 1.9e-06  |ddm|= 1.83e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.4718322037119
E1 = -182.59893289825305  E_coul = 54.06707784183696
init E= -128.531855056416
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845409294588048  LUMO = 1.08908610325488
  mo_energy =
[-3.27690820e+01 -1.92707874e+00 -8.45409295e-01 -8.45409295e-01
 -8.45409295e-01  1.08908610e+00  1.08908610e+00  1.08908610e+00
  1.17078296e+00  5.68700545e+00  5.68700545e+00  5.68700545e+00
  7.14313503e+00  2.40409516e+01  2.40409516e+01  2.40409516e+01
  3.41898538e+01  1.18822902e+02  1.18822902e+02  1.18822902e+02
  1.38081979e+02  5.02194082e+02  1.86989326e+03  7.99960374e+03
  4.77673193e+04]
E1 = -182.59894017916434  E_coul = 54.067085122748324
cycle= 1 E= -128.531855056416  delta_E= 5.68e-14  |g|= 1e-06  |ddm|= 7.34e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59894017916434  E_coul = 54.067085122748324
  HOMO = -0.845408784293167  LUMO = 1.08908629092769
  mo_energy =
[-3.27690804e+01 -1.92707818e+00 -8.45408784e-01 -8.45408784e-01
 -8.45408784e-01  1.08908629e+00  1.08908629e+00  1.08908629e+00
  1.17078318e+00  5.68700608e+00  5.68700608e+00  5.68700608e+00
  7.14313566e+00  2.40409527e+01  2.40409527e+01  2.40409527e+01
  3.41898550e+01  1.18822904e+02  1.18822904e+02  1.18822904e+02
  1.38081981e+02  5.02194084e+02  1.86989326e+03  7.99960375e+03
  4.77673193e+04]
E1 = -182.59893656904444  E_coul = 54.06708151262809
Extra cycle  E= -128.531855056416  delta_E= -3.41e-13  |g|= 4.91e-07  |ddm|= 3.7e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272549e+02 2.35719390e+02
 7.65101961e+01 9.98656006e+00 2.69684125e+01 3.78304675e-01
 1.10154248e+00 2.81942566e+00 3.68293223e+00 1.24427951e+01
 5.47552342e+01 3.30052198e-01 1.14351589e+00]
grad_E = [ 7.23646331e-10 -3.76255503e-08  7.35762838e-07 -7.80237477e-06
  4.42573959e-05  1.03647898e-04 -9.75358078e-05 -2.36140895e-04
  1.34533475e-04 -7.78966201e-05  5.14427726e-06 -4.36021818e-06
  2.52127269e-07 -3.29456728e-04  5.01719022e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439401        1
[INPUT] 0    0    [1    /1   ]  833.272531026        1
[INPUT] 0    0    [1    /1   ]  235.719574497        1
[INPUT] 0    0    [1    /1   ]  76.5092965912        1
[INPUT] 0    0    [1    /1   ]  9.97844534185        1
[INPUT] 0    0    [1    /1   ]  26.9700504291        1
[INPUT] 0    0    [1    /1   ]  0.378770946708       1
[INPUT] 0    0    [1    /1   ]  1.10443523032        1
[INPUT] 0    0    [1    /1   ]  2.84148853392        1
[INPUT] 1    0    [1    /1   ]  3.68399668156        1
[INPUT] 1    0    [1    /1   ]  12.446443743         1
[INPUT] 1    0    [1    /1   ]  54.764976943         1
[INPUT] 1    0    [1    /1   ]  0.330194462737       1
[INPUT] 1    0    [1    /1   ]  1.14390333087        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131454415, 1.0]], [0, [3661.454394013869, 1.0]], [0, [833.2725310261782, 1.0]], [0, [235.7195744973401, 1.0]], [0, [76.50929659122282, 1.0]], [0, [9.978445341850025, 1.0]], [0, [26.970050429115837, 1.0]], [0, [0.37877094670780664, 1.0]], [0, [1.1044352303243363, 1.0]], [0, [2.8414885339168188, 1.0]], [1, [3.6839966815614376, 1.0]], [1, [12.446443742963657, 1.0]], [1, [54.76497694297543, 1.0]], [1, [0.33019446273669906, 1.0]], [1, [1.143903330869832, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439401]
bas 2, expnt(s) = [833.27253103]
bas 3, expnt(s) = [235.7195745]
bas 4, expnt(s) = [76.50929659]
bas 5, expnt(s) = [9.97844534]
bas 6, expnt(s) = [26.97005043]
bas 7, expnt(s) = [0.37877095]
bas 8, expnt(s) = [1.10443523]
bas 9, expnt(s) = [2.84148853]
bas 10, expnt(s) = [3.68399668]
bas 11, expnt(s) = [12.44644374]
bas 12, expnt(s) = [54.76497694]
bas 13, expnt(s) = [0.33019446]
bas 14, expnt(s) = [1.14390333]
CPU time:       265.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272531e+02 3.91836892e+02 2.35719574e+02 1.51988861e+02
 7.65092966e+01 6.53582900e+01 9.97844534e+00 1.41844397e+01
 2.69700504e+01 2.99003549e+01 3.78770947e-01 1.21982497e+00
 1.10443523e+00 2.72188776e+00 2.84148853e+00 5.52935476e+00
 3.68399668e+00 1.48896137e+01 1.24464437e+01 6.82010393e+01
 5.47649769e+01 4.34623324e+02 3.30194463e-01 7.30208065e-01
 1.14390333e+00 3.45120732e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843782443028
cond(S) = 338.6193742995949
E1 = -183.57714370223977  E_coul = 55.0784574868905
init E= -128.498686215349
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947474034  LUMO = 1.1153144823814
  mo_energy =
[-3.25552935e+01 -1.85277599e+00 -7.73947474e-01 -7.73947474e-01
 -7.73947474e-01  1.11531448e+00  1.11531448e+00  1.11531448e+00
  1.20314392e+00  5.77634950e+00  5.77634950e+00  5.77634950e+00
  7.26800584e+00  2.42071195e+01  2.42071195e+01  2.42071195e+01
  3.44345185e+01  1.19069803e+02  1.19069803e+02  1.19069803e+02
  1.38368735e+02  5.02504075e+02  1.87022635e+03  7.99995632e+03
  4.77676810e+04]
E1 = -182.1126532247421  E_coul = 53.58413993731338
cycle= 1 E= -128.528513287429  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450231
diis-c [-0.2027081  1.       ]
  HOMO = -0.879431746623673  LUMO = 1.07723009807653
  mo_energy =
[-3.28734678e+01 -1.96293849e+00 -8.79431747e-01 -8.79431747e-01
 -8.79431747e-01  1.07723010e+00  1.07723010e+00  1.07723010e+00
  1.16070606e+00  5.64763525e+00  5.64763525e+00  5.64763525e+00
  7.14111643e+00  2.39725153e+01  2.39725153e+01  2.39725153e+01
  3.41929731e+01  1.18749384e+02  1.18749384e+02  1.18749384e+02
  1.38055759e+02  5.02147191e+02  1.86983353e+03  7.99953450e+03
  4.77672404e+04]
E1 = -182.84346141829852  E_coul = 54.31244897247982
cycle= 2 E= -128.531012445819  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224526
diis-c [-6.02867355e-04  3.31746430e-01  6.68253570e-01]
  HOMO = -0.845121738517102  LUMO = 1.08970231170912
  mo_energy =
[-3.27685701e+01 -1.92685592e+00 -8.45121739e-01 -8.45121739e-01
 -8.45121739e-01  1.08970231e+00  1.08970231e+00  1.08970231e+00
  1.17443342e+00  5.68950099e+00  5.68950099e+00  5.68950099e+00
  7.18243347e+00  2.40499741e+01  2.40499741e+01  2.40499741e+01
  3.42729701e+01  1.18854305e+02  1.18854305e+02  1.18854305e+02
  1.38158721e+02  5.02260729e+02  1.86995223e+03  7.99965562e+03
  4.77673624e+04]
E1 = -182.59849529000013  E_coul = 54.06663876558909
cycle= 3 E= -128.531856524411  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000982879
diis-c [-9.61523498e-08 -2.15371143e-03 -1.57316812e-04  1.00231103e+00]
  HOMO = -0.845358236283684  LUMO = 1.08965362622253
  mo_energy =
[-3.27689994e+01 -1.92703327e+00 -8.45358236e-01 -8.45358236e-01
 -8.45358236e-01  1.08965363e+00  1.08965363e+00  1.08965363e+00
  1.17437609e+00  5.68929157e+00  5.68929157e+00  5.68929157e+00
  7.18223429e+00  2.40496383e+01  2.40496383e+01  2.40496383e+01
  3.42726351e+01  1.18853864e+02  1.18853864e+02  1.18853864e+02
  1.38158293e+02  5.02260198e+02  1.86995158e+03  7.99965489e+03
  4.77673616e+04]
E1 = -182.59908459555894  E_coul = 54.067228052631684
cycle= 4 E= -128.531856542927  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135942
diis-c [-7.86776062e-10  2.87783763e-04  4.32245918e-04 -1.93148412e-01
  1.19242838e+00]
  HOMO = -0.845389003499267  LUMO = 1.0896412288195
  mo_energy =
[-3.27690537e+01 -1.92705339e+00 -8.45389003e-01 -8.45389003e-01
 -8.45389003e-01  1.08964123e+00  1.08964123e+00  1.08964123e+00
  1.17436624e+00  5.68925682e+00  5.68925682e+00  5.68925682e+00
  7.18220380e+00  2.40495908e+01  2.40495908e+01  2.40495908e+01
  3.42725881e+01  1.18853809e+02  1.18853809e+02  1.18853809e+02
  1.38158238e+02  5.02260136e+02  1.86995151e+03  7.99965482e+03
  4.77673615e+04]
E1 = -182.59920184473904  E_coul = 54.06734530136188
cycle= 5 E= -128.531856543377  delta_E= -4.5e-10  |g|= 5.52e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59920184473904  E_coul = 54.06734530136188
  HOMO = -0.845386096871376  LUMO = 1.08964245676568
  mo_energy =
[-3.27690476e+01 -1.92704977e+00 -8.45386097e-01 -8.45386097e-01
 -8.45386097e-01  1.08964246e+00  1.08964246e+00  1.08964246e+00
  1.17436803e+00  5.68926037e+00  5.68926037e+00  5.68926037e+00
  7.18220768e+00  2.40495961e+01  2.40495961e+01  2.40495961e+01
  3.42725937e+01  1.18853815e+02  1.18853815e+02  1.18853815e+02
  1.38158244e+02  5.02260142e+02  1.86995152e+03  7.99965482e+03
  4.77673615e+04]
E1 = -182.5991883194207  E_coul = 54.06733177604175
Extra cycle  E= -128.531856543379  delta_E= -1.79e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272531e+02 2.35719574e+02
 7.65092966e+01 9.97844534e+00 2.69700504e+01 3.78770947e-01
 1.10443523e+00 2.84148853e+00 3.68399668e+00 1.24464437e+01
 5.47649769e+01 3.30194463e-01 1.14390333e+00]
E = -128.53185654337895
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439401        1
[INPUT] 0    0    [1    /1   ]  833.272531026        1
[INPUT] 0    0    [1    /1   ]  235.719574497        1
[INPUT] 0    0    [1    /1   ]  76.5092965912        1
[INPUT] 0    0    [1    /1   ]  9.97844534185        1
[INPUT] 0    0    [1    /1   ]  26.9700504291        1
[INPUT] 0    0    [1    /1   ]  0.378770946708       1
[INPUT] 0    0    [1    /1   ]  1.10443523032        1
[INPUT] 0    0    [1    /1   ]  2.84148853392        1
[INPUT] 1    0    [1    /1   ]  3.68399668156        1
[INPUT] 1    0    [1    /1   ]  12.446443743         1
[INPUT] 1    0    [1    /1   ]  54.764976943         1
[INPUT] 1    0    [1    /1   ]  0.330194462737       1
[INPUT] 1    0    [1    /1   ]  1.14390333087        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131454415, 1.0]], [0, [3661.454394013869, 1.0]], [0, [833.2725310261782, 1.0]], [0, [235.7195744973401, 1.0]], [0, [76.50929659122282, 1.0]], [0, [9.978445341850025, 1.0]], [0, [26.970050429115837, 1.0]], [0, [0.37877094670780664, 1.0]], [0, [1.1044352303243363, 1.0]], [0, [2.8414885339168188, 1.0]], [1, [3.6839966815614376, 1.0]], [1, [12.446443742963657, 1.0]], [1, [54.76497694297543, 1.0]], [1, [0.33019446273669906, 1.0]], [1, [1.143903330869832, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439401]
bas 2, expnt(s) = [833.27253103]
bas 3, expnt(s) = [235.7195745]
bas 4, expnt(s) = [76.50929659]
bas 5, expnt(s) = [9.97844534]
bas 6, expnt(s) = [26.97005043]
bas 7, expnt(s) = [0.37877095]
bas 8, expnt(s) = [1.10443523]
bas 9, expnt(s) = [2.84148853]
bas 10, expnt(s) = [3.68399668]
bas 11, expnt(s) = [12.44644374]
bas 12, expnt(s) = [54.76497694]
bas 13, expnt(s) = [0.33019446]
bas 14, expnt(s) = [1.14390333]
CPU time:       266.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272531e+02 3.91836892e+02 2.35719574e+02 1.51988861e+02
 7.65092966e+01 6.53582900e+01 9.97844534e+00 1.41844397e+01
 2.69700504e+01 2.99003549e+01 3.78770947e-01 1.21982497e+00
 1.10443523e+00 2.72188776e+00 2.84148853e+00 5.52935476e+00
 3.68399668e+00 1.48896137e+01 1.24464437e+01 6.82010393e+01
 5.47649769e+01 4.34623324e+02 3.30194463e-01 7.30208065e-01
 1.14390333e+00 3.45120732e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843782443028
cond(S) = 338.6193742995949
E1 = -183.57714370223977  E_coul = 55.0784574868905
init E= -128.498686215349
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773947474034  LUMO = 1.1153144823814
  mo_energy =
[-3.25552935e+01 -1.85277599e+00 -7.73947474e-01 -7.73947474e-01
 -7.73947474e-01  1.11531448e+00  1.11531448e+00  1.11531448e+00
  1.20314392e+00  5.77634950e+00  5.77634950e+00  5.77634950e+00
  7.26800584e+00  2.42071195e+01  2.42071195e+01  2.42071195e+01
  3.44345185e+01  1.19069803e+02  1.19069803e+02  1.19069803e+02
  1.38368735e+02  5.02504075e+02  1.87022635e+03  7.99995632e+03
  4.77676810e+04]
E1 = -182.1126532247421  E_coul = 53.58413993731338
cycle= 1 E= -128.528513287429  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450231
diis-c [-0.2027081  1.       ]
  HOMO = -0.879431746623673  LUMO = 1.07723009807653
  mo_energy =
[-3.28734678e+01 -1.96293849e+00 -8.79431747e-01 -8.79431747e-01
 -8.79431747e-01  1.07723010e+00  1.07723010e+00  1.07723010e+00
  1.16070606e+00  5.64763525e+00  5.64763525e+00  5.64763525e+00
  7.14111643e+00  2.39725153e+01  2.39725153e+01  2.39725153e+01
  3.41929731e+01  1.18749384e+02  1.18749384e+02  1.18749384e+02
  1.38055759e+02  5.02147191e+02  1.86983353e+03  7.99953450e+03
  4.77672404e+04]
E1 = -182.84346141829852  E_coul = 54.31244897247982
cycle= 2 E= -128.531012445819  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224526
diis-c [-6.02867355e-04  3.31746430e-01  6.68253570e-01]
  HOMO = -0.845121738517102  LUMO = 1.08970231170912
  mo_energy =
[-3.27685701e+01 -1.92685592e+00 -8.45121739e-01 -8.45121739e-01
 -8.45121739e-01  1.08970231e+00  1.08970231e+00  1.08970231e+00
  1.17443342e+00  5.68950099e+00  5.68950099e+00  5.68950099e+00
  7.18243347e+00  2.40499741e+01  2.40499741e+01  2.40499741e+01
  3.42729701e+01  1.18854305e+02  1.18854305e+02  1.18854305e+02
  1.38158721e+02  5.02260729e+02  1.86995223e+03  7.99965562e+03
  4.77673624e+04]
E1 = -182.59849529000013  E_coul = 54.06663876558909
cycle= 3 E= -128.531856524411  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000982879
diis-c [-9.61523498e-08 -2.15371143e-03 -1.57316812e-04  1.00231103e+00]
  HOMO = -0.845358236283684  LUMO = 1.08965362622253
  mo_energy =
[-3.27689994e+01 -1.92703327e+00 -8.45358236e-01 -8.45358236e-01
 -8.45358236e-01  1.08965363e+00  1.08965363e+00  1.08965363e+00
  1.17437609e+00  5.68929157e+00  5.68929157e+00  5.68929157e+00
  7.18223429e+00  2.40496383e+01  2.40496383e+01  2.40496383e+01
  3.42726351e+01  1.18853864e+02  1.18853864e+02  1.18853864e+02
  1.38158293e+02  5.02260198e+02  1.86995158e+03  7.99965489e+03
  4.77673616e+04]
E1 = -182.59908459555894  E_coul = 54.067228052631684
cycle= 4 E= -128.531856542927  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135942
diis-c [-7.86776062e-10  2.87783763e-04  4.32245918e-04 -1.93148412e-01
  1.19242838e+00]
  HOMO = -0.845389003499267  LUMO = 1.0896412288195
  mo_energy =
[-3.27690537e+01 -1.92705339e+00 -8.45389003e-01 -8.45389003e-01
 -8.45389003e-01  1.08964123e+00  1.08964123e+00  1.08964123e+00
  1.17436624e+00  5.68925682e+00  5.68925682e+00  5.68925682e+00
  7.18220380e+00  2.40495908e+01  2.40495908e+01  2.40495908e+01
  3.42725881e+01  1.18853809e+02  1.18853809e+02  1.18853809e+02
  1.38158238e+02  5.02260136e+02  1.86995151e+03  7.99965482e+03
  4.77673615e+04]
E1 = -182.59920184473904  E_coul = 54.06734530136188
cycle= 5 E= -128.531856543377  delta_E= -4.5e-10  |g|= 5.52e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59920184473904  E_coul = 54.06734530136188
  HOMO = -0.845386096871376  LUMO = 1.08964245676568
  mo_energy =
[-3.27690476e+01 -1.92704977e+00 -8.45386097e-01 -8.45386097e-01
 -8.45386097e-01  1.08964246e+00  1.08964246e+00  1.08964246e+00
  1.17436803e+00  5.68926037e+00  5.68926037e+00  5.68926037e+00
  7.18220768e+00  2.40495961e+01  2.40495961e+01  2.40495961e+01
  3.42725937e+01  1.18853815e+02  1.18853815e+02  1.18853815e+02
  1.38158244e+02  5.02260142e+02  1.86995152e+03  7.99965482e+03
  4.77673615e+04]
E1 = -182.5991883194207  E_coul = 54.06733177604175
Extra cycle  E= -128.531856543379  delta_E= -1.79e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 338.6193742995949
E1 = -182.5991883194207  E_coul = 54.06733177604175
init E= -128.531856543379
    CPU time for initialize scf      0.19 sec, wall time      0.19 sec
  HOMO = -0.845387047577435  LUMO = 1.0896421257485
  mo_energy =
[-3.27690506e+01 -1.92705065e+00 -8.45387048e-01 -8.45387048e-01
 -8.45387048e-01  1.08964213e+00  1.08964213e+00  1.08964213e+00
  1.17436773e+00  5.68925922e+00  5.68925922e+00  5.68925922e+00
  7.18220660e+00  2.40495939e+01  2.40495939e+01  2.40495939e+01
  3.42725915e+01  1.18853812e+02  1.18853812e+02  1.18853812e+02
  1.38158241e+02  5.02260138e+02  1.86995152e+03  7.99965482e+03
  4.77673615e+04]
E1 = -182.59919564035152  E_coul = 54.0673390969721
cycle= 1 E= -128.531856543379  delta_E= -4.83e-13  |g|= 1.01e-06  |ddm|= 7.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59919564035152  E_coul = 54.0673390969721
  HOMO = -0.845386534451342  LUMO = 1.08964231453338
  mo_energy =
[-3.27690490e+01 -1.92705009e+00 -8.45386534e-01 -8.45386534e-01
 -8.45386534e-01  1.08964231e+00  1.08964231e+00  1.08964231e+00
  1.17436795e+00  5.68925985e+00  5.68925985e+00  5.68925985e+00
  7.18220724e+00  2.40495951e+01  2.40495951e+01  2.40495951e+01
  3.42725927e+01  1.18853813e+02  1.18853813e+02  1.18853813e+02
  1.38158243e+02  5.02260140e+02  1.86995152e+03  7.99965482e+03
  4.77673615e+04]
E1 = -182.59919201012738  E_coul = 54.067335466748155
Extra cycle  E= -128.531856543379  delta_E= 1.99e-13  |g|= 4.94e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.25 sec, wall time      0.24 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272531e+02 2.35719574e+02
 7.65092966e+01 9.97844534e+00 2.69700504e+01 3.78770947e-01
 1.10443523e+00 2.84148853e+00 3.68399668e+00 1.24464437e+01
 5.47649769e+01 3.30194463e-01 1.14390333e+00]
grad_E = [ 6.27713059e-10 -3.26074667e-08  6.34581669e-07 -6.61067714e-06
  3.49424718e-05  1.00678372e-05 -5.33803058e-05 -4.22630919e-05
  2.04999043e-05 -1.36928091e-05 -1.32853936e-06 -3.72321054e-07
 -1.63623914e-07 -5.53604124e-05  1.47700179e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439417        1
[INPUT] 0    0    [1    /1   ]  833.272527776        1
[INPUT] 0    0    [1    /1   ]  235.719617196        1
[INPUT] 0    0    [1    /1   ]  76.5089112096        1
[INPUT] 0    0    [1    /1   ]  9.97507660232        1
[INPUT] 0    0    [1    /1   ]  26.9721779057        1
[INPUT] 0    0    [1    /1   ]  0.378598071663       1
[INPUT] 0    0    [1    /1   ]  1.10368509387        1
[INPUT] 0    0    [1    /1   ]  2.84152975539        1
[INPUT] 1    0    [1    /1   ]  3.6837373717         1
[INPUT] 1    0    [1    /1   ]  12.4451079172        1
[INPUT] 1    0    [1    /1   ]  54.7545266207        1
[INPUT] 1    0    [1    /1   ]  0.330197602905       1
[INPUT] 1    0    [1    /1   ]  1.14385334783        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131451454, 1.0]], [0, [3661.4543941719917, 1.0]], [0, [833.2725277759026, 1.0]], [0, [235.71961719625727, 1.0]], [0, [76.50891120961325, 1.0]], [0, [9.97507660231564, 1.0]], [0, [26.972177905726888, 1.0]], [0, [0.3785980716625105, 1.0]], [0, [1.1036850938722749, 1.0]], [0, [2.841529755394355, 1.0]], [1, [3.6837373717026995, 1.0]], [1, [12.445107917159463, 1.0]], [1, [54.754526620655994, 1.0]], [1, [0.33019760290535904, 1.0]], [1, [1.1438533478309634, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439417]
bas 2, expnt(s) = [833.27252778]
bas 3, expnt(s) = [235.7196172]
bas 4, expnt(s) = [76.50891121]
bas 5, expnt(s) = [9.9750766]
bas 6, expnt(s) = [26.97217791]
bas 7, expnt(s) = [0.37859807]
bas 8, expnt(s) = [1.10368509]
bas 9, expnt(s) = [2.84152976]
bas 10, expnt(s) = [3.68373737]
bas 11, expnt(s) = [12.44510792]
bas 12, expnt(s) = [54.75452662]
bas 13, expnt(s) = [0.3301976]
bas 14, expnt(s) = [1.14385335]
CPU time:       269.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272528e+02 3.91836891e+02 2.35719617e+02 1.51988882e+02
 7.65089112e+01 6.53580431e+01 9.97507660e+00 1.41808481e+01
 2.69721779e+01 2.99021238e+01 3.78598072e-01 1.21940739e+00
 1.10368509e+00 2.72050111e+00 2.84152976e+00 5.52941492e+00
 3.68373737e+00 1.48883036e+01 1.24451079e+01 6.81918898e+01
 5.47545266e+01 4.34519657e+02 3.30197603e-01 7.30216745e-01
 1.14385335e+00 3.45101881e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438216055584
cond(S) = 338.3720480555595
E1 = -183.57716358263625  E_coul = 55.07846052785668
init E= -128.49870305478
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947318913987  LUMO = 1.11530709155947
  mo_energy =
[-3.25552925e+01 -1.85277610e+00 -7.73947319e-01 -7.73947319e-01
 -7.73947319e-01  1.11530709e+00  1.11530709e+00  1.11530709e+00
  1.20226835e+00  5.77605920e+00  5.77605920e+00  5.77605920e+00
  7.26459841e+00  2.42048549e+01  2.42048549e+01  2.42048549e+01
  3.44256219e+01  1.19048633e+02  1.19048633e+02  1.19048633e+02
  1.38357893e+02  5.02494816e+02  1.87021821e+03  7.99994919e+03
  4.77676751e+04]
E1 = -182.11267543750233  E_coul = 53.58416208012848
cycle= 1 E= -128.528513357374  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450254
diis-c [-0.20272855  1.        ]
  HOMO = -0.879429602857184  LUMO = 1.07722478631668
  mo_energy =
[-3.28734659e+01 -1.96293576e+00 -8.79429603e-01 -8.79429603e-01
 -8.79429603e-01  1.07722479e+00  1.07722479e+00  1.07722479e+00
  1.15985927e+00  5.64735309e+00  5.64735309e+00  5.64735309e+00
  7.13773503e+00  2.39702604e+01  2.39702604e+01  2.39702604e+01
  3.41840860e+01  1.18728222e+02  1.18728222e+02  1.18728222e+02
  1.38044915e+02  5.02137930e+02  1.86982538e+03  7.99952736e+03
  4.77672345e+04]
E1 = -182.84348712679258  E_coul = 54.31247458351128
cycle= 2 E= -128.531012543281  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224535
diis-c [-6.02811228e-04  3.31744174e-01  6.68255826e-01]
  HOMO = -0.845119262815755  LUMO = 1.08969675237061
  mo_energy =
[-3.27685675e+01 -1.92685290e+00 -8.45119263e-01 -8.45119263e-01
 -8.45119263e-01  1.08969675e+00  1.08969675e+00  1.08969675e+00
  1.17357810e+00  5.68921704e+00  5.68921704e+00  5.68921704e+00
  7.17904486e+00  2.40477168e+01  2.40477168e+01  2.40477168e+01
  3.42640804e+01  1.18833141e+02  1.18833141e+02  1.18833141e+02
  1.38147878e+02  5.02251470e+02  1.86994408e+03  7.99964848e+03
  4.77673565e+04]
E1 = -182.59852160835916  E_coul = 54.06666498960947
cycle= 3 E= -128.53185661875  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983298
diis-c [-9.63101136e-08 -2.15333303e-03 -1.55153516e-04  1.00230849e+00]
  HOMO = -0.845355697906502  LUMO = 1.08964810377857
  mo_energy =
[-3.27689969e+01 -1.92703015e+00 -8.45355698e-01 -8.45355698e-01
 -8.45355698e-01  1.08964810e+00  1.08964810e+00  1.08964810e+00
  1.17352089e+00  5.68900769e+00  5.68900769e+00  5.68900769e+00
  7.17884583e+00  2.40473811e+01  2.40473811e+01  2.40473811e+01
  3.42637454e+01  1.18832700e+02  1.18832700e+02  1.18832700e+02
  1.38147450e+02  5.02250938e+02  1.86994344e+03  7.99964775e+03
  4.77673557e+04]
E1 = -182.59911118994592  E_coul = 54.06725455267615
cycle= 4 E= -128.53185663727  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136019
diis-c [-7.86890532e-10  2.87921196e-04  4.32134783e-04 -1.93256954e-01
  1.19253690e+00]
  HOMO = -0.845386468998925  LUMO = 1.08963570617419
  mo_energy =
[-3.27690512e+01 -1.92705027e+00 -8.45386469e-01 -8.45386469e-01
 -8.45386469e-01  1.08963571e+00  1.08963571e+00  1.08963571e+00
  1.17351105e+00  5.68897294e+00  5.68897294e+00  5.68897294e+00
  7.17881535e+00  2.40473335e+01  2.40473335e+01  2.40473335e+01
  3.42636984e+01  1.18832645e+02  1.18832645e+02  1.18832645e+02
  1.38147395e+02  5.02250876e+02  1.86994337e+03  7.99964768e+03
  4.77673556e+04]
E1 = -182.5992285024112  E_coul = 54.067371864691026
cycle= 5 E= -128.53185663772  delta_E= -4.5e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5992285024112  E_coul = 54.067371864691026
  HOMO = -0.845383559310555  LUMO = 1.08963693521881
  mo_energy =
[-3.27690451e+01 -1.92704665e+00 -8.45383559e-01 -8.45383559e-01
 -8.45383559e-01  1.08963694e+00  1.08963694e+00  1.08963694e+00
  1.17351283e+00  5.68897650e+00  5.68897650e+00  5.68897650e+00
  7.17881922e+00  2.40473388e+01  2.40473388e+01  2.40473388e+01
  3.42637040e+01  1.18832651e+02  1.18832651e+02  1.18832651e+02
  1.38147401e+02  5.02250882e+02  1.86994337e+03  7.99964768e+03
  4.77673556e+04]
E1 = -182.59921495643562  E_coul = 54.067358318713694
Extra cycle  E= -128.531856637722  delta_E= -1.73e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272528e+02 2.35719617e+02
 7.65089112e+01 9.97507660e+00 2.69721779e+01 3.78598072e-01
 1.10368509e+00 2.84152976e+00 3.68373737e+00 1.24451079e+01
 5.47545266e+01 3.30197603e-01 1.14385335e+00]
E = -128.53185663772192
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439417        1
[INPUT] 0    0    [1    /1   ]  833.272527776        1
[INPUT] 0    0    [1    /1   ]  235.719617196        1
[INPUT] 0    0    [1    /1   ]  76.5089112096        1
[INPUT] 0    0    [1    /1   ]  9.97507660232        1
[INPUT] 0    0    [1    /1   ]  26.9721779057        1
[INPUT] 0    0    [1    /1   ]  0.378598071663       1
[INPUT] 0    0    [1    /1   ]  1.10368509387        1
[INPUT] 0    0    [1    /1   ]  2.84152975539        1
[INPUT] 1    0    [1    /1   ]  3.6837373717         1
[INPUT] 1    0    [1    /1   ]  12.4451079172        1
[INPUT] 1    0    [1    /1   ]  54.7545266207        1
[INPUT] 1    0    [1    /1   ]  0.330197602905       1
[INPUT] 1    0    [1    /1   ]  1.14385334783        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131451454, 1.0]], [0, [3661.4543941719917, 1.0]], [0, [833.2725277759026, 1.0]], [0, [235.71961719625727, 1.0]], [0, [76.50891120961325, 1.0]], [0, [9.97507660231564, 1.0]], [0, [26.972177905726888, 1.0]], [0, [0.3785980716625105, 1.0]], [0, [1.1036850938722749, 1.0]], [0, [2.841529755394355, 1.0]], [1, [3.6837373717026995, 1.0]], [1, [12.445107917159463, 1.0]], [1, [54.754526620655994, 1.0]], [1, [0.33019760290535904, 1.0]], [1, [1.1438533478309634, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439417]
bas 2, expnt(s) = [833.27252778]
bas 3, expnt(s) = [235.7196172]
bas 4, expnt(s) = [76.50891121]
bas 5, expnt(s) = [9.9750766]
bas 6, expnt(s) = [26.97217791]
bas 7, expnt(s) = [0.37859807]
bas 8, expnt(s) = [1.10368509]
bas 9, expnt(s) = [2.84152976]
bas 10, expnt(s) = [3.68373737]
bas 11, expnt(s) = [12.44510792]
bas 12, expnt(s) = [54.75452662]
bas 13, expnt(s) = [0.3301976]
bas 14, expnt(s) = [1.14385335]
CPU time:       270.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272528e+02 3.91836891e+02 2.35719617e+02 1.51988882e+02
 7.65089112e+01 6.53580431e+01 9.97507660e+00 1.41808481e+01
 2.69721779e+01 2.99021238e+01 3.78598072e-01 1.21940739e+00
 1.10368509e+00 2.72050111e+00 2.84152976e+00 5.52941492e+00
 3.68373737e+00 1.48883036e+01 1.24451079e+01 6.81918898e+01
 5.47545266e+01 4.34519657e+02 3.30197603e-01 7.30216745e-01
 1.14385335e+00 3.45101881e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438216055584
cond(S) = 338.3720480555595
E1 = -183.57716358263625  E_coul = 55.07846052785668
init E= -128.49870305478
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773947318913987  LUMO = 1.11530709155947
  mo_energy =
[-3.25552925e+01 -1.85277610e+00 -7.73947319e-01 -7.73947319e-01
 -7.73947319e-01  1.11530709e+00  1.11530709e+00  1.11530709e+00
  1.20226835e+00  5.77605920e+00  5.77605920e+00  5.77605920e+00
  7.26459841e+00  2.42048549e+01  2.42048549e+01  2.42048549e+01
  3.44256219e+01  1.19048633e+02  1.19048633e+02  1.19048633e+02
  1.38357893e+02  5.02494816e+02  1.87021821e+03  7.99994919e+03
  4.77676751e+04]
E1 = -182.11267543750233  E_coul = 53.58416208012848
cycle= 1 E= -128.528513357374  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450254
diis-c [-0.20272855  1.        ]
  HOMO = -0.879429602857184  LUMO = 1.07722478631668
  mo_energy =
[-3.28734659e+01 -1.96293576e+00 -8.79429603e-01 -8.79429603e-01
 -8.79429603e-01  1.07722479e+00  1.07722479e+00  1.07722479e+00
  1.15985927e+00  5.64735309e+00  5.64735309e+00  5.64735309e+00
  7.13773503e+00  2.39702604e+01  2.39702604e+01  2.39702604e+01
  3.41840860e+01  1.18728222e+02  1.18728222e+02  1.18728222e+02
  1.38044915e+02  5.02137930e+02  1.86982538e+03  7.99952736e+03
  4.77672345e+04]
E1 = -182.84348712679258  E_coul = 54.31247458351128
cycle= 2 E= -128.531012543281  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224535
diis-c [-6.02811228e-04  3.31744174e-01  6.68255826e-01]
  HOMO = -0.845119262815755  LUMO = 1.08969675237061
  mo_energy =
[-3.27685675e+01 -1.92685290e+00 -8.45119263e-01 -8.45119263e-01
 -8.45119263e-01  1.08969675e+00  1.08969675e+00  1.08969675e+00
  1.17357810e+00  5.68921704e+00  5.68921704e+00  5.68921704e+00
  7.17904486e+00  2.40477168e+01  2.40477168e+01  2.40477168e+01
  3.42640804e+01  1.18833141e+02  1.18833141e+02  1.18833141e+02
  1.38147878e+02  5.02251470e+02  1.86994408e+03  7.99964848e+03
  4.77673565e+04]
E1 = -182.59852160835916  E_coul = 54.06666498960947
cycle= 3 E= -128.53185661875  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983298
diis-c [-9.63101136e-08 -2.15333303e-03 -1.55153516e-04  1.00230849e+00]
  HOMO = -0.845355697906502  LUMO = 1.08964810377857
  mo_energy =
[-3.27689969e+01 -1.92703015e+00 -8.45355698e-01 -8.45355698e-01
 -8.45355698e-01  1.08964810e+00  1.08964810e+00  1.08964810e+00
  1.17352089e+00  5.68900769e+00  5.68900769e+00  5.68900769e+00
  7.17884583e+00  2.40473811e+01  2.40473811e+01  2.40473811e+01
  3.42637454e+01  1.18832700e+02  1.18832700e+02  1.18832700e+02
  1.38147450e+02  5.02250938e+02  1.86994344e+03  7.99964775e+03
  4.77673557e+04]
E1 = -182.59911118994592  E_coul = 54.06725455267615
cycle= 4 E= -128.53185663727  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136019
diis-c [-7.86890532e-10  2.87921196e-04  4.32134783e-04 -1.93256954e-01
  1.19253690e+00]
  HOMO = -0.845386468998925  LUMO = 1.08963570617419
  mo_energy =
[-3.27690512e+01 -1.92705027e+00 -8.45386469e-01 -8.45386469e-01
 -8.45386469e-01  1.08963571e+00  1.08963571e+00  1.08963571e+00
  1.17351105e+00  5.68897294e+00  5.68897294e+00  5.68897294e+00
  7.17881535e+00  2.40473335e+01  2.40473335e+01  2.40473335e+01
  3.42636984e+01  1.18832645e+02  1.18832645e+02  1.18832645e+02
  1.38147395e+02  5.02250876e+02  1.86994337e+03  7.99964768e+03
  4.77673556e+04]
E1 = -182.5992285024112  E_coul = 54.067371864691026
cycle= 5 E= -128.53185663772  delta_E= -4.5e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5992285024112  E_coul = 54.067371864691026
  HOMO = -0.845383559310555  LUMO = 1.08963693521881
  mo_energy =
[-3.27690451e+01 -1.92704665e+00 -8.45383559e-01 -8.45383559e-01
 -8.45383559e-01  1.08963694e+00  1.08963694e+00  1.08963694e+00
  1.17351283e+00  5.68897650e+00  5.68897650e+00  5.68897650e+00
  7.17881922e+00  2.40473388e+01  2.40473388e+01  2.40473388e+01
  3.42637040e+01  1.18832651e+02  1.18832651e+02  1.18832651e+02
  1.38147401e+02  5.02250882e+02  1.86994337e+03  7.99964768e+03
  4.77673556e+04]
E1 = -182.59921495643562  E_coul = 54.067358318713694
Extra cycle  E= -128.531856637722  delta_E= -1.73e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 338.3720480555595
E1 = -182.59921495643562  E_coul = 54.067358318713694
init E= -128.531856637722
    CPU time for initialize scf      0.20 sec, wall time      0.19 sec
  HOMO = -0.845384511460329  LUMO = 1.08963660368598
  mo_energy =
[-3.27690481e+01 -1.92704753e+00 -8.45384511e-01 -8.45384511e-01
 -8.45384511e-01  1.08963660e+00  1.08963660e+00  1.08963660e+00
  1.17351254e+00  5.68897534e+00  5.68897534e+00  5.68897534e+00
  7.17881815e+00  2.40473367e+01  2.40473367e+01  2.40473367e+01
  3.42637018e+01  1.18832648e+02  1.18832648e+02  1.18832648e+02
  1.38147398e+02  5.02250878e+02  1.86994337e+03  7.99964768e+03
  4.77673556e+04]
E1 = -182.59922228768895  E_coul = 54.067365649966675
cycle= 1 E= -128.531856637722  delta_E= -3.69e-13  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59922228768895  E_coul = 54.067365649966675
  HOMO = -0.845383997604983  LUMO = 1.08963679272976
  mo_energy =
[-3.27690465e+01 -1.92704696e+00 -8.45383998e-01 -8.45383998e-01
 -8.45383998e-01  1.08963679e+00  1.08963679e+00  1.08963679e+00
  1.17351276e+00  5.68897597e+00  5.68897597e+00  5.68897597e+00
  7.17881878e+00  2.40473378e+01  2.40473378e+01  2.40473378e+01
  3.42637030e+01  1.18832649e+02  1.18832649e+02  1.18832649e+02
  1.38147400e+02  5.02250880e+02  1.86994337e+03  7.99964768e+03
  4.77673556e+04]
E1 = -182.5992186522731  E_coul = 54.067362014550426
Extra cycle  E= -128.531856637723  delta_E= -3.98e-13  |g|= 4.94e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.25 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272528e+02 2.35719617e+02
 7.65089112e+01 9.97507660e+00 2.69721779e+01 3.78598072e-01
 1.10368509e+00 2.84152976e+00 3.68373737e+00 1.24451079e+01
 5.47545266e+01 3.30197603e-01 1.14385335e+00]
grad_E = [ 5.86940340e-10 -3.04746890e-08  5.91784615e-07 -6.11351929e-06
  3.12378055e-05 -1.81696708e-05 -3.74531022e-05  1.23613764e-05
 -1.12653420e-05 -1.39667198e-06 -9.49649959e-08  4.44329245e-08
 -3.76645340e-07  1.42621596e-05 -3.54869165e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439418        1
[INPUT] 0    0    [1    /1   ]  833.272527501        1
[INPUT] 0    0    [1    /1   ]  235.719623694        1
[INPUT] 0    0    [1    /1   ]  76.5088126886        1
[INPUT] 0    0    [1    /1   ]  9.97436633133        1
[INPUT] 0    0    [1    /1   ]  26.9728799628        1
[INPUT] 0    0    [1    /1   ]  0.378506168581       1
[INPUT] 0    0    [1    /1   ]  1.10325069014        1
[INPUT] 0    0    [1    /1   ]  2.83990554289        1
[INPUT] 1    0    [1    /1   ]  3.68371032152        1
[INPUT] 1    0    [1    /1   ]  12.4449805219        1
[INPUT] 1    0    [1    /1   ]  54.7540641664        1
[INPUT] 1    0    [1    /1   ]  0.330194926796       1
[INPUT] 1    0    [1    /1   ]  1.14384492118        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413145129, 1.0]], [0, [3661.4543941820234, 1.0]], [0, [833.2725275014675, 1.0]], [0, [235.71962369372946, 1.0]], [0, [76.50881268861647, 1.0]], [0, [9.974366331334153, 1.0]], [0, [26.97287996277357, 1.0]], [0, [0.37850616858119174, 1.0]], [0, [1.1032506901414356, 1.0]], [0, [2.8399055428920756, 1.0]], [1, [3.6837103215236695, 1.0]], [1, [12.444980521866185, 1.0]], [1, [54.75406416636538, 1.0]], [1, [0.3301949267962264, 1.0]], [1, [1.1438449211768893, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439418]
bas 2, expnt(s) = [833.2725275]
bas 3, expnt(s) = [235.71962369]
bas 4, expnt(s) = [76.50881269]
bas 5, expnt(s) = [9.97436633]
bas 6, expnt(s) = [26.97287996]
bas 7, expnt(s) = [0.37850617]
bas 8, expnt(s) = [1.10325069]
bas 9, expnt(s) = [2.83990554]
bas 10, expnt(s) = [3.68371032]
bas 11, expnt(s) = [12.44498052]
bas 12, expnt(s) = [54.75406417]
bas 13, expnt(s) = [0.33019493]
bas 14, expnt(s) = [1.14384492]
CPU time:       273.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272528e+02 3.91836891e+02 2.35719624e+02 1.51988885e+02
 7.65088127e+01 6.53579800e+01 9.97436633e+00 1.41800907e+01
 2.69728800e+01 2.99027076e+01 3.78506169e-01 1.21918538e+00
 1.10325069e+00 2.71969799e+00 2.83990554e+00 5.52704430e+00
 3.68371032e+00 1.48881670e+01 1.24449805e+01 6.81910172e+01
 5.47540642e+01 4.34515070e+02 3.30194927e-01 7.30209347e-01
 1.14384492e+00 3.45098704e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438391960462
cond(S) = 338.2050966329922
E1 = -183.57716533296434  E_coul = 55.07846012717244
init E= -128.498705205792
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773947353832944  LUMO = 1.11529619728931
  mo_energy =
[-3.25552923e+01 -1.85277640e+00 -7.73947354e-01 -7.73947354e-01
 -7.73947354e-01  1.11529620e+00  1.11529620e+00  1.11529620e+00
  1.20172200e+00  5.77600965e+00  5.77600965e+00  5.77600965e+00
  7.26062231e+00  2.42046080e+01  2.42046080e+01  2.42046080e+01
  3.44163649e+01  1.19047414e+02  1.19047414e+02  1.19047414e+02
  1.38348304e+02  5.02486532e+02  1.87021090e+03  7.99994278e+03
  4.77676698e+04]
E1 = -182.11266455715986  E_coul = 53.58415123016017
cycle= 1 E= -128.528513327  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450256
diis-c [-0.20273037  1.        ]
  HOMO = -0.879430512026041  LUMO = 1.0772137772067
  mo_energy =
[-3.28734677e+01 -1.96293670e+00 -8.79430512e-01 -8.79430512e-01
 -8.79430512e-01  1.07721378e+00  1.07721378e+00  1.07721378e+00
  1.15933264e+00  5.64730323e+00  5.64730323e+00  5.64730323e+00
  7.13379813e+00  2.39700126e+01  2.39700126e+01  2.39700126e+01
  3.41748334e+01  1.18727001e+02  1.18727001e+02  1.18727001e+02
  1.38035322e+02  5.02129644e+02  1.86981807e+03  7.99952095e+03
  4.77672292e+04]
E1 = -182.8434811721846  E_coul = 54.31246863489241
cycle= 2 E= -128.531012537292  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224536
diis-c [-6.02761379e-04  3.31744178e-01  6.68255822e-01]
  HOMO = -0.845119928750728  LUMO = 1.0896857051216
  mo_energy =
[-3.27685686e+01 -1.92685361e+00 -8.45119929e-01 -8.45119929e-01
 -8.45119929e-01  1.08968571e+00  1.08968571e+00  1.08968571e+00
  1.17304505e+00  5.68916725e+00  5.68916725e+00  5.68916725e+00
  7.17509495e+00  2.40474692e+01  2.40474692e+01  2.40474692e+01
  3.42548263e+01  1.18831921e+02  1.18831921e+02  1.18831921e+02
  1.38138287e+02  5.02243184e+02  1.86993677e+03  7.99964207e+03
  4.77673512e+04]
E1 = -182.59851306176182  E_coul = 54.06665643576869
cycle= 3 E= -128.531856625993  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983545
diis-c [-9.63712934e-08 -2.15351539e-03 -1.54515588e-04  1.00230803e+00]
  HOMO = -0.845356428820362  LUMO = 1.08963702816686
  mo_energy =
[-3.27689981e+01 -1.92703091e+00 -8.45356429e-01 -8.45356429e-01
 -8.45356429e-01  1.08963703e+00  1.08963703e+00  1.08963703e+00
  1.17298784e+00  5.68895783e+00  5.68895783e+00  5.68895783e+00
  7.17489591e+00  2.40471334e+01  2.40471334e+01  2.40471334e+01
  3.42544912e+01  1.18831479e+02  1.18831479e+02  1.18831479e+02
  1.38137858e+02  5.02242652e+02  1.86993613e+03  7.99964134e+03
  4.77673504e+04]
E1 = -182.59910279499294  E_coul = 54.06724615046544
cycle= 4 E= -128.531856644528  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136048
diis-c [-7.87147274e-10  2.87969067e-04  4.32061690e-04 -1.93282431e-01
  1.19256240e+00]
  HOMO = -0.845387209657491  LUMO = 1.0896246263064
  mo_energy =
[-3.27690524e+01 -1.92705103e+00 -8.45387210e-01 -8.45387210e-01
 -8.45387210e-01  1.08962463e+00  1.08962463e+00  1.08962463e+00
  1.17297800e+00  5.68892307e+00  5.68892307e+00  5.68892307e+00
  7.17486542e+00  2.40470858e+01  2.40470858e+01  2.40470858e+01
  3.42544442e+01  1.18831425e+02  1.18831425e+02  1.18831425e+02
  1.38137804e+02  5.02242590e+02  1.86993606e+03  7.99964127e+03
  4.77673503e+04]
E1 = -182.5992201215111  E_coul = 54.06736347653289
cycle= 5 E= -128.531856644978  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5992201215111  E_coul = 54.06736347653289
  HOMO = -0.845384299112761  LUMO = 1.08962585571845
  mo_energy =
[-3.27690463e+01 -1.92704741e+00 -8.45384299e-01 -8.45384299e-01
 -8.45384299e-01  1.08962586e+00  1.08962586e+00  1.08962586e+00
  1.17297979e+00  5.68892662e+00  5.68892662e+00  5.68892662e+00
  7.17486930e+00  2.40470912e+01  2.40470912e+01  2.40470912e+01
  3.42544498e+01  1.18831431e+02  1.18831431e+02  1.18831431e+02
  1.38137810e+02  5.02242596e+02  1.86993606e+03  7.99964127e+03
  4.77673503e+04]
E1 = -182.59920657251305  E_coul = 54.06734992753289
Extra cycle  E= -128.53185664498  delta_E= -1.93e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272528e+02 2.35719624e+02
 7.65088127e+01 9.97436633e+00 2.69728800e+01 3.78506169e-01
 1.10325069e+00 2.83990554e+00 3.68371032e+00 1.24449805e+01
 5.47540642e+01 3.30194927e-01 1.14384492e+00]
E = -128.53185664498017
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439418        1
[INPUT] 0    0    [1    /1   ]  833.272527501        1
[INPUT] 0    0    [1    /1   ]  235.719623694        1
[INPUT] 0    0    [1    /1   ]  76.5088126886        1
[INPUT] 0    0    [1    /1   ]  9.97436633133        1
[INPUT] 0    0    [1    /1   ]  26.9728799628        1
[INPUT] 0    0    [1    /1   ]  0.378506168581       1
[INPUT] 0    0    [1    /1   ]  1.10325069014        1
[INPUT] 0    0    [1    /1   ]  2.83990554289        1
[INPUT] 1    0    [1    /1   ]  3.68371032152        1
[INPUT] 1    0    [1    /1   ]  12.4449805219        1
[INPUT] 1    0    [1    /1   ]  54.7540641664        1
[INPUT] 1    0    [1    /1   ]  0.330194926796       1
[INPUT] 1    0    [1    /1   ]  1.14384492118        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413145129, 1.0]], [0, [3661.4543941820234, 1.0]], [0, [833.2725275014675, 1.0]], [0, [235.71962369372946, 1.0]], [0, [76.50881268861647, 1.0]], [0, [9.974366331334153, 1.0]], [0, [26.97287996277357, 1.0]], [0, [0.37850616858119174, 1.0]], [0, [1.1032506901414356, 1.0]], [0, [2.8399055428920756, 1.0]], [1, [3.6837103215236695, 1.0]], [1, [12.444980521866185, 1.0]], [1, [54.75406416636538, 1.0]], [1, [0.3301949267962264, 1.0]], [1, [1.1438449211768893, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439418]
bas 2, expnt(s) = [833.2725275]
bas 3, expnt(s) = [235.71962369]
bas 4, expnt(s) = [76.50881269]
bas 5, expnt(s) = [9.97436633]
bas 6, expnt(s) = [26.97287996]
bas 7, expnt(s) = [0.37850617]
bas 8, expnt(s) = [1.10325069]
bas 9, expnt(s) = [2.83990554]
bas 10, expnt(s) = [3.68371032]
bas 11, expnt(s) = [12.44498052]
bas 12, expnt(s) = [54.75406417]
bas 13, expnt(s) = [0.33019493]
bas 14, expnt(s) = [1.14384492]
CPU time:       274.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272528e+02 3.91836891e+02 2.35719624e+02 1.51988885e+02
 7.65088127e+01 6.53579800e+01 9.97436633e+00 1.41800907e+01
 2.69728800e+01 2.99027076e+01 3.78506169e-01 1.21918538e+00
 1.10325069e+00 2.71969799e+00 2.83990554e+00 5.52704430e+00
 3.68371032e+00 1.48881670e+01 1.24449805e+01 6.81910172e+01
 5.47540642e+01 4.34515070e+02 3.30194927e-01 7.30209347e-01
 1.14384492e+00 3.45098704e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438391960462
cond(S) = 338.2050966329922
E1 = -183.57716533296434  E_coul = 55.07846012717244
init E= -128.498705205792
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773947353832944  LUMO = 1.11529619728931
  mo_energy =
[-3.25552923e+01 -1.85277640e+00 -7.73947354e-01 -7.73947354e-01
 -7.73947354e-01  1.11529620e+00  1.11529620e+00  1.11529620e+00
  1.20172200e+00  5.77600965e+00  5.77600965e+00  5.77600965e+00
  7.26062231e+00  2.42046080e+01  2.42046080e+01  2.42046080e+01
  3.44163649e+01  1.19047414e+02  1.19047414e+02  1.19047414e+02
  1.38348304e+02  5.02486532e+02  1.87021090e+03  7.99994278e+03
  4.77676698e+04]
E1 = -182.11266455715986  E_coul = 53.58415123016017
cycle= 1 E= -128.528513327  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450256
diis-c [-0.20273037  1.        ]
  HOMO = -0.879430512026041  LUMO = 1.0772137772067
  mo_energy =
[-3.28734677e+01 -1.96293670e+00 -8.79430512e-01 -8.79430512e-01
 -8.79430512e-01  1.07721378e+00  1.07721378e+00  1.07721378e+00
  1.15933264e+00  5.64730323e+00  5.64730323e+00  5.64730323e+00
  7.13379813e+00  2.39700126e+01  2.39700126e+01  2.39700126e+01
  3.41748334e+01  1.18727001e+02  1.18727001e+02  1.18727001e+02
  1.38035322e+02  5.02129644e+02  1.86981807e+03  7.99952095e+03
  4.77672292e+04]
E1 = -182.8434811721846  E_coul = 54.31246863489241
cycle= 2 E= -128.531012537292  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224536
diis-c [-6.02761379e-04  3.31744178e-01  6.68255822e-01]
  HOMO = -0.845119928750728  LUMO = 1.0896857051216
  mo_energy =
[-3.27685686e+01 -1.92685361e+00 -8.45119929e-01 -8.45119929e-01
 -8.45119929e-01  1.08968571e+00  1.08968571e+00  1.08968571e+00
  1.17304505e+00  5.68916725e+00  5.68916725e+00  5.68916725e+00
  7.17509495e+00  2.40474692e+01  2.40474692e+01  2.40474692e+01
  3.42548263e+01  1.18831921e+02  1.18831921e+02  1.18831921e+02
  1.38138287e+02  5.02243184e+02  1.86993677e+03  7.99964207e+03
  4.77673512e+04]
E1 = -182.59851306176182  E_coul = 54.06665643576869
cycle= 3 E= -128.531856625993  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983545
diis-c [-9.63712934e-08 -2.15351539e-03 -1.54515588e-04  1.00230803e+00]
  HOMO = -0.845356428820362  LUMO = 1.08963702816686
  mo_energy =
[-3.27689981e+01 -1.92703091e+00 -8.45356429e-01 -8.45356429e-01
 -8.45356429e-01  1.08963703e+00  1.08963703e+00  1.08963703e+00
  1.17298784e+00  5.68895783e+00  5.68895783e+00  5.68895783e+00
  7.17489591e+00  2.40471334e+01  2.40471334e+01  2.40471334e+01
  3.42544912e+01  1.18831479e+02  1.18831479e+02  1.18831479e+02
  1.38137858e+02  5.02242652e+02  1.86993613e+03  7.99964134e+03
  4.77673504e+04]
E1 = -182.59910279499294  E_coul = 54.06724615046544
cycle= 4 E= -128.531856644528  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136048
diis-c [-7.87147274e-10  2.87969067e-04  4.32061690e-04 -1.93282431e-01
  1.19256240e+00]
  HOMO = -0.845387209657491  LUMO = 1.0896246263064
  mo_energy =
[-3.27690524e+01 -1.92705103e+00 -8.45387210e-01 -8.45387210e-01
 -8.45387210e-01  1.08962463e+00  1.08962463e+00  1.08962463e+00
  1.17297800e+00  5.68892307e+00  5.68892307e+00  5.68892307e+00
  7.17486542e+00  2.40470858e+01  2.40470858e+01  2.40470858e+01
  3.42544442e+01  1.18831425e+02  1.18831425e+02  1.18831425e+02
  1.38137804e+02  5.02242590e+02  1.86993606e+03  7.99964127e+03
  4.77673503e+04]
E1 = -182.5992201215111  E_coul = 54.06736347653289
cycle= 5 E= -128.531856644978  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5992201215111  E_coul = 54.06736347653289
  HOMO = -0.845384299112761  LUMO = 1.08962585571845
  mo_energy =
[-3.27690463e+01 -1.92704741e+00 -8.45384299e-01 -8.45384299e-01
 -8.45384299e-01  1.08962586e+00  1.08962586e+00  1.08962586e+00
  1.17297979e+00  5.68892662e+00  5.68892662e+00  5.68892662e+00
  7.17486930e+00  2.40470912e+01  2.40470912e+01  2.40470912e+01
  3.42544498e+01  1.18831431e+02  1.18831431e+02  1.18831431e+02
  1.38137810e+02  5.02242596e+02  1.86993606e+03  7.99964127e+03
  4.77673503e+04]
E1 = -182.59920657251305  E_coul = 54.06734992753289
Extra cycle  E= -128.53185664498  delta_E= -1.93e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 338.2050966329922
E1 = -182.59920657251305  E_coul = 54.06734992753289
init E= -128.53185664498
    CPU time for initialize scf      0.21 sec, wall time      0.20 sec
  HOMO = -0.845385251468131  LUMO = 1.08962552412054
  mo_energy =
[-3.27690493e+01 -1.92704829e+00 -8.45385251e-01 -8.45385251e-01
 -8.45385251e-01  1.08962552e+00  1.08962552e+00  1.08962552e+00
  1.17297949e+00  5.68892547e+00  5.68892547e+00  5.68892547e+00
  7.17486823e+00  2.40470890e+01  2.40470890e+01  2.40470890e+01
  3.42544475e+01  1.18831427e+02  1.18831427e+02  1.18831427e+02
  1.38137807e+02  5.02242592e+02  1.86993606e+03  7.99964127e+03
  4.77673503e+04]
E1 = -182.59921390555513  E_coul = 54.06735726057478
cycle= 1 E= -128.53185664498  delta_E= -1.71e-13  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59921390555513  E_coul = 54.06735726057478
  HOMO = -0.845384737486169  LUMO = 1.08962571320935
  mo_energy =
[-3.27690478e+01 -1.92704772e+00 -8.45384737e-01 -8.45384737e-01
 -8.45384737e-01  1.08962571e+00  1.08962571e+00  1.08962571e+00
  1.17297971e+00  5.68892610e+00  5.68892610e+00  5.68892610e+00
  7.17486886e+00  2.40470902e+01  2.40470902e+01  2.40470902e+01
  3.42544487e+01  1.18831429e+02  1.18831429e+02  1.18831429e+02
  1.38137808e+02  5.02242594e+02  1.86993606e+03  7.99964127e+03
  4.77673503e+04]
E1 = -182.59921026925215  E_coul = 54.067353624271554
Extra cycle  E= -128.531856644981  delta_E= -2.56e-13  |g|= 4.95e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272528e+02 2.35719624e+02
 7.65088127e+01 9.97436633e+00 2.69728800e+01 3.78506169e-01
 1.10325069e+00 2.83990554e+00 3.68371032e+00 1.24449805e+01
 5.47540642e+01 3.30194927e-01 1.14384492e+00]
grad_E = [ 5.77951278e-10 -3.00045256e-08  5.82386475e-07 -6.00556922e-06
  3.04638381e-05 -2.27258348e-05 -3.43947831e-05  5.96683847e-06
 -7.61228624e-06 -2.41081617e-06  5.61394375e-07 -1.78043737e-07
 -3.63476851e-07  1.14782957e-05 -3.73798377e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439422        1
[INPUT] 0    0    [1    /1   ]  833.272526785        1
[INPUT] 0    0    [1    /1   ]  235.719633765        1
[INPUT] 0    0    [1    /1   ]  76.5087140153        1
[INPUT] 0    0    [1    /1   ]  9.97397592091        1
[INPUT] 0    0    [1    /1   ]  26.9734093752        1
[INPUT] 0    0    [1    /1   ]  0.378442883348       1
[INPUT] 0    0    [1    /1   ]  1.1029275502         1
[INPUT] 0    0    [1    /1   ]  2.83842986513        1
[INPUT] 1    0    [1    /1   ]  3.68374468593        1
[INPUT] 1    0    [1    /1   ]  12.4451447689        1
[INPUT] 1    0    [1    /1   ]  54.7548945474        1
[INPUT] 1    0    [1    /1   ]  0.330193654641       1
[INPUT] 1    0    [1    /1   ]  1.14385018259        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413145066, 1.0]], [0, [3661.4543942158675, 1.0]], [0, [833.2725267851267, 1.0]], [0, [235.7196337652055, 1.0]], [0, [76.5087140153216, 1.0]], [0, [9.973975920905794, 1.0]], [0, [26.973409375164056, 1.0]], [0, [0.3784428833476466, 1.0]], [0, [1.1029275502007028, 1.0]], [0, [2.8384298651271505, 1.0]], [1, [3.6837446859325707, 1.0]], [1, [12.445144768883772, 1.0]], [1, [54.754894547373944, 1.0]], [1, [0.3301936546414459, 1.0]], [1, [1.143850182589677, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439422]
bas 2, expnt(s) = [833.27252679]
bas 3, expnt(s) = [235.71963377]
bas 4, expnt(s) = [76.50871402]
bas 5, expnt(s) = [9.97397592]
bas 6, expnt(s) = [26.97340938]
bas 7, expnt(s) = [0.37844288]
bas 8, expnt(s) = [1.10292755]
bas 9, expnt(s) = [2.83842987]
bas 10, expnt(s) = [3.68374469]
bas 11, expnt(s) = [12.44514477]
bas 12, expnt(s) = [54.75489455]
bas 13, expnt(s) = [0.33019365]
bas 14, expnt(s) = [1.14385018]
CPU time:       278.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272527e+02 3.91836891e+02 2.35719634e+02 1.51988890e+02
 7.65087140e+01 6.53579168e+01 9.97397592e+00 1.41796745e+01
 2.69734094e+01 2.99031478e+01 3.78442883e-01 1.21903249e+00
 1.10292755e+00 2.71910052e+00 2.83842987e+00 5.52489018e+00
 3.68374469e+00 1.48883406e+01 1.24451448e+01 6.81921422e+01
 5.47548945e+01 4.34523307e+02 3.30193655e-01 7.30205831e-01
 1.14385018e+00 3.45100688e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438472910873
cond(S) = 338.07705341289676
E1 = -183.5771655442041  E_coul = 55.07845951534416
init E= -128.49870602886
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947401361159  LUMO = 1.11529420409464
  mo_energy =
[-3.25552922e+01 -1.85277667e+00 -7.73947401e-01 -7.73947401e-01
 -7.73947401e-01  1.11529420e+00  1.11529420e+00  1.11529420e+00
  1.20131921e+00  5.77604065e+00  5.77604065e+00  5.77604065e+00
  7.25734954e+00  2.42048902e+01  2.42048902e+01  2.42048902e+01
  3.44087527e+01  1.19049321e+02  1.19049321e+02  1.19049321e+02
  1.38340603e+02  5.02479890e+02  1.87020503e+03  7.99993763e+03
  4.77676655e+04]
E1 = -182.1126550552067  E_coul = 53.584141745318185
cycle= 1 E= -128.528513309888  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450255
diis-c [-0.20272944  1.        ]
  HOMO = -0.8794313357367  LUMO = 1.07721125204429
  mo_energy =
[-3.28734690e+01 -1.96293762e+00 -8.79431336e-01 -8.79431336e-01
 -8.79431336e-01  1.07721125e+00  1.07721125e+00  1.07721125e+00
  1.15894488e+00  5.64733258e+00  5.64733258e+00  5.64733258e+00
  7.13055889e+00  2.39702923e+01  2.39702923e+01  2.39702923e+01
  3.41672247e+01  1.18728905e+02  1.18728905e+02  1.18728905e+02
  1.38027619e+02  5.02123000e+02  1.86981220e+03  7.99951580e+03
  4.77672249e+04]
E1 = -182.84347442167393  E_coul = 54.31246188793785
cycle= 2 E= -128.531012533736  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224535
diis-c [-6.02722535e-04  3.31744175e-01  6.68255825e-01]
  HOMO = -0.845120620165719  LUMO = 1.08968324919361
  mo_energy =
[-3.27685696e+01 -1.92685440e+00 -8.45120620e-01 -8.45120620e-01
 -8.45120620e-01  1.08968325e+00  1.08968325e+00  1.08968325e+00
  1.17265232e+00  5.68919703e+00  5.68919703e+00  5.68919703e+00
  7.17184446e+00  2.40477496e+01  2.40477496e+01  2.40477496e+01
  3.42472164e+01  1.18833826e+02  1.18833826e+02  1.18833826e+02
  1.38130584e+02  5.02236541e+02  1.86993090e+03  7.99963692e+03
  4.77673469e+04]
E1 = -182.59850442789124  E_coul = 54.066647796472424
cycle= 3 E= -128.531856631419  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983754
diis-c [-9.64072005e-08 -2.15372387e-03 -1.54018763e-04  1.00230774e+00]
  HOMO = -0.845357188498316  LUMO = 1.08963454097557
  mo_energy =
[-3.27689992e+01 -1.92703177e+00 -8.45357188e-01 -8.45357188e-01
 -8.45357188e-01  1.08963454e+00  1.08963454e+00  1.08963454e+00
  1.17259509e+00  5.68898754e+00  5.68898754e+00  5.68898754e+00
  7.17164538e+00  2.40474137e+01  2.40474137e+01  2.40474137e+01
  3.42468812e+01  1.18833384e+02  1.18833384e+02  1.18833384e+02
  1.38130156e+02  5.02236009e+02  1.86993025e+03  7.99963619e+03
  4.77673461e+04]
E1 = -182.59909430625555  E_coul = 54.06723765629066
cycle= 4 E= -128.531856649965  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136065
diis-c [-7.87309432e-10  2.87986880e-04  4.31976413e-04 -1.93287808e-01
  1.19256784e+00]
  HOMO = -0.84538797735746  LUMO = 1.08962213534277
  mo_energy =
[-3.27690535e+01 -1.92705189e+00 -8.45387977e-01 -8.45387977e-01
 -8.45387977e-01  1.08962214e+00  1.08962214e+00  1.08962214e+00
  1.17258526e+00  5.68895277e+00  5.68895277e+00  5.68895277e+00
  7.17161490e+00  2.40473661e+01  2.40473661e+01  2.40473661e+01
  3.42468342e+01  1.18833329e+02  1.18833329e+02  1.18833329e+02
  1.38130101e+02  5.02235947e+02  1.86993018e+03  7.99963611e+03
  4.77673461e+04]
E1 = -182.59921163869447  E_coul = 54.06735498827859
cycle= 5 E= -128.531856650416  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59921163869447  E_coul = 54.06735498827859
  HOMO = -0.845385066487231  LUMO = 1.08962336492469
  mo_energy =
[-3.27690474e+01 -1.92704827e+00 -8.45385066e-01 -8.45385066e-01
 -8.45385066e-01  1.08962336e+00  1.08962336e+00  1.08962336e+00
  1.17258704e+00  5.68895633e+00  5.68895633e+00  5.68895633e+00
  7.17161878e+00  2.40473715e+01  2.40473715e+01  2.40473715e+01
  3.42468398e+01  1.18833335e+02  1.18833335e+02  1.18833335e+02
  1.38130107e+02  5.02235952e+02  1.86993019e+03  7.99963612e+03
  4.77673461e+04]
E1 = -182.5991980894705  E_coul = 54.06734143905266
Extra cycle  E= -128.531856650418  delta_E= -1.96e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272527e+02 2.35719634e+02
 7.65087140e+01 9.97397592e+00 2.69734094e+01 3.78442883e-01
 1.10292755e+00 2.83842987e+00 3.68374469e+00 1.24451448e+01
 5.47548945e+01 3.30193655e-01 1.14385018e+00]
E = -128.53185665041784
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941315        1
[INPUT] 0    0    [1    /1   ]  3661.45439422        1
[INPUT] 0    0    [1    /1   ]  833.272526785        1
[INPUT] 0    0    [1    /1   ]  235.719633765        1
[INPUT] 0    0    [1    /1   ]  76.5087140153        1
[INPUT] 0    0    [1    /1   ]  9.97397592091        1
[INPUT] 0    0    [1    /1   ]  26.9734093752        1
[INPUT] 0    0    [1    /1   ]  0.378442883348       1
[INPUT] 0    0    [1    /1   ]  1.1029275502         1
[INPUT] 0    0    [1    /1   ]  2.83842986513        1
[INPUT] 1    0    [1    /1   ]  3.68374468593        1
[INPUT] 1    0    [1    /1   ]  12.4451447689        1
[INPUT] 1    0    [1    /1   ]  54.7548945474        1
[INPUT] 1    0    [1    /1   ]  0.330193654641       1
[INPUT] 1    0    [1    /1   ]  1.14385018259        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413145066, 1.0]], [0, [3661.4543942158675, 1.0]], [0, [833.2725267851267, 1.0]], [0, [235.7196337652055, 1.0]], [0, [76.5087140153216, 1.0]], [0, [9.973975920905794, 1.0]], [0, [26.973409375164056, 1.0]], [0, [0.3784428833476466, 1.0]], [0, [1.1029275502007028, 1.0]], [0, [2.8384298651271505, 1.0]], [1, [3.6837446859325707, 1.0]], [1, [12.445144768883772, 1.0]], [1, [54.754894547373944, 1.0]], [1, [0.3301936546414459, 1.0]], [1, [1.143850182589677, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439422]
bas 2, expnt(s) = [833.27252679]
bas 3, expnt(s) = [235.71963377]
bas 4, expnt(s) = [76.50871402]
bas 5, expnt(s) = [9.97397592]
bas 6, expnt(s) = [26.97340938]
bas 7, expnt(s) = [0.37844288]
bas 8, expnt(s) = [1.10292755]
bas 9, expnt(s) = [2.83842987]
bas 10, expnt(s) = [3.68374469]
bas 11, expnt(s) = [12.44514477]
bas 12, expnt(s) = [54.75489455]
bas 13, expnt(s) = [0.33019365]
bas 14, expnt(s) = [1.14385018]
CPU time:       279.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272527e+02 3.91836891e+02 2.35719634e+02 1.51988890e+02
 7.65087140e+01 6.53579168e+01 9.97397592e+00 1.41796745e+01
 2.69734094e+01 2.99031478e+01 3.78442883e-01 1.21903249e+00
 1.10292755e+00 2.71910052e+00 2.83842987e+00 5.52489018e+00
 3.68374469e+00 1.48883406e+01 1.24451448e+01 6.81921422e+01
 5.47548945e+01 4.34523307e+02 3.30193655e-01 7.30205831e-01
 1.14385018e+00 3.45100688e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438472910873
cond(S) = 338.07705341289676
E1 = -183.5771655442041  E_coul = 55.07845951534416
init E= -128.49870602886
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773947401361159  LUMO = 1.11529420409464
  mo_energy =
[-3.25552922e+01 -1.85277667e+00 -7.73947401e-01 -7.73947401e-01
 -7.73947401e-01  1.11529420e+00  1.11529420e+00  1.11529420e+00
  1.20131921e+00  5.77604065e+00  5.77604065e+00  5.77604065e+00
  7.25734954e+00  2.42048902e+01  2.42048902e+01  2.42048902e+01
  3.44087527e+01  1.19049321e+02  1.19049321e+02  1.19049321e+02
  1.38340603e+02  5.02479890e+02  1.87020503e+03  7.99993763e+03
  4.77676655e+04]
E1 = -182.1126550552067  E_coul = 53.584141745318185
cycle= 1 E= -128.528513309888  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450255
diis-c [-0.20272944  1.        ]
  HOMO = -0.8794313357367  LUMO = 1.07721125204429
  mo_energy =
[-3.28734690e+01 -1.96293762e+00 -8.79431336e-01 -8.79431336e-01
 -8.79431336e-01  1.07721125e+00  1.07721125e+00  1.07721125e+00
  1.15894488e+00  5.64733258e+00  5.64733258e+00  5.64733258e+00
  7.13055889e+00  2.39702923e+01  2.39702923e+01  2.39702923e+01
  3.41672247e+01  1.18728905e+02  1.18728905e+02  1.18728905e+02
  1.38027619e+02  5.02123000e+02  1.86981220e+03  7.99951580e+03
  4.77672249e+04]
E1 = -182.84347442167393  E_coul = 54.31246188793785
cycle= 2 E= -128.531012533736  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224535
diis-c [-6.02722535e-04  3.31744175e-01  6.68255825e-01]
  HOMO = -0.845120620165719  LUMO = 1.08968324919361
  mo_energy =
[-3.27685696e+01 -1.92685440e+00 -8.45120620e-01 -8.45120620e-01
 -8.45120620e-01  1.08968325e+00  1.08968325e+00  1.08968325e+00
  1.17265232e+00  5.68919703e+00  5.68919703e+00  5.68919703e+00
  7.17184446e+00  2.40477496e+01  2.40477496e+01  2.40477496e+01
  3.42472164e+01  1.18833826e+02  1.18833826e+02  1.18833826e+02
  1.38130584e+02  5.02236541e+02  1.86993090e+03  7.99963692e+03
  4.77673469e+04]
E1 = -182.59850442789124  E_coul = 54.066647796472424
cycle= 3 E= -128.531856631419  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983754
diis-c [-9.64072005e-08 -2.15372387e-03 -1.54018763e-04  1.00230774e+00]
  HOMO = -0.845357188498316  LUMO = 1.08963454097557
  mo_energy =
[-3.27689992e+01 -1.92703177e+00 -8.45357188e-01 -8.45357188e-01
 -8.45357188e-01  1.08963454e+00  1.08963454e+00  1.08963454e+00
  1.17259509e+00  5.68898754e+00  5.68898754e+00  5.68898754e+00
  7.17164538e+00  2.40474137e+01  2.40474137e+01  2.40474137e+01
  3.42468812e+01  1.18833384e+02  1.18833384e+02  1.18833384e+02
  1.38130156e+02  5.02236009e+02  1.86993025e+03  7.99963619e+03
  4.77673461e+04]
E1 = -182.59909430625555  E_coul = 54.06723765629066
cycle= 4 E= -128.531856649965  delta_E= -1.85e-08  |g|= 6.21e-05  |ddm|= 0.000214
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136065
diis-c [-7.87309432e-10  2.87986880e-04  4.31976413e-04 -1.93287808e-01
  1.19256784e+00]
  HOMO = -0.84538797735746  LUMO = 1.08962213534277
  mo_energy =
[-3.27690535e+01 -1.92705189e+00 -8.45387977e-01 -8.45387977e-01
 -8.45387977e-01  1.08962214e+00  1.08962214e+00  1.08962214e+00
  1.17258526e+00  5.68895277e+00  5.68895277e+00  5.68895277e+00
  7.17161490e+00  2.40473661e+01  2.40473661e+01  2.40473661e+01
  3.42468342e+01  1.18833329e+02  1.18833329e+02  1.18833329e+02
  1.38130101e+02  5.02235947e+02  1.86993018e+03  7.99963611e+03
  4.77673461e+04]
E1 = -182.59921163869447  E_coul = 54.06735498827859
cycle= 5 E= -128.531856650416  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59921163869447  E_coul = 54.06735498827859
  HOMO = -0.845385066487231  LUMO = 1.08962336492469
  mo_energy =
[-3.27690474e+01 -1.92704827e+00 -8.45385066e-01 -8.45385066e-01
 -8.45385066e-01  1.08962336e+00  1.08962336e+00  1.08962336e+00
  1.17258704e+00  5.68895633e+00  5.68895633e+00  5.68895633e+00
  7.17161878e+00  2.40473715e+01  2.40473715e+01  2.40473715e+01
  3.42468398e+01  1.18833335e+02  1.18833335e+02  1.18833335e+02
  1.38130107e+02  5.02235952e+02  1.86993019e+03  7.99963612e+03
  4.77673461e+04]
E1 = -182.5991980894705  E_coul = 54.06734143905266
Extra cycle  E= -128.531856650418  delta_E= -1.96e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 338.07705341289676
E1 = -182.5991980894705  E_coul = 54.06734143905266
init E= -128.531856650418
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.845386018855841  LUMO = 1.08962303332636
  mo_energy =
[-3.27690504e+01 -1.92704915e+00 -8.45386019e-01 -8.45386019e-01
 -8.45386019e-01  1.08962303e+00  1.08962303e+00  1.08962303e+00
  1.17258675e+00  5.68895517e+00  5.68895517e+00  5.68895517e+00
  7.17161770e+00  2.40473693e+01  2.40473693e+01  2.40473693e+01
  3.42468376e+01  1.18833332e+02  1.18833332e+02  1.18833332e+02
  1.38130104e+02  5.02235949e+02  1.86993019e+03  7.99963611e+03
  4.77673461e+04]
E1 = -182.59920542283785  E_coul = 54.06734877241989
cycle= 1 E= -128.531856650418  delta_E= -1.42e-13  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59920542283785  E_coul = 54.06734877241989
  HOMO = -0.845385504851144  LUMO = 1.08962322242453
  mo_energy =
[-3.27690488e+01 -1.92704858e+00 -8.45385505e-01 -8.45385505e-01
 -8.45385505e-01  1.08962322e+00  1.08962322e+00  1.08962322e+00
  1.17258697e+00  5.68895580e+00  5.68895580e+00  5.68895580e+00
  7.17161834e+00  2.40473704e+01  2.40473704e+01  2.40473704e+01
  3.42468388e+01  1.18833334e+02  1.18833334e+02  1.18833334e+02
  1.38130106e+02  5.02235951e+02  1.86993019e+03  7.99963612e+03
  4.77673461e+04]
E1 = -182.59920178638183  E_coul = 54.06734513596363
Extra cycle  E= -128.531856650418  delta_E= -2.27e-13  |g|= 4.95e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272527e+02 2.35719634e+02
 7.65087140e+01 9.97397592e+00 2.69734094e+01 3.78442883e-01
 1.10292755e+00 2.83842987e+00 3.68374469e+00 1.24451448e+01
 5.47548945e+01 3.30193655e-01 1.14385018e+00]
grad_E = [ 5.72268822e-10 -2.97074493e-08  5.76470188e-07 -5.93837090e-06
  2.99966584e-05 -2.49965128e-05 -3.26606618e-05 -2.38741605e-06
 -1.81549636e-06 -4.31009618e-06  3.34448714e-07 -8.42039651e-08
 -3.63041359e-07  5.03687367e-07 -9.17627936e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439434        1
[INPUT] 0    0    [1    /1   ]  833.272524378        1
[INPUT] 0    0    [1    /1   ]  235.719661459        1
[INPUT] 0    0    [1    /1   ]  76.5085227189        1
[INPUT] 0    0    [1    /1   ]  9.97364450069        1
[INPUT] 0    0    [1    /1   ]  26.9740693884        1
[INPUT] 0    0    [1    /1   ]  0.378374703321       1
[INPUT] 0    0    [1    /1   ]  1.10258337643        1
[INPUT] 0    0    [1    /1   ]  2.83677821249        1
[INPUT] 1    0    [1    /1   ]  3.68381629337        1
[INPUT] 1    0    [1    /1   ]  12.4454848104        1
[INPUT] 1    0    [1    /1   ]  54.7567554152        1
[INPUT] 1    0    [1    /1   ]  0.33019265836        1
[INPUT] 1    0    [1    /1   ]  1.1438630102         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131448358, 1.0]], [0, [3661.454394336573, 1.0]], [0, [833.2725243783308, 1.0]], [0, [235.7196614585422, 1.0]], [0, [76.50852271893102, 1.0]], [0, [9.97364450068752, 1.0]], [0, [26.974069388449223, 1.0]], [0, [0.37837470332129547, 1.0]], [0, [1.1025833764294701, 1.0]], [0, [2.8367782124890075, 1.0]], [1, [3.683816293373145, 1.0]], [1, [12.445484810424855, 1.0]], [1, [54.75675541518406, 1.0]], [1, [0.33019265835999717, 1.0]], [1, [1.1438630102044622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439434]
bas 2, expnt(s) = [833.27252438]
bas 3, expnt(s) = [235.71966146]
bas 4, expnt(s) = [76.50852272]
bas 5, expnt(s) = [9.9736445]
bas 6, expnt(s) = [26.97406939]
bas 7, expnt(s) = [0.3783747]
bas 8, expnt(s) = [1.10258338]
bas 9, expnt(s) = [2.83677821]
bas 10, expnt(s) = [3.68381629]
bas 11, expnt(s) = [12.44548481]
bas 12, expnt(s) = [54.75675542]
bas 13, expnt(s) = [0.33019266]
bas 14, expnt(s) = [1.14386301]
CPU time:       282.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272524e+02 3.91836890e+02 2.35719661e+02 1.51988903e+02
 7.65085227e+01 6.53577942e+01 9.97364450e+00 1.41793211e+01
 2.69740694e+01 2.99036965e+01 3.78374703e-01 1.21886777e+00
 1.10258338e+00 2.71846412e+00 2.83677821e+00 5.52247885e+00
 3.68381629e+00 1.48887024e+01 1.24454848e+01 6.81944713e+01
 5.47567554e+01 4.34541766e+02 3.30192658e-01 7.30203077e-01
 1.14386301e+00 3.45105525e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438530365778
cond(S) = 337.93969063984224
E1 = -183.57716539388747  E_coul = 55.07845866131122
init E= -128.498706732576
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947467914919  LUMO = 1.11529560743766
  mo_energy =
[-3.25552921e+01 -1.85277698e+00 -7.73947468e-01 -7.73947468e-01
 -7.73947468e-01  1.11529561e+00  1.11529561e+00  1.11529561e+00
  1.20088537e+00  5.77611670e+00  5.77611670e+00  5.77611670e+00
  7.25376345e+00  2.42054867e+01  2.42054867e+01  2.42054867e+01
  3.44005280e+01  1.19053495e+02  1.19053495e+02  1.19053495e+02
  1.38332534e+02  5.02472977e+02  1.87019890e+03  7.99993224e+03
  4.77676611e+04]
E1 = -182.11264299891906  E_coul = 53.584129704643836
cycle= 1 E= -128.528513294275  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450253
diis-c [-0.20272744  1.        ]
  HOMO = -0.879432399379665  LUMO = 1.07721178022311
  mo_energy =
[-3.28734707e+01 -1.96293879e+00 -8.79432399e-01 -8.79432399e-01
 -8.79432399e-01  1.07721178e+00  1.07721178e+00  1.07721178e+00
  1.15852722e+00  5.64740587e+00  5.64740587e+00  5.64740587e+00
  7.12700954e+00  2.39708849e+01  2.39708849e+01  2.39708849e+01
  3.41590033e+01  1.18733077e+02  1.18733077e+02  1.18733077e+02
  1.38019547e+02  5.02116084e+02  1.86980606e+03  7.99951042e+03
  4.77672204e+04]
E1 = -182.84346537189217  E_coul = 54.31245283881812
cycle= 2 E= -128.531012533074  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224534
diis-c [-6.02681433e-04  3.31744179e-01  6.68255821e-01]
  HOMO = -0.845121542805394  LUMO = 1.08968392325563
  mo_energy =
[-3.27685708e+01 -1.92685543e+00 -8.45121543e-01 -8.45121543e-01
 -8.45121543e-01  1.08968392e+00  1.08968392e+00  1.08968392e+00
  1.17222927e+00  5.68927105e+00  5.68927105e+00  5.68927105e+00
  7.16828272e+00  2.40483433e+01  2.40483433e+01  2.40483433e+01
  3.42389938e+01  1.18837998e+02  1.18837998e+02  1.18837998e+02
  1.38122513e+02  5.02229626e+02  1.86992476e+03  7.99963153e+03
  4.77673425e+04]
E1 = -182.59849316769157  E_coul = 54.06663652647819
cycle= 3 E= -128.531856641213  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984007
diis-c [-9.64478804e-08 -2.15399906e-03 -1.53448389e-04  1.00230745e+00]
  HOMO = -0.84535819684649  LUMO = 1.08963517551379
  mo_energy =
[-3.27690006e+01 -1.92703287e+00 -8.45358197e-01 -8.45358197e-01
 -8.45358197e-01  1.08963518e+00  1.08963518e+00  1.08963518e+00
  1.17217202e+00  5.68906146e+00  5.68906146e+00  5.68906146e+00
  7.16808360e+00  2.40480072e+01  2.40480072e+01  2.40480072e+01
  3.42386585e+01  1.18837557e+02  1.18837557e+02  1.18837557e+02
  1.38122084e+02  5.02229094e+02  1.86992412e+03  7.99963080e+03
  4.77673417e+04]
E1 = -182.5990832258194  E_coul = 54.06722656604563
cycle= 4 E= -128.531856659774  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136084
diis-c [-7.87508471e-10  2.88007403e-04  4.31874885e-04 -1.93291797e-01
  1.19257192e+00]
  HOMO = -0.845388995284183  LUMO = 1.0896227653152
  mo_energy =
[-3.27690549e+01 -1.92705301e+00 -8.45388995e-01 -8.45388995e-01
 -8.45388995e-01  1.08962277e+00  1.08962277e+00  1.08962277e+00
  1.17216219e+00  5.68902668e+00  5.68902668e+00  5.68902668e+00
  7.16805312e+00  2.40479596e+01  2.40479596e+01  2.40479596e+01
  3.42386115e+01  1.18837502e+02  1.18837502e+02  1.18837502e+02
  1.38122030e+02  5.02229032e+02  1.86992405e+03  7.99963073e+03
  4.77673416e+04]
E1 = -182.59920056510666  E_coul = 54.06734390488193
cycle= 5 E= -128.531856660225  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59920056510666  E_coul = 54.06734390488193
  HOMO = -0.845386084059179  LUMO = 1.08962399509425
  mo_energy =
[-3.27690487e+01 -1.92704938e+00 -8.45386084e-01 -8.45386084e-01
 -8.45386084e-01  1.08962400e+00  1.08962400e+00  1.08962400e+00
  1.17216397e+00  5.68903024e+00  5.68903024e+00  5.68903024e+00
  7.16805699e+00  2.40479650e+01  2.40479650e+01  2.40479650e+01
  3.42386171e+01  1.18837508e+02  1.18837508e+02  1.18837508e+02
  1.38122036e+02  5.02229037e+02  1.86992405e+03  7.99963074e+03
  4.77673416e+04]
E1 = -182.59918701592898  E_coul = 54.06733035570207
Extra cycle  E= -128.531856660227  delta_E= -2.19e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272524e+02 2.35719661e+02
 7.65085227e+01 9.97364450e+00 2.69740694e+01 3.78374703e-01
 1.10258338e+00 2.83677821e+00 3.68381629e+00 1.24454848e+01
 5.47567554e+01 3.30192658e-01 1.14386301e+00]
E = -128.5318566602269
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439434        1
[INPUT] 0    0    [1    /1   ]  833.272524378        1
[INPUT] 0    0    [1    /1   ]  235.719661459        1
[INPUT] 0    0    [1    /1   ]  76.5085227189        1
[INPUT] 0    0    [1    /1   ]  9.97364450069        1
[INPUT] 0    0    [1    /1   ]  26.9740693884        1
[INPUT] 0    0    [1    /1   ]  0.378374703321       1
[INPUT] 0    0    [1    /1   ]  1.10258337643        1
[INPUT] 0    0    [1    /1   ]  2.83677821249        1
[INPUT] 1    0    [1    /1   ]  3.68381629337        1
[INPUT] 1    0    [1    /1   ]  12.4454848104        1
[INPUT] 1    0    [1    /1   ]  54.7567554152        1
[INPUT] 1    0    [1    /1   ]  0.33019265836        1
[INPUT] 1    0    [1    /1   ]  1.1438630102         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131448358, 1.0]], [0, [3661.454394336573, 1.0]], [0, [833.2725243783308, 1.0]], [0, [235.7196614585422, 1.0]], [0, [76.50852271893102, 1.0]], [0, [9.97364450068752, 1.0]], [0, [26.974069388449223, 1.0]], [0, [0.37837470332129547, 1.0]], [0, [1.1025833764294701, 1.0]], [0, [2.8367782124890075, 1.0]], [1, [3.683816293373145, 1.0]], [1, [12.445484810424855, 1.0]], [1, [54.75675541518406, 1.0]], [1, [0.33019265835999717, 1.0]], [1, [1.1438630102044622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413145]
bas 1, expnt(s) = [3661.45439434]
bas 2, expnt(s) = [833.27252438]
bas 3, expnt(s) = [235.71966146]
bas 4, expnt(s) = [76.50852272]
bas 5, expnt(s) = [9.9736445]
bas 6, expnt(s) = [26.97406939]
bas 7, expnt(s) = [0.3783747]
bas 8, expnt(s) = [1.10258338]
bas 9, expnt(s) = [2.83677821]
bas 10, expnt(s) = [3.68381629]
bas 11, expnt(s) = [12.44548481]
bas 12, expnt(s) = [54.75675542]
bas 13, expnt(s) = [0.33019266]
bas 14, expnt(s) = [1.14386301]
CPU time:       283.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272524e+02 3.91836890e+02 2.35719661e+02 1.51988903e+02
 7.65085227e+01 6.53577942e+01 9.97364450e+00 1.41793211e+01
 2.69740694e+01 2.99036965e+01 3.78374703e-01 1.21886777e+00
 1.10258338e+00 2.71846412e+00 2.83677821e+00 5.52247885e+00
 3.68381629e+00 1.48887024e+01 1.24454848e+01 6.81944713e+01
 5.47567554e+01 4.34541766e+02 3.30192658e-01 7.30203077e-01
 1.14386301e+00 3.45105525e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438530365778
cond(S) = 337.93969063984224
E1 = -183.57716539388747  E_coul = 55.07845866131122
init E= -128.498706732576
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947467914919  LUMO = 1.11529560743766
  mo_energy =
[-3.25552921e+01 -1.85277698e+00 -7.73947468e-01 -7.73947468e-01
 -7.73947468e-01  1.11529561e+00  1.11529561e+00  1.11529561e+00
  1.20088537e+00  5.77611670e+00  5.77611670e+00  5.77611670e+00
  7.25376345e+00  2.42054867e+01  2.42054867e+01  2.42054867e+01
  3.44005280e+01  1.19053495e+02  1.19053495e+02  1.19053495e+02
  1.38332534e+02  5.02472977e+02  1.87019890e+03  7.99993224e+03
  4.77676611e+04]
E1 = -182.11264299891906  E_coul = 53.584129704643836
cycle= 1 E= -128.528513294275  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450253
diis-c [-0.20272744  1.        ]
  HOMO = -0.879432399379665  LUMO = 1.07721178022311
  mo_energy =
[-3.28734707e+01 -1.96293879e+00 -8.79432399e-01 -8.79432399e-01
 -8.79432399e-01  1.07721178e+00  1.07721178e+00  1.07721178e+00
  1.15852722e+00  5.64740587e+00  5.64740587e+00  5.64740587e+00
  7.12700954e+00  2.39708849e+01  2.39708849e+01  2.39708849e+01
  3.41590033e+01  1.18733077e+02  1.18733077e+02  1.18733077e+02
  1.38019547e+02  5.02116084e+02  1.86980606e+03  7.99951042e+03
  4.77672204e+04]
E1 = -182.84346537189217  E_coul = 54.31245283881812
cycle= 2 E= -128.531012533074  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224534
diis-c [-6.02681433e-04  3.31744179e-01  6.68255821e-01]
  HOMO = -0.845121542805394  LUMO = 1.08968392325563
  mo_energy =
[-3.27685708e+01 -1.92685543e+00 -8.45121543e-01 -8.45121543e-01
 -8.45121543e-01  1.08968392e+00  1.08968392e+00  1.08968392e+00
  1.17222927e+00  5.68927105e+00  5.68927105e+00  5.68927105e+00
  7.16828272e+00  2.40483433e+01  2.40483433e+01  2.40483433e+01
  3.42389938e+01  1.18837998e+02  1.18837998e+02  1.18837998e+02
  1.38122513e+02  5.02229626e+02  1.86992476e+03  7.99963153e+03
  4.77673425e+04]
E1 = -182.59849316769157  E_coul = 54.06663652647819
cycle= 3 E= -128.531856641213  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000984007
diis-c [-9.64478804e-08 -2.15399906e-03 -1.53448389e-04  1.00230745e+00]
  HOMO = -0.84535819684649  LUMO = 1.08963517551379
  mo_energy =
[-3.27690006e+01 -1.92703287e+00 -8.45358197e-01 -8.45358197e-01
 -8.45358197e-01  1.08963518e+00  1.08963518e+00  1.08963518e+00
  1.17217202e+00  5.68906146e+00  5.68906146e+00  5.68906146e+00
  7.16808360e+00  2.40480072e+01  2.40480072e+01  2.40480072e+01
  3.42386585e+01  1.18837557e+02  1.18837557e+02  1.18837557e+02
  1.38122084e+02  5.02229094e+02  1.86992412e+03  7.99963080e+03
  4.77673417e+04]
E1 = -182.5990832258194  E_coul = 54.06722656604563
cycle= 4 E= -128.531856659774  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000136084
diis-c [-7.87508471e-10  2.88007403e-04  4.31874885e-04 -1.93291797e-01
  1.19257192e+00]
  HOMO = -0.845388995284183  LUMO = 1.0896227653152
  mo_energy =
[-3.27690549e+01 -1.92705301e+00 -8.45388995e-01 -8.45388995e-01
 -8.45388995e-01  1.08962277e+00  1.08962277e+00  1.08962277e+00
  1.17216219e+00  5.68902668e+00  5.68902668e+00  5.68902668e+00
  7.16805312e+00  2.40479596e+01  2.40479596e+01  2.40479596e+01
  3.42386115e+01  1.18837502e+02  1.18837502e+02  1.18837502e+02
  1.38122030e+02  5.02229032e+02  1.86992405e+03  7.99963073e+03
  4.77673416e+04]
E1 = -182.59920056510666  E_coul = 54.06734390488193
cycle= 5 E= -128.531856660225  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.65e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59920056510666  E_coul = 54.06734390488193
  HOMO = -0.845386084059179  LUMO = 1.08962399509425
  mo_energy =
[-3.27690487e+01 -1.92704938e+00 -8.45386084e-01 -8.45386084e-01
 -8.45386084e-01  1.08962400e+00  1.08962400e+00  1.08962400e+00
  1.17216397e+00  5.68903024e+00  5.68903024e+00  5.68903024e+00
  7.16805699e+00  2.40479650e+01  2.40479650e+01  2.40479650e+01
  3.42386171e+01  1.18837508e+02  1.18837508e+02  1.18837508e+02
  1.38122036e+02  5.02229037e+02  1.86992405e+03  7.99963074e+03
  4.77673416e+04]
E1 = -182.59918701592898  E_coul = 54.06733035570207
Extra cycle  E= -128.531856660227  delta_E= -2.19e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.93969063984224
E1 = -182.59918701592898  E_coul = 54.06733035570207
init E= -128.531856660227
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.845387036421412  LUMO = 1.08962366350168
  mo_energy =
[-3.27690518e+01 -1.92705026e+00 -8.45387036e-01 -8.45387036e-01
 -8.45387036e-01  1.08962366e+00  1.08962366e+00  1.08962366e+00
  1.17216368e+00  5.68902908e+00  5.68902908e+00  5.68902908e+00
  7.16805592e+00  2.40479628e+01  2.40479628e+01  2.40479628e+01
  3.42386148e+01  1.18837505e+02  1.18837505e+02  1.18837505e+02
  1.38122033e+02  5.02229034e+02  1.86992405e+03  7.99963073e+03
  4.77673416e+04]
E1 = -182.59919434952803  E_coul = 54.06733768930089
cycle= 1 E= -128.531856660227  delta_E= -2.27e-13  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59919434952803  E_coul = 54.06733768930089
  HOMO = -0.845386522400523  LUMO = 1.0896238526081
  mo_energy =
[-3.27690502e+01 -1.92704970e+00 -8.45386522e-01 -8.45386522e-01
 -8.45386522e-01  1.08962385e+00  1.08962385e+00  1.08962385e+00
  1.17216390e+00  5.68902971e+00  5.68902971e+00  5.68902971e+00
  7.16805655e+00  2.40479639e+01  2.40479639e+01  2.40479639e+01
  3.42386160e+01  1.18837506e+02  1.18837506e+02  1.18837506e+02
  1.38122034e+02  5.02229035e+02  1.86992405e+03  7.99963073e+03
  4.77673416e+04]
E1 = -182.59919071296852  E_coul = 54.06733405274122
Extra cycle  E= -128.531856660227  delta_E= -1.71e-13  |g|= 4.95e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272524e+02 2.35719661e+02
 7.65085227e+01 9.97364450e+00 2.69740694e+01 3.78374703e-01
 1.10258338e+00 2.83677821e+00 3.68381629e+00 1.24454848e+01
 5.47567554e+01 3.30192658e-01 1.14386301e+00]
grad_E = [ 5.65745394e-10 -2.93667071e-08  5.69713462e-07 -5.86264786e-06
  2.94855646e-05 -2.71779837e-05 -3.08575495e-05 -1.42540778e-05
  5.91381409e-06 -6.75327349e-06 -7.10726766e-08  6.15970350e-08
 -3.53781088e-07 -1.67047878e-05  3.58431425e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439479        1
[INPUT] 0    0    [1    /1   ]  833.272515451        1
[INPUT] 0    0    [1    /1   ]  235.719758375        1
[INPUT] 0    0    [1    /1   ]  76.5079453209        1
[INPUT] 0    0    [1    /1   ]  9.97327396513        1
[INPUT] 0    0    [1    /1   ]  26.9754708525        1
[INPUT] 0    0    [1    /1   ]  0.378268981335       1
[INPUT] 0    0    [1    /1   ]  1.10203454573        1
[INPUT] 0    0    [1    /1   ]  2.8340019306         1
[INPUT] 1    0    [1    /1   ]  3.68395722838        1
[INPUT] 1    0    [1    /1   ]  12.4461502082        1
[INPUT] 1    0    [1    /1   ]  54.7602845424        1
[INPUT] 1    0    [1    /1   ]  0.330190858278       1
[INPUT] 1    0    [1    /1   ]  1.14388874181        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413143964, 1.0]], [0, [3661.4543947909565, 1.0]], [0, [833.2725154508367, 1.0]], [0, [235.71975837511624, 1.0]], [0, [76.50794532094596, 1.0]], [0, [9.973273965126815, 1.0]], [0, [26.97547085250287, 1.0]], [0, [0.37826898133511816, 1.0]], [0, [1.102034545726898, 1.0]], [0, [2.834001930597851, 1.0]], [1, [3.683957228379679, 1.0]], [1, [12.446150208197118, 1.0]], [1, [54.760284542387026, 1.0]], [1, [0.33019085827756745, 1.0]], [1, [1.1438887418135975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413144]
bas 1, expnt(s) = [3661.45439479]
bas 2, expnt(s) = [833.27251545]
bas 3, expnt(s) = [235.71975838]
bas 4, expnt(s) = [76.50794532]
bas 5, expnt(s) = [9.97327397]
bas 6, expnt(s) = [26.97547085]
bas 7, expnt(s) = [0.37826898]
bas 8, expnt(s) = [1.10203455]
bas 9, expnt(s) = [2.83400193]
bas 10, expnt(s) = [3.68395723]
bas 11, expnt(s) = [12.44615021]
bas 12, expnt(s) = [54.76028454]
bas 13, expnt(s) = [0.33019086]
bas 14, expnt(s) = [1.14388874]
CPU time:       287.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272515e+02 3.91836887e+02 2.35719758e+02 1.51988950e+02
 7.65079453e+01 6.53574243e+01 9.97327397e+00 1.41789260e+01
 2.69754709e+01 2.99048618e+01 3.78268981e-01 1.21861234e+00
 1.10203455e+00 2.71744918e+00 2.83400193e+00 5.51842482e+00
 3.68395723e+00 1.48894144e+01 1.24461502e+01 6.81990288e+01
 5.47602845e+01 4.34576775e+02 3.30190858e-01 7.30198101e-01
 1.14388874e+00 3.45115230e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438605053611
cond(S) = 337.7202692343454
E1 = -183.57716515942727  E_coul = 55.07845709260829
init E= -128.498708066819
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947590800844  LUMO = 1.11529901318599
  mo_energy =
[-3.25552921e+01 -1.85277749e+00 -7.73947591e-01 -7.73947591e-01
 -7.73947591e-01  1.11529901e+00  1.11529901e+00  1.11529901e+00
  1.20019670e+00  5.77626818e+00  5.77626818e+00  5.77626818e+00
  7.24788586e+00  2.42066594e+01  2.42066594e+01  2.42066594e+01
  3.43873023e+01  1.19061496e+02  1.19061496e+02  1.19061496e+02
  1.38320268e+02  5.02462632e+02  1.87018966e+03  7.99992413e+03
  4.77676544e+04]
E1 = -182.11262133909216  E_coul = 53.58410806127081
cycle= 1 E= -128.528513277821  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450248
diis-c [-0.20272343  1.        ]
  HOMO = -0.879434310945888  LUMO = 1.07721355298328
  mo_energy =
[-3.28734737e+01 -1.96294091e+00 -8.79434311e-01 -8.79434311e-01
 -8.79434311e-01  1.07721355e+00  1.07721355e+00  1.07721355e+00
  1.15786442e+00  5.64755207e+00  5.64755207e+00  5.64755207e+00
  7.12119254e+00  2.39720503e+01  2.39720503e+01  2.39720503e+01
  3.41457820e+01  1.18741072e+02  1.18741072e+02  1.18741072e+02
  1.38007275e+02  5.02105736e+02  1.86979682e+03  7.99950230e+03
  4.77672137e+04]
E1 = -182.84344893301144  E_coul = 54.31243639049837
cycle= 2 E= -128.531012542513  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224532
diis-c [-6.02616198e-04  3.31744205e-01  6.68255795e-01]
  HOMO = -0.845123213008896  LUMO = 1.08968597634213
  mo_energy =
[-3.27685730e+01 -1.92685730e+00 -8.45123213e-01 -8.45123213e-01
 -8.45123213e-01  1.08968598e+00  1.08968598e+00  1.08968598e+00
  1.17155781e+00  5.68941866e+00  5.68941866e+00  5.68941866e+00
  7.16244525e+00  2.40495107e+01  2.40495107e+01  2.40495107e+01
  3.42257707e+01  1.18845995e+02  1.18845995e+02  1.18845995e+02
  1.38110243e+02  5.02219278e+02  1.86991552e+03  7.99962342e+03
  4.77673357e+04]
E1 = -182.5984728240961  E_coul = 54.06661615491508
cycle= 3 E= -128.531856669181  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984447
diis-c [-9.65078570e-08 -2.15448785e-03 -1.52449857e-04  1.00230694e+00]
  HOMO = -0.845360019279845  LUMO = 1.08963715819993
  mo_energy =
[-3.27690030e+01 -1.92703489e+00 -8.45360019e-01 -8.45360019e-01
 -8.45360019e-01  1.08963716e+00  1.08963716e+00  1.08963716e+00
  1.17150051e+00  5.68920890e+00  5.68920890e+00  5.68920890e+00
  7.16224603e+00  2.40491744e+01  2.40491744e+01  2.40491744e+01
  3.42254353e+01  1.18845553e+02  1.18845553e+02  1.18845553e+02
  1.38109814e+02  5.02218746e+02  1.86991487e+03  7.99962269e+03
  4.77673350e+04]
E1 = -182.59906320524462  E_coul = 54.06720651747828
cycle= 4 E= -128.531856687766  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136113
diis-c [-7.87799116e-10  2.88026335e-04  4.31685801e-04 -1.93288054e-01
  1.19256834e+00]
  HOMO = -0.845390833771299  LUMO = 1.08962474024543
  mo_energy =
[-3.27690574e+01 -1.92705504e+00 -8.45390834e-01 -8.45390834e-01
 -8.45390834e-01  1.08962474e+00  1.08962474e+00  1.08962474e+00
  1.17149067e+00  5.68917411e+00  5.68917411e+00  5.68917411e+00
  7.16221554e+00  2.40491268e+01  2.40491268e+01  2.40491268e+01
  3.42253882e+01  1.18845498e+02  1.18845498e+02  1.18845498e+02
  1.38109759e+02  5.02218684e+02  1.86991481e+03  7.99962261e+03
  4.77673349e+04]
E1 = -182.59918055430248  E_coul = 54.067323866084955
cycle= 5 E= -128.531856688218  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59918055430248  E_coul = 54.067323866084955
  HOMO = -0.845387922168239  LUMO = 1.08962597027358
  mo_energy =
[-3.27690512e+01 -1.92705142e+00 -8.45387922e-01 -8.45387922e-01
 -8.45387922e-01  1.08962597e+00  1.08962597e+00  1.08962597e+00
  1.17149245e+00  5.68917766e+00  5.68917766e+00  5.68917766e+00
  7.16221942e+00  2.40491321e+01  2.40491321e+01  2.40491321e+01
  3.42253938e+01  1.18845504e+02  1.18845504e+02  1.18845504e+02
  1.38109765e+02  5.02218690e+02  1.86991481e+03  7.99962262e+03
  4.77673349e+04]
E1 = -182.59916700634622  E_coul = 54.06731031812657
Extra cycle  E= -128.53185668822  delta_E= -2.13e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272515e+02 2.35719758e+02
 7.65079453e+01 9.97327397e+00 2.69754709e+01 3.78268981e-01
 1.10203455e+00 2.83400193e+00 3.68395723e+00 1.24461502e+01
 5.47602845e+01 3.30190858e-01 1.14388874e+00]
E = -128.53185668821965
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.45439479        1
[INPUT] 0    0    [1    /1   ]  833.272515451        1
[INPUT] 0    0    [1    /1   ]  235.719758375        1
[INPUT] 0    0    [1    /1   ]  76.5079453209        1
[INPUT] 0    0    [1    /1   ]  9.97327396513        1
[INPUT] 0    0    [1    /1   ]  26.9754708525        1
[INPUT] 0    0    [1    /1   ]  0.378268981335       1
[INPUT] 0    0    [1    /1   ]  1.10203454573        1
[INPUT] 0    0    [1    /1   ]  2.8340019306         1
[INPUT] 1    0    [1    /1   ]  3.68395722838        1
[INPUT] 1    0    [1    /1   ]  12.4461502082        1
[INPUT] 1    0    [1    /1   ]  54.7602845424        1
[INPUT] 1    0    [1    /1   ]  0.330190858278       1
[INPUT] 1    0    [1    /1   ]  1.14388874181        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413143964, 1.0]], [0, [3661.4543947909565, 1.0]], [0, [833.2725154508367, 1.0]], [0, [235.71975837511624, 1.0]], [0, [76.50794532094596, 1.0]], [0, [9.973273965126815, 1.0]], [0, [26.97547085250287, 1.0]], [0, [0.37826898133511816, 1.0]], [0, [1.102034545726898, 1.0]], [0, [2.834001930597851, 1.0]], [1, [3.683957228379679, 1.0]], [1, [12.446150208197118, 1.0]], [1, [54.760284542387026, 1.0]], [1, [0.33019085827756745, 1.0]], [1, [1.1438887418135975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413144]
bas 1, expnt(s) = [3661.45439479]
bas 2, expnt(s) = [833.27251545]
bas 3, expnt(s) = [235.71975838]
bas 4, expnt(s) = [76.50794532]
bas 5, expnt(s) = [9.97327397]
bas 6, expnt(s) = [26.97547085]
bas 7, expnt(s) = [0.37826898]
bas 8, expnt(s) = [1.10203455]
bas 9, expnt(s) = [2.83400193]
bas 10, expnt(s) = [3.68395723]
bas 11, expnt(s) = [12.44615021]
bas 12, expnt(s) = [54.76028454]
bas 13, expnt(s) = [0.33019086]
bas 14, expnt(s) = [1.14388874]
CPU time:       288.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145439e+03 1.18920095e+03
 8.33272515e+02 3.91836887e+02 2.35719758e+02 1.51988950e+02
 7.65079453e+01 6.53574243e+01 9.97327397e+00 1.41789260e+01
 2.69754709e+01 2.99048618e+01 3.78268981e-01 1.21861234e+00
 1.10203455e+00 2.71744918e+00 2.83400193e+00 5.51842482e+00
 3.68395723e+00 1.48894144e+01 1.24461502e+01 6.81990288e+01
 5.47602845e+01 4.34576775e+02 3.30190858e-01 7.30198101e-01
 1.14388874e+00 3.45115230e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438605053611
cond(S) = 337.7202692343454
E1 = -183.57716515942727  E_coul = 55.07845709260829
init E= -128.498708066819
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947590800844  LUMO = 1.11529901318599
  mo_energy =
[-3.25552921e+01 -1.85277749e+00 -7.73947591e-01 -7.73947591e-01
 -7.73947591e-01  1.11529901e+00  1.11529901e+00  1.11529901e+00
  1.20019670e+00  5.77626818e+00  5.77626818e+00  5.77626818e+00
  7.24788586e+00  2.42066594e+01  2.42066594e+01  2.42066594e+01
  3.43873023e+01  1.19061496e+02  1.19061496e+02  1.19061496e+02
  1.38320268e+02  5.02462632e+02  1.87018966e+03  7.99992413e+03
  4.77676544e+04]
E1 = -182.11262133909216  E_coul = 53.58410806127081
cycle= 1 E= -128.528513277821  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450248
diis-c [-0.20272343  1.        ]
  HOMO = -0.879434310945888  LUMO = 1.07721355298328
  mo_energy =
[-3.28734737e+01 -1.96294091e+00 -8.79434311e-01 -8.79434311e-01
 -8.79434311e-01  1.07721355e+00  1.07721355e+00  1.07721355e+00
  1.15786442e+00  5.64755207e+00  5.64755207e+00  5.64755207e+00
  7.12119254e+00  2.39720503e+01  2.39720503e+01  2.39720503e+01
  3.41457820e+01  1.18741072e+02  1.18741072e+02  1.18741072e+02
  1.38007275e+02  5.02105736e+02  1.86979682e+03  7.99950230e+03
  4.77672137e+04]
E1 = -182.84344893301144  E_coul = 54.31243639049837
cycle= 2 E= -128.531012542513  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224532
diis-c [-6.02616198e-04  3.31744205e-01  6.68255795e-01]
  HOMO = -0.845123213008896  LUMO = 1.08968597634213
  mo_energy =
[-3.27685730e+01 -1.92685730e+00 -8.45123213e-01 -8.45123213e-01
 -8.45123213e-01  1.08968598e+00  1.08968598e+00  1.08968598e+00
  1.17155781e+00  5.68941866e+00  5.68941866e+00  5.68941866e+00
  7.16244525e+00  2.40495107e+01  2.40495107e+01  2.40495107e+01
  3.42257707e+01  1.18845995e+02  1.18845995e+02  1.18845995e+02
  1.38110243e+02  5.02219278e+02  1.86991552e+03  7.99962342e+03
  4.77673357e+04]
E1 = -182.5984728240961  E_coul = 54.06661615491508
cycle= 3 E= -128.531856669181  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000984447
diis-c [-9.65078570e-08 -2.15448785e-03 -1.52449857e-04  1.00230694e+00]
  HOMO = -0.845360019279845  LUMO = 1.08963715819993
  mo_energy =
[-3.27690030e+01 -1.92703489e+00 -8.45360019e-01 -8.45360019e-01
 -8.45360019e-01  1.08963716e+00  1.08963716e+00  1.08963716e+00
  1.17150051e+00  5.68920890e+00  5.68920890e+00  5.68920890e+00
  7.16224603e+00  2.40491744e+01  2.40491744e+01  2.40491744e+01
  3.42254353e+01  1.18845553e+02  1.18845553e+02  1.18845553e+02
  1.38109814e+02  5.02218746e+02  1.86991487e+03  7.99962269e+03
  4.77673350e+04]
E1 = -182.59906320524462  E_coul = 54.06720651747828
cycle= 4 E= -128.531856687766  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000136113
diis-c [-7.87799116e-10  2.88026335e-04  4.31685801e-04 -1.93288054e-01
  1.19256834e+00]
  HOMO = -0.845390833771299  LUMO = 1.08962474024543
  mo_energy =
[-3.27690574e+01 -1.92705504e+00 -8.45390834e-01 -8.45390834e-01
 -8.45390834e-01  1.08962474e+00  1.08962474e+00  1.08962474e+00
  1.17149067e+00  5.68917411e+00  5.68917411e+00  5.68917411e+00
  7.16221554e+00  2.40491268e+01  2.40491268e+01  2.40491268e+01
  3.42253882e+01  1.18845498e+02  1.18845498e+02  1.18845498e+02
  1.38109759e+02  5.02218684e+02  1.86991481e+03  7.99962261e+03
  4.77673349e+04]
E1 = -182.59918055430248  E_coul = 54.067323866084955
cycle= 5 E= -128.531856688218  delta_E= -4.51e-10  |g|= 5.53e-06  |ddm|= 3.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59918055430248  E_coul = 54.067323866084955
  HOMO = -0.845387922168239  LUMO = 1.08962597027358
  mo_energy =
[-3.27690512e+01 -1.92705142e+00 -8.45387922e-01 -8.45387922e-01
 -8.45387922e-01  1.08962597e+00  1.08962597e+00  1.08962597e+00
  1.17149245e+00  5.68917766e+00  5.68917766e+00  5.68917766e+00
  7.16221942e+00  2.40491321e+01  2.40491321e+01  2.40491321e+01
  3.42253938e+01  1.18845504e+02  1.18845504e+02  1.18845504e+02
  1.38109765e+02  5.02218690e+02  1.86991481e+03  7.99962262e+03
  4.77673349e+04]
E1 = -182.59916700634622  E_coul = 54.06731031812657
Extra cycle  E= -128.53185668822  delta_E= -2.13e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.7202692343454
E1 = -182.59916700634622  E_coul = 54.06731031812657
init E= -128.53185668822
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.845388874441583  LUMO = 1.08962563871782
  mo_energy =
[-3.27690543e+01 -1.92705230e+00 -8.45388874e-01 -8.45388874e-01
 -8.45388874e-01  1.08962564e+00  1.08962564e+00  1.08962564e+00
  1.17149216e+00  5.68917651e+00  5.68917651e+00  5.68917651e+00
  7.16221834e+00  2.40491299e+01  2.40491299e+01  2.40491299e+01
  3.42253916e+01  1.18845501e+02  1.18845501e+02  1.18845501e+02
  1.38109762e+02  5.02218686e+02  1.86991481e+03  7.99962261e+03
  4.77673349e+04]
E1 = -182.59917433974493  E_coul = 54.06731765152515
cycle= 1 E= -128.53185668822  delta_E= -1.42e-13  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59917433974493  E_coul = 54.06731765152515
  HOMO = -0.845388360435513  LUMO = 1.08962582782338
  mo_energy =
[-3.27690527e+01 -1.92705173e+00 -8.45388360e-01 -8.45388360e-01
 -8.45388360e-01  1.08962583e+00  1.08962583e+00  1.08962583e+00
  1.17149238e+00  5.68917714e+00  5.68917714e+00  5.68917714e+00
  7.16221898e+00  2.40491311e+01  2.40491311e+01  2.40491311e+01
  3.42253928e+01  1.18845503e+02  1.18845503e+02  1.18845503e+02
  1.38109764e+02  5.02218688e+02  1.86991481e+03  7.99962262e+03
  4.77673349e+04]
E1 = -182.5991707033064  E_coul = 54.06731401508654
Extra cycle  E= -128.53185668822  delta_E= -8.53e-14  |g|= 4.95e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [2.44137941e+04 3.66145439e+03 8.33272515e+02 2.35719758e+02
 7.65079453e+01 9.97327397e+00 2.69754709e+01 3.78268981e-01
 1.10203455e+00 2.83400193e+00 3.68395723e+00 1.24461502e+01
 5.47602845e+01 3.30190858e-01 1.14388874e+00]
grad_E = [ 5.52672133e-10 -2.86845821e-08  5.56252935e-07 -5.71409702e-06
  2.85151068e-05 -3.08632482e-05 -2.76125673e-05 -3.49924337e-05
  1.99787408e-05 -1.12042270e-05 -1.05518317e-06  4.05031976e-07
 -3.42749030e-07 -5.10695324e-05  1.28522678e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.4543961         1
[INPUT] 0    0    [1    /1   ]  833.272489976        1
[INPUT] 0    0    [1    /1   ]  235.720027949        1
[INPUT] 0    0    [1    /1   ]  76.5064564602        1
[INPUT] 0    0    [1    /1   ]  9.97322637122        1
[INPUT] 0    0    [1    /1   ]  26.9782147531        1
[INPUT] 0    0    [1    /1   ]  0.378132858213       1
[INPUT] 0    0    [1    /1   ]  1.10132270892        1
[INPUT] 0    0    [1    /1   ]  2.83017475468        1
[INPUT] 1    0    [1    /1   ]  3.68418882445        1
[INPUT] 1    0    [1    /1   ]  12.4472452285        1
[INPUT] 1    0    [1    /1   ]  54.7662011579        1
[INPUT] 1    0    [1    /1   ]  0.330188079865       1
[INPUT] 1    0    [1    /1   ]  1.14393102578        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141456, 1.0]], [0, [3661.4543960955425, 1.0]], [0, [833.272489976118, 1.0]], [0, [235.72002794859145, 1.0]], [0, [76.50645646021145, 1.0]], [0, [9.973226371224632, 1.0]], [0, [26.978214753139394, 1.0]], [0, [0.37813285821326675, 1.0]], [0, [1.1013227089164392, 1.0]], [0, [2.8301747546777936, 1.0]], [1, [3.6841888244450396, 1.0]], [1, [12.447245228478957, 1.0]], [1, [54.76620115791704, 1.0]], [1, [0.3301880798653283, 1.0]], [1, [1.143931025781407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.4543961]
bas 2, expnt(s) = [833.27248998]
bas 3, expnt(s) = [235.72002795]
bas 4, expnt(s) = [76.50645646]
bas 5, expnt(s) = [9.97322637]
bas 6, expnt(s) = [26.97821475]
bas 7, expnt(s) = [0.37813286]
bas 8, expnt(s) = [1.10132271]
bas 9, expnt(s) = [2.83017475]
bas 10, expnt(s) = [3.68418882]
bas 11, expnt(s) = [12.44724523]
bas 12, expnt(s) = [54.76620116]
bas 13, expnt(s) = [0.33018808]
bas 14, expnt(s) = [1.14393103]
CPU time:       291.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272490e+02 3.91836878e+02 2.35720028e+02 1.51989080e+02
 7.65064565e+01 6.53564704e+01 9.97322637e+00 1.41788753e+01
 2.69782148e+01 2.99071432e+01 3.78132858e-01 1.21828343e+00
 1.10132271e+00 2.71613261e+00 2.83017475e+00 5.51283461e+00
 3.68418882e+00 1.48905844e+01 1.24472452e+01 6.82065291e+01
 5.47662012e+01 4.34635469e+02 3.30188080e-01 7.30190420e-01
 1.14393103e+00 3.45131176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438672800711
cond(S) = 337.43720645750307
E1 = -183.57716513382317  E_coul = 55.078454619951586
init E= -128.498710513872
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947785489188  LUMO = 1.115305111039
  mo_energy =
[-3.25552920e+01 -1.85277819e+00 -7.73947785e-01 -7.73947785e-01
 -7.73947785e-01  1.11530511e+00  1.11530511e+00  1.11530511e+00
  1.19929895e+00  5.77651792e+00  5.77651792e+00  5.77651792e+00
  7.24001032e+00  2.42085881e+01  2.42085881e+01  2.42085881e+01
  3.43704126e+01  1.19074830e+02  1.19074830e+02  1.19074830e+02
  1.38306573e+02  5.02451567e+02  1.87017959e+03  7.99991527e+03
  4.77676470e+04]
E1 = -182.11258807221782  E_coul = 53.584074792646504
cycle= 1 E= -128.528513279571  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450241
diis-c [-0.20271677  1.        ]
  HOMO = -0.879437260407082  LUMO = 1.07721709502949
  mo_energy =
[-3.28734783e+01 -1.96294415e+00 -8.79437260e-01 -8.79437260e-01
 -8.79437260e-01  1.07721710e+00  1.07721710e+00  1.07721710e+00
  1.15700051e+00  5.64779332e+00  5.64779332e+00  5.64779332e+00
  7.11339815e+00  2.39739675e+01  2.39739675e+01  2.39739675e+01
  3.41288951e+01  1.18754397e+02  1.18754397e+02  1.18754397e+02
  1.37993571e+02  5.02094666e+02  1.86978674e+03  7.99949343e+03
  4.77672064e+04]
E1 = -182.84342359186013  E_coul = 54.31241100812698
cycle= 2 E= -128.531012583733  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224528
diis-c [-6.02534008e-04  3.31744276e-01  6.68255724e-01]
  HOMO = -0.84512580157485  LUMO = 1.08968996979941
  mo_energy =
[-3.27685765e+01 -1.92686017e+00 -8.45125802e-01 -8.45125802e-01
 -8.45125802e-01  1.08968997e+00  1.08968997e+00  1.08968997e+00
  1.17068249e+00  5.68966218e+00  5.68966218e+00  5.68966218e+00
  7.15462334e+00  2.40514310e+01  2.40514310e+01  2.40514310e+01
  3.42088826e+01  1.18859323e+02  1.18859323e+02  1.18859323e+02
  1.38096541e+02  5.02208210e+02  1.86990545e+03  7.99961455e+03
  4.77673284e+04]
E1 = -182.59844158906049  E_coul = 54.06658485041827
cycle= 3 E= -128.531856738642  delta_E= -0.000844  |g|= 0.000475  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985096
diis-c [-9.65874890e-08 -2.15522882e-03 -1.50984683e-04  1.00230621e+00]
  HOMO = -0.845362834994904  LUMO = 1.08964104674578
  mo_energy =
[-3.27690068e+01 -1.92703798e+00 -8.45362835e-01 -8.45362835e-01
 -8.45362835e-01  1.08964105e+00  1.08964105e+00  1.08964105e+00
  1.17062511e+00  5.68945216e+00  5.68945216e+00  5.68945216e+00
  7.15442398e+00  2.40510944e+01  2.40510944e+01  2.40510944e+01
  3.42085468e+01  1.18858880e+02  1.18858880e+02  1.18858880e+02
  1.38096112e+02  5.02207677e+02  1.86990480e+03  7.99961382e+03
  4.77673276e+04]
E1 = -182.5990324583719  E_coul = 54.06717570110945
cycle= 4 E= -128.531856757262  delta_E= -1.86e-08  |g|= 6.22e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136154
diis-c [-7.88198572e-10  2.88046490e-04  4.31406567e-04 -1.93275113e-01
  1.19255566e+00]
  HOMO = -0.845393672531615  LUMO = 1.08962861761043
  mo_energy =
[-3.27690612e+01 -1.92705815e+00 -8.45393673e-01 -8.45393673e-01
 -8.45393673e-01  1.08962862e+00  1.08962862e+00  1.08962862e+00
  1.17061527e+00  5.68941734e+00  5.68941734e+00  5.68941734e+00
  7.15439347e+00  2.40510468e+01  2.40510468e+01  2.40510468e+01
  3.42084998e+01  1.18858825e+02  1.18858825e+02  1.18858825e+02
  1.38096057e+02  5.02207615e+02  1.86990473e+03  7.99961375e+03
  4.77673276e+04]
E1 = -182.5991498215891  E_coul = 54.06729306387473
cycle= 5 E= -128.531856757714  delta_E= -4.52e-10  |g|= 5.53e-06  |ddm|= 3.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5991498215891  E_coul = 54.06729306387473
  HOMO = -0.845390760512362  LUMO = 1.08962984795165
  mo_energy =
[-3.27690550e+01 -1.92705452e+00 -8.45390761e-01 -8.45390761e-01
 -8.45390761e-01  1.08962985e+00  1.08962985e+00  1.08962985e+00
  1.17061705e+00  5.68942090e+00  5.68942090e+00  5.68942090e+00
  7.15439735e+00  2.40510521e+01  2.40510521e+01  2.40510521e+01
  3.42085054e+01  1.18858831e+02  1.18858831e+02  1.18858831e+02
  1.38096063e+02  5.02207621e+02  1.86990474e+03  7.99961375e+03
  4.77673276e+04]
E1 = -182.59913627617553  E_coul = 54.067279518459024
Extra cycle  E= -128.531856757716  delta_E= -2.13e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272490e+02 2.35720028e+02
 7.65064565e+01 9.97322637e+00 2.69782148e+01 3.78132858e-01
 1.10132271e+00 2.83017475e+00 3.68418882e+00 1.24472452e+01
 5.47662012e+01 3.30188080e-01 1.14393103e+00]
E = -128.5318567577165
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941314        1
[INPUT] 0    0    [1    /1   ]  3661.4543961         1
[INPUT] 0    0    [1    /1   ]  833.272489976        1
[INPUT] 0    0    [1    /1   ]  235.720027949        1
[INPUT] 0    0    [1    /1   ]  76.5064564602        1
[INPUT] 0    0    [1    /1   ]  9.97322637122        1
[INPUT] 0    0    [1    /1   ]  26.9782147531        1
[INPUT] 0    0    [1    /1   ]  0.378132858213       1
[INPUT] 0    0    [1    /1   ]  1.10132270892        1
[INPUT] 0    0    [1    /1   ]  2.83017475468        1
[INPUT] 1    0    [1    /1   ]  3.68418882445        1
[INPUT] 1    0    [1    /1   ]  12.4472452285        1
[INPUT] 1    0    [1    /1   ]  54.7662011579        1
[INPUT] 1    0    [1    /1   ]  0.330188079865       1
[INPUT] 1    0    [1    /1   ]  1.14393102578        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413141456, 1.0]], [0, [3661.4543960955425, 1.0]], [0, [833.272489976118, 1.0]], [0, [235.72002794859145, 1.0]], [0, [76.50645646021145, 1.0]], [0, [9.973226371224632, 1.0]], [0, [26.978214753139394, 1.0]], [0, [0.37813285821326675, 1.0]], [0, [1.1013227089164392, 1.0]], [0, [2.8301747546777936, 1.0]], [1, [3.6841888244450396, 1.0]], [1, [12.447245228478957, 1.0]], [1, [54.76620115791704, 1.0]], [1, [0.3301880798653283, 1.0]], [1, [1.143931025781407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413141]
bas 1, expnt(s) = [3661.4543961]
bas 2, expnt(s) = [833.27248998]
bas 3, expnt(s) = [235.72002795]
bas 4, expnt(s) = [76.50645646]
bas 5, expnt(s) = [9.97322637]
bas 6, expnt(s) = [26.97821475]
bas 7, expnt(s) = [0.37813286]
bas 8, expnt(s) = [1.10132271]
bas 9, expnt(s) = [2.83017475]
bas 10, expnt(s) = [3.68418882]
bas 11, expnt(s) = [12.44724523]
bas 12, expnt(s) = [54.76620116]
bas 13, expnt(s) = [0.33018808]
bas 14, expnt(s) = [1.14393103]
CPU time:       292.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272490e+02 3.91836878e+02 2.35720028e+02 1.51989080e+02
 7.65064565e+01 6.53564704e+01 9.97322637e+00 1.41788753e+01
 2.69782148e+01 2.99071432e+01 3.78132858e-01 1.21828343e+00
 1.10132271e+00 2.71613261e+00 2.83017475e+00 5.51283461e+00
 3.68418882e+00 1.48905844e+01 1.24472452e+01 6.82065291e+01
 5.47662012e+01 4.34635469e+02 3.30188080e-01 7.30190420e-01
 1.14393103e+00 3.45131176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438672800711
cond(S) = 337.43720645750307
E1 = -183.57716513382317  E_coul = 55.078454619951586
init E= -128.498710513872
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947785489188  LUMO = 1.115305111039
  mo_energy =
[-3.25552920e+01 -1.85277819e+00 -7.73947785e-01 -7.73947785e-01
 -7.73947785e-01  1.11530511e+00  1.11530511e+00  1.11530511e+00
  1.19929895e+00  5.77651792e+00  5.77651792e+00  5.77651792e+00
  7.24001032e+00  2.42085881e+01  2.42085881e+01  2.42085881e+01
  3.43704126e+01  1.19074830e+02  1.19074830e+02  1.19074830e+02
  1.38306573e+02  5.02451567e+02  1.87017959e+03  7.99991527e+03
  4.77676470e+04]
E1 = -182.11258807221782  E_coul = 53.584074792646504
cycle= 1 E= -128.528513279571  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450241
diis-c [-0.20271677  1.        ]
  HOMO = -0.879437260407082  LUMO = 1.07721709502949
  mo_energy =
[-3.28734783e+01 -1.96294415e+00 -8.79437260e-01 -8.79437260e-01
 -8.79437260e-01  1.07721710e+00  1.07721710e+00  1.07721710e+00
  1.15700051e+00  5.64779332e+00  5.64779332e+00  5.64779332e+00
  7.11339815e+00  2.39739675e+01  2.39739675e+01  2.39739675e+01
  3.41288951e+01  1.18754397e+02  1.18754397e+02  1.18754397e+02
  1.37993571e+02  5.02094666e+02  1.86978674e+03  7.99949343e+03
  4.77672064e+04]
E1 = -182.84342359186013  E_coul = 54.31241100812698
cycle= 2 E= -128.531012583733  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224528
diis-c [-6.02534008e-04  3.31744276e-01  6.68255724e-01]
  HOMO = -0.84512580157485  LUMO = 1.08968996979941
  mo_energy =
[-3.27685765e+01 -1.92686017e+00 -8.45125802e-01 -8.45125802e-01
 -8.45125802e-01  1.08968997e+00  1.08968997e+00  1.08968997e+00
  1.17068249e+00  5.68966218e+00  5.68966218e+00  5.68966218e+00
  7.15462334e+00  2.40514310e+01  2.40514310e+01  2.40514310e+01
  3.42088826e+01  1.18859323e+02  1.18859323e+02  1.18859323e+02
  1.38096541e+02  5.02208210e+02  1.86990545e+03  7.99961455e+03
  4.77673284e+04]
E1 = -182.59844158906049  E_coul = 54.06658485041827
cycle= 3 E= -128.531856738642  delta_E= -0.000844  |g|= 0.000475  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000985096
diis-c [-9.65874890e-08 -2.15522882e-03 -1.50984683e-04  1.00230621e+00]
  HOMO = -0.845362834994904  LUMO = 1.08964104674578
  mo_energy =
[-3.27690068e+01 -1.92703798e+00 -8.45362835e-01 -8.45362835e-01
 -8.45362835e-01  1.08964105e+00  1.08964105e+00  1.08964105e+00
  1.17062511e+00  5.68945216e+00  5.68945216e+00  5.68945216e+00
  7.15442398e+00  2.40510944e+01  2.40510944e+01  2.40510944e+01
  3.42085468e+01  1.18858880e+02  1.18858880e+02  1.18858880e+02
  1.38096112e+02  5.02207677e+02  1.86990480e+03  7.99961382e+03
  4.77673276e+04]
E1 = -182.5990324583719  E_coul = 54.06717570110945
cycle= 4 E= -128.531856757262  delta_E= -1.86e-08  |g|= 6.22e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000136154
diis-c [-7.88198572e-10  2.88046490e-04  4.31406567e-04 -1.93275113e-01
  1.19255566e+00]
  HOMO = -0.845393672531615  LUMO = 1.08962861761043
  mo_energy =
[-3.27690612e+01 -1.92705815e+00 -8.45393673e-01 -8.45393673e-01
 -8.45393673e-01  1.08962862e+00  1.08962862e+00  1.08962862e+00
  1.17061527e+00  5.68941734e+00  5.68941734e+00  5.68941734e+00
  7.15439347e+00  2.40510468e+01  2.40510468e+01  2.40510468e+01
  3.42084998e+01  1.18858825e+02  1.18858825e+02  1.18858825e+02
  1.38096057e+02  5.02207615e+02  1.86990473e+03  7.99961375e+03
  4.77673276e+04]
E1 = -182.5991498215891  E_coul = 54.06729306387473
cycle= 5 E= -128.531856757714  delta_E= -4.52e-10  |g|= 5.53e-06  |ddm|= 3.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5991498215891  E_coul = 54.06729306387473
  HOMO = -0.845390760512362  LUMO = 1.08962984795165
  mo_energy =
[-3.27690550e+01 -1.92705452e+00 -8.45390761e-01 -8.45390761e-01
 -8.45390761e-01  1.08962985e+00  1.08962985e+00  1.08962985e+00
  1.17061705e+00  5.68942090e+00  5.68942090e+00  5.68942090e+00
  7.15439735e+00  2.40510521e+01  2.40510521e+01  2.40510521e+01
  3.42085054e+01  1.18858831e+02  1.18858831e+02  1.18858831e+02
  1.38096063e+02  5.02207621e+02  1.86990474e+03  7.99961375e+03
  4.77673276e+04]
E1 = -182.59913627617553  E_coul = 54.067279518459024
Extra cycle  E= -128.531856757716  delta_E= -2.13e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.43720645750307
E1 = -182.59913627617553  E_coul = 54.067279518459024
init E= -128.531856757716
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.845391712603429  LUMO = 1.08962951646738
  mo_energy =
[-3.27690581e+01 -1.92705540e+00 -8.45391713e-01 -8.45391713e-01
 -8.45391713e-01  1.08962952e+00  1.08962952e+00  1.08962952e+00
  1.17061676e+00  5.68941975e+00  5.68941975e+00  5.68941975e+00
  7.15439628e+00  2.40510499e+01  2.40510499e+01  2.40510499e+01
  3.42085031e+01  1.18858828e+02  1.18858828e+02  1.18858828e+02
  1.38096060e+02  5.02207617e+02  1.86990474e+03  7.99961375e+03
  4.77673276e+04]
E1 = -182.59914360888732  E_coul = 54.06728685117087
cycle= 1 E= -128.531856757716  delta_E= 5.68e-14  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59914360888732  E_coul = 54.06728685117087
  HOMO = -0.845391198646919  LUMO = 1.08962970556212
  mo_energy =
[-3.27690565e+01 -1.92705483e+00 -8.45391199e-01 -8.45391199e-01
 -8.45391199e-01  1.08962971e+00  1.08962971e+00  1.08962971e+00
  1.17061698e+00  5.68942038e+00  5.68942038e+00  5.68942038e+00
  7.15439691e+00  2.40510511e+01  2.40510511e+01  2.40510511e+01
  3.42085043e+01  1.18858830e+02  1.18858830e+02  1.18858830e+02
  1.38096062e+02  5.02207619e+02  1.86990474e+03  7.99961375e+03
  4.77673276e+04]
E1 = -182.59913997282263  E_coul = 54.06728321510594
Extra cycle  E= -128.531856757717  delta_E= -2.56e-13  |g|= 4.95e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272490e+02 2.35720028e+02
 7.65064565e+01 9.97322637e+00 2.69782148e+01 3.78132858e-01
 1.10132271e+00 2.83017475e+00 3.68418882e+00 1.24472452e+01
 5.47662012e+01 3.30188080e-01 1.14393103e+00]
grad_E = [ 5.28543437e-10 -2.74272004e-08  5.31583082e-07 -5.44681803e-06
  2.68392640e-05 -3.62197322e-05 -2.24080178e-05 -6.75071869e-05
  4.16919294e-05 -1.79682087e-05 -2.53770404e-06  9.23420916e-07
 -3.17991835e-07 -1.06631568e-04  2.75365123e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941313        1
[INPUT] 0    0    [1    /1   ]  3661.45439971        1
[INPUT] 0    0    [1    /1   ]  833.272419526        1
[INPUT] 0    0    [1    /1   ]  235.720763752        1
[INPUT] 0    0    [1    /1   ]  76.5025596887        1
[INPUT] 0    0    [1    /1   ]  9.97449741987        1
[INPUT] 0    0    [1    /1   ]  26.9840583244        1
[INPUT] 0    0    [1    /1   ]  0.377994380411       1
[INPUT] 0    0    [1    /1   ]  1.10055529507        1
[INPUT] 0    0    [1    /1   ]  2.82530975433        1
[INPUT] 1    0    [1    /1   ]  3.6845695478         1
[INPUT] 1    0    [1    /1   ]  12.4490346516        1
[INPUT] 1    0    [1    /1   ]  54.7758902464        1
[INPUT] 1    0    [1    /1   ]  0.330184575778       1
[INPUT] 1    0    [1    /1   ]  1.14400212984        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413134492, 1.0]], [0, [3661.4543997144783, 1.0]], [0, [833.2724195260687, 1.0]], [0, [235.7207637518087, 1.0]], [0, [76.5025596887434, 1.0]], [0, [9.974497419869007, 1.0]], [0, [26.984058324419507, 1.0]], [0, [0.377994380411266, 1.0]], [0, [1.1005552950674387, 1.0]], [0, [2.8253097543263537, 1.0]], [1, [3.684569547795923, 1.0]], [1, [12.449034651628455, 1.0]], [1, [54.77589024637472, 1.0]], [1, [0.330184575777944, 1.0]], [1, [1.144002129841969, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413134]
bas 1, expnt(s) = [3661.45439971]
bas 2, expnt(s) = [833.27241953]
bas 3, expnt(s) = [235.72076375]
bas 4, expnt(s) = [76.50255969]
bas 5, expnt(s) = [9.97449742]
bas 6, expnt(s) = [26.98405832]
bas 7, expnt(s) = [0.37799438]
bas 8, expnt(s) = [1.1005553]
bas 9, expnt(s) = [2.82530975]
bas 10, expnt(s) = [3.68456955]
bas 11, expnt(s) = [12.44903465]
bas 12, expnt(s) = [54.77589025]
bas 13, expnt(s) = [0.33018458]
bas 14, expnt(s) = [1.14400213]
CPU time:       296.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272420e+02 3.91836853e+02 2.35720764e+02 1.51989436e+02
 7.65025597e+01 6.53539737e+01 9.97449742e+00 1.41802305e+01
 2.69840583e+01 2.99120015e+01 3.77994380e-01 1.21794880e+00
 1.10055530e+00 2.71471301e+00 2.82530975e+00 5.50572577e+00
 3.68456955e+00 1.48925079e+01 1.24490347e+01 6.82187861e+01
 5.47758902e+01 4.34731589e+02 3.30184576e-01 7.30180734e-01
 1.14400213e+00 3.45157992e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438652274476
cond(S) = 337.135829954533
E1 = -183.57716632654615  E_coul = 55.07845080354098
init E= -128.498715523005
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948084044251  LUMO = 1.1153187993008
  mo_energy =
[-3.25552922e+01 -1.85277904e+00 -7.73948084e-01 -7.73948084e-01
 -7.73948084e-01  1.11531880e+00  1.11531880e+00  1.11531880e+00
  1.19832893e+00  5.77693692e+00  5.77693692e+00  5.77693692e+00
  7.23070955e+00  2.42117566e+01  2.42117566e+01  2.42117566e+01
  3.43528829e+01  1.19096666e+02  1.19096666e+02  1.19096666e+02
  1.38298503e+02  5.02446787e+02  1.87017455e+03  7.99991076e+03
  4.77676433e+04]
E1 = -182.11254081937747  E_coul = 53.58402745325276
cycle= 1 E= -128.528513366125  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450228
diis-c [-0.20270492  1.        ]
  HOMO = -0.879441493118954  LUMO = 1.07722685150951
  mo_energy =
[-3.28734848e+01 -1.96294878e+00 -8.79441493e-01 -8.79441493e-01
 -8.79441493e-01  1.07722685e+00  1.07722685e+00  1.07722685e+00
  1.15606784e+00  5.64819896e+00  5.64819896e+00  5.64819896e+00
  7.10419390e+00  2.39771180e+01  2.39771180e+01  2.39771180e+01
  3.41113604e+01  1.18776220e+02  1.18776220e+02  1.18776220e+02
  1.37985488e+02  5.02089879e+02  1.86978170e+03  7.99948892e+03
  4.77672026e+04]
E1 = -182.84338658469906  E_coul = 54.31237386268984
cycle= 2 E= -128.531012722009  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224521
diis-c [-6.02450777e-04  3.31744313e-01  6.68255687e-01]
  HOMO = -0.845129577792208  LUMO = 1.08970045034107
  mo_energy =
[-3.27685814e+01 -1.92686431e+00 -8.45129578e-01 -8.45129578e-01
 -8.45129578e-01  1.08970045e+00  1.08970045e+00  1.08970045e+00
  1.16973700e+00  5.69007139e+00  5.69007139e+00  5.69007139e+00
  7.14538612e+00  2.40545866e+01  2.40545866e+01  2.40545866e+01
  3.41913491e+01  1.18881148e+02  1.18881148e+02  1.18881148e+02
  1.38088463e+02  5.02203426e+02  1.86990041e+03  7.99961005e+03
  4.77673247e+04]
E1 = -182.5983965064732  E_coul = 54.066539590999824
cycle= 3 E= -128.531856915473  delta_E= -0.000844  |g|= 0.000475  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000986016
diis-c [-9.66699783e-08 -2.15630945e-03 -1.48875914e-04  1.00230519e+00]
  HOMO = -0.845366938454214  LUMO = 1.08965137613781
  mo_energy =
[-3.27690123e+01 -1.92704245e+00 -8.45366938e-01 -8.45366938e-01
 -8.45366938e-01  1.08965138e+00  1.08965138e+00  1.08965138e+00
  1.16967949e+00  5.68986100e+00  5.68986100e+00  5.68986100e+00
  7.14518651e+00  2.40542495e+01  2.40542495e+01  2.40542495e+01
  3.41910128e+01  1.18880706e+02  1.18880706e+02  1.18880706e+02
  1.38088033e+02  5.02202892e+02  1.86989976e+03  7.99960932e+03
  4.77673239e+04]
E1 = -182.5989881052936  E_coul = 54.06713117115181
cycle= 4 E= -128.531856934142  delta_E= -1.87e-08  |g|= 6.22e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136201
diis-c [-7.88632743e-10  2.88044768e-04  4.30995311e-04 -1.93231994e-01
  1.19251295e+00]
  HOMO = -0.845397806336787  LUMO = 1.08963893205868
  mo_energy =
[-3.27690666e+01 -1.92706264e+00 -8.45397806e-01 -8.45397806e-01
 -8.45397806e-01  1.08963893e+00  1.08963893e+00  1.08963893e+00
  1.16966964e+00  5.68982615e+00  5.68982615e+00  5.68982615e+00
  7.14515599e+00  2.40542018e+01  2.40542018e+01  2.40542018e+01
  3.41909657e+01  1.18880651e+02  1.18880651e+02  1.18880651e+02
  1.38087978e+02  5.02202830e+02  1.86989969e+03  7.99960924e+03
  4.77673238e+04]
E1 = -182.5991054850894  E_coul = 54.06724855049457
cycle= 5 E= -128.531856934595  delta_E= -4.53e-10  |g|= 5.54e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5991054850894  E_coul = 54.06724855049457
  HOMO = -0.845394894284071  LUMO = 1.08964016262615
  mo_energy =
[-3.27690605e+01 -1.92705901e+00 -8.45394894e-01 -8.45394894e-01
 -8.45394894e-01  1.08964016e+00  1.08964016e+00  1.08964016e+00
  1.16967142e+00  5.68982971e+00  5.68982971e+00  5.68982971e+00
  7.14515987e+00  2.40542072e+01  2.40542072e+01  2.40542072e+01
  3.41909713e+01  1.18880657e+02  1.18880657e+02  1.18880657e+02
  1.38087984e+02  5.02202836e+02  1.86989970e+03  7.99960925e+03
  4.77673238e+04]
E1 = -182.5990919460051  E_coul = 54.06723501140868
Extra cycle  E= -128.531856934596  delta_E= -1.59e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272420e+02 2.35720764e+02
 7.65025597e+01 9.97449742e+00 2.69840583e+01 3.77994380e-01
 1.10055530e+00 2.82530975e+00 3.68456955e+00 1.24490347e+01
 5.47758902e+01 3.30184576e-01 1.14400213e+00]
E = -128.53185693459642
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941313        1
[INPUT] 0    0    [1    /1   ]  3661.45439971        1
[INPUT] 0    0    [1    /1   ]  833.272419526        1
[INPUT] 0    0    [1    /1   ]  235.720763752        1
[INPUT] 0    0    [1    /1   ]  76.5025596887        1
[INPUT] 0    0    [1    /1   ]  9.97449741987        1
[INPUT] 0    0    [1    /1   ]  26.9840583244        1
[INPUT] 0    0    [1    /1   ]  0.377994380411       1
[INPUT] 0    0    [1    /1   ]  1.10055529507        1
[INPUT] 0    0    [1    /1   ]  2.82530975433        1
[INPUT] 1    0    [1    /1   ]  3.6845695478         1
[INPUT] 1    0    [1    /1   ]  12.4490346516        1
[INPUT] 1    0    [1    /1   ]  54.7758902464        1
[INPUT] 1    0    [1    /1   ]  0.330184575778       1
[INPUT] 1    0    [1    /1   ]  1.14400212984        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79413134492, 1.0]], [0, [3661.4543997144783, 1.0]], [0, [833.2724195260687, 1.0]], [0, [235.7207637518087, 1.0]], [0, [76.5025596887434, 1.0]], [0, [9.974497419869007, 1.0]], [0, [26.984058324419507, 1.0]], [0, [0.377994380411266, 1.0]], [0, [1.1005552950674387, 1.0]], [0, [2.8253097543263537, 1.0]], [1, [3.684569547795923, 1.0]], [1, [12.449034651628455, 1.0]], [1, [54.77589024637472, 1.0]], [1, [0.330184575777944, 1.0]], [1, [1.144002129841969, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413134]
bas 1, expnt(s) = [3661.45439971]
bas 2, expnt(s) = [833.27241953]
bas 3, expnt(s) = [235.72076375]
bas 4, expnt(s) = [76.50255969]
bas 5, expnt(s) = [9.97449742]
bas 6, expnt(s) = [26.98405832]
bas 7, expnt(s) = [0.37799438]
bas 8, expnt(s) = [1.1005553]
bas 9, expnt(s) = [2.82530975]
bas 10, expnt(s) = [3.68456955]
bas 11, expnt(s) = [12.44903465]
bas 12, expnt(s) = [54.77589025]
bas 13, expnt(s) = [0.33018458]
bas 14, expnt(s) = [1.14400213]
CPU time:       297.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145440e+03 1.18920095e+03
 8.33272420e+02 3.91836853e+02 2.35720764e+02 1.51989436e+02
 7.65025597e+01 6.53539737e+01 9.97449742e+00 1.41802305e+01
 2.69840583e+01 2.99120015e+01 3.77994380e-01 1.21794880e+00
 1.10055530e+00 2.71471301e+00 2.82530975e+00 5.50572577e+00
 3.68456955e+00 1.48925079e+01 1.24490347e+01 6.82187861e+01
 5.47758902e+01 4.34731589e+02 3.30184576e-01 7.30180734e-01
 1.14400213e+00 3.45157992e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438652274476
cond(S) = 337.135829954533
E1 = -183.57716632654615  E_coul = 55.07845080354098
init E= -128.498715523005
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948084044251  LUMO = 1.1153187993008
  mo_energy =
[-3.25552922e+01 -1.85277904e+00 -7.73948084e-01 -7.73948084e-01
 -7.73948084e-01  1.11531880e+00  1.11531880e+00  1.11531880e+00
  1.19832893e+00  5.77693692e+00  5.77693692e+00  5.77693692e+00
  7.23070955e+00  2.42117566e+01  2.42117566e+01  2.42117566e+01
  3.43528829e+01  1.19096666e+02  1.19096666e+02  1.19096666e+02
  1.38298503e+02  5.02446787e+02  1.87017455e+03  7.99991076e+03
  4.77676433e+04]
E1 = -182.11254081937747  E_coul = 53.58402745325276
cycle= 1 E= -128.528513366125  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450228
diis-c [-0.20270492  1.        ]
  HOMO = -0.879441493118954  LUMO = 1.07722685150951
  mo_energy =
[-3.28734848e+01 -1.96294878e+00 -8.79441493e-01 -8.79441493e-01
 -8.79441493e-01  1.07722685e+00  1.07722685e+00  1.07722685e+00
  1.15606784e+00  5.64819896e+00  5.64819896e+00  5.64819896e+00
  7.10419390e+00  2.39771180e+01  2.39771180e+01  2.39771180e+01
  3.41113604e+01  1.18776220e+02  1.18776220e+02  1.18776220e+02
  1.37985488e+02  5.02089879e+02  1.86978170e+03  7.99948892e+03
  4.77672026e+04]
E1 = -182.84338658469906  E_coul = 54.31237386268984
cycle= 2 E= -128.531012722009  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224521
diis-c [-6.02450777e-04  3.31744313e-01  6.68255687e-01]
  HOMO = -0.845129577792208  LUMO = 1.08970045034107
  mo_energy =
[-3.27685814e+01 -1.92686431e+00 -8.45129578e-01 -8.45129578e-01
 -8.45129578e-01  1.08970045e+00  1.08970045e+00  1.08970045e+00
  1.16973700e+00  5.69007139e+00  5.69007139e+00  5.69007139e+00
  7.14538612e+00  2.40545866e+01  2.40545866e+01  2.40545866e+01
  3.41913491e+01  1.18881148e+02  1.18881148e+02  1.18881148e+02
  1.38088463e+02  5.02203426e+02  1.86990041e+03  7.99961005e+03
  4.77673247e+04]
E1 = -182.5983965064732  E_coul = 54.066539590999824
cycle= 3 E= -128.531856915473  delta_E= -0.000844  |g|= 0.000475  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000986016
diis-c [-9.66699783e-08 -2.15630945e-03 -1.48875914e-04  1.00230519e+00]
  HOMO = -0.845366938454214  LUMO = 1.08965137613781
  mo_energy =
[-3.27690123e+01 -1.92704245e+00 -8.45366938e-01 -8.45366938e-01
 -8.45366938e-01  1.08965138e+00  1.08965138e+00  1.08965138e+00
  1.16967949e+00  5.68986100e+00  5.68986100e+00  5.68986100e+00
  7.14518651e+00  2.40542495e+01  2.40542495e+01  2.40542495e+01
  3.41910128e+01  1.18880706e+02  1.18880706e+02  1.18880706e+02
  1.38088033e+02  5.02202892e+02  1.86989976e+03  7.99960932e+03
  4.77673239e+04]
E1 = -182.5989881052936  E_coul = 54.06713117115181
cycle= 4 E= -128.531856934142  delta_E= -1.87e-08  |g|= 6.22e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000136201
diis-c [-7.88632743e-10  2.88044768e-04  4.30995311e-04 -1.93231994e-01
  1.19251295e+00]
  HOMO = -0.845397806336787  LUMO = 1.08963893205868
  mo_energy =
[-3.27690666e+01 -1.92706264e+00 -8.45397806e-01 -8.45397806e-01
 -8.45397806e-01  1.08963893e+00  1.08963893e+00  1.08963893e+00
  1.16966964e+00  5.68982615e+00  5.68982615e+00  5.68982615e+00
  7.14515599e+00  2.40542018e+01  2.40542018e+01  2.40542018e+01
  3.41909657e+01  1.18880651e+02  1.18880651e+02  1.18880651e+02
  1.38087978e+02  5.02202830e+02  1.86989969e+03  7.99960924e+03
  4.77673238e+04]
E1 = -182.5991054850894  E_coul = 54.06724855049457
cycle= 5 E= -128.531856934595  delta_E= -4.53e-10  |g|= 5.54e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5991054850894  E_coul = 54.06724855049457
  HOMO = -0.845394894284071  LUMO = 1.08964016262615
  mo_energy =
[-3.27690605e+01 -1.92705901e+00 -8.45394894e-01 -8.45394894e-01
 -8.45394894e-01  1.08964016e+00  1.08964016e+00  1.08964016e+00
  1.16967142e+00  5.68982971e+00  5.68982971e+00  5.68982971e+00
  7.14515987e+00  2.40542072e+01  2.40542072e+01  2.40542072e+01
  3.41909713e+01  1.18880657e+02  1.18880657e+02  1.18880657e+02
  1.38087984e+02  5.02202836e+02  1.86989970e+03  7.99960925e+03
  4.77673238e+04]
E1 = -182.5990919460051  E_coul = 54.06723501140868
Extra cycle  E= -128.531856934596  delta_E= -1.59e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.135829954533
E1 = -182.5990919460051  E_coul = 54.06723501140868
init E= -128.531856934596
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845395845929715  LUMO = 1.08963983130651
  mo_energy =
[-3.27690635e+01 -1.92705989e+00 -8.45395846e-01 -8.45395846e-01
 -8.45395846e-01  1.08963983e+00  1.08963983e+00  1.08963983e+00
  1.16967113e+00  5.68982855e+00  5.68982855e+00  5.68982855e+00
  7.14515880e+00  2.40542050e+01  2.40542050e+01  2.40542050e+01
  3.41909690e+01  1.18880654e+02  1.18880654e+02  1.18880654e+02
  1.38087981e+02  5.02202833e+02  1.86989969e+03  7.99960924e+03
  4.77673238e+04]
E1 = -182.59909927629238  E_coul = 54.06724234169542
cycle= 1 E= -128.531856934597  delta_E= -5.4e-13  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59909927629238  E_coul = 54.06724234169542
  HOMO = -0.845395332146365  LUMO = 1.0896400203499
  mo_energy =
[-3.27690620e+01 -1.92705933e+00 -8.45395332e-01 -8.45395332e-01
 -8.45395332e-01  1.08964002e+00  1.08964002e+00  1.08964002e+00
  1.16967135e+00  5.68982918e+00  5.68982918e+00  5.68982918e+00
  7.14515943e+00  2.40542061e+01  2.40542061e+01  2.40542061e+01
  3.41909702e+01  1.18880655e+02  1.18880655e+02  1.18880655e+02
  1.38087983e+02  5.02202834e+02  1.86989970e+03  7.99960924e+03
  4.77673238e+04]
E1 = -182.5990956414824  E_coul = 54.06723870688516
Extra cycle  E= -128.531856934597  delta_E= -2.56e-13  |g|= 4.94e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.30 sec
exp = [2.44137941e+04 3.66145440e+03 8.33272420e+02 2.35720764e+02
 7.65025597e+01 9.97449742e+00 2.69840583e+01 3.77994380e-01
 1.10055530e+00 2.82530975e+00 3.68456955e+00 1.24490347e+01
 5.47758902e+01 3.30184576e-01 1.14400213e+00]
grad_E = [ 4.80128960e-10 -2.49074866e-08  4.82457242e-07 -4.92526411e-06
  2.37244136e-05 -4.38742036e-05 -1.36511521e-05 -1.16531938e-04
  7.48946325e-05 -2.82254070e-05 -4.96918718e-06  1.75798256e-06
 -2.75915704e-07 -1.95533874e-04  5.11427808e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941312        1
[INPUT] 0    0    [1    /1   ]  3661.45440866        1
[INPUT] 0    0    [1    /1   ]  833.27224573         1
[INPUT] 0    0    [1    /1   ]  235.72256511         1
[INPUT] 0    0    [1    /1   ]  76.4932611745        1
[INPUT] 0    0    [1    /1   ]  9.97963550642        1
[INPUT] 0    0    [1    /1   ]  26.995985223         1
[INPUT] 0    0    [1    /1   ]  0.37798527243        1
[INPUT] 0    0    [1    /1   ]  1.10036291817        1
[INPUT] 0    0    [1    /1   ]  2.82145956763        1
[INPUT] 1    0    [1    /1   ]  3.68513593303        1
[INPUT] 1    0    [1    /1   ]  12.4516775097        1
[INPUT] 1    0    [1    /1   ]  54.7904569373        1
[INPUT] 1    0    [1    /1   ]  0.330182830388       1
[INPUT] 1    0    [1    /1   ]  1.14411191257        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131172708, 1.0]], [0, [3661.454408657989, 1.0]], [0, [833.2722457302497, 1.0]], [0, [235.72256511000694, 1.0]], [0, [76.493261174469, 1.0]], [0, [9.979635506422078, 1.0]], [0, [26.99598522299749, 1.0]], [0, [0.37798527242955077, 1.0]], [0, [1.1003629181735703, 1.0]], [0, [2.8214595676264054, 1.0]], [1, [3.685135933030424, 1.0]], [1, [12.451677509742225, 1.0]], [1, [54.790456937307965, 1.0]], [1, [0.33018283038786606, 1.0]], [1, [1.1441119125717392, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413117]
bas 1, expnt(s) = [3661.45440866]
bas 2, expnt(s) = [833.27224573]
bas 3, expnt(s) = [235.72256511]
bas 4, expnt(s) = [76.49326117]
bas 5, expnt(s) = [9.97963551]
bas 6, expnt(s) = [26.99598522]
bas 7, expnt(s) = [0.37798527]
bas 8, expnt(s) = [1.10036292]
bas 9, expnt(s) = [2.82145957]
bas 10, expnt(s) = [3.68513593]
bas 11, expnt(s) = [12.45167751]
bas 12, expnt(s) = [54.79045694]
bas 13, expnt(s) = [0.33018283]
bas 14, expnt(s) = [1.14411191]
CPU time:       300.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145441e+03 1.18920095e+03
 8.33272246e+02 3.91836792e+02 2.35722565e+02 1.51990307e+02
 7.64932612e+01 6.53480160e+01 9.97963551e+00 1.41857086e+01
 2.69959852e+01 2.99219168e+01 3.77985272e-01 1.21792679e+00
 1.10036292e+00 2.71435711e+00 2.82145957e+00 5.50009762e+00
 3.68513593e+00 1.48953696e+01 1.24516775e+01 6.82368897e+01
 5.47904569e+01 4.34876105e+02 3.30182830e-01 7.30175909e-01
 1.14411191e+00 3.45199396e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438300274266
cond(S) = 337.07148129322223
E1 = -183.5771712089814  E_coul = 55.07844580679006
init E= -128.498725402191
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948468546108  LUMO = 1.1153507491283
  mo_energy =
[-3.25552931e+01 -1.85277961e+00 -7.73948469e-01 -7.73948469e-01
 -7.73948469e-01  1.11535075e+00  1.11535075e+00  1.11535075e+00
  1.19806716e+00  5.77758465e+00  5.77758465e+00  5.77758465e+00
  7.22548856e+00  2.42164737e+01  2.42164737e+01  2.42164737e+01
  3.43511713e+01  1.19129343e+02  1.19129343e+02  1.19129343e+02
  1.38321008e+02  5.02471733e+02  1.87019457e+03  7.99992811e+03
  4.77676576e+04]
E1 = -182.1124905779926  E_coul = 53.58397687918739
cycle= 1 E= -128.528513698805  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450205
diis-c [-0.20268478  1.        ]
  HOMO = -0.879446148981733  LUMO = 1.07725361283141
  mo_energy =
[-3.28734913e+01 -1.96295378e+00 -8.79446149e-01 -8.79446149e-01
 -8.79446149e-01  1.07725361e+00  1.07725361e+00  1.07725361e+00
  1.15581883e+00  5.64882846e+00  5.64882846e+00  5.64882846e+00
  7.09902877e+00  2.39818118e+01  2.39818118e+01  2.39818118e+01
  3.41096182e+01  1.18808880e+02  1.18808880e+02  1.18808880e+02
  1.38007979e+02  5.02114822e+02  1.86980172e+03  7.99950627e+03
  4.77672169e+04]
E1 = -182.84334396753235  E_coul = 54.3123308717855
cycle= 2 E= -128.531013095747  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.22451
diis-c [-6.02449528e-04  3.31744084e-01  6.68255916e-01]
  HOMO = -0.845133922861824  LUMO = 1.08972825285249
  mo_energy =
[-3.27685866e+01 -1.92686893e+00 -8.45133923e-01 -8.45133923e-01
 -8.45133923e-01  1.08972825e+00  1.08972825e+00  1.08972825e+00
  1.16948289e+00  5.69070578e+00  5.69070578e+00  5.69070578e+00
  7.14020119e+00  2.40592870e+01  2.40592870e+01  2.40592870e+01
  3.41896164e+01  1.18913813e+02  1.18913813e+02  1.18913813e+02
  1.38110958e+02  5.02228370e+02  1.86992043e+03  7.99962739e+03
  4.77673390e+04]
E1 = -182.5983461963159  E_coul = 54.06648887121709
cycle= 3 E= -128.531857325099  delta_E= -0.000844  |g|= 0.000476  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000987027
diis-c [-9.66881871e-08 -2.15758457e-03 -1.46482142e-04  1.00230407e+00]
  HOMO = -0.845371654899976  LUMO = 1.08967900734215
  mo_energy =
[-3.27690181e+01 -1.92704746e+00 -8.45371655e-01 -8.45371655e-01
 -8.45371655e-01  1.08967901e+00  1.08967901e+00  1.08967901e+00
  1.16942518e+00  5.69049496e+00  5.69049496e+00  5.69049496e+00
  7.14000120e+00  2.40589493e+01  2.40589493e+01  2.40589493e+01
  3.41892796e+01  1.18913370e+02  1.18913370e+02  1.18913370e+02
  1.38110528e+02  5.02227836e+02  1.86991978e+03  7.99962666e+03
  4.77673382e+04]
E1 = -182.5989386969071  E_coul = 54.067081353091936
cycle= 4 E= -128.531857343815  delta_E= -1.87e-08  |g|= 6.23e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136229
diis-c [-7.88827511e-10  2.87987504e-04  4.30521300e-04 -1.93130519e-01
  1.19241201e+00]
  HOMO = -0.845402550189653  LUMO = 1.08966654922629
  mo_energy =
[-3.27690724e+01 -1.92706768e+00 -8.45402550e-01 -8.45402550e-01
 -8.45402550e-01  1.08966655e+00  1.08966655e+00  1.08966655e+00
  1.16941532e+00  5.69046007e+00  5.69046007e+00  5.69046007e+00
  7.13997066e+00  2.40589016e+01  2.40589016e+01  2.40589016e+01
  3.41892324e+01  1.18913315e+02  1.18913315e+02  1.18913315e+02
  1.38110473e+02  5.02227774e+02  1.86991971e+03  7.99962659e+03
  4.77673381e+04]
E1 = -182.59905608806073  E_coul = 54.06719874379271
cycle= 5 E= -128.531857344268  delta_E= -4.53e-10  |g|= 5.54e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59905608806073  E_coul = 54.06719874379271
  HOMO = -0.845399639321647  LUMO = 1.08966777957098
  mo_energy =
[-3.27690663e+01 -1.92706406e+00 -8.45399639e-01 -8.45399639e-01
 -8.45399639e-01  1.08966778e+00  1.08966778e+00  1.08966778e+00
  1.16941710e+00  5.69046363e+00  5.69046363e+00  5.69046363e+00
  7.13997453e+00  2.40589070e+01  2.40589070e+01  2.40589070e+01
  3.41892380e+01  1.18913321e+02  1.18913321e+02  1.18913321e+02
  1.38110479e+02  5.02227780e+02  1.86991972e+03  7.99962659e+03
  4.77673381e+04]
E1 = -182.5990425620714  E_coul = 54.06718521780142
Extra cycle  E= -128.53185734427  delta_E= -1.93e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44137941e+04 3.66145441e+03 8.33272246e+02 2.35722565e+02
 7.64932612e+01 9.97963551e+00 2.69959852e+01 3.77985272e-01
 1.10036292e+00 2.82145957e+00 3.68513593e+00 1.24516775e+01
 5.47904569e+01 3.30182830e-01 1.14411191e+00]
E = -128.53185734426995
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941312        1
[INPUT] 0    0    [1    /1   ]  3661.45440866        1
[INPUT] 0    0    [1    /1   ]  833.27224573         1
[INPUT] 0    0    [1    /1   ]  235.72256511         1
[INPUT] 0    0    [1    /1   ]  76.4932611745        1
[INPUT] 0    0    [1    /1   ]  9.97963550642        1
[INPUT] 0    0    [1    /1   ]  26.995985223         1
[INPUT] 0    0    [1    /1   ]  0.37798527243        1
[INPUT] 0    0    [1    /1   ]  1.10036291817        1
[INPUT] 0    0    [1    /1   ]  2.82145956763        1
[INPUT] 1    0    [1    /1   ]  3.68513593303        1
[INPUT] 1    0    [1    /1   ]  12.4516775097        1
[INPUT] 1    0    [1    /1   ]  54.7904569373        1
[INPUT] 1    0    [1    /1   ]  0.330182830388       1
[INPUT] 1    0    [1    /1   ]  1.14411191257        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794131172708, 1.0]], [0, [3661.454408657989, 1.0]], [0, [833.2722457302497, 1.0]], [0, [235.72256511000694, 1.0]], [0, [76.493261174469, 1.0]], [0, [9.979635506422078, 1.0]], [0, [26.99598522299749, 1.0]], [0, [0.37798527242955077, 1.0]], [0, [1.1003629181735703, 1.0]], [0, [2.8214595676264054, 1.0]], [1, [3.685135933030424, 1.0]], [1, [12.451677509742225, 1.0]], [1, [54.790456937307965, 1.0]], [1, [0.33018283038786606, 1.0]], [1, [1.1441119125717392, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413117]
bas 1, expnt(s) = [3661.45440866]
bas 2, expnt(s) = [833.27224573]
bas 3, expnt(s) = [235.72256511]
bas 4, expnt(s) = [76.49326117]
bas 5, expnt(s) = [9.97963551]
bas 6, expnt(s) = [26.99598522]
bas 7, expnt(s) = [0.37798527]
bas 8, expnt(s) = [1.10036292]
bas 9, expnt(s) = [2.82145957]
bas 10, expnt(s) = [3.68513593]
bas 11, expnt(s) = [12.45167751]
bas 12, expnt(s) = [54.79045694]
bas 13, expnt(s) = [0.33018283]
bas 14, expnt(s) = [1.14411191]
CPU time:       301.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145441e+03 1.18920095e+03
 8.33272246e+02 3.91836792e+02 2.35722565e+02 1.51990307e+02
 7.64932612e+01 6.53480160e+01 9.97963551e+00 1.41857086e+01
 2.69959852e+01 2.99219168e+01 3.77985272e-01 1.21792679e+00
 1.10036292e+00 2.71435711e+00 2.82145957e+00 5.50009762e+00
 3.68513593e+00 1.48953696e+01 1.24516775e+01 6.82368897e+01
 5.47904569e+01 4.34876105e+02 3.30182830e-01 7.30175909e-01
 1.14411191e+00 3.45199396e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998438300274266
cond(S) = 337.07148129322223
E1 = -183.5771712089814  E_coul = 55.07844580679006
init E= -128.498725402191
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948468546108  LUMO = 1.1153507491283
  mo_energy =
[-3.25552931e+01 -1.85277961e+00 -7.73948469e-01 -7.73948469e-01
 -7.73948469e-01  1.11535075e+00  1.11535075e+00  1.11535075e+00
  1.19806716e+00  5.77758465e+00  5.77758465e+00  5.77758465e+00
  7.22548856e+00  2.42164737e+01  2.42164737e+01  2.42164737e+01
  3.43511713e+01  1.19129343e+02  1.19129343e+02  1.19129343e+02
  1.38321008e+02  5.02471733e+02  1.87019457e+03  7.99992811e+03
  4.77676576e+04]
E1 = -182.1124905779926  E_coul = 53.58397687918739
cycle= 1 E= -128.528513698805  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450205
diis-c [-0.20268478  1.        ]
  HOMO = -0.879446148981733  LUMO = 1.07725361283141
  mo_energy =
[-3.28734913e+01 -1.96295378e+00 -8.79446149e-01 -8.79446149e-01
 -8.79446149e-01  1.07725361e+00  1.07725361e+00  1.07725361e+00
  1.15581883e+00  5.64882846e+00  5.64882846e+00  5.64882846e+00
  7.09902877e+00  2.39818118e+01  2.39818118e+01  2.39818118e+01
  3.41096182e+01  1.18808880e+02  1.18808880e+02  1.18808880e+02
  1.38007979e+02  5.02114822e+02  1.86980172e+03  7.99950627e+03
  4.77672169e+04]
E1 = -182.84334396753235  E_coul = 54.3123308717855
cycle= 2 E= -128.531013095747  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.22451
diis-c [-6.02449528e-04  3.31744084e-01  6.68255916e-01]
  HOMO = -0.845133922861824  LUMO = 1.08972825285249
  mo_energy =
[-3.27685866e+01 -1.92686893e+00 -8.45133923e-01 -8.45133923e-01
 -8.45133923e-01  1.08972825e+00  1.08972825e+00  1.08972825e+00
  1.16948289e+00  5.69070578e+00  5.69070578e+00  5.69070578e+00
  7.14020119e+00  2.40592870e+01  2.40592870e+01  2.40592870e+01
  3.41896164e+01  1.18913813e+02  1.18913813e+02  1.18913813e+02
  1.38110958e+02  5.02228370e+02  1.86992043e+03  7.99962739e+03
  4.77673390e+04]
E1 = -182.5983461963159  E_coul = 54.06648887121709
cycle= 3 E= -128.531857325099  delta_E= -0.000844  |g|= 0.000476  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000987027
diis-c [-9.66881871e-08 -2.15758457e-03 -1.46482142e-04  1.00230407e+00]
  HOMO = -0.845371654899976  LUMO = 1.08967900734215
  mo_energy =
[-3.27690181e+01 -1.92704746e+00 -8.45371655e-01 -8.45371655e-01
 -8.45371655e-01  1.08967901e+00  1.08967901e+00  1.08967901e+00
  1.16942518e+00  5.69049496e+00  5.69049496e+00  5.69049496e+00
  7.14000120e+00  2.40589493e+01  2.40589493e+01  2.40589493e+01
  3.41892796e+01  1.18913370e+02  1.18913370e+02  1.18913370e+02
  1.38110528e+02  5.02227836e+02  1.86991978e+03  7.99962666e+03
  4.77673382e+04]
E1 = -182.5989386969071  E_coul = 54.067081353091936
cycle= 4 E= -128.531857343815  delta_E= -1.87e-08  |g|= 6.23e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136229
diis-c [-7.88827511e-10  2.87987504e-04  4.30521300e-04 -1.93130519e-01
  1.19241201e+00]
  HOMO = -0.845402550189653  LUMO = 1.08966654922629
  mo_energy =
[-3.27690724e+01 -1.92706768e+00 -8.45402550e-01 -8.45402550e-01
 -8.45402550e-01  1.08966655e+00  1.08966655e+00  1.08966655e+00
  1.16941532e+00  5.69046007e+00  5.69046007e+00  5.69046007e+00
  7.13997066e+00  2.40589016e+01  2.40589016e+01  2.40589016e+01
  3.41892324e+01  1.18913315e+02  1.18913315e+02  1.18913315e+02
  1.38110473e+02  5.02227774e+02  1.86991971e+03  7.99962659e+03
  4.77673381e+04]
E1 = -182.59905608806073  E_coul = 54.06719874379271
cycle= 5 E= -128.531857344268  delta_E= -4.53e-10  |g|= 5.54e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59905608806073  E_coul = 54.06719874379271
  HOMO = -0.845399639321647  LUMO = 1.08966777957098
  mo_energy =
[-3.27690663e+01 -1.92706406e+00 -8.45399639e-01 -8.45399639e-01
 -8.45399639e-01  1.08966778e+00  1.08966778e+00  1.08966778e+00
  1.16941710e+00  5.69046363e+00  5.69046363e+00  5.69046363e+00
  7.13997453e+00  2.40589070e+01  2.40589070e+01  2.40589070e+01
  3.41892380e+01  1.18913321e+02  1.18913321e+02  1.18913321e+02
  1.38110479e+02  5.02227780e+02  1.86991972e+03  7.99962659e+03
  4.77673381e+04]
E1 = -182.5990425620714  E_coul = 54.06718521780142
Extra cycle  E= -128.53185734427  delta_E= -1.93e-12  |g|= 1.91e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.07148129322223
E1 = -182.5990425620714  E_coul = 54.06718521780142
init E= -128.53185734427
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845400590054199  LUMO = 1.08966744857325
  mo_energy =
[-3.27690694e+01 -1.92706493e+00 -8.45400590e-01 -8.45400590e-01
 -8.45400590e-01  1.08966745e+00  1.08966745e+00  1.08966745e+00
  1.16941681e+00  5.69046247e+00  5.69046247e+00  5.69046247e+00
  7.13997346e+00  2.40589048e+01  2.40589048e+01  2.40589048e+01
  3.41892357e+01  1.18913318e+02  1.18913318e+02  1.18913318e+02
  1.38110476e+02  5.02227777e+02  1.86991972e+03  7.99962659e+03
  4.77673381e+04]
E1 = -182.59904988641688  E_coul = 54.06719254214688
cycle= 1 E= -128.53185734427  delta_E= -5.68e-14  |g|= 1.01e-06  |ddm|= 7.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59904988641688  E_coul = 54.06719254214688
  HOMO = -0.845400076693139  LUMO = 1.08966763748026
  mo_energy =
[-3.27690678e+01 -1.92706437e+00 -8.45400077e-01 -8.45400077e-01
 -8.45400077e-01  1.08966764e+00  1.08966764e+00  1.08966764e+00
  1.16941703e+00  5.69046310e+00  5.69046310e+00  5.69046310e+00
  7.13997409e+00  2.40589059e+01  2.40589059e+01  2.40589059e+01
  3.41892369e+01  1.18913320e+02  1.18913320e+02  1.18913320e+02
  1.38110478e+02  5.02227778e+02  1.86991972e+03  7.99962659e+03
  4.77673381e+04]
E1 = -182.59904625462525  E_coul = 54.06718891035498
Extra cycle  E= -128.53185734427  delta_E= -2.56e-13  |g|= 4.94e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145441e+03 8.33272246e+02 2.35722565e+02
 7.64932612e+01 9.97963551e+00 2.69959852e+01 3.77985272e-01
 1.10036292e+00 2.82145957e+00 3.68513593e+00 1.24516775e+01
 5.47904569e+01 3.30182830e-01 1.14411191e+00]
grad_E = [ 3.86988161e-10 -2.00657494e-08  3.88697624e-07 -3.95091809e-06
  1.82255893e-05 -5.23726250e-05 -1.77049046e-07 -1.80121748e-04
  1.17951904e-04 -4.11675208e-05 -8.19296279e-06  2.85989644e-06
 -1.97047280e-07 -3.16347112e-04  8.29677698e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941308        1
[INPUT] 0    0    [1    /1   ]  3661.45442723        1
[INPUT] 0    0    [1    /1   ]  833.271885319        1
[INPUT] 0    0    [1    /1   ]  235.726281729        1
[INPUT] 0    0    [1    /1   ]  76.4744104845        1
[INPUT] 0    0    [1    /1   ]  9.99306803781        1
[INPUT] 0    0    [1    /1   ]  27.0172938785        1
[INPUT] 0    0    [1    /1   ]  0.378429671748       1
[INPUT] 0    0    [1    /1   ]  1.10231200504        1
[INPUT] 0    0    [1    /1   ]  2.82464005133        1
[INPUT] 1    0    [1    /1   ]  3.68577749188        1
[INPUT] 1    0    [1    /1   ]  12.4546151588        1
[INPUT] 1    0    [1    /1   ]  54.8071161325        1
[INPUT] 1    0    [1    /1   ]  0.330189985572       1
[INPUT] 1    0    [1    /1   ]  1.1442473907         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794130815026, 1.0]], [0, [3661.4544272264106, 1.0]], [0, [833.2718853186917, 1.0]], [0, [235.72628172858805, 1.0]], [0, [76.4744104845351, 1.0]], [0, [9.993068037814904, 1.0]], [0, [27.01729387846023, 1.0]], [0, [0.3784296717477293, 1.0]], [0, [1.1023120050434092, 1.0]], [0, [2.8246400513296246, 1.0]], [1, [3.685777491876575, 1.0]], [1, [12.454615158819665, 1.0]], [1, [54.80711613245771, 1.0]], [1, [0.3301899855719279, 1.0]], [1, [1.1442473907005197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413082]
bas 1, expnt(s) = [3661.45442723]
bas 2, expnt(s) = [833.27188532]
bas 3, expnt(s) = [235.72628173]
bas 4, expnt(s) = [76.47441048]
bas 5, expnt(s) = [9.99306804]
bas 6, expnt(s) = [27.01729388]
bas 7, expnt(s) = [0.37842967]
bas 8, expnt(s) = [1.10231201]
bas 9, expnt(s) = [2.82464005]
bas 10, expnt(s) = [3.68577749]
bas 11, expnt(s) = [12.45461516]
bas 12, expnt(s) = [54.80711613]
bas 13, expnt(s) = [0.33018999]
bas 14, expnt(s) = [1.14424739]
CPU time:       305.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145443e+03 1.18920095e+03
 8.33271885e+02 3.91836665e+02 2.35726282e+02 1.51992105e+02
 7.64744105e+01 6.53359376e+01 9.99306804e+00 1.42000266e+01
 2.70172939e+01 2.99396286e+01 3.78429672e-01 1.21900057e+00
 1.10231201e+00 2.71796229e+00 2.82464005e+00 5.50474694e+00
 3.68577749e+00 1.48986111e+01 1.24546152e+01 6.82570136e+01
 5.48071161e+01 4.35041393e+02 3.30189986e-01 7.30195688e-01
 1.14424739e+00 3.45250492e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998437145604038
cond(S) = 337.86940807635966
E1 = -183.57718452420215  E_coul = 55.07844190660825
init E= -128.498742617594
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948748241854  LUMO = 1.11541773807777
  mo_energy =
[-3.25552954e+01 -1.85277866e+00 -7.73948748e-01 -7.73948748e-01
 -7.73948748e-01  1.11541774e+00  1.11541774e+00  1.11541774e+00
  1.20047526e+00  5.77838394e+00  5.77838394e+00  5.77838394e+00
  7.23904690e+00  2.42218235e+01  2.42218235e+01  2.42218235e+01
  3.44047091e+01  1.19166475e+02  1.19166475e+02  1.19166475e+02
  1.38425942e+02  5.02573945e+02  1.87028069e+03  8.00000320e+03
  4.77677196e+04]
E1 = -182.11248387435035  E_coul = 53.583969326392534
cycle= 1 E= -128.528514547958  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450172
diis-c [-0.20265504  1.        ]
  HOMO = -0.879447317667805  LUMO = 1.07731625519377
  mo_energy =
[-3.28734909e+01 -1.96295485e+00 -8.79447318e-01 -8.79447318e-01
 -8.79447318e-01  1.07731626e+00  1.07731626e+00  1.07731626e+00
  1.15814406e+00  5.64961123e+00  5.64961123e+00  5.64961123e+00
  7.11245296e+00  2.39871431e+01  2.39871431e+01  2.39871431e+01
  3.41630687e+01  1.18846002e+02  1.18846002e+02  1.18846002e+02
  1.38112907e+02  5.02217043e+02  1.86988785e+03  7.99958137e+03
  4.77672790e+04]
E1 = -182.84332628480004  E_coul = 54.31231238628395
cycle= 2 E= -128.531013898516  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224493
diis-c [-6.02725484e-04  3.31743000e-01  6.68257000e-01]
  HOMO = -0.845135679950891  LUMO = 1.08979199413265
  mo_energy =
[-3.27685872e+01 -1.92687047e+00 -8.45135680e-01 -8.45135680e-01
 -8.45135680e-01  1.08979199e+00  1.08979199e+00  1.08979199e+00
  1.17183410e+00  5.69149302e+00  5.69149302e+00  5.69149302e+00
  7.15366872e+00  2.40646238e+01  2.40646238e+01  2.40646238e+01
  3.42430954e+01  1.18950938e+02  1.18950938e+02  1.18950938e+02
  1.38215888e+02  5.02330589e+02  1.87000655e+03  7.99970249e+03
  4.77674010e+04]
E1 = -182.59833052810015  E_coul = 54.066472413807716
cycle= 3 E= -128.531858114292  delta_E= -0.000844  |g|= 0.000476  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000987353
diis-c [-9.64601727e-08 -2.15824857e-03 -1.45418614e-04  1.00230367e+00]
  HOMO = -0.8453735674266  LUMO = 1.08974267725914
  mo_energy =
[-3.27690189e+01 -1.92704922e+00 -8.45373567e-01 -8.45373567e-01
 -8.45373567e-01  1.08974268e+00  1.08974268e+00  1.08974268e+00
  1.17177615e+00  5.69128197e+00  5.69128197e+00  5.69128197e+00
  7.15346831e+00  2.40642858e+01  2.40642858e+01  2.40642858e+01
  3.42427582e+01  1.18950495e+02  1.18950495e+02  1.18950495e+02
  1.38215457e+02  5.02330055e+02  1.87000591e+03  7.99970176e+03
  4.77674002e+04]
E1 = -182.59892364127248  E_coul = 54.06706550826436
cycle= 4 E= -128.531858133008  delta_E= -1.87e-08  |g|= 6.22e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136158
diis-c [-7.87966767e-10  2.87790163e-04  4.30282448e-04 -1.92925199e-01
  1.19220713e+00]
  HOMO = -0.845404452299907  LUMO = 1.08973022229867
  mo_energy =
[-3.27690733e+01 -1.92706945e+00 -8.45404452e-01 -8.45404452e-01
 -8.45404452e-01  1.08973022e+00  1.08973022e+00  1.08973022e+00
  1.17176626e+00  5.69124709e+00  5.69124709e+00  5.69124709e+00
  7.15343774e+00  2.40642381e+01  2.40642381e+01  2.40642381e+01
  3.42427111e+01  1.18950440e+02  1.18950440e+02  1.18950440e+02
  1.38215402e+02  5.02329993e+02  1.87000584e+03  7.99970168e+03
  4.77674002e+04]
E1 = -182.59904101108154  E_coul = 54.0671828776217
cycle= 5 E= -128.53185813346  delta_E= -4.52e-10  |g|= 5.53e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.59904101108154  E_coul = 54.0671828776217
  HOMO = -0.845401545788425  LUMO = 1.08973145103693
  mo_energy =
[-3.27690672e+01 -1.92706583e+00 -8.45401546e-01 -8.45401546e-01
 -8.45401546e-01  1.08973145e+00  1.08973145e+00  1.08973145e+00
  1.17176805e+00  5.69125064e+00  5.69125064e+00  5.69125064e+00
  7.15344161e+00  2.40642435e+01  2.40642435e+01  2.40642435e+01
  3.42427166e+01  1.18950446e+02  1.18950446e+02  1.18950446e+02
  1.38215408e+02  5.02329999e+02  1.87000584e+03  7.99970169e+03
  4.77674002e+04]
E1 = -182.5990275092403  E_coul = 54.06716937577849
Extra cycle  E= -128.531858133462  delta_E= -1.96e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145443e+03 8.33271885e+02 2.35726282e+02
 7.64744105e+01 9.99306804e+00 2.70172939e+01 3.78429672e-01
 1.10231201e+00 2.82464005e+00 3.68577749e+00 1.24546152e+01
 5.48071161e+01 3.30189986e-01 1.14424739e+00]
E = -128.5318581334618
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941308        1
[INPUT] 0    0    [1    /1   ]  3661.45442723        1
[INPUT] 0    0    [1    /1   ]  833.271885319        1
[INPUT] 0    0    [1    /1   ]  235.726281729        1
[INPUT] 0    0    [1    /1   ]  76.4744104845        1
[INPUT] 0    0    [1    /1   ]  9.99306803781        1
[INPUT] 0    0    [1    /1   ]  27.0172938785        1
[INPUT] 0    0    [1    /1   ]  0.378429671748       1
[INPUT] 0    0    [1    /1   ]  1.10231200504        1
[INPUT] 0    0    [1    /1   ]  2.82464005133        1
[INPUT] 1    0    [1    /1   ]  3.68577749188        1
[INPUT] 1    0    [1    /1   ]  12.4546151588        1
[INPUT] 1    0    [1    /1   ]  54.8071161325        1
[INPUT] 1    0    [1    /1   ]  0.330189985572       1
[INPUT] 1    0    [1    /1   ]  1.1442473907         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794130815026, 1.0]], [0, [3661.4544272264106, 1.0]], [0, [833.2718853186917, 1.0]], [0, [235.72628172858805, 1.0]], [0, [76.4744104845351, 1.0]], [0, [9.993068037814904, 1.0]], [0, [27.01729387846023, 1.0]], [0, [0.3784296717477293, 1.0]], [0, [1.1023120050434092, 1.0]], [0, [2.8246400513296246, 1.0]], [1, [3.685777491876575, 1.0]], [1, [12.454615158819665, 1.0]], [1, [54.80711613245771, 1.0]], [1, [0.3301899855719279, 1.0]], [1, [1.1442473907005197, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413082]
bas 1, expnt(s) = [3661.45442723]
bas 2, expnt(s) = [833.27188532]
bas 3, expnt(s) = [235.72628173]
bas 4, expnt(s) = [76.47441048]
bas 5, expnt(s) = [9.99306804]
bas 6, expnt(s) = [27.01729388]
bas 7, expnt(s) = [0.37842967]
bas 8, expnt(s) = [1.10231201]
bas 9, expnt(s) = [2.82464005]
bas 10, expnt(s) = [3.68577749]
bas 11, expnt(s) = [12.45461516]
bas 12, expnt(s) = [54.80711613]
bas 13, expnt(s) = [0.33018999]
bas 14, expnt(s) = [1.14424739]
CPU time:       306.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145443e+03 1.18920095e+03
 8.33271885e+02 3.91836665e+02 2.35726282e+02 1.51992105e+02
 7.64744105e+01 6.53359376e+01 9.99306804e+00 1.42000266e+01
 2.70172939e+01 2.99396286e+01 3.78429672e-01 1.21900057e+00
 1.10231201e+00 2.71796229e+00 2.82464005e+00 5.50474694e+00
 3.68577749e+00 1.48986111e+01 1.24546152e+01 6.82570136e+01
 5.48071161e+01 4.35041393e+02 3.30189986e-01 7.30195688e-01
 1.14424739e+00 3.45250492e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998437145604038
cond(S) = 337.86940807635966
E1 = -183.57718452420215  E_coul = 55.07844190660825
init E= -128.498742617594
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773948748241854  LUMO = 1.11541773807777
  mo_energy =
[-3.25552954e+01 -1.85277866e+00 -7.73948748e-01 -7.73948748e-01
 -7.73948748e-01  1.11541774e+00  1.11541774e+00  1.11541774e+00
  1.20047526e+00  5.77838394e+00  5.77838394e+00  5.77838394e+00
  7.23904690e+00  2.42218235e+01  2.42218235e+01  2.42218235e+01
  3.44047091e+01  1.19166475e+02  1.19166475e+02  1.19166475e+02
  1.38425942e+02  5.02573945e+02  1.87028069e+03  8.00000320e+03
  4.77677196e+04]
E1 = -182.11248387435035  E_coul = 53.583969326392534
cycle= 1 E= -128.528514547958  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450172
diis-c [-0.20265504  1.        ]
  HOMO = -0.879447317667805  LUMO = 1.07731625519377
  mo_energy =
[-3.28734909e+01 -1.96295485e+00 -8.79447318e-01 -8.79447318e-01
 -8.79447318e-01  1.07731626e+00  1.07731626e+00  1.07731626e+00
  1.15814406e+00  5.64961123e+00  5.64961123e+00  5.64961123e+00
  7.11245296e+00  2.39871431e+01  2.39871431e+01  2.39871431e+01
  3.41630687e+01  1.18846002e+02  1.18846002e+02  1.18846002e+02
  1.38112907e+02  5.02217043e+02  1.86988785e+03  7.99958137e+03
  4.77672790e+04]
E1 = -182.84332628480004  E_coul = 54.31231238628395
cycle= 2 E= -128.531013898516  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224493
diis-c [-6.02725484e-04  3.31743000e-01  6.68257000e-01]
  HOMO = -0.845135679950891  LUMO = 1.08979199413265
  mo_energy =
[-3.27685872e+01 -1.92687047e+00 -8.45135680e-01 -8.45135680e-01
 -8.45135680e-01  1.08979199e+00  1.08979199e+00  1.08979199e+00
  1.17183410e+00  5.69149302e+00  5.69149302e+00  5.69149302e+00
  7.15366872e+00  2.40646238e+01  2.40646238e+01  2.40646238e+01
  3.42430954e+01  1.18950938e+02  1.18950938e+02  1.18950938e+02
  1.38215888e+02  5.02330589e+02  1.87000655e+03  7.99970249e+03
  4.77674010e+04]
E1 = -182.59833052810015  E_coul = 54.066472413807716
cycle= 3 E= -128.531858114292  delta_E= -0.000844  |g|= 0.000476  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000987353
diis-c [-9.64601727e-08 -2.15824857e-03 -1.45418614e-04  1.00230367e+00]
  HOMO = -0.8453735674266  LUMO = 1.08974267725914
  mo_energy =
[-3.27690189e+01 -1.92704922e+00 -8.45373567e-01 -8.45373567e-01
 -8.45373567e-01  1.08974268e+00  1.08974268e+00  1.08974268e+00
  1.17177615e+00  5.69128197e+00  5.69128197e+00  5.69128197e+00
  7.15346831e+00  2.40642858e+01  2.40642858e+01  2.40642858e+01
  3.42427582e+01  1.18950495e+02  1.18950495e+02  1.18950495e+02
  1.38215457e+02  5.02330055e+02  1.87000591e+03  7.99970176e+03
  4.77674002e+04]
E1 = -182.59892364127248  E_coul = 54.06706550826436
cycle= 4 E= -128.531858133008  delta_E= -1.87e-08  |g|= 6.22e-05  |ddm|= 0.000216
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000136158
diis-c [-7.87966767e-10  2.87790163e-04  4.30282448e-04 -1.92925199e-01
  1.19220713e+00]
  HOMO = -0.845404452299907  LUMO = 1.08973022229867
  mo_energy =
[-3.27690733e+01 -1.92706945e+00 -8.45404452e-01 -8.45404452e-01
 -8.45404452e-01  1.08973022e+00  1.08973022e+00  1.08973022e+00
  1.17176626e+00  5.69124709e+00  5.69124709e+00  5.69124709e+00
  7.15343774e+00  2.40642381e+01  2.40642381e+01  2.40642381e+01
  3.42427111e+01  1.18950440e+02  1.18950440e+02  1.18950440e+02
  1.38215402e+02  5.02329993e+02  1.87000584e+03  7.99970168e+03
  4.77674002e+04]
E1 = -182.59904101108154  E_coul = 54.0671828776217
cycle= 5 E= -128.53185813346  delta_E= -4.52e-10  |g|= 5.53e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59904101108154  E_coul = 54.0671828776217
  HOMO = -0.845401545788425  LUMO = 1.08973145103693
  mo_energy =
[-3.27690672e+01 -1.92706583e+00 -8.45401546e-01 -8.45401546e-01
 -8.45401546e-01  1.08973145e+00  1.08973145e+00  1.08973145e+00
  1.17176805e+00  5.69125064e+00  5.69125064e+00  5.69125064e+00
  7.15344161e+00  2.40642435e+01  2.40642435e+01  2.40642435e+01
  3.42427166e+01  1.18950446e+02  1.18950446e+02  1.18950446e+02
  1.38215408e+02  5.02329999e+02  1.87000584e+03  7.99970169e+03
  4.77674002e+04]
E1 = -182.5990275092403  E_coul = 54.06716937577849
Extra cycle  E= -128.531858133462  delta_E= -1.96e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 337.86940807635966
E1 = -182.5990275092403  E_coul = 54.06716937577849
init E= -128.531858133462
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.845402494851712  LUMO = 1.08973112060099
  mo_energy =
[-3.27690702e+01 -1.92706670e+00 -8.45402495e-01 -8.45402495e-01
 -8.45402495e-01  1.08973112e+00  1.08973112e+00  1.08973112e+00
  1.17176775e+00  5.69124949e+00  5.69124949e+00  5.69124949e+00
  7.15344054e+00  2.40642413e+01  2.40642413e+01  2.40642413e+01
  3.42427144e+01  1.18950443e+02  1.18950443e+02  1.18950443e+02
  1.38215405e+02  5.02329995e+02  1.87000584e+03  7.99970168e+03
  4.77674002e+04]
E1 = -182.59903482103556  E_coul = 54.067176687573266
cycle= 1 E= -128.531858133462  delta_E= -4.83e-13  |g|= 1.01e-06  |ddm|= 7.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59903482103556  E_coul = 54.067176687573266
  HOMO = -0.845401982379968  LUMO = 1.0897313092041
  mo_energy =
[-3.27690686e+01 -1.92706614e+00 -8.45401982e-01 -8.45401982e-01
 -8.45401982e-01  1.08973131e+00  1.08973131e+00  1.08973131e+00
  1.17176798e+00  5.69125012e+00  5.69125012e+00  5.69125012e+00
  7.15344117e+00  2.40642425e+01  2.40642425e+01  2.40642425e+01
  3.42427156e+01  1.18950444e+02  1.18950444e+02  1.18950444e+02
  1.38215407e+02  5.02329997e+02  1.87000584e+03  7.99970169e+03
  4.77674002e+04]
E1 = -182.59903119553925  E_coul = 54.067173062076876
Extra cycle  E= -128.531858133462  delta_E= -8.53e-14  |g|= 4.93e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145443e+03 8.33271885e+02 2.35726282e+02
 7.64744105e+01 9.99306804e+00 2.70172939e+01 3.78429672e-01
 1.10231201e+00 2.82464005e+00 3.68577749e+00 1.24546152e+01
 5.48071161e+01 3.30189986e-01 1.14424739e+00]
grad_E = [ 2.30495194e-10 -1.19393421e-08  2.32524696e-07 -2.36524905e-06
  9.87360813e-06 -5.54683480e-05  1.63976791e-05 -2.29497051e-04
  1.52620651e-04 -5.06266875e-05 -1.11183231e-05  3.83279053e-06
 -7.78670630e-08 -4.24071143e-04  1.11395579e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941303        1
[INPUT] 0    0    [1    /1   ]  3661.45445294        1
[INPUT] 0    0    [1    /1   ]  833.271386745        1
[INPUT] 0    0    [1    /1   ]  235.731400603        1
[INPUT] 0    0    [1    /1   ]  76.4488467177        1
[INPUT] 0    0    [1    /1   ]  10.0150172593        1
[INPUT] 0    0    [1    /1   ]  27.0426906996        1
[INPUT] 0    0    [1    /1   ]  0.379583115768       1
[INPUT] 0    0    [1    /1   ]  1.10776187794        1
[INPUT] 0    0    [1    /1   ]  2.8421825196         1
[INPUT] 1    0    [1    /1   ]  3.68600972481        1
[INPUT] 1    0    [1    /1   ]  12.4555616039        1
[INPUT] 1    0    [1    /1   ]  54.8137104465        1
[INPUT] 1    0    [1    /1   ]  0.330213833724       1
[INPUT] 1    0    [1    /1   ]  1.14432146217        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794130319566, 1.0]], [0, [3661.4544529385744, 1.0]], [0, [833.271386744575, 1.0]], [0, [235.7314006034564, 1.0]], [0, [76.4488467177375, 1.0]], [0, [10.015017259259857, 1.0]], [0, [27.042690699604375, 1.0]], [0, [0.3795831157682536, 1.0]], [0, [1.1077618779363707, 1.0]], [0, [2.842182519597786, 1.0]], [1, [3.6860097248072083, 1.0]], [1, [12.455561603937369, 1.0]], [1, [54.813710446454486, 1.0]], [1, [0.3302138337243952, 1.0]], [1, [1.1443214621703512, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413032]
bas 1, expnt(s) = [3661.45445294]
bas 2, expnt(s) = [833.27138674]
bas 3, expnt(s) = [235.7314006]
bas 4, expnt(s) = [76.44884672]
bas 5, expnt(s) = [10.01501726]
bas 6, expnt(s) = [27.0426907]
bas 7, expnt(s) = [0.37958312]
bas 8, expnt(s) = [1.10776188]
bas 9, expnt(s) = [2.84218252]
bas 10, expnt(s) = [3.68600972]
bas 11, expnt(s) = [12.4555616]
bas 12, expnt(s) = [54.81371045]
bas 13, expnt(s) = [0.33021383]
bas 14, expnt(s) = [1.14432146]
CPU time:       309.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145445e+03 1.18920096e+03
 8.33271387e+02 3.91836489e+02 2.35731401e+02 1.51994580e+02
 7.64488467e+01 6.53195566e+01 1.00150173e+01 1.42234123e+01
 2.70426907e+01 2.99607341e+01 3.79583116e-01 1.22178613e+00
 1.10776188e+00 2.72803436e+00 2.84218252e+00 5.53036757e+00
 3.68600972e+00 1.48997845e+01 1.24555616e+01 6.82634974e+01
 5.48137104e+01 4.35106824e+02 3.30213834e-01 7.30261612e-01
 1.14432146e+00 3.45278429e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998435031161794
cond(S) = 340.07756538533357
E1 = -183.57720687287468  E_coul = 55.078444219076374
init E= -128.498762653798
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948511002549  LUMO = 1.11551340161296
  mo_energy =
[-3.25552992e+01 -1.85277478e+00 -7.73948511e-01 -7.73948511e-01
 -7.73948511e-01  1.11551340e+00  1.11551340e+00  1.11551340e+00
  1.20726888e+00  5.77882356e+00  5.77882356e+00  5.77882356e+00
  7.28649646e+00  2.42237848e+01  2.42237848e+01  2.42237848e+01
  3.45460177e+01  1.19180525e+02  1.19180525e+02  1.19180525e+02
  1.38639826e+02  5.02774930e+02  1.87045249e+03  8.00015326e+03
  4.77678437e+04]
E1 = -182.11259481239318  E_coul = 53.58407891837912
cycle= 1 E= -128.528515894014  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.450142
diis-c [-0.2026276  1.       ]
  HOMO = -0.879438474308757  LUMO = 1.07741370981182
  mo_energy =
[-3.28734731e+01 -1.96294477e+00 -8.79438474e-01 -8.79438474e-01
 -8.79438474e-01  1.07741371e+00  1.07741371e+00  1.07741371e+00
  1.16469521e+00  5.65005429e+00  5.65005429e+00  5.65005429e+00
  7.15942477e+00  2.39891156e+01  2.39891156e+01  2.39891156e+01
  3.43042295e+01  1.18860069e+02  1.18860069e+02  1.18860069e+02
  1.38326810e+02  5.02418062e+02  1.87005967e+03  7.99973146e+03
  4.77674030e+04]
E1 = -182.8433875869765  E_coul = 54.31237257392073
cycle= 2 E= -128.531015013056  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224477
diis-c [-6.03431942e-04  3.31740498e-01  6.68259502e-01]
  HOMO = -0.84512922789444  LUMO = 1.08988965277589
  mo_energy =
[-3.27685757e+01 -1.92686262e+00 -8.45129228e-01 -8.45129228e-01
 -8.45129228e-01  1.08988965e+00  1.08988965e+00  1.08988965e+00
  1.17846399e+00  5.69193519e+00  5.69193519e+00  5.69193519e+00
  7.20079920e+00  2.40665936e+01  2.40665936e+01  2.40665936e+01
  3.43843054e+01  1.18965000e+02  1.18965000e+02  1.18965000e+02
  1.38429785e+02  5.02531599e+02  1.87017837e+03  7.99985257e+03
  4.77675251e+04]
E1 = -182.5984169911899  E_coul = 54.06655789207745
cycle= 3 E= -128.531859099112  delta_E= -0.000844  |g|= 0.000475  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000985724
diis-c [-9.58505939e-08 -2.15684185e-03 -1.48564377e-04  1.00230541e+00]
  HOMO = -0.845366603759447  LUMO = 1.08984057272629
  mo_energy =
[-3.27690065e+01 -1.92704098e+00 -8.45366604e-01 -8.45366604e-01
 -8.45366604e-01  1.08984057e+00  1.08984057e+00  1.08984057e+00
  1.17840594e+00  5.69172466e+00  5.69172466e+00  5.69172466e+00
  7.20059863e+00  2.40662564e+01  2.40662564e+01  2.40662564e+01
  3.43839687e+01  1.18964557e+02  1.18964557e+02  1.18964557e+02
  1.38429355e+02  5.02531066e+02  1.87017772e+03  7.99985184e+03
  4.77675243e+04]
E1 = -182.5990094604923  E_coul = 54.06715034278064
cycle= 4 E= -128.531859117712  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000135916
diis-c [-7.85388511e-10  2.87457663e-04  4.30846133e-04 -1.92665428e-01
  1.19194712e+00]
  HOMO = -0.845397396035588  LUMO = 1.08982815978189
  mo_energy =
[-3.27690608e+01 -1.92706116e+00 -8.45397396e-01 -8.45397396e-01
 -8.45397396e-01  1.08982816e+00  1.08982816e+00  1.08982816e+00
  1.17839603e+00  5.69168987e+00  5.69168987e+00  5.69168987e+00
  7.20056805e+00  2.40662088e+01  2.40662088e+01  2.40662088e+01
  3.43839217e+01  1.18964502e+02  1.18964502e+02  1.18964502e+02
  1.38429301e+02  5.02531004e+02  1.87017765e+03  7.99985177e+03
  4.77675242e+04]
E1 = -182.59912675047042  E_coul = 54.067267632309786
cycle= 5 E= -128.531859118161  delta_E= -4.49e-10  |g|= 5.51e-06  |ddm|= 3.64e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59912675047042  E_coul = 54.067267632309786
  HOMO = -0.84539449738062  LUMO = 1.08982938511755
  mo_energy =
[-3.27690547e+01 -1.92705755e+00 -8.45394497e-01 -8.45394497e-01
 -8.45394497e-01  1.08982939e+00  1.08982939e+00  1.08982939e+00
  1.17839781e+00  5.69169341e+00  5.69169341e+00  5.69169341e+00
  7.20057192e+00  2.40662141e+01  2.40662141e+01  2.40662141e+01
  3.43839272e+01  1.18964508e+02  1.18964508e+02  1.18964508e+02
  1.38429307e+02  5.02531010e+02  1.87017766e+03  7.99985177e+03
  4.77675242e+04]
E1 = -182.59911327689744  E_coul = 54.067254158735125
Extra cycle  E= -128.531859118162  delta_E= -1.68e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145445e+03 8.33271387e+02 2.35731401e+02
 7.64488467e+01 1.00150173e+01 2.70426907e+01 3.79583116e-01
 1.10776188e+00 2.84218252e+00 3.68600972e+00 1.24555616e+01
 5.48137104e+01 3.30213834e-01 1.14432146e+00]
E = -128.53185911816232
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.7941303        1
[INPUT] 0    0    [1    /1   ]  3661.45445294        1
[INPUT] 0    0    [1    /1   ]  833.271386745        1
[INPUT] 0    0    [1    /1   ]  235.731400603        1
[INPUT] 0    0    [1    /1   ]  76.4488467177        1
[INPUT] 0    0    [1    /1   ]  10.0150172593        1
[INPUT] 0    0    [1    /1   ]  27.0426906996        1
[INPUT] 0    0    [1    /1   ]  0.379583115768       1
[INPUT] 0    0    [1    /1   ]  1.10776187794        1
[INPUT] 0    0    [1    /1   ]  2.8421825196         1
[INPUT] 1    0    [1    /1   ]  3.68600972481        1
[INPUT] 1    0    [1    /1   ]  12.4555616039        1
[INPUT] 1    0    [1    /1   ]  54.8137104465        1
[INPUT] 1    0    [1    /1   ]  0.330213833724       1
[INPUT] 1    0    [1    /1   ]  1.14432146217        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794130319566, 1.0]], [0, [3661.4544529385744, 1.0]], [0, [833.271386744575, 1.0]], [0, [235.7314006034564, 1.0]], [0, [76.4488467177375, 1.0]], [0, [10.015017259259857, 1.0]], [0, [27.042690699604375, 1.0]], [0, [0.3795831157682536, 1.0]], [0, [1.1077618779363707, 1.0]], [0, [2.842182519597786, 1.0]], [1, [3.6860097248072083, 1.0]], [1, [12.455561603937369, 1.0]], [1, [54.813710446454486, 1.0]], [1, [0.3302138337243952, 1.0]], [1, [1.1443214621703512, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413032]
bas 1, expnt(s) = [3661.45445294]
bas 2, expnt(s) = [833.27138674]
bas 3, expnt(s) = [235.7314006]
bas 4, expnt(s) = [76.44884672]
bas 5, expnt(s) = [10.01501726]
bas 6, expnt(s) = [27.0426907]
bas 7, expnt(s) = [0.37958312]
bas 8, expnt(s) = [1.10776188]
bas 9, expnt(s) = [2.84218252]
bas 10, expnt(s) = [3.68600972]
bas 11, expnt(s) = [12.4555616]
bas 12, expnt(s) = [54.81371045]
bas 13, expnt(s) = [0.33021383]
bas 14, expnt(s) = [1.14432146]
CPU time:       310.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145445e+03 1.18920096e+03
 8.33271387e+02 3.91836489e+02 2.35731401e+02 1.51994580e+02
 7.64488467e+01 6.53195566e+01 1.00150173e+01 1.42234123e+01
 2.70426907e+01 2.99607341e+01 3.79583116e-01 1.22178613e+00
 1.10776188e+00 2.72803436e+00 2.84218252e+00 5.53036757e+00
 3.68600972e+00 1.48997845e+01 1.24555616e+01 6.82634974e+01
 5.48137104e+01 4.35106824e+02 3.30213834e-01 7.30261612e-01
 1.14432146e+00 3.45278429e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998435031161794
cond(S) = 340.07756538533357
E1 = -183.57720687287468  E_coul = 55.078444219076374
init E= -128.498762653798
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948511002549  LUMO = 1.11551340161296
  mo_energy =
[-3.25552992e+01 -1.85277478e+00 -7.73948511e-01 -7.73948511e-01
 -7.73948511e-01  1.11551340e+00  1.11551340e+00  1.11551340e+00
  1.20726888e+00  5.77882356e+00  5.77882356e+00  5.77882356e+00
  7.28649646e+00  2.42237848e+01  2.42237848e+01  2.42237848e+01
  3.45460177e+01  1.19180525e+02  1.19180525e+02  1.19180525e+02
  1.38639826e+02  5.02774930e+02  1.87045249e+03  8.00015326e+03
  4.77678437e+04]
E1 = -182.11259481239318  E_coul = 53.58407891837912
cycle= 1 E= -128.528515894014  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450142
diis-c [-0.2026276  1.       ]
  HOMO = -0.879438474308757  LUMO = 1.07741370981182
  mo_energy =
[-3.28734731e+01 -1.96294477e+00 -8.79438474e-01 -8.79438474e-01
 -8.79438474e-01  1.07741371e+00  1.07741371e+00  1.07741371e+00
  1.16469521e+00  5.65005429e+00  5.65005429e+00  5.65005429e+00
  7.15942477e+00  2.39891156e+01  2.39891156e+01  2.39891156e+01
  3.43042295e+01  1.18860069e+02  1.18860069e+02  1.18860069e+02
  1.38326810e+02  5.02418062e+02  1.87005967e+03  7.99973146e+03
  4.77674030e+04]
E1 = -182.8433875869765  E_coul = 54.31237257392073
cycle= 2 E= -128.531015013056  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224477
diis-c [-6.03431942e-04  3.31740498e-01  6.68259502e-01]
  HOMO = -0.84512922789444  LUMO = 1.08988965277589
  mo_energy =
[-3.27685757e+01 -1.92686262e+00 -8.45129228e-01 -8.45129228e-01
 -8.45129228e-01  1.08988965e+00  1.08988965e+00  1.08988965e+00
  1.17846399e+00  5.69193519e+00  5.69193519e+00  5.69193519e+00
  7.20079920e+00  2.40665936e+01  2.40665936e+01  2.40665936e+01
  3.43843054e+01  1.18965000e+02  1.18965000e+02  1.18965000e+02
  1.38429785e+02  5.02531599e+02  1.87017837e+03  7.99985257e+03
  4.77675251e+04]
E1 = -182.5984169911899  E_coul = 54.06655789207745
cycle= 3 E= -128.531859099112  delta_E= -0.000844  |g|= 0.000475  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985724
diis-c [-9.58505939e-08 -2.15684185e-03 -1.48564377e-04  1.00230541e+00]
  HOMO = -0.845366603759447  LUMO = 1.08984057272629
  mo_energy =
[-3.27690065e+01 -1.92704098e+00 -8.45366604e-01 -8.45366604e-01
 -8.45366604e-01  1.08984057e+00  1.08984057e+00  1.08984057e+00
  1.17840594e+00  5.69172466e+00  5.69172466e+00  5.69172466e+00
  7.20059863e+00  2.40662564e+01  2.40662564e+01  2.40662564e+01
  3.43839687e+01  1.18964557e+02  1.18964557e+02  1.18964557e+02
  1.38429355e+02  5.02531066e+02  1.87017772e+03  7.99985184e+03
  4.77675243e+04]
E1 = -182.5990094604923  E_coul = 54.06715034278064
cycle= 4 E= -128.531859117712  delta_E= -1.86e-08  |g|= 6.21e-05  |ddm|= 0.000215
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000135916
diis-c [-7.85388511e-10  2.87457663e-04  4.30846133e-04 -1.92665428e-01
  1.19194712e+00]
  HOMO = -0.845397396035588  LUMO = 1.08982815978189
  mo_energy =
[-3.27690608e+01 -1.92706116e+00 -8.45397396e-01 -8.45397396e-01
 -8.45397396e-01  1.08982816e+00  1.08982816e+00  1.08982816e+00
  1.17839603e+00  5.69168987e+00  5.69168987e+00  5.69168987e+00
  7.20056805e+00  2.40662088e+01  2.40662088e+01  2.40662088e+01
  3.43839217e+01  1.18964502e+02  1.18964502e+02  1.18964502e+02
  1.38429301e+02  5.02531004e+02  1.87017765e+03  7.99985177e+03
  4.77675242e+04]
E1 = -182.59912675047042  E_coul = 54.067267632309786
cycle= 5 E= -128.531859118161  delta_E= -4.49e-10  |g|= 5.51e-06  |ddm|= 3.64e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59912675047042  E_coul = 54.067267632309786
  HOMO = -0.84539449738062  LUMO = 1.08982938511755
  mo_energy =
[-3.27690547e+01 -1.92705755e+00 -8.45394497e-01 -8.45394497e-01
 -8.45394497e-01  1.08982939e+00  1.08982939e+00  1.08982939e+00
  1.17839781e+00  5.69169341e+00  5.69169341e+00  5.69169341e+00
  7.20057192e+00  2.40662141e+01  2.40662141e+01  2.40662141e+01
  3.43839272e+01  1.18964508e+02  1.18964508e+02  1.18964508e+02
  1.38429307e+02  5.02531010e+02  1.87017766e+03  7.99985177e+03
  4.77675242e+04]
E1 = -182.59911327689744  E_coul = 54.067254158735125
Extra cycle  E= -128.531859118162  delta_E= -1.68e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 340.07756538533357
E1 = -182.59911327689744  E_coul = 54.067254158735125
init E= -128.531859118162
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845395444503883  LUMO = 1.08982905529819
  mo_energy =
[-3.27690577e+01 -1.92705842e+00 -8.45395445e-01 -8.45395445e-01
 -8.45395445e-01  1.08982906e+00  1.08982906e+00  1.08982906e+00
  1.17839752e+00  5.69169226e+00  5.69169226e+00  5.69169226e+00
  7.20057085e+00  2.40662119e+01  2.40662119e+01  2.40662119e+01
  3.43839250e+01  1.18964505e+02  1.18964505e+02  1.18964505e+02
  1.38429304e+02  5.02531007e+02  1.87017766e+03  7.99985177e+03
  4.77675242e+04]
E1 = -182.59912057193404  E_coul = 54.067261453771245
cycle= 1 E= -128.531859118163  delta_E= -4.83e-13  |g|= 1.01e-06  |ddm|= 7.36e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59912057193404  E_coul = 54.067261453771245
  HOMO = -0.845394933215876  LUMO = 1.08982924347869
  mo_energy =
[-3.27690562e+01 -1.92705786e+00 -8.45394933e-01 -8.45394933e-01
 -8.45394933e-01  1.08982924e+00  1.08982924e+00  1.08982924e+00
  1.17839774e+00  5.69169289e+00  5.69169289e+00  5.69169289e+00
  7.20057148e+00  2.40662131e+01  2.40662131e+01  2.40662131e+01
  3.43839262e+01  1.18964507e+02  1.18964507e+02  1.18964507e+02
  1.38429305e+02  5.02531008e+02  1.87017766e+03  7.99985177e+03
  4.77675242e+04]
E1 = -182.5991169547608  E_coul = 54.06725783659825
Extra cycle  E= -128.531859118163  delta_E= 2.56e-13  |g|= 4.92e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [2.44137941e+04 3.66145445e+03 8.33271387e+02 2.35731401e+02
 7.64488467e+01 1.00150173e+01 2.70426907e+01 3.79583116e-01
 1.10776188e+00 2.84218252e+00 3.68600972e+00 1.24555616e+01
 5.48137104e+01 3.30213834e-01 1.14432146e+00]
grad_E = [ 5.80563474e-11 -2.99758289e-09  6.24505512e-08 -6.94055488e-07
  1.97804757e-06 -4.26558334e-05  2.57915220e-05 -2.05508065e-04
  1.39510592e-04 -4.40386587e-05 -1.01725817e-05  3.49174940e-06
  4.25781103e-08 -3.92551487e-04  1.02654903e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446972        1
[INPUT] 0    0    [1    /1   ]  833.27106181         1
[INPUT] 0    0    [1    /1   ]  235.734715273        1
[INPUT] 0    0    [1    /1   ]  76.4326765197        1
[INPUT] 0    0    [1    /1   ]  10.0326086811        1
[INPUT] 0    0    [1    /1   ]  27.0553253391        1
[INPUT] 0    0    [1    /1   ]  0.38081796927        1
[INPUT] 0    0    [1    /1   ]  1.11384177583        1
[INPUT] 0    0    [1    /1   ]  2.86608493634        1
[INPUT] 1    0    [1    /1   ]  3.6855578091         1
[INPUT] 1    0    [1    /1   ]  12.4532964311        1
[INPUT] 1    0    [1    /1   ]  54.8028491323        1
[INPUT] 1    0    [1    /1   ]  0.330244489026       1
[INPUT] 1    0    [1    /1   ]  1.144268298          1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794129996033, 1.0]], [0, [3661.4544697201213, 1.0]], [0, [833.2710618098889, 1.0]], [0, [235.7347152725184, 1.0]], [0, [76.43267651970164, 1.0]], [0, [10.032608681064664, 1.0]], [0, [27.055325339126334, 1.0]], [0, [0.3808179692698367, 1.0]], [0, [1.113841775834803, 1.0]], [0, [2.8660849363360543, 1.0]], [1, [3.685557809098545, 1.0]], [1, [12.453296431144715, 1.0]], [1, [54.80284913230888, 1.0]], [1, [0.3302444890263462, 1.0]], [1, [1.1442682979951875, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413]
bas 1, expnt(s) = [3661.45446972]
bas 2, expnt(s) = [833.27106181]
bas 3, expnt(s) = [235.73471527]
bas 4, expnt(s) = [76.43267652]
bas 5, expnt(s) = [10.03260868]
bas 6, expnt(s) = [27.05532534]
bas 7, expnt(s) = [0.38081797]
bas 8, expnt(s) = [1.11384178]
bas 9, expnt(s) = [2.86608494]
bas 10, expnt(s) = [3.68555781]
bas 11, expnt(s) = [12.45329643]
bas 12, expnt(s) = [54.80284913]
bas 13, expnt(s) = [0.33024449]
bas 14, expnt(s) = [1.1442683]
CPU time:       314.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271062e+02 3.91836374e+02 2.35734715e+02 1.51996183e+02
 7.64326765e+01 6.53091942e+01 1.00326087e+01 1.42421459e+01
 2.70553253e+01 2.99712320e+01 3.80817969e-01 1.22476594e+00
 1.11384178e+00 2.73925619e+00 2.86608494e+00 5.56521333e+00
 3.68555781e+00 1.48975011e+01 1.24532964e+01 6.82479797e+01
 5.48028491e+01 4.34999056e+02 3.30244489e-01 7.30346355e-01
 1.14426830e+00 3.45258377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998433114362914
cond(S) = 342.57089879697764
E1 = -183.57722457477325  E_coul = 55.07845258484161
init E= -128.498771989932
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773947790597366  LUMO = 1.11558622498341
  mo_energy =
[-3.25553025e+01 -1.85276973e+00 -7.73947791e-01 -7.73947791e-01
 -7.73947791e-01  1.11558622e+00  1.11558622e+00  1.11558622e+00
  1.21487358e+00  5.77851335e+00  5.77851335e+00  5.77851335e+00
  7.34427998e+00  2.42200592e+01  2.42200592e+01  2.42200592e+01
  3.47014368e+01  1.19155280e+02  1.19155280e+02  1.19155280e+02
  1.38844222e+02  5.02962319e+02  1.87061428e+03  8.00029477e+03
  4.77679606e+04]
E1 = -182.11278170865558  E_coul = 53.58426468606082
cycle= 1 E= -128.528517022595  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450136
diis-c [-0.2026221  1.       ]
  HOMO = -0.879422752882814  LUMO = 1.07749481137793
  mo_energy =
[-3.28734454e+01 -1.96292687e+00 -8.79422753e-01 -8.79422753e-01
 -8.79422753e-01  1.07749481e+00  1.07749481e+00  1.07749481e+00
  1.17202438e+00  5.64977096e+00  5.64977096e+00  5.64977096e+00
  7.21662511e+00  2.39854320e+01  2.39854320e+01  2.39854320e+01
  3.44595262e+01  1.18834861e+02  1.18834861e+02  1.18834861e+02
  1.38531245e+02  5.02605492e+02  1.87022150e+03  7.99987300e+03
  4.77675201e+04]
E1 = -182.84350771635937  E_coul = 54.312491889109396
cycle= 2 E= -128.53101582725  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224472
diis-c [-6.04198087e-04  3.31737572e-01  6.68262428e-01]
  HOMO = -0.84511662850916  LUMO = 1.08996970214459
  mo_energy =
[-3.27685568e+01 -1.92684776e+00 -8.45116629e-01 -8.45116629e-01
 -8.45116629e-01  1.08996970e+00  1.08996970e+00  1.08996970e+00
  1.18588390e+00  5.69164466e+00  5.69164466e+00  5.69164466e+00
  7.25819482e+00  2.40628983e+01  2.40628983e+01  2.40628983e+01
  3.45396437e+01  1.18939781e+02  1.18939781e+02  1.18939781e+02
  1.38634209e+02  5.02719017e+02  1.87034019e+03  7.99999411e+03
  4.77676421e+04]
E1 = -182.59857527654952  E_coul = 54.06671555703506
cycle= 3 E= -128.531859719514  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000982781
diis-c [-9.52205876e-08 -2.15384498e-03 -1.54916928e-04  1.00230876e+00]
  HOMO = -0.845353003967668  LUMO = 1.08992108377157
  mo_energy =
[-3.27689861e+01 -1.92702522e+00 -8.45353004e-01 -8.45353004e-01
 -8.45353004e-01  1.08992108e+00  1.08992108e+00  1.08992108e+00
  1.18582598e+00  5.69143520e+00  5.69143520e+00  5.69143520e+00
  7.25799454e+00  2.40625626e+01  2.40625626e+01  2.40625626e+01
  3.45393083e+01  1.18939340e+02  1.18939340e+02  1.18939340e+02
  1.38633781e+02  5.02718486e+02  1.87033955e+03  7.99999338e+03
  4.77676413e+04]
E1 = -182.5991659443275  E_coul = 54.06730620639149
cycle= 4 E= -128.531859737936  delta_E= -1.84e-08  |g|= 6.19e-05  |ddm|= 0.000212
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00013564
diis-c [-7.82600470e-10  2.87236976e-04  4.32075926e-04 -1.92546420e-01
  1.19182711e+00]
  HOMO = -0.845383666510481  LUMO = 1.08990873180765
  mo_energy =
[-3.27690402e+01 -1.92704531e+00 -8.45383667e-01 -8.45383667e-01
 -8.45383667e-01  1.08990873e+00  1.08990873e+00  1.08990873e+00
  1.18581606e+00  5.69140055e+00  5.69140055e+00  5.69140055e+00
  7.25796398e+00  2.40625152e+01  2.40625152e+01  2.40625152e+01
  3.45392614e+01  1.18939286e+02  1.18939286e+02  1.18939286e+02
  1.38633726e+02  5.02718424e+02  1.87033948e+03  7.99999331e+03
  4.77676412e+04]
E1 = -182.599283144767  E_coul = 54.06742340638588
cycle= 5 E= -128.531859738381  delta_E= -4.45e-10  |g|= 5.5e-06  |ddm|= 3.61e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.599283144767  E_coul = 54.06742340638588
  HOMO = -0.845380773958679  LUMO = 1.08990995413836
  mo_energy =
[-3.27690341e+01 -1.92704171e+00 -8.45380774e-01 -8.45380774e-01
 -8.45380774e-01  1.08990995e+00  1.08990995e+00  1.08990995e+00
  1.18581785e+00  5.69140408e+00  5.69140408e+00  5.69140408e+00
  7.25796785e+00  2.40625205e+01  2.40625205e+01  2.40625205e+01
  3.45392669e+01  1.18939291e+02  1.18939291e+02  1.18939291e+02
  1.38633732e+02  5.02718430e+02  1.87033949e+03  7.99999331e+03
  4.77676412e+04]
E1 = -182.5992696819762  E_coul = 54.06740994359294
Extra cycle  E= -128.531859738383  delta_E= -2.13e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271062e+02 2.35734715e+02
 7.64326765e+01 1.00326087e+01 2.70553253e+01 3.80817969e-01
 1.11384178e+00 2.86608494e+00 3.68555781e+00 1.24532964e+01
 5.48028491e+01 3.30244489e-01 1.14426830e+00]
E = -128.53185973838328
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446972        1
[INPUT] 0    0    [1    /1   ]  833.27106181         1
[INPUT] 0    0    [1    /1   ]  235.734715273        1
[INPUT] 0    0    [1    /1   ]  76.4326765197        1
[INPUT] 0    0    [1    /1   ]  10.0326086811        1
[INPUT] 0    0    [1    /1   ]  27.0553253391        1
[INPUT] 0    0    [1    /1   ]  0.38081796927        1
[INPUT] 0    0    [1    /1   ]  1.11384177583        1
[INPUT] 0    0    [1    /1   ]  2.86608493634        1
[INPUT] 1    0    [1    /1   ]  3.6855578091         1
[INPUT] 1    0    [1    /1   ]  12.4532964311        1
[INPUT] 1    0    [1    /1   ]  54.8028491323        1
[INPUT] 1    0    [1    /1   ]  0.330244489026       1
[INPUT] 1    0    [1    /1   ]  1.144268298          1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794129996033, 1.0]], [0, [3661.4544697201213, 1.0]], [0, [833.2710618098889, 1.0]], [0, [235.7347152725184, 1.0]], [0, [76.43267651970164, 1.0]], [0, [10.032608681064664, 1.0]], [0, [27.055325339126334, 1.0]], [0, [0.3808179692698367, 1.0]], [0, [1.113841775834803, 1.0]], [0, [2.8660849363360543, 1.0]], [1, [3.685557809098545, 1.0]], [1, [12.453296431144715, 1.0]], [1, [54.80284913230888, 1.0]], [1, [0.3302444890263462, 1.0]], [1, [1.1442682979951875, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79413]
bas 1, expnt(s) = [3661.45446972]
bas 2, expnt(s) = [833.27106181]
bas 3, expnt(s) = [235.73471527]
bas 4, expnt(s) = [76.43267652]
bas 5, expnt(s) = [10.03260868]
bas 6, expnt(s) = [27.05532534]
bas 7, expnt(s) = [0.38081797]
bas 8, expnt(s) = [1.11384178]
bas 9, expnt(s) = [2.86608494]
bas 10, expnt(s) = [3.68555781]
bas 11, expnt(s) = [12.45329643]
bas 12, expnt(s) = [54.80284913]
bas 13, expnt(s) = [0.33024449]
bas 14, expnt(s) = [1.1442683]
CPU time:       315.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271062e+02 3.91836374e+02 2.35734715e+02 1.51996183e+02
 7.64326765e+01 6.53091942e+01 1.00326087e+01 1.42421459e+01
 2.70553253e+01 2.99712320e+01 3.80817969e-01 1.22476594e+00
 1.11384178e+00 2.73925619e+00 2.86608494e+00 5.56521333e+00
 3.68555781e+00 1.48975011e+01 1.24532964e+01 6.82479797e+01
 5.48028491e+01 4.34999056e+02 3.30244489e-01 7.30346355e-01
 1.14426830e+00 3.45258377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998433114362914
cond(S) = 342.57089879697764
E1 = -183.57722457477325  E_coul = 55.07845258484161
init E= -128.498771989932
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947790597366  LUMO = 1.11558622498341
  mo_energy =
[-3.25553025e+01 -1.85276973e+00 -7.73947791e-01 -7.73947791e-01
 -7.73947791e-01  1.11558622e+00  1.11558622e+00  1.11558622e+00
  1.21487358e+00  5.77851335e+00  5.77851335e+00  5.77851335e+00
  7.34427998e+00  2.42200592e+01  2.42200592e+01  2.42200592e+01
  3.47014368e+01  1.19155280e+02  1.19155280e+02  1.19155280e+02
  1.38844222e+02  5.02962319e+02  1.87061428e+03  8.00029477e+03
  4.77679606e+04]
E1 = -182.11278170865558  E_coul = 53.58426468606082
cycle= 1 E= -128.528517022595  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450136
diis-c [-0.2026221  1.       ]
  HOMO = -0.879422752882814  LUMO = 1.07749481137793
  mo_energy =
[-3.28734454e+01 -1.96292687e+00 -8.79422753e-01 -8.79422753e-01
 -8.79422753e-01  1.07749481e+00  1.07749481e+00  1.07749481e+00
  1.17202438e+00  5.64977096e+00  5.64977096e+00  5.64977096e+00
  7.21662511e+00  2.39854320e+01  2.39854320e+01  2.39854320e+01
  3.44595262e+01  1.18834861e+02  1.18834861e+02  1.18834861e+02
  1.38531245e+02  5.02605492e+02  1.87022150e+03  7.99987300e+03
  4.77675201e+04]
E1 = -182.84350771635937  E_coul = 54.312491889109396
cycle= 2 E= -128.53101582725  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224472
diis-c [-6.04198087e-04  3.31737572e-01  6.68262428e-01]
  HOMO = -0.84511662850916  LUMO = 1.08996970214459
  mo_energy =
[-3.27685568e+01 -1.92684776e+00 -8.45116629e-01 -8.45116629e-01
 -8.45116629e-01  1.08996970e+00  1.08996970e+00  1.08996970e+00
  1.18588390e+00  5.69164466e+00  5.69164466e+00  5.69164466e+00
  7.25819482e+00  2.40628983e+01  2.40628983e+01  2.40628983e+01
  3.45396437e+01  1.18939781e+02  1.18939781e+02  1.18939781e+02
  1.38634209e+02  5.02719017e+02  1.87034019e+03  7.99999411e+03
  4.77676421e+04]
E1 = -182.59857527654952  E_coul = 54.06671555703506
cycle= 3 E= -128.531859719514  delta_E= -0.000844  |g|= 0.000473  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000982781
diis-c [-9.52205876e-08 -2.15384498e-03 -1.54916928e-04  1.00230876e+00]
  HOMO = -0.845353003967668  LUMO = 1.08992108377157
  mo_energy =
[-3.27689861e+01 -1.92702522e+00 -8.45353004e-01 -8.45353004e-01
 -8.45353004e-01  1.08992108e+00  1.08992108e+00  1.08992108e+00
  1.18582598e+00  5.69143520e+00  5.69143520e+00  5.69143520e+00
  7.25799454e+00  2.40625626e+01  2.40625626e+01  2.40625626e+01
  3.45393083e+01  1.18939340e+02  1.18939340e+02  1.18939340e+02
  1.38633781e+02  5.02718486e+02  1.87033955e+03  7.99999338e+03
  4.77676413e+04]
E1 = -182.5991659443275  E_coul = 54.06730620639149
cycle= 4 E= -128.531859737936  delta_E= -1.84e-08  |g|= 6.19e-05  |ddm|= 0.000212
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00013564
diis-c [-7.82600470e-10  2.87236976e-04  4.32075926e-04 -1.92546420e-01
  1.19182711e+00]
  HOMO = -0.845383666510481  LUMO = 1.08990873180765
  mo_energy =
[-3.27690402e+01 -1.92704531e+00 -8.45383667e-01 -8.45383667e-01
 -8.45383667e-01  1.08990873e+00  1.08990873e+00  1.08990873e+00
  1.18581606e+00  5.69140055e+00  5.69140055e+00  5.69140055e+00
  7.25796398e+00  2.40625152e+01  2.40625152e+01  2.40625152e+01
  3.45392614e+01  1.18939286e+02  1.18939286e+02  1.18939286e+02
  1.38633726e+02  5.02718424e+02  1.87033948e+03  7.99999331e+03
  4.77676412e+04]
E1 = -182.599283144767  E_coul = 54.06742340638588
cycle= 5 E= -128.531859738381  delta_E= -4.45e-10  |g|= 5.5e-06  |ddm|= 3.61e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.599283144767  E_coul = 54.06742340638588
  HOMO = -0.845380773958679  LUMO = 1.08990995413836
  mo_energy =
[-3.27690341e+01 -1.92704171e+00 -8.45380774e-01 -8.45380774e-01
 -8.45380774e-01  1.08990995e+00  1.08990995e+00  1.08990995e+00
  1.18581785e+00  5.69140408e+00  5.69140408e+00  5.69140408e+00
  7.25796785e+00  2.40625205e+01  2.40625205e+01  2.40625205e+01
  3.45392669e+01  1.18939291e+02  1.18939291e+02  1.18939291e+02
  1.38633732e+02  5.02718430e+02  1.87033949e+03  7.99999331e+03
  4.77676412e+04]
E1 = -182.5992696819762  E_coul = 54.06740994359294
Extra cycle  E= -128.531859738383  delta_E= -2.13e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 342.57089879697764
E1 = -182.5992696819762  E_coul = 54.06740994359294
init E= -128.531859738383
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.845381720352891  LUMO = 1.08990962450263
  mo_energy =
[-3.27690372e+01 -1.92704258e+00 -8.45381720e-01 -8.45381720e-01
 -8.45381720e-01  1.08990962e+00  1.08990962e+00  1.08990962e+00
  1.18581756e+00  5.69140293e+00  5.69140293e+00  5.69140293e+00
  7.25796678e+00  2.40625183e+01  2.40625183e+01  2.40625183e+01
  3.45392647e+01  1.18939288e+02  1.18939288e+02  1.18939288e+02
  1.38633729e+02  5.02718427e+02  1.87033948e+03  7.99999331e+03
  4.77676412e+04]
E1 = -182.59927696821967  E_coul = 54.067417229836295
cycle= 1 E= -128.531859738383  delta_E= -1.14e-13  |g|= 1e-06  |ddm|= 7.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59927696821967  E_coul = 54.067417229836295
  HOMO = -0.845381209681451  LUMO = 1.0899098124479
  mo_energy =
[-3.27690356e+01 -1.92704202e+00 -8.45381210e-01 -8.45381210e-01
 -8.45381210e-01  1.08990981e+00  1.08990981e+00  1.08990981e+00
  1.18581778e+00  5.69140356e+00  5.69140356e+00  5.69140356e+00
  7.25796741e+00  2.40625195e+01  2.40625195e+01  2.40625195e+01
  3.45392659e+01  1.18939290e+02  1.18939290e+02  1.18939290e+02
  1.38633731e+02  5.02718428e+02  1.87033948e+03  7.99999331e+03
  4.77676412e+04]
E1 = -182.59927335533965  E_coul = 54.06741361695628
Extra cycle  E= -128.531859738383  delta_E= 2.84e-14  |g|= 4.91e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271062e+02 2.35734715e+02
 7.64326765e+01 1.00326087e+01 2.70553253e+01 3.80817969e-01
 1.11384178e+00 2.86608494e+00 3.68555781e+00 1.24532964e+01
 5.48028491e+01 3.30244489e-01 1.14426830e+00]
grad_E = [-1.25819669e-11  6.44824518e-10 -4.88395794e-09 -1.01671367e-07
  2.83117164e-07 -1.83270274e-05  1.92600408e-05 -1.11546437e-04
  7.73310571e-05 -2.28903129e-05 -4.80522007e-06  1.66867829e-06
  8.42691731e-08 -1.97499515e-04  5.08889671e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447194        1
[INPUT] 0    0    [1    /1   ]  833.271019199        1
[INPUT] 0    0    [1    /1   ]  235.735131952        1
[INPUT] 0    0    [1    /1   ]  76.4309691565        1
[INPUT] 0    0    [1    /1   ]  10.0376419112        1
[INPUT] 0    0    [1    /1   ]  27.0536719841        1
[INPUT] 0    0    [1    /1   ]  0.381369490603       1
[INPUT] 0    0    [1    /1   ]  1.11671128743        1
[INPUT] 0    0    [1    /1   ]  2.87986735773        1
[INPUT] 1    0    [1    /1   ]  3.68505466778        1
[INPUT] 1    0    [1    /1   ]  12.4508531698        1
[INPUT] 1    0    [1    /1   ]  54.7900021672        1
[INPUT] 1    0    [1    /1   ]  0.330262191943       1
[INPUT] 1    0    [1    /1   ]  1.14419053002        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79412995308, 1.0]], [0, [3661.454471940947, 1.0]], [0, [833.2710191993461, 1.0]], [0, [235.73513195168024, 1.0]], [0, [76.43096915645715, 1.0]], [0, [10.037641911181577, 1.0]], [0, [27.053671984099253, 1.0]], [0, [0.3813694906025272, 1.0]], [0, [1.116711287432617, 1.0]], [0, [2.879867357733368, 1.0]], [1, [3.68505466778107, 1.0]], [1, [12.450853169779318, 1.0]], [1, [54.79000216716036, 1.0]], [1, [0.3302621919433368, 1.0]], [1, [1.1441905300238084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412995]
bas 1, expnt(s) = [3661.45447194]
bas 2, expnt(s) = [833.2710192]
bas 3, expnt(s) = [235.73513195]
bas 4, expnt(s) = [76.43096916]
bas 5, expnt(s) = [10.03764191]
bas 6, expnt(s) = [27.05367198]
bas 7, expnt(s) = [0.38136949]
bas 8, expnt(s) = [1.11671129]
bas 9, expnt(s) = [2.87986736]
bas 10, expnt(s) = [3.68505467]
bas 11, expnt(s) = [12.45085317]
bas 12, expnt(s) = [54.79000217]
bas 13, expnt(s) = [0.33026219]
bas 14, expnt(s) = [1.14419053]
CPU time:       318.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33271019e+02 3.91836359e+02 2.35735132e+02 1.51996384e+02
 7.64309692e+01 6.53081000e+01 1.00376419e+01 1.42475043e+01
 2.70536720e+01 2.99698583e+01 3.81369491e-01 1.22609602e+00
 1.11671129e+00 2.74454720e+00 2.87986736e+00 5.58527278e+00
 3.68505467e+00 1.48949590e+01 1.24508532e+01 6.82312428e+01
 5.47900022e+01 4.34871593e+02 3.30262192e-01 7.30395294e-01
 1.14419053e+00 3.45229046e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843237764276
cond(S) = 343.7785358304233
E1 = -183.57722963110504  E_coul = 55.07845940138714
init E= -128.498770229718
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773947235126277  LUMO = 1.11561246208676
  mo_energy =
[-3.25553036e+01 -1.85276696e+00 -7.73947235e-01 -7.73947235e-01
 -7.73947235e-01  1.11561246e+00  1.11561246e+00  1.11561246e+00
  1.21847077e+00  5.77805369e+00  5.77805369e+00  5.77805369e+00
  7.37439007e+00  2.42158845e+01  2.42158845e+01  2.42158845e+01
  3.47752628e+01  1.19126178e+02  1.19126178e+02  1.19126178e+02
  1.38925927e+02  5.03034488e+02  1.87067754e+03  8.00035019e+03
  4.77680065e+04]
E1 = -182.1128990211732  E_coul = 53.584381542304
cycle= 1 E= -128.528517478869  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450147
diis-c [-0.20263207  1.        ]
  HOMO = -0.879412656435878  LUMO = 1.07752751128129
  mo_energy =
[-3.28734289e+01 -1.96291531e+00 -8.79412656e-01 -8.79412656e-01
 -8.79412656e-01  1.07752751e+00  1.07752751e+00  1.07752751e+00
  1.17548827e+00  5.64933359e+00  5.64933359e+00  5.64933359e+00
  7.24642844e+00  2.39812895e+01  2.39812895e+01  2.39812895e+01
  3.45333130e+01  1.18805786e+02  1.18805786e+02  1.18805786e+02
  1.38612978e+02  5.02677683e+02  1.87028478e+03  7.99992844e+03
  4.77675659e+04]
E1 = -182.84358924476714  E_coul = 54.31257312998902
cycle= 2 E= -128.531016114778  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0707
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224477
diis-c [-6.04562134e-04  3.31736150e-01  6.68263850e-01]
  HOMO = -0.84510816558374  LUMO = 1.09000145488043
  mo_energy =
[-3.27685452e+01 -1.92683784e+00 -8.45108166e-01 -8.45108166e-01
 -8.45108166e-01  1.09000145e+00  1.09000145e+00  1.09000145e+00
  1.18939229e+00  5.69120139e+00  5.69120139e+00  5.69120139e+00
  7.28810158e+00  2.40587469e+01  2.40587469e+01  2.40587469e+01
  3.46134444e+01  1.18910699e+02  1.18910699e+02  1.18910699e+02
  1.38715933e+02  5.02791202e+02  1.87040346e+03  8.00004954e+03
  4.77676879e+04]
E1 = -182.59867936846388  E_coul = 54.066819474318365
cycle= 3 E= -128.531859894145  delta_E= -0.000844  |g|= 0.000472  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000980839
diis-c [-9.49517559e-08 -2.15173488e-03 -1.59331242e-04  1.00231107e+00]
  HOMO = -0.845343852640623  LUMO = 1.08995315308715
  mo_energy =
[-3.27689733e+01 -1.92701464e+00 -8.45343853e-01 -8.45343853e-01
 -8.45343853e-01  1.08995315e+00  1.08995315e+00  1.08995315e+00
  1.18933457e+00  5.69099270e+00  5.69099270e+00  5.69099270e+00
  7.28790168e+00  2.40584122e+01  2.40584122e+01  2.40584122e+01
  3.46131099e+01  1.18910259e+02  1.18910259e+02  1.18910259e+02
  1.38715506e+02  5.02790671e+02  1.87040282e+03  8.00004882e+03
  4.77676871e+04]
E1 = -182.59926865270504  E_coul = 54.067408740246755
cycle= 4 E= -128.531859912458  delta_E= -1.83e-08  |g|= 6.17e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00013551
diis-c [-7.81300861e-10  2.87206088e-04  4.32965466e-04 -1.92573369e-01
  1.19185320e+00]
  HOMO = -0.84537444057106  LUMO = 1.08994083690389
  mo_energy =
[-3.27690274e+01 -1.92703467e+00 -8.45374441e-01 -8.45374441e-01
 -8.45374441e-01  1.08994084e+00  1.08994084e+00  1.08994084e+00
  1.18932466e+00  5.69095812e+00  5.69095812e+00  5.69095812e+00
  7.28787114e+00  2.40583648e+01  2.40583648e+01  2.40583648e+01
  3.46130630e+01  1.18910204e+02  1.18910204e+02  1.18910204e+02
  1.38715451e+02  5.02790610e+02  1.87040275e+03  8.00004874e+03
  4.77676871e+04]
E1 = -182.59938581384  E_coul = 54.06752590093816
cycle= 5 E= -128.531859912902  delta_E= -4.44e-10  |g|= 5.49e-06  |ddm|= 3.59e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59938581384  E_coul = 54.06752590093816
  HOMO = -0.845371549569253  LUMO = 1.08994205822132
  mo_energy =
[-3.27690213e+01 -1.92703107e+00 -8.45371550e-01 -8.45371550e-01
 -8.45371550e-01  1.08994206e+00  1.08994206e+00  1.08994206e+00
  1.18932646e+00  5.69096165e+00  5.69096165e+00  5.69096165e+00
  7.28787502e+00  2.40583702e+01  2.40583702e+01  2.40583702e+01
  3.46130686e+01  1.18910210e+02  1.18910210e+02  1.18910210e+02
  1.38715457e+02  5.02790615e+02  1.87040275e+03  8.00004875e+03
  4.77676871e+04]
E1 = -182.5993723453496  E_coul = 54.06751243244593
Extra cycle  E= -128.531859912904  delta_E= -1.82e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271019e+02 2.35735132e+02
 7.64309692e+01 1.00376419e+01 2.70536720e+01 3.81369491e-01
 1.11671129e+00 2.87986736e+00 3.68505467e+00 1.24508532e+01
 5.47900022e+01 3.30262192e-01 1.14419053e+00]
E = -128.53185991290366
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447194        1
[INPUT] 0    0    [1    /1   ]  833.271019199        1
[INPUT] 0    0    [1    /1   ]  235.735131952        1
[INPUT] 0    0    [1    /1   ]  76.4309691565        1
[INPUT] 0    0    [1    /1   ]  10.0376419112        1
[INPUT] 0    0    [1    /1   ]  27.0536719841        1
[INPUT] 0    0    [1    /1   ]  0.381369490603       1
[INPUT] 0    0    [1    /1   ]  1.11671128743        1
[INPUT] 0    0    [1    /1   ]  2.87986735773        1
[INPUT] 1    0    [1    /1   ]  3.68505466778        1
[INPUT] 1    0    [1    /1   ]  12.4508531698        1
[INPUT] 1    0    [1    /1   ]  54.7900021672        1
[INPUT] 1    0    [1    /1   ]  0.330262191943       1
[INPUT] 1    0    [1    /1   ]  1.14419053002        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.79412995308, 1.0]], [0, [3661.454471940947, 1.0]], [0, [833.2710191993461, 1.0]], [0, [235.73513195168024, 1.0]], [0, [76.43096915645715, 1.0]], [0, [10.037641911181577, 1.0]], [0, [27.053671984099253, 1.0]], [0, [0.3813694906025272, 1.0]], [0, [1.116711287432617, 1.0]], [0, [2.879867357733368, 1.0]], [1, [3.68505466778107, 1.0]], [1, [12.450853169779318, 1.0]], [1, [54.79000216716036, 1.0]], [1, [0.3302621919433368, 1.0]], [1, [1.1441905300238084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412995]
bas 1, expnt(s) = [3661.45447194]
bas 2, expnt(s) = [833.2710192]
bas 3, expnt(s) = [235.73513195]
bas 4, expnt(s) = [76.43096916]
bas 5, expnt(s) = [10.03764191]
bas 6, expnt(s) = [27.05367198]
bas 7, expnt(s) = [0.38136949]
bas 8, expnt(s) = [1.11671129]
bas 9, expnt(s) = [2.87986736]
bas 10, expnt(s) = [3.68505467]
bas 11, expnt(s) = [12.45085317]
bas 12, expnt(s) = [54.79000217]
bas 13, expnt(s) = [0.33026219]
bas 14, expnt(s) = [1.14419053]
CPU time:       319.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920097e+03
 8.33271019e+02 3.91836359e+02 2.35735132e+02 1.51996384e+02
 7.64309692e+01 6.53081000e+01 1.00376419e+01 1.42475043e+01
 2.70536720e+01 2.99698583e+01 3.81369491e-01 1.22609602e+00
 1.11671129e+00 2.74454720e+00 2.87986736e+00 5.58527278e+00
 3.68505467e+00 1.48949590e+01 1.24508532e+01 6.82312428e+01
 5.47900022e+01 4.34871593e+02 3.30262192e-01 7.30395294e-01
 1.14419053e+00 3.45229046e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843237764276
cond(S) = 343.7785358304233
E1 = -183.57722963110504  E_coul = 55.07845940138714
init E= -128.498770229718
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947235126277  LUMO = 1.11561246208676
  mo_energy =
[-3.25553036e+01 -1.85276696e+00 -7.73947235e-01 -7.73947235e-01
 -7.73947235e-01  1.11561246e+00  1.11561246e+00  1.11561246e+00
  1.21847077e+00  5.77805369e+00  5.77805369e+00  5.77805369e+00
  7.37439007e+00  2.42158845e+01  2.42158845e+01  2.42158845e+01
  3.47752628e+01  1.19126178e+02  1.19126178e+02  1.19126178e+02
  1.38925927e+02  5.03034488e+02  1.87067754e+03  8.00035019e+03
  4.77680065e+04]
E1 = -182.1128990211732  E_coul = 53.584381542304
cycle= 1 E= -128.528517478869  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450147
diis-c [-0.20263207  1.        ]
  HOMO = -0.879412656435878  LUMO = 1.07752751128129
  mo_energy =
[-3.28734289e+01 -1.96291531e+00 -8.79412656e-01 -8.79412656e-01
 -8.79412656e-01  1.07752751e+00  1.07752751e+00  1.07752751e+00
  1.17548827e+00  5.64933359e+00  5.64933359e+00  5.64933359e+00
  7.24642844e+00  2.39812895e+01  2.39812895e+01  2.39812895e+01
  3.45333130e+01  1.18805786e+02  1.18805786e+02  1.18805786e+02
  1.38612978e+02  5.02677683e+02  1.87028478e+03  7.99992844e+03
  4.77675659e+04]
E1 = -182.84358924476714  E_coul = 54.31257312998902
cycle= 2 E= -128.531016114778  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0707
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.224477
diis-c [-6.04562134e-04  3.31736150e-01  6.68263850e-01]
  HOMO = -0.84510816558374  LUMO = 1.09000145488043
  mo_energy =
[-3.27685452e+01 -1.92683784e+00 -8.45108166e-01 -8.45108166e-01
 -8.45108166e-01  1.09000145e+00  1.09000145e+00  1.09000145e+00
  1.18939229e+00  5.69120139e+00  5.69120139e+00  5.69120139e+00
  7.28810158e+00  2.40587469e+01  2.40587469e+01  2.40587469e+01
  3.46134444e+01  1.18910699e+02  1.18910699e+02  1.18910699e+02
  1.38715933e+02  5.02791202e+02  1.87040346e+03  8.00004954e+03
  4.77676879e+04]
E1 = -182.59867936846388  E_coul = 54.066819474318365
cycle= 3 E= -128.531859894145  delta_E= -0.000844  |g|= 0.000472  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000980839
diis-c [-9.49517559e-08 -2.15173488e-03 -1.59331242e-04  1.00231107e+00]
  HOMO = -0.845343852640623  LUMO = 1.08995315308715
  mo_energy =
[-3.27689733e+01 -1.92701464e+00 -8.45343853e-01 -8.45343853e-01
 -8.45343853e-01  1.08995315e+00  1.08995315e+00  1.08995315e+00
  1.18933457e+00  5.69099270e+00  5.69099270e+00  5.69099270e+00
  7.28790168e+00  2.40584122e+01  2.40584122e+01  2.40584122e+01
  3.46131099e+01  1.18910259e+02  1.18910259e+02  1.18910259e+02
  1.38715506e+02  5.02790671e+02  1.87040282e+03  8.00004882e+03
  4.77676871e+04]
E1 = -182.59926865270504  E_coul = 54.067408740246755
cycle= 4 E= -128.531859912458  delta_E= -1.83e-08  |g|= 6.17e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00013551
diis-c [-7.81300861e-10  2.87206088e-04  4.32965466e-04 -1.92573369e-01
  1.19185320e+00]
  HOMO = -0.84537444057106  LUMO = 1.08994083690389
  mo_energy =
[-3.27690274e+01 -1.92703467e+00 -8.45374441e-01 -8.45374441e-01
 -8.45374441e-01  1.08994084e+00  1.08994084e+00  1.08994084e+00
  1.18932466e+00  5.69095812e+00  5.69095812e+00  5.69095812e+00
  7.28787114e+00  2.40583648e+01  2.40583648e+01  2.40583648e+01
  3.46130630e+01  1.18910204e+02  1.18910204e+02  1.18910204e+02
  1.38715451e+02  5.02790610e+02  1.87040275e+03  8.00004874e+03
  4.77676871e+04]
E1 = -182.59938581384  E_coul = 54.06752590093816
cycle= 5 E= -128.531859912902  delta_E= -4.44e-10  |g|= 5.49e-06  |ddm|= 3.59e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59938581384  E_coul = 54.06752590093816
  HOMO = -0.845371549569253  LUMO = 1.08994205822132
  mo_energy =
[-3.27690213e+01 -1.92703107e+00 -8.45371550e-01 -8.45371550e-01
 -8.45371550e-01  1.08994206e+00  1.08994206e+00  1.08994206e+00
  1.18932646e+00  5.69096165e+00  5.69096165e+00  5.69096165e+00
  7.28787502e+00  2.40583702e+01  2.40583702e+01  2.40583702e+01
  3.46130686e+01  1.18910210e+02  1.18910210e+02  1.18910210e+02
  1.38715457e+02  5.02790615e+02  1.87040275e+03  8.00004875e+03
  4.77676871e+04]
E1 = -182.5993723453496  E_coul = 54.06751243244593
Extra cycle  E= -128.531859912904  delta_E= -1.82e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.7785358304233
E1 = -182.5993723453496  E_coul = 54.06751243244593
init E= -128.531859912904
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845372496368589  LUMO = 1.08994172840321
  mo_energy =
[-3.27690243e+01 -1.92703194e+00 -8.45372496e-01 -8.45372496e-01
 -8.45372496e-01  1.08994173e+00  1.08994173e+00  1.08994173e+00
  1.18932616e+00  5.69096051e+00  5.69096051e+00  5.69096051e+00
  7.28787394e+00  2.40583680e+01  2.40583680e+01  2.40583680e+01
  3.46130663e+01  1.18910207e+02  1.18910207e+02  1.18910207e+02
  1.38715454e+02  5.02790612e+02  1.87040275e+03  8.00004874e+03
  4.77676871e+04]
E1 = -182.5993796325621  E_coul = 54.06751971965802
cycle= 1 E= -128.531859912904  delta_E= -3.98e-13  |g|= 1e-06  |ddm|= 7.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5993796325621  E_coul = 54.06751971965802
  HOMO = -0.845371985624801  LUMO = 1.08994191636202
  mo_energy =
[-3.27690228e+01 -1.92703138e+00 -8.45371986e-01 -8.45371986e-01
 -8.45371986e-01  1.08994192e+00  1.08994192e+00  1.08994192e+00
  1.18932638e+00  5.69096113e+00  5.69096113e+00  5.69096113e+00
  7.28787458e+00  2.40583691e+01  2.40583691e+01  2.40583691e+01
  3.46130675e+01  1.18910208e+02  1.18910208e+02  1.18910208e+02
  1.38715456e+02  5.02790614e+02  1.87040275e+03  8.00004875e+03
  4.77676871e+04]
E1 = -182.5993760191212  E_coul = 54.0675161062172
Extra cycle  E= -128.531859912904  delta_E= 5.68e-14  |g|= 4.91e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271019e+02 2.35735132e+02
 7.64309692e+01 1.00376419e+01 2.70536720e+01 3.81369491e-01
 1.11671129e+00 2.87986736e+00 3.68505467e+00 1.24508532e+01
 5.47900022e+01 3.30262192e-01 1.14419053e+00]
grad_E = [ 1.27094290e-11 -6.89020748e-10  2.22715416e-08 -4.36097057e-07
  2.91274522e-06 -1.72998836e-06  7.93670004e-06 -2.89493469e-05
  1.95075191e-05 -5.18792966e-06 -8.34404974e-07  2.86437912e-07
  5.52448698e-08 -3.63733623e-05  9.44175196e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45446999]
bas 2, expnt(s) = [833.2710571]
bas 3, expnt(s) = [235.73473657]
bas 4, expnt(s) = [76.43305808]
bas 5, expnt(s) = [10.03688528]
bas 6, expnt(s) = [27.05056174]
bas 7, expnt(s) = [0.38143141]
bas 8, expnt(s) = [1.11706584]
bas 9, expnt(s) = [2.88245389]
bas 10, expnt(s) = [3.68488423]
bas 11, expnt(s) = [12.45003874]
bas 12, expnt(s) = [54.78531231]
bas 13, expnt(s) = [0.330264]
bas 14, expnt(s) = [1.14415964]
CPU time:       323.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996193e+02
 7.64330581e+01 6.53094387e+01 1.00368853e+01 1.42466989e+01
 2.70505617e+01 2.99672741e+01 3.81431405e-01 1.22624531e+00
 1.11706584e+00 2.74520070e+00 2.88245389e+00 5.58903464e+00
 3.68488423e+00 1.48940978e+01 1.24500387e+01 6.82256640e+01
 5.47853123e+01 4.34825064e+02 3.30264004e-01 7.30400304e-01
 1.14415964e+00 3.45217398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843238046104
cond(S) = 343.9327116544397
E1 = -183.57722929141607  E_coul = 55.07846132288648
init E= -128.49876796853
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773947092104551  LUMO = 1.11560740931621
  mo_energy =
[-3.25553035e+01 -1.85276651e+00 -7.73947092e-01 -7.73947092e-01
 -7.73947092e-01  1.11560741e+00  1.11560741e+00  1.11560741e+00
  1.21892842e+00  5.77786932e+00  5.77786932e+00  5.77786932e+00
  7.37910744e+00  2.42144577e+01  2.42144577e+01  2.42144577e+01
  3.47841163e+01  1.19115821e+02  1.19115821e+02  1.19115821e+02
  1.38929695e+02  5.03036543e+02  1.87067978e+03  8.00035220e+03
  4.77680082e+04]
E1 = -182.112920964966  E_coul = 53.584403435200244
cycle= 1 E= -128.528517529766  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450154
diis-c [-0.20263877  1.        ]
  HOMO = -0.87941067448931  LUMO = 1.07752423152984
  mo_energy =
[-3.28734261e+01 -1.96291310e+00 -8.79410674e-01 -8.79410674e-01
 -8.79410674e-01  1.07752423e+00  1.07752423e+00  1.07752423e+00
  1.17592785e+00  5.64915525e+00  5.64915525e+00  5.64915525e+00
  7.25109663e+00  2.39798708e+01  2.39798708e+01  2.39798708e+01
  3.45421689e+01  1.18795436e+02  1.18795436e+02  1.18795436e+02
  1.38616752e+02  5.02679740e+02  1.87028702e+03  7.99993045e+03
  4.77675676e+04]
E1 = -182.84360718542985  E_coul = 54.31259103948355
cycle= 2 E= -128.531016145946  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0707
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.22448
diis-c [-6.04607045e-04  3.31736140e-01  6.68263860e-01]
  HOMO = -0.845106356802103  LUMO = 1.08999787681553
  mo_energy =
[-3.27685430e+01 -1.92683583e+00 -8.45106357e-01 -8.45106357e-01
 -8.45106357e-01  1.08999788e+00  1.08999788e+00  1.08999788e+00
  1.18983809e+00  5.69102147e+00  5.69102147e+00  5.69102147e+00
  7.29278660e+00  2.40573260e+01  2.40573260e+01  2.40573260e+01
  3.46222998e+01  1.18900346e+02  1.18900346e+02  1.18900346e+02
  1.38719705e+02  5.02793258e+02  1.87040570e+03  8.00005155e+03
  4.77676896e+04]
E1 = -182.5987009378007  E_coul = 54.06684102932833
cycle= 3 E= -128.531859908472  delta_E= -0.000844  |g|= 0.000471  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000980392
diis-c [-9.49128118e-08 -2.15120202e-03 -1.60354952e-04  1.00231156e+00]
  HOMO = -0.845341881205451  LUMO = 1.08994964960714
  mo_energy =
[-3.27689709e+01 -1.92701246e+00 -8.45341881e-01 -8.45341881e-01
 -8.45341881e-01  1.08994965e+00  1.08994965e+00  1.08994965e+00
  1.18978043e+00  5.69081297e+00  5.69081297e+00  5.69081297e+00
  7.29258682e+00  2.40569915e+01  2.40569915e+01  2.40569915e+01
  3.46219655e+01  1.18899907e+02  1.18899907e+02  1.18899907e+02
  1.38719278e+02  5.02792728e+02  1.87040506e+03  8.00005083e+03
  4.77676888e+04]
E1 = -182.59928986376622  E_coul = 54.06742993700526
cycle= 4 E= -128.531859926761  delta_E= -1.83e-08  |g|= 6.17e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000135487
diis-c [-7.81037209e-10  2.87192589e-04  4.33158637e-04 -1.92588995e-01
  1.19186864e+00]
  HOMO = -0.845372454166505  LUMO = 1.089937340699
  mo_energy =
[-3.27690249e+01 -1.92703248e+00 -8.45372454e-01 -8.45372454e-01
 -8.45372454e-01  1.08993734e+00  1.08993734e+00  1.08993734e+00
  1.18977053e+00  5.69077841e+00  5.69077841e+00  5.69077841e+00
  7.29255629e+00  2.40569442e+01  2.40569442e+01  2.40569442e+01
  3.46219187e+01  1.18899852e+02  1.18899852e+02  1.18899852e+02
  1.38719224e+02  5.02792666e+02  1.87040499e+03  8.00005075e+03
  4.77676887e+04]
E1 = -182.59940701765987  E_coul = 54.06754709045558
cycle= 5 E= -128.531859927204  delta_E= -4.43e-10  |g|= 5.49e-06  |ddm|= 3.59e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59940701765987  E_coul = 54.06754709045558
  HOMO = -0.845369563263233  LUMO = 1.08993856187245
  mo_energy =
[-3.27690188e+01 -1.92702888e+00 -8.45369563e-01 -8.45369563e-01
 -8.45369563e-01  1.08993856e+00  1.08993856e+00  1.08993856e+00
  1.18977233e+00  5.69078194e+00  5.69078194e+00  5.69078194e+00
  7.29256017e+00  2.40569495e+01  2.40569495e+01  2.40569495e+01
  3.46219242e+01  1.18899858e+02  1.18899858e+02  1.18899858e+02
  1.38719230e+02  5.02792672e+02  1.87040500e+03  8.00005076e+03
  4.77676887e+04]
E1 = -182.5993935460978  E_coul = 54.06753361889164
Extra cycle  E= -128.531859927206  delta_E= -1.85e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330581e+01 1.00368853e+01 2.70505617e+01 3.81431405e-01
 1.11706584e+00 2.88245389e+00 3.68488423e+00 1.24500387e+01
 5.47853123e+01 3.30264004e-01 1.14415964e+00]
E = -128.53185992720614
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45446999]
bas 2, expnt(s) = [833.2710571]
bas 3, expnt(s) = [235.73473657]
bas 4, expnt(s) = [76.43305808]
bas 5, expnt(s) = [10.03688528]
bas 6, expnt(s) = [27.05056174]
bas 7, expnt(s) = [0.38143141]
bas 8, expnt(s) = [1.11706584]
bas 9, expnt(s) = [2.88245389]
bas 10, expnt(s) = [3.68488423]
bas 11, expnt(s) = [12.45003874]
bas 12, expnt(s) = [54.78531231]
bas 13, expnt(s) = [0.330264]
bas 14, expnt(s) = [1.14415964]
CPU time:       324.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996193e+02
 7.64330581e+01 6.53094387e+01 1.00368853e+01 1.42466989e+01
 2.70505617e+01 2.99672741e+01 3.81431405e-01 1.22624531e+00
 1.11706584e+00 2.74520070e+00 2.88245389e+00 5.58903464e+00
 3.68488423e+00 1.48940978e+01 1.24500387e+01 6.82256640e+01
 5.47853123e+01 4.34825064e+02 3.30264004e-01 7.30400304e-01
 1.14415964e+00 3.45217398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843238046104
cond(S) = 343.9327116544397
E1 = -183.57722929141607  E_coul = 55.07846132288648
init E= -128.49876796853
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773947092104551  LUMO = 1.11560740931621
  mo_energy =
[-3.25553035e+01 -1.85276651e+00 -7.73947092e-01 -7.73947092e-01
 -7.73947092e-01  1.11560741e+00  1.11560741e+00  1.11560741e+00
  1.21892842e+00  5.77786932e+00  5.77786932e+00  5.77786932e+00
  7.37910744e+00  2.42144577e+01  2.42144577e+01  2.42144577e+01
  3.47841163e+01  1.19115821e+02  1.19115821e+02  1.19115821e+02
  1.38929695e+02  5.03036543e+02  1.87067978e+03  8.00035220e+03
  4.77680082e+04]
E1 = -182.112920964966  E_coul = 53.584403435200244
cycle= 1 E= -128.528517529766  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450154
diis-c [-0.20263877  1.        ]
  HOMO = -0.87941067448931  LUMO = 1.07752423152984
  mo_energy =
[-3.28734261e+01 -1.96291310e+00 -8.79410674e-01 -8.79410674e-01
 -8.79410674e-01  1.07752423e+00  1.07752423e+00  1.07752423e+00
  1.17592785e+00  5.64915525e+00  5.64915525e+00  5.64915525e+00
  7.25109663e+00  2.39798708e+01  2.39798708e+01  2.39798708e+01
  3.45421689e+01  1.18795436e+02  1.18795436e+02  1.18795436e+02
  1.38616752e+02  5.02679740e+02  1.87028702e+03  7.99993045e+03
  4.77675676e+04]
E1 = -182.84360718542985  E_coul = 54.31259103948355
cycle= 2 E= -128.531016145946  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0707
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.22448
diis-c [-6.04607045e-04  3.31736140e-01  6.68263860e-01]
  HOMO = -0.845106356802103  LUMO = 1.08999787681553
  mo_energy =
[-3.27685430e+01 -1.92683583e+00 -8.45106357e-01 -8.45106357e-01
 -8.45106357e-01  1.08999788e+00  1.08999788e+00  1.08999788e+00
  1.18983809e+00  5.69102147e+00  5.69102147e+00  5.69102147e+00
  7.29278660e+00  2.40573260e+01  2.40573260e+01  2.40573260e+01
  3.46222998e+01  1.18900346e+02  1.18900346e+02  1.18900346e+02
  1.38719705e+02  5.02793258e+02  1.87040570e+03  8.00005155e+03
  4.77676896e+04]
E1 = -182.5987009378007  E_coul = 54.06684102932833
cycle= 3 E= -128.531859908472  delta_E= -0.000844  |g|= 0.000471  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980392
diis-c [-9.49128118e-08 -2.15120202e-03 -1.60354952e-04  1.00231156e+00]
  HOMO = -0.845341881205451  LUMO = 1.08994964960714
  mo_energy =
[-3.27689709e+01 -1.92701246e+00 -8.45341881e-01 -8.45341881e-01
 -8.45341881e-01  1.08994965e+00  1.08994965e+00  1.08994965e+00
  1.18978043e+00  5.69081297e+00  5.69081297e+00  5.69081297e+00
  7.29258682e+00  2.40569915e+01  2.40569915e+01  2.40569915e+01
  3.46219655e+01  1.18899907e+02  1.18899907e+02  1.18899907e+02
  1.38719278e+02  5.02792728e+02  1.87040506e+03  8.00005083e+03
  4.77676888e+04]
E1 = -182.59928986376622  E_coul = 54.06742993700526
cycle= 4 E= -128.531859926761  delta_E= -1.83e-08  |g|= 6.17e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135487
diis-c [-7.81037209e-10  2.87192589e-04  4.33158637e-04 -1.92588995e-01
  1.19186864e+00]
  HOMO = -0.845372454166505  LUMO = 1.089937340699
  mo_energy =
[-3.27690249e+01 -1.92703248e+00 -8.45372454e-01 -8.45372454e-01
 -8.45372454e-01  1.08993734e+00  1.08993734e+00  1.08993734e+00
  1.18977053e+00  5.69077841e+00  5.69077841e+00  5.69077841e+00
  7.29255629e+00  2.40569442e+01  2.40569442e+01  2.40569442e+01
  3.46219187e+01  1.18899852e+02  1.18899852e+02  1.18899852e+02
  1.38719224e+02  5.02792666e+02  1.87040499e+03  8.00005075e+03
  4.77676887e+04]
E1 = -182.59940701765987  E_coul = 54.06754709045558
cycle= 5 E= -128.531859927204  delta_E= -4.43e-10  |g|= 5.49e-06  |ddm|= 3.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59940701765987  E_coul = 54.06754709045558
  HOMO = -0.845369563263233  LUMO = 1.08993856187245
  mo_energy =
[-3.27690188e+01 -1.92702888e+00 -8.45369563e-01 -8.45369563e-01
 -8.45369563e-01  1.08993856e+00  1.08993856e+00  1.08993856e+00
  1.18977233e+00  5.69078194e+00  5.69078194e+00  5.69078194e+00
  7.29256017e+00  2.40569495e+01  2.40569495e+01  2.40569495e+01
  3.46219242e+01  1.18899858e+02  1.18899858e+02  1.18899858e+02
  1.38719230e+02  5.02792672e+02  1.87040500e+03  8.00005076e+03
  4.77676887e+04]
E1 = -182.5993935460978  E_coul = 54.06753361889164
Extra cycle  E= -128.531859927206  delta_E= -1.85e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 343.9327116544397
E1 = -182.5993935460978  E_coul = 54.06753361889164
init E= -128.531859927206
    CPU time for initialize scf      0.20 sec, wall time      0.20 sec
  HOMO = -0.845370510281904  LUMO = 1.08993823197172
  mo_energy =
[-3.27690219e+01 -1.92702976e+00 -8.45370510e-01 -8.45370510e-01
 -8.45370510e-01  1.08993823e+00  1.08993823e+00  1.08993823e+00
  1.18977203e+00  5.69078079e+00  5.69078079e+00  5.69078079e+00
  7.29255909e+00  2.40569474e+01  2.40569474e+01  2.40569474e+01
  3.46219220e+01  1.18899855e+02  1.18899855e+02  1.18899855e+02
  1.38719227e+02  5.02792668e+02  1.87040499e+03  8.00005075e+03
  4.77676887e+04]
E1 = -182.5994008344528  E_coul = 54.067540907246375
cycle= 1 E= -128.531859927206  delta_E= -2.84e-13  |g|= 1e-06  |ddm|= 7.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5994008344528  E_coul = 54.067540907246375
  HOMO = -0.84536999945688  LUMO = 1.08993841995488
  mo_energy =
[-3.27690203e+01 -1.92702920e+00 -8.45369999e-01 -8.45369999e-01
 -8.45369999e-01  1.08993842e+00  1.08993842e+00  1.08993842e+00
  1.18977225e+00  5.69078142e+00  5.69078142e+00  5.69078142e+00
  7.29255973e+00  2.40569485e+01  2.40569485e+01  2.40569485e+01
  3.46219232e+01  1.18899856e+02  1.18899856e+02  1.18899856e+02
  1.38719228e+02  5.02792670e+02  1.87040499e+03  8.00005076e+03
  4.77676887e+04]
E1 = -182.599397220417  E_coul = 54.06753729321038
Extra cycle  E= -128.531859927207  delta_E= -1.71e-13  |g|= 4.92e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.26 sec, wall time      0.26 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330581e+01 1.00368853e+01 2.70505617e+01 3.81431405e-01
 1.11706584e+00 2.88245389e+00 3.68488423e+00 1.24500387e+01
 5.47853123e+01 3.30264004e-01 1.14415964e+00]
grad_E = [ 3.75931571e-11 -1.98637245e-09  4.74537710e-08 -7.03416189e-07
  4.47803454e-06  1.65676749e-06  3.71156639e-06 -9.12565882e-07
  8.90252636e-07  1.90820078e-07 -9.46743040e-08  2.65893296e-08
  1.95778775e-08  2.61217124e-06 -2.03868844e-07]
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -128.53185992720614
       x: [ 2.441e+04  3.661e+03 ...  3.303e-01  1.144e+00]
     nit: 86
     jac: [ 3.759e-11 -1.986e-09 ...  2.612e-06 -2.039e-07]
    nfev: 94
    njev: 86
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45446999]
bas 2, expnt(s) = [833.2710571]
bas 3, expnt(s) = [235.73473657]
bas 4, expnt(s) = [76.43305808]
bas 5, expnt(s) = [10.03688528]
bas 6, expnt(s) = [27.05056174]
bas 7, expnt(s) = [0.38143141]
bas 8, expnt(s) = [1.11706584]
bas 9, expnt(s) = [2.88245389]
bas 10, expnt(s) = [3.68488423]
bas 11, expnt(s) = [12.45003874]
bas 12, expnt(s) = [54.78531231]
bas 13, expnt(s) = [0.330264]
bas 14, expnt(s) = [1.14415964]
CPU time:       327.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996193e+02
 7.64330581e+01 6.53094387e+01 1.00368853e+01 1.42466989e+01
 2.70505617e+01 2.99672741e+01 3.81431405e-01 1.22624531e+00
 1.11706584e+00 2.74520070e+00 2.88245389e+00 5.58903464e+00
 3.68488423e+00 1.48940978e+01 1.24500387e+01 6.82256640e+01
 5.47853123e+01 4.34825064e+02 3.30264004e-01 7.30400304e-01
 1.14415964e+00 3.45217398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843238046104
cond(S) = 343.9327116544397
E1 = -183.57722929141607  E_coul = 55.07846132288648
init E= -128.49876796853
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773947092104551  LUMO = 1.11560740931621
  mo_energy =
[-3.25553035e+01 -1.85276651e+00 -7.73947092e-01 -7.73947092e-01
 -7.73947092e-01  1.11560741e+00  1.11560741e+00  1.11560741e+00
  1.21892842e+00  5.77786932e+00  5.77786932e+00  5.77786932e+00
  7.37910744e+00  2.42144577e+01  2.42144577e+01  2.42144577e+01
  3.47841163e+01  1.19115821e+02  1.19115821e+02  1.19115821e+02
  1.38929695e+02  5.03036543e+02  1.87067978e+03  8.00035220e+03
  4.77680082e+04]
E1 = -182.112920964966  E_coul = 53.584403435200244
cycle= 1 E= -128.528517529766  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450154
diis-c [-0.20263877  1.        ]
  HOMO = -0.87941067448931  LUMO = 1.07752423152984
  mo_energy =
[-3.28734261e+01 -1.96291310e+00 -8.79410674e-01 -8.79410674e-01
 -8.79410674e-01  1.07752423e+00  1.07752423e+00  1.07752423e+00
  1.17592785e+00  5.64915525e+00  5.64915525e+00  5.64915525e+00
  7.25109663e+00  2.39798708e+01  2.39798708e+01  2.39798708e+01
  3.45421689e+01  1.18795436e+02  1.18795436e+02  1.18795436e+02
  1.38616752e+02  5.02679740e+02  1.87028702e+03  7.99993045e+03
  4.77675676e+04]
E1 = -182.84360718542985  E_coul = 54.31259103948355
cycle= 2 E= -128.531016145946  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0707
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.22448
diis-c [-6.04607045e-04  3.31736140e-01  6.68263860e-01]
  HOMO = -0.845106356802103  LUMO = 1.08999787681553
  mo_energy =
[-3.27685430e+01 -1.92683583e+00 -8.45106357e-01 -8.45106357e-01
 -8.45106357e-01  1.08999788e+00  1.08999788e+00  1.08999788e+00
  1.18983809e+00  5.69102147e+00  5.69102147e+00  5.69102147e+00
  7.29278660e+00  2.40573260e+01  2.40573260e+01  2.40573260e+01
  3.46222998e+01  1.18900346e+02  1.18900346e+02  1.18900346e+02
  1.38719705e+02  5.02793258e+02  1.87040570e+03  8.00005155e+03
  4.77676896e+04]
E1 = -182.5987009378007  E_coul = 54.06684102932833
cycle= 3 E= -128.531859908472  delta_E= -0.000844  |g|= 0.000471  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980392
diis-c [-9.49128118e-08 -2.15120202e-03 -1.60354952e-04  1.00231156e+00]
  HOMO = -0.845341881205451  LUMO = 1.08994964960714
  mo_energy =
[-3.27689709e+01 -1.92701246e+00 -8.45341881e-01 -8.45341881e-01
 -8.45341881e-01  1.08994965e+00  1.08994965e+00  1.08994965e+00
  1.18978043e+00  5.69081297e+00  5.69081297e+00  5.69081297e+00
  7.29258682e+00  2.40569915e+01  2.40569915e+01  2.40569915e+01
  3.46219655e+01  1.18899907e+02  1.18899907e+02  1.18899907e+02
  1.38719278e+02  5.02792728e+02  1.87040506e+03  8.00005083e+03
  4.77676888e+04]
E1 = -182.59928986376622  E_coul = 54.06742993700526
cycle= 4 E= -128.531859926761  delta_E= -1.83e-08  |g|= 6.17e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135487
diis-c [-7.81037209e-10  2.87192589e-04  4.33158637e-04 -1.92588995e-01
  1.19186864e+00]
  HOMO = -0.845372454166505  LUMO = 1.089937340699
  mo_energy =
[-3.27690249e+01 -1.92703248e+00 -8.45372454e-01 -8.45372454e-01
 -8.45372454e-01  1.08993734e+00  1.08993734e+00  1.08993734e+00
  1.18977053e+00  5.69077841e+00  5.69077841e+00  5.69077841e+00
  7.29255629e+00  2.40569442e+01  2.40569442e+01  2.40569442e+01
  3.46219187e+01  1.18899852e+02  1.18899852e+02  1.18899852e+02
  1.38719224e+02  5.02792666e+02  1.87040499e+03  8.00005075e+03
  4.77676887e+04]
E1 = -182.59940701765987  E_coul = 54.06754709045558
cycle= 5 E= -128.531859927204  delta_E= -4.43e-10  |g|= 5.49e-06  |ddm|= 3.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59940701765987  E_coul = 54.06754709045558
  HOMO = -0.845369563263233  LUMO = 1.08993856187245
  mo_energy =
[-3.27690188e+01 -1.92702888e+00 -8.45369563e-01 -8.45369563e-01
 -8.45369563e-01  1.08993856e+00  1.08993856e+00  1.08993856e+00
  1.18977233e+00  5.69078194e+00  5.69078194e+00  5.69078194e+00
  7.29256017e+00  2.40569495e+01  2.40569495e+01  2.40569495e+01
  3.46219242e+01  1.18899858e+02  1.18899858e+02  1.18899858e+02
  1.38719230e+02  5.02792672e+02  1.87040500e+03  8.00005076e+03
  4.77676887e+04]
E1 = -182.5993935460978  E_coul = 54.06753361889164
Extra cycle  E= -128.531859927206  delta_E= -1.85e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330581e+01 1.00368853e+01 2.70505617e+01 3.81431405e-01
 1.11706584e+00 2.88245389e+00 3.68488423e+00 1.24500387e+01
 5.47853123e+01 3.30264004e-01 1.14415964e+00]
E = -128.53185992720614
E = -128.53185992720614
exponents = [
S
2.4413794129990565e+04
3.6614544699930652e+03
8.3327105710227954e+02
2.3573473657470291e+02
7.6433058080797622e+01
1.0036885276749757e+01
2.7050561740223941e+01
3.8143140543204801e-01
1.1170658350677358e+00
2.8824538920925851e+00

P
3.6848842291763377e+00
1.2450038737732893e+01
5.4785312306740778e+01
3.3026400429387798e-01
1.1441596434027714e+00

]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 25
number of NR cGTOs = 25
basis = {'Ne': [[0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [24413.79412999]
bas 1, expnt(s) = [3661.45446999]
bas 2, expnt(s) = [833.2710571]
bas 3, expnt(s) = [235.73473657]
bas 4, expnt(s) = [76.43305808]
bas 5, expnt(s) = [10.03688528]
bas 6, expnt(s) = [27.05056174]
bas 7, expnt(s) = [0.38143141]
bas 8, expnt(s) = [1.11706584]
bas 9, expnt(s) = [2.88245389]
bas 10, expnt(s) = [3.68488423]
bas 11, expnt(s) = [12.45003874]
bas 12, expnt(s) = [54.78531231]
bas 13, expnt(s) = [0.330264]
bas 14, expnt(s) = [1.14415964]
CPU time:       329.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44137941e+04 4.93448102e+03 3.66145447e+03 1.18920096e+03
 8.33271057e+02 3.91836372e+02 2.35734737e+02 1.51996193e+02
 7.64330581e+01 6.53094387e+01 1.00368853e+01 1.42466989e+01
 2.70505617e+01 2.99672741e+01 3.81431405e-01 1.22624531e+00
 1.11706584e+00 2.74520070e+00 2.88245389e+00 5.58903464e+00
 3.68488423e+00 1.48940978e+01 1.24500387e+01 6.82256640e+01
 5.47853123e+01 4.34825064e+02 3.30264004e-01 7.30400304e-01
 1.14415964e+00 3.45217398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843238046104
cond(S) = 343.9327116544397
E1 = -183.57722929141607  E_coul = 55.07846132288648
init E= -128.49876796853
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773947092104551  LUMO = 1.11560740931621
  mo_energy =
[-3.25553035e+01 -1.85276651e+00 -7.73947092e-01 -7.73947092e-01
 -7.73947092e-01  1.11560741e+00  1.11560741e+00  1.11560741e+00
  1.21892842e+00  5.77786932e+00  5.77786932e+00  5.77786932e+00
  7.37910744e+00  2.42144577e+01  2.42144577e+01  2.42144577e+01
  3.47841163e+01  1.19115821e+02  1.19115821e+02  1.19115821e+02
  1.38929695e+02  5.03036543e+02  1.87067978e+03  8.00035220e+03
  4.77680082e+04]
E1 = -182.112920964966  E_coul = 53.584403435200244
cycle= 1 E= -128.528517529766  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.450154
diis-c [-0.20263877  1.        ]
  HOMO = -0.87941067448931  LUMO = 1.07752423152984
  mo_energy =
[-3.28734261e+01 -1.96291310e+00 -8.79410674e-01 -8.79410674e-01
 -8.79410674e-01  1.07752423e+00  1.07752423e+00  1.07752423e+00
  1.17592785e+00  5.64915525e+00  5.64915525e+00  5.64915525e+00
  7.25109663e+00  2.39798708e+01  2.39798708e+01  2.39798708e+01
  3.45421689e+01  1.18795436e+02  1.18795436e+02  1.18795436e+02
  1.38616752e+02  5.02679740e+02  1.87028702e+03  7.99993045e+03
  4.77675676e+04]
E1 = -182.84360718542985  E_coul = 54.31259103948355
cycle= 2 E= -128.531016145946  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0707
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.22448
diis-c [-6.04607045e-04  3.31736140e-01  6.68263860e-01]
  HOMO = -0.845106356802103  LUMO = 1.08999787681553
  mo_energy =
[-3.27685430e+01 -1.92683583e+00 -8.45106357e-01 -8.45106357e-01
 -8.45106357e-01  1.08999788e+00  1.08999788e+00  1.08999788e+00
  1.18983809e+00  5.69102147e+00  5.69102147e+00  5.69102147e+00
  7.29278660e+00  2.40573260e+01  2.40573260e+01  2.40573260e+01
  3.46222998e+01  1.18900346e+02  1.18900346e+02  1.18900346e+02
  1.38719705e+02  5.02793258e+02  1.87040570e+03  8.00005155e+03
  4.77676896e+04]
E1 = -182.5987009378007  E_coul = 54.06684102932833
cycle= 3 E= -128.531859908472  delta_E= -0.000844  |g|= 0.000471  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980392
diis-c [-9.49128118e-08 -2.15120202e-03 -1.60354952e-04  1.00231156e+00]
  HOMO = -0.845341881205451  LUMO = 1.08994964960714
  mo_energy =
[-3.27689709e+01 -1.92701246e+00 -8.45341881e-01 -8.45341881e-01
 -8.45341881e-01  1.08994965e+00  1.08994965e+00  1.08994965e+00
  1.18978043e+00  5.69081297e+00  5.69081297e+00  5.69081297e+00
  7.29258682e+00  2.40569915e+01  2.40569915e+01  2.40569915e+01
  3.46219655e+01  1.18899907e+02  1.18899907e+02  1.18899907e+02
  1.38719278e+02  5.02792728e+02  1.87040506e+03  8.00005083e+03
  4.77676888e+04]
E1 = -182.59928986376622  E_coul = 54.06742993700526
cycle= 4 E= -128.531859926761  delta_E= -1.83e-08  |g|= 6.17e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135487
diis-c [-7.81037209e-10  2.87192589e-04  4.33158637e-04 -1.92588995e-01
  1.19186864e+00]
  HOMO = -0.845372454166505  LUMO = 1.089937340699
  mo_energy =
[-3.27690249e+01 -1.92703248e+00 -8.45372454e-01 -8.45372454e-01
 -8.45372454e-01  1.08993734e+00  1.08993734e+00  1.08993734e+00
  1.18977053e+00  5.69077841e+00  5.69077841e+00  5.69077841e+00
  7.29255629e+00  2.40569442e+01  2.40569442e+01  2.40569442e+01
  3.46219187e+01  1.18899852e+02  1.18899852e+02  1.18899852e+02
  1.38719224e+02  5.02792666e+02  1.87040499e+03  8.00005075e+03
  4.77676887e+04]
E1 = -182.59940701765987  E_coul = 54.06754709045558
cycle= 5 E= -128.531859927204  delta_E= -4.43e-10  |g|= 5.49e-06  |ddm|= 3.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59940701765987  E_coul = 54.06754709045558
  HOMO = -0.845369563263233  LUMO = 1.08993856187245
  mo_energy =
[-3.27690188e+01 -1.92702888e+00 -8.45369563e-01 -8.45369563e-01
 -8.45369563e-01  1.08993856e+00  1.08993856e+00  1.08993856e+00
  1.18977233e+00  5.69078194e+00  5.69078194e+00  5.69078194e+00
  7.29256017e+00  2.40569495e+01  2.40569495e+01  2.40569495e+01
  3.46219242e+01  1.18899858e+02  1.18899858e+02  1.18899858e+02
  1.38719230e+02  5.02792672e+02  1.87040500e+03  8.00005076e+03
  4.77676887e+04]
E1 = -182.5993935460978  E_coul = 54.06753361889164
Extra cycle  E= -128.531859927206  delta_E= -1.85e-12  |g|= 1.9e-06  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44137941e+04 3.66145447e+03 8.33271057e+02 2.35734737e+02
 7.64330581e+01 1.00368853e+01 2.70505617e+01 3.81431405e-01
 1.11706584e+00 2.88245389e+00 3.68488423e+00 1.24500387e+01
 5.47853123e+01 3.30264004e-01 1.14415964e+00]
E = -128.53185992720614
E = -128.53185992720614
exp = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
